!function(e,t,n,r){function o(e,t){return typeof e===t}function i(e){var t=_.className,n=Modernizr._config.classPrefix||"";if(S&&(t=t.baseVal),Modernizr._config.enableJSClass){var r=new RegExp("(^|\\s)"+n+"no-js(\\s|$)");t=t.replace(r,"$1"+n+"js$2")}Modernizr._config.enableClasses&&(e.length>0&&(t+=" "+n+e.join(" "+n)),S?_.className.baseVal=t:_.className=t)}function s(e,t){if("object"==typeof e)for(var n in e)k(e,n)&&s(n,e[n]);else{e=e.toLowerCase();var r=e.split("."),o=Modernizr[r[0]];if(2===r.length&&(o=o[r[1]]),void 0!==o)return Modernizr;t="function"==typeof t?t():t,1===r.length?Modernizr[r[0]]=t:(!Modernizr[r[0]]||Modernizr[r[0]]instanceof Boolean||(Modernizr[r[0]]=new Boolean(Modernizr[r[0]])),Modernizr[r[0]][r[1]]=t),i([(t&&!1!==t?"":"no-")+r.join("-")]),Modernizr._trigger(e,t)}return Modernizr}function a(){return"function"!=typeof n.createElement?n.createElement(arguments[0]):S?n.createElementNS.call(n,"http://www.w3.org/2000/svg",arguments[0]):n.createElement.apply(n,arguments)}function l(){var e=n.body;return e||(e=a(S?"svg":"body"),e.fake=!0),e}function u(e,t,r,o){var i,s,u,f,c="modernizr",d=a("div"),p=l();if(parseInt(r,10))for(;r--;)u=a("div"),u.id=o?o[r]:c+(r+1),d.appendChild(u);return i=a("style"),i.type="text/css",i.id="s"+c,(p.fake?p:d).appendChild(i),p.appendChild(d),i.styleSheet?i.styleSheet.cssText=e:i.appendChild(n.createTextNode(e)),d.id=c,p.fake&&(p.style.background="",p.style.overflow="hidden",f=_.style.overflow,_.style.overflow="hidden",_.appendChild(p)),s=t(d,e),p.fake?(p.parentNode.removeChild(p),_.style.overflow=f,_.offsetHeight):d.parentNode.removeChild(d),!!s}function f(e,n,r){var o;if("getComputedStyle"in t){o=getComputedStyle.call(t,e,n);var i=t.console;if(null!==o)r&&(o=o.getPropertyValue(r));else if(i){var s=i.error?"error":"log";i[s].call(i,"getComputedStyle returning null, its possible modernizr test results are inaccurate")}}else o=!n&&e.currentStyle&&e.currentStyle[r];return o}function c(e,t){return!!~(""+e).indexOf(t)}function d(e){return e.replace(/([A-Z])/g,function(e,t){return"-"+t.toLowerCase()}).replace(/^ms-/,"-ms-")}function p(e,n){var o=e.length;if("CSS"in t&&"supports"in t.CSS){for(;o--;)if(t.CSS.supports(d(e[o]),n))return!0;return!1}if("CSSSupportsRule"in t){for(var i=[];o--;)i.push("("+d(e[o])+":"+n+")");return i=i.join(" or "),u("@supports ("+i+") { #modernizr { position: absolute; } }",function(e){return"absolute"===f(e,null,"position")})}return r}function m(e){return e.replace(/([a-z])-([a-z])/g,function(e,t,n){return t+n.toUpperCase()}).replace(/^-/,"")}function h(e,t,n,i){function s(){u&&(delete N.style,delete N.modElem)}if(i=!o(i,"undefined")&&i,!o(n,"undefined")){var l=p(e,n);if(!o(l,"undefined"))return l}for(var u,f,d,h,A,v=["modernizr","tspan","samp"];!N.style&&v.length;)u=!0,N.modElem=a(v.shift()),N.style=N.modElem.style;for(d=e.length,f=0;f<d;f++)if(h=e[f],A=N.style[h],c(h,"-")&&(h=m(h)),N.style[h]!==r){if(i||o(n,"undefined"))return s(),"pfx"!==t||h;try{N.style[h]=n}catch(e){}if(N.style[h]!==A)return s(),"pfx"!==t||h}return s(),!1}function A(e,t){return function(){return e.apply(t,arguments)}}function v(e,t,n){var r;for(var i in e)if(e[i]in t)return!1===n?e[i]:(r=t[e[i]],o(r,"function")?A(r,n||t):r);return!1}function g(e,t,n,r,i){var s=e.charAt(0).toUpperCase()+e.slice(1),a=(e+" "+O.join(s+" ")+s).split(" ");return o(t,"string")||o(t,"undefined")?h(a,t,r,i):(a=(e+" "+T.join(s+" ")+s).split(" "),v(a,t,n))}function y(e,t,n){return g(e,r,r,t,n)}var w=[],C={_version:"3.11.2",_config:{classPrefix:"",enableClasses:!0,enableJSClass:!0,usePrefixes:!0},_q:[],on:function(e,t){var n=this;setTimeout(function(){t(n[e])},0)},addTest:function(e,t,n){w.push({name:e,fn:t,options:n})},addAsyncTest:function(e){w.push({name:null,fn:e})}},Modernizr=function(){};Modernizr.prototype=C,Modernizr=new Modernizr;var b=[],_=n.documentElement,S="svg"===_.nodeName.toLowerCase(),x="Moz O ms Webkit",T=C._config.usePrefixes?x.toLowerCase().split(" "):[];C._domPrefixes=T;var P=C._config.usePrefixes?" -webkit- -moz- -o- -ms- ".split(" "):["",""];C._prefixes=P;var k;!function(){var e={}.hasOwnProperty;k=o(e,"undefined")||o(e.call,"undefined")?function(e,t){return t in e&&o(e.constructor.prototype[t],"undefined")}:function(t,n){return e.call(t,n)}}(),C._l={},C.on=function(e,t){this._l[e]||(this._l[e]=[]),this._l[e].push(t),Modernizr.hasOwnProperty(e)&&setTimeout(function(){Modernizr._trigger(e,Modernizr[e])},0)},C._trigger=function(e,t){if(this._l[e]){var n=this._l[e];setTimeout(function(){var e;for(e=0;e<n.length;e++)(0,n[e])(t)},0),delete this._l[e]}},Modernizr._q.push(function(){C.addTest=s});var E=function(){function e(e,n){var o;return!!e&&(n&&"string"!=typeof n||(n=a(n||"div")),e="on"+e,o=e in n,!o&&t&&(n.setAttribute||(n=a("div")),n.setAttribute(e,""),o="function"==typeof n[e],n[e]!==r&&(n[e]=r),n.removeAttribute(e)),o)}var t=!("onblur"in _);return e}();C.hasEvent=E;var B=function(){var e=t.matchMedia||t.msMatchMedia;return e?function(t){var n=e(t);return n&&n.matches||!1}:function(e){var t=!1;return u("@media "+e+" { #modernizr { position: absolute; } }",function(e){t="absolute"===f(e,null,"position")}),t}}();C.mq=B;var z=function(e,t){var n=!1,r=a("div"),o=r.style;if(e in o){var i=T.length;for(o[e]=t,n=o[e];i--&&!n;)o[e]="-"+T[i]+"-"+t,n=o[e]}return""===n&&(n=!1),n};C.prefixedCSSValue=z;var O=C._config.usePrefixes?x.split(" "):[];C._cssomPrefixes=O;var L={elem:a("modernizr")};Modernizr._q.push(function(){delete L.elem});var N={style:L.elem.style};Modernizr._q.unshift(function(){delete N.style}),C.testAllProps=g,C.testAllProps=y;C.testProp=function(e,t,n){return h([e],r,t,n)},C.testStyles=u;Modernizr.addTest("customelements","customElements"in t),Modernizr.addTest("history",function(){var e=navigator.userAgent;return!!e&&((-1===e.indexOf("Android 2.")&&-1===e.indexOf("Android 4.0")||-1===e.indexOf("Mobile Safari")||-1!==e.indexOf("Chrome")||-1!==e.indexOf("Windows Phone")||"file:"===location.protocol)&&(t.history&&"pushState"in t.history))});var R=[""].concat(T);C._domPrefixesAll=R,Modernizr.addTest("pointerevents",function(){for(var e=0,t=R.length;e<t;e++)if(E(R[e]+"pointerdown"))return!0;return!1});var j=!0;try{t.postMessage({toString:function(){j=!1}},"*")}catch(e){}Modernizr.addTest("postmessage",new Boolean("postMessage"in t)),Modernizr.addTest("postmessage.structuredclones",j),Modernizr.addTest("webgl",function(){return"WebGLRenderingContext"in t});var M=!1;try{M="WebSocket"in t&&2===t.WebSocket.CLOSING}catch(e){}Modernizr.addTest("websockets",M),Modernizr.addTest("cssanimations",y("animationName","a",!0)),function(){Modernizr.addTest("csscolumns",function(){var e=!1,t=y("columnCount");try{e=!!t,e&&(e=new Boolean(e))}catch(e){}return e});for(var e,t,n=["Width","Span","Fill","Gap","Rule","RuleColor","RuleStyle","RuleWidth","BreakBefore","BreakAfter","BreakInside"],r=0;r<n.length;r++)e=n[r].toLowerCase(),t=y("column"+n[r]),"breakbefore"!==e&&"breakafter"!==e&&"breakinside"!==e||(t=t||y(n[r])),Modernizr.addTest("csscolumns."+e,t)}(),Modernizr.addTest("flexbox",y("flexBasis","1px",!0)),Modernizr.addTest("picture","HTMLPictureElement"in t),Modernizr.addAsyncTest(function(){var e,t,n,r=a("img"),o="sizes"in r;!o&&"srcset"in r?(t="data:image/gif;base64,R0lGODlhAgABAPAAAP///wAAACH5BAAAAAAALAAAAAACAAEAAAICBAoAOw==",e="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",n=function(){s("sizes",2===r.width)},r.onload=n,r.onerror=n,r.setAttribute("sizes","9px"),r.srcset=e+" 1w,"+t+" 8w",r.src=e):s("sizes",o)}),Modernizr.addTest("srcset","srcset"in a("img")),Modernizr.addTest("webworkers","Worker"in t),function(){var e,t,n,r,i,s,a;for(var l in w)if(w.hasOwnProperty(l)){if(e=[],t=w[l],t.name&&(e.push(t.name.toLowerCase()),t.options&&t.options.aliases&&t.options.aliases.length))for(n=0;n<t.options.aliases.length;n++)e.push(t.options.aliases[n].toLowerCase());for(r=o(t.fn,"function")?t.fn():t.fn,i=0;i<e.length;i++)s=e[i],a=s.split("."),1===a.length?Modernizr[a[0]]=r:(Modernizr[a[0]]&&(!Modernizr[a[0]]||Modernizr[a[0]]instanceof Boolean)||(Modernizr[a[0]]=new Boolean(Modernizr[a[0]])),Modernizr[a[0]][a[1]]=r),b.push((r?"":"no-")+a.join("-"))}}(),i(b),delete C.addTest,delete C.addAsyncTest;for(var W=0;W<Modernizr._q.length;W++)Modernizr._q[W]();e.Modernizr=Modernizr}(window,window,document);(function(){var method;var noop=function(){};var methods=['assert','clear','count','debug','dir','dirxml','error','exception','group','groupCollapsed','groupEnd','info','log','markTimeline','profile','profileEnd','table','time','timeEnd','timeline','timelineEnd','timeStamp','trace','warn'];var length=methods.length;var console=(window.console=window.console||{});while(length--){method=methods[length];if(!console[method]){console[method]=noop;}}}());(function(global,factory){typeof exports==='object'&&typeof module!=='undefined'?module.exports=factory():typeof define==='function'&&define.amd?define(factory):(global=typeof globalThis!=='undefined'?globalThis:global||self,global.i18next=factory());})(this,(function(){'use strict';const consoleLogger={type:'logger',log(args){this.output('log',args);},warn(args){this.output('warn',args);},error(args){this.output('error',args);},output(type,args){if(console&&console[type])console[type].apply(console,args);}};class Logger{constructor(concreteLogger){let options=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};this.init(concreteLogger,options);}
init(concreteLogger){let options=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};this.prefix=options.prefix||'i18next:';this.logger=concreteLogger||consoleLogger;this.options=options;this.debug=options.debug;}
log(){for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}
return this.forward(args,'log','',true);}
warn(){for(var _len2=arguments.length,args=new Array(_len2),_key2=0;_key2<_len2;_key2++){args[_key2]=arguments[_key2];}
return this.forward(args,'warn','',true);}
error(){for(var _len3=arguments.length,args=new Array(_len3),_key3=0;_key3<_len3;_key3++){args[_key3]=arguments[_key3];}
return this.forward(args,'error','');}
deprecate(){for(var _len4=arguments.length,args=new Array(_len4),_key4=0;_key4<_len4;_key4++){args[_key4]=arguments[_key4];}
return this.forward(args,'warn','WARNING DEPRECATED: ',true);}
forward(args,lvl,prefix,debugOnly){if(debugOnly&&!this.debug)return null;if(typeof args[0]==='string')args[0]=`${prefix}${this.prefix} ${args[0]}`;return this.logger[lvl](args);}
create(moduleName){return new Logger(this.logger,{...{prefix:`${this.prefix}:${moduleName}:`},...this.options});}
clone(options){options=options||this.options;options.prefix=options.prefix||this.prefix;return new Logger(this.logger,options);}}
var baseLogger=new Logger();class EventEmitter{constructor(){this.observers={};}
on(events,listener){events.split(' ').forEach(event=>{if(!this.observers[event])this.observers[event]=new Map();const numListeners=this.observers[event].get(listener)||0;this.observers[event].set(listener,numListeners+1);});return this;}
off(event,listener){if(!this.observers[event])return;if(!listener){delete this.observers[event];return;}
this.observers[event].delete(listener);}
emit(event){for(var _len=arguments.length,args=new Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){args[_key-1]=arguments[_key];}
if(this.observers[event]){const cloned=Array.from(this.observers[event].entries());cloned.forEach(_ref=>{let[observer,numTimesAdded]=_ref;for(let i=0;i<numTimesAdded;i++){observer(...args);}});}
if(this.observers['*']){const cloned=Array.from(this.observers['*'].entries());cloned.forEach(_ref2=>{let[observer,numTimesAdded]=_ref2;for(let i=0;i<numTimesAdded;i++){observer.apply(observer,[event,...args]);}});}}}
function defer(){let res;let rej;const promise=new Promise((resolve,reject)=>{res=resolve;rej=reject;});promise.resolve=res;promise.reject=rej;return promise;}
function makeString(object){if(object==null)return'';return''+object;}
function copy(a,s,t){a.forEach(m=>{if(s[m])t[m]=s[m];});}
const lastOfPathSeparatorRegExp=/###/g;function getLastOfPath(object,path,Empty){function cleanKey(key){return key&&key.indexOf('###')>-1?key.replace(lastOfPathSeparatorRegExp,'.'):key;}
function canNotTraverseDeeper(){return!object||typeof object==='string';}
const stack=typeof path!=='string'?path:path.split('.');let stackIndex=0;while(stackIndex<stack.length-1){if(canNotTraverseDeeper())return{};const key=cleanKey(stack[stackIndex]);if(!object[key]&&Empty)object[key]=new Empty();if(Object.prototype.hasOwnProperty.call(object,key)){object=object[key];}else{object={};}
++stackIndex;}
if(canNotTraverseDeeper())return{};return{obj:object,k:cleanKey(stack[stackIndex])};}
function setPath(object,path,newValue){const{obj,k}=getLastOfPath(object,path,Object);if(obj!==undefined||path.length===1){obj[k]=newValue;return;}
let e=path[path.length-1];let p=path.slice(0,path.length-1);let last=getLastOfPath(object,p,Object);while(last.obj===undefined&&p.length){e=`${p[p.length - 1]}.${e}`;p=p.slice(0,p.length-1);last=getLastOfPath(object,p,Object);if(last&&last.obj&&typeof last.obj[`${last.k}.${e}`]!=='undefined'){last.obj=undefined;}}
last.obj[`${last.k}.${e}`]=newValue;}
function pushPath(object,path,newValue,concat){const{obj,k}=getLastOfPath(object,path,Object);obj[k]=obj[k]||[];if(concat)obj[k]=obj[k].concat(newValue);if(!concat)obj[k].push(newValue);}
function getPath(object,path){const{obj,k}=getLastOfPath(object,path);if(!obj)return undefined;return obj[k];}
function getPathWithDefaults(data,defaultData,key){const value=getPath(data,key);if(value!==undefined){return value;}
return getPath(defaultData,key);}
function deepExtend(target,source,overwrite){for(const prop in source){if(prop!=='__proto__'&&prop!=='constructor'){if(prop in target){if(typeof target[prop]==='string'||target[prop]instanceof String||typeof source[prop]==='string'||source[prop]instanceof String){if(overwrite)target[prop]=source[prop];}else{deepExtend(target[prop],source[prop],overwrite);}}else{target[prop]=source[prop];}}}
return target;}
function regexEscape(str){return str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,'\\$&');}
var _entityMap={'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;'};function escape(data){if(typeof data==='string'){return data.replace(/[&<>"'\/]/g,s=>_entityMap[s]);}
return data;}
class RegExpCache{constructor(capacity){this.capacity=capacity;this.regExpMap=new Map();this.regExpQueue=[];}
getRegExp(pattern){const regExpFromCache=this.regExpMap.get(pattern);if(regExpFromCache!==undefined){return regExpFromCache;}
const regExpNew=new RegExp(pattern);if(this.regExpQueue.length===this.capacity){this.regExpMap.delete(this.regExpQueue.shift());}
this.regExpMap.set(pattern,regExpNew);this.regExpQueue.push(pattern);return regExpNew;}}
const chars=[' ',',','?','!',';'];const looksLikeObjectPathRegExpCache=new RegExpCache(20);function looksLikeObjectPath(key,nsSeparator,keySeparator){nsSeparator=nsSeparator||'';keySeparator=keySeparator||'';const possibleChars=chars.filter(c=>nsSeparator.indexOf(c)<0&&keySeparator.indexOf(c)<0);if(possibleChars.length===0)return true;const r=looksLikeObjectPathRegExpCache.getRegExp(`(${possibleChars.map(c => c === '?' ? '\\?' : c).join('|')})`);let matched=!r.test(key);if(!matched){const ki=key.indexOf(keySeparator);if(ki>0&&!r.test(key.substring(0,ki))){matched=true;}}
return matched;}
function deepFind(obj,path){let keySeparator=arguments.length>2&&arguments[2]!==undefined?arguments[2]:'.';if(!obj)return undefined;if(obj[path])return obj[path];const tokens=path.split(keySeparator);let current=obj;for(let i=0;i<tokens.length;){if(!current||typeof current!=='object'){return undefined;}
let next;let nextPath='';for(let j=i;j<tokens.length;++j){if(j!==i){nextPath+=keySeparator;}
nextPath+=tokens[j];next=current[nextPath];if(next!==undefined){if(['string','number','boolean'].indexOf(typeof next)>-1&&j<tokens.length-1){continue;}
i+=j-i+1;break;}}
current=next;}
return current;}
function getCleanedCode(code){if(code&&code.indexOf('_')>0)return code.replace('_','-');return code;}
class ResourceStore extends EventEmitter{constructor(data){let options=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{ns:['translation'],defaultNS:'translation'};super();this.data=data||{};this.options=options;if(this.options.keySeparator===undefined){this.options.keySeparator='.';}
if(this.options.ignoreJSONStructure===undefined){this.options.ignoreJSONStructure=true;}}
addNamespaces(ns){if(this.options.ns.indexOf(ns)<0){this.options.ns.push(ns);}}
removeNamespaces(ns){const index=this.options.ns.indexOf(ns);if(index>-1){this.options.ns.splice(index,1);}}
getResource(lng,ns,key){let options=arguments.length>3&&arguments[3]!==undefined?arguments[3]:{};const keySeparator=options.keySeparator!==undefined?options.keySeparator:this.options.keySeparator;const ignoreJSONStructure=options.ignoreJSONStructure!==undefined?options.ignoreJSONStructure:this.options.ignoreJSONStructure;let path;if(lng.indexOf('.')>-1){path=lng.split('.');}else{path=[lng,ns];if(key){if(Array.isArray(key)){path.push(...key);}else if(typeof key==='string'&&keySeparator){path.push(...key.split(keySeparator));}else{path.push(key);}}}
const result=getPath(this.data,path);if(!result&&!ns&&!key&&lng.indexOf('.')>-1){lng=path[0];ns=path[1];key=path.slice(2).join('.');}
if(result||!ignoreJSONStructure||typeof key!=='string')return result;return deepFind(this.data&&this.data[lng]&&this.data[lng][ns],key,keySeparator);}
addResource(lng,ns,key,value){let options=arguments.length>4&&arguments[4]!==undefined?arguments[4]:{silent:false};const keySeparator=options.keySeparator!==undefined?options.keySeparator:this.options.keySeparator;let path=[lng,ns];if(key)path=path.concat(keySeparator?key.split(keySeparator):key);if(lng.indexOf('.')>-1){path=lng.split('.');value=ns;ns=path[1];}
this.addNamespaces(ns);setPath(this.data,path,value);if(!options.silent)this.emit('added',lng,ns,key,value);}
addResources(lng,ns,resources){let options=arguments.length>3&&arguments[3]!==undefined?arguments[3]:{silent:false};for(const m in resources){if(typeof resources[m]==='string'||Object.prototype.toString.apply(resources[m])==='[object Array]')this.addResource(lng,ns,m,resources[m],{silent:true});}
if(!options.silent)this.emit('added',lng,ns,resources);}
addResourceBundle(lng,ns,resources,deep,overwrite){let options=arguments.length>5&&arguments[5]!==undefined?arguments[5]:{silent:false,skipCopy:false};let path=[lng,ns];if(lng.indexOf('.')>-1){path=lng.split('.');deep=resources;resources=ns;ns=path[1];}
this.addNamespaces(ns);let pack=getPath(this.data,path)||{};if(!options.skipCopy)resources=JSON.parse(JSON.stringify(resources));if(deep){deepExtend(pack,resources,overwrite);}else{pack={...pack,...resources};}
setPath(this.data,path,pack);if(!options.silent)this.emit('added',lng,ns,resources);}
removeResourceBundle(lng,ns){if(this.hasResourceBundle(lng,ns)){delete this.data[lng][ns];}
this.removeNamespaces(ns);this.emit('removed',lng,ns);}
hasResourceBundle(lng,ns){return this.getResource(lng,ns)!==undefined;}
getResourceBundle(lng,ns){if(!ns)ns=this.options.defaultNS;if(this.options.compatibilityAPI==='v1')return{...{},...this.getResource(lng,ns)};return this.getResource(lng,ns);}
getDataByLanguage(lng){return this.data[lng];}
hasLanguageSomeTranslations(lng){const data=this.getDataByLanguage(lng);const n=data&&Object.keys(data)||[];return!!n.find(v=>data[v]&&Object.keys(data[v]).length>0);}
toJSON(){return this.data;}}
var postProcessor={processors:{},addPostProcessor(module){this.processors[module.name]=module;},handle(processors,value,key,options,translator){processors.forEach(processor=>{if(this.processors[processor])value=this.processors[processor].process(value,key,options,translator);});return value;}};const checkedLoadedFor={};class Translator extends EventEmitter{constructor(services){let options=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};super();copy(['resourceStore','languageUtils','pluralResolver','interpolator','backendConnector','i18nFormat','utils'],services,this);this.options=options;if(this.options.keySeparator===undefined){this.options.keySeparator='.';}
this.logger=baseLogger.create('translator');}
changeLanguage(lng){if(lng)this.language=lng;}
exists(key){let options=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{interpolation:{}};if(key===undefined||key===null){return false;}
const resolved=this.resolve(key,options);return resolved&&resolved.res!==undefined;}
extractFromKey(key,options){let nsSeparator=options.nsSeparator!==undefined?options.nsSeparator:this.options.nsSeparator;if(nsSeparator===undefined)nsSeparator=':';const keySeparator=options.keySeparator!==undefined?options.keySeparator:this.options.keySeparator;let namespaces=options.ns||this.options.defaultNS||[];const wouldCheckForNsInKey=nsSeparator&&key.indexOf(nsSeparator)>-1;const seemsNaturalLanguage=!this.options.userDefinedKeySeparator&&!options.keySeparator&&!this.options.userDefinedNsSeparator&&!options.nsSeparator&&!looksLikeObjectPath(key,nsSeparator,keySeparator);if(wouldCheckForNsInKey&&!seemsNaturalLanguage){const m=key.match(this.interpolator.nestingRegexp);if(m&&m.length>0){return{key,namespaces};}
const parts=key.split(nsSeparator);if(nsSeparator!==keySeparator||nsSeparator===keySeparator&&this.options.ns.indexOf(parts[0])>-1)namespaces=parts.shift();key=parts.join(keySeparator);}
if(typeof namespaces==='string')namespaces=[namespaces];return{key,namespaces};}
translate(keys,options,lastKey){if(typeof options!=='object'&&this.options.overloadTranslationOptionHandler){options=this.options.overloadTranslationOptionHandler(arguments);}
if(typeof options==='object')options={...options};if(!options)options={};if(keys===undefined||keys===null)return'';if(!Array.isArray(keys))keys=[String(keys)];const returnDetails=options.returnDetails!==undefined?options.returnDetails:this.options.returnDetails;const keySeparator=options.keySeparator!==undefined?options.keySeparator:this.options.keySeparator;const{key,namespaces}=this.extractFromKey(keys[keys.length-1],options);const namespace=namespaces[namespaces.length-1];const lng=options.lng||this.language;const appendNamespaceToCIMode=options.appendNamespaceToCIMode||this.options.appendNamespaceToCIMode;if(lng&&lng.toLowerCase()==='cimode'){if(appendNamespaceToCIMode){const nsSeparator=options.nsSeparator||this.options.nsSeparator;if(returnDetails){return{res:`${namespace}${nsSeparator}${key}`,usedKey:key,exactUsedKey:key,usedLng:lng,usedNS:namespace,usedParams:this.getUsedParamsDetails(options)};}
return`${namespace}${nsSeparator}${key}`;}
if(returnDetails){return{res:key,usedKey:key,exactUsedKey:key,usedLng:lng,usedNS:namespace,usedParams:this.getUsedParamsDetails(options)};}
return key;}
const resolved=this.resolve(keys,options);let res=resolved&&resolved.res;const resUsedKey=resolved&&resolved.usedKey||key;const resExactUsedKey=resolved&&resolved.exactUsedKey||key;const resType=Object.prototype.toString.apply(res);const noObject=['[object Number]','[object Function]','[object RegExp]'];const joinArrays=options.joinArrays!==undefined?options.joinArrays:this.options.joinArrays;const handleAsObjectInI18nFormat=!this.i18nFormat||this.i18nFormat.handleAsObject;const handleAsObject=typeof res!=='string'&&typeof res!=='boolean'&&typeof res!=='number';if(handleAsObjectInI18nFormat&&res&&handleAsObject&&noObject.indexOf(resType)<0&&!(typeof joinArrays==='string'&&resType==='[object Array]')){if(!options.returnObjects&&!this.options.returnObjects){if(!this.options.returnedObjectHandler){this.logger.warn('accessing an object - but returnObjects options is not enabled!');}
const r=this.options.returnedObjectHandler?this.options.returnedObjectHandler(resUsedKey,res,{...options,ns:namespaces}):`key '${key} (${this.language})' returned an object instead of string.`;if(returnDetails){resolved.res=r;resolved.usedParams=this.getUsedParamsDetails(options);return resolved;}
return r;}
if(keySeparator){const resTypeIsArray=resType==='[object Array]';const copy=resTypeIsArray?[]:{};const newKeyToUse=resTypeIsArray?resExactUsedKey:resUsedKey;for(const m in res){if(Object.prototype.hasOwnProperty.call(res,m)){const deepKey=`${newKeyToUse}${keySeparator}${m}`;copy[m]=this.translate(deepKey,{...options,...{joinArrays:false,ns:namespaces}});if(copy[m]===deepKey)copy[m]=res[m];}}
res=copy;}}else if(handleAsObjectInI18nFormat&&typeof joinArrays==='string'&&resType==='[object Array]'){res=res.join(joinArrays);if(res)res=this.extendTranslation(res,keys,options,lastKey);}else{let usedDefault=false;let usedKey=false;const needsPluralHandling=options.count!==undefined&&typeof options.count!=='string';const hasDefaultValue=Translator.hasDefaultValue(options);const defaultValueSuffix=needsPluralHandling?this.pluralResolver.getSuffix(lng,options.count,options):'';const defaultValueSuffixOrdinalFallback=options.ordinal&&needsPluralHandling?this.pluralResolver.getSuffix(lng,options.count,{ordinal:false}):'';const needsZeroSuffixLookup=needsPluralHandling&&!options.ordinal&&options.count===0&&this.pluralResolver.shouldUseIntlApi();const defaultValue=needsZeroSuffixLookup&&options[`defaultValue${this.options.pluralSeparator}zero`]||options[`defaultValue${defaultValueSuffix}`]||options[`defaultValue${defaultValueSuffixOrdinalFallback}`]||options.defaultValue;if(!this.isValidLookup(res)&&hasDefaultValue){usedDefault=true;res=defaultValue;}
if(!this.isValidLookup(res)){usedKey=true;res=key;}
const missingKeyNoValueFallbackToKey=options.missingKeyNoValueFallbackToKey||this.options.missingKeyNoValueFallbackToKey;const resForMissing=missingKeyNoValueFallbackToKey&&usedKey?undefined:res;const updateMissing=hasDefaultValue&&defaultValue!==res&&this.options.updateMissing;if(usedKey||usedDefault||updateMissing){this.logger.log(updateMissing?'updateKey':'missingKey',lng,namespace,key,updateMissing?defaultValue:res);if(keySeparator){const fk=this.resolve(key,{...options,keySeparator:false});if(fk&&fk.res)this.logger.warn('Seems the loaded translations were in flat JSON format instead of nested. Either set keySeparator: false on init or make sure your translations are published in nested format.');}
let lngs=[];const fallbackLngs=this.languageUtils.getFallbackCodes(this.options.fallbackLng,options.lng||this.language);if(this.options.saveMissingTo==='fallback'&&fallbackLngs&&fallbackLngs[0]){for(let i=0;i<fallbackLngs.length;i++){lngs.push(fallbackLngs[i]);}}else if(this.options.saveMissingTo==='all'){lngs=this.languageUtils.toResolveHierarchy(options.lng||this.language);}else{lngs.push(options.lng||this.language);}
const send=(l,k,specificDefaultValue)=>{const defaultForMissing=hasDefaultValue&&specificDefaultValue!==res?specificDefaultValue:resForMissing;if(this.options.missingKeyHandler){this.options.missingKeyHandler(l,namespace,k,defaultForMissing,updateMissing,options);}else if(this.backendConnector&&this.backendConnector.saveMissing){this.backendConnector.saveMissing(l,namespace,k,defaultForMissing,updateMissing,options);}
this.emit('missingKey',l,namespace,k,res);};if(this.options.saveMissing){if(this.options.saveMissingPlurals&&needsPluralHandling){lngs.forEach(language=>{const suffixes=this.pluralResolver.getSuffixes(language,options);if(needsZeroSuffixLookup&&options[`defaultValue${this.options.pluralSeparator}zero`]&&suffixes.indexOf(`${this.options.pluralSeparator}zero`)<0){suffixes.push(`${this.options.pluralSeparator}zero`);}
suffixes.forEach(suffix=>{send([language],key+suffix,options[`defaultValue${suffix}`]||defaultValue);});});}else{send(lngs,key,defaultValue);}}}
res=this.extendTranslation(res,keys,options,resolved,lastKey);if(usedKey&&res===key&&this.options.appendNamespaceToMissingKey)res=`${namespace}:${key}`;if((usedKey||usedDefault)&&this.options.parseMissingKeyHandler){if(this.options.compatibilityAPI!=='v1'){res=this.options.parseMissingKeyHandler(this.options.appendNamespaceToMissingKey?`${namespace}:${key}`:key,usedDefault?res:undefined);}else{res=this.options.parseMissingKeyHandler(res);}}}
if(returnDetails){resolved.res=res;resolved.usedParams=this.getUsedParamsDetails(options);return resolved;}
return res;}
extendTranslation(res,key,options,resolved,lastKey){var _this=this;if(this.i18nFormat&&this.i18nFormat.parse){res=this.i18nFormat.parse(res,{...this.options.interpolation.defaultVariables,...options},options.lng||this.language||resolved.usedLng,resolved.usedNS,resolved.usedKey,{resolved});}else if(!options.skipInterpolation){if(options.interpolation)this.interpolator.init({...options,...{interpolation:{...this.options.interpolation,...options.interpolation}}});const skipOnVariables=typeof res==='string'&&(options&&options.interpolation&&options.interpolation.skipOnVariables!==undefined?options.interpolation.skipOnVariables:this.options.interpolation.skipOnVariables);let nestBef;if(skipOnVariables){const nb=res.match(this.interpolator.nestingRegexp);nestBef=nb&&nb.length;}
let data=options.replace&&typeof options.replace!=='string'?options.replace:options;if(this.options.interpolation.defaultVariables)data={...this.options.interpolation.defaultVariables,...data};res=this.interpolator.interpolate(res,data,options.lng||this.language,options);if(skipOnVariables){const na=res.match(this.interpolator.nestingRegexp);const nestAft=na&&na.length;if(nestBef<nestAft)options.nest=false;}
if(!options.lng&&this.options.compatibilityAPI!=='v1'&&resolved&&resolved.res)options.lng=resolved.usedLng;if(options.nest!==false)res=this.interpolator.nest(res,function(){for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}
if(lastKey&&lastKey[0]===args[0]&&!options.context){_this.logger.warn(`It seems you are nesting recursively key: ${args[0]} in key: ${key[0]}`);return null;}
return _this.translate(...args,key);},options);if(options.interpolation)this.interpolator.reset();}
const postProcess=options.postProcess||this.options.postProcess;const postProcessorNames=typeof postProcess==='string'?[postProcess]:postProcess;if(res!==undefined&&res!==null&&postProcessorNames&&postProcessorNames.length&&options.applyPostProcessor!==false){res=postProcessor.handle(postProcessorNames,res,key,this.options&&this.options.postProcessPassResolved?{i18nResolved:{...resolved,usedParams:this.getUsedParamsDetails(options)},...options}:options,this);}
return res;}
resolve(keys){let options=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};let found;let usedKey;let exactUsedKey;let usedLng;let usedNS;if(typeof keys==='string')keys=[keys];keys.forEach(k=>{if(this.isValidLookup(found))return;const extracted=this.extractFromKey(k,options);const key=extracted.key;usedKey=key;let namespaces=extracted.namespaces;if(this.options.fallbackNS)namespaces=namespaces.concat(this.options.fallbackNS);const needsPluralHandling=options.count!==undefined&&typeof options.count!=='string';const needsZeroSuffixLookup=needsPluralHandling&&!options.ordinal&&options.count===0&&this.pluralResolver.shouldUseIntlApi();const needsContextHandling=options.context!==undefined&&(typeof options.context==='string'||typeof options.context==='number')&&options.context!=='';const codes=options.lngs?options.lngs:this.languageUtils.toResolveHierarchy(options.lng||this.language,options.fallbackLng);namespaces.forEach(ns=>{if(this.isValidLookup(found))return;usedNS=ns;if(!checkedLoadedFor[`${codes[0]}-${ns}`]&&this.utils&&this.utils.hasLoadedNamespace&&!this.utils.hasLoadedNamespace(usedNS)){checkedLoadedFor[`${codes[0]}-${ns}`]=true;this.logger.warn(`key "${usedKey}" for languages "${codes.join(', ')}" won't get resolved as namespace "${usedNS}" was not yet loaded`,'This means something IS WRONG in your setup. You access the t function before i18next.init / i18next.loadNamespace / i18next.changeLanguage was done. Wait for the callback or Promise to resolve before accessing it!!!');}
codes.forEach(code=>{if(this.isValidLookup(found))return;usedLng=code;const finalKeys=[key];if(this.i18nFormat&&this.i18nFormat.addLookupKeys){this.i18nFormat.addLookupKeys(finalKeys,key,code,ns,options);}else{let pluralSuffix;if(needsPluralHandling)pluralSuffix=this.pluralResolver.getSuffix(code,options.count,options);const zeroSuffix=`${this.options.pluralSeparator}zero`;const ordinalPrefix=`${this.options.pluralSeparator}ordinal${this.options.pluralSeparator}`;if(needsPluralHandling){finalKeys.push(key+pluralSuffix);if(options.ordinal&&pluralSuffix.indexOf(ordinalPrefix)===0){finalKeys.push(key+pluralSuffix.replace(ordinalPrefix,this.options.pluralSeparator));}
if(needsZeroSuffixLookup){finalKeys.push(key+zeroSuffix);}}
if(needsContextHandling){const contextKey=`${key}${this.options.contextSeparator}${options.context}`;finalKeys.push(contextKey);if(needsPluralHandling){finalKeys.push(contextKey+pluralSuffix);if(options.ordinal&&pluralSuffix.indexOf(ordinalPrefix)===0){finalKeys.push(contextKey+pluralSuffix.replace(ordinalPrefix,this.options.pluralSeparator));}
if(needsZeroSuffixLookup){finalKeys.push(contextKey+zeroSuffix);}}}}
let possibleKey;while(possibleKey=finalKeys.pop()){if(!this.isValidLookup(found)){exactUsedKey=possibleKey;found=this.getResource(code,ns,possibleKey,options);}}});});});return{res:found,usedKey,exactUsedKey,usedLng,usedNS};}
isValidLookup(res){return res!==undefined&&!(!this.options.returnNull&&res===null)&&!(!this.options.returnEmptyString&&res==='');}
getResource(code,ns,key){let options=arguments.length>3&&arguments[3]!==undefined?arguments[3]:{};if(this.i18nFormat&&this.i18nFormat.getResource)return this.i18nFormat.getResource(code,ns,key,options);return this.resourceStore.getResource(code,ns,key,options);}
getUsedParamsDetails(){let options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};const optionsKeys=['defaultValue','ordinal','context','replace','lng','lngs','fallbackLng','ns','keySeparator','nsSeparator','returnObjects','returnDetails','joinArrays','postProcess','interpolation'];const useOptionsReplaceForData=options.replace&&typeof options.replace!=='string';let data=useOptionsReplaceForData?options.replace:options;if(useOptionsReplaceForData&&typeof options.count!=='undefined'){data.count=options.count;}
if(this.options.interpolation.defaultVariables){data={...this.options.interpolation.defaultVariables,...data};}
if(!useOptionsReplaceForData){data={...data};for(const key of optionsKeys){delete data[key];}}
return data;}
static hasDefaultValue(options){const prefix='defaultValue';for(const option in options){if(Object.prototype.hasOwnProperty.call(options,option)&&prefix===option.substring(0,prefix.length)&&undefined!==options[option]){return true;}}
return false;}}
function capitalize(string){return string.charAt(0).toUpperCase()+string.slice(1);}
class LanguageUtil{constructor(options){this.options=options;this.supportedLngs=this.options.supportedLngs||false;this.logger=baseLogger.create('languageUtils');}
getScriptPartFromCode(code){code=getCleanedCode(code);if(!code||code.indexOf('-')<0)return null;const p=code.split('-');if(p.length===2)return null;p.pop();if(p[p.length-1].toLowerCase()==='x')return null;return this.formatLanguageCode(p.join('-'));}
getLanguagePartFromCode(code){code=getCleanedCode(code);if(!code||code.indexOf('-')<0)return code;const p=code.split('-');return this.formatLanguageCode(p[0]);}
formatLanguageCode(code){if(typeof code==='string'&&code.indexOf('-')>-1){const specialCases=['hans','hant','latn','cyrl','cans','mong','arab'];let p=code.split('-');if(this.options.lowerCaseLng){p=p.map(part=>part.toLowerCase());}else if(p.length===2){p[0]=p[0].toLowerCase();p[1]=p[1].toUpperCase();if(specialCases.indexOf(p[1].toLowerCase())>-1)p[1]=capitalize(p[1].toLowerCase());}else if(p.length===3){p[0]=p[0].toLowerCase();if(p[1].length===2)p[1]=p[1].toUpperCase();if(p[0]!=='sgn'&&p[2].length===2)p[2]=p[2].toUpperCase();if(specialCases.indexOf(p[1].toLowerCase())>-1)p[1]=capitalize(p[1].toLowerCase());if(specialCases.indexOf(p[2].toLowerCase())>-1)p[2]=capitalize(p[2].toLowerCase());}
return p.join('-');}
return this.options.cleanCode||this.options.lowerCaseLng?code.toLowerCase():code;}
isSupportedCode(code){if(this.options.load==='languageOnly'||this.options.nonExplicitSupportedLngs){code=this.getLanguagePartFromCode(code);}
return!this.supportedLngs||!this.supportedLngs.length||this.supportedLngs.indexOf(code)>-1;}
getBestMatchFromCodes(codes){if(!codes)return null;let found;codes.forEach(code=>{if(found)return;const cleanedLng=this.formatLanguageCode(code);if(!this.options.supportedLngs||this.isSupportedCode(cleanedLng))found=cleanedLng;});if(!found&&this.options.supportedLngs){codes.forEach(code=>{if(found)return;const lngOnly=this.getLanguagePartFromCode(code);if(this.isSupportedCode(lngOnly))return found=lngOnly;found=this.options.supportedLngs.find(supportedLng=>{if(supportedLng===lngOnly)return supportedLng;if(supportedLng.indexOf('-')<0&&lngOnly.indexOf('-')<0)return;if(supportedLng.indexOf('-')>0&&lngOnly.indexOf('-')<0&&supportedLng.substring(0,supportedLng.indexOf('-'))===lngOnly)return supportedLng;if(supportedLng.indexOf(lngOnly)===0&&lngOnly.length>1)return supportedLng;});});}
if(!found)found=this.getFallbackCodes(this.options.fallbackLng)[0];return found;}
getFallbackCodes(fallbacks,code){if(!fallbacks)return[];if(typeof fallbacks==='function')fallbacks=fallbacks(code);if(typeof fallbacks==='string')fallbacks=[fallbacks];if(Object.prototype.toString.apply(fallbacks)==='[object Array]')return fallbacks;if(!code)return fallbacks.default||[];let found=fallbacks[code];if(!found)found=fallbacks[this.getScriptPartFromCode(code)];if(!found)found=fallbacks[this.formatLanguageCode(code)];if(!found)found=fallbacks[this.getLanguagePartFromCode(code)];if(!found)found=fallbacks.default;return found||[];}
toResolveHierarchy(code,fallbackCode){const fallbackCodes=this.getFallbackCodes(fallbackCode||this.options.fallbackLng||[],code);const codes=[];const addCode=c=>{if(!c)return;if(this.isSupportedCode(c)){codes.push(c);}else{this.logger.warn(`rejecting language code not found in supportedLngs: ${c}`);}};if(typeof code==='string'&&(code.indexOf('-')>-1||code.indexOf('_')>-1)){if(this.options.load!=='languageOnly')addCode(this.formatLanguageCode(code));if(this.options.load!=='languageOnly'&&this.options.load!=='currentOnly')addCode(this.getScriptPartFromCode(code));if(this.options.load!=='currentOnly')addCode(this.getLanguagePartFromCode(code));}else if(typeof code==='string'){addCode(this.formatLanguageCode(code));}
fallbackCodes.forEach(fc=>{if(codes.indexOf(fc)<0)addCode(this.formatLanguageCode(fc));});return codes;}}
let sets=[{lngs:['ach','ak','am','arn','br','fil','gun','ln','mfe','mg','mi','oc','pt','pt-BR','tg','tl','ti','tr','uz','wa'],nr:[1,2],fc:1},{lngs:['af','an','ast','az','bg','bn','ca','da','de','dev','el','en','eo','es','et','eu','fi','fo','fur','fy','gl','gu','ha','hi','hu','hy','ia','it','kk','kn','ku','lb','mai','ml','mn','mr','nah','nap','nb','ne','nl','nn','no','nso','pa','pap','pms','ps','pt-PT','rm','sco','se','si','so','son','sq','sv','sw','ta','te','tk','ur','yo'],nr:[1,2],fc:2},{lngs:['ay','bo','cgg','fa','ht','id','ja','jbo','ka','km','ko','ky','lo','ms','sah','su','th','tt','ug','vi','wo','zh'],nr:[1],fc:3},{lngs:['be','bs','cnr','dz','hr','ru','sr','uk'],nr:[1,2,5],fc:4},{lngs:['ar'],nr:[0,1,2,3,11,100],fc:5},{lngs:['cs','sk'],nr:[1,2,5],fc:6},{lngs:['csb','pl'],nr:[1,2,5],fc:7},{lngs:['cy'],nr:[1,2,3,8],fc:8},{lngs:['fr'],nr:[1,2],fc:9},{lngs:['ga'],nr:[1,2,3,7,11],fc:10},{lngs:['gd'],nr:[1,2,3,20],fc:11},{lngs:['is'],nr:[1,2],fc:12},{lngs:['jv'],nr:[0,1],fc:13},{lngs:['kw'],nr:[1,2,3,4],fc:14},{lngs:['lt'],nr:[1,2,10],fc:15},{lngs:['lv'],nr:[1,2,0],fc:16},{lngs:['mk'],nr:[1,2],fc:17},{lngs:['mnk'],nr:[0,1,2],fc:18},{lngs:['mt'],nr:[1,2,11,20],fc:19},{lngs:['or'],nr:[2,1],fc:2},{lngs:['ro'],nr:[1,2,20],fc:20},{lngs:['sl'],nr:[5,1,2,3],fc:21},{lngs:['he','iw'],nr:[1,2,20,21],fc:22}];let _rulesPluralsTypes={1:function(n){return Number(n>1);},2:function(n){return Number(n!=1);},3:function(n){return 0;},4:function(n){return Number(n%10==1&&n%100!=11?0:n%10>=2&&n%10<=4&&(n%100<10||n%100>=20)?1:2);},5:function(n){return Number(n==0?0:n==1?1:n==2?2:n%100>=3&&n%100<=10?3:n%100>=11?4:5);},6:function(n){return Number(n==1?0:n>=2&&n<=4?1:2);},7:function(n){return Number(n==1?0:n%10>=2&&n%10<=4&&(n%100<10||n%100>=20)?1:2);},8:function(n){return Number(n==1?0:n==2?1:n!=8&&n!=11?2:3);},9:function(n){return Number(n>=2);},10:function(n){return Number(n==1?0:n==2?1:n<7?2:n<11?3:4);},11:function(n){return Number(n==1||n==11?0:n==2||n==12?1:n>2&&n<20?2:3);},12:function(n){return Number(n%10!=1||n%100==11);},13:function(n){return Number(n!==0);},14:function(n){return Number(n==1?0:n==2?1:n==3?2:3);},15:function(n){return Number(n%10==1&&n%100!=11?0:n%10>=2&&(n%100<10||n%100>=20)?1:2);},16:function(n){return Number(n%10==1&&n%100!=11?0:n!==0?1:2);},17:function(n){return Number(n==1||n%10==1&&n%100!=11?0:1);},18:function(n){return Number(n==0?0:n==1?1:2);},19:function(n){return Number(n==1?0:n==0||n%100>1&&n%100<11?1:n%100>10&&n%100<20?2:3);},20:function(n){return Number(n==1?0:n==0||n%100>0&&n%100<20?1:2);},21:function(n){return Number(n%100==1?1:n%100==2?2:n%100==3||n%100==4?3:0);},22:function(n){return Number(n==1?0:n==2?1:(n<0||n>10)&&n%10==0?2:3);}};const nonIntlVersions=['v1','v2','v3'];const intlVersions=['v4'];const suffixesOrder={zero:0,one:1,two:2,few:3,many:4,other:5};function createRules(){const rules={};sets.forEach(set=>{set.lngs.forEach(l=>{rules[l]={numbers:set.nr,plurals:_rulesPluralsTypes[set.fc]};});});return rules;}
class PluralResolver{constructor(languageUtils){let options=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};this.languageUtils=languageUtils;this.options=options;this.logger=baseLogger.create('pluralResolver');if((!this.options.compatibilityJSON||intlVersions.includes(this.options.compatibilityJSON))&&(typeof Intl==='undefined'||!Intl.PluralRules)){this.options.compatibilityJSON='v3';this.logger.error('Your environment seems not to be Intl API compatible, use an Intl.PluralRules polyfill. Will fallback to the compatibilityJSON v3 format handling.');}
this.rules=createRules();}
addRule(lng,obj){this.rules[lng]=obj;}
getRule(code){let options=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};if(this.shouldUseIntlApi()){try{return new Intl.PluralRules(getCleanedCode(code==='dev'?'en':code),{type:options.ordinal?'ordinal':'cardinal'});}catch(err){return;}}
return this.rules[code]||this.rules[this.languageUtils.getLanguagePartFromCode(code)];}
needsPlural(code){let options=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};const rule=this.getRule(code,options);if(this.shouldUseIntlApi()){return rule&&rule.resolvedOptions().pluralCategories.length>1;}
return rule&&rule.numbers.length>1;}
getPluralFormsOfKey(code,key){let options=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};return this.getSuffixes(code,options).map(suffix=>`${key}${suffix}`);}
getSuffixes(code){let options=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};const rule=this.getRule(code,options);if(!rule){return[];}
if(this.shouldUseIntlApi()){return rule.resolvedOptions().pluralCategories.sort((pluralCategory1,pluralCategory2)=>suffixesOrder[pluralCategory1]-suffixesOrder[pluralCategory2]).map(pluralCategory=>`${this.options.prepend}${options.ordinal ? `ordinal${this.options.prepend}` : ''}${pluralCategory}`);}
return rule.numbers.map(number=>this.getSuffix(code,number,options));}
getSuffix(code,count){let options=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};const rule=this.getRule(code,options);if(rule){if(this.shouldUseIntlApi()){return`${this.options.prepend}${options.ordinal ? `ordinal${this.options.prepend}` : ''}${rule.select(count)}`;}
return this.getSuffixRetroCompatible(rule,count);}
this.logger.warn(`no plural rule found for: ${code}`);return'';}
getSuffixRetroCompatible(rule,count){const idx=rule.noAbs?rule.plurals(count):rule.plurals(Math.abs(count));let suffix=rule.numbers[idx];if(this.options.simplifyPluralSuffix&&rule.numbers.length===2&&rule.numbers[0]===1){if(suffix===2){suffix='plural';}else if(suffix===1){suffix='';}}
const returnSuffix=()=>this.options.prepend&&suffix.toString()?this.options.prepend+suffix.toString():suffix.toString();if(this.options.compatibilityJSON==='v1'){if(suffix===1)return'';if(typeof suffix==='number')return`_plural_${suffix.toString()}`;return returnSuffix();}else if(this.options.compatibilityJSON==='v2'){return returnSuffix();}else if(this.options.simplifyPluralSuffix&&rule.numbers.length===2&&rule.numbers[0]===1){return returnSuffix();}
return this.options.prepend&&idx.toString()?this.options.prepend+idx.toString():idx.toString();}
shouldUseIntlApi(){return!nonIntlVersions.includes(this.options.compatibilityJSON);}}
function deepFindWithDefaults(data,defaultData,key){let keySeparator=arguments.length>3&&arguments[3]!==undefined?arguments[3]:'.';let ignoreJSONStructure=arguments.length>4&&arguments[4]!==undefined?arguments[4]:true;let path=getPathWithDefaults(data,defaultData,key);if(!path&&ignoreJSONStructure&&typeof key==='string'){path=deepFind(data,key,keySeparator);if(path===undefined)path=deepFind(defaultData,key,keySeparator);}
return path;}
class Interpolator{constructor(){let options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};this.logger=baseLogger.create('interpolator');this.options=options;this.format=options.interpolation&&options.interpolation.format||(value=>value);this.init(options);}
init(){let options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};if(!options.interpolation)options.interpolation={escapeValue:true};const iOpts=options.interpolation;this.escape=iOpts.escape!==undefined?iOpts.escape:escape;this.escapeValue=iOpts.escapeValue!==undefined?iOpts.escapeValue:true;this.useRawValueToEscape=iOpts.useRawValueToEscape!==undefined?iOpts.useRawValueToEscape:false;this.prefix=iOpts.prefix?regexEscape(iOpts.prefix):iOpts.prefixEscaped||'{{';this.suffix=iOpts.suffix?regexEscape(iOpts.suffix):iOpts.suffixEscaped||'}}';this.formatSeparator=iOpts.formatSeparator?iOpts.formatSeparator:iOpts.formatSeparator||',';this.unescapePrefix=iOpts.unescapeSuffix?'':iOpts.unescapePrefix||'-';this.unescapeSuffix=this.unescapePrefix?'':iOpts.unescapeSuffix||'';this.nestingPrefix=iOpts.nestingPrefix?regexEscape(iOpts.nestingPrefix):iOpts.nestingPrefixEscaped||regexEscape('$t(');this.nestingSuffix=iOpts.nestingSuffix?regexEscape(iOpts.nestingSuffix):iOpts.nestingSuffixEscaped||regexEscape(')');this.nestingOptionsSeparator=iOpts.nestingOptionsSeparator?iOpts.nestingOptionsSeparator:iOpts.nestingOptionsSeparator||',';this.maxReplaces=iOpts.maxReplaces?iOpts.maxReplaces:1000;this.alwaysFormat=iOpts.alwaysFormat!==undefined?iOpts.alwaysFormat:false;this.resetRegExp();}
reset(){if(this.options)this.init(this.options);}
resetRegExp(){const getOrResetRegExp=(existingRegExp,pattern)=>{if(existingRegExp&&existingRegExp.source===pattern){existingRegExp.lastIndex=0;return existingRegExp;}
return new RegExp(pattern,'g');};this.regexp=getOrResetRegExp(this.regexp,`${this.prefix}(.+?)${this.suffix}`);this.regexpUnescape=getOrResetRegExp(this.regexpUnescape,`${this.prefix}${this.unescapePrefix}(.+?)${this.unescapeSuffix}${this.suffix}`);this.nestingRegexp=getOrResetRegExp(this.nestingRegexp,`${this.nestingPrefix}(.+?)${this.nestingSuffix}`);}
interpolate(str,data,lng,options){let match;let value;let replaces;const defaultData=this.options&&this.options.interpolation&&this.options.interpolation.defaultVariables||{};function regexSafe(val){return val.replace(/\$/g,'$$$$');}
const handleFormat=key=>{if(key.indexOf(this.formatSeparator)<0){const path=deepFindWithDefaults(data,defaultData,key,this.options.keySeparator,this.options.ignoreJSONStructure);return this.alwaysFormat?this.format(path,undefined,lng,{...options,...data,interpolationkey:key}):path;}
const p=key.split(this.formatSeparator);const k=p.shift().trim();const f=p.join(this.formatSeparator).trim();return this.format(deepFindWithDefaults(data,defaultData,k,this.options.keySeparator,this.options.ignoreJSONStructure),f,lng,{...options,...data,interpolationkey:k});};this.resetRegExp();const missingInterpolationHandler=options&&options.missingInterpolationHandler||this.options.missingInterpolationHandler;const skipOnVariables=options&&options.interpolation&&options.interpolation.skipOnVariables!==undefined?options.interpolation.skipOnVariables:this.options.interpolation.skipOnVariables;const todos=[{regex:this.regexpUnescape,safeValue:val=>regexSafe(val)},{regex:this.regexp,safeValue:val=>this.escapeValue?regexSafe(this.escape(val)):regexSafe(val)}];todos.forEach(todo=>{replaces=0;while(match=todo.regex.exec(str)){const matchedVar=match[1].trim();value=handleFormat(matchedVar);if(value===undefined){if(typeof missingInterpolationHandler==='function'){const temp=missingInterpolationHandler(str,match,options);value=typeof temp==='string'?temp:'';}else if(options&&Object.prototype.hasOwnProperty.call(options,matchedVar)){value='';}else if(skipOnVariables){value=match[0];continue;}else{this.logger.warn(`missed to pass in variable ${matchedVar} for interpolating ${str}`);value='';}}else if(typeof value!=='string'&&!this.useRawValueToEscape){value=makeString(value);}
const safeValue=todo.safeValue(value);str=str.replace(match[0],safeValue);if(skipOnVariables){todo.regex.lastIndex+=value.length;todo.regex.lastIndex-=match[0].length;}else{todo.regex.lastIndex=0;}
replaces++;if(replaces>=this.maxReplaces){break;}}});return str;}
nest(str,fc){let options=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};let match;let value;let clonedOptions;function handleHasOptions(key,inheritedOptions){const sep=this.nestingOptionsSeparator;if(key.indexOf(sep)<0)return key;const c=key.split(new RegExp(`${sep}[ ]*{`));let optionsString=`{${c[1]}`;key=c[0];optionsString=this.interpolate(optionsString,clonedOptions);const matchedSingleQuotes=optionsString.match(/'/g);const matchedDoubleQuotes=optionsString.match(/"/g);if(matchedSingleQuotes&&matchedSingleQuotes.length%2===0&&!matchedDoubleQuotes||matchedDoubleQuotes.length%2!==0){optionsString=optionsString.replace(/'/g,'"');}
try{clonedOptions=JSON.parse(optionsString);if(inheritedOptions)clonedOptions={...inheritedOptions,...clonedOptions};}catch(e){this.logger.warn(`failed parsing options string in nesting for key ${key}`,e);return`${key}${sep}${optionsString}`;}
delete clonedOptions.defaultValue;return key;}
while(match=this.nestingRegexp.exec(str)){let formatters=[];clonedOptions={...options};clonedOptions=clonedOptions.replace&&typeof clonedOptions.replace!=='string'?clonedOptions.replace:clonedOptions;clonedOptions.applyPostProcessor=false;delete clonedOptions.defaultValue;let doReduce=false;if(match[0].indexOf(this.formatSeparator)!==-1&&!/{.*}/.test(match[1])){const r=match[1].split(this.formatSeparator).map(elem=>elem.trim());match[1]=r.shift();formatters=r;doReduce=true;}
value=fc(handleHasOptions.call(this,match[1].trim(),clonedOptions),clonedOptions);if(value&&match[0]===str&&typeof value!=='string')return value;if(typeof value!=='string')value=makeString(value);if(!value){this.logger.warn(`missed to resolve ${match[1]} for nesting ${str}`);value='';}
if(doReduce){value=formatters.reduce((v,f)=>this.format(v,f,options.lng,{...options,interpolationkey:match[1].trim()}),value.trim());}
str=str.replace(match[0],value);this.regexp.lastIndex=0;}
return str;}}
function parseFormatStr(formatStr){let formatName=formatStr.toLowerCase().trim();const formatOptions={};if(formatStr.indexOf('(')>-1){const p=formatStr.split('(');formatName=p[0].toLowerCase().trim();const optStr=p[1].substring(0,p[1].length-1);if(formatName==='currency'&&optStr.indexOf(':')<0){if(!formatOptions.currency)formatOptions.currency=optStr.trim();}else if(formatName==='relativetime'&&optStr.indexOf(':')<0){if(!formatOptions.range)formatOptions.range=optStr.trim();}else{const opts=optStr.split(';');opts.forEach(opt=>{if(!opt)return;const[key,...rest]=opt.split(':');const val=rest.join(':').trim().replace(/^'+|'+$/g,'');if(!formatOptions[key.trim()])formatOptions[key.trim()]=val;if(val==='false')formatOptions[key.trim()]=false;if(val==='true')formatOptions[key.trim()]=true;if(!isNaN(val))formatOptions[key.trim()]=parseInt(val,10);});}}
return{formatName,formatOptions};}
function createCachedFormatter(fn){const cache={};return function invokeFormatter(val,lng,options){const key=lng+JSON.stringify(options);let formatter=cache[key];if(!formatter){formatter=fn(getCleanedCode(lng),options);cache[key]=formatter;}
return formatter(val);};}
class Formatter{constructor(){let options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};this.logger=baseLogger.create('formatter');this.options=options;this.formats={number:createCachedFormatter((lng,opt)=>{const formatter=new Intl.NumberFormat(lng,{...opt});return val=>formatter.format(val);}),currency:createCachedFormatter((lng,opt)=>{const formatter=new Intl.NumberFormat(lng,{...opt,style:'currency'});return val=>formatter.format(val);}),datetime:createCachedFormatter((lng,opt)=>{const formatter=new Intl.DateTimeFormat(lng,{...opt});return val=>formatter.format(val);}),relativetime:createCachedFormatter((lng,opt)=>{const formatter=new Intl.RelativeTimeFormat(lng,{...opt});return val=>formatter.format(val,opt.range||'day');}),list:createCachedFormatter((lng,opt)=>{const formatter=new Intl.ListFormat(lng,{...opt});return val=>formatter.format(val);})};this.init(options);}
init(services){let options=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{interpolation:{}};const iOpts=options.interpolation;this.formatSeparator=iOpts.formatSeparator?iOpts.formatSeparator:iOpts.formatSeparator||',';}
add(name,fc){this.formats[name.toLowerCase().trim()]=fc;}
addCached(name,fc){this.formats[name.toLowerCase().trim()]=createCachedFormatter(fc);}
format(value,format,lng){let options=arguments.length>3&&arguments[3]!==undefined?arguments[3]:{};const formats=format.split(this.formatSeparator);const result=formats.reduce((mem,f)=>{const{formatName,formatOptions}=parseFormatStr(f);if(this.formats[formatName]){let formatted=mem;try{const valOptions=options&&options.formatParams&&options.formatParams[options.interpolationkey]||{};const l=valOptions.locale||valOptions.lng||options.locale||options.lng||lng;formatted=this.formats[formatName](mem,l,{...formatOptions,...options,...valOptions});}catch(error){this.logger.warn(error);}
return formatted;}else{this.logger.warn(`there was no format function for ${formatName}`);}
return mem;},value);return result;}}
function removePending(q,name){if(q.pending[name]!==undefined){delete q.pending[name];q.pendingCount--;}}
class Connector extends EventEmitter{constructor(backend,store,services){let options=arguments.length>3&&arguments[3]!==undefined?arguments[3]:{};super();this.backend=backend;this.store=store;this.services=services;this.languageUtils=services.languageUtils;this.options=options;this.logger=baseLogger.create('backendConnector');this.waitingReads=[];this.maxParallelReads=options.maxParallelReads||10;this.readingCalls=0;this.maxRetries=options.maxRetries>=0?options.maxRetries:5;this.retryTimeout=options.retryTimeout>=1?options.retryTimeout:350;this.state={};this.queue=[];if(this.backend&&this.backend.init){this.backend.init(services,options.backend,options);}}
queueLoad(languages,namespaces,options,callback){const toLoad={};const pending={};const toLoadLanguages={};const toLoadNamespaces={};languages.forEach(lng=>{let hasAllNamespaces=true;namespaces.forEach(ns=>{const name=`${lng}|${ns}`;if(!options.reload&&this.store.hasResourceBundle(lng,ns)){this.state[name]=2;}else if(this.state[name]<0);else if(this.state[name]===1){if(pending[name]===undefined)pending[name]=true;}else{this.state[name]=1;hasAllNamespaces=false;if(pending[name]===undefined)pending[name]=true;if(toLoad[name]===undefined)toLoad[name]=true;if(toLoadNamespaces[ns]===undefined)toLoadNamespaces[ns]=true;}});if(!hasAllNamespaces)toLoadLanguages[lng]=true;});if(Object.keys(toLoad).length||Object.keys(pending).length){this.queue.push({pending,pendingCount:Object.keys(pending).length,loaded:{},errors:[],callback});}
return{toLoad:Object.keys(toLoad),pending:Object.keys(pending),toLoadLanguages:Object.keys(toLoadLanguages),toLoadNamespaces:Object.keys(toLoadNamespaces)};}
loaded(name,err,data){const s=name.split('|');const lng=s[0];const ns=s[1];if(err)this.emit('failedLoading',lng,ns,err);if(data){this.store.addResourceBundle(lng,ns,data,undefined,undefined,{skipCopy:true});}
this.state[name]=err?-1:2;const loaded={};this.queue.forEach(q=>{pushPath(q.loaded,[lng],ns);removePending(q,name);if(err)q.errors.push(err);if(q.pendingCount===0&&!q.done){Object.keys(q.loaded).forEach(l=>{if(!loaded[l])loaded[l]={};const loadedKeys=q.loaded[l];if(loadedKeys.length){loadedKeys.forEach(n=>{if(loaded[l][n]===undefined)loaded[l][n]=true;});}});q.done=true;if(q.errors.length){q.callback(q.errors);}else{q.callback();}}});this.emit('loaded',loaded);this.queue=this.queue.filter(q=>!q.done);}
read(lng,ns,fcName){let tried=arguments.length>3&&arguments[3]!==undefined?arguments[3]:0;let wait=arguments.length>4&&arguments[4]!==undefined?arguments[4]:this.retryTimeout;let callback=arguments.length>5?arguments[5]:undefined;if(!lng.length)return callback(null,{});if(this.readingCalls>=this.maxParallelReads){this.waitingReads.push({lng,ns,fcName,tried,wait,callback});return;}
this.readingCalls++;const resolver=(err,data)=>{this.readingCalls--;if(this.waitingReads.length>0){const next=this.waitingReads.shift();this.read(next.lng,next.ns,next.fcName,next.tried,next.wait,next.callback);}
if(err&&data&&tried<this.maxRetries){setTimeout(()=>{this.read.call(this,lng,ns,fcName,tried+1,wait*2,callback);},wait);return;}
callback(err,data);};const fc=this.backend[fcName].bind(this.backend);if(fc.length===2){try{const r=fc(lng,ns);if(r&&typeof r.then==='function'){r.then(data=>resolver(null,data)).catch(resolver);}else{resolver(null,r);}}catch(err){resolver(err);}
return;}
return fc(lng,ns,resolver);}
prepareLoading(languages,namespaces){let options=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};let callback=arguments.length>3?arguments[3]:undefined;if(!this.backend){this.logger.warn('No backend was added via i18next.use. Will not load resources.');return callback&&callback();}
if(typeof languages==='string')languages=this.languageUtils.toResolveHierarchy(languages);if(typeof namespaces==='string')namespaces=[namespaces];const toLoad=this.queueLoad(languages,namespaces,options,callback);if(!toLoad.toLoad.length){if(!toLoad.pending.length)callback();return null;}
toLoad.toLoad.forEach(name=>{this.loadOne(name);});}
load(languages,namespaces,callback){this.prepareLoading(languages,namespaces,{},callback);}
reload(languages,namespaces,callback){this.prepareLoading(languages,namespaces,{reload:true},callback);}
loadOne(name){let prefix=arguments.length>1&&arguments[1]!==undefined?arguments[1]:'';const s=name.split('|');const lng=s[0];const ns=s[1];this.read(lng,ns,'read',undefined,undefined,(err,data)=>{if(err)this.logger.warn(`${prefix}loading namespace ${ns} for language ${lng} failed`,err);if(!err&&data)this.logger.log(`${prefix}loaded namespace ${ns} for language ${lng}`,data);this.loaded(name,err,data);});}
saveMissing(languages,namespace,key,fallbackValue,isUpdate){let options=arguments.length>5&&arguments[5]!==undefined?arguments[5]:{};let clb=arguments.length>6&&arguments[6]!==undefined?arguments[6]:()=>{};if(this.services.utils&&this.services.utils.hasLoadedNamespace&&!this.services.utils.hasLoadedNamespace(namespace)){this.logger.warn(`did not save key "${key}" as the namespace "${namespace}" was not yet loaded`,'This means something IS WRONG in your setup. You access the t function before i18next.init / i18next.loadNamespace / i18next.changeLanguage was done. Wait for the callback or Promise to resolve before accessing it!!!');return;}
if(key===undefined||key===null||key==='')return;if(this.backend&&this.backend.create){const opts={...options,isUpdate};const fc=this.backend.create.bind(this.backend);if(fc.length<6){try{let r;if(fc.length===5){r=fc(languages,namespace,key,fallbackValue,opts);}else{r=fc(languages,namespace,key,fallbackValue);}
if(r&&typeof r.then==='function'){r.then(data=>clb(null,data)).catch(clb);}else{clb(null,r);}}catch(err){clb(err);}}else{fc(languages,namespace,key,fallbackValue,clb,opts);}}
if(!languages||!languages[0])return;this.store.addResource(languages[0],namespace,key,fallbackValue);}}
function get(){return{debug:false,initImmediate:true,ns:['translation'],defaultNS:['translation'],fallbackLng:['dev'],fallbackNS:false,supportedLngs:false,nonExplicitSupportedLngs:false,load:'all',preload:false,simplifyPluralSuffix:true,keySeparator:'.',nsSeparator:':',pluralSeparator:'_',contextSeparator:'_',partialBundledLanguages:false,saveMissing:false,updateMissing:false,saveMissingTo:'fallback',saveMissingPlurals:true,missingKeyHandler:false,missingInterpolationHandler:false,postProcess:false,postProcessPassResolved:false,returnNull:false,returnEmptyString:true,returnObjects:false,joinArrays:false,returnedObjectHandler:false,parseMissingKeyHandler:false,appendNamespaceToMissingKey:false,appendNamespaceToCIMode:false,overloadTranslationOptionHandler:function handle(args){let ret={};if(typeof args[1]==='object')ret=args[1];if(typeof args[1]==='string')ret.defaultValue=args[1];if(typeof args[2]==='string')ret.tDescription=args[2];if(typeof args[2]==='object'||typeof args[3]==='object'){const options=args[3]||args[2];Object.keys(options).forEach(key=>{ret[key]=options[key];});}
return ret;},interpolation:{escapeValue:true,format:value=>value,prefix:'{{',suffix:'}}',formatSeparator:',',unescapePrefix:'-',nestingPrefix:'$t(',nestingSuffix:')',nestingOptionsSeparator:',',maxReplaces:1000,skipOnVariables:true}};}
function transformOptions(options){if(typeof options.ns==='string')options.ns=[options.ns];if(typeof options.fallbackLng==='string')options.fallbackLng=[options.fallbackLng];if(typeof options.fallbackNS==='string')options.fallbackNS=[options.fallbackNS];if(options.supportedLngs&&options.supportedLngs.indexOf('cimode')<0){options.supportedLngs=options.supportedLngs.concat(['cimode']);}
return options;}
function noop(){}
function bindMemberFunctions(inst){const mems=Object.getOwnPropertyNames(Object.getPrototypeOf(inst));mems.forEach(mem=>{if(typeof inst[mem]==='function'){inst[mem]=inst[mem].bind(inst);}});}
class I18n extends EventEmitter{constructor(){let options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};let callback=arguments.length>1?arguments[1]:undefined;super();this.options=transformOptions(options);this.services={};this.logger=baseLogger;this.modules={external:[]};bindMemberFunctions(this);if(callback&&!this.isInitialized&&!options.isClone){if(!this.options.initImmediate){this.init(options,callback);return this;}
setTimeout(()=>{this.init(options,callback);},0);}}
init(){var _this=this;let options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};let callback=arguments.length>1?arguments[1]:undefined;this.isInitializing=true;if(typeof options==='function'){callback=options;options={};}
if(!options.defaultNS&&options.defaultNS!==false&&options.ns){if(typeof options.ns==='string'){options.defaultNS=options.ns;}else if(options.ns.indexOf('translation')<0){options.defaultNS=options.ns[0];}}
const defOpts=get();this.options={...defOpts,...this.options,...transformOptions(options)};if(this.options.compatibilityAPI!=='v1'){this.options.interpolation={...defOpts.interpolation,...this.options.interpolation};}
if(options.keySeparator!==undefined){this.options.userDefinedKeySeparator=options.keySeparator;}
if(options.nsSeparator!==undefined){this.options.userDefinedNsSeparator=options.nsSeparator;}
function createClassOnDemand(ClassOrObject){if(!ClassOrObject)return null;if(typeof ClassOrObject==='function')return new ClassOrObject();return ClassOrObject;}
if(!this.options.isClone){if(this.modules.logger){baseLogger.init(createClassOnDemand(this.modules.logger),this.options);}else{baseLogger.init(null,this.options);}
let formatter;if(this.modules.formatter){formatter=this.modules.formatter;}else if(typeof Intl!=='undefined'){formatter=Formatter;}
const lu=new LanguageUtil(this.options);this.store=new ResourceStore(this.options.resources,this.options);const s=this.services;s.logger=baseLogger;s.resourceStore=this.store;s.languageUtils=lu;s.pluralResolver=new PluralResolver(lu,{prepend:this.options.pluralSeparator,compatibilityJSON:this.options.compatibilityJSON,simplifyPluralSuffix:this.options.simplifyPluralSuffix});if(formatter&&(!this.options.interpolation.format||this.options.interpolation.format===defOpts.interpolation.format)){s.formatter=createClassOnDemand(formatter);s.formatter.init(s,this.options);this.options.interpolation.format=s.formatter.format.bind(s.formatter);}
s.interpolator=new Interpolator(this.options);s.utils={hasLoadedNamespace:this.hasLoadedNamespace.bind(this)};s.backendConnector=new Connector(createClassOnDemand(this.modules.backend),s.resourceStore,s,this.options);s.backendConnector.on('*',function(event){for(var _len=arguments.length,args=new Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){args[_key-1]=arguments[_key];}
_this.emit(event,...args);});if(this.modules.languageDetector){s.languageDetector=createClassOnDemand(this.modules.languageDetector);if(s.languageDetector.init)s.languageDetector.init(s,this.options.detection,this.options);}
if(this.modules.i18nFormat){s.i18nFormat=createClassOnDemand(this.modules.i18nFormat);if(s.i18nFormat.init)s.i18nFormat.init(this);}
this.translator=new Translator(this.services,this.options);this.translator.on('*',function(event){for(var _len2=arguments.length,args=new Array(_len2>1?_len2-1:0),_key2=1;_key2<_len2;_key2++){args[_key2-1]=arguments[_key2];}
_this.emit(event,...args);});this.modules.external.forEach(m=>{if(m.init)m.init(this);});}
this.format=this.options.interpolation.format;if(!callback)callback=noop;if(this.options.fallbackLng&&!this.services.languageDetector&&!this.options.lng){const codes=this.services.languageUtils.getFallbackCodes(this.options.fallbackLng);if(codes.length>0&&codes[0]!=='dev')this.options.lng=codes[0];}
if(!this.services.languageDetector&&!this.options.lng){this.logger.warn('init: no languageDetector is used and no lng is defined');}
const storeApi=['getResource','hasResourceBundle','getResourceBundle','getDataByLanguage'];storeApi.forEach(fcName=>{this[fcName]=function(){return _this.store[fcName](...arguments);};});const storeApiChained=['addResource','addResources','addResourceBundle','removeResourceBundle'];storeApiChained.forEach(fcName=>{this[fcName]=function(){_this.store[fcName](...arguments);return _this;};});const deferred=defer();const load=()=>{const finish=(err,t)=>{this.isInitializing=false;if(this.isInitialized&&!this.initializedStoreOnce)this.logger.warn('init: i18next is already initialized. You should call init just once!');this.isInitialized=true;if(!this.options.isClone)this.logger.log('initialized',this.options);this.emit('initialized',this.options);deferred.resolve(t);callback(err,t);};if(this.languages&&this.options.compatibilityAPI!=='v1'&&!this.isInitialized)return finish(null,this.t.bind(this));this.changeLanguage(this.options.lng,finish);};if(this.options.resources||!this.options.initImmediate){load();}else{setTimeout(load,0);}
return deferred;}
loadResources(language){let callback=arguments.length>1&&arguments[1]!==undefined?arguments[1]:noop;let usedCallback=callback;const usedLng=typeof language==='string'?language:this.language;if(typeof language==='function')usedCallback=language;if(!this.options.resources||this.options.partialBundledLanguages){if(usedLng&&usedLng.toLowerCase()==='cimode'&&(!this.options.preload||this.options.preload.length===0))return usedCallback();const toLoad=[];const append=lng=>{if(!lng)return;if(lng==='cimode')return;const lngs=this.services.languageUtils.toResolveHierarchy(lng);lngs.forEach(l=>{if(l==='cimode')return;if(toLoad.indexOf(l)<0)toLoad.push(l);});};if(!usedLng){const fallbacks=this.services.languageUtils.getFallbackCodes(this.options.fallbackLng);fallbacks.forEach(l=>append(l));}else{append(usedLng);}
if(this.options.preload){this.options.preload.forEach(l=>append(l));}
this.services.backendConnector.load(toLoad,this.options.ns,e=>{if(!e&&!this.resolvedLanguage&&this.language)this.setResolvedLanguage(this.language);usedCallback(e);});}else{usedCallback(null);}}
reloadResources(lngs,ns,callback){const deferred=defer();if(!lngs)lngs=this.languages;if(!ns)ns=this.options.ns;if(!callback)callback=noop;this.services.backendConnector.reload(lngs,ns,err=>{deferred.resolve();callback(err);});return deferred;}
use(module){if(!module)throw new Error('You are passing an undefined module! Please check the object you are passing to i18next.use()');if(!module.type)throw new Error('You are passing a wrong module! Please check the object you are passing to i18next.use()');if(module.type==='backend'){this.modules.backend=module;}
if(module.type==='logger'||module.log&&module.warn&&module.error){this.modules.logger=module;}
if(module.type==='languageDetector'){this.modules.languageDetector=module;}
if(module.type==='i18nFormat'){this.modules.i18nFormat=module;}
if(module.type==='postProcessor'){postProcessor.addPostProcessor(module);}
if(module.type==='formatter'){this.modules.formatter=module;}
if(module.type==='3rdParty'){this.modules.external.push(module);}
return this;}
setResolvedLanguage(l){if(!l||!this.languages)return;if(['cimode','dev'].indexOf(l)>-1)return;for(let li=0;li<this.languages.length;li++){const lngInLngs=this.languages[li];if(['cimode','dev'].indexOf(lngInLngs)>-1)continue;if(this.store.hasLanguageSomeTranslations(lngInLngs)){this.resolvedLanguage=lngInLngs;break;}}}
changeLanguage(lng,callback){var _this2=this;this.isLanguageChangingTo=lng;const deferred=defer();this.emit('languageChanging',lng);const setLngProps=l=>{this.language=l;this.languages=this.services.languageUtils.toResolveHierarchy(l);this.resolvedLanguage=undefined;this.setResolvedLanguage(l);};const done=(err,l)=>{if(l){setLngProps(l);this.translator.changeLanguage(l);this.isLanguageChangingTo=undefined;this.emit('languageChanged',l);this.logger.log('languageChanged',l);}else{this.isLanguageChangingTo=undefined;}
deferred.resolve(function(){return _this2.t(...arguments);});if(callback)callback(err,function(){return _this2.t(...arguments);});};const setLng=lngs=>{if(!lng&&!lngs&&this.services.languageDetector)lngs=[];const l=typeof lngs==='string'?lngs:this.services.languageUtils.getBestMatchFromCodes(lngs);if(l){if(!this.language){setLngProps(l);}
if(!this.translator.language)this.translator.changeLanguage(l);if(this.services.languageDetector&&this.services.languageDetector.cacheUserLanguage)this.services.languageDetector.cacheUserLanguage(l);}
this.loadResources(l,err=>{done(err,l);});};if(!lng&&this.services.languageDetector&&!this.services.languageDetector.async){setLng(this.services.languageDetector.detect());}else if(!lng&&this.services.languageDetector&&this.services.languageDetector.async){if(this.services.languageDetector.detect.length===0){this.services.languageDetector.detect().then(setLng);}else{this.services.languageDetector.detect(setLng);}}else{setLng(lng);}
return deferred;}
getFixedT(lng,ns,keyPrefix){var _this3=this;const fixedT=function(key,opts){let options;if(typeof opts!=='object'){for(var _len3=arguments.length,rest=new Array(_len3>2?_len3-2:0),_key3=2;_key3<_len3;_key3++){rest[_key3-2]=arguments[_key3];}
options=_this3.options.overloadTranslationOptionHandler([key,opts].concat(rest));}else{options={...opts};}
options.lng=options.lng||fixedT.lng;options.lngs=options.lngs||fixedT.lngs;options.ns=options.ns||fixedT.ns;options.keyPrefix=options.keyPrefix||keyPrefix||fixedT.keyPrefix;const keySeparator=_this3.options.keySeparator||'.';let resultKey;if(options.keyPrefix&&Array.isArray(key)){resultKey=key.map(k=>`${options.keyPrefix}${keySeparator}${k}`);}else{resultKey=options.keyPrefix?`${options.keyPrefix}${keySeparator}${key}`:key;}
return _this3.t(resultKey,options);};if(typeof lng==='string'){fixedT.lng=lng;}else{fixedT.lngs=lng;}
fixedT.ns=ns;fixedT.keyPrefix=keyPrefix;return fixedT;}
t(){return this.translator&&this.translator.translate(...arguments);}
exists(){return this.translator&&this.translator.exists(...arguments);}
setDefaultNamespace(ns){this.options.defaultNS=ns;}
hasLoadedNamespace(ns){let options=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};if(!this.isInitialized){this.logger.warn('hasLoadedNamespace: i18next was not initialized',this.languages);return false;}
if(!this.languages||!this.languages.length){this.logger.warn('hasLoadedNamespace: i18n.languages were undefined or empty',this.languages);return false;}
const lng=options.lng||this.resolvedLanguage||this.languages[0];const fallbackLng=this.options?this.options.fallbackLng:false;const lastLng=this.languages[this.languages.length-1];if(lng.toLowerCase()==='cimode')return true;const loadNotPending=(l,n)=>{const loadState=this.services.backendConnector.state[`${l}|${n}`];return loadState===-1||loadState===2;};if(options.precheck){const preResult=options.precheck(this,loadNotPending);if(preResult!==undefined)return preResult;}
if(this.hasResourceBundle(lng,ns))return true;if(!this.services.backendConnector.backend||this.options.resources&&!this.options.partialBundledLanguages)return true;if(loadNotPending(lng,ns)&&(!fallbackLng||loadNotPending(lastLng,ns)))return true;return false;}
loadNamespaces(ns,callback){const deferred=defer();if(!this.options.ns){if(callback)callback();return Promise.resolve();}
if(typeof ns==='string')ns=[ns];ns.forEach(n=>{if(this.options.ns.indexOf(n)<0)this.options.ns.push(n);});this.loadResources(err=>{deferred.resolve();if(callback)callback(err);});return deferred;}
loadLanguages(lngs,callback){const deferred=defer();if(typeof lngs==='string')lngs=[lngs];const preloaded=this.options.preload||[];const newLngs=lngs.filter(lng=>preloaded.indexOf(lng)<0);if(!newLngs.length){if(callback)callback();return Promise.resolve();}
this.options.preload=preloaded.concat(newLngs);this.loadResources(err=>{deferred.resolve();if(callback)callback(err);});return deferred;}
dir(lng){if(!lng)lng=this.resolvedLanguage||(this.languages&&this.languages.length>0?this.languages[0]:this.language);if(!lng)return'rtl';const rtlLngs=['ar','shu','sqr','ssh','xaa','yhd','yud','aao','abh','abv','acm','acq','acw','acx','acy','adf','ads','aeb','aec','afb','ajp','apc','apd','arb','arq','ars','ary','arz','auz','avl','ayh','ayl','ayn','ayp','bbz','pga','he','iw','ps','pbt','pbu','pst','prp','prd','ug','ur','ydd','yds','yih','ji','yi','hbo','men','xmn','fa','jpr','peo','pes','prs','dv','sam','ckb'];const languageUtils=this.services&&this.services.languageUtils||new LanguageUtil(get());return rtlLngs.indexOf(languageUtils.getLanguagePartFromCode(lng))>-1||lng.toLowerCase().indexOf('-arab')>1?'rtl':'ltr';}
static createInstance(){let options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};let callback=arguments.length>1?arguments[1]:undefined;return new I18n(options,callback);}
cloneInstance(){let options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};let callback=arguments.length>1&&arguments[1]!==undefined?arguments[1]:noop;const forkResourceStore=options.forkResourceStore;if(forkResourceStore)delete options.forkResourceStore;const mergedOptions={...this.options,...options,...{isClone:true}};const clone=new I18n(mergedOptions);if(options.debug!==undefined||options.prefix!==undefined){clone.logger=clone.logger.clone(options);}
const membersToCopy=['store','services','language'];membersToCopy.forEach(m=>{clone[m]=this[m];});clone.services={...this.services};clone.services.utils={hasLoadedNamespace:clone.hasLoadedNamespace.bind(clone)};if(forkResourceStore){clone.store=new ResourceStore(this.store.data,mergedOptions);clone.services.resourceStore=clone.store;}
clone.translator=new Translator(clone.services,mergedOptions);clone.translator.on('*',function(event){for(var _len4=arguments.length,args=new Array(_len4>1?_len4-1:0),_key4=1;_key4<_len4;_key4++){args[_key4-1]=arguments[_key4];}
clone.emit(event,...args);});clone.init(mergedOptions,callback);clone.translator.options=mergedOptions;clone.translator.backendConnector.services.utils={hasLoadedNamespace:clone.hasLoadedNamespace.bind(clone)};return clone;}
toJSON(){return{options:this.options,store:this.store,language:this.language,languages:this.languages,resolvedLanguage:this.resolvedLanguage};}}
const instance=I18n.createInstance();instance.createInstance=I18n.createInstance;return instance;}));var luxon=(function(exports){'use strict';function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,_toPropertyKey(descriptor.key),descriptor);}}
function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);Object.defineProperty(Constructor,"prototype",{writable:false});return Constructor;}
function _extends(){_extends=Object.assign?Object.assign.bind():function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}
return target;};return _extends.apply(this,arguments);}
function _inheritsLoose(subClass,superClass){subClass.prototype=Object.create(superClass.prototype);subClass.prototype.constructor=subClass;_setPrototypeOf(subClass,superClass);}
function _getPrototypeOf(o){_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(o){return o.__proto__||Object.getPrototypeOf(o);};return _getPrototypeOf(o);}
function _setPrototypeOf(o,p){_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(o,p){o.__proto__=p;return o;};return _setPrototypeOf(o,p);}
function _isNativeReflectConstruct(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));return true;}catch(e){return false;}}
function _construct(Parent,args,Class){if(_isNativeReflectConstruct()){_construct=Reflect.construct.bind();}else{_construct=function _construct(Parent,args,Class){var a=[null];a.push.apply(a,args);var Constructor=Function.bind.apply(Parent,a);var instance=new Constructor();if(Class)_setPrototypeOf(instance,Class.prototype);return instance;};}
return _construct.apply(null,arguments);}
function _isNativeFunction(fn){return Function.toString.call(fn).indexOf("[native code]")!==-1;}
function _wrapNativeSuper(Class){var _cache=typeof Map==="function"?new Map():undefined;_wrapNativeSuper=function _wrapNativeSuper(Class){if(Class===null||!_isNativeFunction(Class))return Class;if(typeof Class!=="function"){throw new TypeError("Super expression must either be null or a function");}
if(typeof _cache!=="undefined"){if(_cache.has(Class))return _cache.get(Class);_cache.set(Class,Wrapper);}
function Wrapper(){return _construct(Class,arguments,_getPrototypeOf(this).constructor);}
Wrapper.prototype=Object.create(Class.prototype,{constructor:{value:Wrapper,enumerable:false,writable:true,configurable:true}});return _setPrototypeOf(Wrapper,Class);};return _wrapNativeSuper(Class);}
function _objectWithoutPropertiesLoose(source,excluded){if(source==null)return{};var target={};var sourceKeys=Object.keys(source);var key,i;for(i=0;i<sourceKeys.length;i++){key=sourceKeys[i];if(excluded.indexOf(key)>=0)continue;target[key]=source[key];}
return target;}
function _unsupportedIterableToArray(o,minLen){if(!o)return;if(typeof o==="string")return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if(n==="Object"&&o.constructor)n=o.constructor.name;if(n==="Map"||n==="Set")return Array.from(o);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen);}
function _arrayLikeToArray(arr,len){if(len==null||len>arr.length)len=arr.length;for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2;}
function _createForOfIteratorHelperLoose(o,allowArrayLike){var it=typeof Symbol!=="undefined"&&o[Symbol.iterator]||o["@@iterator"];if(it)return(it=it.call(o)).next.bind(it);if(Array.isArray(o)||(it=_unsupportedIterableToArray(o))||allowArrayLike&&o&&typeof o.length==="number"){if(it)o=it;var i=0;return function(){if(i>=o.length)return{done:true};return{done:false,value:o[i++]};};}
throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.");}
function _toPrimitive(input,hint){if(typeof input!=="object"||input===null)return input;var prim=input[Symbol.toPrimitive];if(prim!==undefined){var res=prim.call(input,hint||"default");if(typeof res!=="object")return res;throw new TypeError("@@toPrimitive must return a primitive value.");}
return(hint==="string"?String:Number)(input);}
function _toPropertyKey(arg){var key=_toPrimitive(arg,"string");return typeof key==="symbol"?key:String(key);}
var LuxonError=function(_Error){_inheritsLoose(LuxonError,_Error);function LuxonError(){return _Error.apply(this,arguments)||this;}
return LuxonError;}(_wrapNativeSuper(Error));var InvalidDateTimeError=function(_LuxonError){_inheritsLoose(InvalidDateTimeError,_LuxonError);function InvalidDateTimeError(reason){return _LuxonError.call(this,"Invalid DateTime: "+reason.toMessage())||this;}
return InvalidDateTimeError;}(LuxonError);var InvalidIntervalError=function(_LuxonError2){_inheritsLoose(InvalidIntervalError,_LuxonError2);function InvalidIntervalError(reason){return _LuxonError2.call(this,"Invalid Interval: "+reason.toMessage())||this;}
return InvalidIntervalError;}(LuxonError);var InvalidDurationError=function(_LuxonError3){_inheritsLoose(InvalidDurationError,_LuxonError3);function InvalidDurationError(reason){return _LuxonError3.call(this,"Invalid Duration: "+reason.toMessage())||this;}
return InvalidDurationError;}(LuxonError);var ConflictingSpecificationError=function(_LuxonError4){_inheritsLoose(ConflictingSpecificationError,_LuxonError4);function ConflictingSpecificationError(){return _LuxonError4.apply(this,arguments)||this;}
return ConflictingSpecificationError;}(LuxonError);var InvalidUnitError=function(_LuxonError5){_inheritsLoose(InvalidUnitError,_LuxonError5);function InvalidUnitError(unit){return _LuxonError5.call(this,"Invalid unit "+unit)||this;}
return InvalidUnitError;}(LuxonError);var InvalidArgumentError=function(_LuxonError6){_inheritsLoose(InvalidArgumentError,_LuxonError6);function InvalidArgumentError(){return _LuxonError6.apply(this,arguments)||this;}
return InvalidArgumentError;}(LuxonError);var ZoneIsAbstractError=function(_LuxonError7){_inheritsLoose(ZoneIsAbstractError,_LuxonError7);function ZoneIsAbstractError(){return _LuxonError7.call(this,"Zone is an abstract class")||this;}
return ZoneIsAbstractError;}(LuxonError);var n="numeric",s="short",l="long";var DATE_SHORT={year:n,month:n,day:n};var DATE_MED={year:n,month:s,day:n};var DATE_MED_WITH_WEEKDAY={year:n,month:s,day:n,weekday:s};var DATE_FULL={year:n,month:l,day:n};var DATE_HUGE={year:n,month:l,day:n,weekday:l};var TIME_SIMPLE={hour:n,minute:n};var TIME_WITH_SECONDS={hour:n,minute:n,second:n};var TIME_WITH_SHORT_OFFSET={hour:n,minute:n,second:n,timeZoneName:s};var TIME_WITH_LONG_OFFSET={hour:n,minute:n,second:n,timeZoneName:l};var TIME_24_SIMPLE={hour:n,minute:n,hourCycle:"h23"};var TIME_24_WITH_SECONDS={hour:n,minute:n,second:n,hourCycle:"h23"};var TIME_24_WITH_SHORT_OFFSET={hour:n,minute:n,second:n,hourCycle:"h23",timeZoneName:s};var TIME_24_WITH_LONG_OFFSET={hour:n,minute:n,second:n,hourCycle:"h23",timeZoneName:l};var DATETIME_SHORT={year:n,month:n,day:n,hour:n,minute:n};var DATETIME_SHORT_WITH_SECONDS={year:n,month:n,day:n,hour:n,minute:n,second:n};var DATETIME_MED={year:n,month:s,day:n,hour:n,minute:n};var DATETIME_MED_WITH_SECONDS={year:n,month:s,day:n,hour:n,minute:n,second:n};var DATETIME_MED_WITH_WEEKDAY={year:n,month:s,day:n,weekday:s,hour:n,minute:n};var DATETIME_FULL={year:n,month:l,day:n,hour:n,minute:n,timeZoneName:s};var DATETIME_FULL_WITH_SECONDS={year:n,month:l,day:n,hour:n,minute:n,second:n,timeZoneName:s};var DATETIME_HUGE={year:n,month:l,day:n,weekday:l,hour:n,minute:n,timeZoneName:l};var DATETIME_HUGE_WITH_SECONDS={year:n,month:l,day:n,weekday:l,hour:n,minute:n,second:n,timeZoneName:l};var Zone=function(){function Zone(){}
var _proto=Zone.prototype;_proto.offsetName=function offsetName(ts,opts){throw new ZoneIsAbstractError();};_proto.formatOffset=function formatOffset(ts,format){throw new ZoneIsAbstractError();};_proto.offset=function offset(ts){throw new ZoneIsAbstractError();};_proto.equals=function equals(otherZone){throw new ZoneIsAbstractError();};_createClass(Zone,[{key:"type",get:function get(){throw new ZoneIsAbstractError();}},{key:"name",get:function get(){throw new ZoneIsAbstractError();}},{key:"ianaName",get:function get(){return this.name;}},{key:"isUniversal",get:function get(){throw new ZoneIsAbstractError();}},{key:"isValid",get:function get(){throw new ZoneIsAbstractError();}}]);return Zone;}();var singleton$1=null;var SystemZone=function(_Zone){_inheritsLoose(SystemZone,_Zone);function SystemZone(){return _Zone.apply(this,arguments)||this;}
var _proto=SystemZone.prototype;_proto.offsetName=function offsetName(ts,_ref){var format=_ref.format,locale=_ref.locale;return parseZoneInfo(ts,format,locale);};_proto.formatOffset=function formatOffset$1(ts,format){return formatOffset(this.offset(ts),format);};_proto.offset=function offset(ts){return-new Date(ts).getTimezoneOffset();};_proto.equals=function equals(otherZone){return otherZone.type==="system";};_createClass(SystemZone,[{key:"type",get:function get(){return"system";}},{key:"name",get:function get(){return new Intl.DateTimeFormat().resolvedOptions().timeZone;}},{key:"isUniversal",get:function get(){return false;}},{key:"isValid",get:function get(){return true;}}],[{key:"instance",get:function get(){if(singleton$1===null){singleton$1=new SystemZone();}
return singleton$1;}}]);return SystemZone;}(Zone);var dtfCache={};function makeDTF(zone){if(!dtfCache[zone]){dtfCache[zone]=new Intl.DateTimeFormat("en-US",{hour12:false,timeZone:zone,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",era:"short"});}
return dtfCache[zone];}
var typeToPos={year:0,month:1,day:2,era:3,hour:4,minute:5,second:6};function hackyOffset(dtf,date){var formatted=dtf.format(date).replace(/\u200E/g,""),parsed=/(\d+)\/(\d+)\/(\d+) (AD|BC),? (\d+):(\d+):(\d+)/.exec(formatted),fMonth=parsed[1],fDay=parsed[2],fYear=parsed[3],fadOrBc=parsed[4],fHour=parsed[5],fMinute=parsed[6],fSecond=parsed[7];return[fYear,fMonth,fDay,fadOrBc,fHour,fMinute,fSecond];}
function partsOffset(dtf,date){var formatted=dtf.formatToParts(date);var filled=[];for(var i=0;i<formatted.length;i++){var _formatted$i=formatted[i],type=_formatted$i.type,value=_formatted$i.value;var pos=typeToPos[type];if(type==="era"){filled[pos]=value;}else if(!isUndefined(pos)){filled[pos]=parseInt(value,10);}}
return filled;}
var ianaZoneCache={};var IANAZone=function(_Zone){_inheritsLoose(IANAZone,_Zone);IANAZone.create=function create(name){if(!ianaZoneCache[name]){ianaZoneCache[name]=new IANAZone(name);}
return ianaZoneCache[name];};IANAZone.resetCache=function resetCache(){ianaZoneCache={};dtfCache={};};IANAZone.isValidSpecifier=function isValidSpecifier(s){return this.isValidZone(s);};IANAZone.isValidZone=function isValidZone(zone){if(!zone){return false;}
try{new Intl.DateTimeFormat("en-US",{timeZone:zone}).format();return true;}catch(e){return false;}};function IANAZone(name){var _this;_this=_Zone.call(this)||this;_this.zoneName=name;_this.valid=IANAZone.isValidZone(name);return _this;}
var _proto=IANAZone.prototype;_proto.offsetName=function offsetName(ts,_ref){var format=_ref.format,locale=_ref.locale;return parseZoneInfo(ts,format,locale,this.name);};_proto.formatOffset=function formatOffset$1(ts,format){return formatOffset(this.offset(ts),format);};_proto.offset=function offset(ts){var date=new Date(ts);if(isNaN(date))return NaN;var dtf=makeDTF(this.name);var _ref2=dtf.formatToParts?partsOffset(dtf,date):hackyOffset(dtf,date),year=_ref2[0],month=_ref2[1],day=_ref2[2],adOrBc=_ref2[3],hour=_ref2[4],minute=_ref2[5],second=_ref2[6];if(adOrBc==="BC"){year=-Math.abs(year)+1;}
var adjustedHour=hour===24?0:hour;var asUTC=objToLocalTS({year:year,month:month,day:day,hour:adjustedHour,minute:minute,second:second,millisecond:0});var asTS=+date;var over=asTS%1000;asTS-=over>=0?over:1000+over;return(asUTC-asTS)/(60*1000);};_proto.equals=function equals(otherZone){return otherZone.type==="iana"&&otherZone.name===this.name;};_createClass(IANAZone,[{key:"type",get:function get(){return"iana";}},{key:"name",get:function get(){return this.zoneName;}},{key:"isUniversal",get:function get(){return false;}},{key:"isValid",get:function get(){return this.valid;}}]);return IANAZone;}(Zone);var _excluded=["base"],_excluded2=["padTo","floor"];var intlLFCache={};function getCachedLF(locString,opts){if(opts===void 0){opts={};}
var key=JSON.stringify([locString,opts]);var dtf=intlLFCache[key];if(!dtf){dtf=new Intl.ListFormat(locString,opts);intlLFCache[key]=dtf;}
return dtf;}
var intlDTCache={};function getCachedDTF(locString,opts){if(opts===void 0){opts={};}
var key=JSON.stringify([locString,opts]);var dtf=intlDTCache[key];if(!dtf){dtf=new Intl.DateTimeFormat(locString,opts);intlDTCache[key]=dtf;}
return dtf;}
var intlNumCache={};function getCachedINF(locString,opts){if(opts===void 0){opts={};}
var key=JSON.stringify([locString,opts]);var inf=intlNumCache[key];if(!inf){inf=new Intl.NumberFormat(locString,opts);intlNumCache[key]=inf;}
return inf;}
var intlRelCache={};function getCachedRTF(locString,opts){if(opts===void 0){opts={};}
var _opts=opts;_opts.base;var cacheKeyOpts=_objectWithoutPropertiesLoose(_opts,_excluded);var key=JSON.stringify([locString,cacheKeyOpts]);var inf=intlRelCache[key];if(!inf){inf=new Intl.RelativeTimeFormat(locString,opts);intlRelCache[key]=inf;}
return inf;}
var sysLocaleCache=null;function systemLocale(){if(sysLocaleCache){return sysLocaleCache;}else{sysLocaleCache=new Intl.DateTimeFormat().resolvedOptions().locale;return sysLocaleCache;}}
var weekInfoCache={};function getCachedWeekInfo(locString){var data=weekInfoCache[locString];if(!data){var locale=new Intl.Locale(locString);data="getWeekInfo"in locale?locale.getWeekInfo():locale.weekInfo;weekInfoCache[locString]=data;}
return data;}
function parseLocaleString(localeStr){var xIndex=localeStr.indexOf("-x-");if(xIndex!==-1){localeStr=localeStr.substring(0,xIndex);}
var uIndex=localeStr.indexOf("-u-");if(uIndex===-1){return[localeStr];}else{var options;var selectedStr;try{options=getCachedDTF(localeStr).resolvedOptions();selectedStr=localeStr;}catch(e){var smaller=localeStr.substring(0,uIndex);options=getCachedDTF(smaller).resolvedOptions();selectedStr=smaller;}
var _options=options,numberingSystem=_options.numberingSystem,calendar=_options.calendar;return[selectedStr,numberingSystem,calendar];}}
function intlConfigString(localeStr,numberingSystem,outputCalendar){if(outputCalendar||numberingSystem){if(!localeStr.includes("-u-")){localeStr+="-u";}
if(outputCalendar){localeStr+="-ca-"+outputCalendar;}
if(numberingSystem){localeStr+="-nu-"+numberingSystem;}
return localeStr;}else{return localeStr;}}
function mapMonths(f){var ms=[];for(var i=1;i<=12;i++){var dt=DateTime.utc(2009,i,1);ms.push(f(dt));}
return ms;}
function mapWeekdays(f){var ms=[];for(var i=1;i<=7;i++){var dt=DateTime.utc(2016,11,13+i);ms.push(f(dt));}
return ms;}
function listStuff(loc,length,englishFn,intlFn){var mode=loc.listingMode();if(mode==="error"){return null;}else if(mode==="en"){return englishFn(length);}else{return intlFn(length);}}
function supportsFastNumbers(loc){if(loc.numberingSystem&&loc.numberingSystem!=="latn"){return false;}else{return loc.numberingSystem==="latn"||!loc.locale||loc.locale.startsWith("en")||new Intl.DateTimeFormat(loc.intl).resolvedOptions().numberingSystem==="latn";}}
var PolyNumberFormatter=function(){function PolyNumberFormatter(intl,forceSimple,opts){this.padTo=opts.padTo||0;this.floor=opts.floor||false;opts.padTo;opts.floor;var otherOpts=_objectWithoutPropertiesLoose(opts,_excluded2);if(!forceSimple||Object.keys(otherOpts).length>0){var intlOpts=_extends({useGrouping:false},opts);if(opts.padTo>0)intlOpts.minimumIntegerDigits=opts.padTo;this.inf=getCachedINF(intl,intlOpts);}}
var _proto=PolyNumberFormatter.prototype;_proto.format=function format(i){if(this.inf){var fixed=this.floor?Math.floor(i):i;return this.inf.format(fixed);}else{var _fixed=this.floor?Math.floor(i):roundTo(i,3);return padStart(_fixed,this.padTo);}};return PolyNumberFormatter;}();var PolyDateFormatter=function(){function PolyDateFormatter(dt,intl,opts){this.opts=opts;this.originalZone=undefined;var z=undefined;if(this.opts.timeZone){this.dt=dt;}else if(dt.zone.type==="fixed"){var gmtOffset=-1*(dt.offset/60);var offsetZ=gmtOffset>=0?"Etc/GMT+"+gmtOffset:"Etc/GMT"+gmtOffset;if(dt.offset!==0&&IANAZone.create(offsetZ).valid){z=offsetZ;this.dt=dt;}else{z="UTC";this.dt=dt.offset===0?dt:dt.setZone("UTC").plus({minutes:dt.offset});this.originalZone=dt.zone;}}else if(dt.zone.type==="system"){this.dt=dt;}else if(dt.zone.type==="iana"){this.dt=dt;z=dt.zone.name;}else{z="UTC";this.dt=dt.setZone("UTC").plus({minutes:dt.offset});this.originalZone=dt.zone;}
var intlOpts=_extends({},this.opts);intlOpts.timeZone=intlOpts.timeZone||z;this.dtf=getCachedDTF(intl,intlOpts);}
var _proto2=PolyDateFormatter.prototype;_proto2.format=function format(){if(this.originalZone){return this.formatToParts().map(function(_ref){var value=_ref.value;return value;}).join("");}
return this.dtf.format(this.dt.toJSDate());};_proto2.formatToParts=function formatToParts(){var _this=this;var parts=this.dtf.formatToParts(this.dt.toJSDate());if(this.originalZone){return parts.map(function(part){if(part.type==="timeZoneName"){var offsetName=_this.originalZone.offsetName(_this.dt.ts,{locale:_this.dt.locale,format:_this.opts.timeZoneName});return _extends({},part,{value:offsetName});}else{return part;}});}
return parts;};_proto2.resolvedOptions=function resolvedOptions(){return this.dtf.resolvedOptions();};return PolyDateFormatter;}();var PolyRelFormatter=function(){function PolyRelFormatter(intl,isEnglish,opts){this.opts=_extends({style:"long"},opts);if(!isEnglish&&hasRelative()){this.rtf=getCachedRTF(intl,opts);}}
var _proto3=PolyRelFormatter.prototype;_proto3.format=function format(count,unit){if(this.rtf){return this.rtf.format(count,unit);}else{return formatRelativeTime(unit,count,this.opts.numeric,this.opts.style!=="long");}};_proto3.formatToParts=function formatToParts(count,unit){if(this.rtf){return this.rtf.formatToParts(count,unit);}else{return[];}};return PolyRelFormatter;}();var fallbackWeekSettings={firstDay:1,minimalDays:4,weekend:[6,7]};var Locale=function(){Locale.fromOpts=function fromOpts(opts){return Locale.create(opts.locale,opts.numberingSystem,opts.outputCalendar,opts.weekSettings,opts.defaultToEN);};Locale.create=function create(locale,numberingSystem,outputCalendar,weekSettings,defaultToEN){if(defaultToEN===void 0){defaultToEN=false;}
var specifiedLocale=locale||Settings.defaultLocale;var localeR=specifiedLocale||(defaultToEN?"en-US":systemLocale());var numberingSystemR=numberingSystem||Settings.defaultNumberingSystem;var outputCalendarR=outputCalendar||Settings.defaultOutputCalendar;var weekSettingsR=validateWeekSettings(weekSettings)||Settings.defaultWeekSettings;return new Locale(localeR,numberingSystemR,outputCalendarR,weekSettingsR,specifiedLocale);};Locale.resetCache=function resetCache(){sysLocaleCache=null;intlDTCache={};intlNumCache={};intlRelCache={};};Locale.fromObject=function fromObject(_temp){var _ref2=_temp===void 0?{}:_temp,locale=_ref2.locale,numberingSystem=_ref2.numberingSystem,outputCalendar=_ref2.outputCalendar,weekSettings=_ref2.weekSettings;return Locale.create(locale,numberingSystem,outputCalendar,weekSettings);};function Locale(locale,numbering,outputCalendar,weekSettings,specifiedLocale){var _parseLocaleString=parseLocaleString(locale),parsedLocale=_parseLocaleString[0],parsedNumberingSystem=_parseLocaleString[1],parsedOutputCalendar=_parseLocaleString[2];this.locale=parsedLocale;this.numberingSystem=numbering||parsedNumberingSystem||null;this.outputCalendar=outputCalendar||parsedOutputCalendar||null;this.weekSettings=weekSettings;this.intl=intlConfigString(this.locale,this.numberingSystem,this.outputCalendar);this.weekdaysCache={format:{},standalone:{}};this.monthsCache={format:{},standalone:{}};this.meridiemCache=null;this.eraCache={};this.specifiedLocale=specifiedLocale;this.fastNumbersCached=null;}
var _proto4=Locale.prototype;_proto4.listingMode=function listingMode(){var isActuallyEn=this.isEnglish();var hasNoWeirdness=(this.numberingSystem===null||this.numberingSystem==="latn")&&(this.outputCalendar===null||this.outputCalendar==="gregory");return isActuallyEn&&hasNoWeirdness?"en":"intl";};_proto4.clone=function clone(alts){if(!alts||Object.getOwnPropertyNames(alts).length===0){return this;}else{return Locale.create(alts.locale||this.specifiedLocale,alts.numberingSystem||this.numberingSystem,alts.outputCalendar||this.outputCalendar,validateWeekSettings(alts.weekSettings)||this.weekSettings,alts.defaultToEN||false);}};_proto4.redefaultToEN=function redefaultToEN(alts){if(alts===void 0){alts={};}
return this.clone(_extends({},alts,{defaultToEN:true}));};_proto4.redefaultToSystem=function redefaultToSystem(alts){if(alts===void 0){alts={};}
return this.clone(_extends({},alts,{defaultToEN:false}));};_proto4.months=function months$1(length,format){var _this2=this;if(format===void 0){format=false;}
return listStuff(this,length,months,function(){var intl=format?{month:length,day:"numeric"}:{month:length},formatStr=format?"format":"standalone";if(!_this2.monthsCache[formatStr][length]){_this2.monthsCache[formatStr][length]=mapMonths(function(dt){return _this2.extract(dt,intl,"month");});}
return _this2.monthsCache[formatStr][length];});};_proto4.weekdays=function weekdays$1(length,format){var _this3=this;if(format===void 0){format=false;}
return listStuff(this,length,weekdays,function(){var intl=format?{weekday:length,year:"numeric",month:"long",day:"numeric"}:{weekday:length},formatStr=format?"format":"standalone";if(!_this3.weekdaysCache[formatStr][length]){_this3.weekdaysCache[formatStr][length]=mapWeekdays(function(dt){return _this3.extract(dt,intl,"weekday");});}
return _this3.weekdaysCache[formatStr][length];});};_proto4.meridiems=function meridiems$1(){var _this4=this;return listStuff(this,undefined,function(){return meridiems;},function(){if(!_this4.meridiemCache){var intl={hour:"numeric",hourCycle:"h12"};_this4.meridiemCache=[DateTime.utc(2016,11,13,9),DateTime.utc(2016,11,13,19)].map(function(dt){return _this4.extract(dt,intl,"dayperiod");});}
return _this4.meridiemCache;});};_proto4.eras=function eras$1(length){var _this5=this;return listStuff(this,length,eras,function(){var intl={era:length};if(!_this5.eraCache[length]){_this5.eraCache[length]=[DateTime.utc(-40,1,1),DateTime.utc(2017,1,1)].map(function(dt){return _this5.extract(dt,intl,"era");});}
return _this5.eraCache[length];});};_proto4.extract=function extract(dt,intlOpts,field){var df=this.dtFormatter(dt,intlOpts),results=df.formatToParts(),matching=results.find(function(m){return m.type.toLowerCase()===field;});return matching?matching.value:null;};_proto4.numberFormatter=function numberFormatter(opts){if(opts===void 0){opts={};}
return new PolyNumberFormatter(this.intl,opts.forceSimple||this.fastNumbers,opts);};_proto4.dtFormatter=function dtFormatter(dt,intlOpts){if(intlOpts===void 0){intlOpts={};}
return new PolyDateFormatter(dt,this.intl,intlOpts);};_proto4.relFormatter=function relFormatter(opts){if(opts===void 0){opts={};}
return new PolyRelFormatter(this.intl,this.isEnglish(),opts);};_proto4.listFormatter=function listFormatter(opts){if(opts===void 0){opts={};}
return getCachedLF(this.intl,opts);};_proto4.isEnglish=function isEnglish(){return this.locale==="en"||this.locale.toLowerCase()==="en-us"||new Intl.DateTimeFormat(this.intl).resolvedOptions().locale.startsWith("en-us");};_proto4.getWeekSettings=function getWeekSettings(){if(this.weekSettings){return this.weekSettings;}else if(!hasLocaleWeekInfo()){return fallbackWeekSettings;}else{return getCachedWeekInfo(this.locale);}};_proto4.getStartOfWeek=function getStartOfWeek(){return this.getWeekSettings().firstDay;};_proto4.getMinDaysInFirstWeek=function getMinDaysInFirstWeek(){return this.getWeekSettings().minimalDays;};_proto4.getWeekendDays=function getWeekendDays(){return this.getWeekSettings().weekend;};_proto4.equals=function equals(other){return this.locale===other.locale&&this.numberingSystem===other.numberingSystem&&this.outputCalendar===other.outputCalendar;};_createClass(Locale,[{key:"fastNumbers",get:function get(){if(this.fastNumbersCached==null){this.fastNumbersCached=supportsFastNumbers(this);}
return this.fastNumbersCached;}}]);return Locale;}();var singleton=null;var FixedOffsetZone=function(_Zone){_inheritsLoose(FixedOffsetZone,_Zone);FixedOffsetZone.instance=function instance(offset){return offset===0?FixedOffsetZone.utcInstance:new FixedOffsetZone(offset);};FixedOffsetZone.parseSpecifier=function parseSpecifier(s){if(s){var r=s.match(/^utc(?:([+-]\d{1,2})(?::(\d{2}))?)?$/i);if(r){return new FixedOffsetZone(signedOffset(r[1],r[2]));}}
return null;};function FixedOffsetZone(offset){var _this;_this=_Zone.call(this)||this;_this.fixed=offset;return _this;}
var _proto=FixedOffsetZone.prototype;_proto.offsetName=function offsetName(){return this.name;};_proto.formatOffset=function formatOffset$1(ts,format){return formatOffset(this.fixed,format);};_proto.offset=function offset(){return this.fixed;};_proto.equals=function equals(otherZone){return otherZone.type==="fixed"&&otherZone.fixed===this.fixed;};_createClass(FixedOffsetZone,[{key:"type",get:function get(){return"fixed";}},{key:"name",get:function get(){return this.fixed===0?"UTC":"UTC"+formatOffset(this.fixed,"narrow");}},{key:"ianaName",get:function get(){if(this.fixed===0){return"Etc/UTC";}else{return"Etc/GMT"+formatOffset(-this.fixed,"narrow");}}},{key:"isUniversal",get:function get(){return true;}},{key:"isValid",get:function get(){return true;}}],[{key:"utcInstance",get:function get(){if(singleton===null){singleton=new FixedOffsetZone(0);}
return singleton;}}]);return FixedOffsetZone;}(Zone);var InvalidZone=function(_Zone){_inheritsLoose(InvalidZone,_Zone);function InvalidZone(zoneName){var _this;_this=_Zone.call(this)||this;_this.zoneName=zoneName;return _this;}
var _proto=InvalidZone.prototype;_proto.offsetName=function offsetName(){return null;};_proto.formatOffset=function formatOffset(){return"";};_proto.offset=function offset(){return NaN;};_proto.equals=function equals(){return false;};_createClass(InvalidZone,[{key:"type",get:function get(){return"invalid";}},{key:"name",get:function get(){return this.zoneName;}},{key:"isUniversal",get:function get(){return false;}},{key:"isValid",get:function get(){return false;}}]);return InvalidZone;}(Zone);function normalizeZone(input,defaultZone){if(isUndefined(input)||input===null){return defaultZone;}else if(input instanceof Zone){return input;}else if(isString(input)){var lowered=input.toLowerCase();if(lowered==="default")return defaultZone;else if(lowered==="local"||lowered==="system")return SystemZone.instance;else if(lowered==="utc"||lowered==="gmt")return FixedOffsetZone.utcInstance;else return FixedOffsetZone.parseSpecifier(lowered)||IANAZone.create(input);}else if(isNumber(input)){return FixedOffsetZone.instance(input);}else if(typeof input==="object"&&"offset"in input&&typeof input.offset==="function"){return input;}else{return new InvalidZone(input);}}
var now=function now(){return Date.now();},defaultZone="system",defaultLocale=null,defaultNumberingSystem=null,defaultOutputCalendar=null,twoDigitCutoffYear=60,throwOnInvalid,defaultWeekSettings=null;var Settings=function(){function Settings(){}
Settings.resetCaches=function resetCaches(){Locale.resetCache();IANAZone.resetCache();};_createClass(Settings,null,[{key:"now",get:function get(){return now;},set:function set(n){now=n;}},{key:"defaultZone",get:function get(){return normalizeZone(defaultZone,SystemZone.instance);},set:function set(zone){defaultZone=zone;}},{key:"defaultLocale",get:function get(){return defaultLocale;},set:function set(locale){defaultLocale=locale;}},{key:"defaultNumberingSystem",get:function get(){return defaultNumberingSystem;},set:function set(numberingSystem){defaultNumberingSystem=numberingSystem;}},{key:"defaultOutputCalendar",get:function get(){return defaultOutputCalendar;},set:function set(outputCalendar){defaultOutputCalendar=outputCalendar;}},{key:"defaultWeekSettings",get:function get(){return defaultWeekSettings;},set:function set(weekSettings){defaultWeekSettings=validateWeekSettings(weekSettings);}},{key:"twoDigitCutoffYear",get:function get(){return twoDigitCutoffYear;},set:function set(cutoffYear){twoDigitCutoffYear=cutoffYear%100;}},{key:"throwOnInvalid",get:function get(){return throwOnInvalid;},set:function set(t){throwOnInvalid=t;}}]);return Settings;}();var Invalid=function(){function Invalid(reason,explanation){this.reason=reason;this.explanation=explanation;}
var _proto=Invalid.prototype;_proto.toMessage=function toMessage(){if(this.explanation){return this.reason+": "+this.explanation;}else{return this.reason;}};return Invalid;}();var nonLeapLadder=[0,31,59,90,120,151,181,212,243,273,304,334],leapLadder=[0,31,60,91,121,152,182,213,244,274,305,335];function unitOutOfRange(unit,value){return new Invalid("unit out of range","you specified "+value+" (of type "+typeof value+") as a "+unit+", which is invalid");}
function dayOfWeek(year,month,day){var d=new Date(Date.UTC(year,month-1,day));if(year<100&&year>=0){d.setUTCFullYear(d.getUTCFullYear()-1900);}
var js=d.getUTCDay();return js===0?7:js;}
function computeOrdinal(year,month,day){return day+(isLeapYear(year)?leapLadder:nonLeapLadder)[month-1];}
function uncomputeOrdinal(year,ordinal){var table=isLeapYear(year)?leapLadder:nonLeapLadder,month0=table.findIndex(function(i){return i<ordinal;}),day=ordinal-table[month0];return{month:month0+1,day:day};}
function isoWeekdayToLocal(isoWeekday,startOfWeek){return(isoWeekday-startOfWeek+7)%7+1;}
function gregorianToWeek(gregObj,minDaysInFirstWeek,startOfWeek){if(minDaysInFirstWeek===void 0){minDaysInFirstWeek=4;}
if(startOfWeek===void 0){startOfWeek=1;}
var year=gregObj.year,month=gregObj.month,day=gregObj.day,ordinal=computeOrdinal(year,month,day),weekday=isoWeekdayToLocal(dayOfWeek(year,month,day),startOfWeek);var weekNumber=Math.floor((ordinal-weekday+14-minDaysInFirstWeek)/7),weekYear;if(weekNumber<1){weekYear=year-1;weekNumber=weeksInWeekYear(weekYear,minDaysInFirstWeek,startOfWeek);}else if(weekNumber>weeksInWeekYear(year,minDaysInFirstWeek,startOfWeek)){weekYear=year+1;weekNumber=1;}else{weekYear=year;}
return _extends({weekYear:weekYear,weekNumber:weekNumber,weekday:weekday},timeObject(gregObj));}
function weekToGregorian(weekData,minDaysInFirstWeek,startOfWeek){if(minDaysInFirstWeek===void 0){minDaysInFirstWeek=4;}
if(startOfWeek===void 0){startOfWeek=1;}
var weekYear=weekData.weekYear,weekNumber=weekData.weekNumber,weekday=weekData.weekday,weekdayOfJan4=isoWeekdayToLocal(dayOfWeek(weekYear,1,minDaysInFirstWeek),startOfWeek),yearInDays=daysInYear(weekYear);var ordinal=weekNumber*7+weekday-weekdayOfJan4-7+minDaysInFirstWeek,year;if(ordinal<1){year=weekYear-1;ordinal+=daysInYear(year);}else if(ordinal>yearInDays){year=weekYear+1;ordinal-=daysInYear(weekYear);}else{year=weekYear;}
var _uncomputeOrdinal=uncomputeOrdinal(year,ordinal),month=_uncomputeOrdinal.month,day=_uncomputeOrdinal.day;return _extends({year:year,month:month,day:day},timeObject(weekData));}
function gregorianToOrdinal(gregData){var year=gregData.year,month=gregData.month,day=gregData.day;var ordinal=computeOrdinal(year,month,day);return _extends({year:year,ordinal:ordinal},timeObject(gregData));}
function ordinalToGregorian(ordinalData){var year=ordinalData.year,ordinal=ordinalData.ordinal;var _uncomputeOrdinal2=uncomputeOrdinal(year,ordinal),month=_uncomputeOrdinal2.month,day=_uncomputeOrdinal2.day;return _extends({year:year,month:month,day:day},timeObject(ordinalData));}
function usesLocalWeekValues(obj,loc){var hasLocaleWeekData=!isUndefined(obj.localWeekday)||!isUndefined(obj.localWeekNumber)||!isUndefined(obj.localWeekYear);if(hasLocaleWeekData){var hasIsoWeekData=!isUndefined(obj.weekday)||!isUndefined(obj.weekNumber)||!isUndefined(obj.weekYear);if(hasIsoWeekData){throw new ConflictingSpecificationError("Cannot mix locale-based week fields with ISO-based week fields");}
if(!isUndefined(obj.localWeekday))obj.weekday=obj.localWeekday;if(!isUndefined(obj.localWeekNumber))obj.weekNumber=obj.localWeekNumber;if(!isUndefined(obj.localWeekYear))obj.weekYear=obj.localWeekYear;delete obj.localWeekday;delete obj.localWeekNumber;delete obj.localWeekYear;return{minDaysInFirstWeek:loc.getMinDaysInFirstWeek(),startOfWeek:loc.getStartOfWeek()};}else{return{minDaysInFirstWeek:4,startOfWeek:1};}}
function hasInvalidWeekData(obj,minDaysInFirstWeek,startOfWeek){if(minDaysInFirstWeek===void 0){minDaysInFirstWeek=4;}
if(startOfWeek===void 0){startOfWeek=1;}
var validYear=isInteger(obj.weekYear),validWeek=integerBetween(obj.weekNumber,1,weeksInWeekYear(obj.weekYear,minDaysInFirstWeek,startOfWeek)),validWeekday=integerBetween(obj.weekday,1,7);if(!validYear){return unitOutOfRange("weekYear",obj.weekYear);}else if(!validWeek){return unitOutOfRange("week",obj.weekNumber);}else if(!validWeekday){return unitOutOfRange("weekday",obj.weekday);}else return false;}
function hasInvalidOrdinalData(obj){var validYear=isInteger(obj.year),validOrdinal=integerBetween(obj.ordinal,1,daysInYear(obj.year));if(!validYear){return unitOutOfRange("year",obj.year);}else if(!validOrdinal){return unitOutOfRange("ordinal",obj.ordinal);}else return false;}
function hasInvalidGregorianData(obj){var validYear=isInteger(obj.year),validMonth=integerBetween(obj.month,1,12),validDay=integerBetween(obj.day,1,daysInMonth(obj.year,obj.month));if(!validYear){return unitOutOfRange("year",obj.year);}else if(!validMonth){return unitOutOfRange("month",obj.month);}else if(!validDay){return unitOutOfRange("day",obj.day);}else return false;}
function hasInvalidTimeData(obj){var hour=obj.hour,minute=obj.minute,second=obj.second,millisecond=obj.millisecond;var validHour=integerBetween(hour,0,23)||hour===24&&minute===0&&second===0&&millisecond===0,validMinute=integerBetween(minute,0,59),validSecond=integerBetween(second,0,59),validMillisecond=integerBetween(millisecond,0,999);if(!validHour){return unitOutOfRange("hour",hour);}else if(!validMinute){return unitOutOfRange("minute",minute);}else if(!validSecond){return unitOutOfRange("second",second);}else if(!validMillisecond){return unitOutOfRange("millisecond",millisecond);}else return false;}
function isUndefined(o){return typeof o==="undefined";}
function isNumber(o){return typeof o==="number";}
function isInteger(o){return typeof o==="number"&&o%1===0;}
function isString(o){return typeof o==="string";}
function isDate(o){return Object.prototype.toString.call(o)==="[object Date]";}
function hasRelative(){try{return typeof Intl!=="undefined"&&!!Intl.RelativeTimeFormat;}catch(e){return false;}}
function hasLocaleWeekInfo(){try{return typeof Intl!=="undefined"&&!!Intl.Locale&&("weekInfo"in Intl.Locale.prototype||"getWeekInfo"in Intl.Locale.prototype);}catch(e){return false;}}
function maybeArray(thing){return Array.isArray(thing)?thing:[thing];}
function bestBy(arr,by,compare){if(arr.length===0){return undefined;}
return arr.reduce(function(best,next){var pair=[by(next),next];if(!best){return pair;}else if(compare(best[0],pair[0])===best[0]){return best;}else{return pair;}},null)[1];}
function pick(obj,keys){return keys.reduce(function(a,k){a[k]=obj[k];return a;},{});}
function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop);}
function validateWeekSettings(settings){if(settings==null){return null;}else if(typeof settings!=="object"){throw new InvalidArgumentError("Week settings must be an object");}else{if(!integerBetween(settings.firstDay,1,7)||!integerBetween(settings.minimalDays,1,7)||!Array.isArray(settings.weekend)||settings.weekend.some(function(v){return!integerBetween(v,1,7);})){throw new InvalidArgumentError("Invalid week settings");}
return{firstDay:settings.firstDay,minimalDays:settings.minimalDays,weekend:Array.from(settings.weekend)};}}
function integerBetween(thing,bottom,top){return isInteger(thing)&&thing>=bottom&&thing<=top;}
function floorMod(x,n){return x-n*Math.floor(x/n);}
function padStart(input,n){if(n===void 0){n=2;}
var isNeg=input<0;var padded;if(isNeg){padded="-"+(""+-input).padStart(n,"0");}else{padded=(""+input).padStart(n,"0");}
return padded;}
function parseInteger(string){if(isUndefined(string)||string===null||string===""){return undefined;}else{return parseInt(string,10);}}
function parseFloating(string){if(isUndefined(string)||string===null||string===""){return undefined;}else{return parseFloat(string);}}
function parseMillis(fraction){if(isUndefined(fraction)||fraction===null||fraction===""){return undefined;}else{var f=parseFloat("0."+fraction)*1000;return Math.floor(f);}}
function roundTo(number,digits,towardZero){if(towardZero===void 0){towardZero=false;}
var factor=Math.pow(10,digits),rounder=towardZero?Math.trunc:Math.round;return rounder(number*factor)/factor;}
function isLeapYear(year){return year%4===0&&(year%100!==0||year%400===0);}
function daysInYear(year){return isLeapYear(year)?366:365;}
function daysInMonth(year,month){var modMonth=floorMod(month-1,12)+1,modYear=year+(month-modMonth)/12;if(modMonth===2){return isLeapYear(modYear)?29:28;}else{return[31,null,31,30,31,30,31,31,30,31,30,31][modMonth-1];}}
function objToLocalTS(obj){var d=Date.UTC(obj.year,obj.month-1,obj.day,obj.hour,obj.minute,obj.second,obj.millisecond);if(obj.year<100&&obj.year>=0){d=new Date(d);d.setUTCFullYear(obj.year,obj.month-1,obj.day);}
return+d;}
function firstWeekOffset(year,minDaysInFirstWeek,startOfWeek){var fwdlw=isoWeekdayToLocal(dayOfWeek(year,1,minDaysInFirstWeek),startOfWeek);return-fwdlw+minDaysInFirstWeek-1;}
function weeksInWeekYear(weekYear,minDaysInFirstWeek,startOfWeek){if(minDaysInFirstWeek===void 0){minDaysInFirstWeek=4;}
if(startOfWeek===void 0){startOfWeek=1;}
var weekOffset=firstWeekOffset(weekYear,minDaysInFirstWeek,startOfWeek);var weekOffsetNext=firstWeekOffset(weekYear+1,minDaysInFirstWeek,startOfWeek);return(daysInYear(weekYear)-weekOffset+weekOffsetNext)/7;}
function untruncateYear(year){if(year>99){return year;}else return year>Settings.twoDigitCutoffYear?1900+year:2000+year;}
function parseZoneInfo(ts,offsetFormat,locale,timeZone){if(timeZone===void 0){timeZone=null;}
var date=new Date(ts),intlOpts={hourCycle:"h23",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"};if(timeZone){intlOpts.timeZone=timeZone;}
var modified=_extends({timeZoneName:offsetFormat},intlOpts);var parsed=new Intl.DateTimeFormat(locale,modified).formatToParts(date).find(function(m){return m.type.toLowerCase()==="timezonename";});return parsed?parsed.value:null;}
function signedOffset(offHourStr,offMinuteStr){var offHour=parseInt(offHourStr,10);if(Number.isNaN(offHour)){offHour=0;}
var offMin=parseInt(offMinuteStr,10)||0,offMinSigned=offHour<0||Object.is(offHour,-0)?-offMin:offMin;return offHour*60+offMinSigned;}
function asNumber(value){var numericValue=Number(value);if(typeof value==="boolean"||value===""||Number.isNaN(numericValue))throw new InvalidArgumentError("Invalid unit value "+value);return numericValue;}
function normalizeObject(obj,normalizer){var normalized={};for(var u in obj){if(hasOwnProperty(obj,u)){var v=obj[u];if(v===undefined||v===null)continue;normalized[normalizer(u)]=asNumber(v);}}
return normalized;}
function formatOffset(offset,format){var hours=Math.trunc(Math.abs(offset/60)),minutes=Math.trunc(Math.abs(offset%60)),sign=offset>=0?"+":"-";switch(format){case"short":return""+sign+padStart(hours,2)+":"+padStart(minutes,2);case"narrow":return""+sign+hours+(minutes>0?":"+minutes:"");case"techie":return""+sign+padStart(hours,2)+padStart(minutes,2);default:throw new RangeError("Value format "+format+" is out of range for property format");}}
function timeObject(obj){return pick(obj,["hour","minute","second","millisecond"]);}
var monthsLong=["January","February","March","April","May","June","July","August","September","October","November","December"];var monthsShort=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];var monthsNarrow=["J","F","M","A","M","J","J","A","S","O","N","D"];function months(length){switch(length){case"narrow":return[].concat(monthsNarrow);case"short":return[].concat(monthsShort);case"long":return[].concat(monthsLong);case"numeric":return["1","2","3","4","5","6","7","8","9","10","11","12"];case"2-digit":return["01","02","03","04","05","06","07","08","09","10","11","12"];default:return null;}}
var weekdaysLong=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];var weekdaysShort=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];var weekdaysNarrow=["M","T","W","T","F","S","S"];function weekdays(length){switch(length){case"narrow":return[].concat(weekdaysNarrow);case"short":return[].concat(weekdaysShort);case"long":return[].concat(weekdaysLong);case"numeric":return["1","2","3","4","5","6","7"];default:return null;}}
var meridiems=["AM","PM"];var erasLong=["Before Christ","Anno Domini"];var erasShort=["BC","AD"];var erasNarrow=["B","A"];function eras(length){switch(length){case"narrow":return[].concat(erasNarrow);case"short":return[].concat(erasShort);case"long":return[].concat(erasLong);default:return null;}}
function meridiemForDateTime(dt){return meridiems[dt.hour<12?0:1];}
function weekdayForDateTime(dt,length){return weekdays(length)[dt.weekday-1];}
function monthForDateTime(dt,length){return months(length)[dt.month-1];}
function eraForDateTime(dt,length){return eras(length)[dt.year<0?0:1];}
function formatRelativeTime(unit,count,numeric,narrow){if(numeric===void 0){numeric="always";}
if(narrow===void 0){narrow=false;}
var units={years:["year","yr."],quarters:["quarter","qtr."],months:["month","mo."],weeks:["week","wk."],days:["day","day","days"],hours:["hour","hr."],minutes:["minute","min."],seconds:["second","sec."]};var lastable=["hours","minutes","seconds"].indexOf(unit)===-1;if(numeric==="auto"&&lastable){var isDay=unit==="days";switch(count){case 1:return isDay?"tomorrow":"next "+units[unit][0];case-1:return isDay?"yesterday":"last "+units[unit][0];case 0:return isDay?"today":"this "+units[unit][0];}}
var isInPast=Object.is(count,-0)||count<0,fmtValue=Math.abs(count),singular=fmtValue===1,lilUnits=units[unit],fmtUnit=narrow?singular?lilUnits[1]:lilUnits[2]||lilUnits[1]:singular?units[unit][0]:unit;return isInPast?fmtValue+" "+fmtUnit+" ago":"in "+fmtValue+" "+fmtUnit;}
function stringifyTokens(splits,tokenToString){var s="";for(var _iterator=_createForOfIteratorHelperLoose(splits),_step;!(_step=_iterator()).done;){var token=_step.value;if(token.literal){s+=token.val;}else{s+=tokenToString(token.val);}}
return s;}
var _macroTokenToFormatOpts={D:DATE_SHORT,DD:DATE_MED,DDD:DATE_FULL,DDDD:DATE_HUGE,t:TIME_SIMPLE,tt:TIME_WITH_SECONDS,ttt:TIME_WITH_SHORT_OFFSET,tttt:TIME_WITH_LONG_OFFSET,T:TIME_24_SIMPLE,TT:TIME_24_WITH_SECONDS,TTT:TIME_24_WITH_SHORT_OFFSET,TTTT:TIME_24_WITH_LONG_OFFSET,f:DATETIME_SHORT,ff:DATETIME_MED,fff:DATETIME_FULL,ffff:DATETIME_HUGE,F:DATETIME_SHORT_WITH_SECONDS,FF:DATETIME_MED_WITH_SECONDS,FFF:DATETIME_FULL_WITH_SECONDS,FFFF:DATETIME_HUGE_WITH_SECONDS};var Formatter=function(){Formatter.create=function create(locale,opts){if(opts===void 0){opts={};}
return new Formatter(locale,opts);};Formatter.parseFormat=function parseFormat(fmt){var current=null,currentFull="",bracketed=false;var splits=[];for(var i=0;i<fmt.length;i++){var c=fmt.charAt(i);if(c==="'"){if(currentFull.length>0){splits.push({literal:bracketed||/^\s+$/.test(currentFull),val:currentFull});}
current=null;currentFull="";bracketed=!bracketed;}else if(bracketed){currentFull+=c;}else if(c===current){currentFull+=c;}else{if(currentFull.length>0){splits.push({literal:/^\s+$/.test(currentFull),val:currentFull});}
currentFull=c;current=c;}}
if(currentFull.length>0){splits.push({literal:bracketed||/^\s+$/.test(currentFull),val:currentFull});}
return splits;};Formatter.macroTokenToFormatOpts=function macroTokenToFormatOpts(token){return _macroTokenToFormatOpts[token];};function Formatter(locale,formatOpts){this.opts=formatOpts;this.loc=locale;this.systemLoc=null;}
var _proto=Formatter.prototype;_proto.formatWithSystemDefault=function formatWithSystemDefault(dt,opts){if(this.systemLoc===null){this.systemLoc=this.loc.redefaultToSystem();}
var df=this.systemLoc.dtFormatter(dt,_extends({},this.opts,opts));return df.format();};_proto.dtFormatter=function dtFormatter(dt,opts){if(opts===void 0){opts={};}
return this.loc.dtFormatter(dt,_extends({},this.opts,opts));};_proto.formatDateTime=function formatDateTime(dt,opts){return this.dtFormatter(dt,opts).format();};_proto.formatDateTimeParts=function formatDateTimeParts(dt,opts){return this.dtFormatter(dt,opts).formatToParts();};_proto.formatInterval=function formatInterval(interval,opts){var df=this.dtFormatter(interval.start,opts);return df.dtf.formatRange(interval.start.toJSDate(),interval.end.toJSDate());};_proto.resolvedOptions=function resolvedOptions(dt,opts){return this.dtFormatter(dt,opts).resolvedOptions();};_proto.num=function num(n,p){if(p===void 0){p=0;}
if(this.opts.forceSimple){return padStart(n,p);}
var opts=_extends({},this.opts);if(p>0){opts.padTo=p;}
return this.loc.numberFormatter(opts).format(n);};_proto.formatDateTimeFromString=function formatDateTimeFromString(dt,fmt){var _this=this;var knownEnglish=this.loc.listingMode()==="en",useDateTimeFormatter=this.loc.outputCalendar&&this.loc.outputCalendar!=="gregory",string=function string(opts,extract){return _this.loc.extract(dt,opts,extract);},formatOffset=function formatOffset(opts){if(dt.isOffsetFixed&&dt.offset===0&&opts.allowZ){return"Z";}
return dt.isValid?dt.zone.formatOffset(dt.ts,opts.format):"";},meridiem=function meridiem(){return knownEnglish?meridiemForDateTime(dt):string({hour:"numeric",hourCycle:"h12"},"dayperiod");},month=function month(length,standalone){return knownEnglish?monthForDateTime(dt,length):string(standalone?{month:length}:{month:length,day:"numeric"},"month");},weekday=function weekday(length,standalone){return knownEnglish?weekdayForDateTime(dt,length):string(standalone?{weekday:length}:{weekday:length,month:"long",day:"numeric"},"weekday");},maybeMacro=function maybeMacro(token){var formatOpts=Formatter.macroTokenToFormatOpts(token);if(formatOpts){return _this.formatWithSystemDefault(dt,formatOpts);}else{return token;}},era=function era(length){return knownEnglish?eraForDateTime(dt,length):string({era:length},"era");},tokenToString=function tokenToString(token){switch(token){case"S":return _this.num(dt.millisecond);case"u":case"SSS":return _this.num(dt.millisecond,3);case"s":return _this.num(dt.second);case"ss":return _this.num(dt.second,2);case"uu":return _this.num(Math.floor(dt.millisecond/10),2);case"uuu":return _this.num(Math.floor(dt.millisecond/100));case"m":return _this.num(dt.minute);case"mm":return _this.num(dt.minute,2);case"h":return _this.num(dt.hour%12===0?12:dt.hour%12);case"hh":return _this.num(dt.hour%12===0?12:dt.hour%12,2);case"H":return _this.num(dt.hour);case"HH":return _this.num(dt.hour,2);case"Z":return formatOffset({format:"narrow",allowZ:_this.opts.allowZ});case"ZZ":return formatOffset({format:"short",allowZ:_this.opts.allowZ});case"ZZZ":return formatOffset({format:"techie",allowZ:_this.opts.allowZ});case"ZZZZ":return dt.zone.offsetName(dt.ts,{format:"short",locale:_this.loc.locale});case"ZZZZZ":return dt.zone.offsetName(dt.ts,{format:"long",locale:_this.loc.locale});case"z":return dt.zoneName;case"a":return meridiem();case"d":return useDateTimeFormatter?string({day:"numeric"},"day"):_this.num(dt.day);case"dd":return useDateTimeFormatter?string({day:"2-digit"},"day"):_this.num(dt.day,2);case"c":return _this.num(dt.weekday);case"ccc":return weekday("short",true);case"cccc":return weekday("long",true);case"ccccc":return weekday("narrow",true);case"E":return _this.num(dt.weekday);case"EEE":return weekday("short",false);case"EEEE":return weekday("long",false);case"EEEEE":return weekday("narrow",false);case"L":return useDateTimeFormatter?string({month:"numeric",day:"numeric"},"month"):_this.num(dt.month);case"LL":return useDateTimeFormatter?string({month:"2-digit",day:"numeric"},"month"):_this.num(dt.month,2);case"LLL":return month("short",true);case"LLLL":return month("long",true);case"LLLLL":return month("narrow",true);case"M":return useDateTimeFormatter?string({month:"numeric"},"month"):_this.num(dt.month);case"MM":return useDateTimeFormatter?string({month:"2-digit"},"month"):_this.num(dt.month,2);case"MMM":return month("short",false);case"MMMM":return month("long",false);case"MMMMM":return month("narrow",false);case"y":return useDateTimeFormatter?string({year:"numeric"},"year"):_this.num(dt.year);case"yy":return useDateTimeFormatter?string({year:"2-digit"},"year"):_this.num(dt.year.toString().slice(-2),2);case"yyyy":return useDateTimeFormatter?string({year:"numeric"},"year"):_this.num(dt.year,4);case"yyyyyy":return useDateTimeFormatter?string({year:"numeric"},"year"):_this.num(dt.year,6);case"G":return era("short");case"GG":return era("long");case"GGGGG":return era("narrow");case"kk":return _this.num(dt.weekYear.toString().slice(-2),2);case"kkkk":return _this.num(dt.weekYear,4);case"W":return _this.num(dt.weekNumber);case"WW":return _this.num(dt.weekNumber,2);case"n":return _this.num(dt.localWeekNumber);case"nn":return _this.num(dt.localWeekNumber,2);case"ii":return _this.num(dt.localWeekYear.toString().slice(-2),2);case"iiii":return _this.num(dt.localWeekYear,4);case"o":return _this.num(dt.ordinal);case"ooo":return _this.num(dt.ordinal,3);case"q":return _this.num(dt.quarter);case"qq":return _this.num(dt.quarter,2);case"X":return _this.num(Math.floor(dt.ts/1000));case"x":return _this.num(dt.ts);default:return maybeMacro(token);}};return stringifyTokens(Formatter.parseFormat(fmt),tokenToString);};_proto.formatDurationFromString=function formatDurationFromString(dur,fmt){var _this2=this;var tokenToField=function tokenToField(token){switch(token[0]){case"S":return"millisecond";case"s":return"second";case"m":return"minute";case"h":return"hour";case"d":return"day";case"w":return"week";case"M":return"month";case"y":return"year";default:return null;}},tokenToString=function tokenToString(lildur){return function(token){var mapped=tokenToField(token);if(mapped){return _this2.num(lildur.get(mapped),token.length);}else{return token;}};},tokens=Formatter.parseFormat(fmt),realTokens=tokens.reduce(function(found,_ref){var literal=_ref.literal,val=_ref.val;return literal?found:found.concat(val);},[]),collapsed=dur.shiftTo.apply(dur,realTokens.map(tokenToField).filter(function(t){return t;}));return stringifyTokens(tokens,tokenToString(collapsed));};return Formatter;}();var ianaRegex=/[A-Za-z_+-]{1,256}(?::?\/[A-Za-z0-9_+-]{1,256}(?:\/[A-Za-z0-9_+-]{1,256})?)?/;function combineRegexes(){for(var _len=arguments.length,regexes=new Array(_len),_key=0;_key<_len;_key++){regexes[_key]=arguments[_key];}
var full=regexes.reduce(function(f,r){return f+r.source;},"");return RegExp("^"+full+"$");}
function combineExtractors(){for(var _len2=arguments.length,extractors=new Array(_len2),_key2=0;_key2<_len2;_key2++){extractors[_key2]=arguments[_key2];}
return function(m){return extractors.reduce(function(_ref,ex){var mergedVals=_ref[0],mergedZone=_ref[1],cursor=_ref[2];var _ex=ex(m,cursor),val=_ex[0],zone=_ex[1],next=_ex[2];return[_extends({},mergedVals,val),zone||mergedZone,next];},[{},null,1]).slice(0,2);};}
function parse(s){if(s==null){return[null,null];}
for(var _len3=arguments.length,patterns=new Array(_len3>1?_len3-1:0),_key3=1;_key3<_len3;_key3++){patterns[_key3-1]=arguments[_key3];}
for(var _i=0,_patterns=patterns;_i<_patterns.length;_i++){var _patterns$_i=_patterns[_i],regex=_patterns$_i[0],extractor=_patterns$_i[1];var m=regex.exec(s);if(m){return extractor(m);}}
return[null,null];}
function simpleParse(){for(var _len4=arguments.length,keys=new Array(_len4),_key4=0;_key4<_len4;_key4++){keys[_key4]=arguments[_key4];}
return function(match,cursor){var ret={};var i;for(i=0;i<keys.length;i++){ret[keys[i]]=parseInteger(match[cursor+i]);}
return[ret,null,cursor+i];};}
var offsetRegex=/(?:(Z)|([+-]\d\d)(?::?(\d\d))?)/;var isoExtendedZone="(?:"+offsetRegex.source+"?(?:\\[("+ianaRegex.source+")\\])?)?";var isoTimeBaseRegex=/(\d\d)(?::?(\d\d)(?::?(\d\d)(?:[.,](\d{1,30}))?)?)?/;var isoTimeRegex=RegExp(""+isoTimeBaseRegex.source+isoExtendedZone);var isoTimeExtensionRegex=RegExp("(?:T"+isoTimeRegex.source+")?");var isoYmdRegex=/([+-]\d{6}|\d{4})(?:-?(\d\d)(?:-?(\d\d))?)?/;var isoWeekRegex=/(\d{4})-?W(\d\d)(?:-?(\d))?/;var isoOrdinalRegex=/(\d{4})-?(\d{3})/;var extractISOWeekData=simpleParse("weekYear","weekNumber","weekDay");var extractISOOrdinalData=simpleParse("year","ordinal");var sqlYmdRegex=/(\d{4})-(\d\d)-(\d\d)/;var sqlTimeRegex=RegExp(isoTimeBaseRegex.source+" ?(?:"+offsetRegex.source+"|("+ianaRegex.source+"))?");var sqlTimeExtensionRegex=RegExp("(?: "+sqlTimeRegex.source+")?");function int(match,pos,fallback){var m=match[pos];return isUndefined(m)?fallback:parseInteger(m);}
function extractISOYmd(match,cursor){var item={year:int(match,cursor),month:int(match,cursor+1,1),day:int(match,cursor+2,1)};return[item,null,cursor+3];}
function extractISOTime(match,cursor){var item={hours:int(match,cursor,0),minutes:int(match,cursor+1,0),seconds:int(match,cursor+2,0),milliseconds:parseMillis(match[cursor+3])};return[item,null,cursor+4];}
function extractISOOffset(match,cursor){var local=!match[cursor]&&!match[cursor+1],fullOffset=signedOffset(match[cursor+1],match[cursor+2]),zone=local?null:FixedOffsetZone.instance(fullOffset);return[{},zone,cursor+3];}
function extractIANAZone(match,cursor){var zone=match[cursor]?IANAZone.create(match[cursor]):null;return[{},zone,cursor+1];}
var isoTimeOnly=RegExp("^T?"+isoTimeBaseRegex.source+"$");var isoDuration=/^-?P(?:(?:(-?\d{1,20}(?:\.\d{1,20})?)Y)?(?:(-?\d{1,20}(?:\.\d{1,20})?)M)?(?:(-?\d{1,20}(?:\.\d{1,20})?)W)?(?:(-?\d{1,20}(?:\.\d{1,20})?)D)?(?:T(?:(-?\d{1,20}(?:\.\d{1,20})?)H)?(?:(-?\d{1,20}(?:\.\d{1,20})?)M)?(?:(-?\d{1,20})(?:[.,](-?\d{1,20}))?S)?)?)$/;function extractISODuration(match){var s=match[0],yearStr=match[1],monthStr=match[2],weekStr=match[3],dayStr=match[4],hourStr=match[5],minuteStr=match[6],secondStr=match[7],millisecondsStr=match[8];var hasNegativePrefix=s[0]==="-";var negativeSeconds=secondStr&&secondStr[0]==="-";var maybeNegate=function maybeNegate(num,force){if(force===void 0){force=false;}
return num!==undefined&&(force||num&&hasNegativePrefix)?-num:num;};return[{years:maybeNegate(parseFloating(yearStr)),months:maybeNegate(parseFloating(monthStr)),weeks:maybeNegate(parseFloating(weekStr)),days:maybeNegate(parseFloating(dayStr)),hours:maybeNegate(parseFloating(hourStr)),minutes:maybeNegate(parseFloating(minuteStr)),seconds:maybeNegate(parseFloating(secondStr),secondStr==="-0"),milliseconds:maybeNegate(parseMillis(millisecondsStr),negativeSeconds)}];}
var obsOffsets={GMT:0,EDT:-4*60,EST:-5*60,CDT:-5*60,CST:-6*60,MDT:-6*60,MST:-7*60,PDT:-7*60,PST:-8*60};function fromStrings(weekdayStr,yearStr,monthStr,dayStr,hourStr,minuteStr,secondStr){var result={year:yearStr.length===2?untruncateYear(parseInteger(yearStr)):parseInteger(yearStr),month:monthsShort.indexOf(monthStr)+1,day:parseInteger(dayStr),hour:parseInteger(hourStr),minute:parseInteger(minuteStr)};if(secondStr)result.second=parseInteger(secondStr);if(weekdayStr){result.weekday=weekdayStr.length>3?weekdaysLong.indexOf(weekdayStr)+1:weekdaysShort.indexOf(weekdayStr)+1;}
return result;}
var rfc2822=/^(?:(Mon|Tue|Wed|Thu|Fri|Sat|Sun),\s)?(\d{1,2})\s(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s(\d{2,4})\s(\d\d):(\d\d)(?::(\d\d))?\s(?:(UT|GMT|[ECMP][SD]T)|([Zz])|(?:([+-]\d\d)(\d\d)))$/;function extractRFC2822(match){var weekdayStr=match[1],dayStr=match[2],monthStr=match[3],yearStr=match[4],hourStr=match[5],minuteStr=match[6],secondStr=match[7],obsOffset=match[8],milOffset=match[9],offHourStr=match[10],offMinuteStr=match[11],result=fromStrings(weekdayStr,yearStr,monthStr,dayStr,hourStr,minuteStr,secondStr);var offset;if(obsOffset){offset=obsOffsets[obsOffset];}else if(milOffset){offset=0;}else{offset=signedOffset(offHourStr,offMinuteStr);}
return[result,new FixedOffsetZone(offset)];}
function preprocessRFC2822(s){return s.replace(/\([^()]*\)|[\n\t]/g," ").replace(/(\s\s+)/g," ").trim();}
var rfc1123=/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun), (\d\d) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) (\d{4}) (\d\d):(\d\d):(\d\d) GMT$/,rfc850=/^(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday), (\d\d)-(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)-(\d\d) (\d\d):(\d\d):(\d\d) GMT$/,ascii=/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) ( \d|\d\d) (\d\d):(\d\d):(\d\d) (\d{4})$/;function extractRFC1123Or850(match){var weekdayStr=match[1],dayStr=match[2],monthStr=match[3],yearStr=match[4],hourStr=match[5],minuteStr=match[6],secondStr=match[7],result=fromStrings(weekdayStr,yearStr,monthStr,dayStr,hourStr,minuteStr,secondStr);return[result,FixedOffsetZone.utcInstance];}
function extractASCII(match){var weekdayStr=match[1],monthStr=match[2],dayStr=match[3],hourStr=match[4],minuteStr=match[5],secondStr=match[6],yearStr=match[7],result=fromStrings(weekdayStr,yearStr,monthStr,dayStr,hourStr,minuteStr,secondStr);return[result,FixedOffsetZone.utcInstance];}
var isoYmdWithTimeExtensionRegex=combineRegexes(isoYmdRegex,isoTimeExtensionRegex);var isoWeekWithTimeExtensionRegex=combineRegexes(isoWeekRegex,isoTimeExtensionRegex);var isoOrdinalWithTimeExtensionRegex=combineRegexes(isoOrdinalRegex,isoTimeExtensionRegex);var isoTimeCombinedRegex=combineRegexes(isoTimeRegex);var extractISOYmdTimeAndOffset=combineExtractors(extractISOYmd,extractISOTime,extractISOOffset,extractIANAZone);var extractISOWeekTimeAndOffset=combineExtractors(extractISOWeekData,extractISOTime,extractISOOffset,extractIANAZone);var extractISOOrdinalDateAndTime=combineExtractors(extractISOOrdinalData,extractISOTime,extractISOOffset,extractIANAZone);var extractISOTimeAndOffset=combineExtractors(extractISOTime,extractISOOffset,extractIANAZone);function parseISODate(s){return parse(s,[isoYmdWithTimeExtensionRegex,extractISOYmdTimeAndOffset],[isoWeekWithTimeExtensionRegex,extractISOWeekTimeAndOffset],[isoOrdinalWithTimeExtensionRegex,extractISOOrdinalDateAndTime],[isoTimeCombinedRegex,extractISOTimeAndOffset]);}
function parseRFC2822Date(s){return parse(preprocessRFC2822(s),[rfc2822,extractRFC2822]);}
function parseHTTPDate(s){return parse(s,[rfc1123,extractRFC1123Or850],[rfc850,extractRFC1123Or850],[ascii,extractASCII]);}
function parseISODuration(s){return parse(s,[isoDuration,extractISODuration]);}
var extractISOTimeOnly=combineExtractors(extractISOTime);function parseISOTimeOnly(s){return parse(s,[isoTimeOnly,extractISOTimeOnly]);}
var sqlYmdWithTimeExtensionRegex=combineRegexes(sqlYmdRegex,sqlTimeExtensionRegex);var sqlTimeCombinedRegex=combineRegexes(sqlTimeRegex);var extractISOTimeOffsetAndIANAZone=combineExtractors(extractISOTime,extractISOOffset,extractIANAZone);function parseSQL(s){return parse(s,[sqlYmdWithTimeExtensionRegex,extractISOYmdTimeAndOffset],[sqlTimeCombinedRegex,extractISOTimeOffsetAndIANAZone]);}
var INVALID$2="Invalid Duration";var lowOrderMatrix={weeks:{days:7,hours:7*24,minutes:7*24*60,seconds:7*24*60*60,milliseconds:7*24*60*60*1000},days:{hours:24,minutes:24*60,seconds:24*60*60,milliseconds:24*60*60*1000},hours:{minutes:60,seconds:60*60,milliseconds:60*60*1000},minutes:{seconds:60,milliseconds:60*1000},seconds:{milliseconds:1000}},casualMatrix=_extends({years:{quarters:4,months:12,weeks:52,days:365,hours:365*24,minutes:365*24*60,seconds:365*24*60*60,milliseconds:365*24*60*60*1000},quarters:{months:3,weeks:13,days:91,hours:91*24,minutes:91*24*60,seconds:91*24*60*60,milliseconds:91*24*60*60*1000},months:{weeks:4,days:30,hours:30*24,minutes:30*24*60,seconds:30*24*60*60,milliseconds:30*24*60*60*1000}},lowOrderMatrix),daysInYearAccurate=146097.0/400,daysInMonthAccurate=146097.0/4800,accurateMatrix=_extends({years:{quarters:4,months:12,weeks:daysInYearAccurate/7,days:daysInYearAccurate,hours:daysInYearAccurate*24,minutes:daysInYearAccurate*24*60,seconds:daysInYearAccurate*24*60*60,milliseconds:daysInYearAccurate*24*60*60*1000},quarters:{months:3,weeks:daysInYearAccurate/28,days:daysInYearAccurate/4,hours:daysInYearAccurate*24/4,minutes:daysInYearAccurate*24*60/4,seconds:daysInYearAccurate*24*60*60/4,milliseconds:daysInYearAccurate*24*60*60*1000/4},months:{weeks:daysInMonthAccurate/7,days:daysInMonthAccurate,hours:daysInMonthAccurate*24,minutes:daysInMonthAccurate*24*60,seconds:daysInMonthAccurate*24*60*60,milliseconds:daysInMonthAccurate*24*60*60*1000}},lowOrderMatrix);var orderedUnits$1=["years","quarters","months","weeks","days","hours","minutes","seconds","milliseconds"];var reverseUnits=orderedUnits$1.slice(0).reverse();function clone$1(dur,alts,clear){if(clear===void 0){clear=false;}
var conf={values:clear?alts.values:_extends({},dur.values,alts.values||{}),loc:dur.loc.clone(alts.loc),conversionAccuracy:alts.conversionAccuracy||dur.conversionAccuracy,matrix:alts.matrix||dur.matrix};return new Duration(conf);}
function durationToMillis(matrix,vals){var _vals$milliseconds;var sum=(_vals$milliseconds=vals.milliseconds)!=null?_vals$milliseconds:0;for(var _iterator=_createForOfIteratorHelperLoose(reverseUnits.slice(1)),_step;!(_step=_iterator()).done;){var unit=_step.value;if(vals[unit]){sum+=vals[unit]*matrix[unit]["milliseconds"];}}
return sum;}
function normalizeValues(matrix,vals){var factor=durationToMillis(matrix,vals)<0?-1:1;orderedUnits$1.reduceRight(function(previous,current){if(!isUndefined(vals[current])){if(previous){var previousVal=vals[previous]*factor;var conv=matrix[current][previous];var rollUp=Math.floor(previousVal/conv);vals[current]+=rollUp*factor;vals[previous]-=rollUp*conv*factor;}
return current;}else{return previous;}},null);orderedUnits$1.reduce(function(previous,current){if(!isUndefined(vals[current])){if(previous){var fraction=vals[previous]%1;vals[previous]-=fraction;vals[current]+=fraction*matrix[previous][current];}
return current;}else{return previous;}},null);}
function removeZeroes(vals){var newVals={};for(var _i=0,_Object$entries=Object.entries(vals);_i<_Object$entries.length;_i++){var _Object$entries$_i=_Object$entries[_i],key=_Object$entries$_i[0],value=_Object$entries$_i[1];if(value!==0){newVals[key]=value;}}
return newVals;}
var Duration=function(_Symbol$for){function Duration(config){var accurate=config.conversionAccuracy==="longterm"||false;var matrix=accurate?accurateMatrix:casualMatrix;if(config.matrix){matrix=config.matrix;}
this.values=config.values;this.loc=config.loc||Locale.create();this.conversionAccuracy=accurate?"longterm":"casual";this.invalid=config.invalid||null;this.matrix=matrix;this.isLuxonDuration=true;}
Duration.fromMillis=function fromMillis(count,opts){return Duration.fromObject({milliseconds:count},opts);};Duration.fromObject=function fromObject(obj,opts){if(opts===void 0){opts={};}
if(obj==null||typeof obj!=="object"){throw new InvalidArgumentError("Duration.fromObject: argument expected to be an object, got "+(obj===null?"null":typeof obj));}
return new Duration({values:normalizeObject(obj,Duration.normalizeUnit),loc:Locale.fromObject(opts),conversionAccuracy:opts.conversionAccuracy,matrix:opts.matrix});};Duration.fromDurationLike=function fromDurationLike(durationLike){if(isNumber(durationLike)){return Duration.fromMillis(durationLike);}else if(Duration.isDuration(durationLike)){return durationLike;}else if(typeof durationLike==="object"){return Duration.fromObject(durationLike);}else{throw new InvalidArgumentError("Unknown duration argument "+durationLike+" of type "+typeof durationLike);}};Duration.fromISO=function fromISO(text,opts){var _parseISODuration=parseISODuration(text),parsed=_parseISODuration[0];if(parsed){return Duration.fromObject(parsed,opts);}else{return Duration.invalid("unparsable","the input \""+text+"\" can't be parsed as ISO 8601");}};Duration.fromISOTime=function fromISOTime(text,opts){var _parseISOTimeOnly=parseISOTimeOnly(text),parsed=_parseISOTimeOnly[0];if(parsed){return Duration.fromObject(parsed,opts);}else{return Duration.invalid("unparsable","the input \""+text+"\" can't be parsed as ISO 8601");}};Duration.invalid=function invalid(reason,explanation){if(explanation===void 0){explanation=null;}
if(!reason){throw new InvalidArgumentError("need to specify a reason the Duration is invalid");}
var invalid=reason instanceof Invalid?reason:new Invalid(reason,explanation);if(Settings.throwOnInvalid){throw new InvalidDurationError(invalid);}else{return new Duration({invalid:invalid});}};Duration.normalizeUnit=function normalizeUnit(unit){var normalized={year:"years",years:"years",quarter:"quarters",quarters:"quarters",month:"months",months:"months",week:"weeks",weeks:"weeks",day:"days",days:"days",hour:"hours",hours:"hours",minute:"minutes",minutes:"minutes",second:"seconds",seconds:"seconds",millisecond:"milliseconds",milliseconds:"milliseconds"}[unit?unit.toLowerCase():unit];if(!normalized)throw new InvalidUnitError(unit);return normalized;};Duration.isDuration=function isDuration(o){return o&&o.isLuxonDuration||false;};var _proto=Duration.prototype;_proto.toFormat=function toFormat(fmt,opts){if(opts===void 0){opts={};}
var fmtOpts=_extends({},opts,{floor:opts.round!==false&&opts.floor!==false});return this.isValid?Formatter.create(this.loc,fmtOpts).formatDurationFromString(this,fmt):INVALID$2;};_proto.toHuman=function toHuman(opts){var _this=this;if(opts===void 0){opts={};}
if(!this.isValid)return INVALID$2;var l=orderedUnits$1.map(function(unit){var val=_this.values[unit];if(isUndefined(val)){return null;}
return _this.loc.numberFormatter(_extends({style:"unit",unitDisplay:"long"},opts,{unit:unit.slice(0,-1)})).format(val);}).filter(function(n){return n;});return this.loc.listFormatter(_extends({type:"conjunction",style:opts.listStyle||"narrow"},opts)).format(l);};_proto.toObject=function toObject(){if(!this.isValid)return{};return _extends({},this.values);};_proto.toISO=function toISO(){if(!this.isValid)return null;var s="P";if(this.years!==0)s+=this.years+"Y";if(this.months!==0||this.quarters!==0)s+=this.months+this.quarters*3+"M";if(this.weeks!==0)s+=this.weeks+"W";if(this.days!==0)s+=this.days+"D";if(this.hours!==0||this.minutes!==0||this.seconds!==0||this.milliseconds!==0)s+="T";if(this.hours!==0)s+=this.hours+"H";if(this.minutes!==0)s+=this.minutes+"M";if(this.seconds!==0||this.milliseconds!==0)
s+=roundTo(this.seconds+this.milliseconds/1000,3)+"S";if(s==="P")s+="T0S";return s;};_proto.toISOTime=function toISOTime(opts){if(opts===void 0){opts={};}
if(!this.isValid)return null;var millis=this.toMillis();if(millis<0||millis>=86400000)return null;opts=_extends({suppressMilliseconds:false,suppressSeconds:false,includePrefix:false,format:"extended"},opts,{includeOffset:false});var dateTime=DateTime.fromMillis(millis,{zone:"UTC"});return dateTime.toISOTime(opts);};_proto.toJSON=function toJSON(){return this.toISO();};_proto.toString=function toString(){return this.toISO();};_proto[_Symbol$for]=function(){if(this.isValid){return"Duration { values: "+JSON.stringify(this.values)+" }";}else{return"Duration { Invalid, reason: "+this.invalidReason+" }";}};_proto.toMillis=function toMillis(){if(!this.isValid)return NaN;return durationToMillis(this.matrix,this.values);};_proto.valueOf=function valueOf(){return this.toMillis();};_proto.plus=function plus(duration){if(!this.isValid)return this;var dur=Duration.fromDurationLike(duration),result={};for(var _i2=0,_orderedUnits=orderedUnits$1;_i2<_orderedUnits.length;_i2++){var k=_orderedUnits[_i2];if(hasOwnProperty(dur.values,k)||hasOwnProperty(this.values,k)){result[k]=dur.get(k)+this.get(k);}}
return clone$1(this,{values:result},true);};_proto.minus=function minus(duration){if(!this.isValid)return this;var dur=Duration.fromDurationLike(duration);return this.plus(dur.negate());};_proto.mapUnits=function mapUnits(fn){if(!this.isValid)return this;var result={};for(var _i3=0,_Object$keys=Object.keys(this.values);_i3<_Object$keys.length;_i3++){var k=_Object$keys[_i3];result[k]=asNumber(fn(this.values[k],k));}
return clone$1(this,{values:result},true);};_proto.get=function get(unit){return this[Duration.normalizeUnit(unit)];};_proto.set=function set(values){if(!this.isValid)return this;var mixed=_extends({},this.values,normalizeObject(values,Duration.normalizeUnit));return clone$1(this,{values:mixed});};_proto.reconfigure=function reconfigure(_temp){var _ref=_temp===void 0?{}:_temp,locale=_ref.locale,numberingSystem=_ref.numberingSystem,conversionAccuracy=_ref.conversionAccuracy,matrix=_ref.matrix;var loc=this.loc.clone({locale:locale,numberingSystem:numberingSystem});var opts={loc:loc,matrix:matrix,conversionAccuracy:conversionAccuracy};return clone$1(this,opts);};_proto.as=function as(unit){return this.isValid?this.shiftTo(unit).get(unit):NaN;};_proto.normalize=function normalize(){if(!this.isValid)return this;var vals=this.toObject();normalizeValues(this.matrix,vals);return clone$1(this,{values:vals},true);};_proto.rescale=function rescale(){if(!this.isValid)return this;var vals=removeZeroes(this.normalize().shiftToAll().toObject());return clone$1(this,{values:vals},true);};_proto.shiftTo=function shiftTo(){for(var _len=arguments.length,units=new Array(_len),_key=0;_key<_len;_key++){units[_key]=arguments[_key];}
if(!this.isValid)return this;if(units.length===0){return this;}
units=units.map(function(u){return Duration.normalizeUnit(u);});var built={},accumulated={},vals=this.toObject();var lastUnit;for(var _i4=0,_orderedUnits2=orderedUnits$1;_i4<_orderedUnits2.length;_i4++){var k=_orderedUnits2[_i4];if(units.indexOf(k)>=0){lastUnit=k;var own=0;for(var ak in accumulated){own+=this.matrix[ak][k]*accumulated[ak];accumulated[ak]=0;}
if(isNumber(vals[k])){own+=vals[k];}
var i=Math.trunc(own);built[k]=i;accumulated[k]=(own*1000-i*1000)/1000;}else if(isNumber(vals[k])){accumulated[k]=vals[k];}}
for(var key in accumulated){if(accumulated[key]!==0){built[lastUnit]+=key===lastUnit?accumulated[key]:accumulated[key]/this.matrix[lastUnit][key];}}
normalizeValues(this.matrix,built);return clone$1(this,{values:built},true);};_proto.shiftToAll=function shiftToAll(){if(!this.isValid)return this;return this.shiftTo("years","months","weeks","days","hours","minutes","seconds","milliseconds");};_proto.negate=function negate(){if(!this.isValid)return this;var negated={};for(var _i5=0,_Object$keys2=Object.keys(this.values);_i5<_Object$keys2.length;_i5++){var k=_Object$keys2[_i5];negated[k]=this.values[k]===0?0:-this.values[k];}
return clone$1(this,{values:negated},true);};_proto.equals=function equals(other){if(!this.isValid||!other.isValid){return false;}
if(!this.loc.equals(other.loc)){return false;}
function eq(v1,v2){if(v1===undefined||v1===0)return v2===undefined||v2===0;return v1===v2;}
for(var _i6=0,_orderedUnits3=orderedUnits$1;_i6<_orderedUnits3.length;_i6++){var u=_orderedUnits3[_i6];if(!eq(this.values[u],other.values[u])){return false;}}
return true;};_createClass(Duration,[{key:"locale",get:function get(){return this.isValid?this.loc.locale:null;}},{key:"numberingSystem",get:function get(){return this.isValid?this.loc.numberingSystem:null;}},{key:"years",get:function get(){return this.isValid?this.values.years||0:NaN;}},{key:"quarters",get:function get(){return this.isValid?this.values.quarters||0:NaN;}},{key:"months",get:function get(){return this.isValid?this.values.months||0:NaN;}},{key:"weeks",get:function get(){return this.isValid?this.values.weeks||0:NaN;}},{key:"days",get:function get(){return this.isValid?this.values.days||0:NaN;}},{key:"hours",get:function get(){return this.isValid?this.values.hours||0:NaN;}},{key:"minutes",get:function get(){return this.isValid?this.values.minutes||0:NaN;}},{key:"seconds",get:function get(){return this.isValid?this.values.seconds||0:NaN;}},{key:"milliseconds",get:function get(){return this.isValid?this.values.milliseconds||0:NaN;}},{key:"isValid",get:function get(){return this.invalid===null;}},{key:"invalidReason",get:function get(){return this.invalid?this.invalid.reason:null;}},{key:"invalidExplanation",get:function get(){return this.invalid?this.invalid.explanation:null;}}]);return Duration;}(Symbol.for("nodejs.util.inspect.custom"));var INVALID$1="Invalid Interval";function validateStartEnd(start,end){if(!start||!start.isValid){return Interval.invalid("missing or invalid start");}else if(!end||!end.isValid){return Interval.invalid("missing or invalid end");}else if(end<start){return Interval.invalid("end before start","The end of an interval must be after its start, but you had start="+start.toISO()+" and end="+end.toISO());}else{return null;}}
var Interval=function(_Symbol$for){function Interval(config){this.s=config.start;this.e=config.end;this.invalid=config.invalid||null;this.isLuxonInterval=true;}
Interval.invalid=function invalid(reason,explanation){if(explanation===void 0){explanation=null;}
if(!reason){throw new InvalidArgumentError("need to specify a reason the Interval is invalid");}
var invalid=reason instanceof Invalid?reason:new Invalid(reason,explanation);if(Settings.throwOnInvalid){throw new InvalidIntervalError(invalid);}else{return new Interval({invalid:invalid});}};Interval.fromDateTimes=function fromDateTimes(start,end){var builtStart=friendlyDateTime(start),builtEnd=friendlyDateTime(end);var validateError=validateStartEnd(builtStart,builtEnd);if(validateError==null){return new Interval({start:builtStart,end:builtEnd});}else{return validateError;}};Interval.after=function after(start,duration){var dur=Duration.fromDurationLike(duration),dt=friendlyDateTime(start);return Interval.fromDateTimes(dt,dt.plus(dur));};Interval.before=function before(end,duration){var dur=Duration.fromDurationLike(duration),dt=friendlyDateTime(end);return Interval.fromDateTimes(dt.minus(dur),dt);};Interval.fromISO=function fromISO(text,opts){var _split=(text||"").split("/",2),s=_split[0],e=_split[1];if(s&&e){var start,startIsValid;try{start=DateTime.fromISO(s,opts);startIsValid=start.isValid;}catch(e){startIsValid=false;}
var end,endIsValid;try{end=DateTime.fromISO(e,opts);endIsValid=end.isValid;}catch(e){endIsValid=false;}
if(startIsValid&&endIsValid){return Interval.fromDateTimes(start,end);}
if(startIsValid){var dur=Duration.fromISO(e,opts);if(dur.isValid){return Interval.after(start,dur);}}else if(endIsValid){var _dur=Duration.fromISO(s,opts);if(_dur.isValid){return Interval.before(end,_dur);}}}
return Interval.invalid("unparsable","the input \""+text+"\" can't be parsed as ISO 8601");};Interval.isInterval=function isInterval(o){return o&&o.isLuxonInterval||false;};var _proto=Interval.prototype;_proto.length=function length(unit){if(unit===void 0){unit="milliseconds";}
return this.isValid?this.toDuration.apply(this,[unit]).get(unit):NaN;};_proto.count=function count(unit,opts){if(unit===void 0){unit="milliseconds";}
if(!this.isValid)return NaN;var start=this.start.startOf(unit,opts);var end;if(opts!=null&&opts.useLocaleWeeks){end=this.end.reconfigure({locale:start.locale});}else{end=this.end;}
end=end.startOf(unit,opts);return Math.floor(end.diff(start,unit).get(unit))+(end.valueOf()!==this.end.valueOf());};_proto.hasSame=function hasSame(unit){return this.isValid?this.isEmpty()||this.e.minus(1).hasSame(this.s,unit):false;};_proto.isEmpty=function isEmpty(){return this.s.valueOf()===this.e.valueOf();};_proto.isAfter=function isAfter(dateTime){if(!this.isValid)return false;return this.s>dateTime;};_proto.isBefore=function isBefore(dateTime){if(!this.isValid)return false;return this.e<=dateTime;};_proto.contains=function contains(dateTime){if(!this.isValid)return false;return this.s<=dateTime&&this.e>dateTime;};_proto.set=function set(_temp){var _ref=_temp===void 0?{}:_temp,start=_ref.start,end=_ref.end;if(!this.isValid)return this;return Interval.fromDateTimes(start||this.s,end||this.e);};_proto.splitAt=function splitAt(){var _this=this;if(!this.isValid)return[];for(var _len=arguments.length,dateTimes=new Array(_len),_key=0;_key<_len;_key++){dateTimes[_key]=arguments[_key];}
var sorted=dateTimes.map(friendlyDateTime).filter(function(d){return _this.contains(d);}).sort(function(a,b){return a.toMillis()-b.toMillis();}),results=[];var s=this.s,i=0;while(s<this.e){var added=sorted[i]||this.e,next=+added>+this.e?this.e:added;results.push(Interval.fromDateTimes(s,next));s=next;i+=1;}
return results;};_proto.splitBy=function splitBy(duration){var dur=Duration.fromDurationLike(duration);if(!this.isValid||!dur.isValid||dur.as("milliseconds")===0){return[];}
var s=this.s,idx=1,next;var results=[];while(s<this.e){var added=this.start.plus(dur.mapUnits(function(x){return x*idx;}));next=+added>+this.e?this.e:added;results.push(Interval.fromDateTimes(s,next));s=next;idx+=1;}
return results;};_proto.divideEqually=function divideEqually(numberOfParts){if(!this.isValid)return[];return this.splitBy(this.length()/numberOfParts).slice(0,numberOfParts);};_proto.overlaps=function overlaps(other){return this.e>other.s&&this.s<other.e;};_proto.abutsStart=function abutsStart(other){if(!this.isValid)return false;return+this.e===+other.s;};_proto.abutsEnd=function abutsEnd(other){if(!this.isValid)return false;return+other.e===+this.s;};_proto.engulfs=function engulfs(other){if(!this.isValid)return false;return this.s<=other.s&&this.e>=other.e;};_proto.equals=function equals(other){if(!this.isValid||!other.isValid){return false;}
return this.s.equals(other.s)&&this.e.equals(other.e);};_proto.intersection=function intersection(other){if(!this.isValid)return this;var s=this.s>other.s?this.s:other.s,e=this.e<other.e?this.e:other.e;if(s>=e){return null;}else{return Interval.fromDateTimes(s,e);}};_proto.union=function union(other){if(!this.isValid)return this;var s=this.s<other.s?this.s:other.s,e=this.e>other.e?this.e:other.e;return Interval.fromDateTimes(s,e);};Interval.merge=function merge(intervals){var _intervals$sort$reduc=intervals.sort(function(a,b){return a.s-b.s;}).reduce(function(_ref2,item){var sofar=_ref2[0],current=_ref2[1];if(!current){return[sofar,item];}else if(current.overlaps(item)||current.abutsStart(item)){return[sofar,current.union(item)];}else{return[sofar.concat([current]),item];}},[[],null]),found=_intervals$sort$reduc[0],final=_intervals$sort$reduc[1];if(final){found.push(final);}
return found;};Interval.xor=function xor(intervals){var _Array$prototype;var start=null,currentCount=0;var results=[],ends=intervals.map(function(i){return[{time:i.s,type:"s"},{time:i.e,type:"e"}];}),flattened=(_Array$prototype=Array.prototype).concat.apply(_Array$prototype,ends),arr=flattened.sort(function(a,b){return a.time-b.time;});for(var _iterator=_createForOfIteratorHelperLoose(arr),_step;!(_step=_iterator()).done;){var i=_step.value;currentCount+=i.type==="s"?1:-1;if(currentCount===1){start=i.time;}else{if(start&&+start!==+i.time){results.push(Interval.fromDateTimes(start,i.time));}
start=null;}}
return Interval.merge(results);};_proto.difference=function difference(){var _this2=this;for(var _len2=arguments.length,intervals=new Array(_len2),_key2=0;_key2<_len2;_key2++){intervals[_key2]=arguments[_key2];}
return Interval.xor([this].concat(intervals)).map(function(i){return _this2.intersection(i);}).filter(function(i){return i&&!i.isEmpty();});};_proto.toString=function toString(){if(!this.isValid)return INVALID$1;return"["+this.s.toISO()+" \u2013 "+this.e.toISO()+")";};_proto[_Symbol$for]=function(){if(this.isValid){return"Interval { start: "+this.s.toISO()+", end: "+this.e.toISO()+" }";}else{return"Interval { Invalid, reason: "+this.invalidReason+" }";}};_proto.toLocaleString=function toLocaleString(formatOpts,opts){if(formatOpts===void 0){formatOpts=DATE_SHORT;}
if(opts===void 0){opts={};}
return this.isValid?Formatter.create(this.s.loc.clone(opts),formatOpts).formatInterval(this):INVALID$1;};_proto.toISO=function toISO(opts){if(!this.isValid)return INVALID$1;return this.s.toISO(opts)+"/"+this.e.toISO(opts);};_proto.toISODate=function toISODate(){if(!this.isValid)return INVALID$1;return this.s.toISODate()+"/"+this.e.toISODate();};_proto.toISOTime=function toISOTime(opts){if(!this.isValid)return INVALID$1;return this.s.toISOTime(opts)+"/"+this.e.toISOTime(opts);};_proto.toFormat=function toFormat(dateFormat,_temp2){var _ref3=_temp2===void 0?{}:_temp2,_ref3$separator=_ref3.separator,separator=_ref3$separator===void 0?" – ":_ref3$separator;if(!this.isValid)return INVALID$1;return""+this.s.toFormat(dateFormat)+separator+this.e.toFormat(dateFormat);};_proto.toDuration=function toDuration(unit,opts){if(!this.isValid){return Duration.invalid(this.invalidReason);}
return this.e.diff(this.s,unit,opts);};_proto.mapEndpoints=function mapEndpoints(mapFn){return Interval.fromDateTimes(mapFn(this.s),mapFn(this.e));};_createClass(Interval,[{key:"start",get:function get(){return this.isValid?this.s:null;}},{key:"end",get:function get(){return this.isValid?this.e:null;}},{key:"isValid",get:function get(){return this.invalidReason===null;}},{key:"invalidReason",get:function get(){return this.invalid?this.invalid.reason:null;}},{key:"invalidExplanation",get:function get(){return this.invalid?this.invalid.explanation:null;}}]);return Interval;}(Symbol.for("nodejs.util.inspect.custom"));var Info=function(){function Info(){}
Info.hasDST=function hasDST(zone){if(zone===void 0){zone=Settings.defaultZone;}
var proto=DateTime.now().setZone(zone).set({month:12});return!zone.isUniversal&&proto.offset!==proto.set({month:6}).offset;};Info.isValidIANAZone=function isValidIANAZone(zone){return IANAZone.isValidZone(zone);};Info.normalizeZone=function normalizeZone$1(input){return normalizeZone(input,Settings.defaultZone);};Info.getStartOfWeek=function getStartOfWeek(_temp){var _ref=_temp===void 0?{}:_temp,_ref$locale=_ref.locale,locale=_ref$locale===void 0?null:_ref$locale,_ref$locObj=_ref.locObj,locObj=_ref$locObj===void 0?null:_ref$locObj;return(locObj||Locale.create(locale)).getStartOfWeek();};Info.getMinimumDaysInFirstWeek=function getMinimumDaysInFirstWeek(_temp2){var _ref2=_temp2===void 0?{}:_temp2,_ref2$locale=_ref2.locale,locale=_ref2$locale===void 0?null:_ref2$locale,_ref2$locObj=_ref2.locObj,locObj=_ref2$locObj===void 0?null:_ref2$locObj;return(locObj||Locale.create(locale)).getMinDaysInFirstWeek();};Info.getWeekendWeekdays=function getWeekendWeekdays(_temp3){var _ref3=_temp3===void 0?{}:_temp3,_ref3$locale=_ref3.locale,locale=_ref3$locale===void 0?null:_ref3$locale,_ref3$locObj=_ref3.locObj,locObj=_ref3$locObj===void 0?null:_ref3$locObj;return(locObj||Locale.create(locale)).getWeekendDays().slice();};Info.months=function months(length,_temp4){if(length===void 0){length="long";}
var _ref4=_temp4===void 0?{}:_temp4,_ref4$locale=_ref4.locale,locale=_ref4$locale===void 0?null:_ref4$locale,_ref4$numberingSystem=_ref4.numberingSystem,numberingSystem=_ref4$numberingSystem===void 0?null:_ref4$numberingSystem,_ref4$locObj=_ref4.locObj,locObj=_ref4$locObj===void 0?null:_ref4$locObj,_ref4$outputCalendar=_ref4.outputCalendar,outputCalendar=_ref4$outputCalendar===void 0?"gregory":_ref4$outputCalendar;return(locObj||Locale.create(locale,numberingSystem,outputCalendar)).months(length);};Info.monthsFormat=function monthsFormat(length,_temp5){if(length===void 0){length="long";}
var _ref5=_temp5===void 0?{}:_temp5,_ref5$locale=_ref5.locale,locale=_ref5$locale===void 0?null:_ref5$locale,_ref5$numberingSystem=_ref5.numberingSystem,numberingSystem=_ref5$numberingSystem===void 0?null:_ref5$numberingSystem,_ref5$locObj=_ref5.locObj,locObj=_ref5$locObj===void 0?null:_ref5$locObj,_ref5$outputCalendar=_ref5.outputCalendar,outputCalendar=_ref5$outputCalendar===void 0?"gregory":_ref5$outputCalendar;return(locObj||Locale.create(locale,numberingSystem,outputCalendar)).months(length,true);};Info.weekdays=function weekdays(length,_temp6){if(length===void 0){length="long";}
var _ref6=_temp6===void 0?{}:_temp6,_ref6$locale=_ref6.locale,locale=_ref6$locale===void 0?null:_ref6$locale,_ref6$numberingSystem=_ref6.numberingSystem,numberingSystem=_ref6$numberingSystem===void 0?null:_ref6$numberingSystem,_ref6$locObj=_ref6.locObj,locObj=_ref6$locObj===void 0?null:_ref6$locObj;return(locObj||Locale.create(locale,numberingSystem,null)).weekdays(length);};Info.weekdaysFormat=function weekdaysFormat(length,_temp7){if(length===void 0){length="long";}
var _ref7=_temp7===void 0?{}:_temp7,_ref7$locale=_ref7.locale,locale=_ref7$locale===void 0?null:_ref7$locale,_ref7$numberingSystem=_ref7.numberingSystem,numberingSystem=_ref7$numberingSystem===void 0?null:_ref7$numberingSystem,_ref7$locObj=_ref7.locObj,locObj=_ref7$locObj===void 0?null:_ref7$locObj;return(locObj||Locale.create(locale,numberingSystem,null)).weekdays(length,true);};Info.meridiems=function meridiems(_temp8){var _ref8=_temp8===void 0?{}:_temp8,_ref8$locale=_ref8.locale,locale=_ref8$locale===void 0?null:_ref8$locale;return Locale.create(locale).meridiems();};Info.eras=function eras(length,_temp9){if(length===void 0){length="short";}
var _ref9=_temp9===void 0?{}:_temp9,_ref9$locale=_ref9.locale,locale=_ref9$locale===void 0?null:_ref9$locale;return Locale.create(locale,null,"gregory").eras(length);};Info.features=function features(){return{relative:hasRelative(),localeWeek:hasLocaleWeekInfo()};};return Info;}();function dayDiff(earlier,later){var utcDayStart=function utcDayStart(dt){return dt.toUTC(0,{keepLocalTime:true}).startOf("day").valueOf();},ms=utcDayStart(later)-utcDayStart(earlier);return Math.floor(Duration.fromMillis(ms).as("days"));}
function highOrderDiffs(cursor,later,units){var differs=[["years",function(a,b){return b.year-a.year;}],["quarters",function(a,b){return b.quarter-a.quarter+(b.year-a.year)*4;}],["months",function(a,b){return b.month-a.month+(b.year-a.year)*12;}],["weeks",function(a,b){var days=dayDiff(a,b);return(days-days%7)/7;}],["days",dayDiff]];var results={};var earlier=cursor;var lowestOrder,highWater;for(var _i=0,_differs=differs;_i<_differs.length;_i++){var _differs$_i=_differs[_i],unit=_differs$_i[0],differ=_differs$_i[1];if(units.indexOf(unit)>=0){lowestOrder=unit;results[unit]=differ(cursor,later);highWater=earlier.plus(results);if(highWater>later){results[unit]--;cursor=earlier.plus(results);if(cursor>later){highWater=cursor;results[unit]--;cursor=earlier.plus(results);}}else{cursor=highWater;}}}
return[cursor,results,highWater,lowestOrder];}
function _diff(earlier,later,units,opts){var _highOrderDiffs=highOrderDiffs(earlier,later,units),cursor=_highOrderDiffs[0],results=_highOrderDiffs[1],highWater=_highOrderDiffs[2],lowestOrder=_highOrderDiffs[3];var remainingMillis=later-cursor;var lowerOrderUnits=units.filter(function(u){return["hours","minutes","seconds","milliseconds"].indexOf(u)>=0;});if(lowerOrderUnits.length===0){if(highWater<later){var _cursor$plus;highWater=cursor.plus((_cursor$plus={},_cursor$plus[lowestOrder]=1,_cursor$plus));}
if(highWater!==cursor){results[lowestOrder]=(results[lowestOrder]||0)+remainingMillis/(highWater-cursor);}}
var duration=Duration.fromObject(results,opts);if(lowerOrderUnits.length>0){var _Duration$fromMillis;return(_Duration$fromMillis=Duration.fromMillis(remainingMillis,opts)).shiftTo.apply(_Duration$fromMillis,lowerOrderUnits).plus(duration);}else{return duration;}}
var numberingSystems={arab:"[\u0660-\u0669]",arabext:"[\u06F0-\u06F9]",bali:"[\u1B50-\u1B59]",beng:"[\u09E6-\u09EF]",deva:"[\u0966-\u096F]",fullwide:"[\uFF10-\uFF19]",gujr:"[\u0AE6-\u0AEF]",hanidec:"[〇|一|二|三|四|五|六|七|八|九]",khmr:"[\u17E0-\u17E9]",knda:"[\u0CE6-\u0CEF]",laoo:"[\u0ED0-\u0ED9]",limb:"[\u1946-\u194F]",mlym:"[\u0D66-\u0D6F]",mong:"[\u1810-\u1819]",mymr:"[\u1040-\u1049]",orya:"[\u0B66-\u0B6F]",tamldec:"[\u0BE6-\u0BEF]",telu:"[\u0C66-\u0C6F]",thai:"[\u0E50-\u0E59]",tibt:"[\u0F20-\u0F29]",latn:"\\d"};var numberingSystemsUTF16={arab:[1632,1641],arabext:[1776,1785],bali:[6992,7001],beng:[2534,2543],deva:[2406,2415],fullwide:[65296,65303],gujr:[2790,2799],khmr:[6112,6121],knda:[3302,3311],laoo:[3792,3801],limb:[6470,6479],mlym:[3430,3439],mong:[6160,6169],mymr:[4160,4169],orya:[2918,2927],tamldec:[3046,3055],telu:[3174,3183],thai:[3664,3673],tibt:[3872,3881]};var hanidecChars=numberingSystems.hanidec.replace(/[\[|\]]/g,"").split("");function parseDigits(str){var value=parseInt(str,10);if(isNaN(value)){value="";for(var i=0;i<str.length;i++){var code=str.charCodeAt(i);if(str[i].search(numberingSystems.hanidec)!==-1){value+=hanidecChars.indexOf(str[i]);}else{for(var key in numberingSystemsUTF16){var _numberingSystemsUTF=numberingSystemsUTF16[key],min=_numberingSystemsUTF[0],max=_numberingSystemsUTF[1];if(code>=min&&code<=max){value+=code-min;}}}}
return parseInt(value,10);}else{return value;}}
function digitRegex(_ref,append){var numberingSystem=_ref.numberingSystem;if(append===void 0){append="";}
return new RegExp(""+numberingSystems[numberingSystem||"latn"]+append);}
var MISSING_FTP="missing Intl.DateTimeFormat.formatToParts support";function intUnit(regex,post){if(post===void 0){post=function post(i){return i;};}
return{regex:regex,deser:function deser(_ref){var s=_ref[0];return post(parseDigits(s));}};}
var NBSP=String.fromCharCode(160);var spaceOrNBSP="[ "+NBSP+"]";var spaceOrNBSPRegExp=new RegExp(spaceOrNBSP,"g");function fixListRegex(s){return s.replace(/\./g,"\\.?").replace(spaceOrNBSPRegExp,spaceOrNBSP);}
function stripInsensitivities(s){return s.replace(/\./g,"").replace(spaceOrNBSPRegExp," ").toLowerCase();}
function oneOf(strings,startIndex){if(strings===null){return null;}else{return{regex:RegExp(strings.map(fixListRegex).join("|")),deser:function deser(_ref2){var s=_ref2[0];return strings.findIndex(function(i){return stripInsensitivities(s)===stripInsensitivities(i);})+startIndex;}};}}
function offset(regex,groups){return{regex:regex,deser:function deser(_ref3){var h=_ref3[1],m=_ref3[2];return signedOffset(h,m);},groups:groups};}
function simple(regex){return{regex:regex,deser:function deser(_ref4){var s=_ref4[0];return s;}};}
function escapeToken(value){return value.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&");}
function unitForToken(token,loc){var one=digitRegex(loc),two=digitRegex(loc,"{2}"),three=digitRegex(loc,"{3}"),four=digitRegex(loc,"{4}"),six=digitRegex(loc,"{6}"),oneOrTwo=digitRegex(loc,"{1,2}"),oneToThree=digitRegex(loc,"{1,3}"),oneToSix=digitRegex(loc,"{1,6}"),oneToNine=digitRegex(loc,"{1,9}"),twoToFour=digitRegex(loc,"{2,4}"),fourToSix=digitRegex(loc,"{4,6}"),literal=function literal(t){return{regex:RegExp(escapeToken(t.val)),deser:function deser(_ref5){var s=_ref5[0];return s;},literal:true};},unitate=function unitate(t){if(token.literal){return literal(t);}
switch(t.val){case"G":return oneOf(loc.eras("short"),0);case"GG":return oneOf(loc.eras("long"),0);case"y":return intUnit(oneToSix);case"yy":return intUnit(twoToFour,untruncateYear);case"yyyy":return intUnit(four);case"yyyyy":return intUnit(fourToSix);case"yyyyyy":return intUnit(six);case"M":return intUnit(oneOrTwo);case"MM":return intUnit(two);case"MMM":return oneOf(loc.months("short",true),1);case"MMMM":return oneOf(loc.months("long",true),1);case"L":return intUnit(oneOrTwo);case"LL":return intUnit(two);case"LLL":return oneOf(loc.months("short",false),1);case"LLLL":return oneOf(loc.months("long",false),1);case"d":return intUnit(oneOrTwo);case"dd":return intUnit(two);case"o":return intUnit(oneToThree);case"ooo":return intUnit(three);case"HH":return intUnit(two);case"H":return intUnit(oneOrTwo);case"hh":return intUnit(two);case"h":return intUnit(oneOrTwo);case"mm":return intUnit(two);case"m":return intUnit(oneOrTwo);case"q":return intUnit(oneOrTwo);case"qq":return intUnit(two);case"s":return intUnit(oneOrTwo);case"ss":return intUnit(two);case"S":return intUnit(oneToThree);case"SSS":return intUnit(three);case"u":return simple(oneToNine);case"uu":return simple(oneOrTwo);case"uuu":return intUnit(one);case"a":return oneOf(loc.meridiems(),0);case"kkkk":return intUnit(four);case"kk":return intUnit(twoToFour,untruncateYear);case"W":return intUnit(oneOrTwo);case"WW":return intUnit(two);case"E":case"c":return intUnit(one);case"EEE":return oneOf(loc.weekdays("short",false),1);case"EEEE":return oneOf(loc.weekdays("long",false),1);case"ccc":return oneOf(loc.weekdays("short",true),1);case"cccc":return oneOf(loc.weekdays("long",true),1);case"Z":case"ZZ":return offset(new RegExp("([+-]"+oneOrTwo.source+")(?::("+two.source+"))?"),2);case"ZZZ":return offset(new RegExp("([+-]"+oneOrTwo.source+")("+two.source+")?"),2);case"z":return simple(/[a-z_+-/]{1,256}?/i);case" ":return simple(/[^\S\n\r]/);default:return literal(t);}};var unit=unitate(token)||{invalidReason:MISSING_FTP};unit.token=token;return unit;}
var partTypeStyleToTokenVal={year:{"2-digit":"yy",numeric:"yyyyy"},month:{numeric:"M","2-digit":"MM",short:"MMM",long:"MMMM"},day:{numeric:"d","2-digit":"dd"},weekday:{short:"EEE",long:"EEEE"},dayperiod:"a",dayPeriod:"a",hour12:{numeric:"h","2-digit":"hh"},hour24:{numeric:"H","2-digit":"HH"},minute:{numeric:"m","2-digit":"mm"},second:{numeric:"s","2-digit":"ss"},timeZoneName:{long:"ZZZZZ",short:"ZZZ"}};function tokenForPart(part,formatOpts,resolvedOpts){var type=part.type,value=part.value;if(type==="literal"){var isSpace=/^\s+$/.test(value);return{literal:!isSpace,val:isSpace?" ":value};}
var style=formatOpts[type];var actualType=type;if(type==="hour"){if(formatOpts.hour12!=null){actualType=formatOpts.hour12?"hour12":"hour24";}else if(formatOpts.hourCycle!=null){if(formatOpts.hourCycle==="h11"||formatOpts.hourCycle==="h12"){actualType="hour12";}else{actualType="hour24";}}else{actualType=resolvedOpts.hour12?"hour12":"hour24";}}
var val=partTypeStyleToTokenVal[actualType];if(typeof val==="object"){val=val[style];}
if(val){return{literal:false,val:val};}
return undefined;}
function buildRegex(units){var re=units.map(function(u){return u.regex;}).reduce(function(f,r){return f+"("+r.source+")";},"");return["^"+re+"$",units];}
function match(input,regex,handlers){var matches=input.match(regex);if(matches){var all={};var matchIndex=1;for(var i in handlers){if(hasOwnProperty(handlers,i)){var h=handlers[i],groups=h.groups?h.groups+1:1;if(!h.literal&&h.token){all[h.token.val[0]]=h.deser(matches.slice(matchIndex,matchIndex+groups));}
matchIndex+=groups;}}
return[matches,all];}else{return[matches,{}];}}
function dateTimeFromMatches(matches){var toField=function toField(token){switch(token){case"S":return"millisecond";case"s":return"second";case"m":return"minute";case"h":case"H":return"hour";case"d":return"day";case"o":return"ordinal";case"L":case"M":return"month";case"y":return"year";case"E":case"c":return"weekday";case"W":return"weekNumber";case"k":return"weekYear";case"q":return"quarter";default:return null;}};var zone=null;var specificOffset;if(!isUndefined(matches.z)){zone=IANAZone.create(matches.z);}
if(!isUndefined(matches.Z)){if(!zone){zone=new FixedOffsetZone(matches.Z);}
specificOffset=matches.Z;}
if(!isUndefined(matches.q)){matches.M=(matches.q-1)*3+1;}
if(!isUndefined(matches.h)){if(matches.h<12&&matches.a===1){matches.h+=12;}else if(matches.h===12&&matches.a===0){matches.h=0;}}
if(matches.G===0&&matches.y){matches.y=-matches.y;}
if(!isUndefined(matches.u)){matches.S=parseMillis(matches.u);}
var vals=Object.keys(matches).reduce(function(r,k){var f=toField(k);if(f){r[f]=matches[k];}
return r;},{});return[vals,zone,specificOffset];}
var dummyDateTimeCache=null;function getDummyDateTime(){if(!dummyDateTimeCache){dummyDateTimeCache=DateTime.fromMillis(1555555555555);}
return dummyDateTimeCache;}
function maybeExpandMacroToken(token,locale){if(token.literal){return token;}
var formatOpts=Formatter.macroTokenToFormatOpts(token.val);var tokens=formatOptsToTokens(formatOpts,locale);if(tokens==null||tokens.includes(undefined)){return token;}
return tokens;}
function expandMacroTokens(tokens,locale){var _Array$prototype;return(_Array$prototype=Array.prototype).concat.apply(_Array$prototype,tokens.map(function(t){return maybeExpandMacroToken(t,locale);}));}
function explainFromTokens(locale,input,format){var tokens=expandMacroTokens(Formatter.parseFormat(format),locale),units=tokens.map(function(t){return unitForToken(t,locale);}),disqualifyingUnit=units.find(function(t){return t.invalidReason;});if(disqualifyingUnit){return{input:input,tokens:tokens,invalidReason:disqualifyingUnit.invalidReason};}else{var _buildRegex=buildRegex(units),regexString=_buildRegex[0],handlers=_buildRegex[1],regex=RegExp(regexString,"i"),_match=match(input,regex,handlers),rawMatches=_match[0],matches=_match[1],_ref6=matches?dateTimeFromMatches(matches):[null,null,undefined],result=_ref6[0],zone=_ref6[1],specificOffset=_ref6[2];if(hasOwnProperty(matches,"a")&&hasOwnProperty(matches,"H")){throw new ConflictingSpecificationError("Can't include meridiem when specifying 24-hour format");}
return{input:input,tokens:tokens,regex:regex,rawMatches:rawMatches,matches:matches,result:result,zone:zone,specificOffset:specificOffset};}}
function parseFromTokens(locale,input,format){var _explainFromTokens=explainFromTokens(locale,input,format),result=_explainFromTokens.result,zone=_explainFromTokens.zone,specificOffset=_explainFromTokens.specificOffset,invalidReason=_explainFromTokens.invalidReason;return[result,zone,specificOffset,invalidReason];}
function formatOptsToTokens(formatOpts,locale){if(!formatOpts){return null;}
var formatter=Formatter.create(locale,formatOpts);var df=formatter.dtFormatter(getDummyDateTime());var parts=df.formatToParts();var resolvedOpts=df.resolvedOptions();return parts.map(function(p){return tokenForPart(p,formatOpts,resolvedOpts);});}
var INVALID="Invalid DateTime";var MAX_DATE=8.64e15;function unsupportedZone(zone){return new Invalid("unsupported zone","the zone \""+zone.name+"\" is not supported");}
function possiblyCachedWeekData(dt){if(dt.weekData===null){dt.weekData=gregorianToWeek(dt.c);}
return dt.weekData;}
function possiblyCachedLocalWeekData(dt){if(dt.localWeekData===null){dt.localWeekData=gregorianToWeek(dt.c,dt.loc.getMinDaysInFirstWeek(),dt.loc.getStartOfWeek());}
return dt.localWeekData;}
function clone(inst,alts){var current={ts:inst.ts,zone:inst.zone,c:inst.c,o:inst.o,loc:inst.loc,invalid:inst.invalid};return new DateTime(_extends({},current,alts,{old:current}));}
function fixOffset(localTS,o,tz){var utcGuess=localTS-o*60*1000;var o2=tz.offset(utcGuess);if(o===o2){return[utcGuess,o];}
utcGuess-=(o2-o)*60*1000;var o3=tz.offset(utcGuess);if(o2===o3){return[utcGuess,o2];}
return[localTS-Math.min(o2,o3)*60*1000,Math.max(o2,o3)];}
function tsToObj(ts,offset){ts+=offset*60*1000;var d=new Date(ts);return{year:d.getUTCFullYear(),month:d.getUTCMonth()+1,day:d.getUTCDate(),hour:d.getUTCHours(),minute:d.getUTCMinutes(),second:d.getUTCSeconds(),millisecond:d.getUTCMilliseconds()};}
function objToTS(obj,offset,zone){return fixOffset(objToLocalTS(obj),offset,zone);}
function adjustTime(inst,dur){var oPre=inst.o,year=inst.c.year+Math.trunc(dur.years),month=inst.c.month+Math.trunc(dur.months)+Math.trunc(dur.quarters)*3,c=_extends({},inst.c,{year:year,month:month,day:Math.min(inst.c.day,daysInMonth(year,month))+Math.trunc(dur.days)+Math.trunc(dur.weeks)*7}),millisToAdd=Duration.fromObject({years:dur.years-Math.trunc(dur.years),quarters:dur.quarters-Math.trunc(dur.quarters),months:dur.months-Math.trunc(dur.months),weeks:dur.weeks-Math.trunc(dur.weeks),days:dur.days-Math.trunc(dur.days),hours:dur.hours,minutes:dur.minutes,seconds:dur.seconds,milliseconds:dur.milliseconds}).as("milliseconds"),localTS=objToLocalTS(c);var _fixOffset=fixOffset(localTS,oPre,inst.zone),ts=_fixOffset[0],o=_fixOffset[1];if(millisToAdd!==0){ts+=millisToAdd;o=inst.zone.offset(ts);}
return{ts:ts,o:o};}
function parseDataToDateTime(parsed,parsedZone,opts,format,text,specificOffset){var setZone=opts.setZone,zone=opts.zone;if(parsed&&Object.keys(parsed).length!==0||parsedZone){var interpretationZone=parsedZone||zone,inst=DateTime.fromObject(parsed,_extends({},opts,{zone:interpretationZone,specificOffset:specificOffset}));return setZone?inst:inst.setZone(zone);}else{return DateTime.invalid(new Invalid("unparsable","the input \""+text+"\" can't be parsed as "+format));}}
function toTechFormat(dt,format,allowZ){if(allowZ===void 0){allowZ=true;}
return dt.isValid?Formatter.create(Locale.create("en-US"),{allowZ:allowZ,forceSimple:true}).formatDateTimeFromString(dt,format):null;}
function _toISODate(o,extended){var longFormat=o.c.year>9999||o.c.year<0;var c="";if(longFormat&&o.c.year>=0)c+="+";c+=padStart(o.c.year,longFormat?6:4);if(extended){c+="-";c+=padStart(o.c.month);c+="-";c+=padStart(o.c.day);}else{c+=padStart(o.c.month);c+=padStart(o.c.day);}
return c;}
function _toISOTime(o,extended,suppressSeconds,suppressMilliseconds,includeOffset,extendedZone){var c=padStart(o.c.hour);if(extended){c+=":";c+=padStart(o.c.minute);if(o.c.millisecond!==0||o.c.second!==0||!suppressSeconds){c+=":";}}else{c+=padStart(o.c.minute);}
if(o.c.millisecond!==0||o.c.second!==0||!suppressSeconds){c+=padStart(o.c.second);if(o.c.millisecond!==0||!suppressMilliseconds){c+=".";c+=padStart(o.c.millisecond,3);}}
if(includeOffset){if(o.isOffsetFixed&&o.offset===0&&!extendedZone){c+="Z";}else if(o.o<0){c+="-";c+=padStart(Math.trunc(-o.o/60));c+=":";c+=padStart(Math.trunc(-o.o%60));}else{c+="+";c+=padStart(Math.trunc(o.o/60));c+=":";c+=padStart(Math.trunc(o.o%60));}}
if(extendedZone){c+="["+o.zone.ianaName+"]";}
return c;}
var defaultUnitValues={month:1,day:1,hour:0,minute:0,second:0,millisecond:0},defaultWeekUnitValues={weekNumber:1,weekday:1,hour:0,minute:0,second:0,millisecond:0},defaultOrdinalUnitValues={ordinal:1,hour:0,minute:0,second:0,millisecond:0};var orderedUnits=["year","month","day","hour","minute","second","millisecond"],orderedWeekUnits=["weekYear","weekNumber","weekday","hour","minute","second","millisecond"],orderedOrdinalUnits=["year","ordinal","hour","minute","second","millisecond"];function normalizeUnit(unit){var normalized={year:"year",years:"year",month:"month",months:"month",day:"day",days:"day",hour:"hour",hours:"hour",minute:"minute",minutes:"minute",quarter:"quarter",quarters:"quarter",second:"second",seconds:"second",millisecond:"millisecond",milliseconds:"millisecond",weekday:"weekday",weekdays:"weekday",weeknumber:"weekNumber",weeksnumber:"weekNumber",weeknumbers:"weekNumber",weekyear:"weekYear",weekyears:"weekYear",ordinal:"ordinal"}[unit.toLowerCase()];if(!normalized)throw new InvalidUnitError(unit);return normalized;}
function normalizeUnitWithLocalWeeks(unit){switch(unit.toLowerCase()){case"localweekday":case"localweekdays":return"localWeekday";case"localweeknumber":case"localweeknumbers":return"localWeekNumber";case"localweekyear":case"localweekyears":return"localWeekYear";default:return normalizeUnit(unit);}}
function quickDT(obj,opts){var zone=normalizeZone(opts.zone,Settings.defaultZone),loc=Locale.fromObject(opts),tsNow=Settings.now();var ts,o;if(!isUndefined(obj.year)){for(var _i=0,_orderedUnits=orderedUnits;_i<_orderedUnits.length;_i++){var u=_orderedUnits[_i];if(isUndefined(obj[u])){obj[u]=defaultUnitValues[u];}}
var invalid=hasInvalidGregorianData(obj)||hasInvalidTimeData(obj);if(invalid){return DateTime.invalid(invalid);}
var offsetProvis=zone.offset(tsNow);var _objToTS=objToTS(obj,offsetProvis,zone);ts=_objToTS[0];o=_objToTS[1];}else{ts=tsNow;}
return new DateTime({ts:ts,zone:zone,loc:loc,o:o});}
function diffRelative(start,end,opts){var round=isUndefined(opts.round)?true:opts.round,format=function format(c,unit){c=roundTo(c,round||opts.calendary?0:2,true);var formatter=end.loc.clone(opts).relFormatter(opts);return formatter.format(c,unit);},differ=function differ(unit){if(opts.calendary){if(!end.hasSame(start,unit)){return end.startOf(unit).diff(start.startOf(unit),unit).get(unit);}else return 0;}else{return end.diff(start,unit).get(unit);}};if(opts.unit){return format(differ(opts.unit),opts.unit);}
for(var _iterator=_createForOfIteratorHelperLoose(opts.units),_step;!(_step=_iterator()).done;){var unit=_step.value;var count=differ(unit);if(Math.abs(count)>=1){return format(count,unit);}}
return format(start>end?-0:0,opts.units[opts.units.length-1]);}
function lastOpts(argList){var opts={},args;if(argList.length>0&&typeof argList[argList.length-1]==="object"){opts=argList[argList.length-1];args=Array.from(argList).slice(0,argList.length-1);}else{args=Array.from(argList);}
return[opts,args];}
var DateTime=function(_Symbol$for){function DateTime(config){var zone=config.zone||Settings.defaultZone;var invalid=config.invalid||(Number.isNaN(config.ts)?new Invalid("invalid input"):null)||(!zone.isValid?unsupportedZone(zone):null);this.ts=isUndefined(config.ts)?Settings.now():config.ts;var c=null,o=null;if(!invalid){var unchanged=config.old&&config.old.ts===this.ts&&config.old.zone.equals(zone);if(unchanged){var _ref=[config.old.c,config.old.o];c=_ref[0];o=_ref[1];}else{var ot=zone.offset(this.ts);c=tsToObj(this.ts,ot);invalid=Number.isNaN(c.year)?new Invalid("invalid input"):null;c=invalid?null:c;o=invalid?null:ot;}}
this._zone=zone;this.loc=config.loc||Locale.create();this.invalid=invalid;this.weekData=null;this.localWeekData=null;this.c=c;this.o=o;this.isLuxonDateTime=true;}
DateTime.now=function now(){return new DateTime({});};DateTime.local=function local(){var _lastOpts=lastOpts(arguments),opts=_lastOpts[0],args=_lastOpts[1],year=args[0],month=args[1],day=args[2],hour=args[3],minute=args[4],second=args[5],millisecond=args[6];return quickDT({year:year,month:month,day:day,hour:hour,minute:minute,second:second,millisecond:millisecond},opts);};DateTime.utc=function utc(){var _lastOpts2=lastOpts(arguments),opts=_lastOpts2[0],args=_lastOpts2[1],year=args[0],month=args[1],day=args[2],hour=args[3],minute=args[4],second=args[5],millisecond=args[6];opts.zone=FixedOffsetZone.utcInstance;return quickDT({year:year,month:month,day:day,hour:hour,minute:minute,second:second,millisecond:millisecond},opts);};DateTime.fromJSDate=function fromJSDate(date,options){if(options===void 0){options={};}
var ts=isDate(date)?date.valueOf():NaN;if(Number.isNaN(ts)){return DateTime.invalid("invalid input");}
var zoneToUse=normalizeZone(options.zone,Settings.defaultZone);if(!zoneToUse.isValid){return DateTime.invalid(unsupportedZone(zoneToUse));}
return new DateTime({ts:ts,zone:zoneToUse,loc:Locale.fromObject(options)});};DateTime.fromMillis=function fromMillis(milliseconds,options){if(options===void 0){options={};}
if(!isNumber(milliseconds)){throw new InvalidArgumentError("fromMillis requires a numerical input, but received a "+typeof milliseconds+" with value "+milliseconds);}else if(milliseconds<-MAX_DATE||milliseconds>MAX_DATE){return DateTime.invalid("Timestamp out of range");}else{return new DateTime({ts:milliseconds,zone:normalizeZone(options.zone,Settings.defaultZone),loc:Locale.fromObject(options)});}};DateTime.fromSeconds=function fromSeconds(seconds,options){if(options===void 0){options={};}
if(!isNumber(seconds)){throw new InvalidArgumentError("fromSeconds requires a numerical input");}else{return new DateTime({ts:seconds*1000,zone:normalizeZone(options.zone,Settings.defaultZone),loc:Locale.fromObject(options)});}};DateTime.fromObject=function fromObject(obj,opts){if(opts===void 0){opts={};}
obj=obj||{};var zoneToUse=normalizeZone(opts.zone,Settings.defaultZone);if(!zoneToUse.isValid){return DateTime.invalid(unsupportedZone(zoneToUse));}
var loc=Locale.fromObject(opts);var normalized=normalizeObject(obj,normalizeUnitWithLocalWeeks);var _usesLocalWeekValues=usesLocalWeekValues(normalized,loc),minDaysInFirstWeek=_usesLocalWeekValues.minDaysInFirstWeek,startOfWeek=_usesLocalWeekValues.startOfWeek;var tsNow=Settings.now(),offsetProvis=!isUndefined(opts.specificOffset)?opts.specificOffset:zoneToUse.offset(tsNow),containsOrdinal=!isUndefined(normalized.ordinal),containsGregorYear=!isUndefined(normalized.year),containsGregorMD=!isUndefined(normalized.month)||!isUndefined(normalized.day),containsGregor=containsGregorYear||containsGregorMD,definiteWeekDef=normalized.weekYear||normalized.weekNumber;if((containsGregor||containsOrdinal)&&definiteWeekDef){throw new ConflictingSpecificationError("Can't mix weekYear/weekNumber units with year/month/day or ordinals");}
if(containsGregorMD&&containsOrdinal){throw new ConflictingSpecificationError("Can't mix ordinal dates with month/day");}
var useWeekData=definiteWeekDef||normalized.weekday&&!containsGregor;var units,defaultValues,objNow=tsToObj(tsNow,offsetProvis);if(useWeekData){units=orderedWeekUnits;defaultValues=defaultWeekUnitValues;objNow=gregorianToWeek(objNow,minDaysInFirstWeek,startOfWeek);}else if(containsOrdinal){units=orderedOrdinalUnits;defaultValues=defaultOrdinalUnitValues;objNow=gregorianToOrdinal(objNow);}else{units=orderedUnits;defaultValues=defaultUnitValues;}
var foundFirst=false;for(var _iterator2=_createForOfIteratorHelperLoose(units),_step2;!(_step2=_iterator2()).done;){var u=_step2.value;var v=normalized[u];if(!isUndefined(v)){foundFirst=true;}else if(foundFirst){normalized[u]=defaultValues[u];}else{normalized[u]=objNow[u];}}
var higherOrderInvalid=useWeekData?hasInvalidWeekData(normalized,minDaysInFirstWeek,startOfWeek):containsOrdinal?hasInvalidOrdinalData(normalized):hasInvalidGregorianData(normalized),invalid=higherOrderInvalid||hasInvalidTimeData(normalized);if(invalid){return DateTime.invalid(invalid);}
var gregorian=useWeekData?weekToGregorian(normalized,minDaysInFirstWeek,startOfWeek):containsOrdinal?ordinalToGregorian(normalized):normalized,_objToTS2=objToTS(gregorian,offsetProvis,zoneToUse),tsFinal=_objToTS2[0],offsetFinal=_objToTS2[1],inst=new DateTime({ts:tsFinal,zone:zoneToUse,o:offsetFinal,loc:loc});if(normalized.weekday&&containsGregor&&obj.weekday!==inst.weekday){return DateTime.invalid("mismatched weekday","you can't specify both a weekday of "+normalized.weekday+" and a date of "+inst.toISO());}
return inst;};DateTime.fromISO=function fromISO(text,opts){if(opts===void 0){opts={};}
var _parseISODate=parseISODate(text),vals=_parseISODate[0],parsedZone=_parseISODate[1];return parseDataToDateTime(vals,parsedZone,opts,"ISO 8601",text);};DateTime.fromRFC2822=function fromRFC2822(text,opts){if(opts===void 0){opts={};}
var _parseRFC2822Date=parseRFC2822Date(text),vals=_parseRFC2822Date[0],parsedZone=_parseRFC2822Date[1];return parseDataToDateTime(vals,parsedZone,opts,"RFC 2822",text);};DateTime.fromHTTP=function fromHTTP(text,opts){if(opts===void 0){opts={};}
var _parseHTTPDate=parseHTTPDate(text),vals=_parseHTTPDate[0],parsedZone=_parseHTTPDate[1];return parseDataToDateTime(vals,parsedZone,opts,"HTTP",opts);};DateTime.fromFormat=function fromFormat(text,fmt,opts){if(opts===void 0){opts={};}
if(isUndefined(text)||isUndefined(fmt)){throw new InvalidArgumentError("fromFormat requires an input string and a format");}
var _opts=opts,_opts$locale=_opts.locale,locale=_opts$locale===void 0?null:_opts$locale,_opts$numberingSystem=_opts.numberingSystem,numberingSystem=_opts$numberingSystem===void 0?null:_opts$numberingSystem,localeToUse=Locale.fromOpts({locale:locale,numberingSystem:numberingSystem,defaultToEN:true}),_parseFromTokens=parseFromTokens(localeToUse,text,fmt),vals=_parseFromTokens[0],parsedZone=_parseFromTokens[1],specificOffset=_parseFromTokens[2],invalid=_parseFromTokens[3];if(invalid){return DateTime.invalid(invalid);}else{return parseDataToDateTime(vals,parsedZone,opts,"format "+fmt,text,specificOffset);}};DateTime.fromString=function fromString(text,fmt,opts){if(opts===void 0){opts={};}
return DateTime.fromFormat(text,fmt,opts);};DateTime.fromSQL=function fromSQL(text,opts){if(opts===void 0){opts={};}
var _parseSQL=parseSQL(text),vals=_parseSQL[0],parsedZone=_parseSQL[1];return parseDataToDateTime(vals,parsedZone,opts,"SQL",text);};DateTime.invalid=function invalid(reason,explanation){if(explanation===void 0){explanation=null;}
if(!reason){throw new InvalidArgumentError("need to specify a reason the DateTime is invalid");}
var invalid=reason instanceof Invalid?reason:new Invalid(reason,explanation);if(Settings.throwOnInvalid){throw new InvalidDateTimeError(invalid);}else{return new DateTime({invalid:invalid});}};DateTime.isDateTime=function isDateTime(o){return o&&o.isLuxonDateTime||false;};DateTime.parseFormatForOpts=function parseFormatForOpts(formatOpts,localeOpts){if(localeOpts===void 0){localeOpts={};}
var tokenList=formatOptsToTokens(formatOpts,Locale.fromObject(localeOpts));return!tokenList?null:tokenList.map(function(t){return t?t.val:null;}).join("");};DateTime.expandFormat=function expandFormat(fmt,localeOpts){if(localeOpts===void 0){localeOpts={};}
var expanded=expandMacroTokens(Formatter.parseFormat(fmt),Locale.fromObject(localeOpts));return expanded.map(function(t){return t.val;}).join("");};var _proto=DateTime.prototype;_proto.get=function get(unit){return this[unit];};_proto.getPossibleOffsets=function getPossibleOffsets(){if(!this.isValid||this.isOffsetFixed){return[this];}
var dayMs=86400000;var minuteMs=60000;var localTS=objToLocalTS(this.c);var oEarlier=this.zone.offset(localTS-dayMs);var oLater=this.zone.offset(localTS+dayMs);var o1=this.zone.offset(localTS-oEarlier*minuteMs);var o2=this.zone.offset(localTS-oLater*minuteMs);if(o1===o2){return[this];}
var ts1=localTS-o1*minuteMs;var ts2=localTS-o2*minuteMs;var c1=tsToObj(ts1,o1);var c2=tsToObj(ts2,o2);if(c1.hour===c2.hour&&c1.minute===c2.minute&&c1.second===c2.second&&c1.millisecond===c2.millisecond){return[clone(this,{ts:ts1}),clone(this,{ts:ts2})];}
return[this];};_proto.resolvedLocaleOptions=function resolvedLocaleOptions(opts){if(opts===void 0){opts={};}
var _Formatter$create$res=Formatter.create(this.loc.clone(opts),opts).resolvedOptions(this),locale=_Formatter$create$res.locale,numberingSystem=_Formatter$create$res.numberingSystem,calendar=_Formatter$create$res.calendar;return{locale:locale,numberingSystem:numberingSystem,outputCalendar:calendar};};_proto.toUTC=function toUTC(offset,opts){if(offset===void 0){offset=0;}
if(opts===void 0){opts={};}
return this.setZone(FixedOffsetZone.instance(offset),opts);};_proto.toLocal=function toLocal(){return this.setZone(Settings.defaultZone);};_proto.setZone=function setZone(zone,_temp){var _ref2=_temp===void 0?{}:_temp,_ref2$keepLocalTime=_ref2.keepLocalTime,keepLocalTime=_ref2$keepLocalTime===void 0?false:_ref2$keepLocalTime,_ref2$keepCalendarTim=_ref2.keepCalendarTime,keepCalendarTime=_ref2$keepCalendarTim===void 0?false:_ref2$keepCalendarTim;zone=normalizeZone(zone,Settings.defaultZone);if(zone.equals(this.zone)){return this;}else if(!zone.isValid){return DateTime.invalid(unsupportedZone(zone));}else{var newTS=this.ts;if(keepLocalTime||keepCalendarTime){var offsetGuess=zone.offset(this.ts);var asObj=this.toObject();var _objToTS3=objToTS(asObj,offsetGuess,zone);newTS=_objToTS3[0];}
return clone(this,{ts:newTS,zone:zone});}};_proto.reconfigure=function reconfigure(_temp2){var _ref3=_temp2===void 0?{}:_temp2,locale=_ref3.locale,numberingSystem=_ref3.numberingSystem,outputCalendar=_ref3.outputCalendar;var loc=this.loc.clone({locale:locale,numberingSystem:numberingSystem,outputCalendar:outputCalendar});return clone(this,{loc:loc});};_proto.setLocale=function setLocale(locale){return this.reconfigure({locale:locale});};_proto.set=function set(values){if(!this.isValid)return this;var normalized=normalizeObject(values,normalizeUnitWithLocalWeeks);var _usesLocalWeekValues2=usesLocalWeekValues(normalized,this.loc),minDaysInFirstWeek=_usesLocalWeekValues2.minDaysInFirstWeek,startOfWeek=_usesLocalWeekValues2.startOfWeek;var settingWeekStuff=!isUndefined(normalized.weekYear)||!isUndefined(normalized.weekNumber)||!isUndefined(normalized.weekday),containsOrdinal=!isUndefined(normalized.ordinal),containsGregorYear=!isUndefined(normalized.year),containsGregorMD=!isUndefined(normalized.month)||!isUndefined(normalized.day),containsGregor=containsGregorYear||containsGregorMD,definiteWeekDef=normalized.weekYear||normalized.weekNumber;if((containsGregor||containsOrdinal)&&definiteWeekDef){throw new ConflictingSpecificationError("Can't mix weekYear/weekNumber units with year/month/day or ordinals");}
if(containsGregorMD&&containsOrdinal){throw new ConflictingSpecificationError("Can't mix ordinal dates with month/day");}
var mixed;if(settingWeekStuff){mixed=weekToGregorian(_extends({},gregorianToWeek(this.c,minDaysInFirstWeek,startOfWeek),normalized),minDaysInFirstWeek,startOfWeek);}else if(!isUndefined(normalized.ordinal)){mixed=ordinalToGregorian(_extends({},gregorianToOrdinal(this.c),normalized));}else{mixed=_extends({},this.toObject(),normalized);if(isUndefined(normalized.day)){mixed.day=Math.min(daysInMonth(mixed.year,mixed.month),mixed.day);}}
var _objToTS4=objToTS(mixed,this.o,this.zone),ts=_objToTS4[0],o=_objToTS4[1];return clone(this,{ts:ts,o:o});};_proto.plus=function plus(duration){if(!this.isValid)return this;var dur=Duration.fromDurationLike(duration);return clone(this,adjustTime(this,dur));};_proto.minus=function minus(duration){if(!this.isValid)return this;var dur=Duration.fromDurationLike(duration).negate();return clone(this,adjustTime(this,dur));};_proto.startOf=function startOf(unit,_temp3){var _ref4=_temp3===void 0?{}:_temp3,_ref4$useLocaleWeeks=_ref4.useLocaleWeeks,useLocaleWeeks=_ref4$useLocaleWeeks===void 0?false:_ref4$useLocaleWeeks;if(!this.isValid)return this;var o={},normalizedUnit=Duration.normalizeUnit(unit);switch(normalizedUnit){case"years":o.month=1;case"quarters":case"months":o.day=1;case"weeks":case"days":o.hour=0;case"hours":o.minute=0;case"minutes":o.second=0;case"seconds":o.millisecond=0;break;}
if(normalizedUnit==="weeks"){if(useLocaleWeeks){var startOfWeek=this.loc.getStartOfWeek();var weekday=this.weekday;if(weekday<startOfWeek){o.weekNumber=this.weekNumber-1;}
o.weekday=startOfWeek;}else{o.weekday=1;}}
if(normalizedUnit==="quarters"){var q=Math.ceil(this.month/3);o.month=(q-1)*3+1;}
return this.set(o);};_proto.endOf=function endOf(unit,opts){var _this$plus;return this.isValid?this.plus((_this$plus={},_this$plus[unit]=1,_this$plus)).startOf(unit,opts).minus(1):this;};_proto.toFormat=function toFormat(fmt,opts){if(opts===void 0){opts={};}
return this.isValid?Formatter.create(this.loc.redefaultToEN(opts)).formatDateTimeFromString(this,fmt):INVALID;};_proto.toLocaleString=function toLocaleString(formatOpts,opts){if(formatOpts===void 0){formatOpts=DATE_SHORT;}
if(opts===void 0){opts={};}
return this.isValid?Formatter.create(this.loc.clone(opts),formatOpts).formatDateTime(this):INVALID;};_proto.toLocaleParts=function toLocaleParts(opts){if(opts===void 0){opts={};}
return this.isValid?Formatter.create(this.loc.clone(opts),opts).formatDateTimeParts(this):[];};_proto.toISO=function toISO(_temp4){var _ref5=_temp4===void 0?{}:_temp4,_ref5$format=_ref5.format,format=_ref5$format===void 0?"extended":_ref5$format,_ref5$suppressSeconds=_ref5.suppressSeconds,suppressSeconds=_ref5$suppressSeconds===void 0?false:_ref5$suppressSeconds,_ref5$suppressMillise=_ref5.suppressMilliseconds,suppressMilliseconds=_ref5$suppressMillise===void 0?false:_ref5$suppressMillise,_ref5$includeOffset=_ref5.includeOffset,includeOffset=_ref5$includeOffset===void 0?true:_ref5$includeOffset,_ref5$extendedZone=_ref5.extendedZone,extendedZone=_ref5$extendedZone===void 0?false:_ref5$extendedZone;if(!this.isValid){return null;}
var ext=format==="extended";var c=_toISODate(this,ext);c+="T";c+=_toISOTime(this,ext,suppressSeconds,suppressMilliseconds,includeOffset,extendedZone);return c;};_proto.toISODate=function toISODate(_temp5){var _ref6=_temp5===void 0?{}:_temp5,_ref6$format=_ref6.format,format=_ref6$format===void 0?"extended":_ref6$format;if(!this.isValid){return null;}
return _toISODate(this,format==="extended");};_proto.toISOWeekDate=function toISOWeekDate(){return toTechFormat(this,"kkkk-'W'WW-c");};_proto.toISOTime=function toISOTime(_temp6){var _ref7=_temp6===void 0?{}:_temp6,_ref7$suppressMillise=_ref7.suppressMilliseconds,suppressMilliseconds=_ref7$suppressMillise===void 0?false:_ref7$suppressMillise,_ref7$suppressSeconds=_ref7.suppressSeconds,suppressSeconds=_ref7$suppressSeconds===void 0?false:_ref7$suppressSeconds,_ref7$includeOffset=_ref7.includeOffset,includeOffset=_ref7$includeOffset===void 0?true:_ref7$includeOffset,_ref7$includePrefix=_ref7.includePrefix,includePrefix=_ref7$includePrefix===void 0?false:_ref7$includePrefix,_ref7$extendedZone=_ref7.extendedZone,extendedZone=_ref7$extendedZone===void 0?false:_ref7$extendedZone,_ref7$format=_ref7.format,format=_ref7$format===void 0?"extended":_ref7$format;if(!this.isValid){return null;}
var c=includePrefix?"T":"";return c+_toISOTime(this,format==="extended",suppressSeconds,suppressMilliseconds,includeOffset,extendedZone);};_proto.toRFC2822=function toRFC2822(){return toTechFormat(this,"EEE, dd LLL yyyy HH:mm:ss ZZZ",false);};_proto.toHTTP=function toHTTP(){return toTechFormat(this.toUTC(),"EEE, dd LLL yyyy HH:mm:ss 'GMT'");};_proto.toSQLDate=function toSQLDate(){if(!this.isValid){return null;}
return _toISODate(this,true);};_proto.toSQLTime=function toSQLTime(_temp7){var _ref8=_temp7===void 0?{}:_temp7,_ref8$includeOffset=_ref8.includeOffset,includeOffset=_ref8$includeOffset===void 0?true:_ref8$includeOffset,_ref8$includeZone=_ref8.includeZone,includeZone=_ref8$includeZone===void 0?false:_ref8$includeZone,_ref8$includeOffsetSp=_ref8.includeOffsetSpace,includeOffsetSpace=_ref8$includeOffsetSp===void 0?true:_ref8$includeOffsetSp;var fmt="HH:mm:ss.SSS";if(includeZone||includeOffset){if(includeOffsetSpace){fmt+=" ";}
if(includeZone){fmt+="z";}else if(includeOffset){fmt+="ZZ";}}
return toTechFormat(this,fmt,true);};_proto.toSQL=function toSQL(opts){if(opts===void 0){opts={};}
if(!this.isValid){return null;}
return this.toSQLDate()+" "+this.toSQLTime(opts);};_proto.toString=function toString(){return this.isValid?this.toISO():INVALID;};_proto[_Symbol$for]=function(){if(this.isValid){return"DateTime { ts: "+this.toISO()+", zone: "+this.zone.name+", locale: "+this.locale+" }";}else{return"DateTime { Invalid, reason: "+this.invalidReason+" }";}};_proto.valueOf=function valueOf(){return this.toMillis();};_proto.toMillis=function toMillis(){return this.isValid?this.ts:NaN;};_proto.toSeconds=function toSeconds(){return this.isValid?this.ts/1000:NaN;};_proto.toUnixInteger=function toUnixInteger(){return this.isValid?Math.floor(this.ts/1000):NaN;};_proto.toJSON=function toJSON(){return this.toISO();};_proto.toBSON=function toBSON(){return this.toJSDate();};_proto.toObject=function toObject(opts){if(opts===void 0){opts={};}
if(!this.isValid)return{};var base=_extends({},this.c);if(opts.includeConfig){base.outputCalendar=this.outputCalendar;base.numberingSystem=this.loc.numberingSystem;base.locale=this.loc.locale;}
return base;};_proto.toJSDate=function toJSDate(){return new Date(this.isValid?this.ts:NaN);};_proto.diff=function diff(otherDateTime,unit,opts){if(unit===void 0){unit="milliseconds";}
if(opts===void 0){opts={};}
if(!this.isValid||!otherDateTime.isValid){return Duration.invalid("created by diffing an invalid DateTime");}
var durOpts=_extends({locale:this.locale,numberingSystem:this.numberingSystem},opts);var units=maybeArray(unit).map(Duration.normalizeUnit),otherIsLater=otherDateTime.valueOf()>this.valueOf(),earlier=otherIsLater?this:otherDateTime,later=otherIsLater?otherDateTime:this,diffed=_diff(earlier,later,units,durOpts);return otherIsLater?diffed.negate():diffed;};_proto.diffNow=function diffNow(unit,opts){if(unit===void 0){unit="milliseconds";}
if(opts===void 0){opts={};}
return this.diff(DateTime.now(),unit,opts);};_proto.until=function until(otherDateTime){return this.isValid?Interval.fromDateTimes(this,otherDateTime):this;};_proto.hasSame=function hasSame(otherDateTime,unit,opts){if(!this.isValid)return false;var inputMs=otherDateTime.valueOf();var adjustedToZone=this.setZone(otherDateTime.zone,{keepLocalTime:true});return adjustedToZone.startOf(unit,opts)<=inputMs&&inputMs<=adjustedToZone.endOf(unit,opts);};_proto.equals=function equals(other){return this.isValid&&other.isValid&&this.valueOf()===other.valueOf()&&this.zone.equals(other.zone)&&this.loc.equals(other.loc);};_proto.toRelative=function toRelative(options){if(options===void 0){options={};}
if(!this.isValid)return null;var base=options.base||DateTime.fromObject({},{zone:this.zone}),padding=options.padding?this<base?-options.padding:options.padding:0;var units=["years","months","days","hours","minutes","seconds"];var unit=options.unit;if(Array.isArray(options.unit)){units=options.unit;unit=undefined;}
return diffRelative(base,this.plus(padding),_extends({},options,{numeric:"always",units:units,unit:unit}));};_proto.toRelativeCalendar=function toRelativeCalendar(options){if(options===void 0){options={};}
if(!this.isValid)return null;return diffRelative(options.base||DateTime.fromObject({},{zone:this.zone}),this,_extends({},options,{numeric:"auto",units:["years","months","days"],calendary:true}));};DateTime.min=function min(){for(var _len=arguments.length,dateTimes=new Array(_len),_key=0;_key<_len;_key++){dateTimes[_key]=arguments[_key];}
if(!dateTimes.every(DateTime.isDateTime)){throw new InvalidArgumentError("min requires all arguments be DateTimes");}
return bestBy(dateTimes,function(i){return i.valueOf();},Math.min);};DateTime.max=function max(){for(var _len2=arguments.length,dateTimes=new Array(_len2),_key2=0;_key2<_len2;_key2++){dateTimes[_key2]=arguments[_key2];}
if(!dateTimes.every(DateTime.isDateTime)){throw new InvalidArgumentError("max requires all arguments be DateTimes");}
return bestBy(dateTimes,function(i){return i.valueOf();},Math.max);};DateTime.fromFormatExplain=function fromFormatExplain(text,fmt,options){if(options===void 0){options={};}
var _options=options,_options$locale=_options.locale,locale=_options$locale===void 0?null:_options$locale,_options$numberingSys=_options.numberingSystem,numberingSystem=_options$numberingSys===void 0?null:_options$numberingSys,localeToUse=Locale.fromOpts({locale:locale,numberingSystem:numberingSystem,defaultToEN:true});return explainFromTokens(localeToUse,text,fmt);};DateTime.fromStringExplain=function fromStringExplain(text,fmt,options){if(options===void 0){options={};}
return DateTime.fromFormatExplain(text,fmt,options);};_createClass(DateTime,[{key:"isValid",get:function get(){return this.invalid===null;}},{key:"invalidReason",get:function get(){return this.invalid?this.invalid.reason:null;}},{key:"invalidExplanation",get:function get(){return this.invalid?this.invalid.explanation:null;}},{key:"locale",get:function get(){return this.isValid?this.loc.locale:null;}},{key:"numberingSystem",get:function get(){return this.isValid?this.loc.numberingSystem:null;}},{key:"outputCalendar",get:function get(){return this.isValid?this.loc.outputCalendar:null;}},{key:"zone",get:function get(){return this._zone;}},{key:"zoneName",get:function get(){return this.isValid?this.zone.name:null;}},{key:"year",get:function get(){return this.isValid?this.c.year:NaN;}},{key:"quarter",get:function get(){return this.isValid?Math.ceil(this.c.month/3):NaN;}},{key:"month",get:function get(){return this.isValid?this.c.month:NaN;}},{key:"day",get:function get(){return this.isValid?this.c.day:NaN;}},{key:"hour",get:function get(){return this.isValid?this.c.hour:NaN;}},{key:"minute",get:function get(){return this.isValid?this.c.minute:NaN;}},{key:"second",get:function get(){return this.isValid?this.c.second:NaN;}},{key:"millisecond",get:function get(){return this.isValid?this.c.millisecond:NaN;}},{key:"weekYear",get:function get(){return this.isValid?possiblyCachedWeekData(this).weekYear:NaN;}},{key:"weekNumber",get:function get(){return this.isValid?possiblyCachedWeekData(this).weekNumber:NaN;}},{key:"weekday",get:function get(){return this.isValid?possiblyCachedWeekData(this).weekday:NaN;}},{key:"isWeekend",get:function get(){return this.isValid&&this.loc.getWeekendDays().includes(this.weekday);}},{key:"localWeekday",get:function get(){return this.isValid?possiblyCachedLocalWeekData(this).weekday:NaN;}},{key:"localWeekNumber",get:function get(){return this.isValid?possiblyCachedLocalWeekData(this).weekNumber:NaN;}},{key:"localWeekYear",get:function get(){return this.isValid?possiblyCachedLocalWeekData(this).weekYear:NaN;}},{key:"ordinal",get:function get(){return this.isValid?gregorianToOrdinal(this.c).ordinal:NaN;}},{key:"monthShort",get:function get(){return this.isValid?Info.months("short",{locObj:this.loc})[this.month-1]:null;}},{key:"monthLong",get:function get(){return this.isValid?Info.months("long",{locObj:this.loc})[this.month-1]:null;}},{key:"weekdayShort",get:function get(){return this.isValid?Info.weekdays("short",{locObj:this.loc})[this.weekday-1]:null;}},{key:"weekdayLong",get:function get(){return this.isValid?Info.weekdays("long",{locObj:this.loc})[this.weekday-1]:null;}},{key:"offset",get:function get(){return this.isValid?+this.o:NaN;}},{key:"offsetNameShort",get:function get(){if(this.isValid){return this.zone.offsetName(this.ts,{format:"short",locale:this.locale});}else{return null;}}},{key:"offsetNameLong",get:function get(){if(this.isValid){return this.zone.offsetName(this.ts,{format:"long",locale:this.locale});}else{return null;}}},{key:"isOffsetFixed",get:function get(){return this.isValid?this.zone.isUniversal:null;}},{key:"isInDST",get:function get(){if(this.isOffsetFixed){return false;}else{return this.offset>this.set({month:1,day:1}).offset||this.offset>this.set({month:5}).offset;}}},{key:"isInLeapYear",get:function get(){return isLeapYear(this.year);}},{key:"daysInMonth",get:function get(){return daysInMonth(this.year,this.month);}},{key:"daysInYear",get:function get(){return this.isValid?daysInYear(this.year):NaN;}},{key:"weeksInWeekYear",get:function get(){return this.isValid?weeksInWeekYear(this.weekYear):NaN;}},{key:"weeksInLocalWeekYear",get:function get(){return this.isValid?weeksInWeekYear(this.localWeekYear,this.loc.getMinDaysInFirstWeek(),this.loc.getStartOfWeek()):NaN;}}],[{key:"DATE_SHORT",get:function get(){return DATE_SHORT;}},{key:"DATE_MED",get:function get(){return DATE_MED;}},{key:"DATE_MED_WITH_WEEKDAY",get:function get(){return DATE_MED_WITH_WEEKDAY;}},{key:"DATE_FULL",get:function get(){return DATE_FULL;}},{key:"DATE_HUGE",get:function get(){return DATE_HUGE;}},{key:"TIME_SIMPLE",get:function get(){return TIME_SIMPLE;}},{key:"TIME_WITH_SECONDS",get:function get(){return TIME_WITH_SECONDS;}},{key:"TIME_WITH_SHORT_OFFSET",get:function get(){return TIME_WITH_SHORT_OFFSET;}},{key:"TIME_WITH_LONG_OFFSET",get:function get(){return TIME_WITH_LONG_OFFSET;}},{key:"TIME_24_SIMPLE",get:function get(){return TIME_24_SIMPLE;}},{key:"TIME_24_WITH_SECONDS",get:function get(){return TIME_24_WITH_SECONDS;}},{key:"TIME_24_WITH_SHORT_OFFSET",get:function get(){return TIME_24_WITH_SHORT_OFFSET;}},{key:"TIME_24_WITH_LONG_OFFSET",get:function get(){return TIME_24_WITH_LONG_OFFSET;}},{key:"DATETIME_SHORT",get:function get(){return DATETIME_SHORT;}},{key:"DATETIME_SHORT_WITH_SECONDS",get:function get(){return DATETIME_SHORT_WITH_SECONDS;}},{key:"DATETIME_MED",get:function get(){return DATETIME_MED;}},{key:"DATETIME_MED_WITH_SECONDS",get:function get(){return DATETIME_MED_WITH_SECONDS;}},{key:"DATETIME_MED_WITH_WEEKDAY",get:function get(){return DATETIME_MED_WITH_WEEKDAY;}},{key:"DATETIME_FULL",get:function get(){return DATETIME_FULL;}},{key:"DATETIME_FULL_WITH_SECONDS",get:function get(){return DATETIME_FULL_WITH_SECONDS;}},{key:"DATETIME_HUGE",get:function get(){return DATETIME_HUGE;}},{key:"DATETIME_HUGE_WITH_SECONDS",get:function get(){return DATETIME_HUGE_WITH_SECONDS;}}]);return DateTime;}(Symbol.for("nodejs.util.inspect.custom"));function friendlyDateTime(dateTimeish){if(DateTime.isDateTime(dateTimeish)){return dateTimeish;}else if(dateTimeish&&dateTimeish.valueOf&&isNumber(dateTimeish.valueOf())){return DateTime.fromJSDate(dateTimeish);}else if(dateTimeish&&typeof dateTimeish==="object"){return DateTime.fromObject(dateTimeish);}else{throw new InvalidArgumentError("Unknown datetime argument: "+dateTimeish+", of type "+typeof dateTimeish);}}
var VERSION="3.4.4";exports.DateTime=DateTime;exports.Duration=Duration;exports.FixedOffsetZone=FixedOffsetZone;exports.IANAZone=IANAZone;exports.Info=Info;exports.Interval=Interval;exports.InvalidZone=InvalidZone;exports.Settings=Settings;exports.SystemZone=SystemZone;exports.VERSION=VERSION;exports.Zone=Zone;Object.defineProperty(exports,'__esModule',{value:true});return exports;})({});(function(global,factory){typeof exports==='object'&&typeof module!=='undefined'?module.exports=factory():typeof define==='function'&&define.amd?define(factory):(global=typeof globalThis!=='undefined'?globalThis:global||self,global.Konva=factory());})(this,(function(){'use strict';const PI_OVER_180=Math.PI/180;function detectBrowser(){return(typeof window!=='undefined'&&({}.toString.call(window)==='[object Window]'||{}.toString.call(window)==='[object global]'));}
const glob=typeof global!=='undefined'?global:typeof window!=='undefined'?window:typeof WorkerGlobalScope!=='undefined'?self:{};const Konva$2={_global:glob,version:'9.3.6',isBrowser:detectBrowser(),isUnminified:/param/.test(function(param){}.toString()),dblClickWindow:400,getAngle(angle){return Konva$2.angleDeg?angle*PI_OVER_180:angle;},enableTrace:false,pointerEventsEnabled:true,autoDrawEnabled:true,hitOnDragEnabled:false,capturePointerEventsEnabled:false,_mouseListenClick:false,_touchListenClick:false,_pointerListenClick:false,_mouseInDblClickWindow:false,_touchInDblClickWindow:false,_pointerInDblClickWindow:false,_mouseDblClickPointerId:null,_touchDblClickPointerId:null,_pointerDblClickPointerId:null,pixelRatio:(typeof window!=='undefined'&&window.devicePixelRatio)||1,dragDistance:3,angleDeg:true,showWarnings:true,dragButtons:[0,1],isDragging(){return Konva$2['DD'].isDragging;},isTransforming(){var _a;return(_a=Konva$2['Transformer'])===null||_a===void 0?void 0:_a.isTransforming();},isDragReady(){return!!Konva$2['DD'].node;},releaseCanvasOnDestroy:true,document:glob.document,_injectGlobal(Konva){glob.Konva=Konva;},};const _registerNode=(NodeClass)=>{Konva$2[NodeClass.prototype.getClassName()]=NodeClass;};Konva$2._injectGlobal(Konva$2);class Transform{constructor(m=[1,0,0,1,0,0]){this.dirty=false;this.m=(m&&m.slice())||[1,0,0,1,0,0];}
reset(){this.m[0]=1;this.m[1]=0;this.m[2]=0;this.m[3]=1;this.m[4]=0;this.m[5]=0;}
copy(){return new Transform(this.m);}
copyInto(tr){tr.m[0]=this.m[0];tr.m[1]=this.m[1];tr.m[2]=this.m[2];tr.m[3]=this.m[3];tr.m[4]=this.m[4];tr.m[5]=this.m[5];}
point(point){var m=this.m;return{x:m[0]*point.x+m[2]*point.y+m[4],y:m[1]*point.x+m[3]*point.y+m[5],};}
translate(x,y){this.m[4]+=this.m[0]*x+this.m[2]*y;this.m[5]+=this.m[1]*x+this.m[3]*y;return this;}
scale(sx,sy){this.m[0]*=sx;this.m[1]*=sx;this.m[2]*=sy;this.m[3]*=sy;return this;}
rotate(rad){var c=Math.cos(rad);var s=Math.sin(rad);var m11=this.m[0]*c+this.m[2]*s;var m12=this.m[1]*c+this.m[3]*s;var m21=this.m[0]*-s+this.m[2]*c;var m22=this.m[1]*-s+this.m[3]*c;this.m[0]=m11;this.m[1]=m12;this.m[2]=m21;this.m[3]=m22;return this;}
getTranslation(){return{x:this.m[4],y:this.m[5],};}
skew(sx,sy){var m11=this.m[0]+this.m[2]*sy;var m12=this.m[1]+this.m[3]*sy;var m21=this.m[2]+this.m[0]*sx;var m22=this.m[3]+this.m[1]*sx;this.m[0]=m11;this.m[1]=m12;this.m[2]=m21;this.m[3]=m22;return this;}
multiply(matrix){var m11=this.m[0]*matrix.m[0]+this.m[2]*matrix.m[1];var m12=this.m[1]*matrix.m[0]+this.m[3]*matrix.m[1];var m21=this.m[0]*matrix.m[2]+this.m[2]*matrix.m[3];var m22=this.m[1]*matrix.m[2]+this.m[3]*matrix.m[3];var dx=this.m[0]*matrix.m[4]+this.m[2]*matrix.m[5]+this.m[4];var dy=this.m[1]*matrix.m[4]+this.m[3]*matrix.m[5]+this.m[5];this.m[0]=m11;this.m[1]=m12;this.m[2]=m21;this.m[3]=m22;this.m[4]=dx;this.m[5]=dy;return this;}
invert(){var d=1/(this.m[0]*this.m[3]-this.m[1]*this.m[2]);var m0=this.m[3]*d;var m1=-this.m[1]*d;var m2=-this.m[2]*d;var m3=this.m[0]*d;var m4=d*(this.m[2]*this.m[5]-this.m[3]*this.m[4]);var m5=d*(this.m[1]*this.m[4]-this.m[0]*this.m[5]);this.m[0]=m0;this.m[1]=m1;this.m[2]=m2;this.m[3]=m3;this.m[4]=m4;this.m[5]=m5;return this;}
getMatrix(){return this.m;}
decompose(){var a=this.m[0];var b=this.m[1];var c=this.m[2];var d=this.m[3];var e=this.m[4];var f=this.m[5];var delta=a*d-b*c;let result={x:e,y:f,rotation:0,scaleX:0,scaleY:0,skewX:0,skewY:0,};if(a!=0||b!=0){var r=Math.sqrt(a*a+b*b);result.rotation=b>0?Math.acos(a/r):-Math.acos(a/r);result.scaleX=r;result.scaleY=delta/r;result.skewX=(a*c+b*d)/delta;result.skewY=0;}
else if(c!=0||d!=0){var s=Math.sqrt(c*c+d*d);result.rotation=Math.PI/2-(d>0?Math.acos(-c/s):-Math.acos(c/s));result.scaleX=delta/s;result.scaleY=s;result.skewX=0;result.skewY=(a*c+b*d)/delta;}
else;result.rotation=Util._getRotation(result.rotation);return result;}}
var OBJECT_ARRAY='[object Array]',OBJECT_NUMBER='[object Number]',OBJECT_STRING='[object String]',OBJECT_BOOLEAN='[object Boolean]',PI_OVER_DEG180=Math.PI/180,DEG180_OVER_PI=180/Math.PI,HASH$1='#',EMPTY_STRING$1='',ZERO='0',KONVA_WARNING='Konva warning: ',KONVA_ERROR='Konva error: ',RGB_PAREN='rgb(',COLORS={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,132,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,255,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,203],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[119,128,144],slategrey:[119,128,144],snow:[255,255,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],transparent:[255,255,255,0],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,5],},RGB_REGEX=/rgb\((\d{1,3}),(\d{1,3}),(\d{1,3})\)/,animQueue=[];const req=(typeof requestAnimationFrame!=='undefined'&&requestAnimationFrame)||function(f){setTimeout(f,60);};const Util={_isElement(obj){return!!(obj&&obj.nodeType==1);},_isFunction(obj){return!!(obj&&obj.constructor&&obj.call&&obj.apply);},_isPlainObject(obj){return!!obj&&obj.constructor===Object;},_isArray(obj){return Object.prototype.toString.call(obj)===OBJECT_ARRAY;},_isNumber(obj){return(Object.prototype.toString.call(obj)===OBJECT_NUMBER&&!isNaN(obj)&&isFinite(obj));},_isString(obj){return Object.prototype.toString.call(obj)===OBJECT_STRING;},_isBoolean(obj){return Object.prototype.toString.call(obj)===OBJECT_BOOLEAN;},isObject(val){return val instanceof Object;},isValidSelector(selector){if(typeof selector!=='string'){return false;}
var firstChar=selector[0];return(firstChar==='#'||firstChar==='.'||firstChar===firstChar.toUpperCase());},_sign(number){if(number===0){return 1;}
if(number>0){return 1;}
else{return-1;}},requestAnimFrame(callback){animQueue.push(callback);if(animQueue.length===1){req(function(){const queue=animQueue;animQueue=[];queue.forEach(function(cb){cb();});});}},createCanvasElement(){var canvas=document.createElement('canvas');try{canvas.style=canvas.style||{};}
catch(e){}
return canvas;},createImageElement(){return document.createElement('img');},_isInDocument(el){while((el=el.parentNode)){if(el==document){return true;}}
return false;},_urlToImage(url,callback){var imageObj=Util.createImageElement();imageObj.onload=function(){callback(imageObj);};imageObj.src=url;},_rgbToHex(r,g,b){return((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1);},_hexToRgb(hex){hex=hex.replace(HASH$1,EMPTY_STRING$1);var bigint=parseInt(hex,16);return{r:(bigint>>16)&255,g:(bigint>>8)&255,b:bigint&255,};},getRandomColor(){var randColor=((Math.random()*0xffffff)<<0).toString(16);while(randColor.length<6){randColor=ZERO+randColor;}
return HASH$1+randColor;},getRGB(color){var rgb;if(color in COLORS){rgb=COLORS[color];return{r:rgb[0],g:rgb[1],b:rgb[2],};}
else if(color[0]===HASH$1){return this._hexToRgb(color.substring(1));}
else if(color.substr(0,4)===RGB_PAREN){rgb=RGB_REGEX.exec(color.replace(/ /g,''));return{r:parseInt(rgb[1],10),g:parseInt(rgb[2],10),b:parseInt(rgb[3],10),};}
else{return{r:0,g:0,b:0,};}},colorToRGBA(str){str=str||'black';return(Util._namedColorToRBA(str)||Util._hex3ColorToRGBA(str)||Util._hex4ColorToRGBA(str)||Util._hex6ColorToRGBA(str)||Util._hex8ColorToRGBA(str)||Util._rgbColorToRGBA(str)||Util._rgbaColorToRGBA(str)||Util._hslColorToRGBA(str));},_namedColorToRBA(str){var c=COLORS[str.toLowerCase()];if(!c){return null;}
return{r:c[0],g:c[1],b:c[2],a:1,};},_rgbColorToRGBA(str){if(str.indexOf('rgb(')===0){str=str.match(/rgb\(([^)]+)\)/)[1];var parts=str.split(/ *, */).map(Number);return{r:parts[0],g:parts[1],b:parts[2],a:1,};}},_rgbaColorToRGBA(str){if(str.indexOf('rgba(')===0){str=str.match(/rgba\(([^)]+)\)/)[1];var parts=str.split(/ *, */).map((n,index)=>{if(n.slice(-1)==='%'){return index===3?parseInt(n)/100:(parseInt(n)/100)*255;}
return Number(n);});return{r:parts[0],g:parts[1],b:parts[2],a:parts[3],};}},_hex8ColorToRGBA(str){if(str[0]==='#'&&str.length===9){return{r:parseInt(str.slice(1,3),16),g:parseInt(str.slice(3,5),16),b:parseInt(str.slice(5,7),16),a:parseInt(str.slice(7,9),16)/0xff,};}},_hex6ColorToRGBA(str){if(str[0]==='#'&&str.length===7){return{r:parseInt(str.slice(1,3),16),g:parseInt(str.slice(3,5),16),b:parseInt(str.slice(5,7),16),a:1,};}},_hex4ColorToRGBA(str){if(str[0]==='#'&&str.length===5){return{r:parseInt(str[1]+str[1],16),g:parseInt(str[2]+str[2],16),b:parseInt(str[3]+str[3],16),a:parseInt(str[4]+str[4],16)/0xff,};}},_hex3ColorToRGBA(str){if(str[0]==='#'&&str.length===4){return{r:parseInt(str[1]+str[1],16),g:parseInt(str[2]+str[2],16),b:parseInt(str[3]+str[3],16),a:1,};}},_hslColorToRGBA(str){if(/hsl\((\d+),\s*([\d.]+)%,\s*([\d.]+)%\)/g.test(str)){const[_,...hsl]=/hsl\((\d+),\s*([\d.]+)%,\s*([\d.]+)%\)/g.exec(str);const h=Number(hsl[0])/360;const s=Number(hsl[1])/100;const l=Number(hsl[2])/100;let t2;let t3;let val;if(s===0){val=l*255;return{r:Math.round(val),g:Math.round(val),b:Math.round(val),a:1,};}
if(l<0.5){t2=l*(1+s);}
else{t2=l+s-l*s;}
const t1=2*l-t2;const rgb=[0,0,0];for(let i=0;i<3;i++){t3=h+(1/3)*-(i-1);if(t3<0){t3++;}
if(t3>1){t3--;}
if(6*t3<1){val=t1+(t2-t1)*6*t3;}
else if(2*t3<1){val=t2;}
else if(3*t3<2){val=t1+(t2-t1)*(2/3-t3)*6;}
else{val=t1;}
rgb[i]=val*255;}
return{r:Math.round(rgb[0]),g:Math.round(rgb[1]),b:Math.round(rgb[2]),a:1,};}},haveIntersection(r1,r2){return!(r2.x>r1.x+r1.width||r2.x+r2.width<r1.x||r2.y>r1.y+r1.height||r2.y+r2.height<r1.y);},cloneObject(obj){var retObj={};for(var key in obj){if(this._isPlainObject(obj[key])){retObj[key]=this.cloneObject(obj[key]);}
else if(this._isArray(obj[key])){retObj[key]=this.cloneArray(obj[key]);}
else{retObj[key]=obj[key];}}
return retObj;},cloneArray(arr){return arr.slice(0);},degToRad(deg){return deg*PI_OVER_DEG180;},radToDeg(rad){return rad*DEG180_OVER_PI;},_degToRad(deg){Util.warn('Util._degToRad is removed. Please use public Util.degToRad instead.');return Util.degToRad(deg);},_radToDeg(rad){Util.warn('Util._radToDeg is removed. Please use public Util.radToDeg instead.');return Util.radToDeg(rad);},_getRotation(radians){return Konva$2.angleDeg?Util.radToDeg(radians):radians;},_capitalize(str){return str.charAt(0).toUpperCase()+str.slice(1);},throw(str){throw new Error(KONVA_ERROR+str);},error(str){console.error(KONVA_ERROR+str);},warn(str){if(!Konva$2.showWarnings){return;}
console.warn(KONVA_WARNING+str);},each(obj,func){for(var key in obj){func(key,obj[key]);}},_inRange(val,left,right){return left<=val&&val<right;},_getProjectionToSegment(x1,y1,x2,y2,x3,y3){var x,y,dist;var pd2=(x1-x2)*(x1-x2)+(y1-y2)*(y1-y2);if(pd2==0){x=x1;y=y1;dist=(x3-x2)*(x3-x2)+(y3-y2)*(y3-y2);}
else{var u=((x3-x1)*(x2-x1)+(y3-y1)*(y2-y1))/pd2;if(u<0){x=x1;y=y1;dist=(x1-x3)*(x1-x3)+(y1-y3)*(y1-y3);}
else if(u>1.0){x=x2;y=y2;dist=(x2-x3)*(x2-x3)+(y2-y3)*(y2-y3);}
else{x=x1+u*(x2-x1);y=y1+u*(y2-y1);dist=(x-x3)*(x-x3)+(y-y3)*(y-y3);}}
return[x,y,dist];},_getProjectionToLine(pt,line,isClosed){var pc=Util.cloneObject(pt);var dist=Number.MAX_VALUE;line.forEach(function(p1,i){if(!isClosed&&i===line.length-1){return;}
var p2=line[(i+1)%line.length];var proj=Util._getProjectionToSegment(p1.x,p1.y,p2.x,p2.y,pt.x,pt.y);var px=proj[0],py=proj[1],pdist=proj[2];if(pdist<dist){pc.x=px;pc.y=py;dist=pdist;}});return pc;},_prepareArrayForTween(startArray,endArray,isClosed){var n,start=[],end=[];if(startArray.length>endArray.length){var temp=endArray;endArray=startArray;startArray=temp;}
for(n=0;n<startArray.length;n+=2){start.push({x:startArray[n],y:startArray[n+1],});}
for(n=0;n<endArray.length;n+=2){end.push({x:endArray[n],y:endArray[n+1],});}
var newStart=[];end.forEach(function(point){var pr=Util._getProjectionToLine(point,start,isClosed);newStart.push(pr.x);newStart.push(pr.y);});return newStart;},_prepareToStringify(obj){var desc;obj.visitedByCircularReferenceRemoval=true;for(var key in obj){if(!(obj.hasOwnProperty(key)&&obj[key]&&typeof obj[key]=='object')){continue;}
desc=Object.getOwnPropertyDescriptor(obj,key);if(obj[key].visitedByCircularReferenceRemoval||Util._isElement(obj[key])){if(desc.configurable){delete obj[key];}
else{return null;}}
else if(Util._prepareToStringify(obj[key])===null){if(desc.configurable){delete obj[key];}
else{return null;}}}
delete obj.visitedByCircularReferenceRemoval;return obj;},_assign(target,source){for(var key in source){target[key]=source[key];}
return target;},_getFirstPointerId(evt){if(!evt.touches){return evt.pointerId||999;}
else{return evt.changedTouches[0].identifier;}},releaseCanvas(...canvases){if(!Konva$2.releaseCanvasOnDestroy)
return;canvases.forEach((c)=>{c.width=0;c.height=0;});},drawRoundedRectPath(context,width,height,cornerRadius){let topLeft=0;let topRight=0;let bottomLeft=0;let bottomRight=0;if(typeof cornerRadius==='number'){topLeft=topRight=bottomLeft=bottomRight=Math.min(cornerRadius,width/2,height/2);}
else{topLeft=Math.min(cornerRadius[0]||0,width/2,height/2);topRight=Math.min(cornerRadius[1]||0,width/2,height/2);bottomRight=Math.min(cornerRadius[2]||0,width/2,height/2);bottomLeft=Math.min(cornerRadius[3]||0,width/2,height/2);}
context.moveTo(topLeft,0);context.lineTo(width-topRight,0);context.arc(width-topRight,topRight,topRight,(Math.PI*3)/2,0,false);context.lineTo(width,height-bottomRight);context.arc(width-bottomRight,height-bottomRight,bottomRight,0,Math.PI/2,false);context.lineTo(bottomLeft,height);context.arc(bottomLeft,height-bottomLeft,bottomLeft,Math.PI/2,Math.PI,false);context.lineTo(0,topLeft);context.arc(topLeft,topLeft,topLeft,Math.PI,(Math.PI*3)/2,false);},};function _formatValue(val){if(Util._isString(val)){return'"'+val+'"';}
if(Object.prototype.toString.call(val)==='[object Number]'){return val;}
if(Util._isBoolean(val)){return val;}
return Object.prototype.toString.call(val);}
function RGBComponent(val){if(val>255){return 255;}
else if(val<0){return 0;}
return Math.round(val);}
function getNumberValidator(){if(Konva$2.isUnminified){return function(val,attr){if(!Util._isNumber(val)){Util.warn(_formatValue(val)+' is a not valid value for "'+
attr+'" attribute. The value should be a number.');}
return val;};}}
function getNumberOrArrayOfNumbersValidator(noOfElements){if(Konva$2.isUnminified){return function(val,attr){let isNumber=Util._isNumber(val);let isValidArray=Util._isArray(val)&&val.length==noOfElements;if(!isNumber&&!isValidArray){Util.warn(_formatValue(val)+' is a not valid value for "'+
attr+'" attribute. The value should be a number or Array<number>('+
noOfElements+')');}
return val;};}}
function getNumberOrAutoValidator(){if(Konva$2.isUnminified){return function(val,attr){var isNumber=Util._isNumber(val);var isAuto=val==='auto';if(!(isNumber||isAuto)){Util.warn(_formatValue(val)+' is a not valid value for "'+
attr+'" attribute. The value should be a number or "auto".');}
return val;};}}
function getStringValidator(){if(Konva$2.isUnminified){return function(val,attr){if(!Util._isString(val)){Util.warn(_formatValue(val)+' is a not valid value for "'+
attr+'" attribute. The value should be a string.');}
return val;};}}
function getStringOrGradientValidator(){if(Konva$2.isUnminified){return function(val,attr){const isString=Util._isString(val);const isGradient=Object.prototype.toString.call(val)==='[object CanvasGradient]'||(val&&val.addColorStop);if(!(isString||isGradient)){Util.warn(_formatValue(val)+' is a not valid value for "'+
attr+'" attribute. The value should be a string or a native gradient.');}
return val;};}}
function getNumberArrayValidator(){if(Konva$2.isUnminified){return function(val,attr){const TypedArray=Int8Array?Object.getPrototypeOf(Int8Array):null;if(TypedArray&&val instanceof TypedArray){return val;}
if(!Util._isArray(val)){Util.warn(_formatValue(val)+' is a not valid value for "'+
attr+'" attribute. The value should be a array of numbers.');}
else{val.forEach(function(item){if(!Util._isNumber(item)){Util.warn('"'+
attr+'" attribute has non numeric element '+
item+'. Make sure that all elements are numbers.');}});}
return val;};}}
function getBooleanValidator(){if(Konva$2.isUnminified){return function(val,attr){var isBool=val===true||val===false;if(!isBool){Util.warn(_formatValue(val)+' is a not valid value for "'+
attr+'" attribute. The value should be a boolean.');}
return val;};}}
function getComponentValidator(components){if(Konva$2.isUnminified){return function(val,attr){if(val===undefined||val===null){return val;}
if(!Util.isObject(val)){Util.warn(_formatValue(val)+' is a not valid value for "'+
attr+'" attribute. The value should be an object with properties '+
components);}
return val;};}}
var GET='get',SET$1='set';const Factory={addGetterSetter(constructor,attr,def,validator,after){Factory.addGetter(constructor,attr,def);Factory.addSetter(constructor,attr,validator,after);Factory.addOverloadedGetterSetter(constructor,attr);},addGetter(constructor,attr,def){var method=GET+Util._capitalize(attr);constructor.prototype[method]=constructor.prototype[method]||function(){var val=this.attrs[attr];return val===undefined?def:val;};},addSetter(constructor,attr,validator,after){var method=SET$1+Util._capitalize(attr);if(!constructor.prototype[method]){Factory.overWriteSetter(constructor,attr,validator,after);}},overWriteSetter(constructor,attr,validator,after){var method=SET$1+Util._capitalize(attr);constructor.prototype[method]=function(val){if(validator&&val!==undefined&&val!==null){val=validator.call(this,val,attr);}
this._setAttr(attr,val);if(after){after.call(this);}
return this;};},addComponentsGetterSetter(constructor,attr,components,validator,after){var len=components.length,capitalize=Util._capitalize,getter=GET+capitalize(attr),setter=SET$1+capitalize(attr),n,component;constructor.prototype[getter]=function(){var ret={};for(n=0;n<len;n++){component=components[n];ret[component]=this.getAttr(attr+capitalize(component));}
return ret;};var basicValidator=getComponentValidator(components);constructor.prototype[setter]=function(val){var oldVal=this.attrs[attr],key;if(validator){val=validator.call(this,val);}
if(basicValidator){basicValidator.call(this,val,attr);}
for(key in val){if(!val.hasOwnProperty(key)){continue;}
this._setAttr(attr+capitalize(key),val[key]);}
if(!val){components.forEach((component)=>{this._setAttr(attr+capitalize(component),undefined);});}
this._fireChangeEvent(attr,oldVal,val);if(after){after.call(this);}
return this;};Factory.addOverloadedGetterSetter(constructor,attr);},addOverloadedGetterSetter(constructor,attr){var capitalizedAttr=Util._capitalize(attr),setter=SET$1+capitalizedAttr,getter=GET+capitalizedAttr;constructor.prototype[attr]=function(){if(arguments.length){this[setter](arguments[0]);return this;}
return this[getter]();};},addDeprecatedGetterSetter(constructor,attr,def,validator){Util.error('Adding deprecated '+attr);var method=GET+Util._capitalize(attr);var message=attr+' property is deprecated and will be removed soon. Look at Konva change log for more information.';constructor.prototype[method]=function(){Util.error(message);var val=this.attrs[attr];return val===undefined?def:val;};Factory.addSetter(constructor,attr,validator,function(){Util.error(message);});Factory.addOverloadedGetterSetter(constructor,attr);},backCompat(constructor,methods){Util.each(methods,function(oldMethodName,newMethodName){var method=constructor.prototype[newMethodName];var oldGetter=GET+Util._capitalize(oldMethodName);var oldSetter=SET$1+Util._capitalize(oldMethodName);function deprecated(){method.apply(this,arguments);Util.error('"'+
oldMethodName+'" method is deprecated and will be removed soon. Use ""'+
newMethodName+'" instead.');}
constructor.prototype[oldMethodName]=deprecated;constructor.prototype[oldGetter]=deprecated;constructor.prototype[oldSetter]=deprecated;});},afterSetFilter(){this._filterUpToDate=false;},};function simplifyArray(arr){var retArr=[],len=arr.length,util=Util,n,val;for(n=0;n<len;n++){val=arr[n];if(util._isNumber(val)){val=Math.round(val*1000)/1000;}
else if(!util._isString(val)){val=val+'';}
retArr.push(val);}
return retArr;}
var COMMA=',',OPEN_PAREN='(',CLOSE_PAREN=')',OPEN_PAREN_BRACKET='([',CLOSE_BRACKET_PAREN='])',SEMICOLON=';',DOUBLE_PAREN='()',EQUALS='=',CONTEXT_METHODS=['arc','arcTo','beginPath','bezierCurveTo','clearRect','clip','closePath','createLinearGradient','createPattern','createRadialGradient','drawImage','ellipse','fill','fillText','getImageData','createImageData','lineTo','moveTo','putImageData','quadraticCurveTo','rect','roundRect','restore','rotate','save','scale','setLineDash','setTransform','stroke','strokeText','transform','translate',];var CONTEXT_PROPERTIES=['fillStyle','strokeStyle','shadowColor','shadowBlur','shadowOffsetX','shadowOffsetY','letterSpacing','lineCap','lineDashOffset','lineJoin','lineWidth','miterLimit','direction','font','textAlign','textBaseline','globalAlpha','globalCompositeOperation','imageSmoothingEnabled',];const traceArrMax=100;class Context{constructor(canvas){this.canvas=canvas;if(Konva$2.enableTrace){this.traceArr=[];this._enableTrace();}}
fillShape(shape){if(shape.fillEnabled()){this._fill(shape);}}
_fill(shape){}
strokeShape(shape){if(shape.hasStroke()){this._stroke(shape);}}
_stroke(shape){}
fillStrokeShape(shape){if(shape.attrs.fillAfterStrokeEnabled){this.strokeShape(shape);this.fillShape(shape);}
else{this.fillShape(shape);this.strokeShape(shape);}}
getTrace(relaxed,rounded){var traceArr=this.traceArr,len=traceArr.length,str='',n,trace,method,args;for(n=0;n<len;n++){trace=traceArr[n];method=trace.method;if(method){args=trace.args;str+=method;if(relaxed){str+=DOUBLE_PAREN;}
else{if(Util._isArray(args[0])){str+=OPEN_PAREN_BRACKET+args.join(COMMA)+CLOSE_BRACKET_PAREN;}
else{if(rounded){args=args.map((a)=>typeof a==='number'?Math.floor(a):a);}
str+=OPEN_PAREN+args.join(COMMA)+CLOSE_PAREN;}}}
else{str+=trace.property;if(!relaxed){str+=EQUALS+trace.val;}}
str+=SEMICOLON;}
return str;}
clearTrace(){this.traceArr=[];}
_trace(str){var traceArr=this.traceArr,len;traceArr.push(str);len=traceArr.length;if(len>=traceArrMax){traceArr.shift();}}
reset(){var pixelRatio=this.getCanvas().getPixelRatio();this.setTransform(1*pixelRatio,0,0,1*pixelRatio,0,0);}
getCanvas(){return this.canvas;}
clear(bounds){var canvas=this.getCanvas();if(bounds){this.clearRect(bounds.x||0,bounds.y||0,bounds.width||0,bounds.height||0);}
else{this.clearRect(0,0,canvas.getWidth()/canvas.pixelRatio,canvas.getHeight()/canvas.pixelRatio);}}
_applyLineCap(shape){const lineCap=shape.attrs.lineCap;if(lineCap){this.setAttr('lineCap',lineCap);}}
_applyOpacity(shape){var absOpacity=shape.getAbsoluteOpacity();if(absOpacity!==1){this.setAttr('globalAlpha',absOpacity);}}
_applyLineJoin(shape){const lineJoin=shape.attrs.lineJoin;if(lineJoin){this.setAttr('lineJoin',lineJoin);}}
setAttr(attr,val){this._context[attr]=val;}
arc(x,y,radius,startAngle,endAngle,counterClockwise){this._context.arc(x,y,radius,startAngle,endAngle,counterClockwise);}
arcTo(x1,y1,x2,y2,radius){this._context.arcTo(x1,y1,x2,y2,radius);}
beginPath(){this._context.beginPath();}
bezierCurveTo(cp1x,cp1y,cp2x,cp2y,x,y){this._context.bezierCurveTo(cp1x,cp1y,cp2x,cp2y,x,y);}
clearRect(x,y,width,height){this._context.clearRect(x,y,width,height);}
clip(...args){this._context.clip.apply(this._context,args);}
closePath(){this._context.closePath();}
createImageData(width,height){var a=arguments;if(a.length===2){return this._context.createImageData(width,height);}
else if(a.length===1){return this._context.createImageData(width);}}
createLinearGradient(x0,y0,x1,y1){return this._context.createLinearGradient(x0,y0,x1,y1);}
createPattern(image,repetition){return this._context.createPattern(image,repetition);}
createRadialGradient(x0,y0,r0,x1,y1,r1){return this._context.createRadialGradient(x0,y0,r0,x1,y1,r1);}
drawImage(image,sx,sy,sWidth,sHeight,dx,dy,dWidth,dHeight){var a=arguments,_context=this._context;if(a.length===3){_context.drawImage(image,sx,sy);}
else if(a.length===5){_context.drawImage(image,sx,sy,sWidth,sHeight);}
else if(a.length===9){_context.drawImage(image,sx,sy,sWidth,sHeight,dx,dy,dWidth,dHeight);}}
ellipse(x,y,radiusX,radiusY,rotation,startAngle,endAngle,counterclockwise){this._context.ellipse(x,y,radiusX,radiusY,rotation,startAngle,endAngle,counterclockwise);}
isPointInPath(x,y,path,fillRule){if(path){return this._context.isPointInPath(path,x,y,fillRule);}
return this._context.isPointInPath(x,y,fillRule);}
fill(...args){this._context.fill.apply(this._context,args);}
fillRect(x,y,width,height){this._context.fillRect(x,y,width,height);}
strokeRect(x,y,width,height){this._context.strokeRect(x,y,width,height);}
fillText(text,x,y,maxWidth){if(maxWidth){this._context.fillText(text,x,y,maxWidth);}
else{this._context.fillText(text,x,y);}}
measureText(text){return this._context.measureText(text);}
getImageData(sx,sy,sw,sh){return this._context.getImageData(sx,sy,sw,sh);}
lineTo(x,y){this._context.lineTo(x,y);}
moveTo(x,y){this._context.moveTo(x,y);}
rect(x,y,width,height){this._context.rect(x,y,width,height);}
roundRect(x,y,width,height,radii){this._context.roundRect(x,y,width,height,radii);}
putImageData(imageData,dx,dy){this._context.putImageData(imageData,dx,dy);}
quadraticCurveTo(cpx,cpy,x,y){this._context.quadraticCurveTo(cpx,cpy,x,y);}
restore(){this._context.restore();}
rotate(angle){this._context.rotate(angle);}
save(){this._context.save();}
scale(x,y){this._context.scale(x,y);}
setLineDash(segments){if(this._context.setLineDash){this._context.setLineDash(segments);}
else if('mozDash'in this._context){this._context['mozDash']=segments;}
else if('webkitLineDash'in this._context){this._context['webkitLineDash']=segments;}}
getLineDash(){return this._context.getLineDash();}
setTransform(a,b,c,d,e,f){this._context.setTransform(a,b,c,d,e,f);}
stroke(path2d){if(path2d){this._context.stroke(path2d);}
else{this._context.stroke();}}
strokeText(text,x,y,maxWidth){this._context.strokeText(text,x,y,maxWidth);}
transform(a,b,c,d,e,f){this._context.transform(a,b,c,d,e,f);}
translate(x,y){this._context.translate(x,y);}
_enableTrace(){var that=this,len=CONTEXT_METHODS.length,origSetter=this.setAttr,n,args;var func=function(methodName){var origMethod=that[methodName],ret;that[methodName]=function(){args=simplifyArray(Array.prototype.slice.call(arguments,0));ret=origMethod.apply(that,arguments);that._trace({method:methodName,args:args,});return ret;};};for(n=0;n<len;n++){func(CONTEXT_METHODS[n]);}
that.setAttr=function(){origSetter.apply(that,arguments);var prop=arguments[0];var val=arguments[1];if(prop==='shadowOffsetX'||prop==='shadowOffsetY'||prop==='shadowBlur'){val=val/this.canvas.getPixelRatio();}
that._trace({property:prop,val:val,});};}
_applyGlobalCompositeOperation(node){const op=node.attrs.globalCompositeOperation;var def=!op||op==='source-over';if(!def){this.setAttr('globalCompositeOperation',op);}}}
CONTEXT_PROPERTIES.forEach(function(prop){Object.defineProperty(Context.prototype,prop,{get(){return this._context[prop];},set(val){this._context[prop]=val;},});});class SceneContext extends Context{constructor(canvas,{willReadFrequently=false}={}){super(canvas);this._context=canvas._canvas.getContext('2d',{willReadFrequently,});}
_fillColor(shape){var fill=shape.fill();this.setAttr('fillStyle',fill);shape._fillFunc(this);}
_fillPattern(shape){this.setAttr('fillStyle',shape._getFillPattern());shape._fillFunc(this);}
_fillLinearGradient(shape){var grd=shape._getLinearGradient();if(grd){this.setAttr('fillStyle',grd);shape._fillFunc(this);}}
_fillRadialGradient(shape){const grd=shape._getRadialGradient();if(grd){this.setAttr('fillStyle',grd);shape._fillFunc(this);}}
_fill(shape){const hasColor=shape.fill(),fillPriority=shape.getFillPriority();if(hasColor&&fillPriority==='color'){this._fillColor(shape);return;}
const hasPattern=shape.getFillPatternImage();if(hasPattern&&fillPriority==='pattern'){this._fillPattern(shape);return;}
const hasLinearGradient=shape.getFillLinearGradientColorStops();if(hasLinearGradient&&fillPriority==='linear-gradient'){this._fillLinearGradient(shape);return;}
const hasRadialGradient=shape.getFillRadialGradientColorStops();if(hasRadialGradient&&fillPriority==='radial-gradient'){this._fillRadialGradient(shape);return;}
if(hasColor){this._fillColor(shape);}
else if(hasPattern){this._fillPattern(shape);}
else if(hasLinearGradient){this._fillLinearGradient(shape);}
else if(hasRadialGradient){this._fillRadialGradient(shape);}}
_strokeLinearGradient(shape){const start=shape.getStrokeLinearGradientStartPoint(),end=shape.getStrokeLinearGradientEndPoint(),colorStops=shape.getStrokeLinearGradientColorStops(),grd=this.createLinearGradient(start.x,start.y,end.x,end.y);if(colorStops){for(var n=0;n<colorStops.length;n+=2){grd.addColorStop(colorStops[n],colorStops[n+1]);}
this.setAttr('strokeStyle',grd);}}
_stroke(shape){var dash=shape.dash(),strokeScaleEnabled=shape.getStrokeScaleEnabled();if(shape.hasStroke()){if(!strokeScaleEnabled){this.save();var pixelRatio=this.getCanvas().getPixelRatio();this.setTransform(pixelRatio,0,0,pixelRatio,0,0);}
this._applyLineCap(shape);if(dash&&shape.dashEnabled()){this.setLineDash(dash);this.setAttr('lineDashOffset',shape.dashOffset());}
this.setAttr('lineWidth',shape.strokeWidth());if(!shape.getShadowForStrokeEnabled()){this.setAttr('shadowColor','rgba(0,0,0,0)');}
var hasLinearGradient=shape.getStrokeLinearGradientColorStops();if(hasLinearGradient){this._strokeLinearGradient(shape);}
else{this.setAttr('strokeStyle',shape.stroke());}
shape._strokeFunc(this);if(!strokeScaleEnabled){this.restore();}}}
_applyShadow(shape){var _a,_b,_c;var color=(_a=shape.getShadowRGBA())!==null&&_a!==void 0?_a:'black',blur=(_b=shape.getShadowBlur())!==null&&_b!==void 0?_b:5,offset=(_c=shape.getShadowOffset())!==null&&_c!==void 0?_c:{x:0,y:0,},scale=shape.getAbsoluteScale(),ratio=this.canvas.getPixelRatio(),scaleX=scale.x*ratio,scaleY=scale.y*ratio;this.setAttr('shadowColor',color);this.setAttr('shadowBlur',blur*Math.min(Math.abs(scaleX),Math.abs(scaleY)));this.setAttr('shadowOffsetX',offset.x*scaleX);this.setAttr('shadowOffsetY',offset.y*scaleY);}}
class HitContext extends Context{constructor(canvas){super(canvas);this._context=canvas._canvas.getContext('2d',{willReadFrequently:true,});}
_fill(shape){this.save();this.setAttr('fillStyle',shape.colorKey);shape._fillFuncHit(this);this.restore();}
strokeShape(shape){if(shape.hasHitStroke()){this._stroke(shape);}}
_stroke(shape){if(shape.hasHitStroke()){const strokeScaleEnabled=shape.getStrokeScaleEnabled();if(!strokeScaleEnabled){this.save();var pixelRatio=this.getCanvas().getPixelRatio();this.setTransform(pixelRatio,0,0,pixelRatio,0,0);}
this._applyLineCap(shape);var hitStrokeWidth=shape.hitStrokeWidth();var strokeWidth=hitStrokeWidth==='auto'?shape.strokeWidth():hitStrokeWidth;this.setAttr('lineWidth',strokeWidth);this.setAttr('strokeStyle',shape.colorKey);shape._strokeFuncHit(this);if(!strokeScaleEnabled){this.restore();}}}}
var _pixelRatio;function getDevicePixelRatio(){if(_pixelRatio){return _pixelRatio;}
var canvas=Util.createCanvasElement();var context=canvas.getContext('2d');_pixelRatio=(function(){var devicePixelRatio=Konva$2._global.devicePixelRatio||1,backingStoreRatio=context.webkitBackingStorePixelRatio||context.mozBackingStorePixelRatio||context.msBackingStorePixelRatio||context.oBackingStorePixelRatio||context.backingStorePixelRatio||1;return devicePixelRatio/backingStoreRatio;})();Util.releaseCanvas(canvas);return _pixelRatio;}
class Canvas{constructor(config){this.pixelRatio=1;this.width=0;this.height=0;this.isCache=false;var conf=config||{};var pixelRatio=conf.pixelRatio||Konva$2.pixelRatio||getDevicePixelRatio();this.pixelRatio=pixelRatio;this._canvas=Util.createCanvasElement();this._canvas.style.padding='0';this._canvas.style.margin='0';this._canvas.style.border='0';this._canvas.style.background='transparent';this._canvas.style.position='absolute';this._canvas.style.top='0';this._canvas.style.left='0';}
getContext(){return this.context;}
getPixelRatio(){return this.pixelRatio;}
setPixelRatio(pixelRatio){var previousRatio=this.pixelRatio;this.pixelRatio=pixelRatio;this.setSize(this.getWidth()/previousRatio,this.getHeight()/previousRatio);}
setWidth(width){this.width=this._canvas.width=width*this.pixelRatio;this._canvas.style.width=width+'px';var pixelRatio=this.pixelRatio,_context=this.getContext()._context;_context.scale(pixelRatio,pixelRatio);}
setHeight(height){this.height=this._canvas.height=height*this.pixelRatio;this._canvas.style.height=height+'px';var pixelRatio=this.pixelRatio,_context=this.getContext()._context;_context.scale(pixelRatio,pixelRatio);}
getWidth(){return this.width;}
getHeight(){return this.height;}
setSize(width,height){this.setWidth(width||0);this.setHeight(height||0);}
toDataURL(mimeType,quality){try{return this._canvas.toDataURL(mimeType,quality);}
catch(e){try{return this._canvas.toDataURL();}
catch(err){Util.error('Unable to get data URL. '+
err.message+' For more info read https://konvajs.org/docs/posts/Tainted_Canvas.html.');return'';}}}}
Factory.addGetterSetter(Canvas,'pixelRatio',undefined,getNumberValidator());class SceneCanvas extends Canvas{constructor(config={width:0,height:0,willReadFrequently:false}){super(config);this.context=new SceneContext(this,{willReadFrequently:config.willReadFrequently,});this.setSize(config.width,config.height);}}
class HitCanvas extends Canvas{constructor(config={width:0,height:0}){super(config);this.hitCanvas=true;this.context=new HitContext(this);this.setSize(config.width,config.height);}}
const DD={get isDragging(){var flag=false;DD._dragElements.forEach((elem)=>{if(elem.dragStatus==='dragging'){flag=true;}});return flag;},justDragged:false,get node(){var node;DD._dragElements.forEach((elem)=>{node=elem.node;});return node;},_dragElements:new Map(),_drag(evt){const nodesToFireEvents=[];DD._dragElements.forEach((elem,key)=>{const{node}=elem;const stage=node.getStage();stage.setPointersPositions(evt);if(elem.pointerId===undefined){elem.pointerId=Util._getFirstPointerId(evt);}
const pos=stage._changedPointerPositions.find((pos)=>pos.id===elem.pointerId);if(!pos){return;}
if(elem.dragStatus!=='dragging'){var dragDistance=node.dragDistance();var distance=Math.max(Math.abs(pos.x-elem.startPointerPos.x),Math.abs(pos.y-elem.startPointerPos.y));if(distance<dragDistance){return;}
node.startDrag({evt});if(!node.isDragging()){return;}}
node._setDragPosition(evt,elem);nodesToFireEvents.push(node);});nodesToFireEvents.forEach((node)=>{node.fire('dragmove',{type:'dragmove',target:node,evt:evt,},true);});},_endDragBefore(evt){const drawNodes=[];DD._dragElements.forEach((elem)=>{const{node}=elem;const stage=node.getStage();if(evt){stage.setPointersPositions(evt);}
const pos=stage._changedPointerPositions.find((pos)=>pos.id===elem.pointerId);if(!pos){return;}
if(elem.dragStatus==='dragging'||elem.dragStatus==='stopped'){DD.justDragged=true;Konva$2._mouseListenClick=false;Konva$2._touchListenClick=false;Konva$2._pointerListenClick=false;elem.dragStatus='stopped';}
const drawNode=elem.node.getLayer()||(elem.node instanceof Konva$2['Stage']&&elem.node);if(drawNode&&drawNodes.indexOf(drawNode)===-1){drawNodes.push(drawNode);}});drawNodes.forEach((drawNode)=>{drawNode.draw();});},_endDragAfter(evt){DD._dragElements.forEach((elem,key)=>{if(elem.dragStatus==='stopped'){elem.node.fire('dragend',{type:'dragend',target:elem.node,evt:evt,},true);}
if(elem.dragStatus!=='dragging'){DD._dragElements.delete(key);}});},};if(Konva$2.isBrowser){window.addEventListener('mouseup',DD._endDragBefore,true);window.addEventListener('touchend',DD._endDragBefore,true);window.addEventListener('mousemove',DD._drag);window.addEventListener('touchmove',DD._drag);window.addEventListener('mouseup',DD._endDragAfter,false);window.addEventListener('touchend',DD._endDragAfter,false);}
var ABSOLUTE_OPACITY='absoluteOpacity',ALL_LISTENERS='allEventListeners',ABSOLUTE_TRANSFORM='absoluteTransform',ABSOLUTE_SCALE='absoluteScale',CANVAS='canvas',CHANGE='Change',CHILDREN='children',KONVA='konva',LISTENING='listening',MOUSEENTER$1='mouseenter',MOUSELEAVE$1='mouseleave',SET='set',SHAPE='Shape',SPACE$1=' ',STAGE$1='stage',TRANSFORM='transform',UPPER_STAGE='Stage',VISIBLE='visible',TRANSFORM_CHANGE_STR$1=['xChange.konva','yChange.konva','scaleXChange.konva','scaleYChange.konva','skewXChange.konva','skewYChange.konva','rotationChange.konva','offsetXChange.konva','offsetYChange.konva','transformsEnabledChange.konva',].join(SPACE$1);let idCounter$1=1;class Node{constructor(config){this._id=idCounter$1++;this.eventListeners={};this.attrs={};this.index=0;this._allEventListeners=null;this.parent=null;this._cache=new Map();this._attachedDepsListeners=new Map();this._lastPos=null;this._batchingTransformChange=false;this._needClearTransformCache=false;this._filterUpToDate=false;this._isUnderCache=false;this._dragEventId=null;this._shouldFireChangeEvents=false;this.setAttrs(config);this._shouldFireChangeEvents=true;}
hasChildren(){return false;}
_clearCache(attr){if((attr===TRANSFORM||attr===ABSOLUTE_TRANSFORM)&&this._cache.get(attr)){this._cache.get(attr).dirty=true;}
else if(attr){this._cache.delete(attr);}
else{this._cache.clear();}}
_getCache(attr,privateGetter){var cache=this._cache.get(attr);var isTransform=attr===TRANSFORM||attr===ABSOLUTE_TRANSFORM;var invalid=cache===undefined||(isTransform&&cache.dirty===true);if(invalid){cache=privateGetter.call(this);this._cache.set(attr,cache);}
return cache;}
_calculate(name,deps,getter){if(!this._attachedDepsListeners.get(name)){const depsString=deps.map((dep)=>dep+'Change.konva').join(SPACE$1);this.on(depsString,()=>{this._clearCache(name);});this._attachedDepsListeners.set(name,true);}
return this._getCache(name,getter);}
_getCanvasCache(){return this._cache.get(CANVAS);}
_clearSelfAndDescendantCache(attr){this._clearCache(attr);if(attr===ABSOLUTE_TRANSFORM){this.fire('absoluteTransformChange');}}
clearCache(){if(this._cache.has(CANVAS)){const{scene,filter,hit}=this._cache.get(CANVAS);Util.releaseCanvas(scene,filter,hit);this._cache.delete(CANVAS);}
this._clearSelfAndDescendantCache();this._requestDraw();return this;}
cache(config){var conf=config||{};var rect={};if(conf.x===undefined||conf.y===undefined||conf.width===undefined||conf.height===undefined){rect=this.getClientRect({skipTransform:true,relativeTo:this.getParent()||undefined,});}
var width=Math.ceil(conf.width||rect.width),height=Math.ceil(conf.height||rect.height),pixelRatio=conf.pixelRatio,x=conf.x===undefined?Math.floor(rect.x):conf.x,y=conf.y===undefined?Math.floor(rect.y):conf.y,offset=conf.offset||0,drawBorder=conf.drawBorder||false,hitCanvasPixelRatio=conf.hitCanvasPixelRatio||1;if(!width||!height){Util.error('Can not cache the node. Width or height of the node equals 0. Caching is skipped.');return;}
const extraPaddingX=Math.abs(Math.round(rect.x)-x)>0.5?1:0;const extraPaddingY=Math.abs(Math.round(rect.y)-y)>0.5?1:0;width+=offset*2+extraPaddingX;height+=offset*2+extraPaddingY;x-=offset;y-=offset;var cachedSceneCanvas=new SceneCanvas({pixelRatio:pixelRatio,width:width,height:height,}),cachedFilterCanvas=new SceneCanvas({pixelRatio:pixelRatio,width:0,height:0,willReadFrequently:true,}),cachedHitCanvas=new HitCanvas({pixelRatio:hitCanvasPixelRatio,width:width,height:height,}),sceneContext=cachedSceneCanvas.getContext(),hitContext=cachedHitCanvas.getContext();cachedHitCanvas.isCache=true;cachedSceneCanvas.isCache=true;this._cache.delete(CANVAS);this._filterUpToDate=false;if(conf.imageSmoothingEnabled===false){cachedSceneCanvas.getContext()._context.imageSmoothingEnabled=false;cachedFilterCanvas.getContext()._context.imageSmoothingEnabled=false;}
sceneContext.save();hitContext.save();sceneContext.translate(-x,-y);hitContext.translate(-x,-y);this._isUnderCache=true;this._clearSelfAndDescendantCache(ABSOLUTE_OPACITY);this._clearSelfAndDescendantCache(ABSOLUTE_SCALE);this.drawScene(cachedSceneCanvas,this);this.drawHit(cachedHitCanvas,this);this._isUnderCache=false;sceneContext.restore();hitContext.restore();if(drawBorder){sceneContext.save();sceneContext.beginPath();sceneContext.rect(0,0,width,height);sceneContext.closePath();sceneContext.setAttr('strokeStyle','red');sceneContext.setAttr('lineWidth',5);sceneContext.stroke();sceneContext.restore();}
this._cache.set(CANVAS,{scene:cachedSceneCanvas,filter:cachedFilterCanvas,hit:cachedHitCanvas,x:x,y:y,});this._requestDraw();return this;}
isCached(){return this._cache.has(CANVAS);}
getClientRect(config){throw new Error('abstract "getClientRect" method call');}
_transformedRect(rect,top){var points=[{x:rect.x,y:rect.y},{x:rect.x+rect.width,y:rect.y},{x:rect.x+rect.width,y:rect.y+rect.height},{x:rect.x,y:rect.y+rect.height},];var minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;var trans=this.getAbsoluteTransform(top);points.forEach(function(point){var transformed=trans.point(point);if(minX===undefined){minX=maxX=transformed.x;minY=maxY=transformed.y;}
minX=Math.min(minX,transformed.x);minY=Math.min(minY,transformed.y);maxX=Math.max(maxX,transformed.x);maxY=Math.max(maxY,transformed.y);});return{x:minX,y:minY,width:maxX-minX,height:maxY-minY,};}
_drawCachedSceneCanvas(context){context.save();context._applyOpacity(this);context._applyGlobalCompositeOperation(this);const canvasCache=this._getCanvasCache();context.translate(canvasCache.x,canvasCache.y);var cacheCanvas=this._getCachedSceneCanvas();var ratio=cacheCanvas.pixelRatio;context.drawImage(cacheCanvas._canvas,0,0,cacheCanvas.width/ratio,cacheCanvas.height/ratio);context.restore();}
_drawCachedHitCanvas(context){var canvasCache=this._getCanvasCache(),hitCanvas=canvasCache.hit;context.save();context.translate(canvasCache.x,canvasCache.y);context.drawImage(hitCanvas._canvas,0,0,hitCanvas.width/hitCanvas.pixelRatio,hitCanvas.height/hitCanvas.pixelRatio);context.restore();}
_getCachedSceneCanvas(){var filters=this.filters(),cachedCanvas=this._getCanvasCache(),sceneCanvas=cachedCanvas.scene,filterCanvas=cachedCanvas.filter,filterContext=filterCanvas.getContext(),len,imageData,n,filter;if(filters){if(!this._filterUpToDate){var ratio=sceneCanvas.pixelRatio;filterCanvas.setSize(sceneCanvas.width/sceneCanvas.pixelRatio,sceneCanvas.height/sceneCanvas.pixelRatio);try{len=filters.length;filterContext.clear();filterContext.drawImage(sceneCanvas._canvas,0,0,sceneCanvas.getWidth()/ratio,sceneCanvas.getHeight()/ratio);imageData=filterContext.getImageData(0,0,filterCanvas.getWidth(),filterCanvas.getHeight());for(n=0;n<len;n++){filter=filters[n];if(typeof filter!=='function'){Util.error('Filter should be type of function, but got '+
typeof filter+' instead. Please check correct filters');continue;}
filter.call(this,imageData);filterContext.putImageData(imageData,0,0);}}
catch(e){Util.error('Unable to apply filter. '+
e.message+' This post my help you https://konvajs.org/docs/posts/Tainted_Canvas.html.');}
this._filterUpToDate=true;}
return filterCanvas;}
return sceneCanvas;}
on(evtStr,handler){this._cache&&this._cache.delete(ALL_LISTENERS);if(arguments.length===3){return this._delegate.apply(this,arguments);}
var events=evtStr.split(SPACE$1),len=events.length,n,event,parts,baseEvent,name;for(n=0;n<len;n++){event=events[n];parts=event.split('.');baseEvent=parts[0];name=parts[1]||'';if(!this.eventListeners[baseEvent]){this.eventListeners[baseEvent]=[];}
this.eventListeners[baseEvent].push({name:name,handler:handler,});}
return this;}
off(evtStr,callback){var events=(evtStr||'').split(SPACE$1),len=events.length,n,t,event,parts,baseEvent,name;this._cache&&this._cache.delete(ALL_LISTENERS);if(!evtStr){for(t in this.eventListeners){this._off(t);}}
for(n=0;n<len;n++){event=events[n];parts=event.split('.');baseEvent=parts[0];name=parts[1];if(baseEvent){if(this.eventListeners[baseEvent]){this._off(baseEvent,name,callback);}}
else{for(t in this.eventListeners){this._off(t,name,callback);}}}
return this;}
dispatchEvent(evt){var e={target:this,type:evt.type,evt:evt,};this.fire(evt.type,e);return this;}
addEventListener(type,handler){this.on(type,function(evt){handler.call(this,evt.evt);});return this;}
removeEventListener(type){this.off(type);return this;}
_delegate(event,selector,handler){var stopNode=this;this.on(event,function(evt){var targets=evt.target.findAncestors(selector,true,stopNode);for(var i=0;i<targets.length;i++){evt=Util.cloneObject(evt);evt.currentTarget=targets[i];handler.call(targets[i],evt);}});}
remove(){if(this.isDragging()){this.stopDrag();}
DD._dragElements.delete(this._id);this._remove();return this;}
_clearCaches(){this._clearSelfAndDescendantCache(ABSOLUTE_TRANSFORM);this._clearSelfAndDescendantCache(ABSOLUTE_OPACITY);this._clearSelfAndDescendantCache(ABSOLUTE_SCALE);this._clearSelfAndDescendantCache(STAGE$1);this._clearSelfAndDescendantCache(VISIBLE);this._clearSelfAndDescendantCache(LISTENING);}
_remove(){this._clearCaches();var parent=this.getParent();if(parent&&parent.children){parent.children.splice(this.index,1);parent._setChildrenIndices();this.parent=null;}}
destroy(){this.remove();this.clearCache();return this;}
getAttr(attr){var method='get'+Util._capitalize(attr);if(Util._isFunction(this[method])){return this[method]();}
return this.attrs[attr];}
getAncestors(){var parent=this.getParent(),ancestors=[];while(parent){ancestors.push(parent);parent=parent.getParent();}
return ancestors;}
getAttrs(){return(this.attrs||{});}
setAttrs(config){this._batchTransformChanges(()=>{var key,method;if(!config){return this;}
for(key in config){if(key===CHILDREN){continue;}
method=SET+Util._capitalize(key);if(Util._isFunction(this[method])){this[method](config[key]);}
else{this._setAttr(key,config[key]);}}});return this;}
isListening(){return this._getCache(LISTENING,this._isListening);}
_isListening(relativeTo){const listening=this.listening();if(!listening){return false;}
const parent=this.getParent();if(parent&&parent!==relativeTo&&this!==relativeTo){return parent._isListening(relativeTo);}
else{return true;}}
isVisible(){return this._getCache(VISIBLE,this._isVisible);}
_isVisible(relativeTo){const visible=this.visible();if(!visible){return false;}
const parent=this.getParent();if(parent&&parent!==relativeTo&&this!==relativeTo){return parent._isVisible(relativeTo);}
else{return true;}}
shouldDrawHit(top,skipDragCheck=false){if(top){return this._isVisible(top)&&this._isListening(top);}
var layer=this.getLayer();var layerUnderDrag=false;DD._dragElements.forEach((elem)=>{if(elem.dragStatus!=='dragging'){return;}
else if(elem.node.nodeType==='Stage'){layerUnderDrag=true;}
else if(elem.node.getLayer()===layer){layerUnderDrag=true;}});var dragSkip=!skipDragCheck&&!Konva$2.hitOnDragEnabled&&(layerUnderDrag||Konva$2.isTransforming());return this.isListening()&&this.isVisible()&&!dragSkip;}
show(){this.visible(true);return this;}
hide(){this.visible(false);return this;}
getZIndex(){return this.index||0;}
getAbsoluteZIndex(){var depth=this.getDepth(),that=this,index=0,nodes,len,n,child;function addChildren(children){nodes=[];len=children.length;for(n=0;n<len;n++){child=children[n];index++;if(child.nodeType!==SHAPE){nodes=nodes.concat(child.getChildren().slice());}
if(child._id===that._id){n=len;}}
if(nodes.length>0&&nodes[0].getDepth()<=depth){addChildren(nodes);}}
const stage=this.getStage();if(that.nodeType!==UPPER_STAGE&&stage){addChildren(stage.getChildren());}
return index;}
getDepth(){var depth=0,parent=this.parent;while(parent){depth++;parent=parent.parent;}
return depth;}
_batchTransformChanges(func){this._batchingTransformChange=true;func();this._batchingTransformChange=false;if(this._needClearTransformCache){this._clearCache(TRANSFORM);this._clearSelfAndDescendantCache(ABSOLUTE_TRANSFORM);}
this._needClearTransformCache=false;}
setPosition(pos){this._batchTransformChanges(()=>{this.x(pos.x);this.y(pos.y);});return this;}
getPosition(){return{x:this.x(),y:this.y(),};}
getRelativePointerPosition(){const stage=this.getStage();if(!stage){return null;}
var pos=stage.getPointerPosition();if(!pos){return null;}
var transform=this.getAbsoluteTransform().copy();transform.invert();return transform.point(pos);}
getAbsolutePosition(top){let haveCachedParent=false;let parent=this.parent;while(parent){if(parent.isCached()){haveCachedParent=true;break;}
parent=parent.parent;}
if(haveCachedParent&&!top){top=true;}
var absoluteMatrix=this.getAbsoluteTransform(top).getMatrix(),absoluteTransform=new Transform(),offset=this.offset();absoluteTransform.m=absoluteMatrix.slice();absoluteTransform.translate(offset.x,offset.y);return absoluteTransform.getTranslation();}
setAbsolutePosition(pos){const{x,y,...origTrans}=this._clearTransform();this.attrs.x=x;this.attrs.y=y;this._clearCache(TRANSFORM);var it=this._getAbsoluteTransform().copy();it.invert();it.translate(pos.x,pos.y);pos={x:this.attrs.x+it.getTranslation().x,y:this.attrs.y+it.getTranslation().y,};this._setTransform(origTrans);this.setPosition({x:pos.x,y:pos.y});this._clearCache(TRANSFORM);this._clearSelfAndDescendantCache(ABSOLUTE_TRANSFORM);return this;}
_setTransform(trans){var key;for(key in trans){this.attrs[key]=trans[key];}}
_clearTransform(){var trans={x:this.x(),y:this.y(),rotation:this.rotation(),scaleX:this.scaleX(),scaleY:this.scaleY(),offsetX:this.offsetX(),offsetY:this.offsetY(),skewX:this.skewX(),skewY:this.skewY(),};this.attrs.x=0;this.attrs.y=0;this.attrs.rotation=0;this.attrs.scaleX=1;this.attrs.scaleY=1;this.attrs.offsetX=0;this.attrs.offsetY=0;this.attrs.skewX=0;this.attrs.skewY=0;return trans;}
move(change){var changeX=change.x,changeY=change.y,x=this.x(),y=this.y();if(changeX!==undefined){x+=changeX;}
if(changeY!==undefined){y+=changeY;}
this.setPosition({x:x,y:y});return this;}
_eachAncestorReverse(func,top){var family=[],parent=this.getParent(),len,n;if(top&&top._id===this._id){return;}
family.unshift(this);while(parent&&(!top||parent._id!==top._id)){family.unshift(parent);parent=parent.parent;}
len=family.length;for(n=0;n<len;n++){func(family[n]);}}
rotate(theta){this.rotation(this.rotation()+theta);return this;}
moveToTop(){if(!this.parent){Util.warn('Node has no parent. moveToTop function is ignored.');return false;}
var index=this.index,len=this.parent.getChildren().length;if(index<len-1){this.parent.children.splice(index,1);this.parent.children.push(this);this.parent._setChildrenIndices();return true;}
return false;}
moveUp(){if(!this.parent){Util.warn('Node has no parent. moveUp function is ignored.');return false;}
var index=this.index,len=this.parent.getChildren().length;if(index<len-1){this.parent.children.splice(index,1);this.parent.children.splice(index+1,0,this);this.parent._setChildrenIndices();return true;}
return false;}
moveDown(){if(!this.parent){Util.warn('Node has no parent. moveDown function is ignored.');return false;}
var index=this.index;if(index>0){this.parent.children.splice(index,1);this.parent.children.splice(index-1,0,this);this.parent._setChildrenIndices();return true;}
return false;}
moveToBottom(){if(!this.parent){Util.warn('Node has no parent. moveToBottom function is ignored.');return false;}
var index=this.index;if(index>0){this.parent.children.splice(index,1);this.parent.children.unshift(this);this.parent._setChildrenIndices();return true;}
return false;}
setZIndex(zIndex){if(!this.parent){Util.warn('Node has no parent. zIndex parameter is ignored.');return this;}
if(zIndex<0||zIndex>=this.parent.children.length){Util.warn('Unexpected value '+
zIndex+' for zIndex property. zIndex is just index of a node in children of its parent. Expected value is from 0 to '+
(this.parent.children.length-1)+'.');}
var index=this.index;this.parent.children.splice(index,1);this.parent.children.splice(zIndex,0,this);this.parent._setChildrenIndices();return this;}
getAbsoluteOpacity(){return this._getCache(ABSOLUTE_OPACITY,this._getAbsoluteOpacity);}
_getAbsoluteOpacity(){var absOpacity=this.opacity();var parent=this.getParent();if(parent&&!parent._isUnderCache){absOpacity*=parent.getAbsoluteOpacity();}
return absOpacity;}
moveTo(newContainer){if(this.getParent()!==newContainer){this._remove();newContainer.add(this);}
return this;}
toObject(){var attrs=this.getAttrs(),key,val,getter,defaultValue,nonPlainObject;const obj={attrs:{},className:this.getClassName(),};for(key in attrs){val=attrs[key];nonPlainObject=Util.isObject(val)&&!Util._isPlainObject(val)&&!Util._isArray(val);if(nonPlainObject){continue;}
getter=typeof this[key]==='function'&&this[key];delete attrs[key];defaultValue=getter?getter.call(this):null;attrs[key]=val;if(defaultValue!==val){obj.attrs[key]=val;}}
return Util._prepareToStringify(obj);}
toJSON(){return JSON.stringify(this.toObject());}
getParent(){return this.parent;}
findAncestors(selector,includeSelf,stopNode){var res=[];if(includeSelf&&this._isMatch(selector)){res.push(this);}
var ancestor=this.parent;while(ancestor){if(ancestor===stopNode){return res;}
if(ancestor._isMatch(selector)){res.push(ancestor);}
ancestor=ancestor.parent;}
return res;}
isAncestorOf(node){return false;}
findAncestor(selector,includeSelf,stopNode){return this.findAncestors(selector,includeSelf,stopNode)[0];}
_isMatch(selector){if(!selector){return false;}
if(typeof selector==='function'){return selector(this);}
var selectorArr=selector.replace(/ /g,'').split(','),len=selectorArr.length,n,sel;for(n=0;n<len;n++){sel=selectorArr[n];if(!Util.isValidSelector(sel)){Util.warn('Selector "'+
sel+'" is invalid. Allowed selectors examples are "#foo", ".bar" or "Group".');Util.warn('If you have a custom shape with such className, please change it to start with upper letter like "Triangle".');Util.warn('Konva is awesome, right?');}
if(sel.charAt(0)==='#'){if(this.id()===sel.slice(1)){return true;}}
else if(sel.charAt(0)==='.'){if(this.hasName(sel.slice(1))){return true;}}
else if(this.className===sel||this.nodeType===sel){return true;}}
return false;}
getLayer(){var parent=this.getParent();return parent?parent.getLayer():null;}
getStage(){return this._getCache(STAGE$1,this._getStage);}
_getStage(){var parent=this.getParent();if(parent){return parent.getStage();}
else{return null;}}
fire(eventType,evt={},bubble){evt.target=evt.target||this;if(bubble){this._fireAndBubble(eventType,evt);}
else{this._fire(eventType,evt);}
return this;}
getAbsoluteTransform(top){if(top){return this._getAbsoluteTransform(top);}
else{return this._getCache(ABSOLUTE_TRANSFORM,this._getAbsoluteTransform);}}
_getAbsoluteTransform(top){var at;if(top){at=new Transform();this._eachAncestorReverse(function(node){var transformsEnabled=node.transformsEnabled();if(transformsEnabled==='all'){at.multiply(node.getTransform());}
else if(transformsEnabled==='position'){at.translate(node.x()-node.offsetX(),node.y()-node.offsetY());}},top);return at;}
else{at=this._cache.get(ABSOLUTE_TRANSFORM)||new Transform();if(this.parent){this.parent.getAbsoluteTransform().copyInto(at);}
else{at.reset();}
var transformsEnabled=this.transformsEnabled();if(transformsEnabled==='all'){at.multiply(this.getTransform());}
else if(transformsEnabled==='position'){const x=this.attrs.x||0;const y=this.attrs.y||0;const offsetX=this.attrs.offsetX||0;const offsetY=this.attrs.offsetY||0;at.translate(x-offsetX,y-offsetY);}
at.dirty=false;return at;}}
getAbsoluteScale(top){var parent=this;while(parent){if(parent._isUnderCache){top=parent;}
parent=parent.getParent();}
const transform=this.getAbsoluteTransform(top);const attrs=transform.decompose();return{x:attrs.scaleX,y:attrs.scaleY,};}
getAbsoluteRotation(){return this.getAbsoluteTransform().decompose().rotation;}
getTransform(){return this._getCache(TRANSFORM,this._getTransform);}
_getTransform(){var _a,_b;var m=this._cache.get(TRANSFORM)||new Transform();m.reset();var x=this.x(),y=this.y(),rotation=Konva$2.getAngle(this.rotation()),scaleX=(_a=this.attrs.scaleX)!==null&&_a!==void 0?_a:1,scaleY=(_b=this.attrs.scaleY)!==null&&_b!==void 0?_b:1,skewX=this.attrs.skewX||0,skewY=this.attrs.skewY||0,offsetX=this.attrs.offsetX||0,offsetY=this.attrs.offsetY||0;if(x!==0||y!==0){m.translate(x,y);}
if(rotation!==0){m.rotate(rotation);}
if(skewX!==0||skewY!==0){m.skew(skewX,skewY);}
if(scaleX!==1||scaleY!==1){m.scale(scaleX,scaleY);}
if(offsetX!==0||offsetY!==0){m.translate(-1*offsetX,-1*offsetY);}
m.dirty=false;return m;}
clone(obj){var attrs=Util.cloneObject(this.attrs),key,allListeners,len,n,listener;for(key in obj){attrs[key]=obj[key];}
var node=new this.constructor(attrs);for(key in this.eventListeners){allListeners=this.eventListeners[key];len=allListeners.length;for(n=0;n<len;n++){listener=allListeners[n];if(listener.name.indexOf(KONVA)<0){if(!node.eventListeners[key]){node.eventListeners[key]=[];}
node.eventListeners[key].push(listener);}}}
return node;}
_toKonvaCanvas(config){config=config||{};var box=this.getClientRect();var stage=this.getStage(),x=config.x!==undefined?config.x:Math.floor(box.x),y=config.y!==undefined?config.y:Math.floor(box.y),pixelRatio=config.pixelRatio||1,canvas=new SceneCanvas({width:config.width||Math.ceil(box.width)||(stage?stage.width():0),height:config.height||Math.ceil(box.height)||(stage?stage.height():0),pixelRatio:pixelRatio,}),context=canvas.getContext();const bufferCanvas=new SceneCanvas({width:canvas.width/canvas.pixelRatio+Math.abs(x),height:canvas.height/canvas.pixelRatio+Math.abs(y),pixelRatio:canvas.pixelRatio,});if(config.imageSmoothingEnabled===false){context._context.imageSmoothingEnabled=false;}
context.save();if(x||y){context.translate(-1*x,-1*y);}
this.drawScene(canvas,undefined,bufferCanvas);context.restore();return canvas;}
toCanvas(config){return this._toKonvaCanvas(config)._canvas;}
toDataURL(config){config=config||{};var mimeType=config.mimeType||null,quality=config.quality||null;var url=this._toKonvaCanvas(config).toDataURL(mimeType,quality);if(config.callback){config.callback(url);}
return url;}
toImage(config){return new Promise((resolve,reject)=>{try{const callback=config===null||config===void 0?void 0:config.callback;if(callback)
delete config.callback;Util._urlToImage(this.toDataURL(config),function(img){resolve(img);callback===null||callback===void 0?void 0:callback(img);});}
catch(err){reject(err);}});}
toBlob(config){return new Promise((resolve,reject)=>{try{const callback=config===null||config===void 0?void 0:config.callback;if(callback)
delete config.callback;this.toCanvas(config).toBlob((blob)=>{resolve(blob);callback===null||callback===void 0?void 0:callback(blob);},config===null||config===void 0?void 0:config.mimeType,config===null||config===void 0?void 0:config.quality);}
catch(err){reject(err);}});}
setSize(size){this.width(size.width);this.height(size.height);return this;}
getSize(){return{width:this.width(),height:this.height(),};}
getClassName(){return this.className||this.nodeType;}
getType(){return this.nodeType;}
getDragDistance(){if(this.attrs.dragDistance!==undefined){return this.attrs.dragDistance;}
else if(this.parent){return this.parent.getDragDistance();}
else{return Konva$2.dragDistance;}}
_off(type,name,callback){var evtListeners=this.eventListeners[type],i,evtName,handler;for(i=0;i<evtListeners.length;i++){evtName=evtListeners[i].name;handler=evtListeners[i].handler;if((evtName!=='konva'||name==='konva')&&(!name||evtName===name)&&(!callback||callback===handler)){evtListeners.splice(i,1);if(evtListeners.length===0){delete this.eventListeners[type];break;}
i--;}}}
_fireChangeEvent(attr,oldVal,newVal){this._fire(attr+CHANGE,{oldVal:oldVal,newVal:newVal,});}
addName(name){if(!this.hasName(name)){var oldName=this.name();var newName=oldName?oldName+' '+name:name;this.name(newName);}
return this;}
hasName(name){if(!name){return false;}
const fullName=this.name();if(!fullName){return false;}
var names=(fullName||'').split(/\s/g);return names.indexOf(name)!==-1;}
removeName(name){var names=(this.name()||'').split(/\s/g);var index=names.indexOf(name);if(index!==-1){names.splice(index,1);this.name(names.join(' '));}
return this;}
setAttr(attr,val){var func=this[SET+Util._capitalize(attr)];if(Util._isFunction(func)){func.call(this,val);}
else{this._setAttr(attr,val);}
return this;}
_requestDraw(){if(Konva$2.autoDrawEnabled){const drawNode=this.getLayer()||this.getStage();drawNode===null||drawNode===void 0?void 0:drawNode.batchDraw();}}
_setAttr(key,val){var oldVal=this.attrs[key];if(oldVal===val&&!Util.isObject(val)){return;}
if(val===undefined||val===null){delete this.attrs[key];}
else{this.attrs[key]=val;}
if(this._shouldFireChangeEvents){this._fireChangeEvent(key,oldVal,val);}
this._requestDraw();}
_setComponentAttr(key,component,val){var oldVal;if(val!==undefined){oldVal=this.attrs[key];if(!oldVal){this.attrs[key]=this.getAttr(key);}
this.attrs[key][component]=val;this._fireChangeEvent(key,oldVal,val);}}
_fireAndBubble(eventType,evt,compareShape){if(evt&&this.nodeType===SHAPE){evt.target=this;}
var shouldStop=(eventType===MOUSEENTER$1||eventType===MOUSELEAVE$1)&&((compareShape&&(this===compareShape||(this.isAncestorOf&&this.isAncestorOf(compareShape))))||(this.nodeType==='Stage'&&!compareShape));if(!shouldStop){this._fire(eventType,evt);var stopBubble=(eventType===MOUSEENTER$1||eventType===MOUSELEAVE$1)&&compareShape&&compareShape.isAncestorOf&&compareShape.isAncestorOf(this)&&!compareShape.isAncestorOf(this.parent);if(((evt&&!evt.cancelBubble)||!evt)&&this.parent&&this.parent.isListening()&&!stopBubble){if(compareShape&&compareShape.parent){this._fireAndBubble.call(this.parent,eventType,evt,compareShape);}
else{this._fireAndBubble.call(this.parent,eventType,evt);}}}}
_getProtoListeners(eventType){var _a,_b,_c;const allListeners=(_a=this._cache.get(ALL_LISTENERS))!==null&&_a!==void 0?_a:{};let events=allListeners===null||allListeners===void 0?void 0:allListeners[eventType];if(events===undefined){events=[];let obj=Object.getPrototypeOf(this);while(obj){const hierarchyEvents=(_c=(_b=obj.eventListeners)===null||_b===void 0?void 0:_b[eventType])!==null&&_c!==void 0?_c:[];events.push(...hierarchyEvents);obj=Object.getPrototypeOf(obj);}
allListeners[eventType]=events;this._cache.set(ALL_LISTENERS,allListeners);}
return events;}
_fire(eventType,evt){evt=evt||{};evt.currentTarget=this;evt.type=eventType;const topListeners=this._getProtoListeners(eventType);if(topListeners){for(var i=0;i<topListeners.length;i++){topListeners[i].handler.call(this,evt);}}
const selfListeners=this.eventListeners[eventType];if(selfListeners){for(var i=0;i<selfListeners.length;i++){selfListeners[i].handler.call(this,evt);}}}
draw(){this.drawScene();this.drawHit();return this;}
_createDragElement(evt){var pointerId=evt?evt.pointerId:undefined;var stage=this.getStage();var ap=this.getAbsolutePosition();if(!stage){return;}
var pos=stage._getPointerById(pointerId)||stage._changedPointerPositions[0]||ap;DD._dragElements.set(this._id,{node:this,startPointerPos:pos,offset:{x:pos.x-ap.x,y:pos.y-ap.y,},dragStatus:'ready',pointerId,});}
startDrag(evt,bubbleEvent=true){if(!DD._dragElements.has(this._id)){this._createDragElement(evt);}
const elem=DD._dragElements.get(this._id);elem.dragStatus='dragging';this.fire('dragstart',{type:'dragstart',target:this,evt:evt&&evt.evt,},bubbleEvent);}
_setDragPosition(evt,elem){const pos=this.getStage()._getPointerById(elem.pointerId);if(!pos){return;}
var newNodePos={x:pos.x-elem.offset.x,y:pos.y-elem.offset.y,};var dbf=this.dragBoundFunc();if(dbf!==undefined){const bounded=dbf.call(this,newNodePos,evt);if(!bounded){Util.warn('dragBoundFunc did not return any value. That is unexpected behavior. You must return new absolute position from dragBoundFunc.');}
else{newNodePos=bounded;}}
if(!this._lastPos||this._lastPos.x!==newNodePos.x||this._lastPos.y!==newNodePos.y){this.setAbsolutePosition(newNodePos);this._requestDraw();}
this._lastPos=newNodePos;}
stopDrag(evt){const elem=DD._dragElements.get(this._id);if(elem){elem.dragStatus='stopped';}
DD._endDragBefore(evt);DD._endDragAfter(evt);}
setDraggable(draggable){this._setAttr('draggable',draggable);this._dragChange();}
isDragging(){const elem=DD._dragElements.get(this._id);return elem?elem.dragStatus==='dragging':false;}
_listenDrag(){this._dragCleanup();this.on('mousedown.konva touchstart.konva',function(evt){var shouldCheckButton=evt.evt['button']!==undefined;var canDrag=!shouldCheckButton||Konva$2.dragButtons.indexOf(evt.evt['button'])>=0;if(!canDrag){return;}
if(this.isDragging()){return;}
var hasDraggingChild=false;DD._dragElements.forEach((elem)=>{if(this.isAncestorOf(elem.node)){hasDraggingChild=true;}});if(!hasDraggingChild){this._createDragElement(evt);}});}
_dragChange(){if(this.attrs.draggable){this._listenDrag();}
else{this._dragCleanup();var stage=this.getStage();if(!stage){return;}
const dragElement=DD._dragElements.get(this._id);const isDragging=dragElement&&dragElement.dragStatus==='dragging';const isReady=dragElement&&dragElement.dragStatus==='ready';if(isDragging){this.stopDrag();}
else if(isReady){DD._dragElements.delete(this._id);}}}
_dragCleanup(){this.off('mousedown.konva');this.off('touchstart.konva');}
isClientRectOnScreen(margin={x:0,y:0}){const stage=this.getStage();if(!stage){return false;}
const screenRect={x:-margin.x,y:-margin.y,width:stage.width()+2*margin.x,height:stage.height()+2*margin.y,};return Util.haveIntersection(screenRect,this.getClientRect());}
static create(data,container){if(Util._isString(data)){data=JSON.parse(data);}
return this._createNode(data,container);}
static _createNode(obj,container){var className=Node.prototype.getClassName.call(obj),children=obj.children,no,len,n;if(container){obj.attrs.container=container;}
if(!Konva$2[className]){Util.warn('Can not find a node with class name "'+
className+'". Fallback to "Shape".');className='Shape';}
const Class=Konva$2[className];no=new Class(obj.attrs);if(children){len=children.length;for(n=0;n<len;n++){no.add(Node._createNode(children[n]));}}
return no;}}
Node.prototype.nodeType='Node';Node.prototype._attrsAffectingSize=[];Node.prototype.eventListeners={};Node.prototype.on.call(Node.prototype,TRANSFORM_CHANGE_STR$1,function(){if(this._batchingTransformChange){this._needClearTransformCache=true;return;}
this._clearCache(TRANSFORM);this._clearSelfAndDescendantCache(ABSOLUTE_TRANSFORM);});Node.prototype.on.call(Node.prototype,'visibleChange.konva',function(){this._clearSelfAndDescendantCache(VISIBLE);});Node.prototype.on.call(Node.prototype,'listeningChange.konva',function(){this._clearSelfAndDescendantCache(LISTENING);});Node.prototype.on.call(Node.prototype,'opacityChange.konva',function(){this._clearSelfAndDescendantCache(ABSOLUTE_OPACITY);});const addGetterSetter=Factory.addGetterSetter;addGetterSetter(Node,'zIndex');addGetterSetter(Node,'absolutePosition');addGetterSetter(Node,'position');addGetterSetter(Node,'x',0,getNumberValidator());addGetterSetter(Node,'y',0,getNumberValidator());addGetterSetter(Node,'globalCompositeOperation','source-over',getStringValidator());addGetterSetter(Node,'opacity',1,getNumberValidator());addGetterSetter(Node,'name','',getStringValidator());addGetterSetter(Node,'id','',getStringValidator());addGetterSetter(Node,'rotation',0,getNumberValidator());Factory.addComponentsGetterSetter(Node,'scale',['x','y']);addGetterSetter(Node,'scaleX',1,getNumberValidator());addGetterSetter(Node,'scaleY',1,getNumberValidator());Factory.addComponentsGetterSetter(Node,'skew',['x','y']);addGetterSetter(Node,'skewX',0,getNumberValidator());addGetterSetter(Node,'skewY',0,getNumberValidator());Factory.addComponentsGetterSetter(Node,'offset',['x','y']);addGetterSetter(Node,'offsetX',0,getNumberValidator());addGetterSetter(Node,'offsetY',0,getNumberValidator());addGetterSetter(Node,'dragDistance',null,getNumberValidator());addGetterSetter(Node,'width',0,getNumberValidator());addGetterSetter(Node,'height',0,getNumberValidator());addGetterSetter(Node,'listening',true,getBooleanValidator());addGetterSetter(Node,'preventDefault',true,getBooleanValidator());addGetterSetter(Node,'filters',null,function(val){this._filterUpToDate=false;return val;});addGetterSetter(Node,'visible',true,getBooleanValidator());addGetterSetter(Node,'transformsEnabled','all',getStringValidator());addGetterSetter(Node,'size');addGetterSetter(Node,'dragBoundFunc');addGetterSetter(Node,'draggable',false,getBooleanValidator());Factory.backCompat(Node,{rotateDeg:'rotate',setRotationDeg:'setRotation',getRotationDeg:'getRotation',});class Container extends Node{constructor(){super(...arguments);this.children=[];}
getChildren(filterFunc){if(!filterFunc){return this.children||[];}
const children=this.children||[];var results=[];children.forEach(function(child){if(filterFunc(child)){results.push(child);}});return results;}
hasChildren(){return this.getChildren().length>0;}
removeChildren(){this.getChildren().forEach((child)=>{child.parent=null;child.index=0;child.remove();});this.children=[];this._requestDraw();return this;}
destroyChildren(){this.getChildren().forEach((child)=>{child.parent=null;child.index=0;child.destroy();});this.children=[];this._requestDraw();return this;}
add(...children){if(children.length===0){return this;}
if(children.length>1){for(var i=0;i<children.length;i++){this.add(children[i]);}
return this;}
const child=children[0];if(child.getParent()){child.moveTo(this);return this;}
this._validateAdd(child);child.index=this.getChildren().length;child.parent=this;child._clearCaches();this.getChildren().push(child);this._fire('add',{child:child,});this._requestDraw();return this;}
destroy(){if(this.hasChildren()){this.destroyChildren();}
super.destroy();return this;}
find(selector){return this._generalFind(selector,false);}
findOne(selector){var result=this._generalFind(selector,true);return result.length>0?result[0]:undefined;}
_generalFind(selector,findOne){var retArr=[];this._descendants((node)=>{const valid=node._isMatch(selector);if(valid){retArr.push(node);}
if(valid&&findOne){return true;}
return false;});return retArr;}
_descendants(fn){let shouldStop=false;const children=this.getChildren();for(const child of children){shouldStop=fn(child);if(shouldStop){return true;}
if(!child.hasChildren()){continue;}
shouldStop=child._descendants(fn);if(shouldStop){return true;}}
return false;}
toObject(){var obj=Node.prototype.toObject.call(this);obj.children=[];this.getChildren().forEach((child)=>{obj.children.push(child.toObject());});return obj;}
isAncestorOf(node){var parent=node.getParent();while(parent){if(parent._id===this._id){return true;}
parent=parent.getParent();}
return false;}
clone(obj){var node=Node.prototype.clone.call(this,obj);this.getChildren().forEach(function(no){node.add(no.clone());});return node;}
getAllIntersections(pos){var arr=[];this.find('Shape').forEach((shape)=>{if(shape.isVisible()&&shape.intersects(pos)){arr.push(shape);}});return arr;}
_clearSelfAndDescendantCache(attr){var _a;super._clearSelfAndDescendantCache(attr);if(this.isCached()){return;}
(_a=this.children)===null||_a===void 0?void 0:_a.forEach(function(node){node._clearSelfAndDescendantCache(attr);});}
_setChildrenIndices(){var _a;(_a=this.children)===null||_a===void 0?void 0:_a.forEach(function(child,n){child.index=n;});this._requestDraw();}
drawScene(can,top,bufferCanvas){var layer=this.getLayer(),canvas=can||(layer&&layer.getCanvas()),context=canvas&&canvas.getContext(),cachedCanvas=this._getCanvasCache(),cachedSceneCanvas=cachedCanvas&&cachedCanvas.scene;var caching=canvas&&canvas.isCache;if(!this.isVisible()&&!caching){return this;}
if(cachedSceneCanvas){context.save();var m=this.getAbsoluteTransform(top).getMatrix();context.transform(m[0],m[1],m[2],m[3],m[4],m[5]);this._drawCachedSceneCanvas(context);context.restore();}
else{this._drawChildren('drawScene',canvas,top,bufferCanvas);}
return this;}
drawHit(can,top){if(!this.shouldDrawHit(top)){return this;}
var layer=this.getLayer(),canvas=can||(layer&&layer.hitCanvas),context=canvas&&canvas.getContext(),cachedCanvas=this._getCanvasCache(),cachedHitCanvas=cachedCanvas&&cachedCanvas.hit;if(cachedHitCanvas){context.save();var m=this.getAbsoluteTransform(top).getMatrix();context.transform(m[0],m[1],m[2],m[3],m[4],m[5]);this._drawCachedHitCanvas(context);context.restore();}
else{this._drawChildren('drawHit',canvas,top);}
return this;}
_drawChildren(drawMethod,canvas,top,bufferCanvas){var _a;var context=canvas&&canvas.getContext(),clipWidth=this.clipWidth(),clipHeight=this.clipHeight(),clipFunc=this.clipFunc(),hasClip=(typeof clipWidth==='number'&&typeof clipHeight==='number')||clipFunc;const selfCache=top===this;if(hasClip){context.save();var transform=this.getAbsoluteTransform(top);var m=transform.getMatrix();context.transform(m[0],m[1],m[2],m[3],m[4],m[5]);context.beginPath();let clipArgs;if(clipFunc){clipArgs=clipFunc.call(this,context,this);}
else{var clipX=this.clipX();var clipY=this.clipY();context.rect(clipX||0,clipY||0,clipWidth,clipHeight);}
context.clip.apply(context,clipArgs);m=transform.copy().invert().getMatrix();context.transform(m[0],m[1],m[2],m[3],m[4],m[5]);}
var hasComposition=!selfCache&&this.globalCompositeOperation()!=='source-over'&&drawMethod==='drawScene';if(hasComposition){context.save();context._applyGlobalCompositeOperation(this);}
(_a=this.children)===null||_a===void 0?void 0:_a.forEach(function(child){child[drawMethod](canvas,top,bufferCanvas);});if(hasComposition){context.restore();}
if(hasClip){context.restore();}}
getClientRect(config={}){var _a;var skipTransform=config.skipTransform;var relativeTo=config.relativeTo;var minX,minY,maxX,maxY;var selfRect={x:Infinity,y:Infinity,width:0,height:0,};var that=this;(_a=this.children)===null||_a===void 0?void 0:_a.forEach(function(child){if(!child.visible()){return;}
var rect=child.getClientRect({relativeTo:that,skipShadow:config.skipShadow,skipStroke:config.skipStroke,});if(rect.width===0&&rect.height===0){return;}
if(minX===undefined){minX=rect.x;minY=rect.y;maxX=rect.x+rect.width;maxY=rect.y+rect.height;}
else{minX=Math.min(minX,rect.x);minY=Math.min(minY,rect.y);maxX=Math.max(maxX,rect.x+rect.width);maxY=Math.max(maxY,rect.y+rect.height);}});var shapes=this.find('Shape');var hasVisible=false;for(var i=0;i<shapes.length;i++){var shape=shapes[i];if(shape._isVisible(this)){hasVisible=true;break;}}
if(hasVisible&&minX!==undefined){selfRect={x:minX,y:minY,width:maxX-minX,height:maxY-minY,};}
else{selfRect={x:0,y:0,width:0,height:0,};}
if(!skipTransform){return this._transformedRect(selfRect,relativeTo);}
return selfRect;}}
Factory.addComponentsGetterSetter(Container,'clip',['x','y','width','height',]);Factory.addGetterSetter(Container,'clipX',undefined,getNumberValidator());Factory.addGetterSetter(Container,'clipY',undefined,getNumberValidator());Factory.addGetterSetter(Container,'clipWidth',undefined,getNumberValidator());Factory.addGetterSetter(Container,'clipHeight',undefined,getNumberValidator());Factory.addGetterSetter(Container,'clipFunc');const Captures=new Map();const SUPPORT_POINTER_EVENTS=Konva$2._global['PointerEvent']!==undefined;function getCapturedShape(pointerId){return Captures.get(pointerId);}
function createEvent(evt){return{evt,pointerId:evt.pointerId,};}
function hasPointerCapture(pointerId,shape){return Captures.get(pointerId)===shape;}
function setPointerCapture(pointerId,shape){releaseCapture(pointerId);const stage=shape.getStage();if(!stage)
return;Captures.set(pointerId,shape);if(SUPPORT_POINTER_EVENTS){shape._fire('gotpointercapture',createEvent(new PointerEvent('gotpointercapture')));}}
function releaseCapture(pointerId,target){const shape=Captures.get(pointerId);if(!shape)
return;const stage=shape.getStage();if(stage&&stage.content);Captures.delete(pointerId);if(SUPPORT_POINTER_EVENTS){shape._fire('lostpointercapture',createEvent(new PointerEvent('lostpointercapture')));}}
var STAGE='Stage',STRING='string',PX='px',MOUSEOUT='mouseout',MOUSELEAVE='mouseleave',MOUSEOVER='mouseover',MOUSEENTER='mouseenter',MOUSEMOVE='mousemove',MOUSEDOWN='mousedown',MOUSEUP='mouseup',POINTERMOVE='pointermove',POINTERDOWN='pointerdown',POINTERUP='pointerup',POINTERCANCEL='pointercancel',LOSTPOINTERCAPTURE='lostpointercapture',POINTEROUT='pointerout',POINTERLEAVE='pointerleave',POINTEROVER='pointerover',POINTERENTER='pointerenter',CONTEXTMENU='contextmenu',TOUCHSTART='touchstart',TOUCHEND='touchend',TOUCHMOVE='touchmove',TOUCHCANCEL='touchcancel',WHEEL='wheel',MAX_LAYERS_NUMBER=5,EVENTS=[[MOUSEENTER,'_pointerenter'],[MOUSEDOWN,'_pointerdown'],[MOUSEMOVE,'_pointermove'],[MOUSEUP,'_pointerup'],[MOUSELEAVE,'_pointerleave'],[TOUCHSTART,'_pointerdown'],[TOUCHMOVE,'_pointermove'],[TOUCHEND,'_pointerup'],[TOUCHCANCEL,'_pointercancel'],[MOUSEOVER,'_pointerover'],[WHEEL,'_wheel'],[CONTEXTMENU,'_contextmenu'],[POINTERDOWN,'_pointerdown'],[POINTERMOVE,'_pointermove'],[POINTERUP,'_pointerup'],[POINTERCANCEL,'_pointercancel'],[LOSTPOINTERCAPTURE,'_lostpointercapture'],];const EVENTS_MAP={mouse:{[POINTEROUT]:MOUSEOUT,[POINTERLEAVE]:MOUSELEAVE,[POINTEROVER]:MOUSEOVER,[POINTERENTER]:MOUSEENTER,[POINTERMOVE]:MOUSEMOVE,[POINTERDOWN]:MOUSEDOWN,[POINTERUP]:MOUSEUP,[POINTERCANCEL]:'mousecancel',pointerclick:'click',pointerdblclick:'dblclick',},touch:{[POINTEROUT]:'touchout',[POINTERLEAVE]:'touchleave',[POINTEROVER]:'touchover',[POINTERENTER]:'touchenter',[POINTERMOVE]:TOUCHMOVE,[POINTERDOWN]:TOUCHSTART,[POINTERUP]:TOUCHEND,[POINTERCANCEL]:TOUCHCANCEL,pointerclick:'tap',pointerdblclick:'dbltap',},pointer:{[POINTEROUT]:POINTEROUT,[POINTERLEAVE]:POINTERLEAVE,[POINTEROVER]:POINTEROVER,[POINTERENTER]:POINTERENTER,[POINTERMOVE]:POINTERMOVE,[POINTERDOWN]:POINTERDOWN,[POINTERUP]:POINTERUP,[POINTERCANCEL]:POINTERCANCEL,pointerclick:'pointerclick',pointerdblclick:'pointerdblclick',},};const getEventType=(type)=>{if(type.indexOf('pointer')>=0){return'pointer';}
if(type.indexOf('touch')>=0){return'touch';}
return'mouse';};const getEventsMap=(eventType)=>{const type=getEventType(eventType);if(type==='pointer'){return Konva$2.pointerEventsEnabled&&EVENTS_MAP.pointer;}
if(type==='touch'){return EVENTS_MAP.touch;}
if(type==='mouse'){return EVENTS_MAP.mouse;}};function checkNoClip(attrs={}){if(attrs.clipFunc||attrs.clipWidth||attrs.clipHeight){Util.warn('Stage does not support clipping. Please use clip for Layers or Groups.');}
return attrs;}
const NO_POINTERS_MESSAGE=`Pointer position is missing and not registered by the stage. Looks like it is outside of the stage container. You can set it manually from event: stage.setPointersPositions(event);`;const stages=[];class Stage extends Container{constructor(config){super(checkNoClip(config));this._pointerPositions=[];this._changedPointerPositions=[];this._buildDOM();this._bindContentEvents();stages.push(this);this.on('widthChange.konva heightChange.konva',this._resizeDOM);this.on('visibleChange.konva',this._checkVisibility);this.on('clipWidthChange.konva clipHeightChange.konva clipFuncChange.konva',()=>{checkNoClip(this.attrs);});this._checkVisibility();}
_validateAdd(child){const isLayer=child.getType()==='Layer';const isFastLayer=child.getType()==='FastLayer';const valid=isLayer||isFastLayer;if(!valid){Util.throw('You may only add layers to the stage.');}}
_checkVisibility(){if(!this.content){return;}
const style=this.visible()?'':'none';this.content.style.display=style;}
setContainer(container){if(typeof container===STRING){if(container.charAt(0)==='.'){var className=container.slice(1);container=document.getElementsByClassName(className)[0];}
else{var id;if(container.charAt(0)!=='#'){id=container;}
else{id=container.slice(1);}
container=document.getElementById(id);}
if(!container){throw'Can not find container in document with id '+id;}}
this._setAttr('container',container);if(this.content){if(this.content.parentElement){this.content.parentElement.removeChild(this.content);}
container.appendChild(this.content);}
return this;}
shouldDrawHit(){return true;}
clear(){var layers=this.children,len=layers.length,n;for(n=0;n<len;n++){layers[n].clear();}
return this;}
clone(obj){if(!obj){obj={};}
obj.container=typeof document!=='undefined'&&document.createElement('div');return Container.prototype.clone.call(this,obj);}
destroy(){super.destroy();var content=this.content;if(content&&Util._isInDocument(content)){this.container().removeChild(content);}
var index=stages.indexOf(this);if(index>-1){stages.splice(index,1);}
Util.releaseCanvas(this.bufferCanvas._canvas,this.bufferHitCanvas._canvas);return this;}
getPointerPosition(){const pos=this._pointerPositions[0]||this._changedPointerPositions[0];if(!pos){Util.warn(NO_POINTERS_MESSAGE);return null;}
return{x:pos.x,y:pos.y,};}
_getPointerById(id){return this._pointerPositions.find((p)=>p.id===id);}
getPointersPositions(){return this._pointerPositions;}
getStage(){return this;}
getContent(){return this.content;}
_toKonvaCanvas(config){config=config||{};config.x=config.x||0;config.y=config.y||0;config.width=config.width||this.width();config.height=config.height||this.height();var canvas=new SceneCanvas({width:config.width,height:config.height,pixelRatio:config.pixelRatio||1,});var _context=canvas.getContext()._context;var layers=this.children;if(config.x||config.y){_context.translate(-1*config.x,-1*config.y);}
layers.forEach(function(layer){if(!layer.isVisible()){return;}
var layerCanvas=layer._toKonvaCanvas(config);_context.drawImage(layerCanvas._canvas,config.x,config.y,layerCanvas.getWidth()/layerCanvas.getPixelRatio(),layerCanvas.getHeight()/layerCanvas.getPixelRatio());});return canvas;}
getIntersection(pos){if(!pos){return null;}
var layers=this.children,len=layers.length,end=len-1,n;for(n=end;n>=0;n--){const shape=layers[n].getIntersection(pos);if(shape){return shape;}}
return null;}
_resizeDOM(){var width=this.width();var height=this.height();if(this.content){this.content.style.width=width+PX;this.content.style.height=height+PX;}
this.bufferCanvas.setSize(width,height);this.bufferHitCanvas.setSize(width,height);this.children.forEach((layer)=>{layer.setSize({width,height});layer.draw();});}
add(layer,...rest){if(arguments.length>1){for(var i=0;i<arguments.length;i++){this.add(arguments[i]);}
return this;}
super.add(layer);var length=this.children.length;if(length>MAX_LAYERS_NUMBER){Util.warn('The stage has '+
length+' layers. Recommended maximum number of layers is 3-5. Adding more layers into the stage may drop the performance. Rethink your tree structure, you can use Konva.Group.');}
layer.setSize({width:this.width(),height:this.height()});layer.draw();if(Konva$2.isBrowser){this.content.appendChild(layer.canvas._canvas);}
return this;}
getParent(){return null;}
getLayer(){return null;}
hasPointerCapture(pointerId){return hasPointerCapture(pointerId,this);}
setPointerCapture(pointerId){setPointerCapture(pointerId,this);}
releaseCapture(pointerId){releaseCapture(pointerId);}
getLayers(){return this.children;}
_bindContentEvents(){if(!Konva$2.isBrowser){return;}
EVENTS.forEach(([event,methodName])=>{this.content.addEventListener(event,(evt)=>{this[methodName](evt);},{passive:false});});}
_pointerenter(evt){this.setPointersPositions(evt);const events=getEventsMap(evt.type);if(events){this._fire(events.pointerenter,{evt:evt,target:this,currentTarget:this,});}}
_pointerover(evt){this.setPointersPositions(evt);const events=getEventsMap(evt.type);if(events){this._fire(events.pointerover,{evt:evt,target:this,currentTarget:this,});}}
_getTargetShape(evenType){let shape=this[evenType+'targetShape'];if(shape&&!shape.getStage()){shape=null;}
return shape;}
_pointerleave(evt){const events=getEventsMap(evt.type);const eventType=getEventType(evt.type);if(!events){return;}
this.setPointersPositions(evt);var targetShape=this._getTargetShape(eventType);var eventsEnabled=!(Konva$2.isDragging()||Konva$2.isTransforming())||Konva$2.hitOnDragEnabled;if(targetShape&&eventsEnabled){targetShape._fireAndBubble(events.pointerout,{evt:evt});targetShape._fireAndBubble(events.pointerleave,{evt:evt});this._fire(events.pointerleave,{evt:evt,target:this,currentTarget:this,});this[eventType+'targetShape']=null;}
else if(eventsEnabled){this._fire(events.pointerleave,{evt:evt,target:this,currentTarget:this,});this._fire(events.pointerout,{evt:evt,target:this,currentTarget:this,});}
this.pointerPos=null;this._pointerPositions=[];}
_pointerdown(evt){const events=getEventsMap(evt.type);const eventType=getEventType(evt.type);if(!events){return;}
this.setPointersPositions(evt);var triggeredOnShape=false;this._changedPointerPositions.forEach((pos)=>{var shape=this.getIntersection(pos);DD.justDragged=false;Konva$2['_'+eventType+'ListenClick']=true;if(!shape||!shape.isListening()){return;}
if(Konva$2.capturePointerEventsEnabled){shape.setPointerCapture(pos.id);}
this[eventType+'ClickStartShape']=shape;shape._fireAndBubble(events.pointerdown,{evt:evt,pointerId:pos.id,});triggeredOnShape=true;const isTouch=evt.type.indexOf('touch')>=0;if(shape.preventDefault()&&evt.cancelable&&isTouch){evt.preventDefault();}});if(!triggeredOnShape){this._fire(events.pointerdown,{evt:evt,target:this,currentTarget:this,pointerId:this._pointerPositions[0].id,});}}
_pointermove(evt){const events=getEventsMap(evt.type);const eventType=getEventType(evt.type);if(!events){return;}
if(Konva$2.isDragging()&&DD.node.preventDefault()&&evt.cancelable){evt.preventDefault();}
this.setPointersPositions(evt);var eventsEnabled=!(Konva$2.isDragging()||Konva$2.isTransforming())||Konva$2.hitOnDragEnabled;if(!eventsEnabled){return;}
var processedShapesIds={};let triggeredOnShape=false;var targetShape=this._getTargetShape(eventType);this._changedPointerPositions.forEach((pos)=>{const shape=(getCapturedShape(pos.id)||this.getIntersection(pos));const pointerId=pos.id;const event={evt:evt,pointerId};var differentTarget=targetShape!==shape;if(differentTarget&&targetShape){targetShape._fireAndBubble(events.pointerout,{...event},shape);targetShape._fireAndBubble(events.pointerleave,{...event},shape);}
if(shape){if(processedShapesIds[shape._id]){return;}
processedShapesIds[shape._id]=true;}
if(shape&&shape.isListening()){triggeredOnShape=true;if(differentTarget){shape._fireAndBubble(events.pointerover,{...event},targetShape);shape._fireAndBubble(events.pointerenter,{...event},targetShape);this[eventType+'targetShape']=shape;}
shape._fireAndBubble(events.pointermove,{...event});}
else{if(targetShape){this._fire(events.pointerover,{evt:evt,target:this,currentTarget:this,pointerId,});this[eventType+'targetShape']=null;}}});if(!triggeredOnShape){this._fire(events.pointermove,{evt:evt,target:this,currentTarget:this,pointerId:this._changedPointerPositions[0].id,});}}
_pointerup(evt){const events=getEventsMap(evt.type);const eventType=getEventType(evt.type);if(!events){return;}
this.setPointersPositions(evt);const clickStartShape=this[eventType+'ClickStartShape'];const clickEndShape=this[eventType+'ClickEndShape'];var processedShapesIds={};let triggeredOnShape=false;this._changedPointerPositions.forEach((pos)=>{const shape=(getCapturedShape(pos.id)||this.getIntersection(pos));if(shape){shape.releaseCapture(pos.id);if(processedShapesIds[shape._id]){return;}
processedShapesIds[shape._id]=true;}
const pointerId=pos.id;const event={evt:evt,pointerId};let fireDblClick=false;if(Konva$2['_'+eventType+'InDblClickWindow']){fireDblClick=true;clearTimeout(this[eventType+'DblTimeout']);}
else if(!DD.justDragged){Konva$2['_'+eventType+'InDblClickWindow']=true;clearTimeout(this[eventType+'DblTimeout']);}
this[eventType+'DblTimeout']=setTimeout(function(){Konva$2['_'+eventType+'InDblClickWindow']=false;},Konva$2.dblClickWindow);if(shape&&shape.isListening()){triggeredOnShape=true;this[eventType+'ClickEndShape']=shape;shape._fireAndBubble(events.pointerup,{...event});if(Konva$2['_'+eventType+'ListenClick']&&clickStartShape&&clickStartShape===shape){shape._fireAndBubble(events.pointerclick,{...event});if(fireDblClick&&clickEndShape&&clickEndShape===shape){shape._fireAndBubble(events.pointerdblclick,{...event});}}}
else{this[eventType+'ClickEndShape']=null;if(Konva$2['_'+eventType+'ListenClick']){this._fire(events.pointerclick,{evt:evt,target:this,currentTarget:this,pointerId,});}
if(fireDblClick){this._fire(events.pointerdblclick,{evt:evt,target:this,currentTarget:this,pointerId,});}}});if(!triggeredOnShape){this._fire(events.pointerup,{evt:evt,target:this,currentTarget:this,pointerId:this._changedPointerPositions[0].id,});}
Konva$2['_'+eventType+'ListenClick']=false;if(evt.cancelable&&eventType!=='touch'){evt.preventDefault();}}
_contextmenu(evt){this.setPointersPositions(evt);var shape=this.getIntersection(this.getPointerPosition());if(shape&&shape.isListening()){shape._fireAndBubble(CONTEXTMENU,{evt:evt});}
else{this._fire(CONTEXTMENU,{evt:evt,target:this,currentTarget:this,});}}
_wheel(evt){this.setPointersPositions(evt);var shape=this.getIntersection(this.getPointerPosition());if(shape&&shape.isListening()){shape._fireAndBubble(WHEEL,{evt:evt});}
else{this._fire(WHEEL,{evt:evt,target:this,currentTarget:this,});}}
_pointercancel(evt){this.setPointersPositions(evt);const shape=getCapturedShape(evt.pointerId)||this.getIntersection(this.getPointerPosition());if(shape){shape._fireAndBubble(POINTERUP,createEvent(evt));}
releaseCapture(evt.pointerId);}
_lostpointercapture(evt){releaseCapture(evt.pointerId);}
setPointersPositions(evt){var contentPosition=this._getContentPosition(),x=null,y=null;evt=evt?evt:window.event;if(evt.touches!==undefined){this._pointerPositions=[];this._changedPointerPositions=[];Array.prototype.forEach.call(evt.touches,(touch)=>{this._pointerPositions.push({id:touch.identifier,x:(touch.clientX-contentPosition.left)/contentPosition.scaleX,y:(touch.clientY-contentPosition.top)/contentPosition.scaleY,});});Array.prototype.forEach.call(evt.changedTouches||evt.touches,(touch)=>{this._changedPointerPositions.push({id:touch.identifier,x:(touch.clientX-contentPosition.left)/contentPosition.scaleX,y:(touch.clientY-contentPosition.top)/contentPosition.scaleY,});});}
else{x=(evt.clientX-contentPosition.left)/contentPosition.scaleX;y=(evt.clientY-contentPosition.top)/contentPosition.scaleY;this.pointerPos={x:x,y:y,};this._pointerPositions=[{x,y,id:Util._getFirstPointerId(evt)}];this._changedPointerPositions=[{x,y,id:Util._getFirstPointerId(evt)},];}}
_setPointerPosition(evt){Util.warn('Method _setPointerPosition is deprecated. Use "stage.setPointersPositions(event)" instead.');this.setPointersPositions(evt);}
_getContentPosition(){if(!this.content||!this.content.getBoundingClientRect){return{top:0,left:0,scaleX:1,scaleY:1,};}
var rect=this.content.getBoundingClientRect();return{top:rect.top,left:rect.left,scaleX:rect.width/this.content.clientWidth||1,scaleY:rect.height/this.content.clientHeight||1,};}
_buildDOM(){this.bufferCanvas=new SceneCanvas({width:this.width(),height:this.height(),});this.bufferHitCanvas=new HitCanvas({pixelRatio:1,width:this.width(),height:this.height(),});if(!Konva$2.isBrowser){return;}
var container=this.container();if(!container){throw'Stage has no container. A container is required.';}
container.innerHTML='';this.content=document.createElement('div');this.content.style.position='relative';this.content.style.userSelect='none';this.content.className='konvajs-content';this.content.setAttribute('role','presentation');container.appendChild(this.content);this._resizeDOM();}
cache(){Util.warn('Cache function is not allowed for stage. You may use cache only for layers, groups and shapes.');return this;}
clearCache(){return this;}
batchDraw(){this.getChildren().forEach(function(layer){layer.batchDraw();});return this;}}
Stage.prototype.nodeType=STAGE;_registerNode(Stage);Factory.addGetterSetter(Stage,'container');var HAS_SHADOW='hasShadow';var SHADOW_RGBA='shadowRGBA';var patternImage='patternImage';var linearGradient='linearGradient';var radialGradient='radialGradient';let dummyContext$1;function getDummyContext$1(){if(dummyContext$1){return dummyContext$1;}
dummyContext$1=Util.createCanvasElement().getContext('2d');return dummyContext$1;}
const shapes={};function _fillFunc$2(context){const fillRule=this.attrs.fillRule;if(fillRule){context.fill(fillRule);}
else{context.fill();}}
function _strokeFunc$2(context){context.stroke();}
function _fillFuncHit(context){context.fill();}
function _strokeFuncHit(context){context.stroke();}
function _clearHasShadowCache(){this._clearCache(HAS_SHADOW);}
function _clearGetShadowRGBACache(){this._clearCache(SHADOW_RGBA);}
function _clearFillPatternCache(){this._clearCache(patternImage);}
function _clearLinearGradientCache(){this._clearCache(linearGradient);}
function _clearRadialGradientCache(){this._clearCache(radialGradient);}
class Shape extends Node{constructor(config){super(config);let key;while(true){key=Util.getRandomColor();if(key&&!(key in shapes)){break;}}
this.colorKey=key;shapes[key]=this;}
getContext(){Util.warn('shape.getContext() method is deprecated. Please do not use it.');return this.getLayer().getContext();}
getCanvas(){Util.warn('shape.getCanvas() method is deprecated. Please do not use it.');return this.getLayer().getCanvas();}
getSceneFunc(){return this.attrs.sceneFunc||this['_sceneFunc'];}
getHitFunc(){return this.attrs.hitFunc||this['_hitFunc'];}
hasShadow(){return this._getCache(HAS_SHADOW,this._hasShadow);}
_hasShadow(){return(this.shadowEnabled()&&this.shadowOpacity()!==0&&!!(this.shadowColor()||this.shadowBlur()||this.shadowOffsetX()||this.shadowOffsetY()));}
_getFillPattern(){return this._getCache(patternImage,this.__getFillPattern);}
__getFillPattern(){if(this.fillPatternImage()){var ctx=getDummyContext$1();const pattern=ctx.createPattern(this.fillPatternImage(),this.fillPatternRepeat()||'repeat');if(pattern&&pattern.setTransform){const tr=new Transform();tr.translate(this.fillPatternX(),this.fillPatternY());tr.rotate(Konva$2.getAngle(this.fillPatternRotation()));tr.scale(this.fillPatternScaleX(),this.fillPatternScaleY());tr.translate(-1*this.fillPatternOffsetX(),-1*this.fillPatternOffsetY());const m=tr.getMatrix();const matrix=typeof DOMMatrix==='undefined'?{a:m[0],b:m[1],c:m[2],d:m[3],e:m[4],f:m[5],}:new DOMMatrix(m);pattern.setTransform(matrix);}
return pattern;}}
_getLinearGradient(){return this._getCache(linearGradient,this.__getLinearGradient);}
__getLinearGradient(){var colorStops=this.fillLinearGradientColorStops();if(colorStops){var ctx=getDummyContext$1();var start=this.fillLinearGradientStartPoint();var end=this.fillLinearGradientEndPoint();var grd=ctx.createLinearGradient(start.x,start.y,end.x,end.y);for(var n=0;n<colorStops.length;n+=2){grd.addColorStop(colorStops[n],colorStops[n+1]);}
return grd;}}
_getRadialGradient(){return this._getCache(radialGradient,this.__getRadialGradient);}
__getRadialGradient(){var colorStops=this.fillRadialGradientColorStops();if(colorStops){var ctx=getDummyContext$1();var start=this.fillRadialGradientStartPoint();var end=this.fillRadialGradientEndPoint();var grd=ctx.createRadialGradient(start.x,start.y,this.fillRadialGradientStartRadius(),end.x,end.y,this.fillRadialGradientEndRadius());for(var n=0;n<colorStops.length;n+=2){grd.addColorStop(colorStops[n],colorStops[n+1]);}
return grd;}}
getShadowRGBA(){return this._getCache(SHADOW_RGBA,this._getShadowRGBA);}
_getShadowRGBA(){if(!this.hasShadow()){return;}
var rgba=Util.colorToRGBA(this.shadowColor());if(rgba){return('rgba('+
rgba.r+','+
rgba.g+','+
rgba.b+','+
rgba.a*(this.shadowOpacity()||1)+')');}}
hasFill(){return this._calculate('hasFill',['fillEnabled','fill','fillPatternImage','fillLinearGradientColorStops','fillRadialGradientColorStops',],()=>{return(this.fillEnabled()&&!!(this.fill()||this.fillPatternImage()||this.fillLinearGradientColorStops()||this.fillRadialGradientColorStops()));});}
hasStroke(){return this._calculate('hasStroke',['strokeEnabled','strokeWidth','stroke','strokeLinearGradientColorStops',],()=>{return(this.strokeEnabled()&&this.strokeWidth()&&!!(this.stroke()||this.strokeLinearGradientColorStops()));});}
hasHitStroke(){const width=this.hitStrokeWidth();if(width==='auto'){return this.hasStroke();}
return this.strokeEnabled()&&!!width;}
intersects(point){var stage=this.getStage();if(!stage){return false;}
const bufferHitCanvas=stage.bufferHitCanvas;bufferHitCanvas.getContext().clear();this.drawHit(bufferHitCanvas,undefined,true);const p=bufferHitCanvas.context.getImageData(Math.round(point.x),Math.round(point.y),1,1).data;return p[3]>0;}
destroy(){Node.prototype.destroy.call(this);delete shapes[this.colorKey];delete this.colorKey;return this;}
_useBufferCanvas(forceFill){var _a;const perfectDrawEnabled=(_a=this.attrs.perfectDrawEnabled)!==null&&_a!==void 0?_a:true;if(!perfectDrawEnabled){return false;}
const hasFill=forceFill||this.hasFill();const hasStroke=this.hasStroke();const isTransparent=this.getAbsoluteOpacity()!==1;if(hasFill&&hasStroke&&isTransparent){return true;}
const hasShadow=this.hasShadow();const strokeForShadow=this.shadowForStrokeEnabled();if(hasFill&&hasStroke&&hasShadow&&strokeForShadow){return true;}
return false;}
setStrokeHitEnabled(val){Util.warn('strokeHitEnabled property is deprecated. Please use hitStrokeWidth instead.');if(val){this.hitStrokeWidth('auto');}
else{this.hitStrokeWidth(0);}}
getStrokeHitEnabled(){if(this.hitStrokeWidth()===0){return false;}
else{return true;}}
getSelfRect(){var size=this.size();return{x:this._centroid?-size.width/2:0,y:this._centroid?-size.height/2:0,width:size.width,height:size.height,};}
getClientRect(config={}){const skipTransform=config.skipTransform;const relativeTo=config.relativeTo;const fillRect=this.getSelfRect();const applyStroke=!config.skipStroke&&this.hasStroke();const strokeWidth=(applyStroke&&this.strokeWidth())||0;const fillAndStrokeWidth=fillRect.width+strokeWidth;const fillAndStrokeHeight=fillRect.height+strokeWidth;const applyShadow=!config.skipShadow&&this.hasShadow();const shadowOffsetX=applyShadow?this.shadowOffsetX():0;const shadowOffsetY=applyShadow?this.shadowOffsetY():0;const preWidth=fillAndStrokeWidth+Math.abs(shadowOffsetX);const preHeight=fillAndStrokeHeight+Math.abs(shadowOffsetY);const blurRadius=(applyShadow&&this.shadowBlur())||0;const width=preWidth+blurRadius*2;const height=preHeight+blurRadius*2;const rect={width:width,height:height,x:-(strokeWidth/2+blurRadius)+
Math.min(shadowOffsetX,0)+
fillRect.x,y:-(strokeWidth/2+blurRadius)+
Math.min(shadowOffsetY,0)+
fillRect.y,};if(!skipTransform){return this._transformedRect(rect,relativeTo);}
return rect;}
drawScene(can,top,bufferCanvas){var layer=this.getLayer();var canvas=can||layer.getCanvas(),context=canvas.getContext(),cachedCanvas=this._getCanvasCache(),drawFunc=this.getSceneFunc(),hasShadow=this.hasShadow(),stage,bufferContext;var skipBuffer=canvas.isCache;var cachingSelf=top===this;if(!this.isVisible()&&!cachingSelf){return this;}
if(cachedCanvas){context.save();var m=this.getAbsoluteTransform(top).getMatrix();context.transform(m[0],m[1],m[2],m[3],m[4],m[5]);this._drawCachedSceneCanvas(context);context.restore();return this;}
if(!drawFunc){return this;}
context.save();if(this._useBufferCanvas()&&!skipBuffer){stage=this.getStage();const bc=bufferCanvas||stage.bufferCanvas;bufferContext=bc.getContext();bufferContext.clear();bufferContext.save();bufferContext._applyLineJoin(this);var o=this.getAbsoluteTransform(top).getMatrix();bufferContext.transform(o[0],o[1],o[2],o[3],o[4],o[5]);drawFunc.call(this,bufferContext,this);bufferContext.restore();var ratio=bc.pixelRatio;if(hasShadow){context._applyShadow(this);}
context._applyOpacity(this);context._applyGlobalCompositeOperation(this);context.drawImage(bc._canvas,0,0,bc.width/ratio,bc.height/ratio);}
else{context._applyLineJoin(this);if(!cachingSelf){var o=this.getAbsoluteTransform(top).getMatrix();context.transform(o[0],o[1],o[2],o[3],o[4],o[5]);context._applyOpacity(this);context._applyGlobalCompositeOperation(this);}
if(hasShadow){context._applyShadow(this);}
drawFunc.call(this,context,this);}
context.restore();return this;}
drawHit(can,top,skipDragCheck=false){if(!this.shouldDrawHit(top,skipDragCheck)){return this;}
var layer=this.getLayer(),canvas=can||layer.hitCanvas,context=canvas&&canvas.getContext(),drawFunc=this.hitFunc()||this.sceneFunc(),cachedCanvas=this._getCanvasCache(),cachedHitCanvas=cachedCanvas&&cachedCanvas.hit;if(!this.colorKey){Util.warn('Looks like your canvas has a destroyed shape in it. Do not reuse shape after you destroyed it. If you want to reuse shape you should call remove() instead of destroy()');}
if(cachedHitCanvas){context.save();var m=this.getAbsoluteTransform(top).getMatrix();context.transform(m[0],m[1],m[2],m[3],m[4],m[5]);this._drawCachedHitCanvas(context);context.restore();return this;}
if(!drawFunc){return this;}
context.save();context._applyLineJoin(this);const selfCache=this===top;if(!selfCache){var o=this.getAbsoluteTransform(top).getMatrix();context.transform(o[0],o[1],o[2],o[3],o[4],o[5]);}
drawFunc.call(this,context,this);context.restore();return this;}
drawHitFromCache(alphaThreshold=0){var cachedCanvas=this._getCanvasCache(),sceneCanvas=this._getCachedSceneCanvas(),hitCanvas=cachedCanvas.hit,hitContext=hitCanvas.getContext(),hitWidth=hitCanvas.getWidth(),hitHeight=hitCanvas.getHeight(),hitImageData,hitData,len,rgbColorKey,i,alpha;hitContext.clear();hitContext.drawImage(sceneCanvas._canvas,0,0,hitWidth,hitHeight);try{hitImageData=hitContext.getImageData(0,0,hitWidth,hitHeight);hitData=hitImageData.data;len=hitData.length;rgbColorKey=Util._hexToRgb(this.colorKey);for(i=0;i<len;i+=4){alpha=hitData[i+3];if(alpha>alphaThreshold){hitData[i]=rgbColorKey.r;hitData[i+1]=rgbColorKey.g;hitData[i+2]=rgbColorKey.b;hitData[i+3]=255;}
else{hitData[i+3]=0;}}
hitContext.putImageData(hitImageData,0,0);}
catch(e){Util.error('Unable to draw hit graph from cached scene canvas. '+e.message);}
return this;}
hasPointerCapture(pointerId){return hasPointerCapture(pointerId,this);}
setPointerCapture(pointerId){setPointerCapture(pointerId,this);}
releaseCapture(pointerId){releaseCapture(pointerId);}}
Shape.prototype._fillFunc=_fillFunc$2;Shape.prototype._strokeFunc=_strokeFunc$2;Shape.prototype._fillFuncHit=_fillFuncHit;Shape.prototype._strokeFuncHit=_strokeFuncHit;Shape.prototype._centroid=false;Shape.prototype.nodeType='Shape';_registerNode(Shape);Shape.prototype.eventListeners={};Shape.prototype.on.call(Shape.prototype,'shadowColorChange.konva shadowBlurChange.konva shadowOffsetChange.konva shadowOpacityChange.konva shadowEnabledChange.konva',_clearHasShadowCache);Shape.prototype.on.call(Shape.prototype,'shadowColorChange.konva shadowOpacityChange.konva shadowEnabledChange.konva',_clearGetShadowRGBACache);Shape.prototype.on.call(Shape.prototype,'fillPriorityChange.konva fillPatternImageChange.konva fillPatternRepeatChange.konva fillPatternScaleXChange.konva fillPatternScaleYChange.konva fillPatternOffsetXChange.konva fillPatternOffsetYChange.konva fillPatternXChange.konva fillPatternYChange.konva fillPatternRotationChange.konva',_clearFillPatternCache);Shape.prototype.on.call(Shape.prototype,'fillPriorityChange.konva fillLinearGradientColorStopsChange.konva fillLinearGradientStartPointXChange.konva fillLinearGradientStartPointYChange.konva fillLinearGradientEndPointXChange.konva fillLinearGradientEndPointYChange.konva',_clearLinearGradientCache);Shape.prototype.on.call(Shape.prototype,'fillPriorityChange.konva fillRadialGradientColorStopsChange.konva fillRadialGradientStartPointXChange.konva fillRadialGradientStartPointYChange.konva fillRadialGradientEndPointXChange.konva fillRadialGradientEndPointYChange.konva fillRadialGradientStartRadiusChange.konva fillRadialGradientEndRadiusChange.konva',_clearRadialGradientCache);Factory.addGetterSetter(Shape,'stroke',undefined,getStringOrGradientValidator());Factory.addGetterSetter(Shape,'strokeWidth',2,getNumberValidator());Factory.addGetterSetter(Shape,'fillAfterStrokeEnabled',false);Factory.addGetterSetter(Shape,'hitStrokeWidth','auto',getNumberOrAutoValidator());Factory.addGetterSetter(Shape,'strokeHitEnabled',true,getBooleanValidator());Factory.addGetterSetter(Shape,'perfectDrawEnabled',true,getBooleanValidator());Factory.addGetterSetter(Shape,'shadowForStrokeEnabled',true,getBooleanValidator());Factory.addGetterSetter(Shape,'lineJoin');Factory.addGetterSetter(Shape,'lineCap');Factory.addGetterSetter(Shape,'sceneFunc');Factory.addGetterSetter(Shape,'hitFunc');Factory.addGetterSetter(Shape,'dash');Factory.addGetterSetter(Shape,'dashOffset',0,getNumberValidator());Factory.addGetterSetter(Shape,'shadowColor',undefined,getStringValidator());Factory.addGetterSetter(Shape,'shadowBlur',0,getNumberValidator());Factory.addGetterSetter(Shape,'shadowOpacity',1,getNumberValidator());Factory.addComponentsGetterSetter(Shape,'shadowOffset',['x','y']);Factory.addGetterSetter(Shape,'shadowOffsetX',0,getNumberValidator());Factory.addGetterSetter(Shape,'shadowOffsetY',0,getNumberValidator());Factory.addGetterSetter(Shape,'fillPatternImage');Factory.addGetterSetter(Shape,'fill',undefined,getStringOrGradientValidator());Factory.addGetterSetter(Shape,'fillPatternX',0,getNumberValidator());Factory.addGetterSetter(Shape,'fillPatternY',0,getNumberValidator());Factory.addGetterSetter(Shape,'fillLinearGradientColorStops');Factory.addGetterSetter(Shape,'strokeLinearGradientColorStops');Factory.addGetterSetter(Shape,'fillRadialGradientStartRadius',0);Factory.addGetterSetter(Shape,'fillRadialGradientEndRadius',0);Factory.addGetterSetter(Shape,'fillRadialGradientColorStops');Factory.addGetterSetter(Shape,'fillPatternRepeat','repeat');Factory.addGetterSetter(Shape,'fillEnabled',true);Factory.addGetterSetter(Shape,'strokeEnabled',true);Factory.addGetterSetter(Shape,'shadowEnabled',true);Factory.addGetterSetter(Shape,'dashEnabled',true);Factory.addGetterSetter(Shape,'strokeScaleEnabled',true);Factory.addGetterSetter(Shape,'fillPriority','color');Factory.addComponentsGetterSetter(Shape,'fillPatternOffset',['x','y']);Factory.addGetterSetter(Shape,'fillPatternOffsetX',0,getNumberValidator());Factory.addGetterSetter(Shape,'fillPatternOffsetY',0,getNumberValidator());Factory.addComponentsGetterSetter(Shape,'fillPatternScale',['x','y']);Factory.addGetterSetter(Shape,'fillPatternScaleX',1,getNumberValidator());Factory.addGetterSetter(Shape,'fillPatternScaleY',1,getNumberValidator());Factory.addComponentsGetterSetter(Shape,'fillLinearGradientStartPoint',['x','y',]);Factory.addComponentsGetterSetter(Shape,'strokeLinearGradientStartPoint',['x','y',]);Factory.addGetterSetter(Shape,'fillLinearGradientStartPointX',0);Factory.addGetterSetter(Shape,'strokeLinearGradientStartPointX',0);Factory.addGetterSetter(Shape,'fillLinearGradientStartPointY',0);Factory.addGetterSetter(Shape,'strokeLinearGradientStartPointY',0);Factory.addComponentsGetterSetter(Shape,'fillLinearGradientEndPoint',['x','y',]);Factory.addComponentsGetterSetter(Shape,'strokeLinearGradientEndPoint',['x','y',]);Factory.addGetterSetter(Shape,'fillLinearGradientEndPointX',0);Factory.addGetterSetter(Shape,'strokeLinearGradientEndPointX',0);Factory.addGetterSetter(Shape,'fillLinearGradientEndPointY',0);Factory.addGetterSetter(Shape,'strokeLinearGradientEndPointY',0);Factory.addComponentsGetterSetter(Shape,'fillRadialGradientStartPoint',['x','y',]);Factory.addGetterSetter(Shape,'fillRadialGradientStartPointX',0);Factory.addGetterSetter(Shape,'fillRadialGradientStartPointY',0);Factory.addComponentsGetterSetter(Shape,'fillRadialGradientEndPoint',['x','y',]);Factory.addGetterSetter(Shape,'fillRadialGradientEndPointX',0);Factory.addGetterSetter(Shape,'fillRadialGradientEndPointY',0);Factory.addGetterSetter(Shape,'fillPatternRotation',0);Factory.addGetterSetter(Shape,'fillRule',undefined,getStringValidator());Factory.backCompat(Shape,{dashArray:'dash',getDashArray:'getDash',setDashArray:'getDash',drawFunc:'sceneFunc',getDrawFunc:'getSceneFunc',setDrawFunc:'setSceneFunc',drawHitFunc:'hitFunc',getDrawHitFunc:'getHitFunc',setDrawHitFunc:'setHitFunc',});var HASH='#',BEFORE_DRAW='beforeDraw',DRAW='draw',INTERSECTION_OFFSETS=[{x:0,y:0},{x:-1,y:-1},{x:1,y:-1},{x:1,y:1},{x:-1,y:1},],INTERSECTION_OFFSETS_LEN=INTERSECTION_OFFSETS.length;class Layer extends Container{constructor(config){super(config);this.canvas=new SceneCanvas();this.hitCanvas=new HitCanvas({pixelRatio:1,});this._waitingForDraw=false;this.on('visibleChange.konva',this._checkVisibility);this._checkVisibility();this.on('imageSmoothingEnabledChange.konva',this._setSmoothEnabled);this._setSmoothEnabled();}
createPNGStream(){const c=this.canvas._canvas;return c.createPNGStream();}
getCanvas(){return this.canvas;}
getNativeCanvasElement(){return this.canvas._canvas;}
getHitCanvas(){return this.hitCanvas;}
getContext(){return this.getCanvas().getContext();}
clear(bounds){this.getContext().clear(bounds);this.getHitCanvas().getContext().clear(bounds);return this;}
setZIndex(index){super.setZIndex(index);var stage=this.getStage();if(stage&&stage.content){stage.content.removeChild(this.getNativeCanvasElement());if(index<stage.children.length-1){stage.content.insertBefore(this.getNativeCanvasElement(),stage.children[index+1].getCanvas()._canvas);}
else{stage.content.appendChild(this.getNativeCanvasElement());}}
return this;}
moveToTop(){Node.prototype.moveToTop.call(this);var stage=this.getStage();if(stage&&stage.content){stage.content.removeChild(this.getNativeCanvasElement());stage.content.appendChild(this.getNativeCanvasElement());}
return true;}
moveUp(){var moved=Node.prototype.moveUp.call(this);if(!moved){return false;}
var stage=this.getStage();if(!stage||!stage.content){return false;}
stage.content.removeChild(this.getNativeCanvasElement());if(this.index<stage.children.length-1){stage.content.insertBefore(this.getNativeCanvasElement(),stage.children[this.index+1].getCanvas()._canvas);}
else{stage.content.appendChild(this.getNativeCanvasElement());}
return true;}
moveDown(){if(Node.prototype.moveDown.call(this)){var stage=this.getStage();if(stage){var children=stage.children;if(stage.content){stage.content.removeChild(this.getNativeCanvasElement());stage.content.insertBefore(this.getNativeCanvasElement(),children[this.index+1].getCanvas()._canvas);}}
return true;}
return false;}
moveToBottom(){if(Node.prototype.moveToBottom.call(this)){var stage=this.getStage();if(stage){var children=stage.children;if(stage.content){stage.content.removeChild(this.getNativeCanvasElement());stage.content.insertBefore(this.getNativeCanvasElement(),children[1].getCanvas()._canvas);}}
return true;}
return false;}
getLayer(){return this;}
remove(){var _canvas=this.getNativeCanvasElement();Node.prototype.remove.call(this);if(_canvas&&_canvas.parentNode&&Util._isInDocument(_canvas)){_canvas.parentNode.removeChild(_canvas);}
return this;}
getStage(){return this.parent;}
setSize({width,height}){this.canvas.setSize(width,height);this.hitCanvas.setSize(width,height);this._setSmoothEnabled();return this;}
_validateAdd(child){var type=child.getType();if(type!=='Group'&&type!=='Shape'){Util.throw('You may only add groups and shapes to a layer.');}}
_toKonvaCanvas(config){config=config||{};config.width=config.width||this.getWidth();config.height=config.height||this.getHeight();config.x=config.x!==undefined?config.x:this.x();config.y=config.y!==undefined?config.y:this.y();return Node.prototype._toKonvaCanvas.call(this,config);}
_checkVisibility(){const visible=this.visible();if(visible){this.canvas._canvas.style.display='block';}
else{this.canvas._canvas.style.display='none';}}
_setSmoothEnabled(){this.getContext()._context.imageSmoothingEnabled=this.imageSmoothingEnabled();}
getWidth(){if(this.parent){return this.parent.width();}}
setWidth(){Util.warn('Can not change width of layer. Use "stage.width(value)" function instead.');}
getHeight(){if(this.parent){return this.parent.height();}}
setHeight(){Util.warn('Can not change height of layer. Use "stage.height(value)" function instead.');}
batchDraw(){if(!this._waitingForDraw){this._waitingForDraw=true;Util.requestAnimFrame(()=>{this.draw();this._waitingForDraw=false;});}
return this;}
getIntersection(pos){if(!this.isListening()||!this.isVisible()){return null;}
var spiralSearchDistance=1;var continueSearch=false;while(true){for(let i=0;i<INTERSECTION_OFFSETS_LEN;i++){const intersectionOffset=INTERSECTION_OFFSETS[i];const obj=this._getIntersection({x:pos.x+intersectionOffset.x*spiralSearchDistance,y:pos.y+intersectionOffset.y*spiralSearchDistance,});const shape=obj.shape;if(shape){return shape;}
continueSearch=!!obj.antialiased;if(!obj.antialiased){break;}}
if(continueSearch){spiralSearchDistance+=1;}
else{return null;}}}
_getIntersection(pos){const ratio=this.hitCanvas.pixelRatio;const p=this.hitCanvas.context.getImageData(Math.round(pos.x*ratio),Math.round(pos.y*ratio),1,1).data;const p3=p[3];if(p3===255){const colorKey=Util._rgbToHex(p[0],p[1],p[2]);const shape=shapes[HASH+colorKey];if(shape){return{shape:shape,};}
return{antialiased:true,};}
else if(p3>0){return{antialiased:true,};}
return{};}
drawScene(can,top){var layer=this.getLayer(),canvas=can||(layer&&layer.getCanvas());this._fire(BEFORE_DRAW,{node:this,});if(this.clearBeforeDraw()){canvas.getContext().clear();}
Container.prototype.drawScene.call(this,canvas,top);this._fire(DRAW,{node:this,});return this;}
drawHit(can,top){var layer=this.getLayer(),canvas=can||(layer&&layer.hitCanvas);if(layer&&layer.clearBeforeDraw()){layer.getHitCanvas().getContext().clear();}
Container.prototype.drawHit.call(this,canvas,top);return this;}
enableHitGraph(){this.hitGraphEnabled(true);return this;}
disableHitGraph(){this.hitGraphEnabled(false);return this;}
setHitGraphEnabled(val){Util.warn('hitGraphEnabled method is deprecated. Please use layer.listening() instead.');this.listening(val);}
getHitGraphEnabled(val){Util.warn('hitGraphEnabled method is deprecated. Please use layer.listening() instead.');return this.listening();}
toggleHitCanvas(){if(!this.parent||!this.parent['content']){return;}
var parent=this.parent;var added=!!this.hitCanvas._canvas.parentNode;if(added){parent.content.removeChild(this.hitCanvas._canvas);}
else{parent.content.appendChild(this.hitCanvas._canvas);}}
destroy(){Util.releaseCanvas(this.getNativeCanvasElement(),this.getHitCanvas()._canvas);return super.destroy();}}
Layer.prototype.nodeType='Layer';_registerNode(Layer);Factory.addGetterSetter(Layer,'imageSmoothingEnabled',true);Factory.addGetterSetter(Layer,'clearBeforeDraw',true);Factory.addGetterSetter(Layer,'hitGraphEnabled',true,getBooleanValidator());class FastLayer extends Layer{constructor(attrs){super(attrs);this.listening(false);Util.warn('Konva.Fast layer is deprecated. Please use "new Konva.Layer({ listening: false })" instead.');}}
FastLayer.prototype.nodeType='FastLayer';_registerNode(FastLayer);class Group extends Container{_validateAdd(child){var type=child.getType();if(type!=='Group'&&type!=='Shape'){Util.throw('You may only add groups and shapes to groups.');}}}
Group.prototype.nodeType='Group';_registerNode(Group);const now=(function(){if(glob.performance&&glob.performance.now){return function(){return glob.performance.now();};}
return function(){return new Date().getTime();};})();class Animation{constructor(func,layers){this.id=Animation.animIdCounter++;this.frame={time:0,timeDiff:0,lastTime:now(),frameRate:0,};this.func=func;this.setLayers(layers);}
setLayers(layers){let lays=[];if(layers){lays=Array.isArray(layers)?layers:[layers];}
this.layers=lays;return this;}
getLayers(){return this.layers;}
addLayer(layer){const layers=this.layers;const len=layers.length;for(let n=0;n<len;n++){if(layers[n]._id===layer._id){return false;}}
this.layers.push(layer);return true;}
isRunning(){const a=Animation;const animations=a.animations;const len=animations.length;for(let n=0;n<len;n++){if(animations[n].id===this.id){return true;}}
return false;}
start(){this.stop();this.frame.timeDiff=0;this.frame.lastTime=now();Animation._addAnimation(this);return this;}
stop(){Animation._removeAnimation(this);return this;}
_updateFrameObject(time){this.frame.timeDiff=time-this.frame.lastTime;this.frame.lastTime=time;this.frame.time+=this.frame.timeDiff;this.frame.frameRate=1000/this.frame.timeDiff;}
static _addAnimation(anim){this.animations.push(anim);this._handleAnimation();}
static _removeAnimation(anim){const id=anim.id;const animations=this.animations;const len=animations.length;for(let n=0;n<len;n++){if(animations[n].id===id){this.animations.splice(n,1);break;}}}
static _runFrames(){const layerHash={};const animations=this.animations;for(let n=0;n<animations.length;n++){const anim=animations[n];const layers=anim.layers;const func=anim.func;anim._updateFrameObject(now());const layersLen=layers.length;let needRedraw;if(func){needRedraw=func.call(anim,anim.frame)!==false;}
else{needRedraw=true;}
if(!needRedraw){continue;}
for(let i=0;i<layersLen;i++){const layer=layers[i];if(layer._id!==undefined){layerHash[layer._id]=layer;}}}
for(let key in layerHash){if(!layerHash.hasOwnProperty(key)){continue;}
layerHash[key].batchDraw();}}
static _animationLoop(){const Anim=Animation;if(Anim.animations.length){Anim._runFrames();Util.requestAnimFrame(Anim._animationLoop);}
else{Anim.animRunning=false;}}
static _handleAnimation(){if(!this.animRunning){this.animRunning=true;Util.requestAnimFrame(this._animationLoop);}}}
Animation.animations=[];Animation.animIdCounter=0;Animation.animRunning=false;var blacklist={node:1,duration:1,easing:1,onFinish:1,yoyo:1,},PAUSED=1,PLAYING=2,REVERSING=3,idCounter=0,colorAttrs=['fill','stroke','shadowColor'];class TweenEngine{constructor(prop,propFunc,func,begin,finish,duration,yoyo){this.prop=prop;this.propFunc=propFunc;this.begin=begin;this._pos=begin;this.duration=duration;this._change=0;this.prevPos=0;this.yoyo=yoyo;this._time=0;this._position=0;this._startTime=0;this._finish=0;this.func=func;this._change=finish-this.begin;this.pause();}
fire(str){var handler=this[str];if(handler){handler();}}
setTime(t){if(t>this.duration){if(this.yoyo){this._time=this.duration;this.reverse();}
else{this.finish();}}
else if(t<0){if(this.yoyo){this._time=0;this.play();}
else{this.reset();}}
else{this._time=t;this.update();}}
getTime(){return this._time;}
setPosition(p){this.prevPos=this._pos;this.propFunc(p);this._pos=p;}
getPosition(t){if(t===undefined){t=this._time;}
return this.func(t,this.begin,this._change,this.duration);}
play(){this.state=PLAYING;this._startTime=this.getTimer()-this._time;this.onEnterFrame();this.fire('onPlay');}
reverse(){this.state=REVERSING;this._time=this.duration-this._time;this._startTime=this.getTimer()-this._time;this.onEnterFrame();this.fire('onReverse');}
seek(t){this.pause();this._time=t;this.update();this.fire('onSeek');}
reset(){this.pause();this._time=0;this.update();this.fire('onReset');}
finish(){this.pause();this._time=this.duration;this.update();this.fire('onFinish');}
update(){this.setPosition(this.getPosition(this._time));this.fire('onUpdate');}
onEnterFrame(){var t=this.getTimer()-this._startTime;if(this.state===PLAYING){this.setTime(t);}
else if(this.state===REVERSING){this.setTime(this.duration-t);}}
pause(){this.state=PAUSED;this.fire('onPause');}
getTimer(){return new Date().getTime();}}
class Tween{constructor(config){var that=this,node=config.node,nodeId=node._id,duration,easing=config.easing||Easings.Linear,yoyo=!!config.yoyo,key;if(typeof config.duration==='undefined'){duration=0.3;}
else if(config.duration===0){duration=0.001;}
else{duration=config.duration;}
this.node=node;this._id=idCounter++;var layers=node.getLayer()||(node instanceof Konva$2['Stage']?node.getLayers():null);if(!layers){Util.error('Tween constructor have `node` that is not in a layer. Please add node into layer first.');}
this.anim=new Animation(function(){that.tween.onEnterFrame();},layers);this.tween=new TweenEngine(key,function(i){that._tweenFunc(i);},easing,0,1,duration*1000,yoyo);this._addListeners();if(!Tween.attrs[nodeId]){Tween.attrs[nodeId]={};}
if(!Tween.attrs[nodeId][this._id]){Tween.attrs[nodeId][this._id]={};}
if(!Tween.tweens[nodeId]){Tween.tweens[nodeId]={};}
for(key in config){if(blacklist[key]===undefined){this._addAttr(key,config[key]);}}
this.reset();this.onFinish=config.onFinish;this.onReset=config.onReset;this.onUpdate=config.onUpdate;}
_addAttr(key,end){var node=this.node,nodeId=node._id,start,diff,tweenId,n,len,trueEnd,trueStart,endRGBA;tweenId=Tween.tweens[nodeId][key];if(tweenId){delete Tween.attrs[nodeId][tweenId][key];}
start=node.getAttr(key);if(Util._isArray(end)){diff=[];len=Math.max(end.length,start.length);if(key==='points'&&end.length!==start.length){if(end.length>start.length){trueStart=start;start=Util._prepareArrayForTween(start,end,node.closed());}
else{trueEnd=end;end=Util._prepareArrayForTween(end,start,node.closed());}}
if(key.indexOf('fill')===0){for(n=0;n<len;n++){if(n%2===0){diff.push(end[n]-start[n]);}
else{var startRGBA=Util.colorToRGBA(start[n]);endRGBA=Util.colorToRGBA(end[n]);start[n]=startRGBA;diff.push({r:endRGBA.r-startRGBA.r,g:endRGBA.g-startRGBA.g,b:endRGBA.b-startRGBA.b,a:endRGBA.a-startRGBA.a,});}}}
else{for(n=0;n<len;n++){diff.push(end[n]-start[n]);}}}
else if(colorAttrs.indexOf(key)!==-1){start=Util.colorToRGBA(start);endRGBA=Util.colorToRGBA(end);diff={r:endRGBA.r-start.r,g:endRGBA.g-start.g,b:endRGBA.b-start.b,a:endRGBA.a-start.a,};}
else{diff=end-start;}
Tween.attrs[nodeId][this._id][key]={start:start,diff:diff,end:end,trueEnd:trueEnd,trueStart:trueStart,};Tween.tweens[nodeId][key]=this._id;}
_tweenFunc(i){var node=this.node,attrs=Tween.attrs[node._id][this._id],key,attr,start,diff,newVal,n,len,end;for(key in attrs){attr=attrs[key];start=attr.start;diff=attr.diff;end=attr.end;if(Util._isArray(start)){newVal=[];len=Math.max(start.length,end.length);if(key.indexOf('fill')===0){for(n=0;n<len;n++){if(n%2===0){newVal.push((start[n]||0)+diff[n]*i);}
else{newVal.push('rgba('+
Math.round(start[n].r+diff[n].r*i)+','+
Math.round(start[n].g+diff[n].g*i)+','+
Math.round(start[n].b+diff[n].b*i)+','+
(start[n].a+diff[n].a*i)+')');}}}
else{for(n=0;n<len;n++){newVal.push((start[n]||0)+diff[n]*i);}}}
else if(colorAttrs.indexOf(key)!==-1){newVal='rgba('+
Math.round(start.r+diff.r*i)+','+
Math.round(start.g+diff.g*i)+','+
Math.round(start.b+diff.b*i)+','+
(start.a+diff.a*i)+')';}
else{newVal=start+diff*i;}
node.setAttr(key,newVal);}}
_addListeners(){this.tween.onPlay=()=>{this.anim.start();};this.tween.onReverse=()=>{this.anim.start();};this.tween.onPause=()=>{this.anim.stop();};this.tween.onFinish=()=>{var node=this.node;var attrs=Tween.attrs[node._id][this._id];if(attrs.points&&attrs.points.trueEnd){node.setAttr('points',attrs.points.trueEnd);}
if(this.onFinish){this.onFinish.call(this);}};this.tween.onReset=()=>{var node=this.node;var attrs=Tween.attrs[node._id][this._id];if(attrs.points&&attrs.points.trueStart){node.points(attrs.points.trueStart);}
if(this.onReset){this.onReset();}};this.tween.onUpdate=()=>{if(this.onUpdate){this.onUpdate.call(this);}};}
play(){this.tween.play();return this;}
reverse(){this.tween.reverse();return this;}
reset(){this.tween.reset();return this;}
seek(t){this.tween.seek(t*1000);return this;}
pause(){this.tween.pause();return this;}
finish(){this.tween.finish();return this;}
destroy(){var nodeId=this.node._id,thisId=this._id,attrs=Tween.tweens[nodeId],key;this.pause();for(key in attrs){delete Tween.tweens[nodeId][key];}
delete Tween.attrs[nodeId][thisId];}}
Tween.attrs={};Tween.tweens={};Node.prototype.to=function(params){var onFinish=params.onFinish;params.node=this;params.onFinish=function(){this.destroy();if(onFinish){onFinish();}};var tween=new Tween(params);tween.play();};const Easings={BackEaseIn(t,b,c,d){var s=1.70158;return c*(t/=d)*t*((s+1)*t-s)+b;},BackEaseOut(t,b,c,d){var s=1.70158;return c*((t=t/d-1)*t*((s+1)*t+s)+1)+b;},BackEaseInOut(t,b,c,d){var s=1.70158;if((t/=d/2)<1){return(c/2)*(t*t*(((s*=1.525)+1)*t-s))+b;}
return(c/2)*((t-=2)*t*(((s*=1.525)+1)*t+s)+2)+b;},ElasticEaseIn(t,b,c,d,a,p){var s=0;if(t===0){return b;}
if((t/=d)===1){return b+c;}
if(!p){p=d*0.3;}
if(!a||a<Math.abs(c)){a=c;s=p/4;}
else{s=(p/(2*Math.PI))*Math.asin(c/a);}
return(-(a*Math.pow(2,10*(t-=1))*Math.sin(((t*d-s)*(2*Math.PI))/p))+b);},ElasticEaseOut(t,b,c,d,a,p){var s=0;if(t===0){return b;}
if((t/=d)===1){return b+c;}
if(!p){p=d*0.3;}
if(!a||a<Math.abs(c)){a=c;s=p/4;}
else{s=(p/(2*Math.PI))*Math.asin(c/a);}
return(a*Math.pow(2,-10*t)*Math.sin(((t*d-s)*(2*Math.PI))/p)+
c+
b);},ElasticEaseInOut(t,b,c,d,a,p){var s=0;if(t===0){return b;}
if((t/=d/2)===2){return b+c;}
if(!p){p=d*(0.3*1.5);}
if(!a||a<Math.abs(c)){a=c;s=p/4;}
else{s=(p/(2*Math.PI))*Math.asin(c/a);}
if(t<1){return(-0.5*(a*Math.pow(2,10*(t-=1))*Math.sin(((t*d-s)*(2*Math.PI))/p))+
b);}
return(a*Math.pow(2,-10*(t-=1))*Math.sin(((t*d-s)*(2*Math.PI))/p)*0.5+
c+
b);},BounceEaseOut(t,b,c,d){if((t/=d)<1/2.75){return c*(7.5625*t*t)+b;}
else if(t<2/2.75){return c*(7.5625*(t-=1.5/2.75)*t+0.75)+b;}
else if(t<2.5/2.75){return c*(7.5625*(t-=2.25/2.75)*t+0.9375)+b;}
else{return c*(7.5625*(t-=2.625/2.75)*t+0.984375)+b;}},BounceEaseIn(t,b,c,d){return c-Easings.BounceEaseOut(d-t,0,c,d)+b;},BounceEaseInOut(t,b,c,d){if(t<d/2){return Easings.BounceEaseIn(t*2,0,c,d)*0.5+b;}
else{return Easings.BounceEaseOut(t*2-d,0,c,d)*0.5+c*0.5+b;}},EaseIn(t,b,c,d){return c*(t/=d)*t+b;},EaseOut(t,b,c,d){return-c*(t/=d)*(t-2)+b;},EaseInOut(t,b,c,d){if((t/=d/2)<1){return(c/2)*t*t+b;}
return(-c/2)*(--t*(t-2)-1)+b;},StrongEaseIn(t,b,c,d){return c*(t/=d)*t*t*t*t+b;},StrongEaseOut(t,b,c,d){return c*((t=t/d-1)*t*t*t*t+1)+b;},StrongEaseInOut(t,b,c,d){if((t/=d/2)<1){return(c/2)*t*t*t*t*t+b;}
return(c/2)*((t-=2)*t*t*t*t+2)+b;},Linear(t,b,c,d){return(c*t)/d+b;},};const Konva$1=Util._assign(Konva$2,{Util,Transform,Node,Container,Stage,stages,Layer,FastLayer,Group,DD,Shape,shapes,Animation,Tween,Easings,Context,Canvas,});class Arc extends Shape{_sceneFunc(context){var angle=Konva$2.getAngle(this.angle()),clockwise=this.clockwise();context.beginPath();context.arc(0,0,this.outerRadius(),0,angle,clockwise);context.arc(0,0,this.innerRadius(),angle,0,!clockwise);context.closePath();context.fillStrokeShape(this);}
getWidth(){return this.outerRadius()*2;}
getHeight(){return this.outerRadius()*2;}
setWidth(width){this.outerRadius(width/2);}
setHeight(height){this.outerRadius(height/2);}
getSelfRect(){const innerRadius=this.innerRadius();const outerRadius=this.outerRadius();const clockwise=this.clockwise();const angle=Konva$2.getAngle(clockwise?360-this.angle():this.angle());const boundLeftRatio=Math.cos(Math.min(angle,Math.PI));const boundRightRatio=1;const boundTopRatio=Math.sin(Math.min(Math.max(Math.PI,angle),(3*Math.PI)/2));const boundBottomRatio=Math.sin(Math.min(angle,Math.PI/2));const boundLeft=boundLeftRatio*(boundLeftRatio>0?innerRadius:outerRadius);const boundRight=boundRightRatio*(outerRadius);const boundTop=boundTopRatio*(boundTopRatio>0?innerRadius:outerRadius);const boundBottom=boundBottomRatio*(boundBottomRatio>0?outerRadius:innerRadius);return{x:boundLeft,y:clockwise?-1*boundBottom:boundTop,width:boundRight-boundLeft,height:boundBottom-boundTop,};}}
Arc.prototype._centroid=true;Arc.prototype.className='Arc';Arc.prototype._attrsAffectingSize=['innerRadius','outerRadius'];_registerNode(Arc);Factory.addGetterSetter(Arc,'innerRadius',0,getNumberValidator());Factory.addGetterSetter(Arc,'outerRadius',0,getNumberValidator());Factory.addGetterSetter(Arc,'angle',0,getNumberValidator());Factory.addGetterSetter(Arc,'clockwise',false,getBooleanValidator());function getControlPoints(x0,y0,x1,y1,x2,y2,t){var d01=Math.sqrt(Math.pow(x1-x0,2)+Math.pow(y1-y0,2)),d12=Math.sqrt(Math.pow(x2-x1,2)+Math.pow(y2-y1,2)),fa=(t*d01)/(d01+d12),fb=(t*d12)/(d01+d12),p1x=x1-fa*(x2-x0),p1y=y1-fa*(y2-y0),p2x=x1+fb*(x2-x0),p2y=y1+fb*(y2-y0);return[p1x,p1y,p2x,p2y];}
function expandPoints(p,tension){var len=p.length,allPoints=[],n,cp;for(n=2;n<len-2;n+=2){cp=getControlPoints(p[n-2],p[n-1],p[n],p[n+1],p[n+2],p[n+3],tension);if(isNaN(cp[0])){continue;}
allPoints.push(cp[0]);allPoints.push(cp[1]);allPoints.push(p[n]);allPoints.push(p[n+1]);allPoints.push(cp[2]);allPoints.push(cp[3]);}
return allPoints;}
class Line extends Shape{constructor(config){super(config);this.on('pointsChange.konva tensionChange.konva closedChange.konva bezierChange.konva',function(){this._clearCache('tensionPoints');});}
_sceneFunc(context){var points=this.points(),length=points.length,tension=this.tension(),closed=this.closed(),bezier=this.bezier(),tp,len,n;if(!length){return;}
context.beginPath();context.moveTo(points[0],points[1]);if(tension!==0&&length>4){tp=this.getTensionPoints();len=tp.length;n=closed?0:4;if(!closed){context.quadraticCurveTo(tp[0],tp[1],tp[2],tp[3]);}
while(n<len-2){context.bezierCurveTo(tp[n++],tp[n++],tp[n++],tp[n++],tp[n++],tp[n++]);}
if(!closed){context.quadraticCurveTo(tp[len-2],tp[len-1],points[length-2],points[length-1]);}}
else if(bezier){n=2;while(n<length){context.bezierCurveTo(points[n++],points[n++],points[n++],points[n++],points[n++],points[n++]);}}
else{for(n=2;n<length;n+=2){context.lineTo(points[n],points[n+1]);}}
if(closed){context.closePath();context.fillStrokeShape(this);}
else{context.strokeShape(this);}}
getTensionPoints(){return this._getCache('tensionPoints',this._getTensionPoints);}
_getTensionPoints(){if(this.closed()){return this._getTensionPointsClosed();}
else{return expandPoints(this.points(),this.tension());}}
_getTensionPointsClosed(){var p=this.points(),len=p.length,tension=this.tension(),firstControlPoints=getControlPoints(p[len-2],p[len-1],p[0],p[1],p[2],p[3],tension),lastControlPoints=getControlPoints(p[len-4],p[len-3],p[len-2],p[len-1],p[0],p[1],tension),middle=expandPoints(p,tension),tp=[firstControlPoints[2],firstControlPoints[3]].concat(middle).concat([lastControlPoints[0],lastControlPoints[1],p[len-2],p[len-1],lastControlPoints[2],lastControlPoints[3],firstControlPoints[0],firstControlPoints[1],p[0],p[1],]);return tp;}
getWidth(){return this.getSelfRect().width;}
getHeight(){return this.getSelfRect().height;}
getSelfRect(){var points=this.points();if(points.length<4){return{x:points[0]||0,y:points[1]||0,width:0,height:0,};}
if(this.tension()!==0){points=[points[0],points[1],...this._getTensionPoints(),points[points.length-2],points[points.length-1],];}
else{points=this.points();}
var minX=points[0];var maxX=points[0];var minY=points[1];var maxY=points[1];var x,y;for(var i=0;i<points.length/2;i++){x=points[i*2];y=points[i*2+1];minX=Math.min(minX,x);maxX=Math.max(maxX,x);minY=Math.min(minY,y);maxY=Math.max(maxY,y);}
return{x:minX,y:minY,width:maxX-minX,height:maxY-minY,};}}
Line.prototype.className='Line';Line.prototype._attrsAffectingSize=['points','bezier','tension'];_registerNode(Line);Factory.addGetterSetter(Line,'closed',false);Factory.addGetterSetter(Line,'bezier',false);Factory.addGetterSetter(Line,'tension',0,getNumberValidator());Factory.addGetterSetter(Line,'points',[],getNumberArrayValidator());const tValues=[[],[],[-0.5773502691896257645091487805019574556476,0.5773502691896257645091487805019574556476,],[0,-0.7745966692414833770358530799564799221665,0.7745966692414833770358530799564799221665,],[-0.3399810435848562648026657591032446872005,0.3399810435848562648026657591032446872005,-0.8611363115940525752239464888928095050957,0.8611363115940525752239464888928095050957,],[0,-0.5384693101056830910363144207002088049672,0.5384693101056830910363144207002088049672,-0.9061798459386639927976268782993929651256,0.9061798459386639927976268782993929651256,],[0.6612093864662645136613995950199053470064,-0.6612093864662645136613995950199053470064,-0.2386191860831969086305017216807119354186,0.2386191860831969086305017216807119354186,-0.9324695142031520278123015544939946091347,0.9324695142031520278123015544939946091347,],[0,0.4058451513773971669066064120769614633473,-0.4058451513773971669066064120769614633473,-0.7415311855993944398638647732807884070741,0.7415311855993944398638647732807884070741,-0.9491079123427585245261896840478512624007,0.9491079123427585245261896840478512624007,],[-0.1834346424956498049394761423601839806667,0.1834346424956498049394761423601839806667,-0.5255324099163289858177390491892463490419,0.5255324099163289858177390491892463490419,-0.7966664774136267395915539364758304368371,0.7966664774136267395915539364758304368371,-0.9602898564975362316835608685694729904282,0.9602898564975362316835608685694729904282,],[0,-0.8360311073266357942994297880697348765441,0.8360311073266357942994297880697348765441,-0.9681602395076260898355762029036728700494,0.9681602395076260898355762029036728700494,-0.3242534234038089290385380146433366085719,0.3242534234038089290385380146433366085719,-0.6133714327005903973087020393414741847857,0.6133714327005903973087020393414741847857,],[-0.1488743389816312108848260011297199846175,0.1488743389816312108848260011297199846175,-0.4333953941292471907992659431657841622,0.4333953941292471907992659431657841622,-0.6794095682990244062343273651148735757692,0.6794095682990244062343273651148735757692,-0.8650633666889845107320966884234930485275,0.8650633666889845107320966884234930485275,-0.9739065285171717200779640120844520534282,0.9739065285171717200779640120844520534282,],[0,-0.2695431559523449723315319854008615246796,0.2695431559523449723315319854008615246796,-0.5190961292068118159257256694586095544802,0.5190961292068118159257256694586095544802,-0.7301520055740493240934162520311534580496,0.7301520055740493240934162520311534580496,-0.8870625997680952990751577693039272666316,0.8870625997680952990751577693039272666316,-0.9782286581460569928039380011228573907714,0.9782286581460569928039380011228573907714,],[-0.1252334085114689154724413694638531299833,0.1252334085114689154724413694638531299833,-0.3678314989981801937526915366437175612563,0.3678314989981801937526915366437175612563,-0.587317954286617447296702418940534280369,0.587317954286617447296702418940534280369,-0.7699026741943046870368938332128180759849,0.7699026741943046870368938332128180759849,-0.9041172563704748566784658661190961925375,0.9041172563704748566784658661190961925375,-0.9815606342467192506905490901492808229601,0.9815606342467192506905490901492808229601,],[0,-0.2304583159551347940655281210979888352115,0.2304583159551347940655281210979888352115,-0.4484927510364468528779128521276398678019,0.4484927510364468528779128521276398678019,-0.6423493394403402206439846069955156500716,0.6423493394403402206439846069955156500716,-0.8015780907333099127942064895828598903056,0.8015780907333099127942064895828598903056,-0.9175983992229779652065478365007195123904,0.9175983992229779652065478365007195123904,-0.9841830547185881494728294488071096110649,0.9841830547185881494728294488071096110649,],[-0.1080549487073436620662446502198347476119,0.1080549487073436620662446502198347476119,-0.3191123689278897604356718241684754668342,0.3191123689278897604356718241684754668342,-0.5152486363581540919652907185511886623088,0.5152486363581540919652907185511886623088,-0.6872929048116854701480198030193341375384,0.6872929048116854701480198030193341375384,-0.8272013150697649931897947426503949610397,0.8272013150697649931897947426503949610397,-0.928434883663573517336391139377874264477,0.928434883663573517336391139377874264477,-0.986283808696812338841597266704052801676,0.986283808696812338841597266704052801676,],[0,-0.2011940939974345223006283033945962078128,0.2011940939974345223006283033945962078128,-0.3941513470775633698972073709810454683627,0.3941513470775633698972073709810454683627,-0.5709721726085388475372267372539106412383,0.5709721726085388475372267372539106412383,-0.7244177313601700474161860546139380096308,0.7244177313601700474161860546139380096308,-0.8482065834104272162006483207742168513662,0.8482065834104272162006483207742168513662,-0.9372733924007059043077589477102094712439,0.9372733924007059043077589477102094712439,-0.9879925180204854284895657185866125811469,0.9879925180204854284895657185866125811469,],[-0.0950125098376374401853193354249580631303,0.0950125098376374401853193354249580631303,-0.281603550779258913230460501460496106486,0.281603550779258913230460501460496106486,-0.45801677765722738634241944298357757354,0.45801677765722738634241944298357757354,-0.6178762444026437484466717640487910189918,0.6178762444026437484466717640487910189918,-0.7554044083550030338951011948474422683538,0.7554044083550030338951011948474422683538,-0.8656312023878317438804678977123931323873,0.8656312023878317438804678977123931323873,-0.9445750230732325760779884155346083450911,0.9445750230732325760779884155346083450911,-0.9894009349916499325961541734503326274262,0.9894009349916499325961541734503326274262,],[0,-0.1784841814958478558506774936540655574754,0.1784841814958478558506774936540655574754,-0.3512317634538763152971855170953460050405,0.3512317634538763152971855170953460050405,-0.5126905370864769678862465686295518745829,0.5126905370864769678862465686295518745829,-0.6576711592166907658503022166430023351478,0.6576711592166907658503022166430023351478,-0.7815140038968014069252300555204760502239,0.7815140038968014069252300555204760502239,-0.8802391537269859021229556944881556926234,0.8802391537269859021229556944881556926234,-0.9506755217687677612227169578958030214433,0.9506755217687677612227169578958030214433,-0.9905754753144173356754340199406652765077,0.9905754753144173356754340199406652765077,],[-0.0847750130417353012422618529357838117333,0.0847750130417353012422618529357838117333,-0.2518862256915055095889728548779112301628,0.2518862256915055095889728548779112301628,-0.4117511614628426460359317938330516370789,0.4117511614628426460359317938330516370789,-0.5597708310739475346078715485253291369276,0.5597708310739475346078715485253291369276,-0.6916870430603532078748910812888483894522,0.6916870430603532078748910812888483894522,-0.8037049589725231156824174550145907971032,0.8037049589725231156824174550145907971032,-0.8926024664975557392060605911271455154078,0.8926024664975557392060605911271455154078,-0.9558239495713977551811958929297763099728,0.9558239495713977551811958929297763099728,-0.9915651684209309467300160047061507702525,0.9915651684209309467300160047061507702525,],[0,-0.1603586456402253758680961157407435495048,0.1603586456402253758680961157407435495048,-0.3165640999636298319901173288498449178922,0.3165640999636298319901173288498449178922,-0.4645707413759609457172671481041023679762,0.4645707413759609457172671481041023679762,-0.6005453046616810234696381649462392798683,0.6005453046616810234696381649462392798683,-0.7209661773352293786170958608237816296571,0.7209661773352293786170958608237816296571,-0.8227146565371428249789224867127139017745,0.8227146565371428249789224867127139017745,-0.9031559036148179016426609285323124878093,0.9031559036148179016426609285323124878093,-0.960208152134830030852778840687651526615,0.960208152134830030852778840687651526615,-0.9924068438435844031890176702532604935893,0.9924068438435844031890176702532604935893,],[-0.0765265211334973337546404093988382110047,0.0765265211334973337546404093988382110047,-0.227785851141645078080496195368574624743,0.227785851141645078080496195368574624743,-0.3737060887154195606725481770249272373957,0.3737060887154195606725481770249272373957,-0.5108670019508270980043640509552509984254,0.5108670019508270980043640509552509984254,-0.6360536807265150254528366962262859367433,0.6360536807265150254528366962262859367433,-0.7463319064601507926143050703556415903107,0.7463319064601507926143050703556415903107,-0.8391169718222188233945290617015206853296,0.8391169718222188233945290617015206853296,-0.9122344282513259058677524412032981130491,0.9122344282513259058677524412032981130491,-0.963971927277913791267666131197277221912,0.963971927277913791267666131197277221912,-0.9931285991850949247861223884713202782226,0.9931285991850949247861223884713202782226,],[0,-0.1455618541608950909370309823386863301163,0.1455618541608950909370309823386863301163,-0.288021316802401096600792516064600319909,0.288021316802401096600792516064600319909,-0.4243421202074387835736688885437880520964,0.4243421202074387835736688885437880520964,-0.551618835887219807059018796724313286622,0.551618835887219807059018796724313286622,-0.667138804197412319305966669990339162597,0.667138804197412319305966669990339162597,-0.7684399634756779086158778513062280348209,0.7684399634756779086158778513062280348209,-0.8533633645833172836472506385875676702761,0.8533633645833172836472506385875676702761,-0.9200993341504008287901871337149688941591,0.9200993341504008287901871337149688941591,-0.9672268385663062943166222149076951614246,0.9672268385663062943166222149076951614246,-0.9937521706203895002602420359379409291933,0.9937521706203895002602420359379409291933,],[-0.0697392733197222212138417961186280818222,0.0697392733197222212138417961186280818222,-0.2078604266882212854788465339195457342156,0.2078604266882212854788465339195457342156,-0.3419358208920842251581474204273796195591,0.3419358208920842251581474204273796195591,-0.4693558379867570264063307109664063460953,0.4693558379867570264063307109664063460953,-0.5876404035069115929588769276386473488776,0.5876404035069115929588769276386473488776,-0.6944872631866827800506898357622567712673,0.6944872631866827800506898357622567712673,-0.7878168059792081620042779554083515213881,0.7878168059792081620042779554083515213881,-0.8658125777203001365364256370193787290847,0.8658125777203001365364256370193787290847,-0.9269567721871740005206929392590531966353,0.9269567721871740005206929392590531966353,-0.9700604978354287271239509867652687108059,0.9700604978354287271239509867652687108059,-0.994294585482399292073031421161298980393,0.994294585482399292073031421161298980393,],[0,-0.1332568242984661109317426822417661370104,0.1332568242984661109317426822417661370104,-0.264135680970344930533869538283309602979,0.264135680970344930533869538283309602979,-0.390301038030290831421488872880605458578,0.390301038030290831421488872880605458578,-0.5095014778460075496897930478668464305448,0.5095014778460075496897930478668464305448,-0.6196098757636461563850973116495956533871,0.6196098757636461563850973116495956533871,-0.7186613631319501944616244837486188483299,0.7186613631319501944616244837486188483299,-0.8048884016188398921511184069967785579414,0.8048884016188398921511184069967785579414,-0.8767523582704416673781568859341456716389,0.8767523582704416673781568859341456716389,-0.9329710868260161023491969890384229782357,0.9329710868260161023491969890384229782357,-0.9725424712181152319560240768207773751816,0.9725424712181152319560240768207773751816,-0.9947693349975521235239257154455743605736,0.9947693349975521235239257154455743605736,],[-0.0640568928626056260850430826247450385909,0.0640568928626056260850430826247450385909,-0.1911188674736163091586398207570696318404,0.1911188674736163091586398207570696318404,-0.3150426796961633743867932913198102407864,0.3150426796961633743867932913198102407864,-0.4337935076260451384870842319133497124524,0.4337935076260451384870842319133497124524,-0.5454214713888395356583756172183723700107,0.5454214713888395356583756172183723700107,-0.6480936519369755692524957869107476266696,0.6480936519369755692524957869107476266696,-0.7401241915785543642438281030999784255232,0.7401241915785543642438281030999784255232,-0.8200019859739029219539498726697452080761,0.8200019859739029219539498726697452080761,-0.8864155270044010342131543419821967550873,0.8864155270044010342131543419821967550873,-0.9382745520027327585236490017087214496548,0.9382745520027327585236490017087214496548,-0.9747285559713094981983919930081690617411,0.9747285559713094981983919930081690617411,-0.9951872199970213601799974097007368118745,0.9951872199970213601799974097007368118745,],];const cValues=[[],[],[1.0,1.0],[0.8888888888888888888888888888888888888888,0.5555555555555555555555555555555555555555,0.5555555555555555555555555555555555555555,],[0.6521451548625461426269360507780005927646,0.6521451548625461426269360507780005927646,0.3478548451374538573730639492219994072353,0.3478548451374538573730639492219994072353,],[0.5688888888888888888888888888888888888888,0.4786286704993664680412915148356381929122,0.4786286704993664680412915148356381929122,0.2369268850561890875142640407199173626432,0.2369268850561890875142640407199173626432,],[0.3607615730481386075698335138377161116615,0.3607615730481386075698335138377161116615,0.4679139345726910473898703439895509948116,0.4679139345726910473898703439895509948116,0.1713244923791703450402961421727328935268,0.1713244923791703450402961421727328935268,],[0.4179591836734693877551020408163265306122,0.3818300505051189449503697754889751338783,0.3818300505051189449503697754889751338783,0.2797053914892766679014677714237795824869,0.2797053914892766679014677714237795824869,0.1294849661688696932706114326790820183285,0.1294849661688696932706114326790820183285,],[0.3626837833783619829651504492771956121941,0.3626837833783619829651504492771956121941,0.3137066458778872873379622019866013132603,0.3137066458778872873379622019866013132603,0.2223810344533744705443559944262408844301,0.2223810344533744705443559944262408844301,0.1012285362903762591525313543099621901153,0.1012285362903762591525313543099621901153,],[0.3302393550012597631645250692869740488788,0.1806481606948574040584720312429128095143,0.1806481606948574040584720312429128095143,0.0812743883615744119718921581105236506756,0.0812743883615744119718921581105236506756,0.3123470770400028400686304065844436655987,0.3123470770400028400686304065844436655987,0.2606106964029354623187428694186328497718,0.2606106964029354623187428694186328497718,],[0.295524224714752870173892994651338329421,0.295524224714752870173892994651338329421,0.2692667193099963550912269215694693528597,0.2692667193099963550912269215694693528597,0.2190863625159820439955349342281631924587,0.2190863625159820439955349342281631924587,0.1494513491505805931457763396576973324025,0.1494513491505805931457763396576973324025,0.0666713443086881375935688098933317928578,0.0666713443086881375935688098933317928578,],[0.272925086777900630714483528336342189156,0.2628045445102466621806888698905091953727,0.2628045445102466621806888698905091953727,0.2331937645919904799185237048431751394317,0.2331937645919904799185237048431751394317,0.1862902109277342514260976414316558916912,0.1862902109277342514260976414316558916912,0.1255803694649046246346942992239401001976,0.1255803694649046246346942992239401001976,0.0556685671161736664827537204425485787285,0.0556685671161736664827537204425485787285,],[0.2491470458134027850005624360429512108304,0.2491470458134027850005624360429512108304,0.2334925365383548087608498989248780562594,0.2334925365383548087608498989248780562594,0.2031674267230659217490644558097983765065,0.2031674267230659217490644558097983765065,0.160078328543346226334652529543359071872,0.160078328543346226334652529543359071872,0.1069393259953184309602547181939962242145,0.1069393259953184309602547181939962242145,0.047175336386511827194615961485017060317,0.047175336386511827194615961485017060317,],[0.2325515532308739101945895152688359481566,0.2262831802628972384120901860397766184347,0.2262831802628972384120901860397766184347,0.2078160475368885023125232193060527633865,0.2078160475368885023125232193060527633865,0.1781459807619457382800466919960979955128,0.1781459807619457382800466919960979955128,0.1388735102197872384636017768688714676218,0.1388735102197872384636017768688714676218,0.0921214998377284479144217759537971209236,0.0921214998377284479144217759537971209236,0.0404840047653158795200215922009860600419,0.0404840047653158795200215922009860600419,],[0.2152638534631577901958764433162600352749,0.2152638534631577901958764433162600352749,0.2051984637212956039659240656612180557103,0.2051984637212956039659240656612180557103,0.1855383974779378137417165901251570362489,0.1855383974779378137417165901251570362489,0.1572031671581935345696019386238421566056,0.1572031671581935345696019386238421566056,0.1215185706879031846894148090724766259566,0.1215185706879031846894148090724766259566,0.0801580871597602098056332770628543095836,0.0801580871597602098056332770628543095836,0.0351194603317518630318328761381917806197,0.0351194603317518630318328761381917806197,],[0.2025782419255612728806201999675193148386,0.1984314853271115764561183264438393248186,0.1984314853271115764561183264438393248186,0.1861610000155622110268005618664228245062,0.1861610000155622110268005618664228245062,0.1662692058169939335532008604812088111309,0.1662692058169939335532008604812088111309,0.1395706779261543144478047945110283225208,0.1395706779261543144478047945110283225208,0.1071592204671719350118695466858693034155,0.1071592204671719350118695466858693034155,0.0703660474881081247092674164506673384667,0.0703660474881081247092674164506673384667,0.0307532419961172683546283935772044177217,0.0307532419961172683546283935772044177217,],[0.1894506104550684962853967232082831051469,0.1894506104550684962853967232082831051469,0.1826034150449235888667636679692199393835,0.1826034150449235888667636679692199393835,0.1691565193950025381893120790303599622116,0.1691565193950025381893120790303599622116,0.1495959888165767320815017305474785489704,0.1495959888165767320815017305474785489704,0.1246289712555338720524762821920164201448,0.1246289712555338720524762821920164201448,0.0951585116824927848099251076022462263552,0.0951585116824927848099251076022462263552,0.0622535239386478928628438369943776942749,0.0622535239386478928628438369943776942749,0.0271524594117540948517805724560181035122,0.0271524594117540948517805724560181035122,],[0.1794464703562065254582656442618856214487,0.1765627053669926463252709901131972391509,0.1765627053669926463252709901131972391509,0.1680041021564500445099706637883231550211,0.1680041021564500445099706637883231550211,0.1540457610768102880814315948019586119404,0.1540457610768102880814315948019586119404,0.1351363684685254732863199817023501973721,0.1351363684685254732863199817023501973721,0.1118838471934039710947883856263559267358,0.1118838471934039710947883856263559267358,0.0850361483171791808835353701910620738504,0.0850361483171791808835353701910620738504,0.0554595293739872011294401653582446605128,0.0554595293739872011294401653582446605128,0.0241483028685479319601100262875653246916,0.0241483028685479319601100262875653246916,],[0.1691423829631435918406564701349866103341,0.1691423829631435918406564701349866103341,0.1642764837458327229860537764659275904123,0.1642764837458327229860537764659275904123,0.1546846751262652449254180038363747721932,0.1546846751262652449254180038363747721932,0.1406429146706506512047313037519472280955,0.1406429146706506512047313037519472280955,0.1225552067114784601845191268002015552281,0.1225552067114784601845191268002015552281,0.1009420441062871655628139849248346070628,0.1009420441062871655628139849248346070628,0.0764257302548890565291296776166365256053,0.0764257302548890565291296776166365256053,0.0497145488949697964533349462026386416808,0.0497145488949697964533349462026386416808,0.0216160135264833103133427102664524693876,0.0216160135264833103133427102664524693876,],[0.1610544498487836959791636253209167350399,0.1589688433939543476499564394650472016787,0.1589688433939543476499564394650472016787,0.152766042065859666778855400897662998461,0.152766042065859666778855400897662998461,0.1426067021736066117757461094419029724756,0.1426067021736066117757461094419029724756,0.1287539625393362276755157848568771170558,0.1287539625393362276755157848568771170558,0.1115666455473339947160239016817659974813,0.1115666455473339947160239016817659974813,0.0914900216224499994644620941238396526609,0.0914900216224499994644620941238396526609,0.0690445427376412265807082580060130449618,0.0690445427376412265807082580060130449618,0.0448142267656996003328381574019942119517,0.0448142267656996003328381574019942119517,0.0194617882297264770363120414644384357529,0.0194617882297264770363120414644384357529,],[0.1527533871307258506980843319550975934919,0.1527533871307258506980843319550975934919,0.1491729864726037467878287370019694366926,0.1491729864726037467878287370019694366926,0.1420961093183820513292983250671649330345,0.1420961093183820513292983250671649330345,0.1316886384491766268984944997481631349161,0.1316886384491766268984944997481631349161,0.118194531961518417312377377711382287005,0.118194531961518417312377377711382287005,0.1019301198172404350367501354803498761666,0.1019301198172404350367501354803498761666,0.0832767415767047487247581432220462061001,0.0832767415767047487247581432220462061001,0.0626720483341090635695065351870416063516,0.0626720483341090635695065351870416063516,0.040601429800386941331039952274932109879,0.040601429800386941331039952274932109879,0.0176140071391521183118619623518528163621,0.0176140071391521183118619623518528163621,],[0.1460811336496904271919851476833711882448,0.1445244039899700590638271665537525436099,0.1445244039899700590638271665537525436099,0.1398873947910731547221334238675831108927,0.1398873947910731547221334238675831108927,0.132268938633337461781052574496775604329,0.132268938633337461781052574496775604329,0.1218314160537285341953671771257335983563,0.1218314160537285341953671771257335983563,0.1087972991671483776634745780701056420336,0.1087972991671483776634745780701056420336,0.0934444234560338615532897411139320884835,0.0934444234560338615532897411139320884835,0.0761001136283793020170516533001831792261,0.0761001136283793020170516533001831792261,0.0571344254268572082836358264724479574912,0.0571344254268572082836358264724479574912,0.0369537897708524937999506682993296661889,0.0369537897708524937999506682993296661889,0.0160172282577743333242246168584710152658,0.0160172282577743333242246168584710152658,],[0.1392518728556319933754102483418099578739,0.1392518728556319933754102483418099578739,0.1365414983460151713525738312315173965863,0.1365414983460151713525738312315173965863,0.1311735047870623707329649925303074458757,0.1311735047870623707329649925303074458757,0.1232523768105124242855609861548144719594,0.1232523768105124242855609861548144719594,0.1129322960805392183934006074217843191142,0.1129322960805392183934006074217843191142,0.1004141444428809649320788378305362823508,0.1004141444428809649320788378305362823508,0.0859416062170677274144436813727028661891,0.0859416062170677274144436813727028661891,0.0697964684245204880949614189302176573987,0.0697964684245204880949614189302176573987,0.0522933351526832859403120512732112561121,0.0522933351526832859403120512732112561121,0.0337749015848141547933022468659129013491,0.0337749015848141547933022468659129013491,0.0146279952982722006849910980471854451902,0.0146279952982722006849910980471854451902,],[0.1336545721861061753514571105458443385831,0.132462039404696617371642464703316925805,0.132462039404696617371642464703316925805,0.1289057221880821499785953393997936532597,0.1289057221880821499785953393997936532597,0.1230490843067295304675784006720096548158,0.1230490843067295304675784006720096548158,0.1149966402224113649416435129339613014914,0.1149966402224113649416435129339613014914,0.1048920914645414100740861850147438548584,0.1048920914645414100740861850147438548584,0.0929157660600351474770186173697646486034,0.0929157660600351474770186173697646486034,0.0792814117767189549228925247420432269137,0.0792814117767189549228925247420432269137,0.0642324214085258521271696151589109980391,0.0642324214085258521271696151589109980391,0.0480376717310846685716410716320339965612,0.0480376717310846685716410716320339965612,0.0309880058569794443106942196418845053837,0.0309880058569794443106942196418845053837,0.0134118594871417720813094934586150649766,0.0134118594871417720813094934586150649766,],[0.1279381953467521569740561652246953718517,0.1279381953467521569740561652246953718517,0.1258374563468282961213753825111836887264,0.1258374563468282961213753825111836887264,0.121670472927803391204463153476262425607,0.121670472927803391204463153476262425607,0.1155056680537256013533444839067835598622,0.1155056680537256013533444839067835598622,0.1074442701159656347825773424466062227946,0.1074442701159656347825773424466062227946,0.0976186521041138882698806644642471544279,0.0976186521041138882698806644642471544279,0.086190161531953275917185202983742667185,0.086190161531953275917185202983742667185,0.0733464814110803057340336152531165181193,0.0733464814110803057340336152531165181193,0.0592985849154367807463677585001085845412,0.0592985849154367807463677585001085845412,0.0442774388174198061686027482113382288593,0.0442774388174198061686027482113382288593,0.0285313886289336631813078159518782864491,0.0285313886289336631813078159518782864491,0.0123412297999871995468056670700372915759,0.0123412297999871995468056670700372915759,],];const binomialCoefficients=[[1],[1,1],[1,2,1],[1,3,3,1]];const getCubicArcLength=(xs,ys,t)=>{let z;let sum;let correctedT;const n=20;z=t/2;sum=0;for(let i=0;i<n;i++){correctedT=z*tValues[n][i]+z;sum+=cValues[n][i]*BFunc(xs,ys,correctedT);}
return z*sum;};const getQuadraticArcLength=(xs,ys,t)=>{if(t===undefined){t=1;}
const ax=xs[0]-2*xs[1]+xs[2];const ay=ys[0]-2*ys[1]+ys[2];const bx=2*xs[1]-2*xs[0];const by=2*ys[1]-2*ys[0];const A=4*(ax*ax+ay*ay);const B=4*(ax*bx+ay*by);const C=bx*bx+by*by;if(A===0){return(t*Math.sqrt(Math.pow(xs[2]-xs[0],2)+Math.pow(ys[2]-ys[0],2)));}
const b=B/(2*A);const c=C/A;const u=t+b;const k=c-b*b;const uuk=u*u+k>0?Math.sqrt(u*u+k):0;const bbk=b*b+k>0?Math.sqrt(b*b+k):0;const term=b+Math.sqrt(b*b+k)!==0?k*Math.log(Math.abs((u+uuk)/(b+bbk))):0;return(Math.sqrt(A)/2)*(u*uuk-b*bbk+term);};function BFunc(xs,ys,t){const xbase=getDerivative(1,t,xs);const ybase=getDerivative(1,t,ys);const combined=xbase*xbase+ybase*ybase;return Math.sqrt(combined);}
const getDerivative=(derivative,t,vs)=>{const n=vs.length-1;let _vs;let value;if(n===0){return 0;}
if(derivative===0){value=0;for(let k=0;k<=n;k++){value+=binomialCoefficients[n][k]*Math.pow(1-t,n-k)*Math.pow(t,k)*vs[k];}
return value;}
else{_vs=new Array(n);for(let k=0;k<n;k++){_vs[k]=n*(vs[k+1]-vs[k]);}
return getDerivative(derivative-1,t,_vs);}};const t2length=(length,totalLength,func)=>{let error=1;let t=length/totalLength;let step=(length-func(t))/totalLength;let numIterations=0;while(error>0.001){const increasedTLength=func(t+step);const increasedTError=Math.abs(length-increasedTLength)/totalLength;if(increasedTError<error){error=increasedTError;t+=step;}
else{const decreasedTLength=func(t-step);const decreasedTError=Math.abs(length-decreasedTLength)/totalLength;if(decreasedTError<error){error=decreasedTError;t-=step;}
else{step/=2;}}
numIterations++;if(numIterations>500){break;}}
return t;};class Path extends Shape{constructor(config){super(config);this.dataArray=[];this.pathLength=0;this._readDataAttribute();this.on('dataChange.konva',function(){this._readDataAttribute();});}
_readDataAttribute(){this.dataArray=Path.parsePathData(this.data());this.pathLength=Path.getPathLength(this.dataArray);}
_sceneFunc(context){var ca=this.dataArray;context.beginPath();var isClosed=false;for(var n=0;n<ca.length;n++){var c=ca[n].command;var p=ca[n].points;switch(c){case'L':context.lineTo(p[0],p[1]);break;case'M':context.moveTo(p[0],p[1]);break;case'C':context.bezierCurveTo(p[0],p[1],p[2],p[3],p[4],p[5]);break;case'Q':context.quadraticCurveTo(p[0],p[1],p[2],p[3]);break;case'A':var cx=p[0],cy=p[1],rx=p[2],ry=p[3],theta=p[4],dTheta=p[5],psi=p[6],fs=p[7];var r=rx>ry?rx:ry;var scaleX=rx>ry?1:rx/ry;var scaleY=rx>ry?ry/rx:1;context.translate(cx,cy);context.rotate(psi);context.scale(scaleX,scaleY);context.arc(0,0,r,theta,theta+dTheta,1-fs);context.scale(1/scaleX,1/scaleY);context.rotate(-psi);context.translate(-cx,-cy);break;case'z':isClosed=true;context.closePath();break;}}
if(!isClosed&&!this.hasFill()){context.strokeShape(this);}
else{context.fillStrokeShape(this);}}
getSelfRect(){var points=[];this.dataArray.forEach(function(data){if(data.command==='A'){var start=data.points[4];var dTheta=data.points[5];var end=data.points[4]+dTheta;var inc=Math.PI/180.0;if(Math.abs(start-end)<inc){inc=Math.abs(start-end);}
if(dTheta<0){for(let t=start-inc;t>end;t-=inc){const point=Path.getPointOnEllipticalArc(data.points[0],data.points[1],data.points[2],data.points[3],t,0);points.push(point.x,point.y);}}
else{for(let t=start+inc;t<end;t+=inc){const point=Path.getPointOnEllipticalArc(data.points[0],data.points[1],data.points[2],data.points[3],t,0);points.push(point.x,point.y);}}}
else if(data.command==='C'){for(let t=0.0;t<=1;t+=0.01){const point=Path.getPointOnCubicBezier(t,data.start.x,data.start.y,data.points[0],data.points[1],data.points[2],data.points[3],data.points[4],data.points[5]);points.push(point.x,point.y);}}
else{points=points.concat(data.points);}});var minX=points[0];var maxX=points[0];var minY=points[1];var maxY=points[1];var x,y;for(var i=0;i<points.length/2;i++){x=points[i*2];y=points[i*2+1];if(!isNaN(x)){minX=Math.min(minX,x);maxX=Math.max(maxX,x);}
if(!isNaN(y)){minY=Math.min(minY,y);maxY=Math.max(maxY,y);}}
return{x:minX,y:minY,width:maxX-minX,height:maxY-minY,};}
getLength(){return this.pathLength;}
getPointAtLength(length){return Path.getPointAtLengthOfDataArray(length,this.dataArray);}
static getLineLength(x1,y1,x2,y2){return Math.sqrt((x2-x1)*(x2-x1)+(y2-y1)*(y2-y1));}
static getPathLength(dataArray){let pathLength=0;for(var i=0;i<dataArray.length;++i){pathLength+=dataArray[i].pathLength;}
return pathLength;}
static getPointAtLengthOfDataArray(length,dataArray){var point,i=0,ii=dataArray.length;if(!ii){return null;}
while(i<ii&&length>dataArray[i].pathLength){length-=dataArray[i].pathLength;++i;}
if(i===ii){point=dataArray[i-1].points.slice(-2);return{x:point[0],y:point[1],};}
if(length<0.01){point=dataArray[i].points.slice(0,2);return{x:point[0],y:point[1],};}
var cp=dataArray[i];var p=cp.points;switch(cp.command){case'L':return Path.getPointOnLine(length,cp.start.x,cp.start.y,p[0],p[1]);case'C':return Path.getPointOnCubicBezier(t2length(length,Path.getPathLength(dataArray),(i)=>{return getCubicArcLength([cp.start.x,p[0],p[2],p[4]],[cp.start.y,p[1],p[3],p[5]],i);}),cp.start.x,cp.start.y,p[0],p[1],p[2],p[3],p[4],p[5]);case'Q':return Path.getPointOnQuadraticBezier(t2length(length,Path.getPathLength(dataArray),(i)=>{return getQuadraticArcLength([cp.start.x,p[0],p[2]],[cp.start.y,p[1],p[3]],i);}),cp.start.x,cp.start.y,p[0],p[1],p[2],p[3]);case'A':var cx=p[0],cy=p[1],rx=p[2],ry=p[3],theta=p[4],dTheta=p[5],psi=p[6];theta+=(dTheta*length)/cp.pathLength;return Path.getPointOnEllipticalArc(cx,cy,rx,ry,theta,psi);}
return null;}
static getPointOnLine(dist,P1x,P1y,P2x,P2y,fromX,fromY){if(fromX===undefined){fromX=P1x;}
if(fromY===undefined){fromY=P1y;}
var m=(P2y-P1y)/(P2x-P1x+0.00000001);var run=Math.sqrt((dist*dist)/(1+m*m));if(P2x<P1x){run*=-1;}
var rise=m*run;var pt;if(P2x===P1x){pt={x:fromX,y:fromY+rise,};}
else if((fromY-P1y)/(fromX-P1x+0.00000001)===m){pt={x:fromX+run,y:fromY+rise,};}
else{var ix,iy;var len=this.getLineLength(P1x,P1y,P2x,P2y);var u=(fromX-P1x)*(P2x-P1x)+(fromY-P1y)*(P2y-P1y);u=u/(len*len);ix=P1x+u*(P2x-P1x);iy=P1y+u*(P2y-P1y);var pRise=this.getLineLength(fromX,fromY,ix,iy);var pRun=Math.sqrt(dist*dist-pRise*pRise);run=Math.sqrt((pRun*pRun)/(1+m*m));if(P2x<P1x){run*=-1;}
rise=m*run;pt={x:ix+run,y:iy+rise,};}
return pt;}
static getPointOnCubicBezier(pct,P1x,P1y,P2x,P2y,P3x,P3y,P4x,P4y){function CB1(t){return t*t*t;}
function CB2(t){return 3*t*t*(1-t);}
function CB3(t){return 3*t*(1-t)*(1-t);}
function CB4(t){return(1-t)*(1-t)*(1-t);}
var x=P4x*CB1(pct)+P3x*CB2(pct)+P2x*CB3(pct)+P1x*CB4(pct);var y=P4y*CB1(pct)+P3y*CB2(pct)+P2y*CB3(pct)+P1y*CB4(pct);return{x:x,y:y,};}
static getPointOnQuadraticBezier(pct,P1x,P1y,P2x,P2y,P3x,P3y){function QB1(t){return t*t;}
function QB2(t){return 2*t*(1-t);}
function QB3(t){return(1-t)*(1-t);}
var x=P3x*QB1(pct)+P2x*QB2(pct)+P1x*QB3(pct);var y=P3y*QB1(pct)+P2y*QB2(pct)+P1y*QB3(pct);return{x:x,y:y,};}
static getPointOnEllipticalArc(cx,cy,rx,ry,theta,psi){var cosPsi=Math.cos(psi),sinPsi=Math.sin(psi);var pt={x:rx*Math.cos(theta),y:ry*Math.sin(theta),};return{x:cx+(pt.x*cosPsi-pt.y*sinPsi),y:cy+(pt.x*sinPsi+pt.y*cosPsi),};}
static parsePathData(data){if(!data){return[];}
var cs=data;var cc=['m','M','l','L','v','V','h','H','z','Z','c','C','q','Q','t','T','s','S','a','A',];cs=cs.replace(new RegExp(' ','g'),',');for(var n=0;n<cc.length;n++){cs=cs.replace(new RegExp(cc[n],'g'),'|'+cc[n]);}
var arr=cs.split('|');var ca=[];var coords=[];var cpx=0;var cpy=0;var re=/([-+]?((\d+\.\d+)|((\d+)|(\.\d+)))(?:e[-+]?\d+)?)/gi;var match;for(n=1;n<arr.length;n++){var str=arr[n];var c=str.charAt(0);str=str.slice(1);coords.length=0;while((match=re.exec(str))){coords.push(match[0]);}
var p=[];for(var j=0,jlen=coords.length;j<jlen;j++){if(coords[j]==='00'){p.push(0,0);continue;}
var parsed=parseFloat(coords[j]);if(!isNaN(parsed)){p.push(parsed);}
else{p.push(0);}}
while(p.length>0){if(isNaN(p[0])){break;}
var cmd='';var points=[];var startX=cpx,startY=cpy;var prevCmd,ctlPtx,ctlPty;var rx,ry,psi,fa,fs,x1,y1;switch(c){case'l':cpx+=p.shift();cpy+=p.shift();cmd='L';points.push(cpx,cpy);break;case'L':cpx=p.shift();cpy=p.shift();points.push(cpx,cpy);break;case'm':var dx=p.shift();var dy=p.shift();cpx+=dx;cpy+=dy;cmd='M';if(ca.length>2&&ca[ca.length-1].command==='z'){for(var idx=ca.length-2;idx>=0;idx--){if(ca[idx].command==='M'){cpx=ca[idx].points[0]+dx;cpy=ca[idx].points[1]+dy;break;}}}
points.push(cpx,cpy);c='l';break;case'M':cpx=p.shift();cpy=p.shift();cmd='M';points.push(cpx,cpy);c='L';break;case'h':cpx+=p.shift();cmd='L';points.push(cpx,cpy);break;case'H':cpx=p.shift();cmd='L';points.push(cpx,cpy);break;case'v':cpy+=p.shift();cmd='L';points.push(cpx,cpy);break;case'V':cpy=p.shift();cmd='L';points.push(cpx,cpy);break;case'C':points.push(p.shift(),p.shift(),p.shift(),p.shift());cpx=p.shift();cpy=p.shift();points.push(cpx,cpy);break;case'c':points.push(cpx+p.shift(),cpy+p.shift(),cpx+p.shift(),cpy+p.shift());cpx+=p.shift();cpy+=p.shift();cmd='C';points.push(cpx,cpy);break;case'S':ctlPtx=cpx;ctlPty=cpy;prevCmd=ca[ca.length-1];if(prevCmd.command==='C'){ctlPtx=cpx+(cpx-prevCmd.points[2]);ctlPty=cpy+(cpy-prevCmd.points[3]);}
points.push(ctlPtx,ctlPty,p.shift(),p.shift());cpx=p.shift();cpy=p.shift();cmd='C';points.push(cpx,cpy);break;case's':ctlPtx=cpx;ctlPty=cpy;prevCmd=ca[ca.length-1];if(prevCmd.command==='C'){ctlPtx=cpx+(cpx-prevCmd.points[2]);ctlPty=cpy+(cpy-prevCmd.points[3]);}
points.push(ctlPtx,ctlPty,cpx+p.shift(),cpy+p.shift());cpx+=p.shift();cpy+=p.shift();cmd='C';points.push(cpx,cpy);break;case'Q':points.push(p.shift(),p.shift());cpx=p.shift();cpy=p.shift();points.push(cpx,cpy);break;case'q':points.push(cpx+p.shift(),cpy+p.shift());cpx+=p.shift();cpy+=p.shift();cmd='Q';points.push(cpx,cpy);break;case'T':ctlPtx=cpx;ctlPty=cpy;prevCmd=ca[ca.length-1];if(prevCmd.command==='Q'){ctlPtx=cpx+(cpx-prevCmd.points[0]);ctlPty=cpy+(cpy-prevCmd.points[1]);}
cpx=p.shift();cpy=p.shift();cmd='Q';points.push(ctlPtx,ctlPty,cpx,cpy);break;case't':ctlPtx=cpx;ctlPty=cpy;prevCmd=ca[ca.length-1];if(prevCmd.command==='Q'){ctlPtx=cpx+(cpx-prevCmd.points[0]);ctlPty=cpy+(cpy-prevCmd.points[1]);}
cpx+=p.shift();cpy+=p.shift();cmd='Q';points.push(ctlPtx,ctlPty,cpx,cpy);break;case'A':rx=p.shift();ry=p.shift();psi=p.shift();fa=p.shift();fs=p.shift();x1=cpx;y1=cpy;cpx=p.shift();cpy=p.shift();cmd='A';points=this.convertEndpointToCenterParameterization(x1,y1,cpx,cpy,fa,fs,rx,ry,psi);break;case'a':rx=p.shift();ry=p.shift();psi=p.shift();fa=p.shift();fs=p.shift();x1=cpx;y1=cpy;cpx+=p.shift();cpy+=p.shift();cmd='A';points=this.convertEndpointToCenterParameterization(x1,y1,cpx,cpy,fa,fs,rx,ry,psi);break;}
ca.push({command:cmd||c,points:points,start:{x:startX,y:startY,},pathLength:this.calcLength(startX,startY,cmd||c,points),});}
if(c==='z'||c==='Z'){ca.push({command:'z',points:[],start:undefined,pathLength:0,});}}
return ca;}
static calcLength(x,y,cmd,points){var len,p1,p2,t;var path=Path;switch(cmd){case'L':return path.getLineLength(x,y,points[0],points[1]);case'C':return getCubicArcLength([x,points[0],points[2],points[4]],[y,points[1],points[3],points[5]],1);case'Q':return getQuadraticArcLength([x,points[0],points[2]],[y,points[1],points[3]],1);case'A':len=0.0;var start=points[4];var dTheta=points[5];var end=points[4]+dTheta;var inc=Math.PI/180.0;if(Math.abs(start-end)<inc){inc=Math.abs(start-end);}
p1=path.getPointOnEllipticalArc(points[0],points[1],points[2],points[3],start,0);if(dTheta<0){for(t=start-inc;t>end;t-=inc){p2=path.getPointOnEllipticalArc(points[0],points[1],points[2],points[3],t,0);len+=path.getLineLength(p1.x,p1.y,p2.x,p2.y);p1=p2;}}
else{for(t=start+inc;t<end;t+=inc){p2=path.getPointOnEllipticalArc(points[0],points[1],points[2],points[3],t,0);len+=path.getLineLength(p1.x,p1.y,p2.x,p2.y);p1=p2;}}
p2=path.getPointOnEllipticalArc(points[0],points[1],points[2],points[3],end,0);len+=path.getLineLength(p1.x,p1.y,p2.x,p2.y);return len;}
return 0;}
static convertEndpointToCenterParameterization(x1,y1,x2,y2,fa,fs,rx,ry,psiDeg){var psi=psiDeg*(Math.PI/180.0);var xp=(Math.cos(psi)*(x1-x2))/2.0+(Math.sin(psi)*(y1-y2))/2.0;var yp=(-1*Math.sin(psi)*(x1-x2))/2.0+
(Math.cos(psi)*(y1-y2))/2.0;var lambda=(xp*xp)/(rx*rx)+(yp*yp)/(ry*ry);if(lambda>1){rx*=Math.sqrt(lambda);ry*=Math.sqrt(lambda);}
var f=Math.sqrt((rx*rx*(ry*ry)-rx*rx*(yp*yp)-ry*ry*(xp*xp))/(rx*rx*(yp*yp)+ry*ry*(xp*xp)));if(fa===fs){f*=-1;}
if(isNaN(f)){f=0;}
var cxp=(f*rx*yp)/ry;var cyp=(f*-ry*xp)/rx;var cx=(x1+x2)/2.0+Math.cos(psi)*cxp-Math.sin(psi)*cyp;var cy=(y1+y2)/2.0+Math.sin(psi)*cxp+Math.cos(psi)*cyp;var vMag=function(v){return Math.sqrt(v[0]*v[0]+v[1]*v[1]);};var vRatio=function(u,v){return(u[0]*v[0]+u[1]*v[1])/(vMag(u)*vMag(v));};var vAngle=function(u,v){return(u[0]*v[1]<u[1]*v[0]?-1:1)*Math.acos(vRatio(u,v));};var theta=vAngle([1,0],[(xp-cxp)/rx,(yp-cyp)/ry]);var u=[(xp-cxp)/rx,(yp-cyp)/ry];var v=[(-1*xp-cxp)/rx,(-1*yp-cyp)/ry];var dTheta=vAngle(u,v);if(vRatio(u,v)<=-1){dTheta=Math.PI;}
if(vRatio(u,v)>=1){dTheta=0;}
if(fs===0&&dTheta>0){dTheta=dTheta-2*Math.PI;}
if(fs===1&&dTheta<0){dTheta=dTheta+2*Math.PI;}
return[cx,cy,rx,ry,theta,dTheta,psi,fs];}}
Path.prototype.className='Path';Path.prototype._attrsAffectingSize=['data'];_registerNode(Path);Factory.addGetterSetter(Path,'data');class Arrow extends Line{_sceneFunc(ctx){super._sceneFunc(ctx);var PI2=Math.PI*2;var points=this.points();var tp=points;var fromTension=this.tension()!==0&&points.length>4;if(fromTension){tp=this.getTensionPoints();}
var length=this.pointerLength();var n=points.length;var dx,dy;if(fromTension){const lp=[tp[tp.length-4],tp[tp.length-3],tp[tp.length-2],tp[tp.length-1],points[n-2],points[n-1],];const lastLength=Path.calcLength(tp[tp.length-4],tp[tp.length-3],'C',lp);const previous=Path.getPointOnQuadraticBezier(Math.min(1,1-length/lastLength),lp[0],lp[1],lp[2],lp[3],lp[4],lp[5]);dx=points[n-2]-previous.x;dy=points[n-1]-previous.y;}
else{dx=points[n-2]-points[n-4];dy=points[n-1]-points[n-3];}
var radians=(Math.atan2(dy,dx)+PI2)%PI2;var width=this.pointerWidth();if(this.pointerAtEnding()){ctx.save();ctx.beginPath();ctx.translate(points[n-2],points[n-1]);ctx.rotate(radians);ctx.moveTo(0,0);ctx.lineTo(-length,width/2);ctx.lineTo(-length,-width/2);ctx.closePath();ctx.restore();this.__fillStroke(ctx);}
if(this.pointerAtBeginning()){ctx.save();ctx.beginPath();ctx.translate(points[0],points[1]);if(fromTension){dx=(tp[0]+tp[2])/2-points[0];dy=(tp[1]+tp[3])/2-points[1];}
else{dx=points[2]-points[0];dy=points[3]-points[1];}
ctx.rotate((Math.atan2(-dy,-dx)+PI2)%PI2);ctx.moveTo(0,0);ctx.lineTo(-length,width/2);ctx.lineTo(-length,-width/2);ctx.closePath();ctx.restore();this.__fillStroke(ctx);}}
__fillStroke(ctx){var isDashEnabled=this.dashEnabled();if(isDashEnabled){this.attrs.dashEnabled=false;ctx.setLineDash([]);}
ctx.fillStrokeShape(this);if(isDashEnabled){this.attrs.dashEnabled=true;}}
getSelfRect(){const lineRect=super.getSelfRect();const offset=this.pointerWidth()/2;return{x:lineRect.x-offset,y:lineRect.y-offset,width:lineRect.width+offset*2,height:lineRect.height+offset*2,};}}
Arrow.prototype.className='Arrow';_registerNode(Arrow);Factory.addGetterSetter(Arrow,'pointerLength',10,getNumberValidator());Factory.addGetterSetter(Arrow,'pointerWidth',10,getNumberValidator());Factory.addGetterSetter(Arrow,'pointerAtBeginning',false);Factory.addGetterSetter(Arrow,'pointerAtEnding',true);class Circle extends Shape{_sceneFunc(context){context.beginPath();context.arc(0,0,this.attrs.radius||0,0,Math.PI*2,false);context.closePath();context.fillStrokeShape(this);}
getWidth(){return this.radius()*2;}
getHeight(){return this.radius()*2;}
setWidth(width){if(this.radius()!==width/2){this.radius(width/2);}}
setHeight(height){if(this.radius()!==height/2){this.radius(height/2);}}}
Circle.prototype._centroid=true;Circle.prototype.className='Circle';Circle.prototype._attrsAffectingSize=['radius'];_registerNode(Circle);Factory.addGetterSetter(Circle,'radius',0,getNumberValidator());class Ellipse extends Shape{_sceneFunc(context){var rx=this.radiusX(),ry=this.radiusY();context.beginPath();context.save();if(rx!==ry){context.scale(1,ry/rx);}
context.arc(0,0,rx,0,Math.PI*2,false);context.restore();context.closePath();context.fillStrokeShape(this);}
getWidth(){return this.radiusX()*2;}
getHeight(){return this.radiusY()*2;}
setWidth(width){this.radiusX(width/2);}
setHeight(height){this.radiusY(height/2);}}
Ellipse.prototype.className='Ellipse';Ellipse.prototype._centroid=true;Ellipse.prototype._attrsAffectingSize=['radiusX','radiusY'];_registerNode(Ellipse);Factory.addComponentsGetterSetter(Ellipse,'radius',['x','y']);Factory.addGetterSetter(Ellipse,'radiusX',0,getNumberValidator());Factory.addGetterSetter(Ellipse,'radiusY',0,getNumberValidator());class Image extends Shape{constructor(attrs){super(attrs);this.on('imageChange.konva',()=>{this._setImageLoad();});this._setImageLoad();}
_setImageLoad(){const image=this.image();if(image&&image.complete){return;}
if(image&&image.readyState===4){return;}
if(image&&image['addEventListener']){image['addEventListener']('load',()=>{this._requestDraw();});}}
_useBufferCanvas(){return super._useBufferCanvas(true);}
_sceneFunc(context){const width=this.getWidth();const height=this.getHeight();const cornerRadius=this.cornerRadius();const image=this.attrs.image;let params;if(image){const cropWidth=this.attrs.cropWidth;const cropHeight=this.attrs.cropHeight;if(cropWidth&&cropHeight){params=[image,this.cropX(),this.cropY(),cropWidth,cropHeight,0,0,width,height,];}
else{params=[image,0,0,width,height];}}
if(this.hasFill()||this.hasStroke()||cornerRadius){context.beginPath();cornerRadius?Util.drawRoundedRectPath(context,width,height,cornerRadius):context.rect(0,0,width,height);context.closePath();context.fillStrokeShape(this);}
if(image){if(cornerRadius){context.clip();}
context.drawImage.apply(context,params);}}
_hitFunc(context){var width=this.width(),height=this.height(),cornerRadius=this.cornerRadius();context.beginPath();if(!cornerRadius){context.rect(0,0,width,height);}
else{Util.drawRoundedRectPath(context,width,height,cornerRadius);}
context.closePath();context.fillStrokeShape(this);}
getWidth(){var _a,_b;return(_a=this.attrs.width)!==null&&_a!==void 0?_a:(_b=this.image())===null||_b===void 0?void 0:_b.width;}
getHeight(){var _a,_b;return(_a=this.attrs.height)!==null&&_a!==void 0?_a:(_b=this.image())===null||_b===void 0?void 0:_b.height;}
static fromURL(url,callback,onError=null){var img=Util.createImageElement();img.onload=function(){var image=new Image({image:img,});callback(image);};img.onerror=onError;img.crossOrigin='Anonymous';img.src=url;}}
Image.prototype.className='Image';_registerNode(Image);Factory.addGetterSetter(Image,'cornerRadius',0,getNumberOrArrayOfNumbersValidator(4));Factory.addGetterSetter(Image,'image');Factory.addComponentsGetterSetter(Image,'crop',['x','y','width','height']);Factory.addGetterSetter(Image,'cropX',0,getNumberValidator());Factory.addGetterSetter(Image,'cropY',0,getNumberValidator());Factory.addGetterSetter(Image,'cropWidth',0,getNumberValidator());Factory.addGetterSetter(Image,'cropHeight',0,getNumberValidator());var ATTR_CHANGE_LIST$2=['fontFamily','fontSize','fontStyle','padding','lineHeight','text','width','height','pointerDirection','pointerWidth','pointerHeight',],CHANGE_KONVA$1='Change.konva',NONE$1='none',UP='up',RIGHT$1='right',DOWN='down',LEFT$1='left',attrChangeListLen$1=ATTR_CHANGE_LIST$2.length;class Label extends Group{constructor(config){super(config);this.on('add.konva',function(evt){this._addListeners(evt.child);this._sync();});}
getText(){return this.find('Text')[0];}
getTag(){return this.find('Tag')[0];}
_addListeners(text){var that=this,n;var func=function(){that._sync();};for(n=0;n<attrChangeListLen$1;n++){text.on(ATTR_CHANGE_LIST$2[n]+CHANGE_KONVA$1,func);}}
getWidth(){return this.getText().width();}
getHeight(){return this.getText().height();}
_sync(){var text=this.getText(),tag=this.getTag(),width,height,pointerDirection,pointerWidth,x,y,pointerHeight;if(text&&tag){width=text.width();height=text.height();pointerDirection=tag.pointerDirection();pointerWidth=tag.pointerWidth();pointerHeight=tag.pointerHeight();x=0;y=0;switch(pointerDirection){case UP:x=width/2;y=-1*pointerHeight;break;case RIGHT$1:x=width+pointerWidth;y=height/2;break;case DOWN:x=width/2;y=height+pointerHeight;break;case LEFT$1:x=-1*pointerWidth;y=height/2;break;}
tag.setAttrs({x:-1*x,y:-1*y,width:width,height:height,});text.setAttrs({x:-1*x,y:-1*y,});}}}
Label.prototype.className='Label';_registerNode(Label);class Tag extends Shape{_sceneFunc(context){var width=this.width(),height=this.height(),pointerDirection=this.pointerDirection(),pointerWidth=this.pointerWidth(),pointerHeight=this.pointerHeight(),cornerRadius=this.cornerRadius();let topLeft=0;let topRight=0;let bottomLeft=0;let bottomRight=0;if(typeof cornerRadius==='number'){topLeft=topRight=bottomLeft=bottomRight=Math.min(cornerRadius,width/2,height/2);}
else{topLeft=Math.min(cornerRadius[0]||0,width/2,height/2);topRight=Math.min(cornerRadius[1]||0,width/2,height/2);bottomRight=Math.min(cornerRadius[2]||0,width/2,height/2);bottomLeft=Math.min(cornerRadius[3]||0,width/2,height/2);}
context.beginPath();context.moveTo(topLeft,0);if(pointerDirection===UP){context.lineTo((width-pointerWidth)/2,0);context.lineTo(width/2,-1*pointerHeight);context.lineTo((width+pointerWidth)/2,0);}
context.lineTo(width-topRight,0);context.arc(width-topRight,topRight,topRight,(Math.PI*3)/2,0,false);if(pointerDirection===RIGHT$1){context.lineTo(width,(height-pointerHeight)/2);context.lineTo(width+pointerWidth,height/2);context.lineTo(width,(height+pointerHeight)/2);}
context.lineTo(width,height-bottomRight);context.arc(width-bottomRight,height-bottomRight,bottomRight,0,Math.PI/2,false);if(pointerDirection===DOWN){context.lineTo((width+pointerWidth)/2,height);context.lineTo(width/2,height+pointerHeight);context.lineTo((width-pointerWidth)/2,height);}
context.lineTo(bottomLeft,height);context.arc(bottomLeft,height-bottomLeft,bottomLeft,Math.PI/2,Math.PI,false);if(pointerDirection===LEFT$1){context.lineTo(0,(height+pointerHeight)/2);context.lineTo(-1*pointerWidth,height/2);context.lineTo(0,(height-pointerHeight)/2);}
context.lineTo(0,topLeft);context.arc(topLeft,topLeft,topLeft,Math.PI,(Math.PI*3)/2,false);context.closePath();context.fillStrokeShape(this);}
getSelfRect(){var x=0,y=0,pointerWidth=this.pointerWidth(),pointerHeight=this.pointerHeight(),direction=this.pointerDirection(),width=this.width(),height=this.height();if(direction===UP){y-=pointerHeight;height+=pointerHeight;}
else if(direction===DOWN){height+=pointerHeight;}
else if(direction===LEFT$1){x-=pointerWidth*1.5;width+=pointerWidth;}
else if(direction===RIGHT$1){width+=pointerWidth*1.5;}
return{x:x,y:y,width:width,height:height,};}}
Tag.prototype.className='Tag';_registerNode(Tag);Factory.addGetterSetter(Tag,'pointerDirection',NONE$1);Factory.addGetterSetter(Tag,'pointerWidth',0,getNumberValidator());Factory.addGetterSetter(Tag,'pointerHeight',0,getNumberValidator());Factory.addGetterSetter(Tag,'cornerRadius',0,getNumberOrArrayOfNumbersValidator(4));class Rect extends Shape{_sceneFunc(context){var cornerRadius=this.cornerRadius(),width=this.width(),height=this.height();context.beginPath();if(!cornerRadius){context.rect(0,0,width,height);}
else{Util.drawRoundedRectPath(context,width,height,cornerRadius);}
context.closePath();context.fillStrokeShape(this);}}
Rect.prototype.className='Rect';_registerNode(Rect);Factory.addGetterSetter(Rect,'cornerRadius',0,getNumberOrArrayOfNumbersValidator(4));class RegularPolygon extends Shape{_sceneFunc(context){const points=this._getPoints();context.beginPath();context.moveTo(points[0].x,points[0].y);for(var n=1;n<points.length;n++){context.lineTo(points[n].x,points[n].y);}
context.closePath();context.fillStrokeShape(this);}
_getPoints(){const sides=this.attrs.sides;const radius=this.attrs.radius||0;const points=[];for(var n=0;n<sides;n++){points.push({x:radius*Math.sin((n*2*Math.PI)/sides),y:-1*radius*Math.cos((n*2*Math.PI)/sides),});}
return points;}
getSelfRect(){const points=this._getPoints();var minX=points[0].x;var maxX=points[0].y;var minY=points[0].x;var maxY=points[0].y;points.forEach((point)=>{minX=Math.min(minX,point.x);maxX=Math.max(maxX,point.x);minY=Math.min(minY,point.y);maxY=Math.max(maxY,point.y);});return{x:minX,y:minY,width:maxX-minX,height:maxY-minY,};}
getWidth(){return this.radius()*2;}
getHeight(){return this.radius()*2;}
setWidth(width){this.radius(width/2);}
setHeight(height){this.radius(height/2);}}
RegularPolygon.prototype.className='RegularPolygon';RegularPolygon.prototype._centroid=true;RegularPolygon.prototype._attrsAffectingSize=['radius'];_registerNode(RegularPolygon);Factory.addGetterSetter(RegularPolygon,'radius',0,getNumberValidator());Factory.addGetterSetter(RegularPolygon,'sides',0,getNumberValidator());var PIx2=Math.PI*2;class Ring extends Shape{_sceneFunc(context){context.beginPath();context.arc(0,0,this.innerRadius(),0,PIx2,false);context.moveTo(this.outerRadius(),0);context.arc(0,0,this.outerRadius(),PIx2,0,true);context.closePath();context.fillStrokeShape(this);}
getWidth(){return this.outerRadius()*2;}
getHeight(){return this.outerRadius()*2;}
setWidth(width){this.outerRadius(width/2);}
setHeight(height){this.outerRadius(height/2);}}
Ring.prototype.className='Ring';Ring.prototype._centroid=true;Ring.prototype._attrsAffectingSize=['innerRadius','outerRadius'];_registerNode(Ring);Factory.addGetterSetter(Ring,'innerRadius',0,getNumberValidator());Factory.addGetterSetter(Ring,'outerRadius',0,getNumberValidator());class Sprite extends Shape{constructor(config){super(config);this._updated=true;this.anim=new Animation(()=>{var updated=this._updated;this._updated=false;return updated;});this.on('animationChange.konva',function(){this.frameIndex(0);});this.on('frameIndexChange.konva',function(){this._updated=true;});this.on('frameRateChange.konva',function(){if(!this.anim.isRunning()){return;}
clearInterval(this.interval);this._setInterval();});}
_sceneFunc(context){var anim=this.animation(),index=this.frameIndex(),ix4=index*4,set=this.animations()[anim],offsets=this.frameOffsets(),x=set[ix4+0],y=set[ix4+1],width=set[ix4+2],height=set[ix4+3],image=this.image();if(this.hasFill()||this.hasStroke()){context.beginPath();context.rect(0,0,width,height);context.closePath();context.fillStrokeShape(this);}
if(image){if(offsets){var offset=offsets[anim],ix2=index*2;context.drawImage(image,x,y,width,height,offset[ix2+0],offset[ix2+1],width,height);}
else{context.drawImage(image,x,y,width,height,0,0,width,height);}}}
_hitFunc(context){var anim=this.animation(),index=this.frameIndex(),ix4=index*4,set=this.animations()[anim],offsets=this.frameOffsets(),width=set[ix4+2],height=set[ix4+3];context.beginPath();if(offsets){var offset=offsets[anim];var ix2=index*2;context.rect(offset[ix2+0],offset[ix2+1],width,height);}
else{context.rect(0,0,width,height);}
context.closePath();context.fillShape(this);}
_useBufferCanvas(){return super._useBufferCanvas(true);}
_setInterval(){var that=this;this.interval=setInterval(function(){that._updateIndex();},1000/this.frameRate());}
start(){if(this.isRunning()){return;}
var layer=this.getLayer();this.anim.setLayers(layer);this._setInterval();this.anim.start();}
stop(){this.anim.stop();clearInterval(this.interval);}
isRunning(){return this.anim.isRunning();}
_updateIndex(){var index=this.frameIndex(),animation=this.animation(),animations=this.animations(),anim=animations[animation],len=anim.length/4;if(index<len-1){this.frameIndex(index+1);}
else{this.frameIndex(0);}}}
Sprite.prototype.className='Sprite';_registerNode(Sprite);Factory.addGetterSetter(Sprite,'animation');Factory.addGetterSetter(Sprite,'animations');Factory.addGetterSetter(Sprite,'frameOffsets');Factory.addGetterSetter(Sprite,'image');Factory.addGetterSetter(Sprite,'frameIndex',0,getNumberValidator());Factory.addGetterSetter(Sprite,'frameRate',17,getNumberValidator());Factory.backCompat(Sprite,{index:'frameIndex',getIndex:'getFrameIndex',setIndex:'setFrameIndex',});class Star extends Shape{_sceneFunc(context){var innerRadius=this.innerRadius(),outerRadius=this.outerRadius(),numPoints=this.numPoints();context.beginPath();context.moveTo(0,0-outerRadius);for(var n=1;n<numPoints*2;n++){var radius=n%2===0?outerRadius:innerRadius;var x=radius*Math.sin((n*Math.PI)/numPoints);var y=-1*radius*Math.cos((n*Math.PI)/numPoints);context.lineTo(x,y);}
context.closePath();context.fillStrokeShape(this);}
getWidth(){return this.outerRadius()*2;}
getHeight(){return this.outerRadius()*2;}
setWidth(width){this.outerRadius(width/2);}
setHeight(height){this.outerRadius(height/2);}}
Star.prototype.className='Star';Star.prototype._centroid=true;Star.prototype._attrsAffectingSize=['innerRadius','outerRadius'];_registerNode(Star);Factory.addGetterSetter(Star,'numPoints',5,getNumberValidator());Factory.addGetterSetter(Star,'innerRadius',0,getNumberValidator());Factory.addGetterSetter(Star,'outerRadius',0,getNumberValidator());function stringToArray(string){return Array.from(string);}
var AUTO='auto',CENTER='center',INHERIT='inherit',JUSTIFY='justify',CHANGE_KONVA='Change.konva',CONTEXT_2D='2d',DASH='-',LEFT='left',TEXT='text',TEXT_UPPER='Text',TOP='top',BOTTOM='bottom',MIDDLE='middle',NORMAL$1='normal',PX_SPACE='px ',SPACE=' ',RIGHT='right',RTL='rtl',WORD='word',CHAR='char',NONE='none',ELLIPSIS='…',ATTR_CHANGE_LIST$1=['direction','fontFamily','fontSize','fontStyle','fontVariant','padding','align','verticalAlign','lineHeight','text','width','height','wrap','ellipsis','letterSpacing',],attrChangeListLen=ATTR_CHANGE_LIST$1.length;function normalizeFontFamily(fontFamily){return fontFamily.split(',').map((family)=>{family=family.trim();const hasSpace=family.indexOf(' ')>=0;const hasQuotes=family.indexOf('"')>=0||family.indexOf("'")>=0;if(hasSpace&&!hasQuotes){family=`"${family}"`;}
return family;}).join(', ');}
var dummyContext;function getDummyContext(){if(dummyContext){return dummyContext;}
dummyContext=Util.createCanvasElement().getContext(CONTEXT_2D);return dummyContext;}
function _fillFunc$1(context){context.fillText(this._partialText,this._partialTextX,this._partialTextY);}
function _strokeFunc$1(context){context.setAttr('miterLimit',2);context.strokeText(this._partialText,this._partialTextX,this._partialTextY);}
function checkDefaultFill(config){config=config||{};if(!config.fillLinearGradientColorStops&&!config.fillRadialGradientColorStops&&!config.fillPatternImage){config.fill=config.fill||'black';}
return config;}
class Text extends Shape{constructor(config){super(checkDefaultFill(config));this._partialTextX=0;this._partialTextY=0;for(var n=0;n<attrChangeListLen;n++){this.on(ATTR_CHANGE_LIST$1[n]+CHANGE_KONVA,this._setTextData);}
this._setTextData();}
_sceneFunc(context){var textArr=this.textArr,textArrLen=textArr.length;if(!this.text()){return;}
var padding=this.padding(),fontSize=this.fontSize(),lineHeightPx=this.lineHeight()*fontSize,verticalAlign=this.verticalAlign(),direction=this.direction(),alignY=0,align=this.align(),totalWidth=this.getWidth(),letterSpacing=this.letterSpacing(),fill=this.fill(),textDecoration=this.textDecoration(),shouldUnderline=textDecoration.indexOf('underline')!==-1,shouldLineThrough=textDecoration.indexOf('line-through')!==-1,n;direction=direction===INHERIT?context.direction:direction;var translateY=0;var translateY=lineHeightPx/2;var lineTranslateX=0;var lineTranslateY=0;if(direction===RTL){context.setAttr('direction',direction);}
context.setAttr('font',this._getContextFont());context.setAttr('textBaseline',MIDDLE);context.setAttr('textAlign',LEFT);if(verticalAlign===MIDDLE){alignY=(this.getHeight()-textArrLen*lineHeightPx-padding*2)/2;}
else if(verticalAlign===BOTTOM){alignY=this.getHeight()-textArrLen*lineHeightPx-padding*2;}
context.translate(padding,alignY+padding);for(n=0;n<textArrLen;n++){var lineTranslateX=0;var lineTranslateY=0;var obj=textArr[n],text=obj.text,width=obj.width,lastLine=obj.lastInParagraph,spacesNumber,oneWord,lineWidth;context.save();if(align===RIGHT){lineTranslateX+=totalWidth-width-padding*2;}
else if(align===CENTER){lineTranslateX+=(totalWidth-width-padding*2)/2;}
if(shouldUnderline){context.save();context.beginPath();context.moveTo(lineTranslateX,translateY+lineTranslateY+Math.round(fontSize/2));spacesNumber=text.split(' ').length-1;oneWord=spacesNumber===0;lineWidth=align===JUSTIFY&&!lastLine?totalWidth-padding*2:width;context.lineTo(lineTranslateX+Math.round(lineWidth),translateY+lineTranslateY+Math.round(fontSize/2));context.lineWidth=fontSize/15;const gradient=this._getLinearGradient();context.strokeStyle=gradient||fill;context.stroke();context.restore();}
if(shouldLineThrough){context.save();context.beginPath();context.moveTo(lineTranslateX,translateY+lineTranslateY);spacesNumber=text.split(' ').length-1;oneWord=spacesNumber===0;lineWidth=align===JUSTIFY&&lastLine&&!oneWord?totalWidth-padding*2:width;context.lineTo(lineTranslateX+Math.round(lineWidth),translateY+lineTranslateY);context.lineWidth=fontSize/15;const gradient=this._getLinearGradient();context.strokeStyle=gradient||fill;context.stroke();context.restore();}
if(direction!==RTL&&(letterSpacing!==0||align===JUSTIFY)){spacesNumber=text.split(' ').length-1;var array=stringToArray(text);for(var li=0;li<array.length;li++){var letter=array[li];if(letter===' '&&!lastLine&&align===JUSTIFY){lineTranslateX+=(totalWidth-padding*2-width)/spacesNumber;}
this._partialTextX=lineTranslateX;this._partialTextY=translateY+lineTranslateY;this._partialText=letter;context.fillStrokeShape(this);lineTranslateX+=this.measureSize(letter).width+letterSpacing;}}
else{if(letterSpacing!==0){context.setAttr('letterSpacing',`${letterSpacing}px`);}
this._partialTextX=lineTranslateX;this._partialTextY=translateY+lineTranslateY;this._partialText=text;context.fillStrokeShape(this);}
context.restore();if(textArrLen>1){translateY+=lineHeightPx;}}}
_hitFunc(context){var width=this.getWidth(),height=this.getHeight();context.beginPath();context.rect(0,0,width,height);context.closePath();context.fillStrokeShape(this);}
setText(text){var str=Util._isString(text)?text:text===null||text===undefined?'':text+'';this._setAttr(TEXT,str);return this;}
getWidth(){var isAuto=this.attrs.width===AUTO||this.attrs.width===undefined;return isAuto?this.getTextWidth()+this.padding()*2:this.attrs.width;}
getHeight(){var isAuto=this.attrs.height===AUTO||this.attrs.height===undefined;return isAuto?this.fontSize()*this.textArr.length*this.lineHeight()+
this.padding()*2:this.attrs.height;}
getTextWidth(){return this.textWidth;}
getTextHeight(){Util.warn('text.getTextHeight() method is deprecated. Use text.height() - for full height and text.fontSize() - for one line height.');return this.textHeight;}
measureSize(text){var _context=getDummyContext(),fontSize=this.fontSize(),metrics;_context.save();_context.font=this._getContextFont();metrics=_context.measureText(text);_context.restore();return{width:metrics.width,height:fontSize,};}
_getContextFont(){return(this.fontStyle()+
SPACE+
this.fontVariant()+
SPACE+
(this.fontSize()+PX_SPACE)+
normalizeFontFamily(this.fontFamily()));}
_addTextLine(line){const align=this.align();if(align===JUSTIFY){line=line.trim();}
var width=this._getTextWidth(line);return this.textArr.push({text:line,width:width,lastInParagraph:false,});}
_getTextWidth(text){var letterSpacing=this.letterSpacing();var length=text.length;return(getDummyContext().measureText(text).width+
(length?letterSpacing*(length-1):0));}
_setTextData(){var lines=this.text().split('\n'),fontSize=+this.fontSize(),textWidth=0,lineHeightPx=this.lineHeight()*fontSize,width=this.attrs.width,height=this.attrs.height,fixedWidth=width!==AUTO&&width!==undefined,fixedHeight=height!==AUTO&&height!==undefined,padding=this.padding(),maxWidth=width-padding*2,maxHeightPx=height-padding*2,currentHeightPx=0,wrap=this.wrap(),shouldWrap=wrap!==NONE,wrapAtWord=wrap!==CHAR&&shouldWrap,shouldAddEllipsis=this.ellipsis();this.textArr=[];getDummyContext().font=this._getContextFont();var additionalWidth=shouldAddEllipsis?this._getTextWidth(ELLIPSIS):0;for(var i=0,max=lines.length;i<max;++i){var line=lines[i];var lineWidth=this._getTextWidth(line);if(fixedWidth&&lineWidth>maxWidth){while(line.length>0){var low=0,high=line.length,match='',matchWidth=0;while(low<high){var mid=(low+high)>>>1,substr=line.slice(0,mid+1),substrWidth=this._getTextWidth(substr)+additionalWidth;if(substrWidth<=maxWidth){low=mid+1;match=substr;matchWidth=substrWidth;}
else{high=mid;}}
if(match){if(wrapAtWord){var wrapIndex;var nextChar=line[match.length];var nextIsSpaceOrDash=nextChar===SPACE||nextChar===DASH;if(nextIsSpaceOrDash&&matchWidth<=maxWidth){wrapIndex=match.length;}
else{wrapIndex=Math.max(match.lastIndexOf(SPACE),match.lastIndexOf(DASH))+
1;}
if(wrapIndex>0){low=wrapIndex;match=match.slice(0,low);matchWidth=this._getTextWidth(match);}}
match=match.trimRight();this._addTextLine(match);textWidth=Math.max(textWidth,matchWidth);currentHeightPx+=lineHeightPx;var shouldHandleEllipsis=this._shouldHandleEllipsis(currentHeightPx);if(shouldHandleEllipsis){this._tryToAddEllipsisToLastLine();break;}
line=line.slice(low);line=line.trimLeft();if(line.length>0){lineWidth=this._getTextWidth(line);if(lineWidth<=maxWidth){this._addTextLine(line);currentHeightPx+=lineHeightPx;textWidth=Math.max(textWidth,lineWidth);break;}}}
else{break;}}}
else{this._addTextLine(line);currentHeightPx+=lineHeightPx;textWidth=Math.max(textWidth,lineWidth);if(this._shouldHandleEllipsis(currentHeightPx)&&i<max-1){this._tryToAddEllipsisToLastLine();}}
if(this.textArr[this.textArr.length-1]){this.textArr[this.textArr.length-1].lastInParagraph=true;}
if(fixedHeight&&currentHeightPx+lineHeightPx>maxHeightPx){break;}}
this.textHeight=fontSize;this.textWidth=textWidth;}
_shouldHandleEllipsis(currentHeightPx){var fontSize=+this.fontSize(),lineHeightPx=this.lineHeight()*fontSize,height=this.attrs.height,fixedHeight=height!==AUTO&&height!==undefined,padding=this.padding(),maxHeightPx=height-padding*2,wrap=this.wrap(),shouldWrap=wrap!==NONE;return(!shouldWrap||(fixedHeight&&currentHeightPx+lineHeightPx>maxHeightPx));}
_tryToAddEllipsisToLastLine(){var width=this.attrs.width,fixedWidth=width!==AUTO&&width!==undefined,padding=this.padding(),maxWidth=width-padding*2,shouldAddEllipsis=this.ellipsis();var lastLine=this.textArr[this.textArr.length-1];if(!lastLine||!shouldAddEllipsis){return;}
if(fixedWidth){var haveSpace=this._getTextWidth(lastLine.text+ELLIPSIS)<maxWidth;if(!haveSpace){lastLine.text=lastLine.text.slice(0,lastLine.text.length-3);}}
this.textArr.splice(this.textArr.length-1,1);this._addTextLine(lastLine.text+ELLIPSIS);}
getStrokeScaleEnabled(){return true;}
_useBufferCanvas(){const hasLine=this.textDecoration().indexOf('underline')!==-1||this.textDecoration().indexOf('line-through')!==-1;const hasShadow=this.hasShadow();if(hasLine&&hasShadow){return true;}
return super._useBufferCanvas();}}
Text.prototype._fillFunc=_fillFunc$1;Text.prototype._strokeFunc=_strokeFunc$1;Text.prototype.className=TEXT_UPPER;Text.prototype._attrsAffectingSize=['text','fontSize','padding','wrap','lineHeight','letterSpacing',];_registerNode(Text);Factory.overWriteSetter(Text,'width',getNumberOrAutoValidator());Factory.overWriteSetter(Text,'height',getNumberOrAutoValidator());Factory.addGetterSetter(Text,'direction',INHERIT);Factory.addGetterSetter(Text,'fontFamily','Arial');Factory.addGetterSetter(Text,'fontSize',12,getNumberValidator());Factory.addGetterSetter(Text,'fontStyle',NORMAL$1);Factory.addGetterSetter(Text,'fontVariant',NORMAL$1);Factory.addGetterSetter(Text,'padding',0,getNumberValidator());Factory.addGetterSetter(Text,'align',LEFT);Factory.addGetterSetter(Text,'verticalAlign',TOP);Factory.addGetterSetter(Text,'lineHeight',1,getNumberValidator());Factory.addGetterSetter(Text,'wrap',WORD);Factory.addGetterSetter(Text,'ellipsis',false,getBooleanValidator());Factory.addGetterSetter(Text,'letterSpacing',0,getNumberValidator());Factory.addGetterSetter(Text,'text','',getStringValidator());Factory.addGetterSetter(Text,'textDecoration','');var EMPTY_STRING='',NORMAL='normal';function _fillFunc(context){context.fillText(this.partialText,0,0);}
function _strokeFunc(context){context.strokeText(this.partialText,0,0);}
class TextPath extends Shape{constructor(config){super(config);this.dummyCanvas=Util.createCanvasElement();this.dataArray=[];this._readDataAttribute();this.on('dataChange.konva',function(){this._readDataAttribute();this._setTextData();});this.on('textChange.konva alignChange.konva letterSpacingChange.konva kerningFuncChange.konva fontSizeChange.konva fontFamilyChange.konva',this._setTextData);this._setTextData();}
_getTextPathLength(){return Path.getPathLength(this.dataArray);}
_getPointAtLength(length){if(!this.attrs.data){return null;}
const totalLength=this.pathLength;if(length-1>totalLength){return null;}
return Path.getPointAtLengthOfDataArray(length,this.dataArray);}
_readDataAttribute(){this.dataArray=Path.parsePathData(this.attrs.data);this.pathLength=this._getTextPathLength();}
_sceneFunc(context){context.setAttr('font',this._getContextFont());context.setAttr('textBaseline',this.textBaseline());context.setAttr('textAlign','left');context.save();var textDecoration=this.textDecoration();var fill=this.fill();var fontSize=this.fontSize();var glyphInfo=this.glyphInfo;if(textDecoration==='underline'){context.beginPath();}
for(var i=0;i<glyphInfo.length;i++){context.save();var p0=glyphInfo[i].p0;context.translate(p0.x,p0.y);context.rotate(glyphInfo[i].rotation);this.partialText=glyphInfo[i].text;context.fillStrokeShape(this);if(textDecoration==='underline'){if(i===0){context.moveTo(0,fontSize/2+1);}
context.lineTo(fontSize,fontSize/2+1);}
context.restore();}
if(textDecoration==='underline'){context.strokeStyle=fill;context.lineWidth=fontSize/20;context.stroke();}
context.restore();}
_hitFunc(context){context.beginPath();var glyphInfo=this.glyphInfo;if(glyphInfo.length>=1){var p0=glyphInfo[0].p0;context.moveTo(p0.x,p0.y);}
for(var i=0;i<glyphInfo.length;i++){var p1=glyphInfo[i].p1;context.lineTo(p1.x,p1.y);}
context.setAttr('lineWidth',this.fontSize());context.setAttr('strokeStyle',this.colorKey);context.stroke();}
getTextWidth(){return this.textWidth;}
getTextHeight(){Util.warn('text.getTextHeight() method is deprecated. Use text.height() - for full height and text.fontSize() - for one line height.');return this.textHeight;}
setText(text){return Text.prototype.setText.call(this,text);}
_getContextFont(){return Text.prototype._getContextFont.call(this);}
_getTextSize(text){var dummyCanvas=this.dummyCanvas;var _context=dummyCanvas.getContext('2d');_context.save();_context.font=this._getContextFont();var metrics=_context.measureText(text);_context.restore();return{width:metrics.width,height:parseInt(`${this.fontSize()}`,10),};}
_setTextData(){const{width,height}=this._getTextSize(this.attrs.text);this.textWidth=width;this.textHeight=height;this.glyphInfo=[];if(!this.attrs.data){return null;}
const letterSpacing=this.letterSpacing();const align=this.align();const kerningFunc=this.kerningFunc();const textWidth=Math.max(this.textWidth+((this.attrs.text||'').length-1)*letterSpacing,0);let offset=0;if(align==='center'){offset=Math.max(0,this.pathLength/2-textWidth/2);}
if(align==='right'){offset=Math.max(0,this.pathLength-textWidth);}
const charArr=stringToArray(this.text());let offsetToGlyph=offset;for(var i=0;i<charArr.length;i++){const charStartPoint=this._getPointAtLength(offsetToGlyph);if(!charStartPoint)
return;let glyphWidth=this._getTextSize(charArr[i]).width+letterSpacing;if(charArr[i]===' '&&align==='justify'){const numberOfSpaces=this.text().split(' ').length-1;glyphWidth+=(this.pathLength-textWidth)/numberOfSpaces;}
const charEndPoint=this._getPointAtLength(offsetToGlyph+glyphWidth);if(!charEndPoint)
return;const width=Path.getLineLength(charStartPoint.x,charStartPoint.y,charEndPoint.x,charEndPoint.y);let kern=0;if(kerningFunc){try{kern=kerningFunc(charArr[i-1],charArr[i])*this.fontSize();}
catch(e){kern=0;}}
charStartPoint.x+=kern;charEndPoint.x+=kern;this.textWidth+=kern;const midpoint=Path.getPointOnLine(kern+width/2.0,charStartPoint.x,charStartPoint.y,charEndPoint.x,charEndPoint.y);const rotation=Math.atan2(charEndPoint.y-charStartPoint.y,charEndPoint.x-charStartPoint.x);this.glyphInfo.push({transposeX:midpoint.x,transposeY:midpoint.y,text:charArr[i],rotation:rotation,p0:charStartPoint,p1:charEndPoint,});offsetToGlyph+=glyphWidth;}}
getSelfRect(){if(!this.glyphInfo.length){return{x:0,y:0,width:0,height:0,};}
var points=[];this.glyphInfo.forEach(function(info){points.push(info.p0.x);points.push(info.p0.y);points.push(info.p1.x);points.push(info.p1.y);});var minX=points[0]||0;var maxX=points[0]||0;var minY=points[1]||0;var maxY=points[1]||0;var x,y;for(var i=0;i<points.length/2;i++){x=points[i*2];y=points[i*2+1];minX=Math.min(minX,x);maxX=Math.max(maxX,x);minY=Math.min(minY,y);maxY=Math.max(maxY,y);}
var fontSize=this.fontSize();return{x:minX-fontSize/2,y:minY-fontSize/2,width:maxX-minX+fontSize,height:maxY-minY+fontSize,};}
destroy(){Util.releaseCanvas(this.dummyCanvas);return super.destroy();}}
TextPath.prototype._fillFunc=_fillFunc;TextPath.prototype._strokeFunc=_strokeFunc;TextPath.prototype._fillFuncHit=_fillFunc;TextPath.prototype._strokeFuncHit=_strokeFunc;TextPath.prototype.className='TextPath';TextPath.prototype._attrsAffectingSize=['text','fontSize','data'];_registerNode(TextPath);Factory.addGetterSetter(TextPath,'data');Factory.addGetterSetter(TextPath,'fontFamily','Arial');Factory.addGetterSetter(TextPath,'fontSize',12,getNumberValidator());Factory.addGetterSetter(TextPath,'fontStyle',NORMAL);Factory.addGetterSetter(TextPath,'align','left');Factory.addGetterSetter(TextPath,'letterSpacing',0,getNumberValidator());Factory.addGetterSetter(TextPath,'textBaseline','middle');Factory.addGetterSetter(TextPath,'fontVariant',NORMAL);Factory.addGetterSetter(TextPath,'text',EMPTY_STRING);Factory.addGetterSetter(TextPath,'textDecoration',null);Factory.addGetterSetter(TextPath,'kerningFunc',null);var EVENTS_NAME='tr-konva';var ATTR_CHANGE_LIST=['resizeEnabledChange','rotateAnchorOffsetChange','rotateEnabledChange','enabledAnchorsChange','anchorSizeChange','borderEnabledChange','borderStrokeChange','borderStrokeWidthChange','borderDashChange','anchorStrokeChange','anchorStrokeWidthChange','anchorFillChange','anchorCornerRadiusChange','ignoreStrokeChange','anchorStyleFuncChange',].map((e)=>e+`.${EVENTS_NAME}`).join(' ');var NODES_RECT='nodesRect';var TRANSFORM_CHANGE_STR=['widthChange','heightChange','scaleXChange','scaleYChange','skewXChange','skewYChange','rotationChange','offsetXChange','offsetYChange','transformsEnabledChange','strokeWidthChange',];var ANGLES={'top-left':-45,'top-center':0,'top-right':45,'middle-right':-90,'middle-left':90,'bottom-left':-135,'bottom-center':180,'bottom-right':135,};const TOUCH_DEVICE='ontouchstart'in Konva$2._global;function getCursor(anchorName,rad,rotateCursor){if(anchorName==='rotater'){return rotateCursor;}
rad+=Util.degToRad(ANGLES[anchorName]||0);var angle=((Util.radToDeg(rad)%360)+360)%360;if(Util._inRange(angle,315+22.5,360)||Util._inRange(angle,0,22.5)){return'ns-resize';}
else if(Util._inRange(angle,45-22.5,45+22.5)){return'nesw-resize';}
else if(Util._inRange(angle,90-22.5,90+22.5)){return'ew-resize';}
else if(Util._inRange(angle,135-22.5,135+22.5)){return'nwse-resize';}
else if(Util._inRange(angle,180-22.5,180+22.5)){return'ns-resize';}
else if(Util._inRange(angle,225-22.5,225+22.5)){return'nesw-resize';}
else if(Util._inRange(angle,270-22.5,270+22.5)){return'ew-resize';}
else if(Util._inRange(angle,315-22.5,315+22.5)){return'nwse-resize';}
else{Util.error('Transformer has unknown angle for cursor detection: '+angle);return'pointer';}}
var ANCHORS_NAMES=['top-left','top-center','top-right','middle-right','middle-left','bottom-left','bottom-center','bottom-right',];var MAX_SAFE_INTEGER=100000000;function getCenter(shape){return{x:shape.x+
(shape.width/2)*Math.cos(shape.rotation)+
(shape.height/2)*Math.sin(-shape.rotation),y:shape.y+
(shape.height/2)*Math.cos(shape.rotation)+
(shape.width/2)*Math.sin(shape.rotation),};}
function rotateAroundPoint(shape,angleRad,point){const x=point.x+
(shape.x-point.x)*Math.cos(angleRad)-
(shape.y-point.y)*Math.sin(angleRad);const y=point.y+
(shape.x-point.x)*Math.sin(angleRad)+
(shape.y-point.y)*Math.cos(angleRad);return{...shape,rotation:shape.rotation+angleRad,x,y,};}
function rotateAroundCenter(shape,deltaRad){const center=getCenter(shape);return rotateAroundPoint(shape,deltaRad,center);}
function getSnap(snaps,newRotationRad,tol){let snapped=newRotationRad;for(let i=0;i<snaps.length;i++){const angle=Konva$2.getAngle(snaps[i]);const absDiff=Math.abs(angle-newRotationRad)%(Math.PI*2);const dif=Math.min(absDiff,Math.PI*2-absDiff);if(dif<tol){snapped=angle;}}
return snapped;}
let activeTransformersCount=0;class Transformer extends Group{constructor(config){super(config);this._movingAnchorName=null;this._transforming=false;this._createElements();this._handleMouseMove=this._handleMouseMove.bind(this);this._handleMouseUp=this._handleMouseUp.bind(this);this.update=this.update.bind(this);this.on(ATTR_CHANGE_LIST,this.update);if(this.getNode()){this.update();}}
attachTo(node){this.setNode(node);return this;}
setNode(node){Util.warn('tr.setNode(shape), tr.node(shape) and tr.attachTo(shape) methods are deprecated. Please use tr.nodes(nodesArray) instead.');return this.setNodes([node]);}
getNode(){return this._nodes&&this._nodes[0];}
_getEventNamespace(){return EVENTS_NAME+this._id;}
setNodes(nodes=[]){if(this._nodes&&this._nodes.length){this.detach();}
const filteredNodes=nodes.filter((node)=>{if(node.isAncestorOf(this)){Util.error('Konva.Transformer cannot be an a child of the node you are trying to attach');return false;}
return true;});this._nodes=nodes=filteredNodes;if(nodes.length===1&&this.useSingleNodeRotation()){this.rotation(nodes[0].getAbsoluteRotation());}
else{this.rotation(0);}
this._nodes.forEach((node)=>{const onChange=()=>{if(this.nodes().length===1&&this.useSingleNodeRotation()){this.rotation(this.nodes()[0].getAbsoluteRotation());}
this._resetTransformCache();if(!this._transforming&&!this.isDragging()){this.update();}};const additionalEvents=node._attrsAffectingSize.map((prop)=>prop+'Change.'+this._getEventNamespace()).join(' ');node.on(additionalEvents,onChange);node.on(TRANSFORM_CHANGE_STR.map((e)=>e+`.${this._getEventNamespace()}`).join(' '),onChange);node.on(`absoluteTransformChange.${this._getEventNamespace()}`,onChange);this._proxyDrag(node);});this._resetTransformCache();var elementsCreated=!!this.findOne('.top-left');if(elementsCreated){this.update();}
return this;}
_proxyDrag(node){let lastPos;node.on(`dragstart.${this._getEventNamespace()}`,(e)=>{lastPos=node.getAbsolutePosition();if(!this.isDragging()&&node!==this.findOne('.back')){this.startDrag(e,false);}});node.on(`dragmove.${this._getEventNamespace()}`,(e)=>{if(!lastPos){return;}
const abs=node.getAbsolutePosition();const dx=abs.x-lastPos.x;const dy=abs.y-lastPos.y;this.nodes().forEach((otherNode)=>{if(otherNode===node){return;}
if(otherNode.isDragging()){return;}
const otherAbs=otherNode.getAbsolutePosition();otherNode.setAbsolutePosition({x:otherAbs.x+dx,y:otherAbs.y+dy,});otherNode.startDrag(e);});lastPos=null;});}
getNodes(){return this._nodes||[];}
getActiveAnchor(){return this._movingAnchorName;}
detach(){if(this._nodes){this._nodes.forEach((node)=>{node.off('.'+this._getEventNamespace());});}
this._nodes=[];this._resetTransformCache();}
_resetTransformCache(){this._clearCache(NODES_RECT);this._clearCache('transform');this._clearSelfAndDescendantCache('absoluteTransform');}
_getNodeRect(){return this._getCache(NODES_RECT,this.__getNodeRect);}
__getNodeShape(node,rot=this.rotation(),relative){var rect=node.getClientRect({skipTransform:true,skipShadow:true,skipStroke:this.ignoreStroke(),});var absScale=node.getAbsoluteScale(relative);var absPos=node.getAbsolutePosition(relative);var dx=rect.x*absScale.x-node.offsetX()*absScale.x;var dy=rect.y*absScale.y-node.offsetY()*absScale.y;const rotation=(Konva$2.getAngle(node.getAbsoluteRotation())+Math.PI*2)%(Math.PI*2);const box={x:absPos.x+dx*Math.cos(rotation)+dy*Math.sin(-rotation),y:absPos.y+dy*Math.cos(rotation)+dx*Math.sin(rotation),width:rect.width*absScale.x,height:rect.height*absScale.y,rotation:rotation,};return rotateAroundPoint(box,-Konva$2.getAngle(rot),{x:0,y:0,});}
__getNodeRect(){var node=this.getNode();if(!node){return{x:-MAX_SAFE_INTEGER,y:-MAX_SAFE_INTEGER,width:0,height:0,rotation:0,};}
const totalPoints=[];this.nodes().map((node)=>{const box=node.getClientRect({skipTransform:true,skipShadow:true,skipStroke:this.ignoreStroke(),});var points=[{x:box.x,y:box.y},{x:box.x+box.width,y:box.y},{x:box.x+box.width,y:box.y+box.height},{x:box.x,y:box.y+box.height},];var trans=node.getAbsoluteTransform();points.forEach(function(point){var transformed=trans.point(point);totalPoints.push(transformed);});});const tr=new Transform();tr.rotate(-Konva$2.getAngle(this.rotation()));var minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;totalPoints.forEach(function(point){var transformed=tr.point(point);if(minX===undefined){minX=maxX=transformed.x;minY=maxY=transformed.y;}
minX=Math.min(minX,transformed.x);minY=Math.min(minY,transformed.y);maxX=Math.max(maxX,transformed.x);maxY=Math.max(maxY,transformed.y);});tr.invert();const p=tr.point({x:minX,y:minY});return{x:p.x,y:p.y,width:maxX-minX,height:maxY-minY,rotation:Konva$2.getAngle(this.rotation()),};}
getX(){return this._getNodeRect().x;}
getY(){return this._getNodeRect().y;}
getWidth(){return this._getNodeRect().width;}
getHeight(){return this._getNodeRect().height;}
_createElements(){this._createBack();ANCHORS_NAMES.forEach((name)=>{this._createAnchor(name);});this._createAnchor('rotater');}
_createAnchor(name){var anchor=new Rect({stroke:'rgb(0, 161, 255)',fill:'white',strokeWidth:1,name:name+' _anchor',dragDistance:0,draggable:true,hitStrokeWidth:TOUCH_DEVICE?10:'auto',});var self=this;anchor.on('mousedown touchstart',function(e){self._handleMouseDown(e);});anchor.on('dragstart',(e)=>{anchor.stopDrag();e.cancelBubble=true;});anchor.on('dragend',(e)=>{e.cancelBubble=true;});anchor.on('mouseenter',()=>{var rad=Konva$2.getAngle(this.rotation());var rotateCursor=this.rotateAnchorCursor();var cursor=getCursor(name,rad,rotateCursor);anchor.getStage().content&&(anchor.getStage().content.style.cursor=cursor);this._cursorChange=true;});anchor.on('mouseout',()=>{anchor.getStage().content&&(anchor.getStage().content.style.cursor='');this._cursorChange=false;});this.add(anchor);}
_createBack(){var back=new Shape({name:'back',width:0,height:0,draggable:true,sceneFunc(ctx,shape){var tr=shape.getParent();var padding=tr.padding();ctx.beginPath();ctx.rect(-padding,-padding,shape.width()+padding*2,shape.height()+padding*2);ctx.moveTo(shape.width()/2,-padding);if(tr.rotateEnabled()&&tr.rotateLineVisible()){ctx.lineTo(shape.width()/2,-tr.rotateAnchorOffset()*Util._sign(shape.height())-padding);}
ctx.fillStrokeShape(shape);},hitFunc:(ctx,shape)=>{if(!this.shouldOverdrawWholeArea()){return;}
var padding=this.padding();ctx.beginPath();ctx.rect(-padding,-padding,shape.width()+padding*2,shape.height()+padding*2);ctx.fillStrokeShape(shape);},});this.add(back);this._proxyDrag(back);back.on('dragstart',(e)=>{e.cancelBubble=true;});back.on('dragmove',(e)=>{e.cancelBubble=true;});back.on('dragend',(e)=>{e.cancelBubble=true;});this.on('dragmove',(e)=>{this.update();});}
_handleMouseDown(e){this._movingAnchorName=e.target.name().split(' ')[0];var attrs=this._getNodeRect();var width=attrs.width;var height=attrs.height;var hypotenuse=Math.sqrt(Math.pow(width,2)+Math.pow(height,2));this.sin=Math.abs(height/hypotenuse);this.cos=Math.abs(width/hypotenuse);if(typeof window!=='undefined'){window.addEventListener('mousemove',this._handleMouseMove);window.addEventListener('touchmove',this._handleMouseMove);window.addEventListener('mouseup',this._handleMouseUp,true);window.addEventListener('touchend',this._handleMouseUp,true);}
this._transforming=true;var ap=e.target.getAbsolutePosition();var pos=e.target.getStage().getPointerPosition();this._anchorDragOffset={x:pos.x-ap.x,y:pos.y-ap.y,};activeTransformersCount++;this._fire('transformstart',{evt:e.evt,target:this.getNode()});this._nodes.forEach((target)=>{target._fire('transformstart',{evt:e.evt,target});});}
_handleMouseMove(e){var x,y,newHypotenuse;var anchorNode=this.findOne('.'+this._movingAnchorName);var stage=anchorNode.getStage();stage.setPointersPositions(e);const pp=stage.getPointerPosition();let newNodePos={x:pp.x-this._anchorDragOffset.x,y:pp.y-this._anchorDragOffset.y,};const oldAbs=anchorNode.getAbsolutePosition();if(this.anchorDragBoundFunc()){newNodePos=this.anchorDragBoundFunc()(oldAbs,newNodePos,e);}
anchorNode.setAbsolutePosition(newNodePos);const newAbs=anchorNode.getAbsolutePosition();if(oldAbs.x===newAbs.x&&oldAbs.y===newAbs.y){return;}
if(this._movingAnchorName==='rotater'){var attrs=this._getNodeRect();x=anchorNode.x()-attrs.width/2;y=-anchorNode.y()+attrs.height/2;let delta=Math.atan2(-y,x)+Math.PI/2;if(attrs.height<0){delta-=Math.PI;}
var oldRotation=Konva$2.getAngle(this.rotation());const newRotation=oldRotation+delta;const tol=Konva$2.getAngle(this.rotationSnapTolerance());const snappedRot=getSnap(this.rotationSnaps(),newRotation,tol);const diff=snappedRot-attrs.rotation;const shape=rotateAroundCenter(attrs,diff);this._fitNodesInto(shape,e);return;}
var shiftBehavior=this.shiftBehavior();var keepProportion;if(shiftBehavior==='inverted'){keepProportion=this.keepRatio()&&!e.shiftKey;}
else if(shiftBehavior==='none'){keepProportion=this.keepRatio();}
else{keepProportion=this.keepRatio()||e.shiftKey;}
var centeredScaling=this.centeredScaling()||e.altKey;if(this._movingAnchorName==='top-left'){if(keepProportion){var comparePoint=centeredScaling?{x:this.width()/2,y:this.height()/2,}:{x:this.findOne('.bottom-right').x(),y:this.findOne('.bottom-right').y(),};newHypotenuse=Math.sqrt(Math.pow(comparePoint.x-anchorNode.x(),2)+
Math.pow(comparePoint.y-anchorNode.y(),2));var reverseX=this.findOne('.top-left').x()>comparePoint.x?-1:1;var reverseY=this.findOne('.top-left').y()>comparePoint.y?-1:1;x=newHypotenuse*this.cos*reverseX;y=newHypotenuse*this.sin*reverseY;this.findOne('.top-left').x(comparePoint.x-x);this.findOne('.top-left').y(comparePoint.y-y);}}
else if(this._movingAnchorName==='top-center'){this.findOne('.top-left').y(anchorNode.y());}
else if(this._movingAnchorName==='top-right'){if(keepProportion){var comparePoint=centeredScaling?{x:this.width()/2,y:this.height()/2,}:{x:this.findOne('.bottom-left').x(),y:this.findOne('.bottom-left').y(),};newHypotenuse=Math.sqrt(Math.pow(anchorNode.x()-comparePoint.x,2)+
Math.pow(comparePoint.y-anchorNode.y(),2));var reverseX=this.findOne('.top-right').x()<comparePoint.x?-1:1;var reverseY=this.findOne('.top-right').y()>comparePoint.y?-1:1;x=newHypotenuse*this.cos*reverseX;y=newHypotenuse*this.sin*reverseY;this.findOne('.top-right').x(comparePoint.x+x);this.findOne('.top-right').y(comparePoint.y-y);}
var pos=anchorNode.position();this.findOne('.top-left').y(pos.y);this.findOne('.bottom-right').x(pos.x);}
else if(this._movingAnchorName==='middle-left'){this.findOne('.top-left').x(anchorNode.x());}
else if(this._movingAnchorName==='middle-right'){this.findOne('.bottom-right').x(anchorNode.x());}
else if(this._movingAnchorName==='bottom-left'){if(keepProportion){var comparePoint=centeredScaling?{x:this.width()/2,y:this.height()/2,}:{x:this.findOne('.top-right').x(),y:this.findOne('.top-right').y(),};newHypotenuse=Math.sqrt(Math.pow(comparePoint.x-anchorNode.x(),2)+
Math.pow(anchorNode.y()-comparePoint.y,2));var reverseX=comparePoint.x<anchorNode.x()?-1:1;var reverseY=anchorNode.y()<comparePoint.y?-1:1;x=newHypotenuse*this.cos*reverseX;y=newHypotenuse*this.sin*reverseY;anchorNode.x(comparePoint.x-x);anchorNode.y(comparePoint.y+y);}
pos=anchorNode.position();this.findOne('.top-left').x(pos.x);this.findOne('.bottom-right').y(pos.y);}
else if(this._movingAnchorName==='bottom-center'){this.findOne('.bottom-right').y(anchorNode.y());}
else if(this._movingAnchorName==='bottom-right'){if(keepProportion){var comparePoint=centeredScaling?{x:this.width()/2,y:this.height()/2,}:{x:this.findOne('.top-left').x(),y:this.findOne('.top-left').y(),};newHypotenuse=Math.sqrt(Math.pow(anchorNode.x()-comparePoint.x,2)+
Math.pow(anchorNode.y()-comparePoint.y,2));var reverseX=this.findOne('.bottom-right').x()<comparePoint.x?-1:1;var reverseY=this.findOne('.bottom-right').y()<comparePoint.y?-1:1;x=newHypotenuse*this.cos*reverseX;y=newHypotenuse*this.sin*reverseY;this.findOne('.bottom-right').x(comparePoint.x+x);this.findOne('.bottom-right').y(comparePoint.y+y);}}
else{console.error(new Error('Wrong position argument of selection resizer: '+
this._movingAnchorName));}
var centeredScaling=this.centeredScaling()||e.altKey;if(centeredScaling){var topLeft=this.findOne('.top-left');var bottomRight=this.findOne('.bottom-right');var topOffsetX=topLeft.x();var topOffsetY=topLeft.y();var bottomOffsetX=this.getWidth()-bottomRight.x();var bottomOffsetY=this.getHeight()-bottomRight.y();bottomRight.move({x:-topOffsetX,y:-topOffsetY,});topLeft.move({x:bottomOffsetX,y:bottomOffsetY,});}
var absPos=this.findOne('.top-left').getAbsolutePosition();x=absPos.x;y=absPos.y;var width=this.findOne('.bottom-right').x()-this.findOne('.top-left').x();var height=this.findOne('.bottom-right').y()-this.findOne('.top-left').y();this._fitNodesInto({x:x,y:y,width:width,height:height,rotation:Konva$2.getAngle(this.rotation()),},e);}
_handleMouseUp(e){this._removeEvents(e);}
getAbsoluteTransform(){return this.getTransform();}
_removeEvents(e){var _a;if(this._transforming){this._transforming=false;if(typeof window!=='undefined'){window.removeEventListener('mousemove',this._handleMouseMove);window.removeEventListener('touchmove',this._handleMouseMove);window.removeEventListener('mouseup',this._handleMouseUp,true);window.removeEventListener('touchend',this._handleMouseUp,true);}
var node=this.getNode();activeTransformersCount--;this._fire('transformend',{evt:e,target:node});(_a=this.getLayer())===null||_a===void 0?void 0:_a.batchDraw();if(node){this._nodes.forEach((target)=>{var _a;target._fire('transformend',{evt:e,target});(_a=target.getLayer())===null||_a===void 0?void 0:_a.batchDraw();});}
this._movingAnchorName=null;}}
_fitNodesInto(newAttrs,evt){var oldAttrs=this._getNodeRect();const minSize=1;if(Util._inRange(newAttrs.width,-this.padding()*2-minSize,minSize)){this.update();return;}
if(Util._inRange(newAttrs.height,-this.padding()*2-minSize,minSize)){this.update();return;}
var t=new Transform();t.rotate(Konva$2.getAngle(this.rotation()));if(this._movingAnchorName&&newAttrs.width<0&&this._movingAnchorName.indexOf('left')>=0){const offset=t.point({x:-this.padding()*2,y:0,});newAttrs.x+=offset.x;newAttrs.y+=offset.y;newAttrs.width+=this.padding()*2;this._movingAnchorName=this._movingAnchorName.replace('left','right');this._anchorDragOffset.x-=offset.x;this._anchorDragOffset.y-=offset.y;}
else if(this._movingAnchorName&&newAttrs.width<0&&this._movingAnchorName.indexOf('right')>=0){const offset=t.point({x:this.padding()*2,y:0,});this._movingAnchorName=this._movingAnchorName.replace('right','left');this._anchorDragOffset.x-=offset.x;this._anchorDragOffset.y-=offset.y;newAttrs.width+=this.padding()*2;}
if(this._movingAnchorName&&newAttrs.height<0&&this._movingAnchorName.indexOf('top')>=0){const offset=t.point({x:0,y:-this.padding()*2,});newAttrs.x+=offset.x;newAttrs.y+=offset.y;this._movingAnchorName=this._movingAnchorName.replace('top','bottom');this._anchorDragOffset.x-=offset.x;this._anchorDragOffset.y-=offset.y;newAttrs.height+=this.padding()*2;}
else if(this._movingAnchorName&&newAttrs.height<0&&this._movingAnchorName.indexOf('bottom')>=0){const offset=t.point({x:0,y:this.padding()*2,});this._movingAnchorName=this._movingAnchorName.replace('bottom','top');this._anchorDragOffset.x-=offset.x;this._anchorDragOffset.y-=offset.y;newAttrs.height+=this.padding()*2;}
if(this.boundBoxFunc()){const bounded=this.boundBoxFunc()(oldAttrs,newAttrs);if(bounded){newAttrs=bounded;}
else{Util.warn('boundBoxFunc returned falsy. You should return new bound rect from it!');}}
const baseSize=10000000;const oldTr=new Transform();oldTr.translate(oldAttrs.x,oldAttrs.y);oldTr.rotate(oldAttrs.rotation);oldTr.scale(oldAttrs.width/baseSize,oldAttrs.height/baseSize);const newTr=new Transform();const newScaleX=newAttrs.width/baseSize;const newScaleY=newAttrs.height/baseSize;if(this.flipEnabled()===false){newTr.translate(newAttrs.x,newAttrs.y);newTr.rotate(newAttrs.rotation);newTr.translate(newAttrs.width<0?newAttrs.width:0,newAttrs.height<0?newAttrs.height:0);newTr.scale(Math.abs(newScaleX),Math.abs(newScaleY));}
else{newTr.translate(newAttrs.x,newAttrs.y);newTr.rotate(newAttrs.rotation);newTr.scale(newScaleX,newScaleY);}
const delta=newTr.multiply(oldTr.invert());this._nodes.forEach((node)=>{var _a;const parentTransform=node.getParent().getAbsoluteTransform();const localTransform=node.getTransform().copy();localTransform.translate(node.offsetX(),node.offsetY());const newLocalTransform=new Transform();newLocalTransform.multiply(parentTransform.copy().invert()).multiply(delta).multiply(parentTransform).multiply(localTransform);const attrs=newLocalTransform.decompose();node.setAttrs(attrs);(_a=node.getLayer())===null||_a===void 0?void 0:_a.batchDraw();});this.rotation(Util._getRotation(newAttrs.rotation));this._nodes.forEach((node)=>{this._fire('transform',{evt:evt,target:node});node._fire('transform',{evt:evt,target:node});});this._resetTransformCache();this.update();this.getLayer().batchDraw();}
forceUpdate(){this._resetTransformCache();this.update();}
_batchChangeChild(selector,attrs){const anchor=this.findOne(selector);anchor.setAttrs(attrs);}
update(){var _a;var attrs=this._getNodeRect();this.rotation(Util._getRotation(attrs.rotation));var width=attrs.width;var height=attrs.height;var enabledAnchors=this.enabledAnchors();var resizeEnabled=this.resizeEnabled();var padding=this.padding();var anchorSize=this.anchorSize();const anchors=this.find('._anchor');anchors.forEach((node)=>{node.setAttrs({width:anchorSize,height:anchorSize,offsetX:anchorSize/2,offsetY:anchorSize/2,stroke:this.anchorStroke(),strokeWidth:this.anchorStrokeWidth(),fill:this.anchorFill(),cornerRadius:this.anchorCornerRadius(),});});this._batchChangeChild('.top-left',{x:0,y:0,offsetX:anchorSize/2+padding,offsetY:anchorSize/2+padding,visible:resizeEnabled&&enabledAnchors.indexOf('top-left')>=0,});this._batchChangeChild('.top-center',{x:width/2,y:0,offsetY:anchorSize/2+padding,visible:resizeEnabled&&enabledAnchors.indexOf('top-center')>=0,});this._batchChangeChild('.top-right',{x:width,y:0,offsetX:anchorSize/2-padding,offsetY:anchorSize/2+padding,visible:resizeEnabled&&enabledAnchors.indexOf('top-right')>=0,});this._batchChangeChild('.middle-left',{x:0,y:height/2,offsetX:anchorSize/2+padding,visible:resizeEnabled&&enabledAnchors.indexOf('middle-left')>=0,});this._batchChangeChild('.middle-right',{x:width,y:height/2,offsetX:anchorSize/2-padding,visible:resizeEnabled&&enabledAnchors.indexOf('middle-right')>=0,});this._batchChangeChild('.bottom-left',{x:0,y:height,offsetX:anchorSize/2+padding,offsetY:anchorSize/2-padding,visible:resizeEnabled&&enabledAnchors.indexOf('bottom-left')>=0,});this._batchChangeChild('.bottom-center',{x:width/2,y:height,offsetY:anchorSize/2-padding,visible:resizeEnabled&&enabledAnchors.indexOf('bottom-center')>=0,});this._batchChangeChild('.bottom-right',{x:width,y:height,offsetX:anchorSize/2-padding,offsetY:anchorSize/2-padding,visible:resizeEnabled&&enabledAnchors.indexOf('bottom-right')>=0,});this._batchChangeChild('.rotater',{x:width/2,y:-this.rotateAnchorOffset()*Util._sign(height)-padding,visible:this.rotateEnabled(),});this._batchChangeChild('.back',{width:width,height:height,visible:this.borderEnabled(),stroke:this.borderStroke(),strokeWidth:this.borderStrokeWidth(),dash:this.borderDash(),x:0,y:0,});const styleFunc=this.anchorStyleFunc();if(styleFunc){anchors.forEach((node)=>{styleFunc(node);});}
(_a=this.getLayer())===null||_a===void 0?void 0:_a.batchDraw();}
isTransforming(){return this._transforming;}
stopTransform(){if(this._transforming){this._removeEvents();var anchorNode=this.findOne('.'+this._movingAnchorName);if(anchorNode){anchorNode.stopDrag();}}}
destroy(){if(this.getStage()&&this._cursorChange){this.getStage().content&&(this.getStage().content.style.cursor='');}
Group.prototype.destroy.call(this);this.detach();this._removeEvents();return this;}
toObject(){return Node.prototype.toObject.call(this);}
clone(obj){var node=Node.prototype.clone.call(this,obj);return node;}
getClientRect(){if(this.nodes().length>0){return super.getClientRect();}
else{return{x:0,y:0,width:0,height:0};}}}
Transformer.isTransforming=()=>{return activeTransformersCount>0;};function validateAnchors(val){if(!(val instanceof Array)){Util.warn('enabledAnchors value should be an array');}
if(val instanceof Array){val.forEach(function(name){if(ANCHORS_NAMES.indexOf(name)===-1){Util.warn('Unknown anchor name: '+
name+'. Available names are: '+
ANCHORS_NAMES.join(', '));}});}
return val||[];}
Transformer.prototype.className='Transformer';_registerNode(Transformer);Factory.addGetterSetter(Transformer,'enabledAnchors',ANCHORS_NAMES,validateAnchors);Factory.addGetterSetter(Transformer,'flipEnabled',true,getBooleanValidator());Factory.addGetterSetter(Transformer,'resizeEnabled',true);Factory.addGetterSetter(Transformer,'anchorSize',10,getNumberValidator());Factory.addGetterSetter(Transformer,'rotateEnabled',true);Factory.addGetterSetter(Transformer,'rotateLineVisible',true);Factory.addGetterSetter(Transformer,'rotationSnaps',[]);Factory.addGetterSetter(Transformer,'rotateAnchorOffset',50,getNumberValidator());Factory.addGetterSetter(Transformer,'rotateAnchorCursor','crosshair');Factory.addGetterSetter(Transformer,'rotationSnapTolerance',5,getNumberValidator());Factory.addGetterSetter(Transformer,'borderEnabled',true);Factory.addGetterSetter(Transformer,'anchorStroke','rgb(0, 161, 255)');Factory.addGetterSetter(Transformer,'anchorStrokeWidth',1,getNumberValidator());Factory.addGetterSetter(Transformer,'anchorFill','white');Factory.addGetterSetter(Transformer,'anchorCornerRadius',0,getNumberValidator());Factory.addGetterSetter(Transformer,'borderStroke','rgb(0, 161, 255)');Factory.addGetterSetter(Transformer,'borderStrokeWidth',1,getNumberValidator());Factory.addGetterSetter(Transformer,'borderDash');Factory.addGetterSetter(Transformer,'keepRatio',true);Factory.addGetterSetter(Transformer,'shiftBehavior','default');Factory.addGetterSetter(Transformer,'centeredScaling',false);Factory.addGetterSetter(Transformer,'ignoreStroke',false);Factory.addGetterSetter(Transformer,'padding',0,getNumberValidator());Factory.addGetterSetter(Transformer,'node');Factory.addGetterSetter(Transformer,'nodes');Factory.addGetterSetter(Transformer,'boundBoxFunc');Factory.addGetterSetter(Transformer,'anchorDragBoundFunc');Factory.addGetterSetter(Transformer,'anchorStyleFunc');Factory.addGetterSetter(Transformer,'shouldOverdrawWholeArea',false);Factory.addGetterSetter(Transformer,'useSingleNodeRotation',true);Factory.backCompat(Transformer,{lineEnabled:'borderEnabled',rotateHandlerOffset:'rotateAnchorOffset',enabledHandlers:'enabledAnchors',});class Wedge extends Shape{_sceneFunc(context){context.beginPath();context.arc(0,0,this.radius(),0,Konva$2.getAngle(this.angle()),this.clockwise());context.lineTo(0,0);context.closePath();context.fillStrokeShape(this);}
getWidth(){return this.radius()*2;}
getHeight(){return this.radius()*2;}
setWidth(width){this.radius(width/2);}
setHeight(height){this.radius(height/2);}}
Wedge.prototype.className='Wedge';Wedge.prototype._centroid=true;Wedge.prototype._attrsAffectingSize=['radius'];_registerNode(Wedge);Factory.addGetterSetter(Wedge,'radius',0,getNumberValidator());Factory.addGetterSetter(Wedge,'angle',0,getNumberValidator());Factory.addGetterSetter(Wedge,'clockwise',false);Factory.backCompat(Wedge,{angleDeg:'angle',getAngleDeg:'getAngle',setAngleDeg:'setAngle',});function BlurStack(){this.r=0;this.g=0;this.b=0;this.a=0;this.next=null;}
var mul_table=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259,];var shg_table=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,];function filterGaussBlurRGBA(imageData,radius){var pixels=imageData.data,width=imageData.width,height=imageData.height;var x,y,i,p,yp,yi,yw,r_sum,g_sum,b_sum,a_sum,r_out_sum,g_out_sum,b_out_sum,a_out_sum,r_in_sum,g_in_sum,b_in_sum,a_in_sum,pr,pg,pb,pa,rbs;var div=radius+radius+1,widthMinus1=width-1,heightMinus1=height-1,radiusPlus1=radius+1,sumFactor=(radiusPlus1*(radiusPlus1+1))/2,stackStart=new BlurStack(),stackEnd=null,stack=stackStart,stackIn=null,stackOut=null,mul_sum=mul_table[radius],shg_sum=shg_table[radius];for(i=1;i<div;i++){stack=stack.next=new BlurStack();if(i===radiusPlus1){stackEnd=stack;}}
stack.next=stackStart;yw=yi=0;for(y=0;y<height;y++){r_in_sum=g_in_sum=b_in_sum=a_in_sum=r_sum=g_sum=b_sum=a_sum=0;r_out_sum=radiusPlus1*(pr=pixels[yi]);g_out_sum=radiusPlus1*(pg=pixels[yi+1]);b_out_sum=radiusPlus1*(pb=pixels[yi+2]);a_out_sum=radiusPlus1*(pa=pixels[yi+3]);r_sum+=sumFactor*pr;g_sum+=sumFactor*pg;b_sum+=sumFactor*pb;a_sum+=sumFactor*pa;stack=stackStart;for(i=0;i<radiusPlus1;i++){stack.r=pr;stack.g=pg;stack.b=pb;stack.a=pa;stack=stack.next;}
for(i=1;i<radiusPlus1;i++){p=yi+((widthMinus1<i?widthMinus1:i)<<2);r_sum+=(stack.r=pr=pixels[p])*(rbs=radiusPlus1-i);g_sum+=(stack.g=pg=pixels[p+1])*rbs;b_sum+=(stack.b=pb=pixels[p+2])*rbs;a_sum+=(stack.a=pa=pixels[p+3])*rbs;r_in_sum+=pr;g_in_sum+=pg;b_in_sum+=pb;a_in_sum+=pa;stack=stack.next;}
stackIn=stackStart;stackOut=stackEnd;for(x=0;x<width;x++){pixels[yi+3]=pa=(a_sum*mul_sum)>>shg_sum;if(pa!==0){pa=255/pa;pixels[yi]=((r_sum*mul_sum)>>shg_sum)*pa;pixels[yi+1]=((g_sum*mul_sum)>>shg_sum)*pa;pixels[yi+2]=((b_sum*mul_sum)>>shg_sum)*pa;}
else{pixels[yi]=pixels[yi+1]=pixels[yi+2]=0;}
r_sum-=r_out_sum;g_sum-=g_out_sum;b_sum-=b_out_sum;a_sum-=a_out_sum;r_out_sum-=stackIn.r;g_out_sum-=stackIn.g;b_out_sum-=stackIn.b;a_out_sum-=stackIn.a;p=(yw+((p=x+radius+1)<widthMinus1?p:widthMinus1))<<2;r_in_sum+=stackIn.r=pixels[p];g_in_sum+=stackIn.g=pixels[p+1];b_in_sum+=stackIn.b=pixels[p+2];a_in_sum+=stackIn.a=pixels[p+3];r_sum+=r_in_sum;g_sum+=g_in_sum;b_sum+=b_in_sum;a_sum+=a_in_sum;stackIn=stackIn.next;r_out_sum+=pr=stackOut.r;g_out_sum+=pg=stackOut.g;b_out_sum+=pb=stackOut.b;a_out_sum+=pa=stackOut.a;r_in_sum-=pr;g_in_sum-=pg;b_in_sum-=pb;a_in_sum-=pa;stackOut=stackOut.next;yi+=4;}
yw+=width;}
for(x=0;x<width;x++){g_in_sum=b_in_sum=a_in_sum=r_in_sum=g_sum=b_sum=a_sum=r_sum=0;yi=x<<2;r_out_sum=radiusPlus1*(pr=pixels[yi]);g_out_sum=radiusPlus1*(pg=pixels[yi+1]);b_out_sum=radiusPlus1*(pb=pixels[yi+2]);a_out_sum=radiusPlus1*(pa=pixels[yi+3]);r_sum+=sumFactor*pr;g_sum+=sumFactor*pg;b_sum+=sumFactor*pb;a_sum+=sumFactor*pa;stack=stackStart;for(i=0;i<radiusPlus1;i++){stack.r=pr;stack.g=pg;stack.b=pb;stack.a=pa;stack=stack.next;}
yp=width;for(i=1;i<=radius;i++){yi=(yp+x)<<2;r_sum+=(stack.r=pr=pixels[yi])*(rbs=radiusPlus1-i);g_sum+=(stack.g=pg=pixels[yi+1])*rbs;b_sum+=(stack.b=pb=pixels[yi+2])*rbs;a_sum+=(stack.a=pa=pixels[yi+3])*rbs;r_in_sum+=pr;g_in_sum+=pg;b_in_sum+=pb;a_in_sum+=pa;stack=stack.next;if(i<heightMinus1){yp+=width;}}
yi=x;stackIn=stackStart;stackOut=stackEnd;for(y=0;y<height;y++){p=yi<<2;pixels[p+3]=pa=(a_sum*mul_sum)>>shg_sum;if(pa>0){pa=255/pa;pixels[p]=((r_sum*mul_sum)>>shg_sum)*pa;pixels[p+1]=((g_sum*mul_sum)>>shg_sum)*pa;pixels[p+2]=((b_sum*mul_sum)>>shg_sum)*pa;}
else{pixels[p]=pixels[p+1]=pixels[p+2]=0;}
r_sum-=r_out_sum;g_sum-=g_out_sum;b_sum-=b_out_sum;a_sum-=a_out_sum;r_out_sum-=stackIn.r;g_out_sum-=stackIn.g;b_out_sum-=stackIn.b;a_out_sum-=stackIn.a;p=(x+
((p=y+radiusPlus1)<heightMinus1?p:heightMinus1)*width)<<2;r_sum+=r_in_sum+=stackIn.r=pixels[p];g_sum+=g_in_sum+=stackIn.g=pixels[p+1];b_sum+=b_in_sum+=stackIn.b=pixels[p+2];a_sum+=a_in_sum+=stackIn.a=pixels[p+3];stackIn=stackIn.next;r_out_sum+=pr=stackOut.r;g_out_sum+=pg=stackOut.g;b_out_sum+=pb=stackOut.b;a_out_sum+=pa=stackOut.a;r_in_sum-=pr;g_in_sum-=pg;b_in_sum-=pb;a_in_sum-=pa;stackOut=stackOut.next;yi+=width;}}}
const Blur=function Blur(imageData){var radius=Math.round(this.blurRadius());if(radius>0){filterGaussBlurRGBA(imageData,radius);}};Factory.addGetterSetter(Node,'blurRadius',0,getNumberValidator(),Factory.afterSetFilter);const Brighten=function(imageData){var brightness=this.brightness()*255,data=imageData.data,len=data.length,i;for(i=0;i<len;i+=4){data[i]+=brightness;data[i+1]+=brightness;data[i+2]+=brightness;}};Factory.addGetterSetter(Node,'brightness',0,getNumberValidator(),Factory.afterSetFilter);const Contrast=function(imageData){var adjust=Math.pow((this.contrast()+100)/100,2);var data=imageData.data,nPixels=data.length,red=150,green=150,blue=150,i;for(i=0;i<nPixels;i+=4){red=data[i];green=data[i+1];blue=data[i+2];red/=255;red-=0.5;red*=adjust;red+=0.5;red*=255;green/=255;green-=0.5;green*=adjust;green+=0.5;green*=255;blue/=255;blue-=0.5;blue*=adjust;blue+=0.5;blue*=255;red=red<0?0:red>255?255:red;green=green<0?0:green>255?255:green;blue=blue<0?0:blue>255?255:blue;data[i]=red;data[i+1]=green;data[i+2]=blue;}};Factory.addGetterSetter(Node,'contrast',0,getNumberValidator(),Factory.afterSetFilter);const Emboss=function(imageData){var strength=this.embossStrength()*10,greyLevel=this.embossWhiteLevel()*255,direction=this.embossDirection(),blend=this.embossBlend(),dirY=0,dirX=0,data=imageData.data,w=imageData.width,h=imageData.height,w4=w*4,y=h;switch(direction){case'top-left':dirY=-1;dirX=-1;break;case'top':dirY=-1;dirX=0;break;case'top-right':dirY=-1;dirX=1;break;case'right':dirY=0;dirX=1;break;case'bottom-right':dirY=1;dirX=1;break;case'bottom':dirY=1;dirX=0;break;case'bottom-left':dirY=1;dirX=-1;break;case'left':dirY=0;dirX=-1;break;default:Util.error('Unknown emboss direction: '+direction);}
do{var offsetY=(y-1)*w4;var otherY=dirY;if(y+otherY<1){otherY=0;}
if(y+otherY>h){otherY=0;}
var offsetYOther=(y-1+otherY)*w*4;var x=w;do{var offset=offsetY+(x-1)*4;var otherX=dirX;if(x+otherX<1){otherX=0;}
if(x+otherX>w){otherX=0;}
var offsetOther=offsetYOther+(x-1+otherX)*4;var dR=data[offset]-data[offsetOther];var dG=data[offset+1]-data[offsetOther+1];var dB=data[offset+2]-data[offsetOther+2];var dif=dR;var absDif=dif>0?dif:-dif;var absG=dG>0?dG:-dG;var absB=dB>0?dB:-dB;if(absG>absDif){dif=dG;}
if(absB>absDif){dif=dB;}
dif*=strength;if(blend){var r=data[offset]+dif;var g=data[offset+1]+dif;var b=data[offset+2]+dif;data[offset]=r>255?255:r<0?0:r;data[offset+1]=g>255?255:g<0?0:g;data[offset+2]=b>255?255:b<0?0:b;}
else{var grey=greyLevel-dif;if(grey<0){grey=0;}
else if(grey>255){grey=255;}
data[offset]=data[offset+1]=data[offset+2]=grey;}}while(--x);}while(--y);};Factory.addGetterSetter(Node,'embossStrength',0.5,getNumberValidator(),Factory.afterSetFilter);Factory.addGetterSetter(Node,'embossWhiteLevel',0.5,getNumberValidator(),Factory.afterSetFilter);Factory.addGetterSetter(Node,'embossDirection','top-left',null,Factory.afterSetFilter);Factory.addGetterSetter(Node,'embossBlend',false,null,Factory.afterSetFilter);function remap(fromValue,fromMin,fromMax,toMin,toMax){var fromRange=fromMax-fromMin,toRange=toMax-toMin,toValue;if(fromRange===0){return toMin+toRange/2;}
if(toRange===0){return toMin;}
toValue=(fromValue-fromMin)/fromRange;toValue=toRange*toValue+toMin;return toValue;}
const Enhance=function(imageData){var data=imageData.data,nSubPixels=data.length,rMin=data[0],rMax=rMin,r,gMin=data[1],gMax=gMin,g,bMin=data[2],bMax=bMin,b,i;var enhanceAmount=this.enhance();if(enhanceAmount===0){return;}
for(i=0;i<nSubPixels;i+=4){r=data[i+0];if(r<rMin){rMin=r;}
else if(r>rMax){rMax=r;}
g=data[i+1];if(g<gMin){gMin=g;}
else if(g>gMax){gMax=g;}
b=data[i+2];if(b<bMin){bMin=b;}
else if(b>bMax){bMax=b;}}
if(rMax===rMin){rMax=255;rMin=0;}
if(gMax===gMin){gMax=255;gMin=0;}
if(bMax===bMin){bMax=255;bMin=0;}
var rMid,rGoalMax,rGoalMin,gMid,gGoalMax,gGoalMin,bMid,bGoalMax,bGoalMin;if(enhanceAmount>0){rGoalMax=rMax+enhanceAmount*(255-rMax);rGoalMin=rMin-enhanceAmount*(rMin-0);gGoalMax=gMax+enhanceAmount*(255-gMax);gGoalMin=gMin-enhanceAmount*(gMin-0);bGoalMax=bMax+enhanceAmount*(255-bMax);bGoalMin=bMin-enhanceAmount*(bMin-0);}
else{rMid=(rMax+rMin)*0.5;rGoalMax=rMax+enhanceAmount*(rMax-rMid);rGoalMin=rMin+enhanceAmount*(rMin-rMid);gMid=(gMax+gMin)*0.5;gGoalMax=gMax+enhanceAmount*(gMax-gMid);gGoalMin=gMin+enhanceAmount*(gMin-gMid);bMid=(bMax+bMin)*0.5;bGoalMax=bMax+enhanceAmount*(bMax-bMid);bGoalMin=bMin+enhanceAmount*(bMin-bMid);}
for(i=0;i<nSubPixels;i+=4){data[i+0]=remap(data[i+0],rMin,rMax,rGoalMin,rGoalMax);data[i+1]=remap(data[i+1],gMin,gMax,gGoalMin,gGoalMax);data[i+2]=remap(data[i+2],bMin,bMax,bGoalMin,bGoalMax);}};Factory.addGetterSetter(Node,'enhance',0,getNumberValidator(),Factory.afterSetFilter);const Grayscale=function(imageData){var data=imageData.data,len=data.length,i,brightness;for(i=0;i<len;i+=4){brightness=0.34*data[i]+0.5*data[i+1]+0.16*data[i+2];data[i]=brightness;data[i+1]=brightness;data[i+2]=brightness;}};Factory.addGetterSetter(Node,'hue',0,getNumberValidator(),Factory.afterSetFilter);Factory.addGetterSetter(Node,'saturation',0,getNumberValidator(),Factory.afterSetFilter);Factory.addGetterSetter(Node,'luminance',0,getNumberValidator(),Factory.afterSetFilter);const HSL=function(imageData){var data=imageData.data,nPixels=data.length,v=1,s=Math.pow(2,this.saturation()),h=Math.abs(this.hue()+360)%360,l=this.luminance()*127,i;var vsu=v*s*Math.cos((h*Math.PI)/180),vsw=v*s*Math.sin((h*Math.PI)/180);var rr=0.299*v+0.701*vsu+0.167*vsw,rg=0.587*v-0.587*vsu+0.33*vsw,rb=0.114*v-0.114*vsu-0.497*vsw;var gr=0.299*v-0.299*vsu-0.328*vsw,gg=0.587*v+0.413*vsu+0.035*vsw,gb=0.114*v-0.114*vsu+0.293*vsw;var br=0.299*v-0.3*vsu+1.25*vsw,bg=0.587*v-0.586*vsu-1.05*vsw,bb=0.114*v+0.886*vsu-0.2*vsw;var r,g,b,a;for(i=0;i<nPixels;i+=4){r=data[i+0];g=data[i+1];b=data[i+2];a=data[i+3];data[i+0]=rr*r+rg*g+rb*b+l;data[i+1]=gr*r+gg*g+gb*b+l;data[i+2]=br*r+bg*g+bb*b+l;data[i+3]=a;}};const HSV=function(imageData){var data=imageData.data,nPixels=data.length,v=Math.pow(2,this.value()),s=Math.pow(2,this.saturation()),h=Math.abs(this.hue()+360)%360,i;var vsu=v*s*Math.cos((h*Math.PI)/180),vsw=v*s*Math.sin((h*Math.PI)/180);var rr=0.299*v+0.701*vsu+0.167*vsw,rg=0.587*v-0.587*vsu+0.33*vsw,rb=0.114*v-0.114*vsu-0.497*vsw;var gr=0.299*v-0.299*vsu-0.328*vsw,gg=0.587*v+0.413*vsu+0.035*vsw,gb=0.114*v-0.114*vsu+0.293*vsw;var br=0.299*v-0.3*vsu+1.25*vsw,bg=0.587*v-0.586*vsu-1.05*vsw,bb=0.114*v+0.886*vsu-0.2*vsw;var r,g,b,a;for(i=0;i<nPixels;i+=4){r=data[i+0];g=data[i+1];b=data[i+2];a=data[i+3];data[i+0]=rr*r+rg*g+rb*b;data[i+1]=gr*r+gg*g+gb*b;data[i+2]=br*r+bg*g+bb*b;data[i+3]=a;}};Factory.addGetterSetter(Node,'hue',0,getNumberValidator(),Factory.afterSetFilter);Factory.addGetterSetter(Node,'saturation',0,getNumberValidator(),Factory.afterSetFilter);Factory.addGetterSetter(Node,'value',0,getNumberValidator(),Factory.afterSetFilter);const Invert=function(imageData){var data=imageData.data,len=data.length,i;for(i=0;i<len;i+=4){data[i]=255-data[i];data[i+1]=255-data[i+1];data[i+2]=255-data[i+2];}};var ToPolar=function(src,dst,opt){var srcPixels=src.data,dstPixels=dst.data,xSize=src.width,ySize=src.height,xMid=opt.polarCenterX||xSize/2,yMid=opt.polarCenterY||ySize/2,i,x,y,r=0,g=0,b=0,a=0;var rad,rMax=Math.sqrt(xMid*xMid+yMid*yMid);x=xSize-xMid;y=ySize-yMid;rad=Math.sqrt(x*x+y*y);rMax=rad>rMax?rad:rMax;var rSize=ySize,tSize=xSize,radius,theta;var conversion=((360/tSize)*Math.PI)/180,sin,cos;for(theta=0;theta<tSize;theta+=1){sin=Math.sin(theta*conversion);cos=Math.cos(theta*conversion);for(radius=0;radius<rSize;radius+=1){x=Math.floor(xMid+((rMax*radius)/rSize)*cos);y=Math.floor(yMid+((rMax*radius)/rSize)*sin);i=(y*xSize+x)*4;r=srcPixels[i+0];g=srcPixels[i+1];b=srcPixels[i+2];a=srcPixels[i+3];i=(theta+radius*xSize)*4;dstPixels[i+0]=r;dstPixels[i+1]=g;dstPixels[i+2]=b;dstPixels[i+3]=a;}}};var FromPolar=function(src,dst,opt){var srcPixels=src.data,dstPixels=dst.data,xSize=src.width,ySize=src.height,xMid=opt.polarCenterX||xSize/2,yMid=opt.polarCenterY||ySize/2,i,x,y,dx,dy,r=0,g=0,b=0,a=0;var rad,rMax=Math.sqrt(xMid*xMid+yMid*yMid);x=xSize-xMid;y=ySize-yMid;rad=Math.sqrt(x*x+y*y);rMax=rad>rMax?rad:rMax;var rSize=ySize,tSize=xSize,radius,theta,phaseShift=opt.polarRotation||0;var x1,y1;for(x=0;x<xSize;x+=1){for(y=0;y<ySize;y+=1){dx=x-xMid;dy=y-yMid;radius=(Math.sqrt(dx*dx+dy*dy)*rSize)/rMax;theta=((Math.atan2(dy,dx)*180)/Math.PI+360+phaseShift)%360;theta=(theta*tSize)/360;x1=Math.floor(theta);y1=Math.floor(radius);i=(y1*xSize+x1)*4;r=srcPixels[i+0];g=srcPixels[i+1];b=srcPixels[i+2];a=srcPixels[i+3];i=(y*xSize+x)*4;dstPixels[i+0]=r;dstPixels[i+1]=g;dstPixels[i+2]=b;dstPixels[i+3]=a;}}};const Kaleidoscope=function(imageData){var xSize=imageData.width,ySize=imageData.height;var x,y,xoff,i,r,g,b,a,srcPos,dstPos;var power=Math.round(this.kaleidoscopePower());var angle=Math.round(this.kaleidoscopeAngle());var offset=Math.floor((xSize*(angle%360))/360);if(power<1){return;}
var tempCanvas=Util.createCanvasElement();tempCanvas.width=xSize;tempCanvas.height=ySize;var scratchData=tempCanvas.getContext('2d').getImageData(0,0,xSize,ySize);Util.releaseCanvas(tempCanvas);ToPolar(imageData,scratchData,{polarCenterX:xSize/2,polarCenterY:ySize/2,});var minSectionSize=xSize/Math.pow(2,power);while(minSectionSize<=8){minSectionSize=minSectionSize*2;power-=1;}
minSectionSize=Math.ceil(minSectionSize);var sectionSize=minSectionSize;var xStart=0,xEnd=sectionSize,xDelta=1;if(offset+minSectionSize>xSize){xStart=sectionSize;xEnd=0;xDelta=-1;}
for(y=0;y<ySize;y+=1){for(x=xStart;x!==xEnd;x+=xDelta){xoff=Math.round(x+offset)%xSize;srcPos=(xSize*y+xoff)*4;r=scratchData.data[srcPos+0];g=scratchData.data[srcPos+1];b=scratchData.data[srcPos+2];a=scratchData.data[srcPos+3];dstPos=(xSize*y+x)*4;scratchData.data[dstPos+0]=r;scratchData.data[dstPos+1]=g;scratchData.data[dstPos+2]=b;scratchData.data[dstPos+3]=a;}}
for(y=0;y<ySize;y+=1){sectionSize=Math.floor(minSectionSize);for(i=0;i<power;i+=1){for(x=0;x<sectionSize+1;x+=1){srcPos=(xSize*y+x)*4;r=scratchData.data[srcPos+0];g=scratchData.data[srcPos+1];b=scratchData.data[srcPos+2];a=scratchData.data[srcPos+3];dstPos=(xSize*y+sectionSize*2-x-1)*4;scratchData.data[dstPos+0]=r;scratchData.data[dstPos+1]=g;scratchData.data[dstPos+2]=b;scratchData.data[dstPos+3]=a;}
sectionSize*=2;}}
FromPolar(scratchData,imageData,{polarRotation:0});};Factory.addGetterSetter(Node,'kaleidoscopePower',2,getNumberValidator(),Factory.afterSetFilter);Factory.addGetterSetter(Node,'kaleidoscopeAngle',0,getNumberValidator(),Factory.afterSetFilter);function pixelAt(idata,x,y){var idx=(y*idata.width+x)*4;var d=[];d.push(idata.data[idx++],idata.data[idx++],idata.data[idx++],idata.data[idx++]);return d;}
function rgbDistance(p1,p2){return Math.sqrt(Math.pow(p1[0]-p2[0],2)+
Math.pow(p1[1]-p2[1],2)+
Math.pow(p1[2]-p2[2],2));}
function rgbMean(pTab){var m=[0,0,0];for(var i=0;i<pTab.length;i++){m[0]+=pTab[i][0];m[1]+=pTab[i][1];m[2]+=pTab[i][2];}
m[0]/=pTab.length;m[1]/=pTab.length;m[2]/=pTab.length;return m;}
function backgroundMask(idata,threshold){var rgbv_no=pixelAt(idata,0,0);var rgbv_ne=pixelAt(idata,idata.width-1,0);var rgbv_so=pixelAt(idata,0,idata.height-1);var rgbv_se=pixelAt(idata,idata.width-1,idata.height-1);var thres=threshold||10;if(rgbDistance(rgbv_no,rgbv_ne)<thres&&rgbDistance(rgbv_ne,rgbv_se)<thres&&rgbDistance(rgbv_se,rgbv_so)<thres&&rgbDistance(rgbv_so,rgbv_no)<thres){var mean=rgbMean([rgbv_ne,rgbv_no,rgbv_se,rgbv_so]);var mask=[];for(var i=0;i<idata.width*idata.height;i++){var d=rgbDistance(mean,[idata.data[i*4],idata.data[i*4+1],idata.data[i*4+2],]);mask[i]=d<thres?0:255;}
return mask;}}
function applyMask(idata,mask){for(var i=0;i<idata.width*idata.height;i++){idata.data[4*i+3]=mask[i];}}
function erodeMask(mask,sw,sh){var weights=[1,1,1,1,0,1,1,1,1];var side=Math.round(Math.sqrt(weights.length));var halfSide=Math.floor(side/2);var maskResult=[];for(var y=0;y<sh;y++){for(var x=0;x<sw;x++){var so=y*sw+x;var a=0;for(var cy=0;cy<side;cy++){for(var cx=0;cx<side;cx++){var scy=y+cy-halfSide;var scx=x+cx-halfSide;if(scy>=0&&scy<sh&&scx>=0&&scx<sw){var srcOff=scy*sw+scx;var wt=weights[cy*side+cx];a+=mask[srcOff]*wt;}}}
maskResult[so]=a===255*8?255:0;}}
return maskResult;}
function dilateMask(mask,sw,sh){var weights=[1,1,1,1,1,1,1,1,1];var side=Math.round(Math.sqrt(weights.length));var halfSide=Math.floor(side/2);var maskResult=[];for(var y=0;y<sh;y++){for(var x=0;x<sw;x++){var so=y*sw+x;var a=0;for(var cy=0;cy<side;cy++){for(var cx=0;cx<side;cx++){var scy=y+cy-halfSide;var scx=x+cx-halfSide;if(scy>=0&&scy<sh&&scx>=0&&scx<sw){var srcOff=scy*sw+scx;var wt=weights[cy*side+cx];a+=mask[srcOff]*wt;}}}
maskResult[so]=a>=255*4?255:0;}}
return maskResult;}
function smoothEdgeMask(mask,sw,sh){var weights=[1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9];var side=Math.round(Math.sqrt(weights.length));var halfSide=Math.floor(side/2);var maskResult=[];for(var y=0;y<sh;y++){for(var x=0;x<sw;x++){var so=y*sw+x;var a=0;for(var cy=0;cy<side;cy++){for(var cx=0;cx<side;cx++){var scy=y+cy-halfSide;var scx=x+cx-halfSide;if(scy>=0&&scy<sh&&scx>=0&&scx<sw){var srcOff=scy*sw+scx;var wt=weights[cy*side+cx];a+=mask[srcOff]*wt;}}}
maskResult[so]=a;}}
return maskResult;}
const Mask=function(imageData){var threshold=this.threshold(),mask=backgroundMask(imageData,threshold);if(mask){mask=erodeMask(mask,imageData.width,imageData.height);mask=dilateMask(mask,imageData.width,imageData.height);mask=smoothEdgeMask(mask,imageData.width,imageData.height);applyMask(imageData,mask);}
return imageData;};Factory.addGetterSetter(Node,'threshold',0,getNumberValidator(),Factory.afterSetFilter);const Noise=function(imageData){var amount=this.noise()*255,data=imageData.data,nPixels=data.length,half=amount/2,i;for(i=0;i<nPixels;i+=4){data[i+0]+=half-2*half*Math.random();data[i+1]+=half-2*half*Math.random();data[i+2]+=half-2*half*Math.random();}};Factory.addGetterSetter(Node,'noise',0.2,getNumberValidator(),Factory.afterSetFilter);const Pixelate=function(imageData){var pixelSize=Math.ceil(this.pixelSize()),width=imageData.width,height=imageData.height,x,y,i,red,green,blue,alpha,nBinsX=Math.ceil(width/pixelSize),nBinsY=Math.ceil(height/pixelSize),xBinStart,xBinEnd,yBinStart,yBinEnd,xBin,yBin,pixelsInBin,data=imageData.data;if(pixelSize<=0){Util.error('pixelSize value can not be <= 0');return;}
for(xBin=0;xBin<nBinsX;xBin+=1){for(yBin=0;yBin<nBinsY;yBin+=1){red=0;green=0;blue=0;alpha=0;xBinStart=xBin*pixelSize;xBinEnd=xBinStart+pixelSize;yBinStart=yBin*pixelSize;yBinEnd=yBinStart+pixelSize;pixelsInBin=0;for(x=xBinStart;x<xBinEnd;x+=1){if(x>=width){continue;}
for(y=yBinStart;y<yBinEnd;y+=1){if(y>=height){continue;}
i=(width*y+x)*4;red+=data[i+0];green+=data[i+1];blue+=data[i+2];alpha+=data[i+3];pixelsInBin+=1;}}
red=red/pixelsInBin;green=green/pixelsInBin;blue=blue/pixelsInBin;alpha=alpha/pixelsInBin;for(x=xBinStart;x<xBinEnd;x+=1){if(x>=width){continue;}
for(y=yBinStart;y<yBinEnd;y+=1){if(y>=height){continue;}
i=(width*y+x)*4;data[i+0]=red;data[i+1]=green;data[i+2]=blue;data[i+3]=alpha;}}}}};Factory.addGetterSetter(Node,'pixelSize',8,getNumberValidator(),Factory.afterSetFilter);const Posterize=function(imageData){var levels=Math.round(this.levels()*254)+1,data=imageData.data,len=data.length,scale=255/levels,i;for(i=0;i<len;i+=1){data[i]=Math.floor(data[i]/scale)*scale;}};Factory.addGetterSetter(Node,'levels',0.5,getNumberValidator(),Factory.afterSetFilter);const RGB=function(imageData){var data=imageData.data,nPixels=data.length,red=this.red(),green=this.green(),blue=this.blue(),i,brightness;for(i=0;i<nPixels;i+=4){brightness=(0.34*data[i]+0.5*data[i+1]+0.16*data[i+2])/255;data[i]=brightness*red;data[i+1]=brightness*green;data[i+2]=brightness*blue;data[i+3]=data[i+3];}};Factory.addGetterSetter(Node,'red',0,function(val){this._filterUpToDate=false;if(val>255){return 255;}
else if(val<0){return 0;}
else{return Math.round(val);}});Factory.addGetterSetter(Node,'green',0,function(val){this._filterUpToDate=false;if(val>255){return 255;}
else if(val<0){return 0;}
else{return Math.round(val);}});Factory.addGetterSetter(Node,'blue',0,RGBComponent,Factory.afterSetFilter);const RGBA=function(imageData){var data=imageData.data,nPixels=data.length,red=this.red(),green=this.green(),blue=this.blue(),alpha=this.alpha(),i,ia;for(i=0;i<nPixels;i+=4){ia=1-alpha;data[i]=red*alpha+data[i]*ia;data[i+1]=green*alpha+data[i+1]*ia;data[i+2]=blue*alpha+data[i+2]*ia;}};Factory.addGetterSetter(Node,'red',0,function(val){this._filterUpToDate=false;if(val>255){return 255;}
else if(val<0){return 0;}
else{return Math.round(val);}});Factory.addGetterSetter(Node,'green',0,function(val){this._filterUpToDate=false;if(val>255){return 255;}
else if(val<0){return 0;}
else{return Math.round(val);}});Factory.addGetterSetter(Node,'blue',0,RGBComponent,Factory.afterSetFilter);Factory.addGetterSetter(Node,'alpha',1,function(val){this._filterUpToDate=false;if(val>1){return 1;}
else if(val<0){return 0;}
else{return val;}});const Sepia=function(imageData){var data=imageData.data,nPixels=data.length,i,r,g,b;for(i=0;i<nPixels;i+=4){r=data[i+0];g=data[i+1];b=data[i+2];data[i+0]=Math.min(255,r*0.393+g*0.769+b*0.189);data[i+1]=Math.min(255,r*0.349+g*0.686+b*0.168);data[i+2]=Math.min(255,r*0.272+g*0.534+b*0.131);}};const Solarize=function(imageData){var data=imageData.data,w=imageData.width,h=imageData.height,w4=w*4,y=h;do{var offsetY=(y-1)*w4;var x=w;do{var offset=offsetY+(x-1)*4;var r=data[offset];var g=data[offset+1];var b=data[offset+2];if(r>127){r=255-r;}
if(g>127){g=255-g;}
if(b>127){b=255-b;}
data[offset]=r;data[offset+1]=g;data[offset+2]=b;}while(--x);}while(--y);};const Threshold=function(imageData){var level=this.threshold()*255,data=imageData.data,len=data.length,i;for(i=0;i<len;i+=1){data[i]=data[i]<level?0:255;}};Factory.addGetterSetter(Node,'threshold',0.5,getNumberValidator(),Factory.afterSetFilter);const Konva=Konva$1.Util._assign(Konva$1,{Arc,Arrow,Circle,Ellipse,Image,Label,Tag,Line,Path,Rect,RegularPolygon,Ring,Sprite,Star,Text,TextPath,Transformer,Wedge,Filters:{Blur,Brighten,Contrast,Emboss,Enhance,Grayscale,HSL,HSV,Invert,Kaleidoscope,Mask,Noise,Pixelate,Posterize,RGB,RGBA,Sepia,Solarize,Threshold,},});return Konva;}));class w2event{constructor(owner,edata){Object.assign(this,{type:edata.type??null,detail:edata,owner,target:edata.target??null,phase:edata.phase??'before',object:edata.object??null,execute:null,isStopped:false,isCancelled:false,onComplete:null,listeners:[]})
delete edata.type
delete edata.target
delete edata.object
this.complete=new Promise((resolve,reject)=>{this._resolve=resolve
this._reject=reject})
this.complete.catch(()=>{})}
finish(detail){if(detail){w2utils.extend(this.detail,detail)}
this.phase='after'
this.owner.trigger.call(this.owner,this)}
done(func){this.listeners.push(func)}
preventDefault(){this._reject()
this.isCancelled=true}
stopPropagation(){this.isStopped=true}}
class w2base{constructor(name){this.activeEvents=[]
this.listeners=[]
if(typeof name!=='undefined'){if(!w2utils.checkName(name))return
w2ui[name]=this}
this.debug=false}
on(events,handler){if(typeof events=='string'){events=events.split(/[,\s]+/)}else{events=[events]}
events.forEach(edata=>{let name=typeof edata=='string'?edata:(edata.type+':'+edata.execute+'.'+edata.scope)
if(typeof edata=='string'){let[eventName,scope]=edata.split('.')
let[type,execute]=eventName.replace(':complete',':after').replace(':done',':after').split(':')
edata={type,execute:execute??'before',scope}}
edata=w2utils.extend({type:null,execute:'before',onComplete:null},edata)
if(!edata.type){console.log('ERROR: You must specify event type when calling .on() method of '+this.name);return}
if(!handler){console.log('ERROR: You must specify event handler function when calling .on() method of '+this.name);return}
if(!Array.isArray(this.listeners))this.listeners=[]
this.listeners.push({name,edata,handler})
if(this.debug){console.log('w2base: add event',{name,edata,handler})}})
return this}
off(events,handler){if(typeof events=='string'){events=events.split(/[,\s]+/)}else{events=[events]}
events.forEach(edata=>{let name=typeof edata=='string'?edata:(edata.type+':'+edata.execute+'.'+edata.scope)
if(typeof edata=='string'){let[eventName,scope]=edata.split('.')
let[type,execute]=eventName.replace(':complete',':after').replace(':done',':after').split(':')
edata={type:type||'*',execute:execute||'',scope:scope||''}}
edata=w2utils.extend({type:null,execute:null,onComplete:null},edata)
if(!edata.type&&!edata.scope){console.log('ERROR: You must specify event type when calling .off() method of '+this.name);return}
if(!handler){handler=null}
let count=0
this.listeners=this.listeners.filter(curr=>{if((edata.type==='*'||edata.type===curr.edata.type)&&(edata.execute===''||edata.execute===curr.edata.execute)&&(edata.scope===''||edata.scope===curr.edata.scope)&&(edata.handler==null||edata.handler===curr.edata.handler)){count++
return false}else{return true}})
if(this.debug){console.log(`w2base: remove event (${count})`,{name,edata,handler})}})
return this}
trigger(eventName,edata){if(arguments.length==1){if(typeof eventName=='string'){edata={type:eventName,target:this}}else{edata=eventName}}else{edata.type=eventName
edata.target=edata.target??this}
if(w2utils.isPlainObject(edata)&&edata.phase=='after'){edata=this.activeEvents.find(event=>{if(event.type==edata.type&&event.target==edata.target){return true}
return false})
if(!edata){console.log(`ERROR: Cannot find even handler for "${edata.type}" on "${edata.target}".`)
return}
console.log('NOTICE: This syntax "edata.trigger({ phase: \'after\' })" is outdated. Use edata.finish() instead.')}else if(!(edata instanceof w2event)){edata=new w2event(this,edata)
this.activeEvents.push(edata)}
let args,fun,tmp
if(!Array.isArray(this.listeners))this.listeners=[]
if(this.debug){console.log(`w2base: trigger "${edata.type}:${edata.phase}"`,edata)}
for(let h=this.listeners.length-1;h>=0;h--){let item=this.listeners[h]
if(item!=null&&(item.edata.type===edata.type||item.edata.type==='*')&&(item.edata.target===edata.target||item.edata.target==null)&&(item.edata.execute===edata.phase||item.edata.execute==='*'||item.edata.phase==='*'))
{Object.keys(item.edata).forEach(key=>{if(edata[key]==null&&item.edata[key]!=null){edata[key]=item.edata[key]}})
args=[]
tmp=new RegExp(/\((.*?)\)/).exec(String(item.handler).split('=>')[0])
if(tmp)args=tmp[1].split(/\s*,\s*/)
if(args.length===2){item.handler.call(this,edata.target,edata)
if(this.debug)console.log(' - call (old)',item.handler)}else{item.handler.call(this,edata)
if(this.debug)console.log(' - call',item.handler)}
if(edata.isStopped===true||edata.stop===true)return edata}}
let funName='on'+edata.type.substr(0,1).toUpperCase()+edata.type.substr(1)
if(edata.phase==='before'&&typeof this[funName]==='function'){fun=this[funName]
args=[]
tmp=new RegExp(/\((.*?)\)/).exec(String(fun).split('=>')[0])
if(tmp)args=tmp[1].split(/\s*,\s*/)
if(args.length===2){fun.call(this,edata.target,edata)
if(this.debug)console.log(' - call: on[Event] (old)',fun)}else{fun.call(this,edata)
if(this.debug)console.log(' - call: on[Event]',fun)}
if(edata.isStopped===true||edata.stop===true)return edata}
if(edata.object!=null&&edata.phase==='before'&&typeof edata.object[funName]==='function'){fun=edata.object[funName]
args=[]
tmp=new RegExp(/\((.*?)\)/).exec(String(fun).split('=>')[0])
if(tmp)args=tmp[1].split(/\s*,\s*/)
if(args.length===2){fun.call(this,edata.target,edata)
if(this.debug)console.log(' - call: edata.object (old)',fun)}else{fun.call(this,edata)
if(this.debug)console.log(' - call: edata.object',fun)}
if(edata.isStopped===true||edata.stop===true)return edata}
if(edata.phase==='after'){if(typeof edata.onComplete==='function')edata.onComplete.call(this,edata)
for(let i=0;i<edata.listeners.length;i++){if(typeof edata.listeners[i]==='function'){edata.listeners[i].call(this,edata)
if(this.debug)console.log(' - call: done',fun)}}
edata._resolve(edata)
if(this.debug){console.log(`w2base: trigger "${edata.type}:${edata.phase}"`,edata)}
let ind=this.activeEvents.indexOf(edata)
if(ind!==-1)this.activeEvents.splice(ind,1)}
return edata}
render(box){}
unmount(){let edata=this.trigger('unmount',{target:this.name})
if(edata.isCancelled){return}
let remove=[]
if(this.box instanceof HTMLElement){this.box.classList.forEach(cl=>{if(cl.startsWith('w2ui-'))remove.push(cl)})}
query(this.box).off().removeClass(remove).removeAttr('name').html('')
this.box=null
edata.finish()}}
const w2locale={'locale':'en-US','dateFormat':'m/d/yyyy','timeFormat':'hh:mi pm','datetimeFormat':'m/d/yyyy|hh:mi pm','currencyPrefix':'$','currencySuffix':'','currencyPrecision':2,'groupSymbol':',','decimalSymbol':'.','shortmonths':['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],'fullmonths':['January','February','March','April','May','June','July','August','September','October','November','December'],'shortdays':['M','T','W','T','F','S','S'],'fulldays':['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'],'weekStarts':'S','phrases':{'${count} letters or more...':'---','Add new record':'---','Add New':'---','Advanced Search':'---','after':'---','AJAX error. See console for more details.':'---','All Fields':'---','All':'---','Any':'---','Are you sure you want to delete ${count} ${records}?':'---','Attach files by dragging and dropping or Click to Select':'---','before':'---','begins with':'---','begins':'---','between':'---','buffered':'---','Cancel':'---','Close':'---','Column':'---','Confirmation':'---','contains':'---','Copied':'---','Copy to clipboard':'---','Current Date & Time':'---','Delete selected records':'---','Delete':'---','Do you want to delete search item "${item}"?':'---','Edit selected record':'---','Edit':'---','Empty list':'---','ends with':'---','ends':'---','Field should be at least ${count} characters.':'---','Hide':'---','in':'---','is not':'---','is':'---','less than':'---','Line #':'---','Load ${count} more...':'---','Loading...':'---','Maximum number of files is ${count}':'---','Maximum total size is ${count}':'---','Modified':'---','more than':'---','Multiple Fields':'---','Name':'---','No items found':'---','No matches':'---','No':'---','none':'---','Not a float':'---','Not a hex number':'---','Not a valid date':'---','Not a valid email':'---','Not alpha-numeric':'---','Not an integer':'---','Not in money format':'---','not in':'---','Notification':'---','of':'---','Ok':'---','Opacity':'---','Record ID':'---','record':'---','records':'---','Refreshing...':'---','Reload data in the list':'---','Remove':'---','Remove This Field':'---','Request aborted.':'---','Required field':'---','Reset':'---','Restore Default State':'---','Returned data is not in valid JSON format.':'---','Save changed records':'---','Save Grid State':'---','Save':'---','Saved Searches':'---','Saving...':'---','Search took ${count} seconds':'---','Search':'---','Select Hour':'---','Select Minute':'---','selected':'---','Server Response ${count} seconds':'---','Show/hide columns':'---','Show':'---','Size':'---','Skip':'---','Sorting took ${count} seconds':'---','Type to search...':'---','Type':'---','Yes':'---','Yesterday':'---','Your remote data source record count has changed, reloading from the first record.':'---'}}
class Query{static version=0.8
constructor(selector,context){this.context=context??document
let nodes=[]
if(Array.isArray(selector)){nodes=selector}else if(selector instanceof Node||selector instanceof Window){nodes=[selector]}else if(selector instanceof Query){nodes=selector.nodes}else if(typeof selector=='string'){if(typeof this.context.querySelector!='function'){throw new Error('Invalid context')}
nodes=Array.from(this.context.querySelectorAll(selector))}else if(selector==null){nodes=[]}else{let arr=Array.from(selector??[])
if(typeof selector=='object'&&Array.isArray(arr)){nodes=arr}else{throw new Error(`Invalid selector "${selector}"`)}}
this.nodes=nodes
this.length=nodes.length
this.each((node,ind)=>{this[ind]=node})}
static _fragment(html){let tmpl=document.createElement('template')
tmpl.innerHTML=html
tmpl.content.childNodes.forEach(node=>{let newNode=Query._scriptConvert(node)
if(newNode!=node){tmpl.content.replaceChild(newNode,node)}})
return tmpl.content}
static _scriptConvert(node){let convert=(txtNode)=>{let doc=txtNode.ownerDocument
let scNode=doc.createElement('script')
scNode.text=txtNode.text
let attrs=txtNode.attributes
for(let i=0;i<attrs.length;i++){scNode.setAttribute(attrs[i].name,attrs[i].value)}
return scNode}
if(node.tagName=='SCRIPT'){node=convert(node)}
if(node.querySelectorAll){node.querySelectorAll('script').forEach(textNode=>{textNode.parentNode.replaceChild(convert(textNode),textNode)})}
return node}
static _fixProp(name){let fixes={cellpadding:'cellPadding',cellspacing:'cellSpacing',class:'className',colspan:'colSpan',contenteditable:'contentEditable',for:'htmlFor',frameborder:'frameBorder',maxlength:'maxLength',readonly:'readOnly',rowspan:'rowSpan',tabindex:'tabIndex',usemap:'useMap'}
return fixes[name]?fixes[name]:name}
_insert(method,html){let nodes=[]
let len=this.length
if(len<1)return
let self=this
if(typeof html=='string'){this.each(node=>{let clone=Query._fragment(html)
nodes.push(...clone.childNodes)
node[method](clone)})}else if(html instanceof Query){let single=(len==1)
html.each(el=>{this.each(node=>{let clone=(single?el:el.cloneNode(true))
nodes.push(clone)
node[method](clone)
Query._scriptConvert(clone)})})
if(!single)html.remove()}else if(html instanceof Node){this.each(node=>{let clone=(len===1?html:Query._fragment(html.outerHTML))
nodes.push(...(len===1?[html]:clone.childNodes))
node[method](clone)})
if(len>1)html.remove()}else{throw new Error(`Incorrect argument for "${method}(html)". It expects one string argument.`)}
if(method=='replaceWith'){self=new Query(nodes,this.context)}
return self}
_save(node,name,value){node._mQuery=node._mQuery??{}
if(Array.isArray(value)){node._mQuery[name]=node._mQuery[name]??[]
node._mQuery[name].push(...value)}else if(value!=null){node._mQuery[name]=value}else{delete node._mQuery[name]}}
get(index){if(index<0)index=this.length+index
let node=this[index]
if(node){return node}
if(index!=null){return null}
return this.nodes}
eq(index){if(index<0)index=this.length+index
let nodes=[this[index]]
if(nodes[0]==null)nodes=[]
return new Query(nodes,this.context)}
then(fun){let ret=fun(this)
return ret!=null?ret:this}
find(selector){let nodes=[]
this.each(node=>{let nn=Array.from(node.querySelectorAll(selector))
if(nn.length>0){nodes.push(...nn)}})
return new Query(nodes,this.context)}
filter(selector){let nodes=[]
this.each(node=>{if(node===selector||(typeof selector=='string'&&node.matches&&node.matches(selector))||(typeof selector=='function'&&selector(node))){nodes.push(node)}})
return new Query(nodes,this.context)}
next(){let nodes=[]
this.each(node=>{let nn=node.nextElementSibling
if(nn){nodes.push(nn)}})
return new Query(nodes,this.context)}
prev(){let nodes=[]
this.each(node=>{let nn=node.previousElementSibling
if(nn){nodes.push(nn)}})
return new Query(nodes,this.context)}
shadow(selector){let nodes=[]
this.each(node=>{if(node.shadowRoot)nodes.push(node.shadowRoot)})
let col=new Query(nodes,this.context)
return selector?col.find(selector):col}
closest(selector){let nodes=[]
this.each(node=>{let nn=node.closest(selector)
if(nn){nodes.push(nn)}})
return new Query(nodes,this.context)}
host(all){let nodes=[]
let top=(node)=>{if(node.parentNode){return top(node.parentNode)}else{return node}}
let fun=(node)=>{let nn=top(node)
nodes.push(nn.host?nn.host:nn)
if(nn.host&&all)fun(nn.host)}
this.each(node=>{fun(node)})
return new Query(nodes,this.context)}
parent(selector){return this.parents(selector,true)}
parents(selector,firstOnly){let nodes=[]
let add=(node)=>{if(nodes.indexOf(node)==-1){nodes.push(node)}
if(!firstOnly&&node.parentNode){return add(node.parentNode)}}
this.each(node=>{if(node.parentNode)add(node.parentNode)})
let col=new Query(nodes,this.context)
return selector?col.filter(selector):col}
add(more){let nodes=more instanceof Query?more.nodes:(Array.isArray(more)?more:[more])
return new Query(this.nodes.concat(nodes),this.context)}
each(func){this.nodes.forEach((node,ind)=>{func(node,ind,this)})
return this}
append(html){return this._insert('append',html)}
prepend(html){return this._insert('prepend',html)}
after(html){return this._insert('after',html)}
before(html){return this._insert('before',html)}
replace(html){return this._insert('replaceWith',html)}
remove(){this.each(node=>{node.remove()})
return this}
css(key,value){let css=key
let len=arguments.length
if(len===0||(len===1&&typeof key=='string')){if(this[0]){let st=this[0].style
if(typeof key=='string'){let pri=st.getPropertyPriority(key)
return st.getPropertyValue(key)+(pri?'!'+pri:'')}else{return Object.fromEntries(this[0].style.cssText.split(';').filter(a=>!!a).map(a=>{return a.split(':').map(a=>a.trim())}))}}else{return undefined}}else{if(typeof key!='object'){css={}
css[key]=value}
this.each((el,ind)=>{Object.keys(css).forEach(key=>{let imp=String(css[key]).toLowerCase().includes('!important')?'important':''
el.style.setProperty(key,String(css[key]).replace(/\!important/i,''),imp)})})
return this}}
addClass(classes){this.toggleClass(classes,true)
return this}
removeClass(classes){this.toggleClass(classes,false)
return this}
toggleClass(classes,force){if(typeof classes=='string')classes=classes.split(/[,\s]+/)
this.each(node=>{let classes2=classes
if(classes2==null&&force===false)classes2=Array.from(node.classList)
classes2.forEach(className=>{if(className!==''){let act='toggle'
if(force!=null)act=force?'add':'remove'
node.classList[act](className)}})})
return this}
hasClass(classes){if(typeof classes=='string')classes=classes.split(/[,\s]+/)
if(classes==null&&this.length>0){return Array.from(this[0].classList)}
let ret=false
this.each(node=>{ret=ret||classes.every(className=>{return Array.from(node.classList??[]).includes(className)})})
return ret}
on(events,options,callback){if(typeof options=='function'){callback=options
options=undefined}
let delegate
if(options?.delegate){delegate=options.delegate
delete options.delegate}
events=events.split(/[,\s]+/)
events.forEach(eventName=>{let[event,scope]=String(eventName).toLowerCase().split('.')
if(delegate){let fun=callback
callback=(event)=>{let parent=query(event.target).parents(delegate)
if(parent.length>0){event.delegate=parent[0]}else{event.delegate=event.target}
if(event.target.matches(delegate)||parent.length>0){fun(event)}}}
this.each(node=>{this._save(node,'events',[{event,scope,callback,options}])
node.addEventListener(event,callback,options)})})
return this}
off(events,options,callback){if(typeof options=='function'){callback=options
options=undefined}
events=(events??'').split(/[,\s]+/)
events.forEach(eventName=>{let[event,scope]=String(eventName).toLowerCase().split('.')
this.each(node=>{if(Array.isArray(node._mQuery?.events)){for(let i=node._mQuery.events.length-1;i>=0;i--){let evt=node._mQuery.events[i]
if(scope==null||scope===''){if((evt.event==event||event==='')&&(evt.callback==callback||callback==null)){node.removeEventListener(evt.event,evt.callback,evt.options)
node._mQuery.events.splice(i,1)}}else{if((evt.event==event||event==='')&&evt.scope==scope){node.removeEventListener(evt.event,evt.callback,evt.options)
node._mQuery.events.splice(i,1)}}}}})})
return this}
trigger(name,options){let event,mevent=['click','dblclick','mousedown','mouseup','mousemove'],kevent=['keydown','keyup','keypress']
if(name instanceof Event||name instanceof CustomEvent){event=name}else if(mevent.includes(name)){event=new MouseEvent(name,options)}else if(kevent.includes(name)){event=new KeyboardEvent(name,options)}else{event=new Event(name,options)}
this.each(node=>{node.dispatchEvent(event)})
return this}
attr(name,value){if(value===undefined&&typeof name=='string'){return this[0]?this[0].getAttribute(name):undefined}else{let obj={}
if(typeof name=='object')obj=name;else obj[name]=value
this.each(node=>{Object.entries(obj).forEach(([nm,val])=>{node.setAttribute(nm,val)})})
return this}}
removeAttr(){this.each(node=>{Array.from(arguments).forEach(attr=>{node.removeAttribute(attr)})})
return this}
prop(name,value){if(value===undefined&&typeof name=='string'){return this[0]?this[0][name]:undefined}else{let obj={}
if(typeof name=='object')obj=name;else obj[name]=value
this.each(node=>{Object.entries(obj).forEach(([nm,val])=>{let prop=Query._fixProp(nm)
node[prop]=val
if(prop=='innerHTML'){Query._scriptConvert(node)}})})
return this}}
removeProp(){this.each(node=>{Array.from(arguments).forEach(prop=>{delete node[Query._fixProp(prop)]})})
return this}
data(key,value){if(key instanceof Object){Object.entries(key).forEach(item=>{this.data(item[0],item[1])})
return}
if(key&&key.indexOf('-')!=-1){console.error(`Key "${key}" contains "-" (dash). Dashes are not allowed in property names. Use camelCase instead.`)}
if(arguments.length<2){if(this[0]){let data=Object.assign({},this[0].dataset)
Object.keys(data).forEach(key=>{if(data[key].startsWith('[')||data[key].startsWith('{')){try{data[key]=JSON.parse(data[key])}catch(e){}}})
return key?data[key]:data}else{return undefined}}else{this.each(node=>{if(value!=null){node.dataset[key]=value instanceof Object?JSON.stringify(value):value}else{delete node.dataset[key]}})
return this}}
removeData(key){if(typeof key=='string')key=key.split(/[,\s]+/)
this.each(node=>{key.forEach(k=>{delete node.dataset[k]})})
return this}
show(){return this.toggle(true)}
hide(){return this.toggle(false)}
toggle(force){return this.each(node=>{let prev=node.style.display
let dsp=getComputedStyle(node).display
let isHidden=(prev=='none'||dsp=='none')
if(isHidden&&(force==null||force===true)){let def=node instanceof HTMLTableRowElement?'table-row':node instanceof HTMLTableCellElement?'table-cell':'block'
node.style.display=node._mQuery?.prevDisplay??(prev==dsp&&dsp!='none'?'':def)
this._save(node,'prevDisplay',null)}
if(!isHidden&&(force==null||force===false)){if(dsp!='none')this._save(node,'prevDisplay',dsp)
node.style.setProperty('display','none')}})}
empty(){return this.html('')}
html(html){if(html instanceof HTMLElement){return this.empty().append(html)}else{return this.prop('innerHTML',html)}}
text(text){return this.prop('textContent',text)}
val(value){return this.prop('value',value)}
change(){return this.trigger('change')}
click(){return this.trigger('click')}}
let query=function(selector,context){if(typeof selector=='function'){if(document.readyState=='complete'){selector()}else{window.addEventListener('load',selector)}}else{return new Query(selector,context)}}
query.html=(str)=>{let frag=Query._fragment(str);return query(frag.children,frag)}
query.version=Query.version
let w2ui={}
class Utils{constructor(){this.version='2.0.x'
this.tmp={}
this.settings=this.extend({},{'dataType':'HTTPJSON','dateStartYear':1950,'dateEndYear':2030,'macButtonOrder':false,'warnNoPhrase':false,},w2locale,{phrases:null}),this.i18nCompare=Intl.Collator().compare
this.hasLocalStorage=testLocalStorage()
this.isMac=/Mac/i.test(navigator.platform)
this.isMobile=/(iphone|ipod|ipad|mobile|android)/i.test(navigator.userAgent)
this.isIOS=/(iphone|ipod|ipad)/i.test(navigator.platform)
this.isAndroid=/(android)/i.test(navigator.userAgent)
this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)
this.formatters={'number'(value,params){if(parseInt(params)>20)params=20
if(parseInt(params)<0)params=0
if(value==null||value==='')return''
return w2utils.formatNumber(parseFloat(value),params,true)},'float'(value,params){return w2utils.formatters.number(value,params)},'int'(value,params){return w2utils.formatters.number(value,0)},'money'(value,params){if(value==null||value==='')return''
let data=w2utils.formatNumber(Number(value),w2utils.settings.currencyPrecision)
return(w2utils.settings.currencyPrefix||'')+data+(w2utils.settings.currencySuffix||'')},'currency'(value,params){return w2utils.formatters.money(value,params)},'percent'(value,params){if(value==null||value==='')return''
return w2utils.formatNumber(value,params||1)+'%'},'size'(value,params){if(value==null||value==='')return''
return w2utils.formatSize(parseInt(value))},'date'(value,params){if(params==='')params=w2utils.settings.dateFormat
if(value==null||value===0||value==='')return''
let dt=w2utils.isDateTime(value,params,true)
if(dt===false)dt=w2utils.isDate(value,params,true)
return'<span title="'+dt+'">'+w2utils.formatDate(dt,params)+'</span>'},'datetime'(value,params){if(params==='')params=w2utils.settings.datetimeFormat
if(value==null||value===0||value==='')return''
let dt=w2utils.isDateTime(value,params,true)
if(dt===false)dt=w2utils.isDate(value,params,true)
return'<span title="'+dt+'">'+w2utils.formatDateTime(dt,params)+'</span>'},'time'(value,params){if(params==='')params=w2utils.settings.timeFormat
if(params==='h12')params='hh:mi pm'
if(params==='h24')params='h24:mi'
if(value==null||value===0||value==='')return''
let dt=w2utils.isDateTime(value,params,true)
if(dt===false)dt=w2utils.isDate(value,params,true)
return'<span title="'+dt+'">'+w2utils.formatTime(value,params)+'</span>'},'timestamp'(value,params){if(params==='')params=w2utils.settings.datetimeFormat
if(value==null||value===0||value==='')return''
let dt=w2utils.isDateTime(value,params,true)
if(dt===false)dt=w2utils.isDate(value,params,true)
return dt.toString?dt.toString():''},'gmt'(value,params){if(params==='')params=w2utils.settings.datetimeFormat
if(value==null||value===0||value==='')return''
let dt=w2utils.isDateTime(value,params,true)
if(dt===false)dt=w2utils.isDate(value,params,true)
return dt.toUTCString?dt.toUTCString():''},'age'(value,params){if(value==null||value===0||value==='')return''
let dt=w2utils.isDateTime(value,null,true)
if(dt===false)dt=w2utils.isDate(value,null,true)
return'<span title="'+dt+'">'+w2utils.age(value)+(params?(' '+params):'')+'</span>'},'interval'(value,params){if(value==null||value===0||value==='')return''
return w2utils.interval(value)+(params?(' '+params):'')},'toggle'(value,params){return(value?w2utils.lang('Yes'):'')},'password'(value,params){let ret=''
for(let i=0;i<value.length;i++){ret+='*'}
return ret}}
return
function testLocalStorage(){let str='w2ui_test'
try{localStorage.setItem(str,str)
localStorage.removeItem(str)
return true}catch(e){return false}}}
isBin(val){let re=/^[0-1]+$/
return re.test(val)}
isInt(val){let re=/^[-+]?[0-9]+$/
return re.test(val)}
isFloat(val){if(typeof val==='string'){val=val.replace(this.settings.groupSymbol,'').replace(this.settings.decimalSymbol,'.')}
return(typeof val==='number'||(typeof val==='string'&&val!==''))&&!isNaN(Number(val))}
isMoney(val){if(typeof val==='object'||val==='')return false
if(this.isFloat(val))return true
let se=this.settings
let re=new RegExp('^'+(se.currencyPrefix?'\\'+se.currencyPrefix+'?':'')+'[-+]?'+(se.currencyPrefix?'\\'+se.currencyPrefix+'?':'')+'[0-9]*[\\'+se.decimalSymbol+']?[0-9]+'+(se.currencySuffix?'\\'+se.currencySuffix+'?':'')+'$','i')
if(typeof val==='string'){val=val.replace(new RegExp(se.groupSymbol,'g'),'')}
return re.test(val)}
isHex(val){let re=/^(0x)?[0-9a-fA-F]+$/
return re.test(val)}
isAlphaNumeric(val){let re=/^[a-zA-Z0-9_-]+$/
return re.test(val)}
isEmail(val){let email=/^[a-zA-Z0-9._%\-+]+@[а-яА-Яa-zA-Z0-9.-]+\.[а-яА-Яa-zA-Z]+$/
return email.test(val)}
isIpAddress(val){let re=new RegExp('^'+'((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}'+'(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)'+'$')
return re.test(val)}
isDate(val,format,retDate){if(!val)return false
let dt='Invalid Date'
let month,day,year
if(format==null)format=this.settings.dateFormat
if(typeof val.getFullYear==='function'){year=val.getFullYear()
month=val.getMonth()+1
day=val.getDate()}else if(parseInt(val)==val&&parseInt(val)>0){val=new Date(parseInt(val))
year=val.getFullYear()
month=val.getMonth()+1
day=val.getDate()}else{val=String(val)
if(new RegExp('mon','ig').test(format)){format=format.replace(/month/ig,'m').replace(/mon/ig,'m').replace(/dd/ig,'d').replace(/[, ]/ig,'/').replace(/\/\//g,'/').toLowerCase()
val=val.replace(/[, ]/ig,'/').replace(/\/\//g,'/').toLowerCase()
for(let m=0,len=this.settings.fullmonths.length;m<len;m++){let t=this.settings.fullmonths[m]
val=val.replace(new RegExp(t,'ig'),(parseInt(m)+1)).replace(new RegExp(t.substr(0,3),'ig'),(parseInt(m)+1))}}
let tmp=val.replace(/-/g,'/').replace(/\./g,'/').toLowerCase().split('/')
let tmp2=format.replace(/-/g,'/').replace(/\./g,'/').toLowerCase()
if(tmp2==='mm/dd/yyyy'){month=tmp[0];day=tmp[1];year=tmp[2]}
if(tmp2==='m/d/yyyy'){month=tmp[0];day=tmp[1];year=tmp[2]}
if(tmp2==='dd/mm/yyyy'){month=tmp[1];day=tmp[0];year=tmp[2]}
if(tmp2==='d/m/yyyy'){month=tmp[1];day=tmp[0];year=tmp[2]}
if(tmp2==='yyyy/dd/mm'){month=tmp[2];day=tmp[1];year=tmp[0]}
if(tmp2==='yyyy/d/m'){month=tmp[2];day=tmp[1];year=tmp[0]}
if(tmp2==='yyyy/mm/dd'){month=tmp[1];day=tmp[2];year=tmp[0]}
if(tmp2==='yyyy/m/d'){month=tmp[1];day=tmp[2];year=tmp[0]}
if(tmp2==='mm/dd/yy'){month=tmp[0];day=tmp[1];year=tmp[2]}
if(tmp2==='m/d/yy'){month=tmp[0];day=tmp[1];year=parseInt(tmp[2])+1900}
if(tmp2==='dd/mm/yy'){month=tmp[1];day=tmp[0];year=parseInt(tmp[2])+1900}
if(tmp2==='d/m/yy'){month=tmp[1];day=tmp[0];year=parseInt(tmp[2])+1900}
if(tmp2==='yy/dd/mm'){month=tmp[2];day=tmp[1];year=parseInt(tmp[0])+1900}
if(tmp2==='yy/d/m'){month=tmp[2];day=tmp[1];year=parseInt(tmp[0])+1900}
if(tmp2==='yy/mm/dd'){month=tmp[1];day=tmp[2];year=parseInt(tmp[0])+1900}
if(tmp2==='yy/m/d'){month=tmp[1];day=tmp[2];year=parseInt(tmp[0])+1900}}
if(!this.isInt(year))return false
if(!this.isInt(month))return false
if(!this.isInt(day))return false
year=+year
month=+month
day=+day
dt=new Date(year,month-1,day)
dt.setFullYear(year)
if(month==null)return false
if(String(dt)==='Invalid Date')return false
if((dt.getMonth()+1!==month)||(dt.getDate()!==day)||(dt.getFullYear()!==year))return false
if(retDate===true)return dt;else return true}
isTime(val,retTime){if(val==null)return false
let max,am,pm
val=String(val)
val=val.toUpperCase()
am=val.indexOf('AM')>=0
pm=val.indexOf('PM')>=0
let ampm=(pm||am)
if(ampm)max=12;else max=24
val=val.replace('AM','').replace('PM','').trim()
let tmp=val.split(':')
let h=parseInt(tmp[0]||0),m=parseInt(tmp[1]||0),s=parseInt(tmp[2]||0)
if((!ampm||tmp.length!==1)&&tmp.length!==2&&tmp.length!==3){return false}
if(tmp[0]===''||h<0||h>max||!this.isInt(tmp[0])||tmp[0].length>2){return false}
if(tmp.length>1&&(tmp[1]===''||m<0||m>59||!this.isInt(tmp[1])||tmp[1].length!==2)){return false}
if(tmp.length>2&&(tmp[2]===''||s<0||s>59||!this.isInt(tmp[2])||tmp[2].length!==2)){return false}
if(!ampm&&max===h&&(m!==0||s!==0)){return false}
if(ampm&&tmp.length===1&&h===0){return false}
if(retTime===true){if(pm&&h!==12)h+=12
if(am&&h===12)h+=12
return{hours:h,minutes:m,seconds:s}}
return true}
isDateTime(val,format,retDate){if(typeof val.getFullYear==='function'){if(retDate!==true)return true
return val}
let intVal=parseInt(val)
if(intVal===val){if(intVal<0)return false
else if(retDate!==true)return true
else return new Date(intVal)}
let tmp=String(val).indexOf(' ')
if(tmp<0){if(String(val).indexOf('T')<0||String(new Date(val))=='Invalid Date')return false
else if(retDate!==true)return true
else return new Date(val)}else{if(format==null)format=this.settings.datetimeFormat
let formats=format.split('|')
let values=[val.substr(0,tmp),val.substr(tmp).trim()]
formats[0]=formats[0].trim()
if(formats[1])formats[1]=formats[1].trim()
let tmp1=this.isDate(values[0],formats[0],true)
let tmp2=this.isTime(values[1],true)
if(tmp1!==false&&tmp2!==false){if(retDate!==true)return true
tmp1.setHours(tmp2.hours)
tmp1.setMinutes(tmp2.minutes)
tmp1.setSeconds(tmp2.seconds)
return tmp1}else{return false}}}
age(dateStr){let d1
if(dateStr===''||dateStr==null)return''
if(typeof dateStr.getFullYear==='function'){d1=dateStr}else if(parseInt(dateStr)==dateStr&&parseInt(dateStr)>0){d1=new Date(parseInt(dateStr))}else{d1=new Date(dateStr)}
if(String(d1)==='Invalid Date')return''
let d2=new Date()
let sec=(d2.getTime()-d1.getTime())/1000
let amount=''
let type=''
if(sec<0){amount=0
type='sec'}else if(sec<60){amount=Math.floor(sec)
type='sec'
if(sec<0){amount=0;type='sec'}}else if(sec<60*60){amount=Math.floor(sec/60)
type='min'}else if(sec<24*60*60){amount=Math.floor(sec/60/60)
type='hour'}else if(sec<30*24*60*60){amount=Math.floor(sec/24/60/60)
type='day'}else if(sec<365*24*60*60){amount=Math.floor(sec/30/24/60/60*10)/10
type='month'}else if(sec<365*4*24*60*60){amount=Math.floor(sec/365/24/60/60*10)/10
type='year'}else if(sec>=365*4*24*60*60){amount=Math.floor(sec/365.25/24/60/60*10)/10
type='year'}
return amount+' '+type+(amount>1?'s':'')}
interval(value){let ret=''
if(value<100){ret='< 0.01 sec'}else if(value<1000){ret=(Math.floor(value/10)/100)+' sec'}else if(value<10000){ret=(Math.floor(value/100)/10)+' sec'}else if(value<60000){ret=Math.floor(value/1000)+' secs'}else if(value<3600000){ret=Math.floor(value/60000)+' mins'}else if(value<86400000){ret=Math.floor(value/3600000*10)/10+' hours'}else if(value<2628000000){ret=Math.floor(value/86400000*10)/10+' days'}else if(value<3.1536e+10){ret=Math.floor(value/2628000000*10)/10+' months'}else{ret=Math.floor(value/3.1536e+9)/10+' years'}
return ret}
date(dateStr){if(dateStr===''||dateStr==null||(typeof dateStr==='object'&&!dateStr.getMonth))return''
let d1=new Date(dateStr)
if(this.isInt(dateStr))d1=new Date(Number(dateStr))
if(String(d1)==='Invalid Date')return''
let months=this.settings.shortmonths
let d2=new Date()
let d3=new Date()
d3.setTime(d3.getTime()-86400000)
let dd1=months[d1.getMonth()]+' '+d1.getDate()+', '+d1.getFullYear()
let dd2=months[d2.getMonth()]+' '+d2.getDate()+', '+d2.getFullYear()
let dd3=months[d3.getMonth()]+' '+d3.getDate()+', '+d3.getFullYear()
let time=(d1.getHours()-(d1.getHours()>12?12:0))+':'+(d1.getMinutes()<10?'0':'')+d1.getMinutes()+' '+(d1.getHours()>=12?'pm':'am')
let time2=(d1.getHours()-(d1.getHours()>12?12:0))+':'+(d1.getMinutes()<10?'0':'')+d1.getMinutes()+':'+(d1.getSeconds()<10?'0':'')+d1.getSeconds()+' '+(d1.getHours()>=12?'pm':'am')
let dsp=dd1
if(dd1===dd2)dsp=time
if(dd1===dd3)dsp=this.lang('Yesterday')
return'<span title="'+dd1+' '+time2+'">'+dsp+'</span>'}
formatSize(sizeStr){if(!this.isFloat(sizeStr)||sizeStr==='')return''
sizeStr=parseFloat(sizeStr)
if(sizeStr===0)return 0
let sizes=['Bt','KB','MB','GB','TB','PB','EB','ZB']
let i=parseInt(Math.floor(Math.log(sizeStr)/Math.log(1024)))
return(Math.floor(sizeStr/Math.pow(1024,i)*10)/10).toFixed(i===0?0:1)+' '+(sizes[i]||'??')}
formatNumber(val,fraction,useGrouping){if(val==null||val===''||typeof val==='object')return''
let options={minimumFractionDigits:parseInt(fraction),maximumFractionDigits:parseInt(fraction),useGrouping:!!useGrouping}
if(fraction==null||fraction<0){options.minimumFractionDigits=0
options.maximumFractionDigits=20}
return parseFloat(val).toLocaleString(this.settings.locale,options)}
formatDate(dateStr,format){if(!format)format=this.settings.dateFormat
if(dateStr===''||dateStr==null||(typeof dateStr==='object'&&!dateStr.getMonth))return''
let dt=new Date(dateStr)
if(this.isInt(dateStr))dt=new Date(Number(dateStr))
if(String(dt)==='Invalid Date')return''
let year=dt.getFullYear()
let month=dt.getMonth()
let date=dt.getDate()
return format.toLowerCase().replace('month',this.settings.fullmonths[month]).replace('mon',this.settings.shortmonths[month]).replace(/yyyy/g,('000'+year).slice(-4)).replace(/yyy/g,('000'+year).slice(-4)).replace(/yy/g,('0'+year).slice(-2)).replace(/(^|[^a-z$])y/g,'$1'+year).replace(/mm/g,('0'+(month+1)).slice(-2)).replace(/dd/g,('0'+date).slice(-2)).replace(/th/g,(date==1?'st':'th')).replace(/th/g,(date==2?'nd':'th')).replace(/th/g,(date==3?'rd':'th')).replace(/(^|[^a-z$])m/g,'$1'+(month+1)).replace(/(^|[^a-z$])d/g,'$1'+date)}
formatTime(dateStr,format){if(!format)format=this.settings.timeFormat
if(dateStr===''||dateStr==null||(typeof dateStr==='object'&&!dateStr.getMonth))return''
let dt=new Date(dateStr)
if(this.isInt(dateStr))dt=new Date(Number(dateStr))
if(this.isTime(dateStr)){let tmp=this.isTime(dateStr,true)
dt=new Date()
dt.setHours(tmp.hours)
dt.setMinutes(tmp.minutes)}
if(String(dt)==='Invalid Date')return''
if(format=='h12')format='hh:mi pm'
let type='am'
let hour=dt.getHours()
let h24=dt.getHours()
let min=dt.getMinutes()
let sec=dt.getSeconds()
if(min<10)min='0'+min
if(sec<10)sec='0'+sec
if(format.indexOf('am')!==-1||format.indexOf('pm')!==-1){if(hour>=12)type='pm'
if(hour>12)hour=hour-12
if(hour===0)hour=12}
return format.toLowerCase().replace('am',type).replace('pm',type).replace('hhh',(hour<10?'0'+hour:hour)).replace('hh24',(h24<10?'0'+h24:h24)).replace('h24',h24).replace('hh',hour).replace('mm',min).replace('mi',min).replace('ss',sec).replace(/(^|[^a-z$])h/g,'$1'+hour).replace(/(^|[^a-z$])m/g,'$1'+min).replace(/(^|[^a-z$])s/g,'$1'+sec)}
formatDateTime(dateStr,format){let fmt
if(dateStr===''||dateStr==null||(typeof dateStr==='object'&&!dateStr.getMonth))return''
if(typeof format!=='string'){fmt=[this.settings.dateFormat,this.settings.timeFormat]}else{fmt=format.split('|')
fmt[0]=fmt[0].trim()
fmt[1]=(fmt.length>1?fmt[1].trim():this.settings.timeFormat)}
if(fmt[1]==='h12')fmt[1]='h:m pm'
if(fmt[1]==='h24')fmt[1]='h24:m'
return this.formatDate(dateStr,fmt[0])+' '+this.formatTime(dateStr,fmt[1])}
stripSpaces(html){if(html==null)return html
switch(typeof html){case'number':break
case'string':html=String(html).replace(/(?:\r\n|\r|\n)/g,' ').replace(/\s\s+/g,' ').trim()
break
case'object':if(Array.isArray(html)){html=this.extend([],html)
html.forEach((key,ind)=>{html[ind]=this.stripSpaces(key)})}else{html=this.extend({},html)
Object.keys(html).forEach(key=>{html[key]=this.stripSpaces(html[key])})}
break}
return html}
stripTags(html){if(html==null)return html
switch(typeof html){case'number':break
case'string':html=String(html).replace(/<(?:[^>=]|='[^']*'|="[^"]*"|=[^'"][^\s>]*)*>/ig,'')
break
case'object':if(Array.isArray(html)){html=this.extend([],html)
html.forEach((key,ind)=>{html[ind]=this.stripTags(key)})}else{html=this.extend({},html)
Object.keys(html).forEach(key=>{html[key]=this.stripTags(html[key])})}
break}
return html}
encodeTags(html){if(html==null)return html
switch(typeof html){case'number':break
case'string':html=String(html).replace(/&/g,'&amp;').replace(/>/g,'&gt;').replace(/</g,'&lt;').replace(/"/g,'&quot;')
break
case'object':if(Array.isArray(html)){html=this.extend([],html)
html.forEach((key,ind)=>{html[ind]=this.encodeTags(key)})}else{html=this.extend({},html)
Object.keys(html).forEach(key=>{html[key]=this.encodeTags(html[key])})}
break}
return html}
decodeTags(html){if(html==null)return html
switch(typeof html){case'number':break
case'string':html=String(html).replace(/&gt;/g,'>').replace(/&lt;/g,'<').replace(/&quot;/g,'"').replace(/&amp;/g,'&')
break
case'object':if(Array.isArray(html)){html=this.extend([],html)
html.forEach((key,ind)=>{html[ind]=this.decodeTags(key)})}else{html=this.extend({},html)
Object.keys(html).forEach(key=>{html[key]=this.decodeTags(html[key])})}
break}
return html}
escapeId(id){if(id===''||id==null)return''
let re=/([\0-\x1f\x7f]|^-?\d)|^-$|[^\0-\x1f\x7f-\uFFFF\w-]/g
return(id+'').replace(re,(ch,asCodePoint)=>{if(asCodePoint){if(ch==='\0')return'\uFFFD'
return ch.slice(0,-1)+'\\'+ch.charCodeAt(ch.length-1).toString(16)+' '}
return'\\'+ch})}
unescapeId(id){if(id===''||id==null)return''
let re=/\\[\da-fA-F]{1,6}[\x20\t\r\n\f]?|\\([^\r\n\f])/g
return id.replace(re,(escape,nonHex)=>{let high='0x'+escape.slice(1)-0x10000
return nonHex?nonHex:high<0?String.fromCharCode(high+0x10000):String.fromCharCode(high>>10|0xD800,high&0x3FF|0xDC00)})}
base64encode(input){return btoa(input)}
base64decode(input){return atob(input)}
async sha256(str){const utf8=new TextEncoder().encode(str)
return crypto.subtle.digest('SHA-256',utf8).then((hashBuffer)=>{const hashArray=Array.from(new Uint8Array(hashBuffer))
return hashArray.map((bytes)=>bytes.toString(16).padStart(2,'0')).join('')})}
transition(div_old,div_new,type,callBack){return new Promise((resolve,reject)=>{let styles=getComputedStyle(div_old)
let width=parseInt(styles.width)
let height=parseInt(styles.height)
let time=0.5
if(!div_old||!div_new){console.log('ERROR: Cannot do transition when one of the divs is null')
return}
div_old.parentNode.style.cssText+='perspective: 900px; overflow: hidden;'
div_old.style.cssText+='; position: absolute; z-index: 1019; backface-visibility: hidden'
div_new.style.cssText+='; position: absolute; z-index: 1020; backface-visibility: hidden'
switch(type){case'slide-left':div_old.style.cssText+='overflow: hidden; transform: translate3d(0, 0, 0)'
div_new.style.cssText+='overflow: hidden; transform: translate3d('+width+'px, 0, 0)'
query(div_new).show()
setTimeout(()=>{div_new.style.cssText+='transition: '+time+'s; transform: translate3d(0, 0, 0)'
div_old.style.cssText+='transition: '+time+'s; transform: translate3d(-'+width+'px, 0, 0)'},1)
break
case'slide-right':div_old.style.cssText+='overflow: hidden; transform: translate3d(0, 0, 0)'
div_new.style.cssText+='overflow: hidden; transform: translate3d(-'+width+'px, 0, 0)'
query(div_new).show()
setTimeout(()=>{div_new.style.cssText+='transition: '+time+'s; transform: translate3d(0px, 0, 0)'
div_old.style.cssText+='transition: '+time+'s; transform: translate3d('+width+'px, 0, 0)'},1)
break
case'slide-down':div_old.style.cssText+='overflow: hidden; z-index: 1; transform: translate3d(0, 0, 0)'
div_new.style.cssText+='overflow: hidden; z-index: 0; transform: translate3d(0, 0, 0)'
query(div_new).show()
setTimeout(()=>{div_new.style.cssText+='transition: '+time+'s; transform: translate3d(0, 0, 0)'
div_old.style.cssText+='transition: '+time+'s; transform: translate3d(0, '+height+'px, 0)'},1)
break
case'slide-up':div_old.style.cssText+='overflow: hidden; transform: translate3d(0, 0, 0)'
div_new.style.cssText+='overflow: hidden; transform: translate3d(0, '+height+'px, 0)'
query(div_new).show()
setTimeout(()=>{div_new.style.cssText+='transition: '+time+'s; transform: translate3d(0, 0, 0)'
div_old.style.cssText+='transition: '+time+'s; transform: translate3d(0, 0, 0)'},1)
break
case'flip-left':div_old.style.cssText+='overflow: hidden; transform: rotateY(0deg)'
div_new.style.cssText+='overflow: hidden; transform: rotateY(-180deg)'
query(div_new).show()
setTimeout(()=>{div_new.style.cssText+='transition: '+time+'s; transform: rotateY(0deg)'
div_old.style.cssText+='transition: '+time+'s; transform: rotateY(180deg)'},1)
break
case'flip-right':div_old.style.cssText+='overflow: hidden; transform: rotateY(0deg)'
div_new.style.cssText+='overflow: hidden; transform: rotateY(180deg)'
query(div_new).show()
setTimeout(()=>{div_new.style.cssText+='transition: '+time+'s; transform: rotateY(0deg)'
div_old.style.cssText+='transition: '+time+'s; transform: rotateY(-180deg)'},1)
break
case'flip-down':div_old.style.cssText+='overflow: hidden; transform: rotateX(0deg)'
div_new.style.cssText+='overflow: hidden; transform: rotateX(180deg)'
query(div_new).show()
setTimeout(()=>{div_new.style.cssText+='transition: '+time+'s; transform: rotateX(0deg)'
div_old.style.cssText+='transition: '+time+'s; transform: rotateX(-180deg)'},1)
break
case'flip-up':div_old.style.cssText+='overflow: hidden; transform: rotateX(0deg)'
div_new.style.cssText+='overflow: hidden; transform: rotateX(-180deg)'
query(div_new).show()
setTimeout(()=>{div_new.style.cssText+='transition: '+time+'s; transform: rotateX(0deg)'
div_old.style.cssText+='transition: '+time+'s; transform: rotateX(180deg)'},1)
break
case'pop-in':div_old.style.cssText+='overflow: hidden; transform: translate3d(0, 0, 0)'
div_new.style.cssText+='overflow: hidden; transform: translate3d(0, 0, 0); transform: scale(.8); opacity: 0;'
query(div_new).show()
setTimeout(()=>{div_new.style.cssText+='transition: '+time+'s; transform: scale(1); opacity: 1;'
div_old.style.cssText+='transition: '+time+'s;'},1)
break
case'pop-out':div_old.style.cssText+='overflow: hidden; transform: translate3d(0, 0, 0); transform: scale(1); opacity: 1;'
div_new.style.cssText+='overflow: hidden; transform: translate3d(0, 0, 0); opacity: 0;'
query(div_new).show()
setTimeout(()=>{div_new.style.cssText+='transition: '+time+'s; opacity: 1;'
div_old.style.cssText+='transition: '+time+'s; transform: scale(1.7); opacity: 0;'},1)
break
default:div_old.style.cssText+='overflow: hidden; transform: translate3d(0, 0, 0)'
div_new.style.cssText+='overflow: hidden; translate3d(0, 0, 0); opacity: 0;'
query(div_new).show()
setTimeout(()=>{div_new.style.cssText+='transition: '+time+'s; opacity: 1;'
div_old.style.cssText+='transition: '+time+'s'},1)
break}
setTimeout(()=>{if(type==='slide-down'){query(div_old).css('z-index','1019')
query(div_new).css('z-index','1020')}
if(div_new){query(div_new).css({'opacity':'1'}).css({'transition':'','transform':''})}
if(div_old){query(div_old).css({'opacity':'1'}).css({'transition':'','transform':''})}
if(typeof callBack==='function')callBack()
resolve()},time*1000)})}
lock(box,options={}){if(box==null)return
if(typeof options=='string'){options={msg:options}}
if(arguments[2]){options.spinner=arguments[2]}
options=this.extend({spinner:false},options)
if(box?.[0]instanceof Node){box=Array.isArray(box)?box:box.get()}
if(!options.msg&&options.msg!==0)options.msg=''
this.unlock(box)
let el=query(box).get(0)
let pWidth=el.scrollWidth
let pHeight=el.scrollHeight
if(el.tagName=='BODY'){if(pWidth<innerWidth)pWidth=innerWidth
if(pHeight<innerHeight)pHeight=innerHeight}
query(box).prepend(`<div class="w2ui-lock" style="height: ${pHeight}px; width: ${pWidth}px"></div>`+'<div class="w2ui-lock-msg"></div>')
let $lock=query(box).find('.w2ui-lock')
let $mess=query(box).find('.w2ui-lock-msg')
if(!options.msg){$mess.css({'background-color':'transparent','background-image':'none','border':'0px','box-shadow':'none'})}
if(options.spinner===true){options.msg=`<div class="w2ui-spinner" ${(!options.msg ? 'style="width: 35px; height: 35px"' : '')}></div>`
+options.msg}
if(options.msg){$mess.html(options.msg).css('display','block')}else{$mess.remove()}
if(options.opacity!=null){$lock.css('opacity',options.opacity)}
$lock.css({display:'block'})
if(options.bgColor){$lock.css({'background-color':options.bgColor})}
let styles=getComputedStyle($lock.get(0))
let opacity=styles.opacity??0.15
$lock.on('mousedown',function(){if(typeof options.onClick=='function'){options.onClick()}else{$lock.css({'transition':'.2s','opacity':opacity*1.5})}}).on('mouseup',function(){if(typeof options.onClick!=='function'){$lock.css({'transition':'.2s','opacity':opacity})}}).on('mousewheel',function(event){if(event){event.stopPropagation()
event.preventDefault()}})}
unlock(box,speed){if(box==null)return
clearTimeout(box._prevUnlock)
if(box?.[0]instanceof Node){box=Array.isArray(box)?box:box.get()}
if(this.isInt(speed)&&speed>0){query(box).find('.w2ui-lock').css({transition:(speed/1000)+'s',opacity:0,})
let _box=query(box).get(0)
clearTimeout(_box._prevUnlock)
_box._prevUnlock=setTimeout(()=>{query(box).find('.w2ui-lock').remove()},speed)
query(box).find('.w2ui-lock-msg').remove()}else{query(box).find('.w2ui-lock').remove()
query(box).find('.w2ui-lock-msg').remove()}}
message(where,options){let closeTimer,openTimer,edata
let removeLast=()=>{let msgs=query(where?.box).find('.w2ui-message')
if(msgs.length==0)return
options=msgs.get(0)._msg_options||{}
if(typeof options?.close=='function'){options.close()}}
let closeComplete=(options)=>{let focus=options.box._msg_prevFocus
if(query(where.box).find('.w2ui-message').length<=1){if(where.owner){where.owner.unlock(where.param,150)}else{this.unlock(where.box,150)}}else{query(where.box).find(`#w2ui-message-${where.owner?.name}-${options.msgIndex-1}`).css('z-index',1500)}
if(focus){let msg=query(focus).closest('.w2ui-message')
if(msg.length>0){let opt=msg.get(0)._msg_options
opt.setFocus(focus)}else{focus.focus()}}else{if(typeof where.owner?.focus=='function')where.owner.focus()}
query(options.box).remove()
if(options.msgIndex===0){head.css('z-index',options.tmp.zIndex)
query(where.box).css('overflow',options.tmp.overflow)}
if(options.trigger){edata.finish()}}
if(typeof options=='string'||typeof options=='number'){options={width:(String(options).length<300?350:550),height:(String(options).length<300?170:250),text:String(options),}}
if(typeof options!='object'){removeLast()
return}
if(options.text!=null)options.body=`<div class="w2ui-centered w2ui-msg-text">${options.text}</div>`
if(options.width==null)options.width=350
if(options.height==null)options.height=170
if(options.hideOn==null)options.hideOn=['esc']
if(options.on==null){let opts=options
options=new w2base()
w2utils.extend(options,opts)}
options.on('open',(event)=>{w2utils.bindEvents(query(options.box).find('.w2ui-eaction'),options)
query(event.detail.box).find('button, input, textarea, [name=hidden-first]').off('.message').on('keydown.message',function(evt){if(evt.keyCode==27&&options.hideOn.includes('esc')){if(options.cancelAction){options.action(options.cancelAction)}else{options.close()}}})
setTimeout(()=>options.setFocus(options.focus),300)})
options.off('.prom')
let prom={self:options,action(callBack){options.on('action.prom',callBack)
return prom},close(callBack){options.on('close.prom',callBack)
return prom},open(callBack){options.on('open.prom',callBack)
return prom},then(callBack){options.on('open:after.prom',callBack)
return prom}}
if(options.actions==null&&options.buttons==null&&options.html==null){options.actions={Ok(event){event.detail.self.close()}}}
options.off('.buttons')
if(options.actions!=null){options.buttons=''
Object.keys(options.actions).forEach((action)=>{let handler=options.actions[action]
let btnAction=action
if(typeof handler=='function'){options.buttons+=`<button class="w2ui-btn w2ui-eaction" data-click='["action","${action}","event"]' name="${action}">${action}</button>`}
if(typeof handler=='object'){options.buttons+=`<button class="w2ui-btn w2ui-eaction ${handler.class || ''}" name="${action}" data-click='["action","${action}","event"]'
                        style="${handler.style ?? ''}" ${handler.attrs ?? ''}>${handler.text || action}</button>`
btnAction=Array.isArray(options.actions)?handler.text:action}
if(typeof handler=='string'){options.buttons+=`<button class="w2ui-btn w2ui-eaction" name="${handler}" data-click='["action","${handler}","event"]'>${handler}</button>`
btnAction=handler}
if(typeof btnAction=='string'){btnAction=btnAction[0].toLowerCase()+btnAction.substr(1).replace(/\s+/g,'')}
prom[btnAction]=function(callBack){options.on('action.buttons',(event)=>{let target=event.detail.action[0].toLowerCase()+event.detail.action.substr(1).replace(/\s+/g,'')
if(target==btnAction)callBack(event)})
return prom}})}
Array('html','body','buttons').forEach(param=>{options[param]=String(options[param]??'').trim()})
if(options.body!==''||options.buttons!==''){options.html=`
                <div class="w2ui-message-body">${options.body || ''}</div>
                <div class="w2ui-message-buttons">${options.buttons || ''}</div>
            `}
let styles=getComputedStyle(query(where.box).get(0))
let pWidth=parseFloat(styles.width)
let pHeight=parseFloat(styles.height)
let titleHeight=0
if(query(where.after).length>0){styles=getComputedStyle(query(where.after).get(0))
titleHeight=parseInt(styles.display!='none'?parseInt(styles.height):0)}
if(options.width>pWidth)options.width=pWidth-10
if(options.height>pHeight-titleHeight)options.height=pHeight-10-titleHeight
options.originalWidth=options.width
options.originalHeight=options.height
if(parseInt(options.width)<0)options.width=pWidth+options.width
if(parseInt(options.width)<10)options.width=10
if(parseInt(options.height)<0)options.height=pHeight+options.height-titleHeight
if(parseInt(options.height)<10)options.height=10
if(options.originalHeight<0)options.height=pHeight+options.originalHeight-titleHeight
if(options.originalWidth<0)options.width=pWidth+options.originalWidth*2
let head=query(where.box).find(where.after)
if(!options.tmp){options.tmp={zIndex:head.css('z-index'),overflow:styles.overflow}}
if(options.html===''&&options.body===''&&options.buttons===''){removeLast()}else{options.msgIndex=query(where.box).find('.w2ui-message').length
if(options.msgIndex===0&&typeof this.lock=='function'){query(where.box).css('overflow','hidden')
if(where.owner){where.owner.lock(where.param)}else{this.lock(where.box)}}
query(where.box).find('.w2ui-message').css('z-index',1390)
head.css('z-index',1501)
let content=`
                <div id="w2ui-message-${where.owner?.name}-${options.msgIndex}" class="w2ui-message" data-mousedown="stop"
                    style="z-index: 1500; left: ${((pWidth - options.width) / 2)}px; top: ${titleHeight}px;
                        width: ${options.width}px; height: ${options.height}px; transform: translateY(-${options.height}px)"
                    ${options.hideOn.includes('click')
                        ? where.param
                            ? `data-click='["message","${where.param}"]`
                            : 'data-click="message"'
                        : ''}>
                    <span name="hidden-first" tabindex="0" style="position: absolute; top: 0; outline: none"></span>
                    ${options.html}
                    <span name="hidden-last" tabindex="0" style="position: absolute; top: 0; outline: none"></span>
                </div>`
if(query(where.after).length>0){query(where.box).find(where.after).after(content)}else{query(where.box).prepend(content)}
options.box=query(where.box).find(`#w2ui-message-${where.owner?.name}-${options.msgIndex}`)[0]
w2utils.bindEvents(options.box,this)
query(options.box).addClass('animating')
options.box._msg_options=options
options.box._msg_prevFocus=document.activeElement
setTimeout(()=>{edata=options.trigger('open',{target:this.name,box:options.box,self:options})
if(edata.isCancelled===true){query(where.box).find(`#w2ui-message-${where.owner?.name}-${options.msgIndex}`).remove()
if(options.msgIndex===0){head.css('z-index',options.tmp.zIndex)
query(where.box).css('overflow',options.tmp.overflow)}
return}
query(options.box).css({transition:'0.3s',transform:'translateY(0px)'})},0)
openTimer=setTimeout(()=>{query(where.box).find(`#w2ui-message-${where.owner?.name}-${options.msgIndex}`).removeClass('animating').css({'transition':'0s'})
edata.finish()},300)}
options.action=(action,event)=>{let click=options.actions[action]
if(click instanceof Object&&click.onClick)click=click.onClick
let edata=options.trigger('action',{target:this.name,action,self:options,originalEvent:event,value:options.input?options.input.value:null})
if(edata.isCancelled===true)return
if(typeof click==='function')click(edata)
edata.finish()}
options.close=()=>{edata=options.trigger('close',{target:'self',box:options.box,self:options})
if(edata.isCancelled===true)return
clearTimeout(openTimer)
if(query(options.box).hasClass('animating')){clearTimeout(closeTimer)
closeComplete(options)
return}
query(options.box).addClass('w2ui-closing animating').css({'transition':'0.15s','transform':'translateY(-'+options.height+'px)'})
if(options.msgIndex!==0){query(where.box).find(`#w2ui-message-${where.owner?.name}-${options.msgIndex-1}`).css('z-index',1499)}
closeTimer=setTimeout(()=>{closeComplete(options)},150)}
options.setFocus=(focus)=>{let cnt=query(where.box).find('.w2ui-message').length-1
let box=query(where.box).find(`#w2ui-message-${where.owner?.name}-${cnt}`)
let sel='input, button, select, textarea, [contentEditable], .w2ui-input'
if(focus!=null){let el=isNaN(focus)?box.find(sel).filter(focus).get(0):box.find(sel).get(focus)
el?.focus()}else{box.find('[name=hidden-first]').get(0)?.focus()}
query(where.box).find('.w2ui-message').find(sel+',[name=hidden-first],[name=hidden-last]').off('.keep-focus')
query(box).find(sel+',[name=hidden-first],[name=hidden-last]').on('blur.keep-focus',function(event){setTimeout(()=>{let focus=document.activeElement
let inside=query(box).find(sel).filter(focus).length>0
let name=query(focus).attr('name')
if(!inside&&focus&&focus!==document.body){query(box).find(sel).get(0)?.focus()}
if(name=='hidden-last'){query(box).find(sel).get(0)?.focus()}
if(name=='hidden-first'){query(box).find(sel).get(-1)?.focus()}},1)})}
return prom}
notify(text,options){return new Promise(resolve=>{if(typeof text=='object'){options=text
text=options.text}
options=options||{}
options.where=options.where??document.body
options.timeout=options.timeout??15_000
if(typeof this.tmp.notify_resolve=='function'){this.tmp.notify_resolve()
query(this.tmp.notify_where).find('#w2ui-notify').remove()}
this.tmp.notify_resolve=resolve
this.tmp.notify_where=options.where
clearTimeout(this.tmp.notify_timer)
if(text){if(typeof options.actions=='object'){let actions={}
Object.keys(options.actions).forEach(action=>{actions[action]=`<a class="w2ui-notify-link" value="${action}">${action}</a>`})
text=this.execTemplate(text,actions)}
let html=`
                    <div id="w2ui-notify">
                        <div class="${options.class} ${options.error ? 'w2ui-notify-error' : ''}">
                            ${text}
                            <span class="w2ui-notify-close w2ui-icon-cross"></span>
                        </div>
                    </div>`
query(options.where).append(html)
query(options.where).find('#w2ui-notify').find('.w2ui-notify-close').on('click',event=>{query(options.where).find('#w2ui-notify').remove()
resolve()})
if(options.actions){query(options.where).find('#w2ui-notify .w2ui-notify-link').on('click',event=>{let value=query(event.target).attr('value')
options.actions[value]()
query(options.where).find('#w2ui-notify').remove()
resolve()})}
if(options.timeout>0){this.tmp.notify_timer=setTimeout(()=>{query(options.where).find('#w2ui-notify').remove()
resolve()},options.timeout)}}})}
confirm(where,options){if(typeof options=='string'){options={text:options}}
w2utils.normButtons(options,{yes:'Yes',no:'No'})
let prom=w2utils.message(where,options)
if(prom){prom.action(event=>{event.detail.self.close()})}
return prom}
normButtons(options,btn){options.actions=options.actions??{}
let btns=Object.keys(btn)
btns.forEach(name=>{let action=options['btn_'+name]
if(action){btn[name]={text:w2utils.lang(action.text??btn[name]??''),class:action.class??'',style:action.style??'',attrs:action.attrs??''}
delete options['btn_'+name]}
Array('text','class','style','attrs').forEach(suffix=>{if(options[name+'_'+suffix]){if(typeof btn[name]=='string'){btn[name]={text:btn[name]}}
btn[name][suffix]=options[name+'_'+suffix]
delete options[name+'_'+suffix]}})})
if(btns.includes('yes')&&btns.includes('no')){if(w2utils.settings.macButtonOrder){w2utils.extend(options.actions,{no:btn.no,yes:btn.yes})}else{w2utils.extend(options.actions,{yes:btn.yes,no:btn.no})}}
if(btns.includes('ok')&&btns.includes('cancel')){if(w2utils.settings.macButtonOrder){w2utils.extend(options.actions,{cancel:btn.cancel,ok:btn.ok})}else{w2utils.extend(options.actions,{ok:btn.ok,cancel:btn.cancel})}}
return options}
getSize(el,type){el=query(el)
let ret=0
if(el.length>0){el=el[0]
let styles=getComputedStyle(el)
switch(type){case'width':ret=parseFloat(styles.width)
if(styles.width==='auto')ret=0
break
case'height':ret=parseFloat(styles.height)
if(styles.height==='auto')ret=0
break
default:ret=parseFloat(styles[type]??0)||0
break}}
return ret}
getStrWidth(str,styles,raw){let div=query('body > #_tmp_width')
if(div.length===0){query('body').append('<div id="_tmp_width" style="position: absolute; top: -9000px;"></div>')
div=query('body > #_tmp_width')}
div.html(raw?str:this.encodeTags(str)).attr('style',`position: absolute; top: -9000px; ${styles || ''}`)
return div[0].clientWidth}
execTemplate(str,replace_obj){if(typeof str!=='string'||!replace_obj||typeof replace_obj!=='object'){return str}
return str.replace(/\${([^}]+)?}/g,function($1,$2){return replace_obj[$2]||$2})}
marker(el,items,options={onlyFirst:false,wholeWord:false}){if(!Array.isArray(items)){if(items!=null&&items!==''){items=[items]}else{items=[]}}
let ww=options.wholeWord
query(el).each(el=>{clearMerkers(el)
items.forEach(str=>{if(typeof str!=='string')str=String(str)
let replaceValue=(matched)=>{return'<span class="w2ui-marker">'+matched+'</span>'}
str=str.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,'\\$&').replace(/&/g,'&amp;').replace(/</g,'&gt;').replace(/>/g,'&lt;')
let regex=new RegExp((ww?'\\b':'')+str+(ww?'\\b':'')+'(?!([^<]+)?>)','i'+(!options.onlyFirst?'g':''))
el.innerHTML=el.innerHTML.replace(regex,replaceValue)})})
function clearMerkers(el){let markerRE=/\<span class=\"w2ui\-marker\"\>((.|\n|\r)*)\<\/span\>/ig
while(el.innerHTML.indexOf('<span class="w2ui-marker"')!==-1){el.innerHTML=el.innerHTML.replace(markerRE,'$1')}}}
lang(phrase,params){if(!phrase||this.settings.phrases==null||typeof phrase!=='string'||'<=>='.includes(phrase)){return this.execTemplate(phrase,params)}
let translation=this.settings.phrases[phrase]
if(translation==null){translation=phrase
if(this.settings.warnNoPhrase){if(!this.settings.missing){this.settings.missing={}}
this.settings.missing[phrase]='---'
this.settings.phrases[phrase]='---'
console.log(`Missing translation for "%c${phrase}%c", see %c w2utils.settings.phrases %c with value "---"`,'color: orange','','color: #999','')}}else if(translation==='---'&&!this.settings.warnNoPhrase){translation=phrase}
if(translation==='---'){translation=`<span ${this.tooltip(phrase)}>---</span>`}
return this.execTemplate(translation,params)}
locale(locale,keepPhrases,noMerge){return new Promise((resolve,reject)=>{if(Array.isArray(locale)){this.settings.phrases={}
let proms=[]
let files={}
locale.forEach((file,ind)=>{if(file.length===5){file='locale/'+file.toLowerCase()+'.json'
locale[ind]=file}
proms.push(this.locale(file,true,false))})
Promise.allSettled(proms).then(res=>{res.forEach(r=>{if(r.value)files[r.value.file]=r.value.data})
locale.forEach(file=>{this.settings=this.extend({},this.settings,files[file])})
resolve()})
return}
if(!locale)locale='en-us'
if(locale instanceof Object){this.settings=this.extend({},this.settings,w2locale,locale)
return}
if(locale.length===5){locale='locale/'+locale.toLowerCase()+'.json'}
fetch(locale,{method:'GET'}).then(res=>res.json()).then(data=>{if(noMerge!==true){if(keepPhrases){this.settings=this.extend({},this.settings,data)}else{this.settings=this.extend({},this.settings,w2locale,{phrases:{}},data)}}
resolve({file:locale,data})}).catch((err)=>{console.log('ERROR: Cannot load locale '+locale)
reject(err)})})}
scrollBarSize(){if(this.tmp.scrollBarSize)return this.tmp.scrollBarSize
let html=`
            <div id="_scrollbar_width" style="position: absolute; top: -300px; width: 100px; height: 100px; overflow-y: scroll;">
                <div style="height: 120px">1</div>
            </div>
        `
query('body').append(html)
this.tmp.scrollBarSize=100-query('#_scrollbar_width > div')[0].clientWidth
query('#_scrollbar_width').remove()
return this.tmp.scrollBarSize}
checkName(name){if(name==null){console.log('ERROR: Property "name" is required but not supplied.')
return false}
if(w2ui[name]!=null){console.log(`ERROR: Object named "${name}" is already registered as w2ui.${name}.`)
return false}
if(!this.isAlphaNumeric(name)){console.log('ERROR: Property "name" has to be alpha-numeric (a-z, 0-9, dash and underscore).')
return false}
return true}
checkUniqueId(id,items,desc,obj){if(!Array.isArray(items))items=[items]
let isUnique=true
items.forEach(item=>{if(item.id===id){console.log(`ERROR: The item id="${id}" is not unique within the ${desc} "${obj}".`,items)
isUnique=false}})
return isUnique}
encodeParams(obj,prefix=''){let str=''
Object.keys(obj).forEach(key=>{if(str!='')str+='&'
if(typeof obj[key]=='object'){str+=this.encodeParams(obj[key],prefix+key+(prefix?']':'')+'[')}else{str+=`${prefix}${key}${prefix ? ']' : ''}=${obj[key]}`}})
return str}
parseRoute(route){let keys=[]
let path=route.replace(/\/\(/g,'(?:/').replace(/\+/g,'__plus__').replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?/g,(_,slash,format,key,capture,optional)=>{keys.push({name:key,optional:!!optional})
slash=slash||''
return''+(optional?'':slash)+'(?:'+(optional?slash:'')+(format||'')+(capture||(format&&'([^/.]+?)'||'([^/]+?)'))+')'+(optional||'')}).replace(/([\/.])/g,'\\$1').replace(/__plus__/g,'(.+)').replace(/\*/g,'(.*)')
return{path:new RegExp('^'+path+'$','i'),keys:keys}}
getCursorPosition(input){if(input==null)return null
let caretOffset=0
let doc=input.ownerDocument||input.document
let win=doc.defaultView||doc.parentWindow
let sel
if(['INPUT','TEXTAREA'].includes(input.tagName)){caretOffset=input.selectionStart}else{if(win.getSelection){sel=win.getSelection()
if(sel.rangeCount>0){let range=sel.getRangeAt(0)
let preCaretRange=range.cloneRange()
preCaretRange.selectNodeContents(input)
preCaretRange.setEnd(range.endContainer,range.endOffset)
caretOffset=preCaretRange.toString().length}}else if((sel=doc.selection)&&sel.type!=='Control'){let textRange=sel.createRange()
let preCaretTextRange=doc.body.createTextRange()
preCaretTextRange.moveToElementText(input)
preCaretTextRange.setEndPoint('EndToEnd',textRange)
caretOffset=preCaretTextRange.text.length}}
return caretOffset}
setCursorPosition(input,pos,posEnd){if(input==null)return
let range=document.createRange()
let el,sel=window.getSelection()
if(['INPUT','TEXTAREA'].includes(input.tagName)){input.setSelectionRange(pos,posEnd??pos)}else{for(let i=0;i<input.childNodes.length;i++){let tmp=query(input.childNodes[i]).text()
if(input.childNodes[i].tagName){tmp=query(input.childNodes[i]).html()
tmp=tmp.replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&amp;/g,'&').replace(/&quot;/g,'"').replace(/&nbsp;/g,' ')}
if(pos<=tmp.length){el=input.childNodes[i]
if(el.childNodes&&el.childNodes.length>0)el=el.childNodes[0]
if(el.childNodes&&el.childNodes.length>0)el=el.childNodes[0]
break}else{pos-=tmp.length}}
if(el==null)return
if(pos>el.length)pos=el.length
range.setStart(el,pos)
if(posEnd){range.setEnd(el,posEnd)}else{range.collapse(true)}
sel.removeAllRanges()
sel.addRange(range)}}
parseColor(str){if(typeof str!=='string')return null;else str=str.trim().toUpperCase()
if(str[0]==='#')str=str.substr(1)
let color={}
if(str.length===3){color={r:parseInt(str[0]+str[0],16),g:parseInt(str[1]+str[1],16),b:parseInt(str[2]+str[2],16),a:1}}else if(str.length===6){color={r:parseInt(str.substr(0,2),16),g:parseInt(str.substr(2,2),16),b:parseInt(str.substr(4,2),16),a:1}}else if(str.length===8){color={r:parseInt(str.substr(0,2),16),g:parseInt(str.substr(2,2),16),b:parseInt(str.substr(4,2),16),a:Math.round(parseInt(str.substr(6,2),16)/255*100)/100}}else if(str.length>4&&str.substr(0,4)==='RGB('){let tmp=str.replace('RGB','').replace(/\(/g,'').replace(/\)/g,'').split(',')
color={r:parseInt(tmp[0],10),g:parseInt(tmp[1],10),b:parseInt(tmp[2],10),a:1}}else if(str.length>5&&str.substr(0,5)==='RGBA('){let tmp=str.replace('RGBA','').replace(/\(/g,'').replace(/\)/g,'').split(',')
color={r:parseInt(tmp[0],10),g:parseInt(tmp[1],10),b:parseInt(tmp[2],10),a:parseFloat(tmp[3])}}else{return null}
return color}
colorContrast(color1,color2){let lum1=calcLumens(color1)
let lum2=calcLumens(color2)
let ratio=(Math.max(lum1,lum2)+0.05)/(Math.min(lum1,lum2)+0.05)
return ratio.toFixed(2)
function calcLumens(color){let{r,g,b}=w2utils.parseColor(color)??{r:0,g:0,b:0}
let gamma=2.2
let normR=r/255
let normG=g/255
let normB=b/255
let sR=(normR<=0.03928)?normR/12.92:Math.pow((normR+0.055)/1.055,gamma)
let sG=(normG<=0.03928)?normG/12.92:Math.pow((normG+0.055)/1.055,gamma)
let sB=(normB<=0.03928)?normB/12.92:Math.pow((normB+0.055)/1.055,gamma)
return 0.2126*sR+0.7152*sG+0.0722*sB}}
hsv2rgb(h,s,v,a){let r,g,b,i,f,p,q,t
if(arguments.length===1){s=h.s;v=h.v;a=h.a;h=h.h}
h=h/360
s=s/100
v=v/100
i=Math.floor(h*6)
f=h*6-i
p=v*(1-s)
q=v*(1-f*s)
t=v*(1-(1-f)*s)
switch(i%6){case 0:r=v,g=t,b=p;break
case 1:r=q,g=v,b=p;break
case 2:r=p,g=v,b=t;break
case 3:r=p,g=q,b=v;break
case 4:r=t,g=p,b=v;break
case 5:r=v,g=p,b=q;break}
return{r:Math.round(r*255),g:Math.round(g*255),b:Math.round(b*255),a:(a!=null?a:1)}}
rgb2hsv(r,g,b,a){if(arguments.length===1){g=r.g;b=r.b;a=r.a;r=r.r}
let max=Math.max(r,g,b),min=Math.min(r,g,b),d=max-min,h,s=(max===0?0:d/max),v=max/255
switch(max){case min:h=0;break
case r:h=(g-b)+d*(g<b?6:0);h/=6*d;break
case g:h=(b-r)+d*2;h/=6*d;break
case b:h=(r-g)+d*4;h/=6*d;break}
return{h:Math.round(h*360),s:Math.round(s*100),v:Math.round(v*100),a:(a!=null?a:1)}}
tooltip(html,options){let actions
let showOn='mouseenter'
let hideOn='mouseleave'
if(typeof html=='object'){options=html}
options=options||{}
if(typeof html=='string'){options.html=html}
if(options.showOn){showOn=options.showOn
delete options.showOn}
if(options.hideOn){hideOn=options.hideOn
delete options.hideOn}
if(!options.name)options.name='no-name'
actions=` on${showOn}="w2tooltip.show(this, `
+`JSON.parse(w2utils.base64decode('${this.base64encode(JSON.stringify(options))}')))" `
+`on${hideOn}="w2tooltip.hide('${options.name}')"`
return actions}
isPlainObject(value){if(value==null){return false}
if(Object.prototype.toString.call(value)!=='[object Object]'){return false}
if(value.constructor===undefined){return true}
let proto=Object.getPrototypeOf(value)
return proto===null||proto===Object.prototype}
clone(obj,options){let ret
options=Object.assign({functions:true,elements:true,events:true,exclude:[]},options??{})
if(Array.isArray(obj)){ret=Array.from(obj)
ret.forEach((value,ind)=>{ret[ind]=this.clone(value,options)})}else if(this.isPlainObject(obj)){ret={}
Object.assign(ret,obj)
if(options.exclude){options.exclude.forEach(key=>{delete ret[key]})}
Object.keys(ret).forEach(key=>{ret[key]=this.clone(ret[key],options)
if(ret[key]===undefined)delete ret[key]})}else{if((obj instanceof Function&&!options.functions)||(obj instanceof Node&&!options.elements)||(obj instanceof Event&&!options.events)){}else{ret=obj}}
return ret}
extend(target,source){if(Array.isArray(target)){if(Array.isArray(source)){target.splice(0,target.length)
source.forEach(s=>{target.push(this.clone(s))})}else{throw new Error('Arrays can be extended with arrays only')}}else if(target instanceof Node||target instanceof Event){throw new Error('HTML elmenents and events cannot be extended')}else if(target&&typeof target=='object'&&source!=null){if(typeof source!='object'){throw new Error('Object can be extended with other objects only.')}
Object.keys(source).forEach(key=>{if(target[key]!=null&&typeof target[key]=='object'&&source[key]!=null&&typeof source[key]=='object'){let src=this.clone(source[key])
if(target[key]instanceof Node||target[key]instanceof Event){target[key]=src}else{if(Array.isArray(target[key])&&this.isPlainObject(src)){target[key]={}}
this.extend(target[key],src)}}else{target[key]=this.clone(source[key])}})}else if(source!=null){throw new Error('Object is not extendable, only {} or [] can be extended.')}
if(arguments.length>2){for(let i=2;i<arguments.length;i++){this.extend(target,arguments[i])}}
return target}
naturalCompare(a,b){let i,codeA,codeB=1,posA=0,posB=0,alphabet=String.alphabet
function getCode(str,pos,code){if(code){for(i=pos;code=getCode(str,i),code<76&&code>65;)++i
return+str.slice(pos-1,i)}
code=alphabet&&alphabet.indexOf(str.charAt(pos))
return code>-1?code+76:((code=str.charCodeAt(pos)||0),code<45||code>127)?code:code<46?65:code<48?code-1:code<58?code+18:code<65?code-11:code<91?code+11:code<97?code-37:code<123?code+5:code-63}
if((a+='')!=(b+=''))for(;codeB;){codeA=getCode(a,posA++)
codeB=getCode(b,posB++)
if(codeA<76&&codeB<76&&codeA>66&&codeB>66){codeA=getCode(a,posA,posA)
codeB=getCode(b,posB,posA=i)
posB=i}
if(codeA!=codeB)return(codeA<codeB)?-1:1}
return 0}
normMenu(menu,el){if(Array.isArray(menu)){menu.forEach((it,m)=>{if(typeof it==='string'||typeof it==='number'){menu[m]={id:it,text:String(it)}}else if(it!=null){if(it.caption!=null&&it.text==null)it.text=it.caption
if(it.text!=null&&it.id==null)it.id=it.text
if(it.text==null&&it.id!=null)it.text=it.id}else{menu[m]={id:null,text:'null'}}})
return menu}else if(typeof menu==='function'){let newMenu=menu.call(this,menu,el)
return w2utils.normMenu.call(this,newMenu)}else if(typeof menu==='object'){return Object.keys(menu).map(key=>{return{id:key,text:menu[key]}})}}
prepareParams(url,fetchOptions,defDataType){let dataType=defDataType??w2utils.settings.dataType
let postParams=fetchOptions.body
switch(dataType){case'HTTPJSON':postParams={request:postParams}
if(['PUT','DELETE'].includes(fetchOptions.method)){fetchOptions.method='POST'}
body2params()
break
case'HTTP':if(['PUT','DELETE'].includes(fetchOptions.method)){fetchOptions.method='POST'}
body2params()
break
case'RESTFULL':if(['PUT','DELETE'].includes(fetchOptions.method)){fetchOptions.headers['Content-Type']='application/json'}else{body2params()}
break
case'JSON':if(fetchOptions.method=='GET'){postParams={request:postParams}
body2params()}else{fetchOptions.headers['Content-Type']='application/json'
fetchOptions.method='POST'}
break}
fetchOptions.body=typeof fetchOptions.body=='string'?fetchOptions.body:JSON.stringify(fetchOptions.body)
return fetchOptions
function body2params(){Object.keys(postParams).forEach(key=>{let param=postParams[key]
if(typeof param=='object')param=JSON.stringify(param)
url.searchParams.append(key,param)})
delete fetchOptions.body}}
bindEvents(selector,subject){if(selector.length==0)return
if(selector?.[0]instanceof Node){selector=Array.isArray(selector)?selector:selector.get()}
query(selector).each((el)=>{let actions=query(el).data()
Object.keys(actions).forEach(name=>{let events=['click','dblclick','mouseenter','mouseleave','mouseover','mouseout','mousedown','mousemove','mouseup','pointerenter','pointerleave','pointerover','pointerout','pointerdown','pointermove','pointerup','contextmenu','focus','focusin','focusout','blur','input','change','keydown','keyup','keypress']
if(events.indexOf(String(name).toLowerCase())==-1){return}
let params=actions[name]
if(typeof params=='string'){params=params.split('|').map(key=>{if(key==='true')key=true
if(key==='false')key=false
if(key==='undefined')key=undefined
if(key==='null')key=null
if(parseFloat(key)==key)key=parseFloat(key)
let quotes=['\'','"','`']
if(typeof key=='string'&&quotes.includes(key[0])&&quotes.includes(key[key.length-1])){key=key.substring(1,key.length-1)}
return key})}
let method=params[0]
params=params.slice(1)
query(el).off(name+'.w2utils-bind').on(name+'.w2utils-bind',function(event){switch(method){case'alert':alert(params[0])
break
case'stop':event.stopPropagation()
break
case'prevent':event.preventDefault()
break
case'stopPrevent':event.stopPropagation()
event.preventDefault()
return false
break
default:if(subject[method]==null){throw new Error(`Cannot dispatch event as the method "${method}" does not exist.`)}
subject[method].apply(subject,params.map((key,ind)=>{switch(String(key).toLowerCase()){case'event':return event
case'this':return this
default:return key}}))}})})})}
debounce(func,wait=250){let timeout
return(...args)=>{clearTimeout(timeout)
timeout=setTimeout(()=>{func(...args)},wait)}}}
var w2utils=new Utils()
class Dialog extends w2base{constructor(){super()
this.defaults={title:'',text:'',body:'',buttons:'',width:450,height:250,focus:null,actions:null,style:'',speed:0.3,modal:false,maximized:false,keyboard:true,showClose:true,showMax:false,resizable:false,transition:null,openMaximized:false,moved:false}
this.name='popup'
this.status='closed'
this.onOpen=null
this.onClose=null
this.onMax=null
this.onMin=null
this.onToggle=null
this.onKeydown=null
this.onAction=null
this.onMove=null
this.tmp={}
this.handleResize=(event)=>{if(!this.options.moved){this.center(undefined,undefined,true)}}}
open(options){let self=this
if(this.status=='closing'||query('#w2ui-popup').hasClass('animating')){this.close(true)}
let old_options=this.options
if(['string','number'].includes(typeof options)){options=w2utils.extend({title:'Notification',body:`<div class="w2ui-centered">${options}</div>`,actions:{Ok(){self.close()}},cancelAction:'ok'},arguments[1]??{})}
if(options.text!=null)options.body=`<div class="w2ui-centered w2ui-msg-text">${options.text}</div>`
options=Object.assign({},this.defaults,old_options,{title:'',body:''},options,{maximized:false})
this.options=options
if(query('#w2ui-popup').length===0){this.off('*')
Object.keys(this).forEach(key=>{if(key.startsWith('on')&&key!='on')this[key]=null})}
Object.keys(options).forEach(key=>{if(key.startsWith('on')&&key!='on'&&options[key]){this[key]=options[key]}})
options.width=parseInt(options.width)
options.height=parseInt(options.height)
let edata,msg,tmp
let{top,left}=this.center()
let prom={self:this,action(callBack){self.on('action.prom',callBack)
return prom},close(callBack){self.on('close.prom',callBack)
return prom},then(callBack){self.on('open:after.prom',callBack)
return prom}}
if(options.actions!=null&&!options.buttons){options.buttons=''
Object.keys(options.actions).forEach((action)=>{let handler=options.actions[action]
let btnAction=action
if(typeof handler=='function'){options.buttons+=`<button class="w2ui-btn w2ui-eaction" name="${action}" data-click='["action","${action}","event"]'>${action}</button>`}
if(typeof handler=='object'){options.buttons+=`<button class="w2ui-btn w2ui-eaction ${handler.class || ''}" name="${action}" data-click='["action","${action}","event"]'
                        style="${handler.style}" ${handler.attrs}>${handler.text || action}</button>`
btnAction=Array.isArray(options.actions)?handler.text:action}
if(typeof handler=='string'){btnAction=handler[0].toLowerCase()+handler.substr(1).replace(/\s+/g,'')
options.buttons+=`<button class="w2ui-btn w2ui-eaction" name="${action}" data-click='["action","${btnAction}","event"]'>${handler}</button>`}
if(typeof btnAction=='string'){btnAction=btnAction[0].toLowerCase()+btnAction.substr(1).replace(/\s+/g,'')}
prom[btnAction]=function(callBack){self.on('action.buttons',(event)=>{let target=event.detail.action[0].toLowerCase()+event.detail.action.substr(1).replace(/\s+/g,'')
if(target==btnAction)callBack(event)})
return prom}})}
let titleBtns=''
if(options.showClose){titleBtns+=`<div class="w2ui-popup-button w2ui-popup-close">
                        <span class="w2ui-icon w2ui-icon-cross w2ui-eaction" data-mousedown="stop" data-click="close"></span>
                    </div>`}
if(options.showMax){titleBtns+=`<div class="w2ui-popup-button w2ui-popup-max">
                        <span class="w2ui-icon w2ui-icon-box w2ui-eaction" data-mousedown="stop" data-click="toggle"></span>
                    </div>`}
if(query('#w2ui-popup').length===0){edata=this.trigger('open',{target:'popup',present:false})
if(edata.isCancelled===true)return
this.status='opening'
w2utils.lock(document.body,{opacity:0.3,onClick:options.modal?null:()=>{this.close()}})
let styles=`
                left: ${left}px;
                top: ${top}px;
                width: ${parseInt(options.width)}px;
                height: ${parseInt(options.height)}px;
                transition: ${options.speed}s
            `
msg=`<div id="w2ui-popup" class="w2ui-popup w2ui-anim-open animating" style="${w2utils.stripSpaces(styles)}"></div>`
query('body').append(msg)
query('#w2ui-popup')[0]._w2popup={self:this,created:new Promise((resolve)=>{this._promCreated=resolve}),opened:new Promise((resolve)=>{this._promOpened=resolve}),closing:new Promise((resolve)=>{this._promClosing=resolve}),closed:new Promise((resolve)=>{this._promClosed=resolve}),}
styles=`${!options.title ? 'top: 0px !important;' : ''} ${!options.buttons ? 'bottom: 0px !important;' : ''}`
msg=`
                <span name="hidden-first" tabindex="0" style="position: absolute; top: -100px"></span>
                <div class="w2ui-popup-title-btns">${titleBtns}</div>
                <div class="w2ui-popup-title" style="${!options.title ? 'display: none' : ''}"></div>
                <div class="w2ui-box" style="${styles}">
                    <div class="w2ui-popup-body ${!options.title || ' w2ui-popup-no-title'}
                        ${!options.buttons || ' w2ui-popup-no-buttons'}" style="${options.style}">
                    </div>
                </div>
                <div class="w2ui-popup-buttons" style="${!options.buttons ? 'display: none' : ''}"></div>
                <div class="w2ui-popup-resizer resize-point resize-icon"></div>
                <span name="hidden-last" tabindex="0" style="position: absolute; top: -100px"></span>
            `
query('#w2ui-popup').html(msg)
if(options.title)query('#w2ui-popup .w2ui-popup-title').append(w2utils.lang(options.title))
if(options.buttons)query('#w2ui-popup .w2ui-popup-buttons').append(options.buttons)
if(options.body)query('#w2ui-popup .w2ui-popup-body').append(options.body)
setTimeout(()=>{query('#w2ui-popup').css('transition',options.speed+'s').removeClass('w2ui-anim-open')
w2utils.bindEvents('#w2ui-popup .w2ui-eaction',this)
query('#w2ui-popup').find('.w2ui-popup-body').show()
this._promCreated()},1)
clearTimeout(this._timer)
this._timer=setTimeout(()=>{this.status='open'
self.setFocus(options.focus)
edata.finish()
this._promOpened()
query('#w2ui-popup').removeClass('animating')},options.speed*1000)}else{edata=this.trigger('open',{target:'popup',present:true})
if(edata.isCancelled===true)return
this.status='opening'
if(old_options!=null){if(!old_options.maximized&&(old_options.width!=options.width||old_options.height!=options.height)){this.resize(options.width,options.height)}
options.prevSize=options.width+'px:'+options.height+'px'
options.maximized=old_options.maximized}
let cloned=query('#w2ui-popup .w2ui-box').get(0).cloneNode(true)
query(cloned).removeClass('w2ui-box').addClass('w2ui-box-temp').find('.w2ui-popup-body').empty().append(options.body)
query('#w2ui-popup .w2ui-box').after(cloned)
if(options.buttons){query('#w2ui-popup .w2ui-popup-buttons').show().html('').append(options.buttons)
query('#w2ui-popup .w2ui-popup-body').removeClass('w2ui-popup-no-buttons')
query('#w2ui-popup .w2ui-box, #w2ui-popup .w2ui-box-temp').css('bottom','')}else{query('#w2ui-popup .w2ui-popup-buttons').hide().html('')
query('#w2ui-popup .w2ui-popup-body').addClass('w2ui-popup-no-buttons')
query('#w2ui-popup .w2ui-box, #w2ui-popup .w2ui-box-temp').css('bottom','0px')}
if(options.title){query('#w2ui-popup .w2ui-popup-title').show().html(w2utils.lang(options.title))
query('#w2ui-popup .w2ui-popup-body').removeClass('w2ui-popup-no-title')
query('#w2ui-popup .w2ui-box, #w2ui-popup .w2ui-box-temp').css('top','')}else{query('#w2ui-popup .w2ui-popup-title').hide().html('')
query('#w2ui-popup .w2ui-popup-body').addClass('w2ui-popup-no-title')
query('#w2ui-popup .w2ui-box, #w2ui-popup .w2ui-box-temp').css('top','0px')}
if(titleBtns){query('#w2ui-popup .w2ui-popup-title-btns').show().html(titleBtns)}else{query('#w2ui-popup .w2ui-popup-title-btns').hide()}
let div_old=query('#w2ui-popup .w2ui-box')[0]
let div_new=query('#w2ui-popup .w2ui-box-temp')[0]
query('#w2ui-popup').addClass('animating')
w2utils.transition(div_old,div_new,options.transition,()=>{query(div_old).remove()
query(div_new).removeClass('w2ui-box-temp').addClass('w2ui-box')
let $body=query(div_new).find('.w2ui-popup-body')
if($body.length==1){$body[0].style.cssText=options.style
$body.show()}
self.setFocus(options.focus)
query('#w2ui-popup').removeClass('animating')})
this.status='open'
edata.finish()
w2utils.bindEvents('#w2ui-popup .w2ui-eaction',this)
query('#w2ui-popup').find('.w2ui-popup-body').show()}
if(options.openMaximized){this.max()}
options._last_focus=document.activeElement
if(options.keyboard){query(document.body).off('.w2popup').on('keydown.w2popup',(event)=>{this.keydown(event)})}
query(window).on('resize',this.handleResize)
tmp={changing:false,mvMove:mvMove,mvStop:mvStop}
query('#w2ui-popup .w2ui-popup-title').off('mousedown').on('mousedown',function(event){if(!self.options.maximized)mvStart(event)})
if(options.resizable){query('#w2ui-popup .w2ui-popup-resizer').show()
query('#w2ui-popup .w2ui-popup-resizer').off('mousedown').on('mousedown',event=>{mvStart(event,true)})}else{query('#w2ui-popup .w2ui-popup-resizer').hide()}
return prom
function mvStart(evt,resizer){if(!evt)evt=window.event
self.status=resizer?'resizing':'moving'
let rect=query('#w2ui-popup').get(0).getBoundingClientRect()
Object.assign(tmp,{changing:true,isLocked:query('#w2ui-popup > .w2ui-lock').length==1?true:false,x:evt.screenX,y:evt.screenY,pos_x:rect.x,pos_y:rect.y,width:rect.width,height:rect.height})
if(!tmp.isLocked)self.lock({opacity:0})
query(document.body).on('mousemove.w2ui-popup',tmp.mvMove).on('mouseup.w2ui-popup',tmp.mvStop)
if(evt.stopPropagation)evt.stopPropagation();else evt.cancelBubble=true
if(evt.preventDefault)evt.preventDefault();else return false}
function mvMove(evt){if(tmp.changing!=true)return
if(!evt)evt=window.event
tmp.div_x=evt.screenX-tmp.x
tmp.div_y=evt.screenY-tmp.y
let edata=self.trigger('move',{target:'popup',div_x:tmp.div_x,div_y:tmp.div_y,originalEvent:evt})
if(edata.isCancelled===true)return
if(self.status=='moving'){query('#w2ui-popup').css({'transition':'none','transform':'translate3d('+tmp.div_x+'px, '+tmp.div_y+'px, 0px)'})
self.options.moved=true}else{query('#w2ui-popup').css({transition:'none',width:(tmp.width+tmp.div_x)+'px',height:(tmp.height+tmp.div_y)+'px'})}
edata.finish()}
function mvStop(evt){if(tmp.changing!=true)return
if(!evt)evt=window.event
tmp.div_x=(evt.screenX-tmp.x)
tmp.div_y=(evt.screenY-tmp.y)
if(self.status=='moving'){query('#w2ui-popup').css({'left':(tmp.pos_x+tmp.div_x)+'px','top':(tmp.pos_y+tmp.div_y)+'px'}).css({'transition':'none','transform':'translate3d(0px, 0px, 0px)'})}else{query('#w2ui-popup').css({transition:'none',width:(tmp.width+tmp.div_x)+'px',height:(tmp.height+tmp.div_y)+'px'})
self.resizeMessages()}
tmp.changing=false
self.status='open'
query(document.body).off('.w2ui-popup')
if(!tmp.isLocked)self.unlock()}}
load(options){return new Promise((resolve,reject)=>{if(typeof options=='string'){options={url:options}}
if(options.url==null){console.log('ERROR: The url is not defined.')
reject('The url is not defined')
return}
this.status='loading'
let[url,selector]=String(options.url).split('#')
if(url){fetch(url).then(res=>res.text()).then(html=>{resolve(this.template(html,selector,options))})}})}
template(data,id,options={}){let html
try{html=query(data)}catch(e){html=query.html(data)}
if(id)html=html.filter('#'+id)
Object.assign(options,{width:parseInt(query(html).css('width')),height:parseInt(query(html).css('height')),title:query(html).find('[rel=title]').html(),body:query(html).find('[rel=body]').html(),buttons:query(html).find('[rel=buttons]').html(),style:query(html).find('[rel=body]').get(0).style.cssText,})
return this.open(options)}
action(action,event){let click=this.options.actions[action]
if(click instanceof Object&&click.onClick)click=click.onClick
let edata=this.trigger('action',{action,target:'popup',self:this,originalEvent:event,value:this.input?this.input.value:null})
if(edata.isCancelled===true)return
if(typeof click==='function')click.call(this,event)
edata.finish()}
keydown(event){if(this.options&&!this.options.keyboard)return
let edata=this.trigger('keydown',{target:'popup',originalEvent:event})
if(edata.isCancelled===true)return
switch(event.keyCode){case 27:event.preventDefault()
if(query('#w2ui-popup .w2ui-message').length==0){if(this.options.cancelAction){this.action(this.options.cancelAction)}else{this.close()}}
break}
edata.finish()}
close(immediate){let edata=this.trigger('close',{target:'popup'})
if(edata.isCancelled===true)return
let cleanUp=()=>{query('#w2ui-popup').remove()
if(this.options._last_focus&&this.options._last_focus.length>0)this.options._last_focus.focus()
this.status='closed'
this.options={}
edata.finish()
this._promClosed()}
if(query('#w2ui-popup').length===0||this.status=='closed'){return}
if(this.status=='opening'){immediate=true}
if(this.status=='closing'&&immediate===true){cleanUp()
clearTimeout(this.tmp.closingTimer)
w2utils.unlock(document.body,0)
return}
this.status='closing'
query('#w2ui-popup').css('transition',this.options.speed+'s').addClass('w2ui-anim-close animating')
w2utils.unlock(document.body,300)
this._promClosing()
if(immediate){cleanUp()}else{this.tmp.closingTimer=setTimeout(cleanUp,this.options.speed*1000)}
if(this.options.keyboard){query(document.body).off('keydown',this.keydown)}
query(window).off('resize',this.handleResize)}
toggle(){let edata=this.trigger('toggle',{target:'popup'})
if(edata.isCancelled===true)return
if(this.options.maximized===true)this.min();else this.max()
setTimeout(()=>{edata.finish()},(this.options.speed*1000)+50)}
max(){if(this.options.maximized===true)return
let edata=this.trigger('max',{target:'popup'})
if(edata.isCancelled===true)return
this.status='resizing'
let rect=query('#w2ui-popup').get(0).getBoundingClientRect()
this.options.prevSize=rect.width+':'+rect.height
this.resize(10000,10000,()=>{this.status='open'
this.options.maximized=true
edata.finish()})}
min(){if(this.options.maximized!==true)return
let size=this.options.prevSize.split(':')
let edata=this.trigger('min',{target:'popup'})
if(edata.isCancelled===true)return
this.status='resizing'
this.options.maximized=false
this.resize(parseInt(size[0]),parseInt(size[1]),()=>{this.status='open'
this.options.prevSize=null
edata.finish()})}
clear(){query('#w2ui-popup .w2ui-popup-title').html('')
query('#w2ui-popup .w2ui-popup-body').html('')
query('#w2ui-popup .w2ui-popup-buttons').html('')}
reset(){this.open(this.defaults)}
message(options){return w2utils.message({owner:this,box:query('#w2ui-popup').get(0),after:'.w2ui-popup-title'},options)}
confirm(options){return w2utils.confirm({owner:this,box:query('#w2ui-popup'),after:'.w2ui-popup-title'},options)}
setFocus(focus){let box=query('#w2ui-popup')
let sel='input, button, select, textarea, [contentEditable], [tabindex], .w2ui-input'
if(focus!=null){let el=isNaN(focus)?box.find(sel).filter(focus).get(0):box.find(sel).get(focus)
el?.focus()}else{let el=box.find('[name=hidden-first]').get(0)
if(el)el.focus()}
query(box).find(sel).off('.keep-focus').on('blur.keep-focus',function(event){setTimeout(()=>{let focus=document.activeElement
let inside=query(box).find(sel).filter(focus).length>0
let name=query(focus).attr('name')
if(!inside&&focus&&focus!==document.body){query(box).find(sel).get(0)?.focus()}
if(name=='hidden-last'){query(box).find(sel).get(1)?.focus()}
if(name=='hidden-first'){query(box).find(sel).get(-2)?.focus()}},1)})}
lock(msg,showSpinner){let args=Array.from(arguments)
args.unshift(query('#w2ui-popup'))
w2utils.lock(...args)}
unlock(speed){w2utils.unlock(query('#w2ui-popup'),speed)}
center(width,height,force){let maxW,maxH
if(window.innerHeight==undefined){maxW=parseInt(document.documentElement.offsetWidth)
maxH=parseInt(document.documentElement.offsetHeight)}else{maxW=parseInt(window.innerWidth)
maxH=parseInt(window.innerHeight)}
width=parseInt(width??this.options.width)
height=parseInt(height??this.options.height)
if(this.options.maximized===true){width=maxW
height=maxH}
if(maxW-10<width)width=maxW-10
if(maxH-10<height)height=maxH-10
let top=(maxH-height)/3
let left=(maxW-width)/2
if(force){query('#w2ui-popup').css({'transition':'none','top':top+'px','left':left+'px','width':width+'px','height':height+'px'})
this.resizeMessages()}
return{top,left,width,height}}
resize(newWidth,newHeight,callBack){let self=this
if(this.options.speed==null)this.options.speed=0
let{top,left,width,height}=this.center(newWidth,newHeight)
let speed=this.options.speed
query('#w2ui-popup').css({'transition':`${speed}s width, ${speed}s height, ${speed}s left, ${speed}s top`,'top':top+'px','left':left+'px','width':width+'px','height':height+'px'})
let tmp_int=setInterval(()=>{self.resizeMessages()},10)
setTimeout(()=>{clearInterval(tmp_int)
self.resizeMessages()
if(typeof callBack=='function')callBack()},(this.options.speed*1000)+50)}
resizeMessages(){query('#w2ui-popup .w2ui-message').each(msg=>{let mopt=msg._msg_options
let popup=query('#w2ui-popup')
if(parseInt(mopt.width)<10)mopt.width=10
if(parseInt(mopt.height)<10)mopt.height=10
let rect=popup[0].getBoundingClientRect()
let titleHeight=parseInt(popup.find('.w2ui-popup-title')[0].clientHeight)
let pWidth=parseInt(rect.width)
let pHeight=parseInt(rect.height)
mopt.width=mopt.originalWidth
if(mopt.width>pWidth-10){mopt.width=pWidth-10}
mopt.height=mopt.originalHeight
if(mopt.height>pHeight-titleHeight-5){mopt.height=pHeight-titleHeight-5}
if(mopt.originalHeight<0)mopt.height=pHeight+mopt.originalHeight-titleHeight
if(mopt.originalWidth<0)mopt.width=pWidth+mopt.originalWidth*2
query(msg).css({left:((pWidth-mopt.width)/2)+'px',width:mopt.width+'px',height:mopt.height+'px'})})}}
function w2alert(msg,title,callBack){let prom
let options={title:w2utils.lang(title??'Notification'),body:`<div class="w2ui-centered w2ui-msg-text">${msg}</div>`,showClose:false,actions:{ok:'Ok'},cancelAction:'ok'}
if(query('#w2ui-popup').length>0&&w2popup.status!='closing'){prom=w2popup.message(options)}else{prom=w2popup.open(options)}
prom.ok(event=>{if(typeof event.detail.self?.close=='function'){event.detail.self.close()}
if(typeof callBack=='function')callBack()})
return prom}
function w2confirm(msg,title,callBack){let prom
let options=msg
if(['string','number'].includes(typeof options)){options={msg:options}}
if(options.msg){options.body=`<div class="w2ui-centered w2ui-msg-text">${options.msg}</div>`,delete options.msg}
if(typeof title=='function'&&callBack==null){callBack=title
title=undefined}
w2utils.extend(options,{title:w2utils.lang(title??options.title??'Confirmation'),showClose:false,modal:true,cancelAction:'no'})
if(callBack==null&&options.callBack!=null){callBack=options.callBack}
w2utils.normButtons(options,{yes:'Yes',no:'No'})
if(query('#w2ui-popup').length>0&&w2popup.status!='closing'){prom=w2popup.message(options)}else{prom=w2popup.open(options)}
prom.self.off('.confirm').on('action:after.confirm',(event)=>{if(typeof event.detail.self?.close=='function'){event.detail.self.close()}
if(typeof callBack=='function')callBack(event.detail.action)})
return prom}
function w2prompt(label,title,callBack){let prom
let options=label
if(['string','number'].includes(typeof options)){options={label:options}}
if(options.label){options.focus=1
options.body=(options.textarea?`<div class="w2ui-prompt textarea">
                 <div>${options.label}</div>
                 <textarea id="w2prompt" class="w2ui-input" ${options.attrs ?? ''}
                    data-keydown="keydown|event" data-keyup="change|event">${options.value??''}</textarea>
               </div>`:`<div class="w2ui-prompt w2ui-centered">
                 <label>${options.label}</label>
                 <input id="w2prompt" class="w2ui-input" ${options.attrs ?? ''}
                    data-keydown="keydown|event" data-keyup="change|event" value="${options.value??''}">
               </div>`)}
w2utils.extend(options,{title:w2utils.lang(title??options.title??'Notification'),showClose:false,modal:true,cancelAction:'cancel'})
w2utils.normButtons(options,{ok:'Ok',cancel:'Cancel'})
if(query('#w2ui-popup').length>0&&w2popup.status!='closing'){prom=w2popup.message(options)}else{prom=w2popup.open(options)}
if(prom.self.box){prom.self.input=query(prom.self.box).find('#w2prompt').get(0)}else{prom.self.input=query('#w2ui-popup .w2ui-popup-body #w2prompt').get(0)}
if(options.value!==null){prom.self.input.select()}
prom.change=function(callback){prom.self.on('change',callback)
return this}
prom.self.off('.prompt').on('open:after.prompt',(event)=>{let box=event.detail.box?event.detail.box:query('#w2ui-popup .w2ui-popup-body').get(0)
w2utils.bindEvents(query(box).find('#w2prompt'),{keydown(evt){if(evt.keyCode==27)evt.stopPropagation()},change(evt){let edata=prom.self.trigger('change',{target:'prompt',originalEvent:evt})
if(edata.isCancelled===true)return
if(evt.keyCode==13&&(evt.ctrlKey||evt.metaKey||evt.target.tagName!='TEXTAREA')){prom.self.action('Ok',evt)}
if(evt.keyCode==27){prom.self.action('Cancel',evt)}
edata.finish()}})
query(box).find('.w2ui-eaction').trigger('keyup')}).on('action:after.prompt',(event)=>{if(typeof event.detail.self?.close=='function'){event.detail.self.close()}
if(typeof callBack=='function')callBack(event.detail.action)})
return prom}
let w2popup=new Dialog()
class Tooltip{static active={}
constructor(){this.defaults={name:null,html:'',style:'',class:'',position:'top|bottom',align:'',anchor:null,contextMenu:false,anchorClass:'',anchorStyle:'',autoShow:false,autoShowOn:null,autoHideOn:null,arrowSize:8,screenMargin:2,autoResize:true,margin:1,offsetX:0,offsetY:0,maxWidth:null,maxHeight:null,watchScroll:null,watchResize:null,hideOn:null,onThen:null,onShow:null,onHide:null,onUpdate:null,onMove:null}}
static observeRemove=new MutationObserver((mutations)=>{let cnt=0
Object.keys(Tooltip.active).forEach(name=>{let overlay=Tooltip.active[name]
if(overlay.displayed){if(!overlay.anchor||!overlay.anchor.isConnected){overlay.hide()}else{cnt++}}})
if(cnt===0){Tooltip.observeRemove.disconnect()}})
trigger(event,data){if(arguments.length==2){let type=event
event=data
data.type=type}
if(event.overlay){return event.overlay.trigger(event)}else{console.log('ERROR: cannot find overlay where to trigger events')}}
get(name){if(arguments.length==0){return Object.keys(Tooltip.active)}else if(name===true){return Tooltip.active}else{return Tooltip.active[name.replace(/[\s\.#]/g,'_')]}}
attach(anchor,text){let options,overlay
let self=this
if(arguments.length==0){return}else if(arguments.length==1&&anchor instanceof Object){options=anchor
anchor=options.anchor}else if(arguments.length===2&&typeof text==='string'){options={anchor,html:text}
text=options.html}else if(arguments.length===2&&text!=null&&typeof text==='object'){options=text
text=options.html}
options=w2utils.extend({},this.defaults,options||{})
if(!text&&options.text)text=options.text
if(!text&&options.html)text=options.html
delete options.anchor
let name=(options.name?options.name:anchor?.id)
if(anchor==document||anchor==null){anchor=document.body}
if(options.contextMenu){anchor=document.body
name=name??'context-menu'}
if(!name){name='noname-'+Object.keys(Tooltip.active).length
console.log('NOTICE: name property is not defined for tooltip, could lead to too many instances')}
name=name.replace(/[\s\.#]/g,'_')
if(Tooltip.active[name]){overlay=Tooltip.active[name]
overlay.prevOptions=overlay.options
overlay.options=options
overlay.anchor=anchor
if(overlay.prevOptions.html!=overlay.options.html||overlay.prevOptions.class!=overlay.options.class||overlay.prevOptions.style!=overlay.options.style){overlay.needsUpdate=true}
options=overlay.options
Object.keys(overlay).forEach(key=>{let val=overlay[key]
if(key.startsWith('on')&&typeof val=='function'){delete overlay[key]}})}else{overlay=new w2base()
Object.assign(overlay,{id:'w2overlay-'+name,name,options,anchor,self,displayed:false,tmp:{observeResize:new ResizeObserver(()=>{this.resize(overlay.name)})},hide(){self.hide(name)}})
Tooltip.active[name]=overlay}
Object.keys(overlay.options).forEach(key=>{let val=overlay.options[key]
if(key.startsWith('on')&&typeof val=='function'){overlay[key]=val
delete overlay.options[key]}})
if(options.autoShow===true){options.autoShowOn=options.autoShowOn??'mouseenter'
options.autoHideOn=options.autoHideOn??'mouseleave'
options.autoShow=false
options._keep=true}
if(options.autoShowOn){let scope='autoShow-'+overlay.name
query(anchor).off(`.${scope}`).on(`${options.autoShowOn}.${scope}`,event=>{self.show(overlay.name)
event.stopPropagation()})
delete options.autoShowOn
options._keep=true}
if(options.autoHideOn){let scope='autoHide-'+overlay.name
query(anchor).off(`.${scope}`).on(`${options.autoHideOn}.${scope}`,event=>{self.hide(overlay.name)
event.stopPropagation()})
delete options.autoHideOn
options._keep=true}
overlay.off('.attach')
let ret={overlay,then:(callback)=>{overlay.on('show:after.attach',event=>{callback(event)})
return ret},show:(callback)=>{overlay.on('show.attach',event=>{callback(event)})
return ret},hide:(callback)=>{overlay.on('hide.attach',event=>{callback(event)})
return ret},update:(callback)=>{overlay.on('update.attach',event=>{callback(event)})
return ret},move:(callback)=>{overlay.on('move.attach',event=>{callback(event)})
return ret}}
return ret}
update(name,html){let overlay=Tooltip.active[name]
if(overlay){overlay.needsUpdate=true
overlay.options.html=html
this.show(name)}else{console.log(`Tooltip "${name}" is not displayed. Cannot update it.`)}}
show(name){if(name instanceof HTMLElement||name instanceof Object){let options=name
if(name instanceof HTMLElement){options=arguments[1]||{}
options.anchor=name}
let ret=this.attach(options)
ret.overlay.tmp.hidden=false
query(ret.overlay.anchor).off('.autoShow-'+ret.overlay.name).off('.autoHide-'+ret.overlay.name)
setTimeout(()=>{if(!ret.overlay.tmp.hidden){this.show(ret.overlay.name)
if(this.initControls){this.initControls(ret.overlay)}}},1)
return ret}
let edata
let self=this
let overlay=Tooltip.active[name.replace(/[\s\.#]/g,'_')]
if(!overlay)return
let options=overlay.options
if(!overlay||(overlay.displayed&&!overlay.needsUpdate)){this.resize(overlay?.name)
return}
let position=options.position.split('|')
let isVertical=['top','bottom'].includes(position[0])
let overlayStyles=(options.align=='both'&&isVertical?'':'white-space: nowrap;')
if(options.maxWidth&&w2utils.getStrWidth(options.html,'')>options.maxWidth){overlayStyles='width: '+options.maxWidth+'px; white-space: inherit; overflow: auto;'}
overlayStyles+=' max-height: '+(options.maxHeight?options.maxHeight:window.innerHeight-4)+'px;'
if(options.html===''||options.html==null){self.hide(name)
return}else if(overlay.box){edata=this.trigger('update',{target:name,overlay})
if(edata.isCancelled===true){if(overlay.prevOptions){overlay.options=overlay.prevOptions
delete overlay.prevOptions}
return}
query(overlay.box).find('.w2ui-overlay-body').attr('style',(options.style||'')+'; '+overlayStyles).removeClass().addClass('w2ui-overlay-body '+options.class).html(options.html)
this.resize(overlay.name)}else{edata=this.trigger('show',{target:name,overlay})
if(edata.isCancelled===true)return
query('body').append(`<div id="${overlay.id}" name="${name}" style="display: none; pointer-events: none" class="w2ui-overlay"
                        data-click="stop" data-focusin="stop">
                    <style></style>
                    <div class="w2ui-overlay-body ${options.class}" style="${options.style || ''}; ${overlayStyles}">
                        ${options.html}
                    </div>
                </div>`)
overlay.box=query('#'+w2utils.escapeId(overlay.id))[0]
overlay.displayed=true
let names=query(overlay.anchor).data('tooltipName')??[]
names.push(name)
query(overlay.anchor).data('tooltipName',names)
w2utils.bindEvents(overlay.box,{})
overlay.tmp.originalCSS=''
if(query(overlay.anchor).length>0){overlay.tmp.originalCSS=query(overlay.anchor)[0].style.cssText}
this.resize(overlay.name)}
if(options.anchorStyle){overlay.anchor.style.cssText+=';'+options.anchorStyle}
if(options.anchorClass){if(!(options.anchorClass=='w2ui-focus'&&overlay.anchor==document.body)){query(overlay.anchor).addClass(options.anchorClass)}}
if(typeof options.hideOn=='string')options.hideOn=[options.hideOn]
if(!Array.isArray(options.hideOn))options.hideOn=[]
Object.assign(overlay.tmp,{scrollLeft:document.body.scrollLeft,scrollTop:document.body.scrollTop})
addHideEvents()
addWatchEvents(document.body)
query(overlay.box).show()
overlay.tmp.observeResize.observe(overlay.box)
Tooltip.observeRemove.observe(document.body,{subtree:true,childList:true})
query(overlay.box).css('opacity',1).find('.w2ui-overlay-body').html(options.html)
setTimeout(()=>{query(overlay.box).css({'pointer-events':'auto'}).data('ready','yes')},100)
delete overlay.needsUpdate
overlay.box.overlay=overlay
if(edata)edata.finish()
return{overlay}
function addWatchEvents(el){let scope='tooltip-'+overlay.name
let queryEl=el
if(el.tagName=='BODY'){queryEl=el.ownerDocument}
query(queryEl).off(`.${scope}`).on(`scroll.${scope}`,event=>{Object.assign(overlay.tmp,{scrollLeft:el.scrollLeft,scrollTop:el.scrollTop})
self.resize(overlay.name)})}
function addHideEvents(){let hide=(event)=>{self.hide(overlay.name)}
let $anchor=query(overlay.anchor)
let scope='tooltip-'+overlay.name
query('html').off(`.${scope}`)
if(options.hideOn.includes('doc-click')){if(['INPUT','TEXTAREA'].includes(overlay.anchor.tagName)){$anchor.off(`.${scope}-doc`).on(`click.${scope}-doc`,(event)=>{event.stopPropagation()})}
query('html').on(`click.${scope}`,hide)}
if(options.hideOn.includes('focus-change')){query('html').on(`focusin.${scope}`,(e)=>{if(document.activeElement!=overlay.anchor){self.hide(overlay.name)}})}
if(['INPUT','TEXTAREA'].includes(overlay.anchor.tagName)){$anchor.off(`.${scope}`)
options.hideOn.forEach(event=>{if(['doc-click','focus-change'].indexOf(event)==-1){$anchor.on(`${event}.${scope}`,{once:true},hide)}})}}}
hide(name){let overlay
if(arguments.length==0){Object.keys(Tooltip.active).forEach(name=>{this.hide(name)})
return}
if(name instanceof HTMLElement){let names=query(name).data('tooltipName')??[]
names.forEach(name=>{this.hide(name)})
return}
if(typeof name=='string'){name=name.replace(/[\s\.#]/g,'_')
overlay=Tooltip.active[name]}
if(overlay?.tmp)overlay.tmp.hidden=true
if(!overlay||!overlay.box)return
let edata=this.trigger('hide',{target:name,overlay})
if(edata.isCancelled===true)return
if(!overlay.options._keep)delete Tooltip.active[name]
let scope='tooltip-'+overlay.name
overlay.tmp.observeResize?.disconnect()
if(overlay.options.watchScroll){query(overlay.options.watchScroll).off('.w2scroll-'+overlay.name)}
let cnt=0
Object.keys(Tooltip.active).forEach(key=>{let overlay=Tooltip.active[key]
if(overlay.displayed){cnt++}})
if(cnt==0){Tooltip.observeRemove.disconnect()}
query('html').off(`.${scope}`)
query(document).off(`.${scope}`)
overlay.box?.remove()
overlay.box=null
overlay.displayed=false
let names=query(overlay.anchor).data('tooltipName')??[]
let ind=names.indexOf(overlay.name)
if(ind!=-1)names.splice(names.indexOf(overlay.name),1)
if(names.length==0){query(overlay.anchor).removeData('tooltipName')}else{query(overlay.anchor).data('tooltipName',names)}
if(overlay.options.anchorStyle){overlay.anchor.style.cssText=overlay.tmp.originalCSS}
query(overlay.anchor).off(`.${scope}`).removeClass(overlay.options.anchorClass)
if(overlay.options.url){overlay.options.items.splice(0)
overlay.tmp.remote.hasMore=true
overlay.tmp.remote.search=null}
edata.finish()}
resize(name){if(arguments.length==0){Object.keys(Tooltip.active).forEach(key=>{let overlay=Tooltip.active[key]
if(overlay.displayed)this.resize(overlay.name)})
return}
let overlay=Tooltip.active[name.replace(/[\s\.#]/g,'_')]
let pos=this.getPosition(overlay.name)
let newPos=pos.left+'x'+pos.top
let edata
if(overlay.tmp.lastPos!=newPos){edata=this.trigger('move',{target:name,overlay,pos})}
query(overlay.box).css({left:pos.left+'px',top:pos.top+'px'}).then(query=>{if(pos.width!=null){query.css('width',pos.width+'px').find('.w2ui-overlay-body').css('width','100%')}
if(pos.height!=null){query.css('height',pos.height+'px').find('.w2ui-overlay-body').css('height','100%')}}).find('.w2ui-overlay-body').removeClass('w2ui-arrow-right w2ui-arrow-left w2ui-arrow-top w2ui-arrow-bottom').addClass(pos.arrow.class).closest('.w2ui-overlay').find('style').text(pos.arrow.style)
if(overlay.tmp.lastPos!=newPos&&edata){overlay.tmp.lastPos=newPos
edata.finish()}}
getPosition(name){let overlay=Tooltip.active[name.replace(/[\s\.#]/g,'_')]
if(!overlay||!overlay.box){return}
let options=overlay.options
if(overlay.tmp.resizedY||overlay.tmp.resizedX){query(overlay.box).css({width:'',height:'',scroll:'auto'})}
let scrollSize=w2utils.scrollBarSize()
let hasScrollBarX=!(document.body.scrollWidth==document.body.clientWidth)
let hasScrollBarY=!(document.body.scrollHeight==document.body.clientHeight)
let max={width:window.innerWidth-(hasScrollBarY?scrollSize:0),height:window.innerHeight-(hasScrollBarX?scrollSize:0)}
let position=options.position=='auto'?'top|bottom|right|left'.split('|'):Array.isArray(options.position)?options.position:options.position.split('|')
let isVertical=['top','bottom'].includes(position[0])
let content=overlay.box.getBoundingClientRect()
let anchor=overlay.anchor?.getBoundingClientRect?.()
if(overlay.anchor==document.body){let evt=options.originalEvent
while(evt?.originalEvent){evt=evt.originalEvent}
let{x,y,width,height}=evt??{x:options.x,y:options.y,width:0,height:10}
anchor={left:x-(options.contextMenu?4:0),top:y-(options.contextMenu?4:0),width:width??0,height:height??10,arrow:options.contextMenu?'none':null}}
let arrowSize=options.arrowSize
if(anchor.arrow=='none')arrowSize=0
let available={top:anchor.top-arrowSize,bottom:max.height-arrowSize-(anchor.top+anchor.height)-(hasScrollBarX?scrollSize:0)-2,left:anchor.left,right:max.width-(anchor.left+anchor.width)+(hasScrollBarY?scrollSize:0),}
if(content.width<22)content.width=22
if(content.height<14)content.height=14
let left,top,width,height
let found=''
let arrow={offset:0,class:'',style:`#${overlay.id} { --tip-size: ${arrowSize}px; }`}
let adjust={left:0,top:0}
let bestFit={posX:'',x:0,posY:'',y:0}
position.forEach(pos=>{if(['top','bottom'].includes(pos)){if(!found&&(content.height+arrowSize/1.893)<available[pos]){found=pos}
if(available[pos]>bestFit.y){Object.assign(bestFit,{posY:pos,y:available[pos]})}}
if(['left','right'].includes(pos)){if(!found&&(content.width+arrowSize/1.893)<available[pos]){found=pos}
if(available[pos]>bestFit.x){Object.assign(bestFit,{posX:pos,x:available[pos]})}}})
if(!found){if(isVertical){found=bestFit.posY}else{found=bestFit.posX}}
if(options.autoResize){if(['top','bottom'].includes(found)){if(content.height>available[found]){height=available[found]
overlay.tmp.resizedY=true}else{overlay.tmp.resizedY=false}}
if(['left','right'].includes(found)){if(content.width>available[found]){width=available[found]
overlay.tmp.resizedX=true}else{overlay.tmp.resizedX=false}}}
usePosition(found)
if(isVertical)anchorAlignment()
top+=parseFloat(options.offsetY*(found=='top'?-1:1))
left+=parseFloat(options.offsetX*(found=='left'?-1:1))
screenAdjust()
let extraTop=(found=='top'?-options.margin:(found=='bottom'?options.margin:0))
let extraLeft=(found=='left'?-options.margin:(found=='right'?options.margin:0))
top=Math.floor((top+parseFloat(extraTop))*100)/100
left=Math.floor((left+parseFloat(extraLeft))*100)/100
return{left,top,arrow,adjust,width,height,pos:found}
function usePosition(pos){arrow.class=anchor.arrow?anchor.arrow:`w2ui-arrow-${pos}`
switch(pos){case'top':{left=anchor.left+(anchor.width-(width??content.width))/2
top=anchor.top-(height??content.height)-arrowSize/1.5+1
break}
case'bottom':{left=anchor.left+(anchor.width-(width??content.width))/2
top=anchor.top+anchor.height+arrowSize/1.25+1
break}
case'left':{left=anchor.left-(width??content.width)-arrowSize/1.2-1
top=anchor.top+(anchor.height-(height??content.height))/2
break}
case'right':{left=anchor.left+anchor.width+arrowSize/1.2+1
top=anchor.top+(anchor.height-(height??content.height))/2
break}}}
function anchorAlignment(){if(options.align=='left'){adjust.left=anchor.left-left
left=anchor.left}
if(options.align=='right'){adjust.left=(anchor.left+anchor.width-(width??content.width))-left
left=anchor.left+anchor.width-(width??content.width)}
if(['top','bottom'].includes(found)&&options.align.startsWith('both')){let minWidth=options.align.split(':')[1]??50
if(anchor.width>=minWidth){left=anchor.left
width=anchor.width}}
if(options.align=='top'){adjust.top=anchor.top-top
top=anchor.top}
if(options.align=='bottom'){adjust.top=(anchor.top+anchor.height-(height??content.height))-top
top=anchor.top+anchor.height-(height??content.height)}
if(['left','right'].includes(found)&&options.align.startsWith('both')){let minHeight=options.align.split(':')[1]??50
if(anchor.height>=minHeight){top=anchor.top
height=anchor.height}}}
function screenAdjust(){let adjustArrow
if((['left','right'].includes(options.align)&&anchor.width<(width??content.width))||(['top','bottom'].includes(options.align)&&anchor.height<(height??content.height))){adjustArrow=true}
let minLeft=(found=='right'?arrowSize:options.screenMargin)
let minTop=(found=='bottom'?arrowSize:options.screenMargin)
let maxLeft=max.width-(width??content.width)-(found=='left'?arrowSize:options.screenMargin)
let maxTop=max.height-(height??content.height)-(found=='top'?arrowSize:options.screenMargin)+3
if(['top','bottom'].includes(found)||options.autoResize){if(left<minLeft){adjustArrow=true
adjust.left-=left
left=minLeft}
if(left>maxLeft){adjustArrow=true
adjust.left-=left-maxLeft
left+=maxLeft-left}}
if(['left','right'].includes(found)||options.autoResize){if(top<minTop){adjustArrow=true
adjust.top-=top
top=minTop}
if(top>maxTop){adjustArrow=true
adjust.top-=top-maxTop
top+=maxTop-top}}
if(adjustArrow){let aType=isVertical?'left':'top'
let sType=isVertical?'width':'height'
arrow.offset=-adjust[aType]
let maxOffset=content[sType]/2-arrowSize
if(Math.abs(arrow.offset)>maxOffset+arrowSize){arrow.class=''}
if(Math.abs(arrow.offset)>maxOffset){arrow.offset=arrow.offset<0?-maxOffset:maxOffset}
arrow.style=w2utils.stripSpaces(`#${overlay.id} .w2ui-overlay-body:after,
                            #${overlay.id} .w2ui-overlay-body:before {
                                --tip-size: ${arrowSize}px;
                                margin-${aType}: ${arrow.offset}px;
                            }`)}}}}
class ColorTooltip extends Tooltip{constructor(){super()
this.palette=[['000000','333333','555555','777777','888888','999999','AAAAAA','CCCCCC','DDDDDD','EEEEEE','F7F7F7','FFFFFF'],['FF011B','FF9838','FFC300','FFFD59','86FF14','14FF7A','2EFFFC','2693FF','006CE7','9B24F4','FF21F5','FF0099'],['FFEAEA','FCEFE1','FCF4DC','FFFECF','EBFFD9','D9FFE9','E0FFFF','E8F4FF','ECF4FC','EAE6F4','FFF5FE','FCF0F7'],['F4CCCC','FCE5CD','FFF1C2','FFFDA1','D5FCB1','B5F7D0','BFFFFF','D6ECFF','CFE2F3','D9D1E9','FFE3FD','FFD9F0'],['EA9899','F9CB9C','FFE48C','F7F56F','B9F77E','84F0B1','83F7F7','B5DAFF','9FC5E8','B4A7D6','FAB9F6','FFADDE'],['E06666','F6B26B','DEB737','E0DE51','8FDB48','52D189','4EDEDB','76ACE3','6FA8DC','8E7CC3','E07EDA','F26DBD'],['CC0814','E69138','AB8816','B5B20E','6BAB30','27A85F','1BA8A6','3C81C7','3D85C6','674EA7','A14F9D','BF4990'],['99050C','B45F17','80650E','737103','395E14','10783D','13615E','094785','0A5394','351C75','780172','782C5A']]
this.defaults=w2utils.extend({},this.defaults,{advanced:false,transparent:true,position:'top|bottom',class:'w2ui-white',color:'',updateInput:true,arrowSize:12,autoResize:false,anchorClass:'w2ui-focus',autoShowOn:'focus',hideOn:['doc-click','focus-change'],onSelect:null,onLiveUpdate:null})}
attach(anchor,text){let options
if(arguments.length==1&&anchor instanceof Object){options=anchor
anchor=options.anchor}else if(arguments.length===2&&text!=null&&typeof text==='object'){options=text
options.anchor=anchor}
let prevHideOn=options.hideOn
options=w2utils.extend({},this.defaults,options||{})
if(prevHideOn){options.hideOn=prevHideOn}
options.style+='; padding: 0;'
if(options.transparent&&this.palette[0][1]=='333333'){this.palette[0].splice(1,1)
this.palette[0].push('TRANSPARENT')}
if(!options.transparent&&this.palette[0][1]!='333333'){this.palette[0].splice(1,0,'333333')
this.palette[0].pop()}
if(options.color)options.color=String(options.color).toUpperCase()
if(typeof options.color==='string'&&options.color.substr(0,1)==='#')options.color=options.color.substr(1)
this.index=[-1,-1]
let ret=super.attach(options)
let overlay=ret.overlay
overlay.options.html=this.getColorHTML(overlay.name,options)
overlay.on('show.attach',event=>{let overlay=event.detail.overlay
let anchor=overlay.anchor
let options=overlay.options
if(['INPUT','TEXTAREA'].includes(anchor.tagName)&&!options.color&&anchor.value){overlay.tmp.initColor=anchor.value}
delete overlay.newColor})
overlay.on('show:after.attach',event=>{if(ret.overlay?.box){let actions=query(ret.overlay.box).find('.w2ui-eaction')
w2utils.bindEvents(actions,this)
this.initControls(ret.overlay)}})
overlay.on('update:after.attach',event=>{if(ret.overlay?.box){let actions=query(ret.overlay.box).find('.w2ui-eaction')
w2utils.bindEvents(actions,this)
this.initControls(ret.overlay)}})
overlay.on('hide.attach',event=>{let overlay=event.detail.overlay
let anchor=overlay.anchor
let color=overlay.newColor??overlay.options.color??''
if(color!==''){if(['INPUT','TEXTAREA'].includes(anchor.tagName)&&anchor.value!=color&&overlay.options.updateInput){anchor.value=color}
let edata=this.trigger('select',{color,target:overlay.name,overlay})
if(edata.isCancelled===true)return
edata.finish()}})
ret.liveUpdate=(callback)=>{overlay.on('liveUpdate.attach',(event)=>{callback(event)})
return ret}
ret.select=(callback)=>{overlay.on('select.attach',(event)=>{callback(event)})
return ret}
return ret}
select(color,name){let target
this.index=[-1,-1]
if(typeof name!='string'){target=name.target
this.index=query(target).attr('index').split(':')
name=query(target).closest('.w2ui-overlay').attr('name')}
let overlay=this.get(name)
let edata=this.trigger('liveUpdate',{color,target:name,overlay,param:arguments[1]})
if(edata.isCancelled===true)return
if(['INPUT','TEXTAREA'].includes(overlay.anchor.tagName)&&overlay.options.updateInput){query(overlay.anchor).val(color)}
overlay.newColor=color
query(overlay.box).find('.w2ui-color.w2ui-selected').removeClass('w2ui-selected')
if(target){query(target).addClass('w2ui-selected')}
edata.finish()}
nextColor(direction){let pal=this.palette
switch(direction){case'up':this.index[0]--
break
case'down':this.index[0]++
break
case'right':this.index[1]++
break
case'left':this.index[1]--
break}
if(this.index[0]<0)this.index[0]=0
if(this.index[0]>pal.length-2)this.index[0]=pal.length-2
if(this.index[1]<0)this.index[1]=0
if(this.index[1]>pal[0].length-1)this.index[1]=pal[0].length-1
return pal[this.index[0]][this.index[1]]}
tabClick(index,name){if(typeof name!='string'){name=query(name.target).closest('.w2ui-overlay').attr('name')}
let overlay=this.get(name)
let tab=query(overlay.box).find(`.w2ui-color-tab:nth-child(${index})`)
query(overlay.box).find('.w2ui-color-tab').removeClass('w2ui-selected')
query(tab).addClass('w2ui-selected')
query(overlay.box).find('.w2ui-tab-content').hide().closest('.w2ui-colors').find('.tab-'+index).show()}
getColorHTML(name,options){let html=`
            <div class="w2ui-colors">
                <div class="w2ui-tab-content tab-1">`
for(let i=0;i<this.palette.length;i++){html+='<div class="w2ui-color-row">'
for(let j=0;j<this.palette[i].length;j++){let color=this.palette[i][j]
let border=''
if(color==='FFFFFF')border='; border: 1px solid #efefef'
html+=`
                    <div class="w2ui-color w2ui-eaction ${color === 'TRANSPARENT' ? 'w2ui-no-color' : ''} ${options.color == color ? 'w2ui-selected' : ''}"
                        style="background-color: #${color + border};" name="${color}" index="${i}:${j}"
                        data-mousedown="select|'${color}'|event" data-mouseup="hide|${name}">&nbsp;
                    </div>`}
html+='</div>'
if(i<2)html+='<div style="height: 8px"></div>'}
html+='</div>'
html+=`
            <div class="w2ui-tab-content tab-2" style="display: none">
                <div class="color-info">
                    <div class="color-preview-bg"><div class="color-preview"></div><div class="color-original"></div></div>
                    <div class="color-part">
                        <span>H</span> <input class="w2ui-input" name="h" maxlength="3" max="360" tabindex="101">
                        <span>R</span> <input class="w2ui-input" name="r" maxlength="3" max="255" tabindex="104">
                    </div>
                    <div class="color-part">
                        <span>S</span> <input class="w2ui-input" name="s" maxlength="3" max="100" tabindex="102">
                        <span>G</span> <input class="w2ui-input" name="g" maxlength="3" max="255" tabindex="105">
                    </div>
                    <div class="color-part">
                        <span>V</span> <input class="w2ui-input" name="v" maxlength="3" max="100" tabindex="103">
                        <span>B</span> <input class="w2ui-input" name="b" maxlength="3" max="255" tabindex="106">
                    </div>
                    <div class="color-part opacity">
                        <span>${w2utils.lang('Opacity')}</span>
                        <input class="w2ui-input" name="a" maxlength="5" max="1" tabindex="107">
                    </div>
                </div>
                <div class="palette" name="palette">
                    <div class="palette-bg"></div>
                    <div class="value1 move-x move-y"></div>
                </div>
                <div class="rainbow" name="rainbow">
                    <div class="value2 move-x"></div>
                </div>
                <div class="alpha" name="alpha">
                    <div class="alpha-bg"></div>
                    <div class="value2 move-x"></div>
                </div>
            </div>`
html+=`
            <div class="w2ui-color-tabs">
                <div class="w2ui-color-tab w2ui-selected w2ui-eaction" data-click="tabClick|1|event|this"><span class="w2ui-icon w2ui-icon-colors"></span></div>
                <div class="w2ui-color-tab w2ui-eaction" data-click="tabClick|2|event|this"><span class="w2ui-icon w2ui-icon-settings"></span></div>
                <div style="padding: 5px; width: 100%; text-align: right;">
                    ${(typeof options.html == 'string' ? options.html : '')}
                </div>
            </div>`
return html}
initControls(overlay){let initial
let self=this
let options=overlay.options
let color=options.color||overlay.tmp.initColor
let rgb=w2utils.parseColor(color)
if(rgb==null){rgb={r:140,g:150,b:160,a:1}}
let hsv=w2utils.rgb2hsv(rgb)
if(options.advanced===true){this.tabClick(2,overlay.name)}
setColor(hsv,true,color??'')
query(overlay.box).off('.w2color').on('contextmenu.w2color',event=>{event.preventDefault()}).find('input').off('.w2color').on('change.w2color',(event)=>{let el=query(event.target)
let val=parseFloat(el.val())
let max=parseFloat(el.attr('max'))
if(isNaN(val)){val=0
el.val(0)}
if(max>1)val=parseInt(val)
if(max>0&&val>max){el.val(max)
val=max}
if(val<0){el.val(0)
val=0}
let name=el.attr('name')
let color={}
if(['r','g','b','a'].indexOf(name)!==-1){rgb[name]=val
hsv=w2utils.rgb2hsv(rgb)}else if(['h','s','v'].indexOf(name)!==-1){color[name]=val}
setColor(color,true)})
query(overlay.box).find('.color-original').off('.w2color').on('click.w2color',(event)=>{let tmp=w2utils.parseColor(query(event.target).css('background-color'))
if(tmp!=null){rgb=tmp
hsv=w2utils.rgb2hsv(rgb)
setColor(hsv,true)}})
let mDown=`${!w2utils.isMobile ? 'mousedown' : 'touchstart'}.w2color`
let mUp=`${!w2utils.isMobile ? 'mouseup' : 'touchend'}.w2color`
let mMove=`${!w2utils.isMobile ? 'mousemove' : 'touchmove'}.w2color`
query(overlay.box).find('.palette, .rainbow, .alpha').off('.w2color').on(`${mDown}.w2color`,mouseDown)
return
function setColor(color,fullUpdate,initial){if(color.h!=null)hsv.h=color.h
if(color.s!=null)hsv.s=color.s
if(color.v!=null)hsv.v=color.v
if(color.a!=null){rgb.a=color.a;hsv.a=color.a}
rgb=w2utils.hsv2rgb(hsv)
let newColor='rgba('+rgb.r+','+rgb.g+','+rgb.b+','+rgb.a+')'
let cl=[Number(rgb.r).toString(16).toUpperCase(),Number(rgb.g).toString(16).toUpperCase(),Number(rgb.b).toString(16).toUpperCase(),(Math.round(Number(rgb.a)*255)).toString(16).toUpperCase()]
cl.forEach((item,ind)=>{if(item.length===1)cl[ind]='0'+item})
newColor=cl[0]+cl[1]+cl[2]+cl[3]
if(rgb.a===1){newColor=cl[0]+cl[1]+cl[2]}
query(overlay.box).find('.color-preview').css('background-color','#'+newColor)
query(overlay.box).find('input').each(el=>{if(el.name){if(rgb[el.name]!=null)el.value=rgb[el.name]
if(hsv[el.name]!=null)el.value=hsv[el.name]
if(el.name==='a')el.value=rgb.a}})
if(initial!=null){let color=overlay.tmp.initColor||newColor
query(overlay.box).find('.color-original').css('background-color','#'+color)
query(overlay.box).find('.w2ui-color.w2ui-selected').removeClass('w2ui-selected')
query(overlay.box).find(`.w2ui-colors [name="${color}"], .w2ui-colors [name="${initial}"]`).addClass('w2ui-selected')
if(newColor.length==8){self.tabClick(2,overlay.name)}}else{self.select(newColor,overlay.name)}
if(fullUpdate){updateSliders()
refreshPalette()}}
function updateSliders(){let el1=query(overlay.box).find('.palette .value1')
let el2=query(overlay.box).find('.rainbow .value2')
let el3=query(overlay.box).find('.alpha .value2')
if(!el1[0]||!el2[0]||!el3[0])return
let offset1=parseInt(el1[0].clientWidth)/2
let offset2=parseInt(el2[0].clientWidth)/2
el1.css({'left':(hsv.s*150/100-offset1)+'px','top':((100-hsv.v)*125/100-offset1)+'px'})
el2.css('left',(hsv.h/(360/150)-offset2)+'px')
el3.css('left',(rgb.a*150-offset2)+'px')}
function refreshPalette(){let cl=w2utils.hsv2rgb(hsv.h,100,100)
let rgb=`${cl.r},${cl.g},${cl.b}`
query(overlay.box).find('.palette').css('background-image',`linear-gradient(90deg, rgba(${rgb},0) 0%, rgba(${rgb},1) 100%)`)}
function mouseDown(event){let el=query(this).find('.value1, .value2')
let offset=parseInt(el.prop('clientWidth'))/2
if(el.hasClass('move-x'))el.css({left:(event.offsetX-offset)+'px'})
if(el.hasClass('move-y'))el.css({top:(event.offsetY-offset)+'px'})
initial={el:el,x:event.pageX,y:event.pageY,width:el.prop('parentNode').clientWidth,height:el.prop('parentNode').clientHeight,left:parseInt(el.css('left')),top:parseInt(el.css('top'))}
mouseMove(event)
query('html').off('.w2color').on(mMove,mouseMove).on(mUp,mouseUp)}
function mouseUp(event){query('html').off('.w2color')}
function mouseMove(event){let el=initial.el
let divX=event.pageX-initial.x
let divY=event.pageY-initial.y
let newX=initial.left+divX
let newY=initial.top+divY
let offset=parseInt(el.prop('clientWidth'))/2
if(newX<-offset)newX=-offset
if(newY<-offset)newY=-offset
if(newX>initial.width-offset)newX=initial.width-offset
if(newY>initial.height-offset)newY=initial.height-offset
if(el.hasClass('move-x'))el.css({left:newX+'px'})
if(el.hasClass('move-y'))el.css({top:newY+'px'})
let name=query(el.get(0).parentNode).attr('name')
let x=parseInt(el.css('left'))+offset
let y=parseInt(el.css('top'))+offset
if(name==='palette'){setColor({s:Math.round(x/initial.width*100),v:Math.round(100-(y/initial.height*100))})}
if(name==='rainbow'){let h=Math.round(360/150*x)
setColor({h:h})
refreshPalette()}
if(name==='alpha'){setColor({a:parseFloat(Number(x/150).toFixed(2))})}}}}
class MenuTooltip extends Tooltip{constructor(){super()
this.defaults=w2utils.extend({},this.defaults,{type:'normal',items:[],index:null,render:null,spinner:false,msgNoItems:w2utils.lang('No items found'),topHTML:'',menuStyle:'',filter:false,markSearch:false,prefilter:false,match:'contains',search:false,altRows:false,arrowSize:10,align:'left',position:'bottom|top',class:'w2ui-white',anchorClass:'w2ui-focus',autoShowOn:'focus',hideOn:['doc-click','focus-change','select'],onSelect:null,onSubMenu:null,onRemove:null})}
attach(anchor,text){let options
if(arguments.length==1&&anchor instanceof Object){options=anchor
anchor=options.anchor}else if(arguments.length===2&&text!=null&&typeof text==='object'){options=text
options.anchor=anchor}
let prevHideOn=options.hideOn
options=w2utils.extend({},this.defaults,options||{})
if(prevHideOn){options.hideOn=prevHideOn}
options.style+='; padding: 0;'
if(options.items==null){options.items=[]}
if(options.cacheMax<=0){console.log(`The option "cacheMax" is ${options.cacheMax} but should be more than 0`)}
options.items=w2utils.normMenu(options.items)
options.html=this.getMenuHTML(options)
let ret=super.attach(options)
let overlay=ret.overlay
overlay.on('show:after.attach, update:after.attach',event=>{if(ret.overlay?.box){let search=''
overlay.selected=null
if(['INPUT','TEXTAREA'].includes(overlay.anchor.tagName)){search=overlay.anchor.value
overlay.selected=overlay.anchor.dataset.selectedIndex}
let actions=query(ret.overlay.box).find('.w2ui-eaction')
w2utils.bindEvents(actions,this)
this.applyFilter(overlay.name,null,search).then(data=>{if(!Tooltip.active[overlay.name].displayed){return}
overlay.tmp.searchCount=data.count
overlay.tmp.search=data.search
if(options.prefilter){this.refreshSearch(overlay.name)}
this.initControls(ret.overlay)
this.refreshIndex(overlay.name,true)})}})
overlay.next=()=>{let chain=this.getActiveChain(overlay.name)
if(overlay.selected==null||overlay.selected?.length==0){overlay.selected=chain[0]}else{let ind=chain.indexOf(overlay.selected)
if(ind==-1){overlay.selected=chain[0]}
if(ind<chain.length-1){overlay.selected=chain[ind+1]}}
this.refreshIndex(overlay.name)}
overlay.prev=()=>{let chain=this.getActiveChain(overlay.name)
if(overlay.selected==null||overlay.selected?.length==0){overlay.selected=chain[chain.length-1]}else{let ind=chain.indexOf(overlay.selected)
if(ind==-1){overlay.selected=chain[chain.length-1]}
if(ind>0){overlay.selected=chain[ind-1]}}
this.refreshIndex(overlay.name)}
overlay.click=()=>{$(overlay.box).find('.w2ui-selected').click()}
overlay.on('hide:after.attach',event=>{w2tooltip.hide(overlay.name+'-tooltip')})
ret.select=(callback)=>{overlay.on('select.attach',(event)=>{callback(event)})
return ret}
ret.remove=(callback)=>{overlay.on('remove.attach',(event)=>{callback(event)})
return ret}
ret.subMenu=(callback)=>{overlay.on('subMenu.attach',(event)=>{callback(event)})
return ret}
return ret}
update(name,items){let overlay=Tooltip.active[name]
if(overlay){let options=overlay.options
if(options.items!=items){options.items=items}
let menuHTML=this.getMenuHTML(options)
if(options.html!=menuHTML){options.html=menuHTML
overlay.needsUpdate=true
this.show(name)}}else{console.log(`Tooltip "${name}" is not displayed. Cannot update it.`)}}
initControls(overlay){query(overlay.box).find('.w2ui-menu:not(.w2ui-sub-menu)').off('.w2menu').on('contextmenu.w2menu',event=>{event.preventDefault()}).on('mouseDown.w2menu',{delegate:'.w2ui-menu-item'},event=>{let dt=event.delegate.dataset
this.menuDown(overlay,event,dt.index,dt.parents)}).on((w2utils.isMobile?'touchStart':'click')+'.w2menu',{delegate:'.w2ui-menu-item'},event=>{let dt=event.delegate.dataset
this.menuClick(overlay,event,parseInt(dt.index),dt.parents)}).find('.w2ui-menu-item').off('.w2menu').on('mouseEnter.w2menu',event=>{let dt=event.target.dataset
let tooltip=overlay.options.items[dt.index]?.tooltip
if(tooltip){w2tooltip.show({name:overlay.name+'-tooltip',anchor:event.target,html:tooltip,position:'right|left',hideOn:['doc-click']})}
let _menu=query(event.target).closest('.w2ui-menu').get(0)
if(_menu._evt&&_menu._evt.target!=event.target){this.closeSubMenu(_menu._evt)}
if(dt.hassubmenu=='yes'){let _evt={index:parseInt(dt.index),parents:_menu.dataset.parents!==''?_menu.dataset.parents.split('-').map(ind=>parseInt(ind)):[],target:event.target,originalEvent:event,overlay}
_menu._evt=_evt
this.openSubMenu(_evt)}}).on('mouseLeave.w2menu',event=>{w2tooltip.hide(overlay.name+'-tooltip')}).find('.menu-help').off('.w2menu').on('mouseEnter.w2menu',event=>{let dt=event.target.parentNode.parentNode.dataset
let tooltip=overlay.options.items[dt.index]?.help
if(tooltip){w2tooltip.show({name:overlay.name+'-help-tp',anchor:event.target,html:tooltip,position:'right|left',hideOn:['doc-click']})}}).on('mouseLeave.w2menu',event=>{w2tooltip.hide(overlay.name+'-help-tp')})
if(['INPUT','TEXTAREA'].includes(overlay.anchor.tagName)){query(overlay.anchor).off('.w2menu').on('input.w2menu',event=>{}).on('keyup.w2menu',event=>{event._searchType='filter'
this.keyUp(overlay,event)})}
if(overlay.options.search){query(overlay.box).find('#menu-search').off('.w2menu').on('keyup.w2menu',event=>{event._searchType='search'
this.keyUp(overlay,event)})}}
getCurrent(name,id){let overlay=Tooltip.active[name.replace(/[\s\.#]/g,'_')]
let options=overlay.options
let selected=(id?id:overlay.selected??'').split('-')
let last=selected.length-1
let index=selected[last]
let parents=selected.slice(0,selected.length-1).join('-')
index=w2utils.isInt(index)?parseInt(index):0
let items=options.items
selected.forEach((id,ind)=>{if(ind<selected.length-1){items=items[id].items}})
return{last,index,items,item:items[index],parents}}
getMenuHTML(options){if(options.spinner){return`
            <div class="w2ui-menu">
                <div class="w2ui-no-items">
                    <div class="w2ui-spinner"></div>
                    ${w2utils.lang('Loading...')}
                </div>
            </div>`}
let parents=options.parents??[]
let items=options.items
if(!Array.isArray(items))items=[]
let count=0
let icon=null
let topHTML=''
if(options.search){topHTML+=`
                <div class="w2ui-menu-search">
                    <span class="w2ui-icon w2ui-icon-search"></span>
                    <input id="menu-search" class="w2ui-input" type="text"/>
                </div>`
items.forEach(item=>item.hidden=false)}
if(options.topHTML){topHTML+=`<div class="w2ui-menu-top">${options.topHTML}</div>`}
let menu_html=`
            ${topHTML}
            <div class="w2ui-menu" style="${options.menuStyle}" data-parents="${parents.join('-')}">
        `
items.forEach((mitem,f)=>{icon=mitem.icon
let index=(parents.length>0?parents.join('-')+'-':'')+f
if(icon==null)icon=null
if(['radio','check'].indexOf(options.type)!=-1&&!Array.isArray(mitem.items)&&mitem.group!==false){if(mitem.checked===true)icon='w2ui-icon-check';else icon='w2ui-icon-empty'}
if(mitem.hidden!==true){let txt=mitem.text
let icon_dsp=''
if(typeof options.render==='function')txt=options.render(mitem,options)
if(typeof txt=='function')txt=txt(mitem,options)
if(icon){if(String(icon).slice(0,1)!=='<'){icon=`<span class="w2ui-icon ${icon}"></span>`}
icon_dsp=`<div class="menu-icon">${icon}</span></div>`}
if(mitem.removable==null&&mitem.remove!=null){mitem.removable=mitem.remove}
if(mitem.type!=='break'&&txt!=null&&txt!==''&&String(txt).substr(0,2)!='--'){let classes=['w2ui-menu-item']
if(options.altRows==true){classes.push(count%2===0?'w2ui-even':'w2ui-odd')}
let colspan=1
if(icon_dsp==='')colspan++
if(mitem.count==null&&mitem.hotkey==null&&mitem.removable!==true&&mitem.items==null)colspan++
if(mitem.tooltip==null&&mitem.hint!=null)mitem.tooltip=mitem.hint
let count_dsp=''
if(mitem.removable===true){count_dsp='<span class="menu-remove">x</span>'}else if(mitem.items!=null){classes.push('has-sub-menu')
count_dsp='<span style="background-color: transparent; border: transparent; box-shadow: none;"></span>'}else{if(mitem.count!=null)count_dsp+='<span>'+mitem.count+'</span>'
if(mitem.hotkey!=null)count_dsp+='<span class="menu-hotkey">'+mitem.hotkey+'</span>'
if(mitem.help!=null)count_dsp+='<span class="menu-help">?</span>'}
if(mitem.disabled===true)classes.push('w2ui-disabled')
if(mitem._noSearchInside===true)classes.push('w2ui-no-search-inside')
menu_html+=`
                        <div index="${index}" class="${classes.join(' ')}" style="${mitem.style ? mitem.style : ''}"
                            data-index="${f}" data-hasSubmenu="${mitem.items != null ? 'yes' : ''}">
                                <div style="width: ${parseInt(mitem.indent ?? 0)}px"></div>
                                ${icon_dsp}
                                <div class="menu-text" colspan="${colspan}">${w2utils.lang(txt)}</div>
                                <div class="menu-extra">${count_dsp}</div>
                        </div>`
count++}else{let divText=(txt??'').replace(/^-+/g,'')
menu_html+=`
                        <div index="${index}" class="w2ui-menu-divider ${divText != '' ? 'has-text' : ''}">
                            <div class="line"></div>
                            ${divText ? `<div class="text">${divText}</div>` : ''}
                        </div>`}}
items[f]=mitem})
if(count===0&&options.msgNoItems){let overlay=Tooltip.active[options.name.replace(/[\s\.#]/g,'_')]
let remote=overlay?.tmp.remote
let msg=options.msgNoItems
if(options.url){if(count==0&&remote?.hasMore===false){msg=options.msgNoItems}else{msg=options.msgSearch}}
menu_html+=`
                <div class="w2ui-no-items">
                    ${w2utils.lang(msg)}
                </div>`}
menu_html+='</div>'
return menu_html}
openSubMenu(event){let anchor=query(event.originalEvent.target).get(0)
let{overlay}=event
let{items}=overlay.options
let mitem=items[event.index]
let _items=[]
if(typeof mitem.items=='function'){_items=mitem.items(mitem)}else if(Array.isArray(mitem.items)){_items=mitem.items}
let prev=w2menu.get(overlay.name+'-submenu')
if(prev){prev.hide()}
query(event.target).addClass('expanded')
w2menu.show({name:overlay.name+'-submenu',anchor:anchor,items:_items,class:overlay.options.class,offsetX:-7,arrowSize:0,parentOverlay:overlay,parents:[...event.parents,event.index],position:'right|left',hideOn:['doc-click']}).hide(evt=>{query(event.target).removeClass('expanded')}).select(evt=>{let parents=evt.detail.overlay.options.parents
let _overlay=overlay
while(_overlay.options.parentOverlay){_overlay=_overlay.options.parentOverlay}
this.menuClick(_overlay,evt.detail.originalEvent,parseInt(evt.detail.index),parents)})
setTimeout(()=>{query('#w2overlay-'+overlay.name+'-submenu').on('mouseenter',event=>{event.target._keepSubOpen=true}).on('mouseleave',event=>{event.target._keepSubOpen=false})},10)}
closeSubMenu(event){let{overlay}=event
if(event.target._keepSubOpen!==true){let prev=w2menu.get(overlay.name+'-submenu')
if(prev){prev.hide()}}}
refreshIndex(name,instant){let overlay=Tooltip.active[name.replace(/[\s\.#]/g,'_')]
if(!overlay)return
if(!overlay.displayed){this.show(overlay.name)}
let view=query(overlay.box).find('.w2ui-overlay-body').get(0)
let search=query(overlay.box).find('.w2ui-menu-search, .w2ui-menu-top').get(0)
query(overlay.box).find('.w2ui-menu-item.w2ui-selected').removeClass('w2ui-selected')
let el=query(overlay.box).find(`.w2ui-menu-item[index="${overlay.selected}"]`).addClass('w2ui-selected').get(0)
if(el){if(el.offsetTop+el.clientHeight>view.clientHeight+view.scrollTop){el.scrollIntoView({behavior:instant?'instant':'smooth',block:instant?'center':'start',inline:instant?'center':'start'})}
if(el.offsetTop<view.scrollTop+(search?search.clientHeight:0)){el.scrollIntoView({behavior:instant?'instant':'smooth',block:instant?'center':'end',inline:instant?'center':'end'})}}}
refreshSearch(name){let overlay=Tooltip.active[name.replace(/[\s\.#]/g,'_')]
if(!overlay)return
if(!overlay.displayed){this.show(overlay.name)}
query(overlay.box).find('.w2ui-no-items').hide()
query(overlay.box).find('.w2ui-menu-item, .w2ui-menu-divider').each(el=>{let cur=this.getCurrent(name,el.getAttribute('index'))
if(cur.item?.hidden){query(el).hide()}else{let search=overlay.tmp?.search
if(overlay.options.markSearch){w2utils.marker(el,search,{onlyFirst:overlay.options.match=='begins'})}
query(el).show()}})
query(overlay.box).find('.w2ui-sub-menu').each(sub=>{let hasItems=query(sub).find('.w2ui-menu-item').get().some(el=>{return el.style.display!='none'?true:false})
let parent=this.getCurrent(name,sub.dataset.parent)
if(parent.item.expanded){if(!hasItems){query(sub).parent().hide()}else{query(sub).parent().show()}}})
if(overlay.tmp.searchCount==0||overlay.options?.items?.length==0){if(query(overlay.box).find('.w2ui-no-items').length==0){query(overlay.box).find('.w2ui-menu:not(.w2ui-sub-menu)').append(`
                    <div class="w2ui-no-items">
                        ${w2utils.lang(overlay.options.msgNoItems)}
                    </div>`)}
query(overlay.box).find('.w2ui-no-items').show()}}
applyFilter(name,items,search,debounce){let count=0
let overlay=Tooltip.active[name.replace(/[\s\.#]/g,'_')]
let options=overlay.options
let resolve,reject
let prom=new Promise((res,rej)=>{resolve=res
reject=rej})
if(search==null){if(['INPUT','TEXTAREA'].includes(overlay.anchor.tagName)){search=overlay.anchor.value}else{search=''}}
let selectedIds=[]
if(options.selected){if(Array.isArray(options.selected)){selectedIds=options.selected.map(item=>{return item?.id??item})}else if(options.selected?.id){selectedIds=[options.selected.id]}}
overlay.tmp.activeChain=null
let remote=overlay.tmp.remote??{hasMore:true,emptySet:false,search:null,cached:-1}
if(remote.hasMore==false){let len=remote.hasMore_search.length
if(search.substr(0,len)!=remote.hasMore_search){remote.hasMore=true}}
if(items==null&&options.url&&remote.hasMore&&remote.search!==search){let proceed=true
let msg=w2utils.lang('Loading...')
if(search.length<options.minLength&&remote.emptySet!==true){msg=w2utils.lang('${count} letters or more...',{count:options.minLength})
proceed=false
if(search===''){msg=w2utils.lang(options.msgSearch)}
if(options.items?.length>0){this.update(name,[])
this.applyFilter(name,null,search)}}
query(overlay.box).find('.w2ui-no-items').html(msg)
remote.search=search
options.items=[]
overlay.tmp.remote=remote
if(proceed){this.request(overlay,search,debounce).then(remoteItems=>{this.update(name,remoteItems)
this.applyFilter(name,null,search).then(data=>{resolve(data)})}).catch(error=>{console.log('Server Request error',error)})}
return prom}
let edata
if(items==null){edata=this.trigger('search',{search,overlay,prom,resolve,reject})
if(edata.isCancelled===true){return prom}}
if(items==null){items=overlay.options.items}
if(options.filter===false){resolve({count:-1,search})
return prom}
items.forEach(item=>{let prefix=''
let suffix=''
if(['is','begins','begins with'].indexOf(options.match)!==-1)prefix='^'
if(['is','ends','ends with'].indexOf(options.match)!==-1)suffix='$'
try{let re=new RegExp(prefix+search+suffix,'i')
if(re.test(item.text)||item.text==='...'){item.hidden=false}else{item.hidden=true}}catch(e){}
if(options.hideSelected&&selectedIds.includes(item.id)){item.hidden=true}
if(Array.isArray(item.items)&&item.items.length>0){delete item._noSearchInside
this.applyFilter(name,item.items,search).then(data=>{let subCount=data.count
if(subCount>0){count+=subCount
if(item.hidden)item._noSearchInside=true
if(search)item.expanded=true
item.hidden=false}})}
if(item.hidden!==true)count++})
resolve({count,search})
edata?.finish()
return prom}
request(overlay,search,debounce){let options=overlay.options
let remote=overlay.tmp.remote
let resolve,reject
if((options.items.length===0&&remote.cached!==0)||(remote.cached==options.cacheMax&&search.length>remote.search.length)||(search.length>=remote.search.length&&search.substr(0,remote.search.length)!==remote.search)||(search.length<remote.search.length))
{if(remote.controller){remote.controller.abort()}
remote.loading=true
clearTimeout(remote.timeout)
remote.timeout=setTimeout(()=>{let url=options.url
let postData={search,max:options.cacheMax}
Object.assign(postData,options.postData)
let edata=this.trigger('request',{search,overlay,url,postData,httpMethod:options.method??'GET',httpHeaders:{}})
if(edata.isCancelled===true)return
url=new URL(edata.detail.url,location)
let fetchOptions=w2utils.prepareParams(url,{method:edata.detail.httpMethod,headers:edata.detail.httpHeaders,body:edata.detail.postData})
remote.controller=new AbortController()
fetchOptions.signal=remote.controller.signal
fetch(url,fetchOptions).then(resp=>resp.json()).then(data=>{remote.controller=null
let edata=overlay.trigger('load',{search:postData.search,overlay,data})
if(edata.isCancelled===true)return
data=edata.detail.data
if(typeof data==='string')data=JSON.parse(data)
if(Array.isArray(data)){data={records:data}}
if(data.records==null&&data.items!=null){data.records=data.items
delete data.items}
if(!data.error&&data.records==null){data.records=[]}
if(!Array.isArray(data.records)){console.error('ERROR: server did not return proper data structure','\n',' - it should return',{records:[{id:1,text:'item'}]},'\n',' - or just an array ',[{id:1,text:'item'}],'\n',' - or if errorr ',{error:true,message:'error message'})
return}
if(data.records.length>=options.cacheMax){data.records.splice(options.cacheMax,data.records.length)
remote.hasMore=true}else{remote.hasMore=false
remote.hasMore_search=search}
if(options.recId==null&&options.recid!=null)options.recId=options.recid
if(options.recId||options.recText){data.records.forEach((item)=>{if(typeof options.recId==='string')item.id=item[options.recId]
if(typeof options.recId==='function')item.id=options.recId(item)
if(typeof options.recText==='string')item.text=item[options.recText]
if(typeof options.recText==='function')item.text=options.recText(item)})}
remote.loading=false
remote.search=search
remote.cached=data.records.length==0?-1:data.records.length
remote.lastError=''
remote.emptySet=(search===''&&data.records.length===0?true:false)
edata.finish()
resolve(w2utils.normMenu(data.records))}).catch(error=>{let edata=this.trigger('error',{overlay,search,error})
if(edata.isCancelled===true)return
if(error?.name!=='AbortError'){console.error('ERROR: Server communication failed.','\n',' - it should return',{records:[{id:1,text:'item'}]},'\n',' - or just an array ',[{id:1,text:'item'}],'\n',' - or if errorr ',{error:true,message:'error message'})}
remote.loading=false
remote.search=''
remote.cached=-1
remote.emptySet=true
remote.lastError=(edata.detail.error||'Server communication failed')
options.items=[]
edata.finish()
reject()})
edata.finish()},debounce?(options.debounce??350):0)}
return new Promise((res,rej)=>{resolve=res
reject=rej})}
getActiveChain(name,items,parents=[],res=[],noSave){let overlay=Tooltip.active[name.replace(/[\s\.#]/g,'_')]
if(overlay.tmp.activeChain!=null){return overlay.tmp.activeChain}
if(items==null)items=overlay.options.items
items.forEach((item,ind)=>{if(!item.hidden&&!item.disabled&&!item?.text?.startsWith('--')){res.push(parents.concat([ind]).join('-'))
if(Array.isArray(item.items)&&item.items.length>0&&item.expanded){parents.push(ind)
this.getActiveChain(name,item.items,parents,res,true)
parents.pop()}}})
if(noSave==null){overlay.tmp.activeChain=res}
return res}
menuDown(overlay,event,index,parents){let options=overlay.options
let items=options.items
let icon=query(event.delegate).find('.w2ui-icon')
let menu=query(event.target).closest('.w2ui-menu:not(.w2ui-sub-menu)')
if(typeof parents=='string'&&parents!==''){let ids=parents.split('-')
ids.forEach(id=>{items=items[id].items})}
if(typeof items=='function'){items=items({overlay,index,parents,event})}
let item=items[index]
if(item==null||item.disabled){return}
let uncheck=(items,parent)=>{items.forEach((other,ind)=>{if(other.id==item.id)return
if(other.group===item.group&&other.checked){menu.find(`.w2ui-menu-item[index="${(parent ? parent + '-' : '') + ind}"] .w2ui-icon`).removeClass('w2ui-icon-check').addClass('w2ui-icon-empty')
items[ind].checked=false}
if(Array.isArray(other.items)){uncheck(other.items,ind)}})}
if((options.type==='check'||options.type==='radio')&&item.group!==false&&!query(event.target).hasClass('menu-remove')&&!query(event.target).hasClass('menu-help')&&!query(event.target).closest('.w2ui-menu-item').hasClass('has-sub-menu')){item.checked=options.type=='radio'?true:!item.checked
if(item.checked){if(options.type==='radio'){query(event.target).closest('.w2ui-menu').find('.w2ui-icon').removeClass('w2ui-icon-check').addClass('w2ui-icon-empty')}
if(options.type==='check'&&item.group!=null){uncheck(options.items)}
icon.removeClass('w2ui-icon-empty').addClass('w2ui-icon-check')}else if(options.type==='check'){icon.removeClass('w2ui-icon-check').addClass('w2ui-icon-empty')}}
if(!query(event.target).hasClass('menu-remove')&&!query(event.target).hasClass('menu-help')){menu.find('.w2ui-menu-item').removeClass('w2ui-selected')
if(!query(event.delegate).hasClass('has-sub-menu')){query(event.delegate).addClass('w2ui-selected')}}}
menuClick(overlay,event,index,parents){let options=overlay.options
let items=options.items
let $item=query(event.delegate).closest('.w2ui-menu-item')
let keepOpen=options.hideOn.includes('select')?false:true
if(event.shiftKey||event.metaKey||event.ctrlKey){keepOpen=true}
if(typeof parents=='string'&&parents!==''){parents=parents.split('-')}else if(!Array.isArray(parents)){parents=null}
if(parents){parents.forEach(id=>{items=items[id].items})}
if(typeof items=='function'){items=items({overlay,index,parents,event})}
let item=items[index]
if(!item||(item.disabled&&!query(event.target).hasClass('menu-remove'))){return}
let edata
if(query(event.target).hasClass('menu-remove')){edata=this.trigger('remove',{originalEvent:event,target:overlay.name,overlay,item,index,parents,el:$item[0]})
if(edata.isCancelled===true){return}
keepOpen=!options.hideOn.includes('item-remove')
$item.remove()}else if($item.hasClass('has-sub-menu')){edata=this.trigger('subMenu',{originalEvent:event,target:overlay.name,overlay,item,index,parents,el:$item[0]})
if(edata.isCancelled===true){return}
keepOpen=true}else{let selected=this.findChecked(options.items)
overlay.selected=parseInt($item.attr('index'))
edata=this.trigger('select',{originalEvent:event,target:overlay.name,overlay,item,index,parents,selected,keepOpen,el:$item[0]})
if(edata.isCancelled===true){return}
if(item.keepOpen!=null){keepOpen=item.keepOpen}
if(['INPUT','TEXTAREA'].includes(overlay.anchor.tagName)){overlay.anchor.dataset.selected=item.id
overlay.anchor.dataset.selectedIndex=overlay.selected}}
if(!keepOpen){this.hide(overlay.name)}
edata.finish()}
findChecked(items){let found=[]
items.forEach(item=>{if(item.checked)found.push(item)
if(Array.isArray(item.items)){found=found.concat(this.findChecked(item.items))}})
return found}
keyUp(overlay,event){let options=overlay.options
let search=event.target.value
let filter=true
let refreshIndex=false
switch(event.keyCode){case 46:case 8:{if(search===''&&!overlay.displayed)filter=false
break}
case 13:{if(!overlay.displayed||!overlay.selected)return
let{index,parents}=this.getCurrent(overlay.name)
event.delegate=query(overlay.box).find('.w2ui-selected').get(0)
this.menuClick(overlay,event,parseInt(index),parents)
filter=false
break}
case 27:{filter=false
if(overlay.displayed){this.hide(overlay.name)}else{let el=overlay.anchor
if(['INPUT','TEXTAREA'].includes(el.tagName)){el.value=''
delete el.dataset.selected
delete el.dataset.selectedIndex}}
break}
case 37:{if(!overlay.displayed)return
let{item,index,parents}=this.getCurrent(overlay.name)
if(parents){item=options.items[parents]
index=parseInt(parents)
parents=''
refreshIndex=true}
if(Array.isArray(item?.items)&&item.items.length>0&&item.expanded){event.delegate=query(overlay.box).find(`.w2ui-menu-item[index="${index}"]`).get(0)
overlay.selected=index
this.menuClick(overlay,event,parseInt(index),parents)}
filter=false
break}
case 39:{if(!overlay.displayed)return
let{item,index,parents}=this.getCurrent(overlay.name)
if(Array.isArray(item?.items)&&item.items.length>0&&!item.expanded){event.delegate=query(overlay.box).find('.w2ui-selected').get(0)
this.menuClick(overlay,event,parseInt(index),parents)}
filter=false
break}
case 38:{if(!overlay.displayed){break}
overlay.prev()
filter=false
event.preventDefault()
break}
case 40:{if(!overlay.displayed){break}
overlay.next()
filter=false
event.preventDefault()
break}}
if(filter&&overlay.displayed&&((options.filter&&event._searchType=='filter')||(options.search&&event._searchType=='search'))){this.applyFilter(overlay.name,null,search,true).then(data=>{overlay.tmp.searchCount=data.count
overlay.tmp.search=data.search
if(data.count===0||!this.getActiveChain(overlay.name).includes(overlay.selected)){overlay.selected=null}
this.refreshSearch(overlay.name)})}
if(refreshIndex){this.refreshIndex(overlay.name)}}}
class DateTooltip extends Tooltip{constructor(){super()
let td=new Date()
this.daysCount=[31,28,31,30,31,30,31,31,30,31,30,31]
this.today=td.getFullYear()+'/'+(Number(td.getMonth())+1)+'/'+td.getDate()
this.defaults=w2utils.extend({},this.defaults,{position:'top|bottom',class:'w2ui-calendar',type:'date',value:'',format:'',start:null,end:null,btnNow:false,blockDates:[],blockWeekdays:[],colored:{},arrowSize:12,autoResize:false,anchorClass:'w2ui-focus',autoShowOn:'focus',hideOn:['doc-click','focus-change'],onSelect:null})}
attach(anchor,text){let options
if(arguments.length==1&&anchor instanceof Object){options=anchor
anchor=options.anchor}else if(arguments.length===2&&text!=null&&typeof text==='object'){options=text
options.anchor=anchor}
let prevHideOn=options.hideOn
options=w2utils.extend({},this.defaults,options||{})
if(prevHideOn){options.hideOn=prevHideOn}
if(!options.format){let df=w2utils.settings.dateFormat
let tf=w2utils.settings.timeFormat
if(options.type=='date'){options.format=df}else if(options.type=='time'){options.format=tf}else{options.format=df+'|'+tf}}
let cal=options.type=='time'?this.getHourHTML(options):this.getMonthHTML(options)
options.style+='; padding: 0;'
options.html=cal.html
let ret=super.attach(options)
let overlay=ret.overlay
Object.assign(overlay.tmp,cal)
overlay.on('show.attach',event=>{let overlay=event.detail.overlay
let anchor=overlay.anchor
let options=overlay.options
if(['INPUT','TEXTAREA'].includes(anchor.tagName)&&!options.value&&anchor.value){overlay.tmp.initValue=anchor.value}
delete overlay.newValue
delete overlay.newDate})
overlay.on('show:after.attach',event=>{if(ret.overlay?.box){this.initControls(ret.overlay)}})
overlay.on('update:after.attach',event=>{if(ret.overlay?.box){this.initControls(ret.overlay)}})
overlay.on('hide.attach',event=>{let overlay=event.detail.overlay
let anchor=overlay.anchor
if(overlay.newValue!=null){if(overlay.newDate){overlay.newValue=overlay.newDate+' '+overlay.newValue}
if(['INPUT','TEXTAREA'].includes(anchor.tagName)&&anchor.value!=overlay.newValue){anchor.value=overlay.newValue}
let edata=this.trigger('select',{date:overlay.newValue,target:overlay.name,overlay})
if(edata.isCancelled===true)return
edata.finish()}})
ret.select=(callback)=>{overlay.on('select.attach',(event)=>{callback(event)})
return ret}
return ret}
initControls(overlay){let options=overlay.options
let moveMonth=(inc)=>{let{month,year}=overlay.tmp
month+=inc
if(month>12){month=1
year++}
if(month<1){month=12
year--}
let cal=this.getMonthHTML(options,month,year)
Object.assign(overlay.tmp,cal)
query(overlay.box).find('.w2ui-overlay-body').html(cal.html)
this.initControls(overlay)}
let checkJump=(event,dblclick)=>{query(event.target).parent().find('.w2ui-jump-month, .w2ui-jump-year').removeClass('w2ui-selected')
query(event.target).addClass('w2ui-selected')
let dt=new Date()
let{jumpMonth,jumpYear}=overlay.tmp
if(dblclick){if(jumpYear==null)jumpYear=dt.getFullYear()
if(jumpMonth==null)jumpMonth=dt.getMonth()+1}
if(jumpMonth&&jumpYear){let cal=this.getMonthHTML(options,jumpMonth,jumpYear)
Object.assign(overlay.tmp,cal)
query(overlay.box).find('.w2ui-overlay-body').html(cal.html)
overlay.tmp.jump=false
this.initControls(overlay)}}
query(overlay.box).find('.w2ui-cal-title').off('.calendar').on('click.calendar',event=>{Object.assign(overlay.tmp,{jumpYear:null,jumpMonth:null})
if(overlay.tmp.jump){let{month,year}=overlay.tmp
let cal=this.getMonthHTML(options,month,year)
query(overlay.box).find('.w2ui-overlay-body').html(cal.html)
overlay.tmp.jump=false}else{query(overlay.box).find('.w2ui-overlay-body .w2ui-cal-days').replace(this.getYearHTML())
let el=query(overlay.box).find(`[name="${overlay.tmp.year}"]`).get(0)
if(el)el.scrollIntoView(true)
overlay.tmp.jump=true}
this.initControls(overlay)
event.stopPropagation()}).find('.w2ui-cal-previous').off('.calendar').on('click.calendar',event=>{moveMonth(-1)
event.stopPropagation()}).parent().find('.w2ui-cal-next').off('.calendar').on('click.calendar',event=>{moveMonth(1)
event.stopPropagation()})
query(overlay.box).find('.w2ui-cal-now').off('.calendar').on('click.calendar',event=>{if(options.type=='datetime'){if(overlay.newDate){overlay.newValue=w2utils.formatTime(new Date(),options.format.split('|')[1])}else{overlay.newValue=w2utils.formatDateTime(new Date(),options.format)}}else if(options.type=='date'){overlay.newValue=w2utils.formatDate(new Date(),options.format)}else if(options.type=='time'){overlay.newValue=w2utils.formatTime(new Date(),options.format)}
this.hide(overlay.name)})
query(overlay.box).off('.calendar').on('contextmenu.calendar',event=>{event.preventDefault()}).on('click.calendar',{delegate:'.w2ui-day.w2ui-date'},event=>{if(options.type=='datetime'){overlay.newDate=query(event.target).attr('date')
query(overlay.box).find('.w2ui-overlay-body').html(this.getHourHTML(overlay.options).html)
this.initControls(overlay)}else{overlay.newValue=query(event.target).attr('date')
this.hide(overlay.name)}}).on('click.calendar',{delegate:'.w2ui-jump-month'},event=>{overlay.tmp.jumpMonth=parseInt(query(event.target).attr('name'))
checkJump(event)}).on('dblclick.calendar',{delegate:'.w2ui-jump-month'},event=>{overlay.tmp.jumpMonth=parseInt(query(event.target).attr('name'))
checkJump(event,true)}).on('click.calendar',{delegate:'.w2ui-jump-year'},event=>{overlay.tmp.jumpYear=parseInt(query(event.target).attr('name'))
checkJump(event)}).on('dblclick.calendar',{delegate:'.w2ui-jump-year'},event=>{overlay.tmp.jumpYear=parseInt(query(event.target).attr('name'))
checkJump(event,true)}).on('click.calendar',{delegate:'.w2ui-time.hour'},event=>{let hour=query(event.target).attr('hour')
let min=this.str2min(options.value)%60
if(overlay.tmp.initValue&&!options.value){min=this.str2min(overlay.tmp.initValue)%60}
if(options.noMinutes){overlay.newValue=this.min2str(hour*60,options.format)
this.hide(overlay.name)}else{overlay.newValue=hour+':'+min
let html=this.getMinHTML(hour,options).html
query(overlay.box).find('.w2ui-overlay-body').html(html)
this.initControls(overlay)}}).on('click.calendar',{delegate:'.w2ui-time.min'},event=>{let hour=Math.floor(this.str2min(overlay.newValue)/60)
let time=(hour*60)+parseInt(query(event.target).attr('min'))
overlay.newValue=this.min2str(time,options.format)
this.hide(overlay.name)})}
getMonthHTML(options,month,year){let days=w2utils.settings.fulldays.slice()
let sdays=w2utils.settings.shortdays.slice()
if(w2utils.settings.weekStarts!=='M'){days.unshift(days.pop())
sdays.unshift(sdays.pop())}
let td=new Date()
let dayLengthMil=1000*60*60*24
let selected=options.type==='datetime'?w2utils.isDateTime(options.value,options.format,true):w2utils.isDate(options.value,options.format,true)
let selected_dsp=w2utils.formatDate(selected)
if(month==null||year==null){year=selected?selected.getFullYear():td.getFullYear()
month=selected?selected.getMonth()+1:td.getMonth()+1}
if(month>12){month-=12;year++}
if(month<1||month===0){month+=12;year--}
if(year/4==Math.floor(year/4)){this.daysCount[1]=29}else{this.daysCount[1]=28}
options.current=month+'/'+year
td=new Date(year,month-1,1)
let weekDay=td.getDay()
let weekDays=''
let st=w2utils.settings.weekStarts
for(let i=0;i<sdays.length;i++){let isSat=(st=='M'&&i==5)||(st!='M'&&i==6)?true:false
let isSun=(st=='M'&&i==6)||(st!='M'&&i==0)?true:false
weekDays+=`<div class="w2ui-day w2ui-weekday ${isSat ? 'w2ui-sunday' : ''} ${isSun ? 'w2ui-saturday' : ''}">${sdays[i]}</div>`}
let html=`
            <div class="w2ui-cal-title">
                <div class="w2ui-cal-previous">
                    <div></div>
                </div>
                <div class="w2ui-cal-next">
                    <div></div>
                </div>
                ${w2utils.settings.fullmonths[month-1]}, ${year}
                <span class="arrow-down"></span>
            </div>
            <div class="w2ui-cal-days">
                ${weekDays}
        `
let DT=new Date(`${year}/${month}/1`)
DT=new Date(DT.getTime()+dayLengthMil*0.5)
let weekday=DT.getDay()
if(w2utils.settings.weekStarts=='M')weekDay--
let DaySat=6
let DaySun=0
if(weekday>0){DT=new Date(DT.getTime()-(weekDay*dayLengthMil))}else{DaySat=DaySat+weekDay
DaySun=DaySun+weekDay
if(DaySat<0)DaySat=6+DaySat+1
if(DaySun<0)DaySun=6+DaySun+1}
for(let ci=0;ci<42;ci++){let className=[]
let dt=`${DT.getFullYear()}/${DT.getMonth()+1}/${DT.getDate()}`
if(DT.getDay()===DaySat)className.push('w2ui-saturday')
if(DT.getDay()===DaySun)className.push('w2ui-sunday')
if(DT.getMonth()+1!==month)className.push('outside')
if(dt==this.today)className.push('w2ui-today')
let dspDay=DT.getDate()
let col=''
let bgcol=''
let tmp_dt,tmp_dt_fmt
if(options.type==='datetime'){tmp_dt=w2utils.formatDateTime(dt,options.format)
tmp_dt_fmt=w2utils.formatDate(dt,w2utils.settings.dateFormat)}else{tmp_dt=w2utils.formatDate(dt,options.format)
tmp_dt_fmt=tmp_dt}
if(options.colored&&options.colored[tmp_dt_fmt]!==undefined){let tmp=options.colored[tmp_dt_fmt].split('|')
bgcol='background-color: '+tmp[0]+';'
col='color: '+tmp[1]+';'}
html+=`<div class="w2ui-day ${this.inRange(tmp_dt, options, true)
                            ? 'w2ui-date ' + (tmp_dt_fmt == selected_dsp ? 'w2ui-selected' : '')
                            : 'w2ui-blocked'
                        } ${className.join(' ')}"
                       style="${col + bgcol}" date="${tmp_dt_fmt}" data-date="${DT.getTime()}">
                            ${dspDay}
                    </div>`
DT=new Date(DT.getTime()+dayLengthMil)}
html+='</div>'
if(options.btnNow){let label=w2utils.lang('Today'+(options.type=='datetime'?' & Now':''))
html+=`<div class="w2ui-cal-now">${label}</div>`}
return{html,month,year}}
getYearHTML(){let mhtml=''
let yhtml=''
for(let m=0;m<w2utils.settings.fullmonths.length;m++){mhtml+=`<div class="w2ui-jump-month" name="${m+1}">${w2utils.settings.shortmonths[m]}</div>`}
for(let y=w2utils.settings.dateStartYear;y<=w2utils.settings.dateEndYear;y++){yhtml+=`<div class="w2ui-jump-year" name="${y}">${y}</div>`}
return`<div class="w2ui-cal-jump">
            <div id="w2ui-jump-month">${mhtml}</div>
            <div id="w2ui-jump-year">${yhtml}</div>
        </div>`}
getHourHTML(options){options=options??{}
if(!options.format)options.format=w2utils.settings.timeFormat
let h24=(options.format.indexOf('h24')>-1)
let value=options.value?options.value:(options.anchor?options.anchor.value:'')
let tmp=[]
for(let a=0;a<24;a++){let time=(a>=12&&!h24?a-12:a)+':00'+(!h24?(a<12?' am':' pm'):'')
if(a==12&&!h24)time='12:00 pm'
if(!tmp[Math.floor(a/8)])tmp[Math.floor(a/8)]=''
let tm1=this.min2str(this.str2min(time))
let tm2=this.min2str(this.str2min(time)+59)
if(options.type==='datetime'){let dt=w2utils.isDateTime(value,options.format,true)
let fm=options.format.split('|')[0].trim()
tm1=w2utils.formatDate(dt,fm)+' '+tm1
tm2=w2utils.formatDate(dt,fm)+' '+tm2}
let valid=this.inRange(tm1,options)||this.inRange(tm2,options)
tmp[Math.floor(a/8)]+=`<span hour="${a}"
                class="hour ${valid ? 'w2ui-time ' : 'w2ui-blocked'}">${time}</span>`}
let html=`<div class="w2ui-calendar">
            <div class="w2ui-time-title">${w2utils.lang('Select Hour')}</div>
            <div class="w2ui-cal-time">
                <div class="w2ui-cal-column">${tmp[0]}</div>
                <div class="w2ui-cal-column">${tmp[1]}</div>
                <div class="w2ui-cal-column">${tmp[2]}</div>
            </div>
            ${options.btnNow ? `<div class="w2ui-cal-now">${w2utils.lang('Now')}</div>` : '' }
        </div>`
return{html}}
getMinHTML(hour,options){if(hour==null)hour=0
options=options??{}
if(!options.format)options.format=w2utils.settings.timeFormat
let h24=(options.format.indexOf('h24')>-1)
let value=options.value?options.value:(options.anchor?options.anchor.value:'')
let tmp=[]
for(let a=0;a<60;a+=5){let time=(hour>12&&!h24?hour-12:hour)+':'+(a<10?0:'')+a+' '+(!h24?(hour<12?'am':'pm'):'')
let tm=time
let ind=a<20?0:(a<40?1:2)
if(!tmp[ind])tmp[ind]=''
if(options.type==='datetime'){let dt=w2utils.isDateTime(value,options.format,true)
let fm=options.format.split('|')[0].trim()
tm=w2utils.formatDate(dt,fm)+' '+tm}
tmp[ind]+=`<span min="${a}" class="min ${(this.inRange(tm, options) ? 'w2ui-time ' : 'w2ui-blocked')}">${time}</span>`}
let html=`<div class="w2ui-calendar">
            <div class="w2ui-time-title">${w2utils.lang('Select Minute')}</div>
            <div class="w2ui-cal-time">
                <div class="w2ui-cal-column">${tmp[0]}</div>
                <div class="w2ui-cal-column">${tmp[1]}</div>
                <div class="w2ui-cal-column">${tmp[2]}</div>
            </div>
            ${options.btnNow ? `<div class="w2ui-cal-now">${w2utils.lang('Now')}</div>` : '' }
        </div>`
return{html}}
inRange(str,options,dateOnly){let inRange=false
if(options.type==='date'){let dt=w2utils.isDate(str,options.format,true)
if(dt){if(options.start||options.end){let st=(typeof options.start==='string'?options.start:query(options.start).val())
let en=(typeof options.end==='string'?options.end:query(options.end).val())
let start=w2utils.isDate(st,options.format,true)
let end=w2utils.isDate(en,options.format,true)
let current=new Date(dt)
if(!start)start=current
if(!end)end=current
if(current>=start&&current<=end)inRange=true}else{inRange=true}
if(Array.isArray(options.blockDates)&&options.blockDates.includes(str))inRange=false
if(Array.isArray(options.blockWeekdays)&&options.blockWeekdays.includes(dt.getDay()))inRange=false}}else if(options.type==='time'){if(options.start||options.end){let tm=this.str2min(str)
let tm1=this.str2min(options.start)
let tm2=this.str2min(options.end)
if(!tm1)tm1=tm
if(!tm2)tm2=tm
if(tm>=tm1&&tm<=tm2)inRange=true}else{inRange=true}}else if(options.type==='datetime'){let dt=w2utils.isDateTime(str,options.format,true)
if(dt){let format=options.format.split('|').map(format=>format.trim())
if(dateOnly){let date=w2utils.formatDate(dt,format[0])
let opts=w2utils.extend({},options,{type:'date',format:format[0]})
if(this.inRange(date,opts))inRange=true}else{let time=w2utils.formatTime(dt,format[1])
let opts={type:'time',format:format[1],start:options.startTime,end:options.endTime}
if(this.inRange(time,opts))inRange=true}}}
return inRange}
str2min(str){if(typeof str!=='string')return null
let tmp=str.split(':')
if(tmp.length===2){tmp[0]=parseInt(tmp[0])
tmp[1]=parseInt(tmp[1])
if(str.indexOf('pm')!==-1&&tmp[0]!==12)tmp[0]+=12
if(str.includes('am')&&tmp[0]==12)tmp[0]=0}else{return null}
return tmp[0]*60+tmp[1]}
min2str(time,format){let ret=''
if(time>=24*60)time=time%(24*60)
if(time<0)time=24*60+time
let hour=Math.floor(time/60)
let min=((time%60)<10?'0':'')+(time%60)
if(!format){format=w2utils.settings.timeFormat}
if(format.indexOf('h24')!==-1){ret=hour+':'+min}else{ret=(hour<=12?hour:hour-12)+':'+min+' '+(hour>=12?'pm':'am')}
return ret}}
let w2tooltip=new Tooltip()
let w2menu=new MenuTooltip()
let w2color=new ColorTooltip()
let w2date=new DateTooltip()
class w2toolbar extends w2base{constructor(options){super(options.name)
this.box=null
this.name=null
this.routeData={}
this.items=[]
this.right=''
this.tooltip='top|left'
this.onClick=null
this.onChange=null
this.onMouseDown=null
this.onMouseUp=null
this.onMouseEnter=null
this.onMouseLeave=null
this.onRender=null
this.onRefresh=null
this.onResize=null
this.onDestroy=null
this.item_template={id:null,type:'button',text:null,html:'',tooltip:null,count:null,hidden:false,disabled:false,checked:false,icon:null,route:null,arrow:null,style:null,group:null,items:null,selected:null,color:null,backColor:null,overlay:{anchorClass:''},onClick:null,onRefresh:null}
this.last={badge:{},pendingRefresh:{}}
this._refresh=({effected,resize,refreshTooltip})=>{let options=this.last.pendingRefresh
options.ids??=[]
options.ids.push(...effected)
Object.assign(options,{resize,refreshTooltip})
this._refreshDebounced()}
this._refreshDebounced=w2utils.debounce(()=>{let options=this.last.pendingRefresh
new Set(options.ids).forEach(id=>{this.refresh(id)
if(options.hideTooltip)this.tooltipHide(id)})
if(options.resize)this.resize()
this.last.pendingRefresh={}},15)
let items=options.items
delete options.items
Object.assign(this,options)
if(Array.isArray(items))this.add(items,true)
options.items=items
if(typeof this.box=='string')this.box=query(this.box).get(0)
if(this.box)this.render(this.box)}
add(items,skipRefresh){this.insert(null,items,skipRefresh)}
insert(id,items,skipRefresh){if(!Array.isArray(items))items=[items]
items.forEach((item,idx,arr)=>{if(typeof item==='string'){item=arr[idx]={id:item,text:item}}
let valid=['button','check','radio','drop','menu','menu-radio','menu-check','color','text-color','html','label','input','group','break','spacer','new-line']
if(!valid.includes(String(item.type))){console.log('ERROR: The parameter "type" should be one of the following:',valid,`, but ${item.type} is supplied.`,item)
return}
if(item.id==null&&!['break','spacer','new-line'].includes(item.type)){console.log('ERROR: The parameter "id" is required but not supplied.',item)
return}
if(item.type==null){console.log('ERROR: The parameter "type" is required but not supplied.',item)
return}
if(!w2utils.checkUniqueId(item.id,this.items,'toolbar',this.name))return
let newItem=w2utils.extend({},this.item_template,item)
if(newItem.type=='menu-check'){if(!Array.isArray(newItem.selected))newItem.selected=[]
if(Array.isArray(newItem.items)){newItem.items.forEach(it=>{if(typeof it==='string'){it=arr[idx]={id:it,text:it}}
if(it.checked&&!newItem.selected.includes(it.id))newItem.selected.push(it.id)
if(!it.checked&&newItem.selected.includes(it.id))it.checked=true
if(it.checked==null)it.checked=false})}}else if(newItem.type=='menu-radio'){if(Array.isArray(newItem.items)){newItem.items.forEach((it,idx,arr)=>{if(typeof it==='string'){it=arr[idx]={id:it,text:it}}
if(it.checked&&newItem.selected==null)newItem.selected=it.id;else it.checked=false
if(!it.checked&&newItem.selected==it.id)it.checked=true
if(it.checked==null)it.checked=false})}}
if(id==null){this.items.push(newItem)}else{let middle=this.get(id,true)
this.items=this.items.slice(0,middle).concat([newItem],this.items.slice(middle))}
newItem.line=newItem.line??1
if(skipRefresh!==true)this.refresh(newItem.id)})
if(skipRefresh!==true)this.resize()}
remove(){let effected=0
Array.from(arguments).forEach(item=>{let it=this.get(item)
if(!it||String(item).indexOf(':')!=-1)return
effected++
query(this.box).find('#tb_'+this.name+'_item_'+w2utils.escapeId(it.id)).remove()
let ind=this.get(it.id,true)
if(ind!=null)this.items.splice(ind,1)})
this.resize()
return effected}
set(id,newOptions){let item=this.get(id)
if(item==null)return false
Object.assign(item,newOptions)
this.refresh(String(id).split(':')[0])
return true}
get(id,returnIndex,items){if(arguments.length===0){let all=[]
for(let i1=0;i1<this.items.length;i1++){let it=this.items[i1]
if(it.id!=null)all.push(it.id)
if(it.type=='group'){for(let i2=0;i2<it.items.length;i2++){if(it.items[i2].id!=null)all.push(it.items[i2].id)}}}
return all}
let tmp=String(id).split(':')
if(items==null)items=this.items
for(let i1=0;i1<items.length;i1++){let it=items[i1]
if(['menu','menu-radio','menu-check'].includes(it.type)&&tmp.length==2&&it.id==tmp[0]){let subItems=it.items
if(typeof subItems=='function')subItems=subItems(this)
for(let i=0;i<subItems.length;i++){let item=subItems[i]
if(item.id==tmp[1]||(item.id==null&&item.text==tmp[1])){if(returnIndex==true)return i;else return item}
if(Array.isArray(item.items)){for(let j=0;j<item.items.length;j++){if(item.items[j].id==tmp[1]||(item.items[j].id==null&&item.items[j].text==tmp[1])){if(returnIndex==true)return i;else return item.items[j]}}}}}else if(it.id==tmp[0]){if(returnIndex==true)return i1;else return it}else if(it.type=='group'){let sub=this.get(id,returnIndex,it.items)
if(sub!=null)return sub}}
return null}
setCount(id,count,className,style){let btn=query(this.box).find(`#tb_${this.name}_item_${w2utils.escapeId(id)} .w2ui-tb-count > span`)
if(btn.length>0){btn.removeClass().addClass(className??'').text(count).get(0).style.cssText=style??''
this.last.badge[id]={className:className??'',style:style??''}
let item=this.get(id)
item.count=count}else{this.set(id,{count:count})
this.setCount(...arguments)}}
show(){let effected=[]
Array.from(arguments).forEach(item=>{let it=this.get(item)
if(!it)return
it.hidden=false
effected.push(String(item).split(':')[0])
if(it.type=='group'){it.items.forEach(itm=>this.show(itm.id))}})
this._refresh({effected,resize:true})
return effected}
hide(){let effected=[]
Array.from(arguments).forEach(item=>{let it=this.get(item)
if(!it)return
it.hidden=true
effected.push(String(item).split(':')[0])
if(it.type=='group'){it.items.forEach(itm=>this.hide(itm.id))}})
this._refresh({effected,hideTooltip:true,resize:true})
return effected}
enable(){let effected=[]
Array.from(arguments).forEach(item=>{let it=this.get(item)
if(!it)return
if(it.type=='group'){it.items.forEach(itm=>this.enable(itm.id))}else{it.disabled=false
effected.push(String(item).split(':')[0])}})
this._refresh({effected})
return effected}
disable(){let effected=[]
Array.from(arguments).forEach(item=>{let it=this.get(item)
if(!it)return
if(it.type=='group'){it.items.forEach(itm=>this.disable(itm.id))}else{it.disabled=true
effected.push(String(item).split(':')[0])}})
this._refresh({effected,hideTooltip:true})
return effected}
check(){let effected=[]
Array.from(arguments).forEach(item=>{let it=this.get(item)
if(!it||String(item).indexOf(':')!=-1)return
if(it.type=='group'){it.items.forEach(itm=>this.check(itm.id))}else{it.checked=true
effected.push(String(item).split(':')[0])}})
this._refresh({effected})
return effected}
uncheck(){let effected=[]
Array.from(arguments).forEach(item=>{let it=this.get(item)
if(!it||String(item).indexOf(':')!=-1)return
if(['menu','menu-radio','menu-check','drop','color','text-color'].includes(it.type)&&it.checked){w2tooltip.hide(this.name+'-drop')}
if(it.type=='group'){it.items.forEach(itm=>this.uncheck(itm.id))}else{it.checked=false
effected.push(String(item).split(':')[0])}})
this._refresh({effected})
return effected}
click(id,event){let tmp=String(id).split(':')
let it=this.get(tmp[0])
let items=(it&&it.items?w2utils.normMenu.call(this,it.items,it):[])
if(tmp.length>1){let subItem=this.get(id)
if(subItem&&!subItem.disabled){this.menuClick({name:this.name,item:it,subItem:subItem,originalEvent:event})}
return}
if(it&&!it.disabled){let edata=this.trigger('click',{target:(id!=null?id:this.name),item:it,object:it,originalEvent:event})
if(edata.isCancelled===true)return
items=(it&&it.items?w2utils.normMenu.call(this,it.items,it):[])
let btn='#tb_'+this.name+'_item_'+w2utils.escapeId(it.id)
query(this.box).find(btn).removeClass('down')
if(it.type=='radio'){for(let i=0;i<this.items.length;i++){let itt=this.items[i]
if(itt.type=='group'){for(let i1=0;i1<itt.items.length;i1++){let itt1=itt.items[i1]
if(itt1==null||itt1.id==it.id||itt1.type!=='radio')continue
if(itt1.group==it.group&&itt1.checked){itt1.checked=false
this.refresh(itt1.id)}}}
if(itt==null||itt.id==it.id||itt.type!=='radio')continue
if(itt.group==it.group&&itt.checked){itt.checked=false
this.refresh(itt.id)}}
it.checked=true
query(this.box).find(btn).addClass('checked')}
if(['menu','menu-radio','menu-check','drop','color','text-color'].includes(it.type)){this.tooltipHide(id)
if(it.checked){w2tooltip.hide(this.name+'-drop')
return}else{let overlay=w2tooltip.get(this.name+'-drop')
if(overlay?.displayed)overlay.hide()
overlay?.listeners?.splice(0)
setTimeout(()=>{let hideDrop=(id,btn)=>{let self=this
return function(){self.set(id,{checked:false})}}
let el=query(this.box).find('#tb_'+this.name+'_item_'+w2utils.escapeId(it.id))
if(!w2utils.isPlainObject(it.overlay))it.overlay={}
if(it.type=='drop'){w2tooltip.show(w2utils.extend({html:it.html,class:'w2ui-white',hideOn:['doc-click']},it.overlay,{anchor:el[0],name:this.name+'-drop',data:{item:it,btn}})).hide(hideDrop(it.id,btn))}
if(['menu','menu-radio','menu-check'].includes(it.type)){let menuType='normal'
if(it.type=='menu-radio'){menuType='radio'
items.forEach((item)=>{if(it.selected==item.id)item.checked=true;else item.checked=false})}
if(it.type=='menu-check'){menuType='check'
items.forEach((item)=>{if(Array.isArray(it.selected)&&it.selected.includes(item.id))item.checked=true;else item.checked=false})}
w2menu.show(w2utils.extend({items,align:it.text?'left':'none',},it.overlay,{type:menuType,name:this.name+'-drop',anchor:el[0],data:{item:it,btn}})).hide(hideDrop(it.id,btn)).remove(event=>{this.menuClick({name:this.name,remove:true,item:it,subItem:event.detail.item,originalEvent:event})}).select(event=>{this.menuClick({name:this.name,item:it,subItem:event.detail.item,originalEvent:event})})}
if(['color','text-color'].includes(it.type)){w2color.show(w2utils.extend({color:it.color},it.overlay,{anchor:el[0],name:this.name+'-drop',data:{item:it,btn}})).hide(hideDrop(it.id,btn)).select(event=>{if(event.detail.color!=null){this.colorClick({name:this.name,item:it,color:event.detail.color})}})}},0)}}
if(['check','menu','menu-radio','menu-check','drop','color','text-color'].includes(it.type)){it.checked=!it.checked
if(it.checked){query(this.box).find(btn).addClass('checked')}else{query(this.box).find(btn).removeClass('checked')}}
if(it.route){let route=String('/'+it.route).replace(/\/{2,}/g,'/')
let info=w2utils.parseRoute(route)
if(info.keys.length>0){for(let k=0;k<info.keys.length;k++){route=route.replace((new RegExp(':'+info.keys[k].name,'g')),this.routeData[info.keys[k].name])}}
setTimeout(()=>{window.location.hash=route},1)}
this.tooltipShow(id)
edata.finish()}}
scroll(direction,line,instant){return new Promise((resolve,reject)=>{let scrollBox=query(this.box).find(`.w2ui-tb-line:nth-child(${line}) .w2ui-scroll-wrapper`)
let scrollLeft=scrollBox.get(0).scrollLeft
let right=scrollBox.find('.w2ui-tb-right').get(0)
let width1=scrollBox.parent().get(0).getBoundingClientRect().width
let width2=scrollLeft+parseInt(right.offsetLeft)+parseInt(right.clientWidth)
switch(direction){case'left':{scroll=scrollLeft-width1+50
if(scroll<=0)scroll=0
scrollBox.get(0).scrollTo({top:0,left:scroll,behavior:instant?'atuo':'smooth'})
break}
case'right':{scroll=scrollLeft+width1-50
if(scroll>=width2-width1)scroll=width2-width1
scrollBox.get(0).scrollTo({top:0,left:scroll,behavior:instant?'atuo':'smooth'})
break}}
setTimeout(()=>{this.resize();resolve()},instant?0:600)})}
render(box){let time=Date.now()
if(typeof box=='string')box=query(box).get(0)
let edata=this.trigger('render',{target:this.name,box:box??this.box})
if(edata.isCancelled===true)return
if(box!=null){this.unmount()
this.box=box}
if(!this.box)return
if(!Array.isArray(this.right)){this.right=[this.right]}
let html=''
let line=0
for(let i=0;i<this.items.length;i++){let it=this.items[i]
if(it==null)continue
if(it.id==null)it.id='item_'+i
if(it.caption!=null){console.log('NOTICE: toolbar item.caption property is deprecated, please use item.text. Item -> ',it)}
if(it.hint!=null){console.log('NOTICE: toolbar item.hint property is deprecated, please use item.tooltip. Item -> ',it)}
if(i===0||it.type=='new-line'){line++
html+=`
                    <div class="w2ui-tb-line">
                        <div class="w2ui-scroll-wrapper w2ui-eaction" data-mousedown="resize">
                            <div class="w2ui-tb-right">${this.right[line-1] ?? ''}</div>
                        </div>
                        <div class="w2ui-scroll-left w2ui-eaction" data-click='["scroll", "left", "${line}"]'></div>
                        <div class="w2ui-scroll-right w2ui-eaction" data-click='["scroll", "right", "${line}"]'></div>
                    </div>
                `}
it.line=line}
query(this.box).attr('name',this.name).addClass('w2ui-reset w2ui-toolbar').html(html)
if(query(this.box).length>0){query(this.box)[0].style.cssText+=this.style}
w2utils.bindEvents(query(this.box).find('.w2ui-tb-line .w2ui-eaction'),this)
this.last.observeResize=new ResizeObserver(()=>{this.resize()})
this.last.observeResize.observe(this.box)
this.refresh()
this.resize()
edata.finish()
return Date.now()-time}
refresh(id){let time=Date.now()
let edata=this.trigger('refresh',{target:(id!=null?id:this.name),item:this.get(id)})
if(edata.isCancelled===true)return
let edata2
if(id==null){for(let i=0;i<this.items.length;i++){let it1=this.items[i]
if(it1.id==null)it1.id='item_'+i
this.refresh(it1.id)}
return}
let it=this.get(id)
if(it==null)return false
if(typeof it.onRefresh=='function'){edata2=this.trigger('refresh',{target:id,item:it,object:it})
if(edata2.isCancelled===true)return}
let selector=`#tb_${this.name}_item_${w2utils.escapeId(it.id)}`
let btn=query(this.box).find(selector)
let html=this.getItemHTML(it)
this.tooltipHide(id)
if(it.type=='spacer'){query(this.box).find(`.w2ui-tb-line:nth-child(${it.line}`).find('.w2ui-tb-right').css('width','auto')}
if(btn.length===0){let next=parseInt(this.get(id,true))+1
let $next=query(this.box).find(`#tb_${this.name}_item_${w2utils.escapeId(this.items[next] ? this.items[next].id : '')}`)
if($next.length==0){$next=query(this.box).find(`.w2ui-tb-line:nth-child(${it.line}`).find('.w2ui-tb-right').before(html)}else{$next.after(html)}
w2utils.bindEvents(query(this.box).find(`${selector}, ${selector} .w2ui-eaction`),this)}else{query(this.box).find(selector).replace(query.html(html))
let newBtn=query(this.box).find(selector)
w2utils.bindEvents(newBtn,this)
w2utils.bindEvents(newBtn.find('.w2ui-eaction'),this)
let overlays=w2tooltip.get(true)
Object.keys(overlays).forEach(key=>{if(overlays[key].anchor==btn.get(0)){overlays[key].anchor=newBtn.get(0)}})}
if(['menu','menu-radio','menu-check'].includes(it.type)&&it.checked){let selected=Array.isArray(it.selected)?it.selected:[it.selected]
let items=typeof it.items=='function'?it.items(it):[...it.items]
items.forEach((item)=>{if(selected.includes(item.id))item.checked=true;else item.checked=false})
w2menu.update(this.name+'-drop',items)}
if(typeof it.onRefresh=='function'){edata2.finish()}
edata.finish()
return Date.now()-time}
resize(){let time=Date.now()
let edata=this.trigger('resize',{target:this.name})
if(edata.isCancelled===true)return
query(this.box).find('.w2ui-tb-line').each(el=>{let box=query(el)
box.find('.w2ui-scroll-left, .w2ui-scroll-right').hide()
let scrollBox=box.find('.w2ui-scroll-wrapper').get(0)
let $right=box.find('.w2ui-tb-right')
let boxWidth=box.get(0).getBoundingClientRect().width
let itemsWidth=($right.length>0?$right[0].offsetLeft+$right[0].clientWidth:0)
if(boxWidth<itemsWidth){if(scrollBox.scrollLeft>0){box.find('.w2ui-scroll-left').show()}
if(boxWidth<itemsWidth-scrollBox.scrollLeft){box.find('.w2ui-scroll-right').show()}}})
edata.finish()
return Date.now()-time}
destroy(){let edata=this.trigger('destroy',{target:this.name})
if(edata.isCancelled===true)return
if(query(this.box).find('.w2ui-scroll-wrapper').length>0){this.unmount()}
delete w2ui[this.name]
edata.finish()}
unmount(){super.unmount()
this.last.observeResize?.disconnect()}
getItemHTML(item){let html=''
if(item.caption!=null&&item.text==null)item.text=item.caption
if(item.text==null)item.text=''
if(item.tooltip==null&&item.hint!=null)item.tooltip=item.hint
if(item.tooltip==null)item.tooltip=''
if(typeof item.get!=='function'&&(Array.isArray(item.items)||typeof item.items=='function')){item.get=function get(id){let tmp=item.items
if(typeof tmp=='function')tmp=item.items(item)
return tmp.find(it=>it.id==id?true:false)}}
let icon=''
let text=(typeof item.text=='function'?item.text.call(this,item):item.text)
if(item.icon){icon=item.icon
if(typeof item.icon=='function'){icon=item.icon.call(this,item)}
if(String(icon).slice(0,1)!=='<'){icon=`<span class="${icon}" ${item.icon_style ? `style="${item.icon_style}"` : ''}></span>`}
icon=`<div class="w2ui-tb-icon">${icon}</div>`}
let classes=['w2ui-tb-button','w2ui-eaction']
if(item.checked)classes.push('checked')
if(item.disabled)classes.push('disabled')
if(item.hidden)classes.push('hidden')
if(!icon)classes.push('no-icon')
switch(item.type){case'color':case'text-color':if(typeof item.color=='string'){if(item.color.slice(0,1)=='#')item.color=item.color.slice(1)
if([3,6,8].includes(item.color.length))item.color='#'+item.color}
if(item.type=='color'){text=`<span class="w2ui-tb-color-box" style="background-color: ${(item.color != null ? item.color : '#fff')}"></span>
                           ${(item.text ? `<div style="margin-left: 17px;">${w2utils.lang(item.text)}</div>` : '')}`}
if(item.type=='text-color'){let color=(item.color!=null?item.color:'#444')
let bcolor=item.backColor
if(item.backColor===true){bcolor='#fff'
if(w2utils.colorContrast('#fff',color)<2){bcolor='#555'}}
text=`<span style="color: ${color}">${item.text
                        ? w2utils.lang(item.text)
                        : (item.backColor
                            ? `<b style="background-color: ${bcolor ?? 'transparent'}; padding: 2px 5px; border-radius: 3px;">Ab</b>`
                            : '<b>Ab</b>'
                        )
                    }</span>`}
case'menu':case'menu-check':case'menu-radio':case'button':case'check':case'radio':case'label':case'drop':{let arrow=(item.arrow===true||(item.arrow!==false&&['menu','menu-radio','menu-check','drop','color','text-color'].includes(item.type)))
html=`
                    <div id="tb_${this.name}_item_${item.id}" class="${classes.join(' ')} ${(item.class ? item.class : '')}"
                        style="${(item.hidden ? 'display: none' : '')} ${item.type == 'label' ? (item.style ?? '') : ''}"
                        ${!item.disabled
                            ? `data-click='["click","${item.id}", "event"]'
data-mouseenter='["mouseAction", "event", "this", "Enter", "${item.id}"]'
data-mouseleave='["mouseAction", "event", "this", "Leave", "${item.id}"]'
data-mousedown='["mouseAction", "event", "this", "Down", "${item.id}"]'
data-mouseup='["mouseAction", "event", "this", "Up", "${item.id}"]'`
                            : ''}
                    >
                        ${ icon }
                        ${ (text != '' && text != null) || item.count != null || arrow
                            ? `<div class="w2ui-tb-text"style="${item.type != 'label' ? (item.style ?? '') : ''}; ${!text ? 'padding-left: 0; margin-left: 23px;' : ''}">${w2utils.lang(text)}
${item.count!=null?w2utils.stripSpaces(`
                                            <span class="w2ui-tb-count">
                                                <span class="${this.last.badge[item.id] ? this.last.badge[item.id].className ?? '' : ''}"
                                                        style="${this.last.badge[item.id] ? this.last.badge[item.id].style ?? '' : ''}">${item.count}</span>
                                            </span>`):''}
${arrow?`<span class="w2ui-tb-down" ${!text && !item.count ? 'style="margin-left: -3px"' : ''}><span></span></span>`:''}</div>`
                            : ''
                        }
                    </div>
                `
break}
case'break':{html=`<div id="tb_${this.name}_item_${item.id}" class="w2ui-tb-break"
                            style="${(item.hidden ? 'display: none' : '')}; ${(item.style ? item.style : '')}">
                            &#160;
                        </div>`
break}
case'spacer':{html=`<div id="tb_${this.name}_item_${item.id}" class="w2ui-tb-spacer"
                            style="${(item.hidden ? 'display: none' : '')}; ${(item.style ? item.style : '')}">
                        </div>`
break}
case'html':{html=`<div id="tb_${this.name}_item_${item.id}" class="w2ui-tb-html ${classes.join(' ')}"
                            style="${(item.hidden ? 'display: none' : '')}; ${(item.style ? item.style : '')}">
                            ${(typeof item.html == 'function' ? item.html.call(this, item) : item.html)}
                        </div>`
break}
case'input':{let ph=item.placeholder
let val=item.value
if(val!=null&&String(val).trim()!==''&&item.spinner){let step=item.spinner?.step??1
let prec=item.spinner.precision??String(step).split('.')[1]?.length??0
val=val.toFixed(prec)}
html=`<div id="tb_${this.name}_item_${item.id}" class="w2ui-tb-input w2ui-eaction ${classes.join(' ')}"
                            style="${(item.hidden ? 'display: none' : '')}; ${(item.style ? item.style : '')}"
                        >
                            <span class="w2ui-input-label">${item.text ?? ''}</span>
                            ${item.spinner
                                ? `<span class="w2ui-spinner-dec w2ui-eaction"data-click='["spinner", "${item.id}", "dec", "event"]'>–</span>`
                                : ''}
                            <input class="w2ui-toolbar-input w2ui-eaction ${item.spinner ? 'w2ui-has-spinner' : ''}"
                                ${ph ? `placeholder="${ph}"` : ''} style="${item.spinner?.style ?? ''}" value="${val ?? ''}${item.spinner?.suffix ?? ''}"
                                data-change='["change", "${item.id}", "this"]'
                                data-keydown='["spinner", "${item.id}", "key", "event"]'
                                data-mouseenter='["mouseAction", "event", "this", "Enter", "${item.id}"]'
                                data-mouseleave='["mouseAction", "event", "this", "Leave", "${item.id}"]'
                            >
                            ${item.spinner
                                ? `<span class="w2ui-spinner-inc w2ui-eaction"data-click='["spinner", "${item.id}", "inc", "event"]'>+</span>`
                                : ''}
                        </div>`
break}
case'group':{html=`<div id="tb_${this.name}_item_${item.id}" class="w2ui-tb-group"
                    style="display: flex; ${(item.hidden ? 'display: none' : '')}; ${(item.style ? item.style : '')}">`
if(Array.isArray(item.items)){item.items.forEach(it=>{html+=this.getItemHTML(it)})}else{console.log('ERROR: toolbar group is empty')}
html+='</div>'}}
return html}
spinner(id,action,event){let it=this.get(id)
let inc=0
switch(action){case'inc':{inc=(it.spinner?.step??1)
break}
case'dec':{inc=-(it.spinner?.step??1)
break}
case'key':{if(it.spinner){let mult=1
if(event.shiftKey||event.metaKey)mult=10
if(event.altKey)mult=0.1
switch(event.key){case'ArrowUp':{inc=(it.spinner?.step??1)*mult
event.preventDefault()
break}
case'ArrowDown':{inc=-(it.spinner?.step??1)*mult
event.preventDefault()
break}}}
break}}
if(inc!==0){this.change(id,(it.value??0)+inc)}}
change(id,value){let it=this.get(id)
let input=query(this.box).find('#tb_'+this.name+'_item_'+w2utils.escapeId(id)).find('input.w2ui-toolbar-input')
if(value instanceof HTMLInputElement){value=value.value}
if(value==null)value=input.val()
if(it.spinner){value=parseFloat(value)}
if(it.spinner?.min!=null&&it.spinner.min>value){value=it.spinner.min}
if(it.spinner?.max!=null&&it.spinner.max<value){value=it.spinner.max}
if(it.spinner){if(isNaN(value))value=it.spinner.min??0
let step=it.spinner?.step??1
let prec=it.spinner.precision??String(step).split('.')[1]?.length??0
value=value.toFixed(prec)}
let edata=this.trigger('change',{target:id,id,value,item:it})
if(edata.isCancelled){return}
it.value=it.spinner?parseFloat(value):value
input.val(value+(it.spinner?.suffix??''))
edata.finish()}
tooltipShow(id){if(this.tooltip==null)return
let el=query(this.box).find('#tb_'+this.name+'_item_'+w2utils.escapeId(id)).get(0)
let item=this.get(id)
let overlay=(typeof this.tooltip=='string'?{position:this.tooltip}:this.tooltip)
let txt=item.tooltip
if(typeof txt=='function')txt=txt.call(this,item)
if(['menu','menu-radio','menu-check','drop','color','text-color'].includes(item.type)&&item.checked==true){return}
w2tooltip.show({anchor:el,name:this.name+'-tooltip',html:txt,...overlay})
return}
tooltipHide(id){if(this.tooltip==null)return
w2tooltip.hide(this.name+'-tooltip')}
menuClick(event){if(event.item&&!event.item.disabled){let edata=this.trigger((event.remove!==true?'click':'remove'),{target:event.item.id+':'+event.subItem.id,item:event.item,subItem:event.subItem,originalEvent:event.originalEvent})
if(edata.isCancelled===true)return
let it=event.subItem
let item=this.get(event.item.id)
let items=item.items
if(typeof items=='function')items=item.items()
if(item.type=='menu'){item.selected=it.id}
if(item.type=='menu-radio'){item.selected=it.id
if(Array.isArray(items)){items.forEach((item)=>{if(item.checked===true)delete item.checked
if(Array.isArray(item.items)){item.items.forEach((item)=>{if(item.checked===true)delete item.checked})}})}
it.checked=true}
if(item.type=='menu-check'){if(!Array.isArray(item.selected))item.selected=[]
if(it.group==null){let ind=item.selected.indexOf(it.id)
if(ind==-1){item.selected.push(it.id)
it.checked=true}else{item.selected.splice(ind,1)
it.checked=false}}else if(it.group===false){}else{let unchecked=[]
let ind=item.selected.indexOf(it.id)
let checkNested=(items)=>{items.forEach((sub)=>{if(sub.group===it.group){let ind=item.selected.indexOf(sub.id)
if(ind!=-1){if(sub.id!=it.id)unchecked.push(sub.id)
item.selected.splice(ind,1)}}
if(Array.isArray(sub.items))checkNested(sub.items)})}
checkNested(items)
if(ind==-1){item.selected.push(it.id)
it.checked=true}}}
if(typeof it.route=='string'){let route=it.route!==''?String('/'+it.route).replace(/\/{2,}/g,'/'):''
let info=w2utils.parseRoute(route)
if(info.keys.length>0){for(let k=0;k<info.keys.length;k++){if(this.routeData[info.keys[k].name]==null)continue
route=route.replace((new RegExp(':'+info.keys[k].name,'g')),this.routeData[info.keys[k].name])}}
setTimeout(()=>{window.location.hash=route},1)}
this.refresh(event.item.id)
edata.finish()}}
colorClick(event){let obj=this
if(event.item&&!event.item.disabled){let edata=this.trigger('click',{target:event.item.id,item:event.item,color:event.color,final:true})
if(edata.isCancelled===true)return
event.item.color=event.color
obj.refresh(event.item.id)
edata.finish()}}
mouseAction(event,target,action,id){let btn=this.get(id)
let edata=this.trigger('mouse'+action,{target:id,item:btn,object:btn,originalEvent:event})
if(edata.isCancelled===true||btn.disabled||btn.hidden)return
switch(action){case'Enter':if(!['label','input'].includes(btn.type)){query(target).addClass('over')}
this.tooltipShow(id)
break
case'Leave':if(!['label','input'].includes(btn.type)){query(target).removeClass('over down')}
this.tooltipHide(id)
break
case'Down':if(!['label','input'].includes(btn.type)){query(target).addClass('down')}
break
case'Up':if(!['label','input'].includes(btn.type)){query(target).removeClass('down')}
break}
edata.finish()}}
class w2sidebar extends w2base{constructor(options){super(options.name)
this.name=null
this.box=null
this.sidebar=null
this.parent=null
this.nodes=[]
this.menu=[]
this.routeData={}
this.selected=null
this.icon=null
this.style=''
this.topHTML=''
this.bottomHTML=''
this.multi=false
this.editable=false
this.reorder=false
this.flatButton=false
this.keyboard=true
this.flat=false
this.hasFocus=false
this.levelPadding=12
this.toggleAlign='right'
this.skipRefresh=false
this.tabIndex=null
this.handle={width:0,style:'',text:'',tooltip:''},this.badge=null
this.onClick=null
this.onSelect=null
this.onUnselect=null
this.onDblClick=null
this.onMouseEnter=null
this.onMouseLeave=null
this.onContextMenu=null
this.onMenuClick=null
this.onExpand=null
this.onCollapse=null
this.onKeydown=null
this.onRender=null
this.onRefresh=null
this.onResize=null
this.onDestroy=null
this.onFocus=null
this.onBlur=null
this.onFlat=null
this.onEdit=null
this.onRename=null
this.onReorder=null
this.onDragStart=null
this.onDragOver=null
this.node_template={id:null,text:'',order:null,count:null,icon:null,nodes:[],style:'',route:null,selected:false,expanded:false,hidden:false,disabled:false,group:false,groupShowHide:true,collapsible:false,plus:false,childOffset:0,onClick:null,onDblClick:null,onContextMenu:null,onExpand:null,onCollapse:null,parent:null,sidebar:null}
this.last={badge:{},renaming:false,move:null,}
let nodes=options.nodes
delete options.nodes
Object.assign(this,options)
if(Array.isArray(nodes))this.add(nodes)
options.nodes=nodes
if(typeof this.box=='string')this.box=query(this.box).get(0)
if(this.box)this.render(this.box)}
add(parent,nodes){if(arguments.length==1){nodes=arguments[0]
parent=this}
if(typeof parent=='string')parent=this.get(parent)
if(parent==null||parent=='')parent=this
return this.insert(parent,null,nodes)}
insert(parent,before,nodes){let txt,ind,tmp,node,nd
if(arguments.length==2&&typeof parent=='string'){nodes=arguments[1]
before=arguments[0]
if(before!=null){ind=this.get(before)
if(ind==null){if(!Array.isArray(nodes))nodes=[nodes]
if(nodes[0].caption!=null&&nodes[0].text==null){console.log('NOTICE: sidebar node.caption property is deprecated, please use node.text. Node -> ',nodes[0])
nodes[0].text=nodes[0].caption}
txt=nodes[0].text
console.log('ERROR: Cannot insert node "'+txt+'" because cannot find node "'+before+'" to insert before.')
return null}
parent=this.get(before).parent}else{parent=this}}
if(typeof parent=='string')parent=this.get(parent)
if(parent==null||parent=='')parent=this
if(!Array.isArray(nodes))nodes=[nodes]
for(let o=0;o<nodes.length;o++){node=nodes[o]
if(node.caption!=null&&node.text==null){console.log('NOTICE: sidebar node.caption property is deprecated, please use node.text')
node.text=node.caption}
if(typeof node.id==null){txt=node.text
console.log('ERROR: Cannot insert node "'+txt+'" because it has no id.')
continue}
if(this.get(this,node.id)!=null){console.log('ERROR: Cannot insert node with id='+node.id+' (text: '+node.text+') because another node with the same id already exists.')
continue}
tmp=Object.assign({},this.node_template,node)
tmp.sidebar=this
tmp.parent=parent
nd=tmp.nodes||[]
tmp.nodes=[]
if(before==null){parent.nodes.push(tmp)}else{ind=this.get(parent,before,true)
if(ind==null){console.log('ERROR: Cannot insert node "'+node.text+'" because cannot find node "'+before+'" to insert before.')
return null}
parent.nodes.splice(ind,0,tmp)}
if(nd.length>0){this.insert(tmp,null,nd)}}
if(!this.skipRefresh)this.refresh(parent.id)
return tmp}
remove(){let effected=0
let node
Array.from(arguments).forEach(arg=>{node=this.get(arg)
if(node==null)return
if(this.selected!=null){if(Array.isArray(this.selected)){this.selected.splice(this.selected.indexOf(node.id),1)}else if(this.selected===node.id){this.selected=null}}
let ind=this.get(node.parent,arg,true)
if(ind==null)return
if(node.parent.nodes[ind].selected)node.sidebar.unselect(node.id)
node.parent.nodes.splice(ind,1)
node.parent.collapsible=node.parent.nodes.length>0
effected++})
if(!this.skipRefresh){if(effected>0&&arguments.length==1)this.refresh(node.parent.id);else this.refresh()}
return effected}
set(parent,id,node){if(arguments.length==2){node=id
id=parent
parent=this}
if(typeof parent=='string')parent=this.get(parent)
if(parent.nodes==null)return null
for(let i=0;i<parent.nodes.length;i++){if(parent.nodes[i].id===id){let res=this.update(id,node)
if(Object.keys(res).length!=0){let nodes=node.nodes
w2utils.extend(parent.nodes[i],node,(nodes!=null?{nodes:[]}:{}))
if(nodes!=null){this.add(parent.nodes[i],nodes)}
if(!this.skipRefresh)this.refresh(id)}
return true}else{let rv=this.set(parent.nodes[i],id,node)
if(rv)return true}}
return false}
get(parent,id,returnIndex){if(arguments.length===0){let all=[]
let tmp=this.find({})
for(let t=0;t<tmp.length;t++){if(tmp[t].id!=null)all.push(tmp[t].id)}
return all}else{if(arguments.length==1||(arguments.length==2&&id===true)){returnIndex=id
id=parent
parent=this}
if(typeof parent=='string')parent=this.get(parent)
if(parent.nodes==null)return null
for(let i=0;i<parent.nodes.length;i++){if(parent.nodes[i].id==id){if(returnIndex===true)return i;else return parent.nodes[i]}else{let rv=this.get(parent.nodes[i],id,returnIndex)
if(rv||rv===0)return rv}}
return null}}
setCount(id,count,options={}){let btn=query(this.box).find(`#node_${w2utils.escapeId(id)} .w2ui-node-badge`)
if(btn.length>0){btn.removeClass().addClass(`w2ui-node-badge ${options.className ?? 'w2ui-node-count'}`).text(count).get(0).style.cssText=options.style||''
this.last.badge[id]={className:options.className??'',style:options.style??''}
let item=this.get(id)
item.count=count}else{this.set(id,{count})
this.setCount(...arguments)}}
find(parent,params,results){if(arguments.length==1){params=parent
parent=this}
if(!results)results=[]
if(typeof parent=='string')parent=this.get(parent)
if(parent.nodes==null)return results
for(let i=0;i<parent.nodes.length;i++){let match=true
for(let prop in params){if(parent.nodes[i][prop]!=params[prop])match=false}
if(match)results.push(parent.nodes[i])
if(parent.nodes[i].nodes.length>0)results=this.find(parent.nodes[i],params,results)}
return results}
sort(options,nodes){if(!options||typeof options!='object')options={}
if(options.foldersFirst==null)options.foldersFirst=true
if(options.caseSensitive==null)options.caseSensitive=false
if(options.reverse==null)options.reverse=false
if(nodes==null){nodes=this.nodes}
nodes.sort((a,b)=>{let isAfolder=(a.nodes&&a.nodes.length>0)
let isBfolder=(b.nodes&&b.nodes.length>0)
if(options.foldersFirst===false||(!isAfolder&&!isBfolder)||(isAfolder&&isBfolder)){let aText=a.text
let bText=b.text
if(!options.caseSensitive){aText=aText.toLowerCase()
bText=bText.toLowerCase()}
if(a.order!=null)aText=a.order
if(b.order!=null)bText=b.order
let cmp=w2utils.naturalCompare(aText,bText)
return(cmp===1||cmp===-1)&options.reverse?-cmp:cmp}
if(isAfolder&&!isBfolder){return!options.reverse?-1:1}
if(!isAfolder&&isBfolder){return!options.reverse?1:-1}})
nodes.forEach(node=>{if(node.nodes&&node.nodes.length>0){this.sort(options,node.nodes)}})}
each(fn,nodes){if(nodes==null)nodes=this.nodes
nodes.forEach((node)=>{fn.call(this,node)
if(node.nodes&&node.nodes.length>0){this.each(fn,node.nodes)}})}
search(str,compare=null){let count=0
let str2=str.toLowerCase()
this.each((node)=>{let match=false
if(typeof compare=='function'){match=compare(str,node)}else{match=!(node.text.toLowerCase().indexOf(str2)===-1)}
if(match){count++
showParents(node)
node.hidden=false}else{node.hidden=true}})
this.refresh()
return count
function showParents(node){if(node.parent){node.parent.hidden=false
showParents(node.parent)}}}
show(){let effected=[]
Array.from(arguments).forEach(it=>{let node=this.get(it)
if(node==null||node.hidden===false)return
node.hidden=false
effected.push(node.id)})
if(effected.length>0){if(arguments.length==1)this.refresh(arguments[0]);else this.refresh()}
return effected}
hide(){let effected=[]
Array.from(arguments).forEach(it=>{let node=this.get(it)
if(node==null||node.hidden===true)return
node.hidden=true
effected.push(node.id)})
if(effected.length>0){if(arguments.length==1)this.refresh(arguments[0]);else this.refresh()}
return effected}
enable(){let effected=[]
Array.from(arguments).forEach(it=>{let node=this.get(it)
if(node==null||node.disabled===false)return
node.disabled=false
effected.push(node.id)})
if(effected.length>0){if(arguments.length==1)this.refresh(arguments[0]);else this.refresh()}
return effected}
disable(){let effected=[]
Array.from(arguments).forEach(it=>{let node=this.get(it)
if(node==null||node.disabled===true)return
node.disabled=true
if(node.selected)this.unselect(node.id)
effected.push(node.id)})
if(effected.length>0){if(arguments.length==1)this.refresh(arguments[0]);else this.refresh()}
return effected}
select(id){if(Array.isArray(id)){[...id].forEach(id=>this.select(id))
return}
let new_node=this.get(id)
if(!new_node)return false
let edata=this.trigger('select',{target:id,id,node:new_node})
if(edata.isCancelled===true){return true}
if(!this.multi&&this.selected==id&&new_node.selected){return false}
let $el=query(this.box).find('#node_'+w2utils.escapeId(id))
$el.addClass('w2ui-selected').find('.w2ui-icon').addClass('w2ui-icon-selected')
if($el.length>0){if(!this.inView(id))this.scrollIntoView(id)}
new_node.selected=true
if(this.multi){if(!Array.isArray(this.selected)){this.selected=this.selected?[this.selected]:[]}
this.selected.push(id)}else{this.selected=this.multi?[id]:id}
edata.finish()
return true}
unselect(id){if(arguments.length===0){id=this.selected}
if(Array.isArray(id)){[...id].forEach(id=>this.unselect(id))
return}
let current=this.get(id)
if(!current)return false
let edata=this.trigger('unselect',{target:id,id,node:current})
if(edata.isCancelled===true){return true}
current.selected=false
query(this.box).find('#node_'+w2utils.escapeId(id)).removeClass('w2ui-selected').find('.w2ui-icon').removeClass('w2ui-icon-selected')
if(typeof this.selected=='string'&&this.selected==id){this.selected=null}
if(this.multi&&Array.isArray(this.selected)){let ind=this.selected.indexOf(id)
if(ind!=-1)this.selected.splice(ind,1)}
edata.finish()
return true}
toggle(id){let nd=this.get(id)
if(nd==null)return false
if(nd.plus){this.set(id,{plus:false})
this.expand(id)
this.refresh(id)
return}
if(nd.nodes.length===0)return false
if(!nd.collapsible)return false
if(this.get(id).expanded)return this.collapse(id);else return this.expand(id)}
collapse(id){let nd=this.get(id)
if(nd==null)return false
let edata=this.trigger('collapse',{target:id,object:nd,node:nd})
if(edata.isCancelled===true)return
query(this.box).find('#node_'+w2utils.escapeId(id)+'_sub').hide()
query(this.box).find('#node_'+w2utils.escapeId(id)+' .w2ui-expanded').removeClass('w2ui-expanded').addClass('w2ui-collapsed')
nd.expanded=false
edata.finish()
this.refresh(id)
return true}
expand(id){let nd=this.get(id)
let edata=this.trigger('expand',{target:id,object:nd,node:nd})
if(edata.isCancelled===true)return
query(this.box).find('#node_'+w2utils.escapeId(id)+'_sub').show()
query(this.box).find('#node_'+w2utils.escapeId(id)+' .w2ui-collapsed').removeClass('w2ui-collapsed').addClass('w2ui-expanded')
nd.expanded=true
edata.finish()
this.refresh(id)
return true}
collapseAll(parent){if(parent==null)parent=this
if(typeof parent=='string')parent=this.get(parent)
if(parent.nodes==null)return false
for(let i=0;i<parent.nodes.length;i++){if(parent.nodes[i].expanded===true)parent.nodes[i].expanded=false
if(parent.nodes[i].nodes&&parent.nodes[i].nodes.length>0)this.collapseAll(parent.nodes[i])}
this.refresh(parent.id)
return true}
expandAll(parent){if(parent==null)parent=this
if(typeof parent=='string')parent=this.get(parent)
if(parent.nodes==null)return false
for(let i=0;i<parent.nodes.length;i++){if(parent.nodes[i].expanded===false)parent.nodes[i].expanded=true
if(parent.nodes[i].nodes&&parent.nodes[i].nodes.length>0)this.expandAll(parent.nodes[i])}
this.refresh(parent.id)}
expandParents(id){let node=this.get(id)
if(node==null)return false
if(node.parent){if(!node.parent.expanded){node.parent.expanded=true
this.refresh(node.parent.id)}
this.expandParents(node.parent.id)}
return true}
click(id,event){let obj=this
let nd=this.get(id)
if(nd==null)return
if(nd.disabled||nd.group){let edata=obj.trigger('click',{target:id,originalEvent:event,node:nd,object:nd})
edata.finish()
return}
let newNode=query(obj.box).find('#node_'+w2utils.escapeId(id))
newNode.addClass('w2ui-selected').find('.w2ui-icon').addClass('w2ui-icon-selected')
setTimeout(()=>{let edata=obj.trigger('click',{target:id,originalEvent:event,node:nd,object:nd})
if(edata.isCancelled===true){newNode.removeClass('w2ui-selected').find('.w2ui-icon').removeClass('w2ui-icon-selected')
return}
if(this.multi){let isShift=event?.shiftKey??false
let isCtrl=(event?.ctrlKey||event?.metaKey)??false
if(typeof this.selected=='string'){this.selected=[this.selected]}
if(isCtrl&&!isShift){if(this.selected?.includes(id)){this.unselect(id)
return}else{this.select(id)}}else if(!isCtrl&&isShift){let chain=this.getChain()
let ind1=Math.min(this.selected.map(sel=>chain.indexOf(sel)))
let ind2=chain.indexOf(id)
for(let i=Math.min(ind1,ind2);i<chain.length&&i<=Math.max(ind1,ind2);i++){if(!this.selected.includes(chain[i])){this.select(chain[i])}}}else{let ids=this.selected?.filter(sid=>sid!=id&&this.selected.includes(sid))
this.unselect(ids)
if(!this.selected?.includes(id)){this.select(id)}}}else if(this.selected!==id){if(this.selected!=null)this.unselect(this.selected)
this.select(id)
if(typeof nd.route=='string'){let route=nd.route!==''?String('/'+nd.route).replace(/\/{2,}/g,'/'):''
let info=w2utils.parseRoute(route)
if(info.keys.length>0){for(let k=0;k<info.keys.length;k++){if(obj.routeData[info.keys[k].name]==null)continue
route=route.replace((new RegExp(':'+info.keys[k].name,'g')),obj.routeData[info.keys[k].name])}}
setTimeout(()=>{window.location.hash=route},1)}}
edata.finish()},1)}
focus(event){let self=this
let edata=this.trigger('focus',{target:this.name,originalEvent:event})
if(edata.isCancelled===true)return false
this.hasFocus=true
query(this.box).find('.w2ui-sidebar-body').addClass('w2ui-focus')
setTimeout(()=>{let input=query(self.box).find('#sidebar_'+self.name+'_focus').get(0)
if(document.activeElement!=input)input.focus()},10)
edata.finish()}
blur(event){let edata=this.trigger('blur',{target:this.name,originalEvent:event})
if(edata.isCancelled===true)return false
this.hasFocus=false
query(this.box).find('.w2ui-sidebar-body').removeClass('w2ui-focus')
edata.finish()}
next(node,noSubs){if(node==null)return null
let parent=node.parent
let ind=this.get(node.id,true)
let nextNode=null
if(node.expanded&&node.nodes.length>0&&noSubs!==true){let nd=node.nodes[0]
if(nd.hidden||nd.disabled||nd.group)nextNode=this.next(nd);else nextNode=nd}else{if(parent&&ind+1<parent.nodes.length){nextNode=parent.nodes[ind+1]}else{nextNode=this.next(parent,true)}}
if(nextNode!=null&&(nextNode.hidden||nextNode.disabled||nextNode.group))nextNode=this.next(nextNode)
return nextNode}
prev(node){if(node==null)return null
let parent=node.parent
let ind=this.get(node.id,true)
let lastChild=(node)=>{if(node.expanded&&node.nodes.length>0){let nd=node.nodes[node.nodes.length-1]
if(nd.hidden||nd.disabled||nd.group)return this.prev(nd);else return lastChild(nd)}
return node}
let prevNode=(ind>0)?lastChild(parent.nodes[ind-1]):parent
if(prevNode!=null&&(prevNode.hidden||prevNode.disabled||prevNode.group))prevNode=this.prev(prevNode)
return prevNode}
getChain(nodes,options={}){options.returnDisabled??=false
options.returnGroups??=false
let ids=[]
if(nodes==null)nodes=this.nodes
nodes.forEach(node=>{if((!node.disabled&&!node.group)||(node.disabled&&options.returnDisabled)||(node.group&&options.returnGroups)){ids.push(node.id)}
if(Array.isArray(node.nodes)&&node.expanded){ids.push(...this.getChain(node.nodes,options))}})
return ids}
keydown(event){let self=this
let first=Array.isArray(this.selected)?this.selected[0]:this.selected
let nd=self.get(first)
if(this.keyboard!==true)return
if(!nd)nd=this.nodes[0]
if(event.keyCode==27){let mv=this.last.move
if(mv?.reorder&&mv?.moved){mv.restore()
return}}
let edata=this.trigger('keydown',{target:this.name,originalEvent:event})
if(edata.isCancelled===true)return
if(event.keyCode==13||event.keyCode==32){if(event.keyCode==13&&this.editable&&!event.ctrlKey&&!event.metaKey){this.edit(first)}else{if(nd.nodes.length>0){this.toggle(first)}}}
if(event.keyCode==37){if(nd.nodes.length>0&&nd.expanded){this.collapse(first)}else{selectNode(nd.parent)
if(!nd.parent.group)this.collapse(nd.parent.id)}}
if(event.keyCode==39){if((nd.nodes.length>0||nd.plus)&&!nd.expanded)this.expand(first)}
if(event.keyCode==38){if(this.get(first)==null){selectNode(this.nodes[0]||null)}else{selectNode(neighbor(nd,this.prev))}}
if(event.keyCode==40){if(this.get(first)==null){selectNode(this.nodes[0]||null)}else{selectNode(neighbor(nd,this.next))}}
if([13,32,37,38,39,40].includes(event.keyCode)){if(event.preventDefault)event.preventDefault()
if(event.stopPropagation)event.stopPropagation()}
edata.finish()
function selectNode(node,event){if(node!=null&&!node.hidden&&!node.disabled&&!node.group){self.click(node.id,event)
if(!self.inView(node.id))self.scrollIntoView(node.id)}}
function neighbor(node,neighborFunc){node=neighborFunc.call(self,node)
while(node!=null&&(node.hidden||node.disabled)){if(node.group)break;else node=neighborFunc(node)}
return node}}
inView(id){let item=query(this.box).find('#node_'+w2utils.escapeId(id)).get(0)
if(!item){return false}
let div=query(this.box).find('.w2ui-sidebar-body').get(0)
if(item.offsetTop<div.scrollTop||(item.offsetTop+item.clientHeight>div.clientHeight+div.scrollTop)){return false}
return true}
scrollIntoView(id,instant){return new Promise((resolve,reject)=>{if(id==null)id=Array.isArray(this.selected)?this.selected[0]:this.selected
let nd=this.get(id)
if(nd==null)return
let item=query(this.box).find('#node_'+w2utils.escapeId(id)).get(0)
item.scrollIntoView({block:'center',inline:'center',behavior:instant?'atuo':'smooth'})
setTimeout(()=>{this.resize();resolve()},instant?0:500)})}
dblClick(id,event){let nd=this.get(id)
let edata=this.trigger('dblClick',{target:id,originalEvent:event,object:nd})
if(edata.isCancelled===true)return
if(this.editable){this.edit(id)}else{this.toggle(id)}
edata.finish()}
mouseDown(id,event){let self=this
if(this.reorder){this.last.move={x:event.screenX,y:event.screenY,divX:0,divY:0,reorder:true,moved:false}
let mv=this.last.move
let body=query(this.box).find('.w2ui-sidebar-body')
if(!mv.ghost){let node=query(this.box).find(`#node_${w2utils.escapeId(id)}`)
mv.offsetY=event.offsetY
mv.target=id
mv.pos={top:node.get(0).offsetTop-1,left:node.get(0).offsetLeft}
let clone=query(node.find('.w2ui-node-data').get(0).cloneNode(true))
mv.node=node
mv.nodeSub=node.next()
body.append('<div id="sidebar_'+this.name+'_ghost" class="w2ui-node w2ui-ghost"></div>')
query(this.box).find('#sidebar_'+this.name+'_ghost').append(clone)
mv.ghost=query(this.box).find('#sidebar_'+this.name+'_ghost')
mv.ghost.css({display:'none'})
mv.restore=()=>{mv.resetReorder()
this.refresh()}
mv.resetReorder=()=>{this.last.move=null
query(this.box).find(`#sidebar_${this.name}_ghost`).remove()
query(document).off(`.w2ui-${this.name}-reorder`)}}
query(document).on(`mousemove.w2ui-${this.name}-reorder`,_mouseMove).on(`mouseup.w2ui-${this.name}-reorder`,_mouseStop)}
function _mouseMove(event){if(!event.target.tagName){return}
let mv=self.last.move
mv.divX=(event.screenX-mv.x)
mv.divY=(event.screenY-mv.y)
if(Math.abs(mv.divX)<=1&&Math.abs(mv.divY)<=1)return
if(self.reorder==true&&mv.reorder&&!mv.moved){let edata=self.trigger('dragStart',{target:mv.target,moved:true,node:self.get(mv.target),mv,originalEvent:event})
if(edata.isCancelled===true){mv.restore()
return}
let rect=mv.node.get(0).getBoundingClientRect()
mv.moved=true
mv.node.html('').removeAttr('id','data-id').addClass('w2ui-reorder-empty').css({height:rect.height+'px'})
if(mv.node.next().css('display')!=='none'){let rect=mv.node.next().get(0).getBoundingClientRect()
mv.node.next().html('<div class="w2ui-reorder-empty-sub"></div>').css({height:rect.height+'px'})}
mv.ghost.css({display:'block'})
edata.finish()}
mv.ghost.css({top:(mv.pos.top+mv.divY)+'px',left:0})
let over=query(event.target).closest('.w2ui-node, .w2ui-node-group')
let id=over.attr('data-id')
if(query(event.target).hasClass('w2ui-sidebar-body')&&event.layerY>5&&!mv.append){let edata=self.trigger('dragOver',{target:mv.target,append:true,mv,originalEvent:event})
if(edata.isCancelled===true){return}
mv.ghost.before(mv.node)
mv.ghost.before(mv.nodeSub)
mv.append=true
mv.moveBefore=null
edata.finish()}else if(id!=null&&id!=mv.moveBefore){mv.append=false
mv.moveBefore=id
let edata=self.trigger('dragOver',{target:mv.target,moveBefore:id,mv,originalEvent:event})
if(edata.isCancelled===true){return}
let el=query(self.box).find(`#node_${w2utils.escapeId(id)}`)
el.before(mv.node)
el.before(mv.nodeSub)
edata.finish()}}
function _mouseStop(event){let mv=self.last.move
mv.resetReorder()
if(mv.moved){if(((mv.moveBefore!=null&&mv.target!=mv.moveBefore)||mv.append)){let edata=self.trigger('reorder',{target:mv.target,moveBefore:mv.moveBefore,append:mv.append,originalEvent:event})
if(edata.isCancelled===true){self.refresh()
return}
let target=self.get(mv.target)
let targetInd=target.parent.nodes.indexOf(target)
let cut=target.parent.nodes.splice(targetInd,1)
if(mv.append){self.nodes.push(...cut)
cut.forEach(nd=>nd.parent=self)}else{let before=self.get(mv.moveBefore)
let beforeInd=before.parent.nodes.indexOf(before)
cut.forEach(nd=>nd.parent=before.parent)
before.parent.nodes.splice(beforeInd,0,...cut)}
self.refresh()
edata.finish()}else{self.refresh()}}}}
edit(id){let self=this
let node=query(this.box).find('#node_'+w2utils.escapeId(id))
let text=node.find('.w2ui-node-text')
let edata=this.trigger('edit',{target:id,el:node,textEl:text})
if(edata.isCancelled===true){return}
this.last.renaming=true
node.addClass('w2ui-editing')
text.addClass('w2ui-focus').css('pointer-events','all').attr('contenteditable','plaintext-only').on('blur.node-editing',event=>{setTimeout(_rename,0)}).on('keydown.node-editing',event=>{if(event.keyCode==13)_rename(event)
if(event.keyCode==27)_rename(event,true)}).get(0).focus()
let original=text.text()
w2utils.setCursorPosition(text[0],0,text.text().length)
edata.finish()
return text.get(0)
function _rename(event,cancel){let renameTo=text.text()
node.removeClass('w2ui-editing')
text.removeClass('w2ui-focus').css('pointer-events','none').removeAttr('contenteditable').off('.node-editing')
if(!cancel&&self.last.renaming&&original!==renameTo){let edata=self.trigger('rename',{target:id,text_previous:original,text_new:renameTo,originalEvent:event})
if(edata.isCancelled===true){text.text(original)
self.last.renaming=false
self.focus()
return}
self.set(id,{text:renameTo})
edata.finish()}
if(cancel){self.set(id,{text:original})}
self.last.renaming=false
self.focus()}}
contextMenu(id,event){let nd=this.get(id)
if(Array.isArray(this.selected)){if(!this.selected.includes(id))this.click(id)}else{if(id!=this.selected)this.click(id)}
let edata=this.trigger('contextMenu',{target:id,originalEvent:event,object:nd,allowOnDisabled:false})
if(edata.isCancelled===true)return
if(nd.disabled&&!edata.allowOnDisabled)return
if(this.menu.length>0){w2menu.show({name:this.name+'_menu',anchor:document.body,items:this.menu,originalEvent:event}).select(evt=>{this.menuClick(id,parseInt(evt.detail.index),event)})}
if(event.preventDefault)event.preventDefault()
edata.finish()}
menuClick(itemId,index,event){let edata=this.trigger('menuClick',{target:itemId,originalEvent:event,menuIndex:index,menuItem:this.menu[index]})
if(edata.isCancelled===true)return
edata.finish()}
goFlat(){let edata=this.trigger('flat',{goFlat:!this.flat})
if(edata.isCancelled===true)return
this.flat=!this.flat
this.refresh()
edata.finish()}
render(box){let time=Date.now()
let obj=this
if(typeof box=='string')box=query(box).get(0)
let edata=this.trigger('render',{target:this.name,box:box??this.box})
if(edata.isCancelled===true)return
if(box!=null){this.unmount()
this.box=box}
if(!this.box)return
query(this.box).attr('name',this.name).addClass('w2ui-reset w2ui-sidebar').html(`<div>
                <div class="w2ui-sidebar-top"></div>
                <input id="sidebar_${this.name}_focus" ${(this.tabIndex ? 'tabindex="' + this.tabIndex + '"' : '')}
                    style="position: absolute; top: 0; right: 0; width: 1px; z-index: -1; opacity: 0"
                    ${(w2utils.isMobile ? 'readonly' : '')}/>
                <div class="w2ui-sidebar-body"></div>
                <div class="w2ui-sidebar-bottom"></div>
            </div>`)
let rect=query(this.box).get(0).getBoundingClientRect()
query(this.box).find(':scope > div').css({width:rect.width+'px',height:rect.height+'px'})
query(this.box).get(0).style.cssText+=this.style
let kbd_timer
query(this.box).find('#sidebar_'+this.name+'_focus').on('focus',function(event){clearTimeout(kbd_timer)
if(!obj.hasFocus)obj.focus(event)}).on('blur',function(event){kbd_timer=setTimeout(()=>{if(obj.hasFocus){obj.blur(event)}},100)}).on('keydown',function(event){w2ui[obj.name].keydown.call(w2ui[obj.name],event)})
query(this.box).off('mousedown').on('mousedown',function(event){setTimeout(()=>{if(['INPUT','TEXTAREA','SELECT'].indexOf(event.target.tagName.toUpperCase())==-1){let $input=query(obj.box).find('#sidebar_'+obj.name+'_focus')
if(document.activeElement!=$input.get(0)&&$input.length>0){$input.get(0).focus()}}},1)})
let flatHTML=`<div class="w2ui-flat w2ui-flat-${(this.flat ? 'right' : 'left')}" ${this.flatButton == false ? 'style="display: none"' : ''}></div>`
if(this.topHTML!==''||flatHTML!==''){query(this.box).find('.w2ui-sidebar-top').html(this.topHTML+flatHTML)
query(this.box).find('.w2ui-sidebar-body').css('top',query(this.box).find('.w2ui-sidebar-top').get(0)?.clientHeight+'px')
query(this.box).find('.w2ui-flat').off('click').on('click',event=>{this.goFlat()})}
if(this.bottomHTML!==''){query(this.box).find('.w2ui-sidebar-bottom').html(this.bottomHTML)
query(this.box).find('.w2ui-sidebar-body').css('bottom',query(this.box).find('.w2ui-sidebar-bottom').get(0)?.clientHeight+'px')}
this.last.observeResize=new ResizeObserver(()=>{this.resize()})
this.last.observeResize.observe(this.box)
edata.finish()
this.refresh()
return Date.now()-time}
update(id,options={}){let nd=this.get(id)
let level
if(nd){let $el=query(this.box).find('#node_'+w2utils.escapeId(nd.id))
if(nd.group){if(options.text){nd.text=options.text
$el.find('.w2ui-group-text').replace(typeof nd.text=='function'?nd.text.call(this,nd):'<span class="w2ui-group-text">'+nd.text+'</span>')
delete options.text}
if(options.class){nd.class=options.class
level=$el.data('level')
$el.get(0).className='w2ui-node-group w2ui-level-'+level+(nd.class?' '+nd.class:'')
delete options.class}
if(options.style){nd.style=options.style
$el.get(0).nextElementSibling.style=nd.style+';'+(!nd.hidden&&nd.expanded?'':'display: none;')
delete options.style}}else{if(options.icon){let $icon=$el.find('.w2ui-node-image > span')
if($icon.length>0){nd.icon=options.icon
$icon[0].className=(typeof nd.icon=='function'?nd.icon.call(this,nd):nd.icon)
delete options.icon}}
if(options.count){nd.count=options.count
let txt=nd.count??this.badge.text
let style=this.badge.style
let last=this.last.badge[nd.id]
if(typeof txt=='function')txt=txt.call(this,nd,level)
$el.find('.w2ui-node-badge').html(txt).attr('style',`${style}; ${last?.style ?? ''}`)
if($el.find('.w2ui-node-badge').length>0)delete options.count}
if(options.class&&$el.length>0){nd.class=options.class
level=$el.data('level')
$el[0].className='w2ui-node w2ui-level-'+level+(nd.selected?' w2ui-selected':'')+(nd.disabled?' w2ui-disabled':'')+(nd.class?' '+nd.class:'')
delete options.class}
if(options.text){nd.text=options.text
$el.find('.w2ui-node-text').html(typeof nd.text=='function'?nd.text.call(this,nd):nd.text)
delete options.text}
if(options.style&&$el.length>0){let $txt=$el.find('.w2ui-node-text')
nd.style=options.style
$txt[0].style=nd.style
delete options.style}}}
return options}
refresh(id,noBinding){if(this.box==null)return
let time=Date.now()
let self=this
let edata=this.trigger('refresh',{target:(id!=null?id:this.name),nodeId:(id!=null?id:null),fullRefresh:(id!=null?false:true)})
if(edata.isCancelled===true)return
if(this.flatButton==true){query(this.box).find('.w2ui-sidebar-top .w2ui-flat').show().removeClass('w2ui-flat-left w2ui-flat-right').addClass(` w2ui-flat-${(this.flat ? 'right' : 'left')}`)}else{query(this.box).find('.w2ui-sidebar-top .w2ui-flat').hide()}
query(this.box).find(':scope > div').removeClass('w2ui-sidebar-flat').addClass(this.flat?'w2ui-sidebar-flat':'').css({width:query(this.box).get(0)?.clientWidth+'px',height:query(this.box).get(0)?.clientHeight+'px'})
if(this.nodes.length>0&&this.nodes[0].parent==null){let tmp=this.nodes
this.nodes=[]
this.add(this,tmp)}
let obj=this
let node
let nodeSubId
if(id==null){node=this
nodeSubId='.w2ui-sidebar-body'}else{node=this.get(id)
if(node==null)return
nodeSubId='#node_'+w2utils.escapeId(node.id)+'_sub'}
let nodeId='#node_'+w2utils.escapeId(node.id)
let nodeHTML
if(node!==this){nodeHTML=getNodeHTML(node)
query(this.box).find(nodeId).before('<div id="sidebar_'+this.name+'_tmp"></div>')
query(this.box).find(nodeId).remove()
query(this.box).find(nodeSubId).remove()
query(this.box).find('#sidebar_'+this.name+'_tmp').before(nodeHTML)
query(this.box).find('#sidebar_'+this.name+'_tmp').remove()}
let div=query(this.box).find(':scope > div').get(0)
let scroll={top:div?.scrollTop,left:div?.scrollLeft}
query(this.box).find(nodeSubId).html('')
for(let i=0;i<node.nodes.length;i++){let subNode=node.nodes[i]
nodeHTML=getNodeHTML(subNode)
query(this.box).find(nodeSubId).append(nodeHTML)
if(subNode.nodes.length!==0){this.refresh(subNode.id,true)}else{let edata2=this.trigger('refresh',{target:subNode.id})
if(edata2.isCancelled===true)return
edata2.finish()}}
if(div){div.scrollTop=scroll.top
div.scrollLeft=scroll.left}
if(!noBinding){let els=query(this.box).find(`${nodeId}, ${nodeId} .w2ui-eaction, ${nodeSubId} .w2ui-eaction`)
w2utils.bindEvents(els,this)}
edata.finish()
return Date.now()-time
function getNodeHTML(nd){let html=''
let icon=nd.icon
if(icon==null)icon=obj.icon
let tmp=nd.parent
let level=0
while(tmp&&tmp.parent!=null){tmp=tmp.parent
level++}
if(nd.caption!=null&&nd.text==null)nd.text=nd.caption
if(nd.caption!=null){console.log('NOTICE: sidebar node.caption property is deprecated, please use node.text. Node -> ',nd)
nd.text=nd.caption}
if(Array.isArray(nd.nodes)&&nd.nodes.length>0)nd.collapsible=true
if(nd.group){let text=w2utils.lang(typeof nd.text=='function'?nd.text.call(obj,nd,level):nd.text)
if(String(text).substr(0,5)!='<span'){text=`<span class="w2ui-group-text">${text}</span>`}
html=`
                    <div id="node_${nd.id}" data-id="${nd.id}" data-level="${level}" style="${nd.hidden ? 'display: none' : ''}"
                        class="w2ui-node-group w2ui-level-${level} ${nd.class ? nd.class : ''} w2ui-eaction"
                        data-click="toggle|${nd.id}"
                        data-contextmenu="contextMenu|${nd.id}|event"
                        data-mouseenter="showPlus|this|inherit"
                        data-mouseleave="showPlus|this|transparent">
                        ${nd.groupShowHide && nd.collapsible
                            ? `<span>${!nd.hidden&&nd.expanded?w2utils.lang('Hide'):w2utils.lang('Show')}</span>`
                            : '<span></span>'
                        } ${text}
                    </div>
                    <div class="w2ui-node-sub" id="node_${nd.id}_sub" style="${nd.style}; ${!nd.hidden && nd.expanded ? '' : 'display: none;'}">
                </div>`
if(obj.flat){html=`
                        <div class="w2ui-node-group" id="node_${nd.id}" data-id="${nd.id}"><span>&#160;</span></div>
                        <div id="node_${nd.id}_sub" style="${nd.style}; ${!nd.hidden && nd.expanded ? '' : 'display: none;'}"></div>`}}else{if(nd.selected&&!nd.disabled)obj.selected=nd.id
let image=''
if(icon){if(icon instanceof Object){let text=(typeof icon.text=='function'?(icon.text.call(obj,nd,level)??''):icon.text)
image=`
                            <div class="w2ui-node-image w2ui-eaction" style="${obj.icon.style ?? ''}; pointer-events: all"
                                data-mouseEnter="mouseAction|Enter|this|${nd.id}|event|icon"
                                data-mouseLeave="mouseAction|Leave|this|${nd.id}|event|icon"
                                data-click="mouseAction|click|this|${nd.id}|event|icon">
                                    ${text}
                            </div>
                        `}else{image=`
                            <div class="w2ui-node-image">
                                <span class="${typeof icon == 'function' ? icon.call(obj, nd, level) : icon}"></span>
                            </div>`}}
let expand=''
let counts=''
if(self.badge!=null||nd.count!=null){let txt=nd.count??self.badge?.text
let style=self.badge?.style
let last=obj.last.badge[nd.id]
if(typeof txt=='function')txt=txt.call(self,nd,level)
if(txt){counts=`
                            <div class="w2ui-node-badge w2ui-eaction ${nd.count != null ? 'w2ui-node-count' : ''} ${last?.className ?? ''}"
                                style="${style ?? ''};${last?.style ?? ''}"
                                data-mouseEnter="mouseAction|Enter|this|${nd.id}|event|badge"
                                data-mouseLeave="mouseAction|Leave|this|${nd.id}|event|badge"
                                data-click="mouseAction|click|this|${nd.id}|event|badge"
                            >
                                ${txt}
                            </div>`}}
let classes=['w2ui-node',`w2ui-level-${level}`,'w2ui-eaction']
if(nd.selected)classes.push('w2ui-selected')
if(nd.disabled)classes.push('w2ui-disabled')
if(nd.class)classes.push(nd.class)
if(nd.collapsible===true){let toggleClasses=['w2ui-sb-toggle','w2ui-eaction',(nd.expanded?'w2ui-expanded':'w2ui-collapsed')]
if(self.toggleAlign=='left')toggleClasses.push('w2ui-left-toggle')
expand=`<div class="${toggleClasses.join(' ')}" data-click="toggle|${nd.id}"><span></span></div>`
classes.push('w2ui-has-children')}
let text=w2utils.lang(typeof nd.text=='function'?nd.text.call(obj,nd,level):nd.text)
let nodeOffset=nd.parent?.childOffset??0
if(level===0&&nd.collapsible===true&&self.toggleAlign=='left'){nodeOffset+=12}
html=`
                    <div id="node_${nd.id}" class="${classes.join(' ')}" data-id="${nd.id}" data-level="${level}"
                        style="${nd.hidden ? 'display: none;' : ''}"
                        data-click="click|${nd.id}|event"
                        data-dblclick="dblClick|${nd.id}|event"
                        data-mouseDown="mouseDown|${nd.id}|event"
                        data-contextmenu="contextMenu|${nd.id}|event"
                        data-mouseEnter="mouseAction|Enter|this|${nd.id}|event"
                        data-mouseLeave="mouseAction|Leave|this|${nd.id}|event"
                    >
                        ${obj.handle.text
                            ? `<div class="w2ui-node-handle w2ui-eaction"style="width: ${obj.handle.width}px; ${obj.handle.style}"
data-mouseEnter="mouseAction|Enter|this|${nd.id}|event|handle"
data-mouseLeave="mouseAction|Leave|this|${nd.id}|event|handle"
data-click="mouseAction|click|this|${nd.id}|event|handle">${typeof obj.handle.text=='function'?obj.handle.text.call(obj,nd,level)??'':obj.handle.text}</div>`
                            : ''
                        }
                      <div class="w2ui-node-data" style="margin-left: ${(level * obj.levelPadding) + nodeOffset + obj.handle.width}px">
                            ${expand} ${image} ${counts}
                            <div class="w2ui-node-text ${!image ? 'no-icon' : ''}" style="${nd.style || ''}">${text}</div>
                       </div>
                    </div>
                    <div class="w2ui-node-sub" id="node_${nd.id}_sub" style="${nd.style}; ${!nd.hidden && nd.expanded ? '' : 'display: none;'}"></div>`
if(obj.flat){html=`
                        <div id="node_${nd.id}" class="${classes.join(' ')}" data-id="${nd.id}" style="${nd.hidden ? 'display: none;' : ''}"
                            data-click="click|${nd.id}|event"
                            data-dblclick="dblClick|${nd.id}|event"
                            data-contextmenu="contextMenu|${nd.id}|event"
                            data-mouseEnter="mouseAction|Enter|this|${nd.id}|event|tooltip"
                            data-mouseLeave="mouseAction|Leave|this|${nd.id}|event|tooltip"
                        >
                            <div class="w2ui-node-data w2ui-node-flat">${image}</div>
                        </div>
                        <div class="w2ui-node-sub" id="node_${nd.id}_sub" style="${nd.style}; ${!nd.hidden && nd.expanded ? '' : 'display: none;'}"></div>`}}
return html}}
mouseAction(action,anchor,nodeId,event,type){let edata
let node=this.get(nodeId)
if(type==null){edata=this.trigger('mouse'+action,{target:node.id,node,originalEvent:event})}
if(type=='tooltip'){let text=w2utils.lang(typeof node.text=='function'?node.text.call(this,node):node.text)
let tooltip=text+(node.count||node.count===0?' - <span class="w2ui-node-badge w2ui-node-count">'+node.count+'</span>':'')
if(action=='Leave')tooltip=''
this.tooltip(anchor,tooltip)}
if(type=='handle'){if(action=='click'){let onClick=this.handle.onClick
if(typeof onClick=='function'){onClick.call(this,node,event)}}else{let tooltip=this.handle.tooltip
if(typeof tooltip=='function'){tooltip=tooltip.call(this,node,event)}
if(action=='Leave')tooltip=''
this.otherTooltip(anchor,tooltip)}}
if(type=='icon'){if(action=='click'){let onClick=this.icon.onClick
if(typeof onClick=='function'){onClick.call(this,node,event)}}else{let tooltip=this.icon.tooltip
if(typeof tooltip=='function'){tooltip=tooltip.call(this,node,event)}
if(action=='Leave')tooltip=''
this.otherTooltip(anchor,tooltip)}}
if(type=='badge'){if(action=='click'){let onClick=this.badge?.onClick
if(typeof onClick=='function'){onClick.call(this,node,event)}}else{let tooltip=this.badge?.tooltip
if(typeof tooltip=='function'){tooltip=tooltip.call(this,node,event)}
if(action=='Leave')tooltip=''
this.otherTooltip(anchor,tooltip)}}
edata?.finish()}
tooltip(el,text){let $el=query(el).find('.w2ui-node-data')
if(text!==''){w2tooltip.show({anchor:$el.get(0),name:this.name+'_tooltip',html:text,position:'right|left'})}else{w2tooltip.hide(this.name+'_tooltip')}}
otherTooltip(el,text){if(text!==''){w2tooltip.show({anchor:el,name:this.name+'_tooltip',html:text,position:'top|bottom'})}else{w2tooltip.hide(this.name+'_tooltip')}}
showPlus(el,color){query(el).find('span:nth-child(1)').css('color',color)}
resize(){let time=Date.now()
let edata=this.trigger('resize',{target:this.name})
if(edata.isCancelled===true)return
if(this.box!=null){let rect=query(this.box).get(0).getBoundingClientRect()
query(this.box).css('overflow','hidden')
query(this.box).find(':scope > div').css({width:rect.width+'px',height:rect.height+'px'})}
edata.finish()
return Date.now()-time}
destroy(){let edata=this.trigger('destroy',{target:this.name})
if(edata.isCancelled===true)return
if(query(this.box).find('.w2ui-sidebar-body').length>0){this.unmount()}
delete w2ui[this.name]
edata.finish()}
unmount(){super.unmount()
this.last.observeResize?.disconnect()}
lock(msg,showSpinner){let args=Array.from(arguments)
args.unshift(this.box)
w2utils.lock(...args)}
unlock(speed){w2utils.unlock(this.box,speed)}}
class w2tabs extends w2base{constructor(options){super(options.name)
this.box=null
this.name=null
this.active=null
this.reorder=false
this.flow='down'
this.tooltip='top|left'
this.tabs=[]
this.routeData={}
this.last={}
this.right=''
this.style=''
this.onClick=null
this.onMouseEnter=null
this.onMouseLeave=null
this.onMouseDown=null
this.onMouseUp=null
this.onClose=null
this.onRender=null
this.onRefresh=null
this.onResize=null
this.onDestroy=null
this.tab_template={id:null,text:null,route:null,hidden:false,disabled:false,closable:false,tooltip:null,style:'',onClick:null,onRefresh:null,onClose:null}
let tabs=options.tabs
delete options.tabs
Object.assign(this,options)
if(Array.isArray(tabs))this.add(tabs)
options.tabs=tabs
if(typeof this.box=='string')this.box=query(this.box).get(0)
if(this.box)this.render(this.box)}
add(tab){return this.insert(null,tab)}
insert(id,tabs){if(!Array.isArray(tabs))tabs=[tabs]
let proms=[]
tabs.forEach(tab=>{if(tab.id==null){console.log(`ERROR: The parameter "id" is required but not supplied. (obj: ${this.name})`)
return}
if(!w2utils.checkUniqueId(tab.id,this.tabs,'tabs',this.name))return
let it=Object.assign({},this.tab_template,tab)
if(id==null){this.tabs.push(it)
proms.push(this.animateInsert(null,it))}else{let middle=this.get(id,true)
let before=this.tabs[middle].id
this.tabs.splice(middle,0,it)
proms.push(this.animateInsert(before,it))}})
return Promise.all(proms)}
remove(){let effected=0
Array.from(arguments).forEach(it=>{let tab=this.get(it)
if(!tab)return
effected++
this.tabs.splice(this.get(tab.id,true),1)
query(this.box).find(`#tabs_${this.name}_tab_${w2utils.escapeId(tab.id)}`).remove()})
this.resize()
return effected}
select(id){if(this.active==id||this.get(id)==null)return false
this.active=id
this.refresh()
return true}
set(id,tab){let index=this.get(id,true)
if(index==null)return false
w2utils.extend(this.tabs[index],tab)
this.refresh(id)
return true}
get(id,returnIndex){if(arguments.length===0){let all=[]
for(let i1=0;i1<this.tabs.length;i1++){if(this.tabs[i1].id!=null){all.push(this.tabs[i1].id)}}
return all}else{for(let i2=0;i2<this.tabs.length;i2++){if(this.tabs[i2].id==id){return(returnIndex===true?i2:this.tabs[i2])}}}
return null}
show(){let effected=[]
Array.from(arguments).forEach(it=>{let tab=this.get(it)
if(!tab||tab.hidden===false)return
tab.hidden=false
effected.push(tab.id)})
setTimeout(()=>{effected.forEach(it=>{this.refresh(it);this.resize()})},15)
return effected}
hide(){let effected=[]
Array.from(arguments).forEach(it=>{let tab=this.get(it)
if(!tab||tab.hidden===true)return
tab.hidden=true
effected.push(tab.id)})
setTimeout(()=>{effected.forEach(it=>{this.refresh(it);this.resize()})},15)
return effected}
enable(){let effected=[]
Array.from(arguments).forEach(it=>{let tab=this.get(it)
if(!tab||tab.disabled===false)return
tab.disabled=false
effected.push(tab.id)})
setTimeout(()=>{effected.forEach(it=>{this.refresh(it)})},15)
return effected}
disable(){let effected=[]
Array.from(arguments).forEach(it=>{let tab=this.get(it)
if(!tab||tab.disabled===true)return
tab.disabled=true
effected.push(tab.id)})
setTimeout(()=>{effected.forEach(it=>{this.refresh(it)})},15)
return effected}
dragMove(event){if(!this.last.reordering)return
let self=this
let info=this.last.moving
let tab=this.tabs[info.index]
let next=_find(info.index,1)
let prev=_find(info.index,-1)
let $el=query(this.box).find('#tabs_'+this.name+'_tab_'+w2utils.escapeId(tab.id))
if(info.divX>0&&next){let $nextEl=query(this.box).find('#tabs_'+this.name+'_tab_'+w2utils.escapeId(next.id))
let width1=parseInt($el.get(0).clientWidth)
let width2=parseInt($nextEl.get(0).clientWidth)
if(width1<width2){width1=Math.floor(width1/3)
width2=width2-width1}else{width1=Math.floor(width2/3)
width2=width2-width1}
if(info.divX>width2){let index=this.tabs.indexOf(next)
this.tabs.splice(info.index,0,this.tabs.splice(index,1)[0])
info.$tab.before($nextEl.get(0))
info.$tab.css('opacity',0)
Object.assign(this.last.moving,{index:index,divX:-width1,x:event.pageX+width1,left:info.left+info.divX+width1})
return}}
if(info.divX<0&&prev){let $prevEl=query(this.box).find('#tabs_'+this.name+'_tab_'+w2utils.escapeId(prev.id))
let width1=parseInt($el.get(0).clientWidth)
let width2=parseInt($prevEl.get(0).clientWidth)
if(width1<width2){width1=Math.floor(width1/3)
width2=width2-width1}else{width1=Math.floor(width2/3)
width2=width2-width1}
if(Math.abs(info.divX)>width2){let index=this.tabs.indexOf(prev)
this.tabs.splice(info.index,0,this.tabs.splice(index,1)[0])
$prevEl.before(info.$tab)
info.$tab.css('opacity',0)
Object.assign(info,{index:index,divX:width1,x:event.pageX-width1,left:info.left+info.divX-width1})
return}}
function _find(ind,inc){ind+=inc
let tab=self.tabs[ind]
if(tab&&tab.hidden){tab=_find(ind,inc)}
return tab}}
mouseAction(action,id,event){let tab=this.get(id)
let edata=this.trigger('mouse'+action,{target:id,tab,object:tab,originalEvent:event})
if(edata.isCancelled===true||tab?.disabled||tab?.hidden)return
switch(action){case'Enter':this.tooltipShow(id)
break
case'Leave':this.tooltipHide(id)
break
case'Down':this.initReorder(id,event)
break
case'Up':break}
edata.finish()}
tooltipShow(id){let tab=this.get(id)
let el=query(this.box).find('#tabs_'+this.name+'_tab_'+w2utils.escapeId(id)).get(0)
if(this.tooltip==null||tab?.disabled||this.last.reordering){return}
let pos=this.tooltip
let txt=tab?.tooltip
if(typeof txt=='function')txt=txt.call(this,tab)
w2tooltip.show({anchor:el,name:this.name+'_tooltip',html:txt,position:pos})}
tooltipHide(id){if(this.tooltip==null)return
w2tooltip.hide(this.name+'_tooltip')}
getTabHTML(id){let index=this.get(id,true)
let tab=this.tabs[index]
if(tab==null)return false
if(tab.text==null&&tab.caption!=null)tab.text=tab.caption
if(tab.tooltip==null&&tab.hint!=null)tab.tooltip=tab.hint
if(tab.caption!=null){console.log('NOTICE: tabs tab.caption property is deprecated, please use tab.text. Tab -> ',tab)}
if(tab.hint!=null){console.log('NOTICE: tabs tab.hint property is deprecated, please use tab.tooltip. Tab -> ',tab)}
let text=tab.text
if(typeof text=='function')text=text.call(this,tab)
if(text==null)text=''
let closable=''
let addStyle=''
if(tab.hidden){addStyle+='display: none;'}
if(tab.disabled){addStyle+='opacity: 0.2;'}
if(tab.closable&&!tab.disabled){closable=`<div class="w2ui-tab-close w2ui-eaction ${this.active === tab.id ? 'active' : ''}"
                data-mousedown="stop" data-mouseup="clickClose|${tab.id}|event">
            </div>`}
return`
            <div id="tabs_${this.name}_tab_${tab.id}" style="${addStyle} ${tab.style}"
                class="w2ui-tab w2ui-eaction ${this.active === tab.id ? 'active' : ''} ${tab.closable ? 'closable' : ''} ${tab.class ? tab.class : ''}"
                data-mouseenter="mouseAction|Enter|${tab.id}|event]"
                data-mouseleave="mouseAction|Leave|${tab.id}|event]"
                data-mousedown="mouseAction|Down|${tab.id}|event"
                data-mouseup="mouseAction|Up|${tab.id}|event"
                data-click="click|${tab.id}|event"
               >
                    ${w2utils.lang(text) + closable}
            </div>`}
refresh(id){let time=Date.now()
if(this.flow=='up'){query(this.box).addClass('w2ui-tabs-up')}else{query(this.box).removeClass('w2ui-tabs-up')}
let edata=this.trigger('refresh',{target:(id!=null?id:this.name),object:this.get(id)})
if(edata.isCancelled===true)return
if(id==null){for(let i=0;i<this.tabs.length;i++){this.refresh(this.tabs[i].id)}}else{let selector='#tabs_'+this.name+'_tab_'+w2utils.escapeId(id)
let $tab=query(this.box).find(selector)
let tabHTML=this.getTabHTML(id)
if($tab.length===0){query(this.box).find('#tabs_'+this.name+'_right').before(tabHTML)}else{if(query(this.box).find('.tab-animate-insert').length==0){$tab.replace(tabHTML)}}
w2utils.bindEvents(query(this.box).find(`${selector}, ${selector} .w2ui-eaction`),this)}
query(this.box).find('#tabs_'+this.name+'_right').html(this.right)
edata.finish()
return Date.now()-time}
render(box){let time=Date.now()
if(typeof box=='string')box=query(box).get(0)
let edata=this.trigger('render',{target:this.name,box:box??this.box})
if(edata.isCancelled===true)return
if(box!=null){this.unmount()
this.box=box}
if(!this.box)return false
let html=`
            <div class="w2ui-tabs-line"></div>
            <div class="w2ui-scroll-wrapper w2ui-eaction" data-mousedown="resize">
                <div id="tabs_${this.name}_right" class="w2ui-tabs-right">${this.right}</div>
            </div>
            <div class="w2ui-scroll-left w2ui-eaction" data-click='["scroll","left"]'></div>
            <div class="w2ui-scroll-right w2ui-eaction" data-click='["scroll","right"]'></div>`
query(this.box).attr('name',this.name).addClass('w2ui-reset w2ui-tabs').html(html)
if(query(this.box).length>0){query(this.box)[0].style.cssText+=this.style}
w2utils.bindEvents(query(this.box).find('.w2ui-eaction'),this)
this.last.observeResize=new ResizeObserver(()=>{this.resize()})
this.last.observeResize.observe(this.box)
edata.finish()
this.refresh()
this.resize()
return Date.now()-time}
initReorder(id,event){if(!this.reorder)return
let self=this
let $tab=query(this.box).find('#tabs_'+this.name+'_tab_'+w2utils.escapeId(id))
let tabIndex=this.get(id,true)
let $ghost=query($tab.get(0).cloneNode(true))
let edata
$ghost.attr('id','#tabs_'+this.name+'_tab_ghost')
this.last.moving={index:tabIndex,indexFrom:tabIndex,$tab:$tab,$ghost:$ghost,divX:0,left:$tab.get(0).getBoundingClientRect().left,parentX:query(this.box).get(0).getBoundingClientRect().left,x:event.pageX,opacity:$tab.css('opacity')}
query(document).off('.w2uiTabReorder').on('mousemove.w2uiTabReorder',function(event){if(!self.last.reordering){edata=self.trigger('reorder',{target:self.tabs[tabIndex].id,indexFrom:tabIndex,tab:self.tabs[tabIndex]})
if(edata.isCancelled===true)return
w2tooltip.hide(this.name+'_tooltip')
self.last.reordering=true
$ghost.addClass('moving')
$ghost.css({'pointer-events':'none','position':'absolute','left':$tab.get(0).getBoundingClientRect().left})
$tab.css('opacity',0)
query(self.box).find('.w2ui-scroll-wrapper').append($ghost.get(0))
query(self.box).find('.w2ui-tab-close').hide()}
self.last.moving.divX=event.pageX-self.last.moving.x
$ghost.css('left',(self.last.moving.left-self.last.moving.parentX+self.last.moving.divX)+'px')
self.dragMove(event)}).on('mouseup.w2uiTabReorder',function(){query(document).off('.w2uiTabReorder')
$ghost.css({'transition':'0.1s','left':self.last.moving.$tab.get(0).getBoundingClientRect().left-self.last.moving.parentX})
query(self.box).find('.w2ui-tab-close').show()
$ghost.remove()
$tab.css({opacity:self.last.moving.opacity})
if(self.last.reordering){edata.finish({indexTo:self.last.moving.index})}
self.last.reordering=false})}
scroll(direction,instant){return new Promise((resolve,reject)=>{let scrollBox=query(this.box).find('.w2ui-scroll-wrapper')
let scrollLeft=scrollBox.get(0).scrollLeft
let right=scrollBox.find('.w2ui-tabs-right').get(0)
let width1=scrollBox.parent().get(0).getBoundingClientRect().width
let width2=scrollLeft+parseInt(right.offsetLeft)+parseInt(right.clientWidth)
switch(direction){case'left':{let scroll=scrollLeft-width1+50
if(scroll<=0)scroll=0
scrollBox.get(0).scrollTo({top:0,left:scroll,behavior:instant?'atuo':'smooth'})
break}
case'right':{let scroll=scrollLeft+width1-50
if(scroll>=width2-width1)scroll=width2-width1
scrollBox.get(0).scrollTo({top:0,left:scroll,behavior:instant?'atuo':'smooth'})
break}}
setTimeout(()=>{this.resize();resolve()},instant?0:350)})}
scrollIntoView(id,instant){return new Promise((resolve,reject)=>{if(id==null)id=this.active
let tab=this.get(id)
if(tab==null)return
let tabEl=query(this.box).find('#tabs_'+this.name+'_tab_'+w2utils.escapeId(id)).get(0)
tabEl.scrollIntoView({block:'start',inline:'center',behavior:instant?'atuo':'smooth'})
setTimeout(()=>{this.resize();resolve()},instant?0:500)})}
resize(){let time=Date.now()
if(this.box==null)return
let edata=this.trigger('resize',{target:this.name})
if(edata.isCancelled===true)return
if(this.box!=null){let box=query(this.box)
box.find('.w2ui-scroll-left, .w2ui-scroll-right').hide()
let scrollBox=box.find('.w2ui-scroll-wrapper').get(0)
let $right=box.find('.w2ui-tabs-right')
let boxWidth=box.get(0).getBoundingClientRect().width
let itemsWidth=($right.length>0?$right[0].offsetLeft+$right[0].clientWidth:0)
if(boxWidth<itemsWidth){if(scrollBox.scrollLeft>0){box.find('.w2ui-scroll-left').show()}
if(boxWidth<itemsWidth-scrollBox.scrollLeft){box.find('.w2ui-scroll-right').show()}}}
edata.finish()
return Date.now()-time}
destroy(){let edata=this.trigger('destroy',{target:this.name})
if(edata.isCancelled===true)return
if(query(this.box).find('#tabs_'+this.name+'_right').length>0){this.unmount()}
delete w2ui[this.name]
edata.finish()}
unmount(){super.unmount()
this.last.observeResize?.disconnect()}
click(id,event){let tab=this.get(id)
if(tab==null||tab.disabled||this.last.reordering)return false
let edata=this.trigger('click',{target:id,tab:tab,object:tab,originalEvent:event})
if(edata.isCancelled===true)return
query(this.box).find('#tabs_'+this.name+'_tab_'+w2utils.escapeId(this.active)).removeClass('active')
this.active=tab.id
query(this.box).find('#tabs_'+this.name+'_tab_'+w2utils.escapeId(this.active)).addClass('active')
if(typeof tab.route=='string'){let route=tab.route!==''?String('/'+tab.route).replace(/\/{2,}/g,'/'):''
let info=w2utils.parseRoute(route)
if(info.keys.length>0){for(let k=0;k<info.keys.length;k++){if(this.routeData[info.keys[k].name]==null)continue
route=route.replace((new RegExp(':'+info.keys[k].name,'g')),this.routeData[info.keys[k].name])}}
setTimeout(()=>{window.location.hash=route},1)}
edata.finish()}
clickClose(id,event){let tab=this.get(id)
if(tab==null||tab.disabled)return false
let edata=this.trigger('close',{target:id,object:tab,tab,originalEvent:event})
if(edata.isCancelled===true)return
this.animateClose(id).then(()=>{this.remove(id)
edata.finish()
this.refresh()})
if(event)event.stopPropagation()}
animateClose(id){return new Promise((resolve,reject)=>{let $tab=query(this.box).find('#tabs_'+this.name+'_tab_'+w2utils.escapeId(id))
let width=parseInt($tab.get(0).clientWidth||0)
let anim=`<div class="tab-animate-close" style="display: inline-block; flex-shrink: 0; width: ${width}px; transition: width 0.25s"></div>`
let $anim=$tab.replace(anim)
setTimeout(()=>{$anim.css({width:'0px'})},1)
setTimeout(()=>{$anim.remove()
this.resize()
resolve()},500)})}
animateInsert(id,tab){return new Promise((resolve,reject)=>{let $before=query(this.box).find('#tabs_'+this.name+'_tab_'+w2utils.escapeId(id))
let $tab=query.html(this.getTabHTML(tab.id))
if($before.length==0){$before=query(this.box).find('#tabs_tabs_right')
$before.before($tab)
this.resize()}else{$tab.css({opacity:0})
query(this.box).find('#tabs_tabs_right').before($tab.get(0))
let $tmp=query(this.box).find('#'+$tab.attr('id'))
let width=$tmp.get(0)?.clientWidth??0
let $anim=query.html('<div class="tab-animate-insert" style="flex-shrink: 0; width: 0; transition: width 0.25s"></div>')
$before.before($anim)
$tab.hide()
$anim.before($tab[0])
setTimeout(()=>{$anim.css({width:width+'px'})},1)
setTimeout(()=>{$anim.remove()
$tab.css({opacity:1}).show()
this.refresh(tab.id)
this.resize()
resolve()},500)}})}}
let w2panels=['top','left','main','preview','right','bottom']
class w2layout extends w2base{constructor(options){super(options.name)
this.box=null
this.name=null
this.panels=[]
this.last={}
this.padding=1
this.resizer=4
this.style=''
this.onShow=null
this.onHide=null
this.onResizing=null
this.onResizerClick=null
this.onRender=null
this.onRefresh=null
this.onChange=null
this.onResize=null
this.onDestroy=null
this.panel_template={type:null,title:'',size:100,minSize:20,maxSize:false,hidden:false,resizable:false,overflow:'auto',style:'',html:'',tabs:null,toolbar:null,width:null,height:null,show:{toolbar:false,tabs:false},removed:null,onRefresh:null,onShow:null,onHide:null}
Object.assign(this,options)
if(!Array.isArray(this.panels))this.panels=[]
this.panels.forEach((panel,ind)=>{this.panels[ind]=w2utils.extend({},this.panel_template,panel)
if(w2utils.isPlainObject(panel.tabs)||Array.isArray(panel.tabs))initTabs(this,panel.type)
if(w2utils.isPlainObject(panel.toolbar)||Array.isArray(panel.toolbar))initToolbar(this,panel.type)})
w2panels.forEach(tab=>{if(this.get(tab)!=null)return
this.panels.push(w2utils.extend({},this.panel_template,{type:tab,hidden:(tab!=='main'),size:50}))})
if(typeof this.box=='string')this.box=query(this.box).get(0)
if(this.box)this.render(this.box)
function initTabs(object,panel,tabs){let pan=object.get(panel)
if(pan!=null&&tabs==null)tabs=pan.tabs
if(pan==null||tabs==null)return false
if(Array.isArray(tabs))tabs={tabs:tabs}
let name=object.name+'_'+panel+'_tabs'
if(w2ui[name])w2ui[name].destroy()
pan.tabs=new w2tabs(w2utils.extend({},tabs,{owner:object,name:object.name+'_'+panel+'_tabs'}))
pan.show.tabs=true
return true}
function initToolbar(object,panel,toolbar){let pan=object.get(panel)
if(pan!=null&&toolbar==null)toolbar=pan.toolbar
if(pan==null||toolbar==null)return false
if(Array.isArray(toolbar))toolbar={items:toolbar}
let name=object.name+'_'+panel+'_toolbar'
if(w2ui[name])w2ui[name].destroy()
pan.toolbar=new w2toolbar(w2utils.extend({},toolbar,{owner:object,name:object.name+'_'+panel+'_toolbar'}))
pan.show.toolbar=true
return true}}
html(panel,data,transition){let p=this.get(panel)
let promise={panel:panel,html:p.html,error:false,cancelled:false,removed(cb){if(typeof cb=='function'){p.removed=cb}}}
if(typeof p.removed=='function'){p.removed({panel:panel,html:p.html,html_new:data,transition:transition||'none'})
p.removed=null}
if(panel=='css'){query(this.box).find('#layout_'+this.name+'_panel_css').html('<style>'+data+'</style>')
promise.status=true
return promise}
if(p==null){console.log('ERROR: incorrect panel name. Panel name can be main, left, right, top, bottom, preview or css')
promise.error=true
return promise}
if(data==null){return promise}
let edata=this.trigger('change',{target:panel,panel:p,html_new:data,transition:transition})
if(edata.isCancelled===true){promise.cancelled=true
return promise}
let pname='#layout_'+this.name+'_panel_'+p.type
let current=query(this.box).find(pname+'> [data-role="panel-content"]')
let panelTop=0
if(current.length>0){query(this.box).find(pname).get(0).scrollTop=0
panelTop=query(current).css('top')}
if(typeof p.html.unmount=='function')p.html.unmount()
current.addClass('w2ui-panel-content')
current.removeAttr('style')
this.resizeBoxes(panel)
if(p.html===''){p.html=data
this.refresh(panel)}else{p.html=data
if(!p.hidden){if(transition!=null&&transition!==''){query(this.box).addClass('animating')
let div1=query(this.box).find(pname+'> [data-role="panel-content"]')
div1.after('<div class="w2ui-panel-content new-panel" data-role="panel-content" style="'+div1[0].style.cssText+'"></div>')
let div2=query(this.box).find(pname+'> [data-role="panel-content"].new-panel')
div1.css('top',panelTop)
div2.css('top',panelTop)
if(typeof data=='object'){data.box=div2[0]
data.render()}else{div2.hide().html(data)}
w2utils.transition(div1[0],div2[0],transition,()=>{div1.remove()
div2.removeClass('new-panel')
div2.css('overflow',p.overflow)
query(query(this.box).find(pname+'> [data-role="panel-content"]').get(1)).remove()
query(this.box).removeClass('animating')
this.refresh(panel)})}else{this.refresh(panel)}}}
edata.finish()
return promise}
message(panel,options){let p=this.get(panel)
let box=query(this.box).find('#layout_'+this.name+'_panel_'+p.type)
let oldOverflow=box.css('overflow')
box.css('overflow','hidden')
let prom=w2utils.message({owner:this,box:box.get(0),after:'.w2ui-panel-title',param:panel},options)
if(prom){prom.self.on('close:after',()=>{box.css('overflow',oldOverflow)})}
return prom}
confirm(panel,options){let p=this.get(panel)
let box=query(this.box).find('#layout_'+this.name+'_panel_'+p.type)
let oldOverflow=box.css('overflow')
box.css('overflow','hidden')
let prom=w2utils.confirm({owner:this,box:box.get(0),after:'.w2ui-panel-title',param:panel},options)
if(prom){prom.self.on('close:after',()=>{box.css('overflow',oldOverflow)})}
return prom}
load(panel,url,transition){return new Promise((resolve,reject)=>{if((panel=='css'||this.get(panel)!=null)&&url!=null){fetch(url).then(resp=>resp.text()).then(text=>{this.resize()
resolve(this.html(panel,text,transition))})}else{reject()}})}
sizeTo(panel,size,instant){let pan=this.get(panel)
if(pan==null)return false
query(this.box).find(':scope > div > .w2ui-panel').css('transition',(instant!==true?'.2s':'0s'))
setTimeout(()=>{this.set(panel,{size:size})},1)
setTimeout(()=>{query(this.box).find(':scope > div > .w2ui-panel').css('transition','0s')
this.resize()},300)
return true}
show(panel,immediate){let edata=this.trigger('show',{target:panel,thisect:this.get(panel),immediate:immediate})
if(edata.isCancelled===true)return
let p=this.get(panel)
if(p==null)return false
p.hidden=false
if(immediate===true){query(this.box).find('#layout_'+this.name+'_panel_'+panel).css({'opacity':'1'})
edata.finish()
this.resize()}else{query(this.box).addClass('animating')
query(this.box).find('#layout_'+this.name+'_panel_'+panel).css({'opacity':'0'})
query(this.box).find(':scope > div > .w2ui-panel').css('transition','.2s')
setTimeout(()=>{this.resize()},1)
setTimeout(()=>{query(this.box).find('#layout_'+this.name+'_panel_'+panel).css({'opacity':'1'})},250)
setTimeout(()=>{query(this.box).find(':scope > div > .w2ui-panel').css('transition','0s')
query(this.box).removeClass('animating')
edata.finish()
this.resize()},300)}
return true}
hide(panel,immediate){let edata=this.trigger('hide',{target:panel,object:this.get(panel),immediate:immediate})
if(edata.isCancelled===true)return
let p=this.get(panel)
if(p==null)return false
p.hidden=true
if(immediate===true){query(this.box).find('#layout_'+this.name+'_panel_'+panel).css({'opacity':'0'})
edata.finish()
this.resize()}else{query(this.box).addClass('animating')
query(this.box).find(':scope > div > .w2ui-panel').css('transition','.2s')
query(this.box).find('#layout_'+this.name+'_panel_'+panel).css({'opacity':'0'})
setTimeout(()=>{this.resize()},1)
setTimeout(()=>{query(this.box).find(':scope > div > .w2ui-panel').css('transition','0s')
query(this.box).removeClass('animating')
edata.finish()
this.resize()},300)}
return true}
toggle(panel,immediate){let p=this.get(panel)
if(p==null)return false
if(p.hidden)return this.show(panel,immediate);else return this.hide(panel,immediate)}
set(panel,options){let ind=this.get(panel,true)
if(ind==null)return false
w2utils.extend(this.panels[ind],options)
if(options.html!=null||options.resizable!=null){this.refresh(panel)}
this.resize()
return true}
get(panel,returnIndex){for(let p=0;p<this.panels.length;p++){if(this.panels[p].type==panel){if(returnIndex===true)return p;else return this.panels[p]}}
return null}
el(panel){let el=query(this.box).find('#layout_'+this.name+'_panel_'+panel+'> [data-role="panel-content"]')
if(el.length!=1)return null
return el[0]}
hideToolbar(panel){let pan=this.get(panel)
if(!pan)return
pan.show.toolbar=false
query(this.box).find(`#layout_${this.name}_panel_${panel} > [data-role="panel-toolbar"]`).hide()
this.resize()}
showToolbar(panel){let pan=this.get(panel)
if(!pan)return
pan.show.toolbar=true
query(this.box).find(`#layout_${this.name}_panel_${panel} > [data-role="panel-toolbar"]`).show()
this.resize()}
toggleToolbar(panel){let pan=this.get(panel)
if(!pan)return
if(pan.show.toolbar)this.hideToolbar(panel);else this.showToolbar(panel)}
assignToolbar(panel,toolbar){if(typeof toolbar=='string'&&w2ui[toolbar]!=null)toolbar=w2ui[toolbar]
let pan=this.get(panel)
pan.toolbar=toolbar
let tmp=query(this.box).find(panel+'> [data-role="panel-toolbar"]')
if(pan.toolbar!=null){if(tmp.attr('name')!=pan.toolbar.name){pan.toolbar.render(tmp.get(0))}else if(pan.toolbar!=null){pan.toolbar.refresh()}
toolbar.owner=this
this.showToolbar(panel)
this.refresh(panel)}else{tmp.html('')
this.hideToolbar(panel)}}
hideTabs(panel){let pan=this.get(panel)
if(!pan)return
pan.show.tabs=false
query(this.box).find('#layout_'+this.name+'_panel_'+panel+'> [data-role="panel-tabs"]').hide()
this.resize()}
showTabs(panel){let pan=this.get(panel)
if(!pan)return
pan.show.tabs=true
query(this.box).find('#layout_'+this.name+'_panel_'+panel+'> [data-role="panel-tabs"]').show()
this.resize()}
toggleTabs(panel){let pan=this.get(panel)
if(!pan)return
if(pan.show.tabs)this.hideTabs(panel);else this.showTabs(panel)}
render(box){let time=Date.now()
let self=this
if(typeof box=='string')box=query(box).get(0)
let edata=this.trigger('render',{target:this.name,box:box??this.box})
if(edata.isCancelled===true)return
if(box!=null){this.unmount()
this.box=box}
if(!this.box)return false
query(this.box).attr('name',this.name).addClass('w2ui-layout').html('<div></div>')
if(query(this.box).length>0){query(this.box)[0].style.cssText+=this.style}
for(let p1=0;p1<w2panels.length;p1++){let html='<div id="layout_'+this.name+'_panel_'+w2panels[p1]+'" class="w2ui-panel">'+'    <div class="w2ui-panel-title"></div>'+'    <div class="w2ui-panel-tabs" data-role="panel-tabs"></div>'+'    <div class="w2ui-panel-toolbar" data-role="panel-toolbar"></div>'+'    <div class="w2ui-panel-content" data-role="panel-content"></div>'+'</div>'+'<div id="layout_'+this.name+'_resizer_'+w2panels[p1]+'" class="w2ui-resizer"></div>'
query(this.box).find(':scope > div').append(html)}
query(this.box).find(':scope > div').append('<div id="layout_'+this.name+'_panel_css" style="position: absolute; top: 10000px;"></div>')
this.refresh()
this.last.observeResize=new ResizeObserver(()=>{this.resize()})
this.last.observeResize.observe(this.box)
edata.finish()
setTimeout(()=>{self.last.events={resizeStart,mouseMove,mouseUp}
this.resize()},0)
return Date.now()-time
function resizeStart(type,evnt){if(!self.box)return
if(!evnt)evnt=window.event
query(document).off('mousemove',self.last.events.mouseMove).on('mousemove',self.last.events.mouseMove)
query(document).off('mouseup',self.last.events.mouseUp).on('mouseup',self.last.events.mouseUp)
self.last.resize={type:type,x:evnt.screenX,y:evnt.screenY,diff_x:0,diff_y:0,value:0}
w2panels.forEach(panel=>{let $tmp=query(self.el(panel)).find('.w2ui-lock')
if($tmp.length>0){$tmp.data('locked','yes')}else{self.lock(panel,{opacity:0})}})
let el=query(self.box).find('#layout_'+self.name+'_resizer_'+type).get(0)
if(type=='left'||type=='right'){self.last.resize.value=parseInt(el.style.left)}
if(type=='top'||type=='preview'||type=='bottom'){self.last.resize.value=parseInt(el.style.top)}}
function mouseUp(evnt){if(!self.box)return
if(!evnt)evnt=window.event
query(document).off('mousemove',self.last.events.mouseMove)
query(document).off('mouseup',self.last.events.mouseUp)
if(self.last.resize==null)return
w2panels.forEach(panel=>{let $tmp=query(self.el(panel)).find('.w2ui-lock')
if($tmp.data('locked')=='yes'){$tmp.removeData('locked')}else{self.unlock(panel)}})
if(self.last.diff_x!==0||self.last.resize.diff_y!==0){let ptop=self.get('top')
let pbottom=self.get('bottom')
let panel=self.get(self.last.resize.type)
let width=w2utils.getSize(query(self.box),'width')
let height=w2utils.getSize(query(self.box),'height')
let str=String(panel.size)
let ns,nd
switch(self.last.resize.type){case'top':ns=parseInt(panel.sizeCalculated)+self.last.resize.diff_y
nd=0
break
case'bottom':ns=parseInt(panel.sizeCalculated)-self.last.resize.diff_y
nd=0
break
case'preview':ns=parseInt(panel.sizeCalculated)-self.last.resize.diff_y
nd=(ptop&&!ptop.hidden?ptop.sizeCalculated:0)+
(pbottom&&!pbottom.hidden?pbottom.sizeCalculated:0)
break
case'left':ns=parseInt(panel.sizeCalculated)+self.last.resize.diff_x
nd=0
break
case'right':ns=parseInt(panel.sizeCalculated)-self.last.resize.diff_x
nd=0
break}
if(str.substr(str.length-1)=='%'){panel.size=Math.floor(ns*100/(panel.type=='left'||panel.type=='right'?width:height-nd)*100)/100+'%'}else{if(String(panel.size).substr(0,1)=='-'){panel.size=parseInt(panel.size)-panel.sizeCalculated+ns}else{panel.size=ns}}
self.resize()}
query(self.box).find('#layout_'+self.name+'_resizer_'+self.last.resize.type).removeClass('active')
delete self.last.resize}
function mouseMove(evnt){if(!self.box)return
if(!evnt)evnt=window.event
if(self.last.resize==null)return
let panel=self.get(self.last.resize.type)
let tmp=self.last.resize
let edata=self.trigger('resizing',{target:self.name,object:panel,originalEvent:evnt,panel:tmp?tmp.type:'all',diff_x:tmp?tmp.diff_x:0,diff_y:tmp?tmp.diff_y:0})
if(edata.isCancelled===true)return
let p=query(self.box).find('#layout_'+self.name+'_resizer_'+tmp.type)
let resize_x=(evnt.screenX-tmp.x)
let resize_y=(evnt.screenY-tmp.y)
let mainPanel=self.get('main')
if(!p.hasClass('active'))p.addClass('active')
switch(tmp.type){case'left':if(panel.minSize-resize_x>panel.width){resize_x=panel.minSize-panel.width}
if(panel.maxSize&&(panel.width+resize_x>panel.maxSize)){resize_x=panel.maxSize-panel.width}
if(mainPanel.minSize+resize_x>mainPanel.width){resize_x=mainPanel.width-mainPanel.minSize}
break
case'right':if(panel.minSize+resize_x>panel.width){resize_x=panel.width-panel.minSize}
if(panel.maxSize&&(panel.width-resize_x>panel.maxSize)){resize_x=panel.width-panel.maxSize}
if(mainPanel.minSize-resize_x>mainPanel.width){resize_x=mainPanel.minSize-mainPanel.width}
break
case'top':if(panel.minSize-resize_y>panel.height){resize_y=panel.minSize-panel.height}
if(panel.maxSize&&(panel.height+resize_y>panel.maxSize)){resize_y=panel.maxSize-panel.height}
if(mainPanel.minSize+resize_y>mainPanel.height){resize_y=mainPanel.height-mainPanel.minSize}
break
case'preview':case'bottom':if(panel.minSize+resize_y>panel.height){resize_y=panel.height-panel.minSize}
if(panel.maxSize&&(panel.height-resize_y>panel.maxSize)){resize_y=panel.height-panel.maxSize}
if(mainPanel.minSize-resize_y>mainPanel.height){resize_y=mainPanel.minSize-mainPanel.height}
break}
tmp.diff_x=resize_x
tmp.diff_y=resize_y
switch(tmp.type){case'top':case'preview':case'bottom':tmp.diff_x=0
if(p.length>0)p[0].style.top=(tmp.value+tmp.diff_y)+'px'
break
case'left':case'right':tmp.diff_y=0
if(p.length>0)p[0].style.left=(tmp.value+tmp.diff_x)+'px'
break}
edata.finish()}}
unmount(){super.unmount()
this.panels.forEach(panel=>{panel.tabs?.unmount?.()
panel.toolbar?.unmount?.()})
this.last.observeResize?.disconnect()}
destroy(){let edata=this.trigger('destroy',{target:this.name})
if(edata.isCancelled===true)return
if(w2ui[this.name]==null)return false
this.panels.forEach(panel=>{panel.tabs?.destroy?.()
panel.toolbar?.destroy?.()})
if(query(this.box).find('#layout_'+this.name+'_panel_main').length>0){this.unmount()}
delete w2ui[this.name]
edata.finish()
if(this.last.events&&this.last.events.resize){query(window).off('resize',this.last.events.resize)}
return true}
refresh(panel){let self=this
if(panel==null)panel=null
let time=Date.now()
let edata=self.trigger('refresh',{target:(panel!=null?panel:self.name),object:self.get(panel)})
if(edata.isCancelled===true)return
if(typeof panel=='string'){let p=self.get(panel)
if(p==null)return
let pname='#layout_'+self.name+'_panel_'+p.type
let rname='#layout_'+self.name+'_resizer_'+p.type
query(self.box).find(pname).css({display:p.hidden?'none':'block'})
if(p.resizable){query(self.box).find(rname).show()}else{query(self.box).find(rname).hide()}
if(typeof p.html=='object'&&typeof p.html.render==='function'){p.html.box=query(self.box).find(pname+'> [data-role="panel-content"]')[0]
setTimeout(()=>{if(query(self.box).find(pname+'> [data-role="panel-content"]').length>0){query(self.box).find(pname+'> [data-role="panel-content"]').removeClass().removeAttr('name').addClass('w2ui-panel-content').css('overflow',p.overflow)[0].style.cssText+=';'+p.style}
if(p.html&&typeof p.html.render=='function'){p.html.render()}},1)}else{if(query(self.box).find(pname+'> [data-role="panel-content"]').length>0){query(self.box).find(pname+'> [data-role="panel-content"]').removeClass().removeAttr('name').addClass('w2ui-panel-content').html(p.html).css('overflow',p.overflow)[0].style.cssText+=';'+p.style}}
let tmp=query(self.box).find(pname+'> [data-role="panel-tabs"]')
if(p.show.tabs){if(tmp.attr('name')!=p.tabs.name&&p.tabs!=null){p.tabs.render(tmp.get(0))}else{p.tabs.refresh()}
tmp.addClass('w2ui-panel-tabs')}else{tmp.html('').removeAttr('name').removeClass('w2ui-tabs').hide()}
tmp=query(self.box).find(pname+'> [data-role="panel-toolbar"]')
if(p.show.toolbar){if(tmp.attr('name')!=p.toolbar.name&&p.toolbar!=null){p.toolbar.render(tmp.get(0))}else{p.toolbar.refresh()}
tmp.addClass('w2ui-panel-toolbar')}else{tmp.html('').removeAttr('name').removeClass('w2ui-toolbar').hide()}
tmp=query(self.box).find(pname+'> .w2ui-panel-title')
if(p.title){tmp.html(p.title).show()}else{tmp.html('').hide()}}else{if(query(self.box).find('#layout_'+self.name+'_panel_main').length===0){self.render()
return}
self.resize()
for(let p1=0;p1<this.panels.length;p1++){self.refresh(this.panels[p1].type)}}
edata.finish()
return Date.now()-time}
resize(){if(!this.box)return false
let time=Date.now()
let tmp=this.last.resize
let edata=this.trigger('resize',{target:this.name,panel:tmp?tmp.type:'all',diff_x:tmp?tmp.diff_x:0,diff_y:tmp?tmp.diff_y:0})
if(edata.isCancelled===true)return
if(this.padding<0)this.padding=0
let width=w2utils.getSize(query(this.box),'width')
let height=w2utils.getSize(query(this.box),'height')
let self=this
let pmain=this.get('main')
let pprev=this.get('preview')
let pleft=this.get('left')
let pright=this.get('right')
let ptop=this.get('top')
let pbottom=this.get('bottom')
let sprev=(pprev!=null&&pprev.hidden!==true?true:false)
let sleft=(pleft!=null&&pleft.hidden!==true?true:false)
let sright=(pright!=null&&pright.hidden!==true?true:false)
let stop=(ptop!=null&&ptop.hidden!==true?true:false)
let sbottom=(pbottom!=null&&pbottom.hidden!==true?true:false)
let l,t,w,h
for(let p=0;p<w2panels.length;p++){if(w2panels[p]==='main')continue
tmp=this.get(w2panels[p])
if(!tmp)continue
let str=String(tmp.size||0)
if(str.substr(str.length-1)=='%'){let tmph=height
if(tmp.type=='preview'){tmph=tmph-
(ptop&&!ptop.hidden?ptop.sizeCalculated:0)-
(pbottom&&!pbottom.hidden?pbottom.sizeCalculated:0)}
tmp.sizeCalculated=parseInt((tmp.type=='left'||tmp.type=='right'?width:tmph)*parseFloat(tmp.size)/100)}else{tmp.sizeCalculated=parseInt(tmp.size)}
tmp.sizeCalculated=Math.max(tmp.sizeCalculated,parseInt(tmp.minSize))}
if(String(pright.size).substr(0,1)=='-'){if(sleft&&String(pleft.size).substr(0,1)=='-'){console.log('ERROR: you cannot have both left panel.size and right panel.size be negative.')}else{pright.sizeCalculated=width-(sleft?pleft.sizeCalculated:0)+parseInt(pright.size)}}
if(String(pleft.size).substr(0,1)=='-'){if(sright&&String(pright.size).substr(0,1)=='-'){console.log('ERROR: you cannot have both left panel.size and right panel.size be negative.')}else{pleft.sizeCalculated=width-(sright?pright.sizeCalculated:0)+parseInt(pleft.size)}}
if(ptop!=null&&ptop.hidden!==true){l=0
t=0
w=width
h=ptop.sizeCalculated
query(this.box).find('#layout_'+this.name+'_panel_top').css({'display':'block','left':l+'px','top':t+'px','width':w+'px','height':h+'px'})
ptop.width=w
ptop.height=h
if(ptop.resizable){t=ptop.sizeCalculated-(this.padding===0?this.resizer:0)
h=(this.resizer>this.padding?this.resizer:this.padding)
query(this.box).find('#layout_'+this.name+'_resizer_top').css({'display':'block','left':l+'px','top':t+'px','width':w+'px','height':h+'px','cursor':'ns-resize'}).off('mousedown').on('mousedown',function(event){event.preventDefault()
let edata=self.trigger('resizerClick',{target:'top',originalEvent:event})
if(edata.isCancelled===true)return
w2ui[self.name].last.events.resizeStart('top',event)
edata.finish()
return false})}}else{query(this.box).find('#layout_'+this.name+'_panel_top').hide()
query(this.box).find('#layout_'+this.name+'_resizer_top').hide()}
if(pleft!=null&&pleft.hidden!==true){l=0
t=0+(stop?ptop.sizeCalculated+this.padding:0)
w=pleft.sizeCalculated
h=height-(stop?ptop.sizeCalculated+this.padding:0)-
(sbottom?pbottom.sizeCalculated+this.padding:0)
query(this.box).find('#layout_'+this.name+'_panel_left').css({'display':'block','left':l+'px','top':t+'px','width':w+'px','height':h+'px'})
pleft.width=w
pleft.height=h
if(pleft.resizable){l=pleft.sizeCalculated-(this.padding===0?this.resizer:0)
w=(this.resizer>this.padding?this.resizer:this.padding)
query(this.box).find('#layout_'+this.name+'_resizer_left').css({'display':'block','left':l+'px','top':t+'px','width':w+'px','height':h+'px','cursor':'ew-resize'}).off('mousedown').on('mousedown',function(event){event.preventDefault()
let edata=self.trigger('resizerClick',{target:'left',originalEvent:event})
if(edata.isCancelled===true)return
w2ui[self.name].last.events.resizeStart('left',event)
edata.finish()
return false})}}else{query(this.box).find('#layout_'+this.name+'_panel_left').hide()
query(this.box).find('#layout_'+this.name+'_resizer_left').hide()}
if(pright!=null&&pright.hidden!==true){l=width-pright.sizeCalculated
t=0+(stop?ptop.sizeCalculated+this.padding:0)
w=pright.sizeCalculated
h=height-(stop?ptop.sizeCalculated+this.padding:0)-
(sbottom?pbottom.sizeCalculated+this.padding:0)
query(this.box).find('#layout_'+this.name+'_panel_right').css({'display':'block','left':l+'px','top':t+'px','width':w+'px','height':h+'px'})
pright.width=w
pright.height=h
if(pright.resizable){l=l-this.padding
w=(this.resizer>this.padding?this.resizer:this.padding)
query(this.box).find('#layout_'+this.name+'_resizer_right').css({'display':'block','left':l+'px','top':t+'px','width':w+'px','height':h+'px','cursor':'ew-resize'}).off('mousedown').on('mousedown',function(event){event.preventDefault()
let edata=self.trigger('resizerClick',{target:'right',originalEvent:event})
if(edata.isCancelled===true)return
w2ui[self.name].last.events.resizeStart('right',event)
edata.finish()
return false})}}else{query(this.box).find('#layout_'+this.name+'_panel_right').hide()
query(this.box).find('#layout_'+this.name+'_resizer_right').hide()}
if(pbottom!=null&&pbottom.hidden!==true){l=0
t=height-pbottom.sizeCalculated
w=width
h=pbottom.sizeCalculated
query(this.box).find('#layout_'+this.name+'_panel_bottom').css({'display':'block','left':l+'px','top':t+'px','width':w+'px','height':h+'px'})
pbottom.width=w
pbottom.height=h
if(pbottom.resizable){t=t-(this.padding===0?0:this.padding)
h=(this.resizer>this.padding?this.resizer:this.padding)
query(this.box).find('#layout_'+this.name+'_resizer_bottom').css({'display':'block','left':l+'px','top':t+'px','width':w+'px','height':h+'px','cursor':'ns-resize'}).off('mousedown').on('mousedown',function(event){event.preventDefault()
let edata=self.trigger('resizerClick',{target:'bottom',originalEvent:event})
if(edata.isCancelled===true)return
w2ui[self.name].last.events.resizeStart('bottom',event)
edata.finish()
return false})}}else{query(this.box).find('#layout_'+this.name+'_panel_bottom').hide()
query(this.box).find('#layout_'+this.name+'_resizer_bottom').hide()}
l=0+(sleft?pleft.sizeCalculated+this.padding:0)
t=0+(stop?ptop.sizeCalculated+this.padding:0)
w=width-(sleft?pleft.sizeCalculated+this.padding:0)-
(sright?pright.sizeCalculated+this.padding:0)
h=height-(stop?ptop.sizeCalculated+this.padding:0)-
(sbottom?pbottom.sizeCalculated+this.padding:0)-
(sprev?pprev.sizeCalculated+this.padding:0)
query(this.box).find('#layout_'+this.name+'_panel_main').css({'display':'block','left':l+'px','top':t+'px','width':w+'px','height':h+'px'})
pmain.width=w
pmain.height=h
if(pprev!=null&&pprev.hidden!==true){l=0+(sleft?pleft.sizeCalculated+this.padding:0)
t=height-(sbottom?pbottom.sizeCalculated+this.padding:0)-pprev.sizeCalculated
w=width-(sleft?pleft.sizeCalculated+this.padding:0)-
(sright?pright.sizeCalculated+this.padding:0)
h=pprev.sizeCalculated
query(this.box).find('#layout_'+this.name+'_panel_preview').css({'display':'block','left':l+'px','top':t+'px','width':w+'px','height':h+'px'})
pprev.width=w
pprev.height=h
if(pprev.resizable){t=t-(this.padding===0?0:this.padding)
h=(this.resizer>this.padding?this.resizer:this.padding)
query(this.box).find('#layout_'+this.name+'_resizer_preview').css({'display':'block','left':l+'px','top':t+'px','width':w+'px','height':h+'px','cursor':'ns-resize'}).off('mousedown').on('mousedown',function(event){event.preventDefault()
let edata=self.trigger('resizerClick',{target:'preview',originalEvent:event})
if(edata.isCancelled===true)return
w2ui[self.name].last.events.resizeStart('preview',event)
edata.finish()
return false})}}else{query(this.box).find('#layout_'+this.name+'_panel_preview').hide()
query(this.box).find('#layout_'+this.name+'_resizer_preview').hide()}
this.resizeBoxes()
edata.finish()
return Date.now()-time}
resizeBoxes(panel){let panels=w2panels
if(!panel&&typeof panel=='string')panels=[panel]
panels.forEach((pname,ind)=>{let pan=this.get(w2panels[ind])
let tmp2=`#layout_${this.name}_panel_${pname} > `
let topHeight=0
if(pan){if(pan.title){let el=query(this.box).find(tmp2+'.w2ui-panel-title').css({top:topHeight+'px',display:'block'})
topHeight+=w2utils.getSize(el,'height')}
if(pan.show.tabs){let el=query(this.box).find(tmp2+'[data-role="panel-tabs"]').css({top:topHeight+'px',display:'block'})
topHeight+=w2utils.getSize(el,'height')}
if(pan.show.toolbar){let el=query(this.box).find(tmp2+'[data-role="panel-toolbar"]').css({top:topHeight+'px',display:'block'})
topHeight+=w2utils.getSize(el,'height')}}
query(this.box).find(tmp2+'[data-role="panel-content"]').css({display:'block',top:topHeight+'px'})})}
lock(panel,msg,showSpinner){if(w2panels.indexOf(panel)==-1){console.log('ERROR: First parameter needs to be the a valid panel name.')
return}
let args=Array.from(arguments)
args[0]='#layout_'+this.name+'_panel_'+panel
w2utils.lock(...args)}
unlock(panel,speed){if(w2panels.indexOf(panel)==-1){console.log('ERROR: First parameter needs to be the a valid panel name.')
return}
let nm='#layout_'+this.name+'_panel_'+panel
w2utils.unlock(nm,speed)}}
class w2grid extends w2base{constructor(options){super(options.name)
this.name=null
this.box=null
this.columns=[]
this.columnGroups=[]
this.records=[]
this.summary=[]
this.searches=[]
this.toolbar={}
this.ranges=[]
this.contextMenu=[]
this.searchMap={}
this.searchData=[]
this.sortMap={}
this.sortData=[]
this.savedSearches=[]
this.defaultSearches=[]
this.total=0
this.recid=null
this.last={field:'',label:'',logic:'AND',search:'',searchIds:[],selection:{indexes:[],columns:{}},saved_sel:null,multi:false,fetch:{action:'',offset:null,start:0,response:0,options:null,controller:null,loaded:false,hasMore:false},vscroll:{scrollTop:0,scrollLeft:0,recIndStart:null,recIndEnd:null,colIndStart:0,colIndEnd:0,pull_more:false,pull_refresh:true,show_extra:0,},sel_ind:null,sel_col:null,sel_type:null,sel_recid:null,idCache:{},move:null,cancelClick:null,inEditMode:false,_edit:null,kbd_timer:null,marker_timer:null,click_time:null,click_recid:null,bubbleEl:null,colResizing:false,tmp:null,copy_event:null,userSelect:'',columnDrag:false,state:null,toolbar_height:0,}
this.header=''
this.url=''
this.limit=100
this.offset=0
this.postData={}
this.routeData={}
this.httpHeaders={}
this.show={header:false,toolbar:false,footer:false,columnMenu:true,columnHeaders:true,lineNumbers:false,expandColumn:false,selectColumn:false,emptyRecords:true,toolbarReload:true,toolbarColumns:false,toolbarSearch:true,toolbarAdd:false,toolbarEdit:false,toolbarDelete:false,toolbarSave:false,searchAll:true,searchLogic:true,searchHiddenMsg:false,searchSave:true,statusRange:true,statusBuffered:false,statusRecordID:true,statusSelection:true,statusResponse:true,statusSort:false,statusSearch:false,recordTitles:false,selectionBorder:true,selectionResizer:true,skipRecords:true,saveRestoreState:true}
this.stateId=null
this.hasFocus=false
this.autoLoad=true
this.fixedBody=true
this.recordHeight=32
this.lineNumberWidth=34
this.keyboard=true
this.selectType='row'
this.liveSearch=false
this.multiSearch=true
this.multiSelect=true
this.multiSort=true
this.reorderColumns=false
this.reorderRows=false
this.showExtraOnSearch=0
this.markSearch=true
this.columnTooltip='top|bottom'
this.disableCVS=false
this.nestedFields=true
this.vs_start=150
this.vs_extra=5
this.style=''
this.tabIndex=null
this.dataType=null
this.parser=null
this.advanceOnEdit=true
this.useLocalStorage=true
this.colTemplate={text:'',field:'',size:null,min:20,max:null,gridMinWidth:null,sizeCorrected:null,sizeCalculated:null,sizeOriginal:null,sizeType:null,hidden:false,sortable:false,sortMode:null,searchable:false,resizable:true,hideable:true,autoResize:null,attr:'',style:'',render:null,title:null,tooltip:null,editable:{},frozen:false,info:null,clipboardCopy:false,}
this.stateColProps={text:false,field:true,size:true,min:false,max:false,gridMinWidth:false,sizeCorrected:false,sizeCalculated:true,sizeOriginal:true,sizeType:true,hidden:true,sortable:false,sortMode:true,searchable:false,resizable:false,hideable:false,autoResize:false,attr:false,style:false,render:false,title:false,tooltip:false,editable:false,frozen:true,info:false,clipboardCopy:false}
this.msgDelete='Are you sure you want to delete ${count} ${records}?'
this.msgNotJSON='Returned data is not in valid JSON format.'
this.msgHTTPError='HTTP error. See console for more details.'
this.msgServerError='Server error'
this.msgRefresh='Refreshing...'
this.msgNeedReload='Your remote data source record count has changed, reloading from the first record.'
this.msgEmpty=''
this.buttons={'reload':{type:'button',id:'w2ui-reload',icon:'w2ui-icon-reload',tooltip:'Reload data in the list'},'columns':{type:'menu-check',id:'w2ui-column-on-off',icon:'w2ui-icon-columns',tooltip:'Show/hide columns',overlay:{align:'none'}},'search':{type:'html',id:'w2ui-search',html:'<div class="w2ui-icon w2ui-icon-search w2ui-search-down w2ui-action" data-click="searchShowFields"></div>'},'add':{type:'button',id:'w2ui-add',text:'Add New',tooltip:'Add new record',icon:'w2ui-icon-plus'},'edit':{type:'button',id:'w2ui-edit',text:'Edit',tooltip:'Edit selected record',icon:'w2ui-icon-pencil',batch:1,disabled:true},'delete':{type:'button',id:'w2ui-delete',text:'Delete',tooltip:'Delete selected records',icon:'w2ui-icon-cross',batch:true,disabled:true},'save':{type:'button',id:'w2ui-save',text:'Save',tooltip:'Save changed records',icon:'w2ui-icon-check'}}
this.operators={'text':['is','begins','contains','ends'],'number':['=','between','>','<','>=','<='],'date':['is',{oper:'less',text:'before'},{oper:'more',text:'since'},'between'],'list':['is'],'hex':['is','between'],'color':['is','begins','contains','ends'],'enum':['in','not in']}
this.defaultOperator={'text':'begins','number':'=','date':'is','list':'is','enum':'in','hex':'begins','color':'begins'}
this.operatorsMap={'text':'text','int':'number','float':'number','money':'number','currency':'number','percent':'number','hex':'hex','alphanumeric':'text','color':'color','date':'date','time':'date','datetime':'date','list':'list','combo':'text','enum':'enum','file':'enum','select':'list','radio':'list','checkbox':'list','toggle':'list'}
this.onAdd=null
this.onEdit=null
this.onRequest=null
this.onLoad=null
this.onDelete=null
this.onSave=null
this.onSelect=null
this.onClick=null
this.onDblClick=null
this.onContextMenu=null
this.onContextMenuClick=null
this.onColumnClick=null
this.onColumnDblClick=null
this.onColumnContextMenu=null
this.onColumnResize=null
this.onColumnAutoResize=null
this.onSort=null
this.onSearch=null
this.onSearchOpen=null
this.onChange=null
this.onRestore=null
this.onExpand=null
this.onCollapse=null
this.onError=null
this.onKeydown=null
this.onToolbar=null
this.onColumnOnOff=null
this.onCopy=null
this.onPaste=null
this.onSelectionExtend=null
this.onEditField=null
this.onRender=null
this.onRefresh=null
this.onReload=null
this.onResize=null
this.onDestroy=null
this.onStateSave=null
this.onStateRestore=null
this.onFocus=null
this.onBlur=null
this.onReorderRow=null
this.onSearchSave=null
this.onSearchRemove=null
this.onSearchSelect=null
this.onColumnSelect=null
this.onColumnDragStart=null
this.onColumnDragEnd=null
this.onResizerDblClick=null
this.onMouseEnter=null
this.onMouseLeave=null
w2utils.extend(this,options)
if(Array.isArray(this.records)){let remove=[]
this.records.forEach((rec,ind)=>{if(rec[this.recid]!=null){rec.recid=rec[this.recid]}
if(rec.recid==null){console.log('ERROR: Cannot add records without recid. (obj: '+this.name+')')}
if(rec.w2ui?.summary===true){this.summary.push(rec)
remove.push(ind)}})
remove.sort()
for(let t=remove.length-1;t>=0;t--){this.records.splice(remove[t],1)}}
if(Array.isArray(this.columns)){this.columns.forEach((col,ind)=>{col=w2utils.extend({},this.colTemplate,col)
this.columns[ind]=col
let search=col.searchable
if(search==null||search===false||this.getSearch(col.field)!=null)return
if(w2utils.isPlainObject(search)){this.addSearch(w2utils.extend({field:col.field,label:col.text,type:'text'},search))}else{let stype=col.searchable
let attr=''
if(col.searchable===true){stype='text'
attr='size="20"'}
this.addSearch({field:col.field,label:col.text,type:stype,attr:attr})}})}
if(Array.isArray(this.defaultSearches)){this.defaultSearches.forEach((search,ind)=>{search.id='default-'+ind
search.icon??='w2ui-icon-search'})}
let data=this.cache('searches')
if(Array.isArray(data)){data.forEach(search=>{this.savedSearches.push({id:search.id??'none',text:search.text??'none',icon:'w2ui-icon-search',remove:true,logic:search.logic??'AND',data:search.data??[]})})}
this.initToolbar()
if(typeof this.box=='string')this.box=query(this.box).get(0)
if(this.box)this.render(this.box)}
add(record,first){if(!Array.isArray(record))record=[record]
let added=0
for(let i=0;i<record.length;i++){let rec=record[i]
if(rec[this.recid]!=null){rec.recid=rec[this.recid]}
if(rec.recid==null){console.log('ERROR: Cannot add record without recid. (obj: '+this.name+')')
continue}
if(rec.w2ui?.summary===true){if(first)this.summary.unshift(rec);else this.summary.push(rec)}else{if(first)this.records.unshift(rec);else this.records.push(rec)}
added++}
let url=this.url?.get??this.url
if(!url){this.total=this.records.length
this.localSort(false,true)
this.localSearch()
let indStart=this.records.length-record.length
let indEnd=indStart+record.length
if(this.last.vscroll.recIndStart<=indEnd&&this.last.vscroll.recIndEnd>=indStart){this.refresh()}else{query(this.box).find('#grid_'+this.name+'_footer .w2ui-footer-right .w2ui-total').html(w2utils.formatNumber(this.total))}}else{this.refresh()}
return added}
find(obj,returnIndex,displayedOnly){if(obj==null)obj={}
let recs=[]
let hasDots=false
for(let o in obj)if(String(o).indexOf('.')!=-1)hasDots=true
let start=displayedOnly?this.last.vscroll.recIndStart:0
let end=displayedOnly?this.last.vscroll.recIndEnd+1:this.records.length
if(end>this.records.length)end=this.records.length
for(let i=start;i<end;i++){let match=true
for(let o in obj){let val=this.records[i][o]
if(hasDots&&String(o).indexOf('.')!=-1)val=this.parseField(this.records[i],o)
if(obj[o]=='not-null'){if(val==null||val==='')match=false}else{if(obj[o]!=val)match=false}}
if(match&&returnIndex!==true)recs.push(this.records[i].recid)
if(match&&returnIndex===true)recs.push(i)}
return recs}
set(recid,record,noRefresh){if((typeof recid=='object')&&(recid!==null)){noRefresh=record
record=recid
recid=null}
if(recid==null){for(let i=0;i<this.records.length;i++){w2utils.extend(this.records[i],record)}
if(noRefresh!==true)this.refresh()}else{let ind=this.get(recid,true)
if(ind==null)return false
let isSummary=(this.records[ind]?.recid==recid?false:true)
if(isSummary){w2utils.extend(this.summary[ind],record)}else{w2utils.extend(this.records[ind],record)}
if(noRefresh!==true)this.refreshRow(recid,ind)}
return true}
replace(recid,record,noRefresh){let ind=this.get(recid,true)
if(ind==null)return false
let isSummary=(this.records[ind]?.recid==recid?false:true)
if(isSummary){this.summary[ind]=record}else{this.records[ind]=record}
if(noRefresh!==true)this.refreshRow(recid,ind)
return true}
get(recid,returnIndex){if(Array.isArray(recid)){let recs=[]
for(let i=0;i<recid.length;i++){let v=this.get(recid[i],returnIndex)
if(v!==null)
recs.push(v)}
return recs}else{let idCache=this.last.idCache
if(!idCache){this.last.idCache=idCache={}}
let i=idCache[recid]
if(typeof(i)==='number'){if(i>=0&&i<this.records.length&&this.records[i].recid==recid){if(returnIndex===true)return i;else return this.records[i]}
i=~i
if(i>=0&&i<this.summary.length&&this.summary[i].recid==recid){if(returnIndex===true)return i;else return this.summary[i]}
this.last.idCache=idCache={}}
for(let i=0;i<this.records.length;i++){if(this.records[i].recid==recid){idCache[recid]=i
if(returnIndex===true)return i;else return this.records[i]}}
for(let i=0;i<this.summary.length;i++){if(this.summary[i].recid==recid){idCache[recid]=~i
if(returnIndex===true)return i;else return this.summary[i]}}
return null}}
getFirst(offset){if(this.records.length==0)return null
let rec=this.records[0]
let tmp=this.last.searchIds
if(this.searchData.length>0){if(Array.isArray(tmp)&&tmp.length>0){rec=this.records[tmp[offset||0]]}else{rec=null}}
return rec}
remove(){let removed=0
for(let a=0;a<arguments.length;a++){for(let r=this.records.length-1;r>=0;r--){if(this.records[r].recid==arguments[a]){this.records.splice(r,1);removed++}}
for(let r=this.summary.length-1;r>=0;r--){if(this.summary[r].recid==arguments[a]){this.summary.splice(r,1);removed++}}}
let url=this.url?.get??this.url
if(!url){this.localSort(false,true)
this.localSearch()
this.total=this.records.length}
this.refresh()
return removed}
addColumn(before,columns){let added=0
if(arguments.length==1){columns=before
before=this.columns.length}else{if(typeof before=='string')before=this.getColumn(before,true)
if(before==null)before=this.columns.length}
if(!Array.isArray(columns))columns=[columns]
for(let i=0;i<columns.length;i++){let col=w2utils.extend({},this.colTemplate,columns[i])
this.columns.splice(before,0,col)
if(columns[i].searchable){let stype=columns[i].searchable
let attr=''
if(columns[i].searchable===true){stype='text';attr='size="20"'}
this.addSearch({field:columns[i].field,label:columns[i].text,type:stype,attr:attr})}
before++
added++}
this.refresh()
return added}
removeColumn(){let removed=0
for(let a=0;a<arguments.length;a++){for(let r=this.columns.length-1;r>=0;r--){if(this.columns[r].field==arguments[a]){if(this.columns[r].searchable)this.removeSearch(arguments[a])
this.columns.splice(r,1)
removed++}}}
this.refresh()
return removed}
getColumn(field,returnIndex){if(arguments.length===0){let ret=[]
for(let i=0;i<this.columns.length;i++)ret.push(this.columns[i].field)
return ret}
for(let i=0;i<this.columns.length;i++){if(this.columns[i].field==field){if(returnIndex===true)return i;else return this.columns[i]}}
return null}
updateColumn(fields,updates){let effected=0
fields=(Array.isArray(fields)?fields:[fields])
fields.forEach((colName)=>{this.columns.forEach((col)=>{if(col.field==colName){let _updates=w2utils.clone(updates)
Object.keys(_updates).forEach((key)=>{if(typeof _updates[key]=='function'){_updates[key]=_updates[key](col)}
if(col[key]!=_updates[key])effected++})
w2utils.extend(col,_updates)}})})
if(effected>0){this.refresh()}
return effected}
toggleColumn(){return this.updateColumn(Array.from(arguments),{hidden(col){return!col.hidden}})}
showColumn(){return this.updateColumn(Array.from(arguments),{hidden:false})}
hideColumn(){return this.updateColumn(Array.from(arguments),{hidden:true})}
addSearch(before,search){let added=0
if(arguments.length==1){search=before
before=this.searches.length}else{if(typeof before=='string')before=this.getSearch(before,true)
if(before==null)before=this.searches.length}
if(!Array.isArray(search))search=[search]
for(let i=0;i<search.length;i++){this.searches.splice(before,0,search[i])
before++
added++}
this.searchClose()
return added}
removeSearch(){let removed=0
for(let a=0;a<arguments.length;a++){for(let r=this.searches.length-1;r>=0;r--){if(this.searches[r].field==arguments[a]){this.searches.splice(r,1);removed++}}}
this.searchClose()
return removed}
getSearch(field,returnIndex){if(arguments.length===0){let ret=[]
for(let i=0;i<this.searches.length;i++)ret.push(this.searches[i].field)
return ret}
for(let i=0;i<this.searches.length;i++){if(this.searches[i].field==field){if(returnIndex===true)return i;else return this.searches[i]}}
return null}
toggleSearch(){let effected=0
for(let a=0;a<arguments.length;a++){for(let r=this.searches.length-1;r>=0;r--){if(this.searches[r].field==arguments[a]){this.searches[r].hidden=!this.searches[r].hidden
effected++}}}
this.searchClose()
return effected}
showSearch(){let shown=0
for(let a=0;a<arguments.length;a++){for(let r=this.searches.length-1;r>=0;r--){if(this.searches[r].field==arguments[a]&&this.searches[r].hidden!==false){this.searches[r].hidden=false
shown++}}}
this.searchClose()
return shown}
hideSearch(){let hidden=0
for(let a=0;a<arguments.length;a++){for(let r=this.searches.length-1;r>=0;r--){if(this.searches[r].field==arguments[a]&&this.searches[r].hidden!==true){this.searches[r].hidden=true
hidden++}}}
this.searchClose()
return hidden}
getSearchData(field){for(let i=0;i<this.searchData.length;i++){if(this.searchData[i].field==field)return this.searchData[i]}
return null}
localSort(silent,noResetRefresh){let obj=this
let url=this.url?.get??this.url
if(url){console.log('ERROR: grid.localSort can only be used on local data source, grid.url should be empty.')
return 0}
if(Object.keys(this.sortData).length===0){let os=this.last.originalSort
if(os){this.records.sort((a,b)=>{let aInd=os.indexOf(a.recid)
let bInd=os.indexOf(b.recid)
return aInd>bInd?1:-1})}
return 0}
let time=Date.now()
this.selectionSave()
this.prepareData()
if(!noResetRefresh){this.reset()}
for(let i=0;i<this.sortData.length;i++){let column=this.getColumn(this.sortData[i].field)
if(!column)return
if(typeof column.render=='string'){if(['date','age'].indexOf(column.render.split(':')[0])!=-1){this.sortData[i].field_=column.field+'_'}
if(['time'].indexOf(column.render.split(':')[0])!=-1){this.sortData[i].field_=column.field+'_'}}}
preparePaths()
this.records.sort((a,b)=>{return compareRecordPaths(a,b)})
cleanupPaths()
this.selectionRestore(noResetRefresh)
time=Date.now()-time
if(silent!==true&&this.show.statusSort){setTimeout(()=>{this.status(w2utils.lang('Sorting took ${count} seconds',{count:time/1000}))},10)}
return time
function preparePaths(){for(let i=0;i<obj.records.length;i++){let rec=obj.records[i]
if(rec.w2ui?.parent_recid!=null){rec.w2ui._path=getRecordPath(rec)}}}
function cleanupPaths(){for(let i=0;i<obj.records.length;i++){let rec=obj.records[i]
if(rec.w2ui?.parent_recid!=null){rec.w2ui._path=null}}}
function compareRecordPaths(a,b){if((!a.w2ui||a.w2ui.parent_recid==null)&&(!b.w2ui||b.w2ui.parent_recid==null)){return compareRecords(a,b)}
let pa=getRecordPath(a)
let pb=getRecordPath(b)
for(let i=0;i<Math.min(pa.length,pb.length);i++){let diff=compareRecords(pa[i],pb[i])
if(diff!==0)return diff}
if(pa.length>pb.length)return 1
if(pa.length<pb.length)return-1
console.log('ERROR: two paths should not be equal.')
return 0}
function getRecordPath(rec){if(!rec.w2ui||rec.w2ui.parent_recid==null)return[rec]
if(rec.w2ui._path)
return rec.w2ui._path
let subrec=obj.get(rec.w2ui.parent_recid)
if(!subrec){console.log('ERROR: no parent record: '+rec.w2ui.parent_recid)
return[rec]}
return(getRecordPath(subrec).concat(rec))}
function compareRecords(a,b){if(a===b)return 0
for(let i=0;i<obj.sortData.length;i++){let fld=obj.sortData[i].field
let sortFld=(obj.sortData[i].field_)?obj.sortData[i].field_:fld
let aa=a[sortFld]
let bb=b[sortFld]
if(String(fld).indexOf('.')!=-1){aa=obj.parseField(a,sortFld)
bb=obj.parseField(b,sortFld)}
let col=obj.getColumn(fld)
if(col&&Object.keys(col.editable).length>0){if(w2utils.isPlainObject(aa)&&aa.text)aa=aa.text
if(w2utils.isPlainObject(bb)&&bb.text)bb=bb.text}
let ret=compareCells(aa,bb,i,obj.sortData[i].direction,col.sortMode||'default')
if(ret!==0)return ret}
let ret=compareCells(a.recid,b.recid,-1,'asc')
return ret}
function compareCells(aa,bb,i,direction,sortMode){if(aa===bb)
return 0
if((aa==null||aa==='')&&(bb!=null&&bb!==''))
return 1
if((aa!=null&&aa!=='')&&(bb==null||bb===''))
return-1
let dir=(direction.toLowerCase()==='asc')?1:-1
if(typeof aa!=typeof bb)
return(typeof aa>typeof bb)?dir:-dir
if(aa.constructor.name!=bb.constructor.name)
return(aa.constructor.name>bb.constructor.name)?dir:-dir
if(aa&&typeof aa=='object')
aa=aa.valueOf()
if(bb&&typeof bb=='object')
bb=bb.valueOf()
let defaultToString={}.toString
if(aa&&typeof aa=='object'&&aa.toString!=defaultToString)
aa=String(aa)
if(bb&&typeof bb=='object'&&bb.toString!=defaultToString)
bb=String(bb)
if(typeof aa=='string')
aa=aa.toLowerCase().trim()
if(typeof bb=='string')
bb=bb.toLowerCase().trim()
switch(sortMode){case'natural':sortMode=w2utils.naturalCompare
break
case'i18n':sortMode=w2utils.i18nCompare
break}
if(typeof sortMode=='function'){return sortMode(aa,bb)*dir}
if(aa>bb)
return dir
if(aa<bb)
return-dir
return 0}}
localSearch(silent){let obj=this
let url=this.url?.get??this.url
if(url){console.log('ERROR: grid.localSearch can only be used on local data source, grid.url should be empty.')
return}
let time=Date.now()
let defaultToString={}.toString
let duplicateMap={}
this.total=this.records.length
this.last.searchIds=[]
this.prepareData()
if(this.searchData.length>0&&!url){this.total=0
for(let i=0;i<this.records.length;i++){let rec=this.records[i]
let match=searchRecord(rec)
if(match){if(rec?.w2ui)addParent(rec.w2ui.parent_recid)
if(this.showExtraOnSearch>0){let before=this.showExtraOnSearch
let after=this.showExtraOnSearch
if(i<before)before=i
if(i+after>this.records.length)after=this.records.length-i
if(before>0){for(let j=i-before;j<i;j++){if(this.last.searchIds.indexOf(j)<0)
this.last.searchIds.push(j)}}
if(this.last.searchIds.indexOf(i)<0)this.last.searchIds.push(i)
if(after>0){for(let j=(i+1);j<=(i+after);j++){if(this.last.searchIds.indexOf(j)<0)this.last.searchIds.push(j)}}}else{this.last.searchIds.push(i)}}}
this.total=this.last.searchIds.length}
time=Date.now()-time
if(silent!==true&&this.show.statusSearch){setTimeout(()=>{this.status(w2utils.lang('Search took ${count} seconds',{count:time/1000}))},10)}
return time
function searchRecord(rec){let fl=0,val1,val2,val3,tmp
let orEqual=false
for(let j=0;j<obj.searchData.length;j++){let sdata=obj.searchData[j]
let search=obj.getSearch(sdata.field)
if(sdata==null)continue
if(search==null)search={field:sdata.field,type:sdata.type}
let val1b=obj.parseField(rec,search.field)
val1=(val1b!=null&&(typeof val1b!='object'||val1b.toString!=defaultToString))?String(val1b).toLowerCase():''
if(sdata.value!=null){if(!Array.isArray(sdata.value)){val2=String(sdata.value).toLowerCase()}else{val2=sdata.value[0]
val3=sdata.value[1]}}
switch(sdata.operator){case'=':case'is':if(obj.parseField(rec,search.field)==sdata.value)fl++
else if(search.type=='date'){tmp=(obj.parseField(rec,search.field+'_')instanceof Date?obj.parseField(rec,search.field+'_'):obj.parseField(rec,search.field))
val1=w2utils.formatDate(tmp,'yyyy-mm-dd')
val2=w2utils.formatDate(w2utils.isDate(val2,w2utils.settings.dateFormat,true),'yyyy-mm-dd')
if(val1==val2)fl++}
else if(search.type=='time'){tmp=(obj.parseField(rec,search.field+'_')instanceof Date?obj.parseField(rec,search.field+'_'):obj.parseField(rec,search.field))
val1=w2utils.formatTime(tmp,'hh24:mi')
val2=w2utils.formatTime(val2,'hh24:mi')
if(val1==val2)fl++}
else if(search.type=='datetime'){tmp=(obj.parseField(rec,search.field+'_')instanceof Date?obj.parseField(rec,search.field+'_'):obj.parseField(rec,search.field))
val1=w2utils.formatDateTime(tmp,'yyyy-mm-dd|hh24:mm:ss')
val2=w2utils.formatDateTime(w2utils.isDateTime(val2,w2utils.settings.datetimeFormat,true),'yyyy-mm-dd|hh24:mm:ss')
if(val1==val2)fl++}
break
case'between':if(['int','float','money','currency','percent'].indexOf(search.type)!=-1){if(parseFloat(obj.parseField(rec,search.field))>=parseFloat(val2)&&parseFloat(obj.parseField(rec,search.field))<=parseFloat(val3))fl++}
else if(search.type=='date'){tmp=(obj.parseField(rec,search.field+'_')instanceof Date?obj.parseField(rec,search.field+'_'):obj.parseField(rec,search.field))
val1=w2utils.isDate(tmp,w2utils.settings.dateFormat,true)
val2=w2utils.isDate(val2,w2utils.settings.dateFormat,true)
val3=w2utils.isDate(val3,w2utils.settings.dateFormat,true)
if(val3!=null)val3=new Date(val3.getTime()+86400000)
if(val1>=val2&&val1<val3)fl++}
else if(search.type=='time'){val1=(obj.parseField(rec,search.field+'_')instanceof Date?obj.parseField(rec,search.field+'_'):obj.parseField(rec,search.field))
val2=w2utils.isTime(val2,true)
val3=w2utils.isTime(val3,true)
val2=(new Date()).setHours(val2.hours,val2.minutes,val2.seconds?val2.seconds:0,0)
val3=(new Date()).setHours(val3.hours,val3.minutes,val3.seconds?val3.seconds:0,0)
if(val1>=val2&&val1<val3)fl++}
else if(search.type=='datetime'){val1=(obj.parseField(rec,search.field+'_')instanceof Date?obj.parseField(rec,search.field+'_'):obj.parseField(rec,search.field))
val2=w2utils.isDateTime(val2,w2utils.settings.datetimeFormat,true)
val3=w2utils.isDateTime(val3,w2utils.settings.datetimeFormat,true)
if(val3)val3=new Date(val3.getTime()+86400000)
if(val1>=val2&&val1<val3)fl++}
break
case'<=':orEqual=true
case'<':case'less':if(['int','float','money','currency','percent'].indexOf(search.type)!=-1){val1=parseFloat(obj.parseField(rec,search.field))
val2=parseFloat(sdata.value)
if(val1<val2||(orEqual&&val1===val2))fl++}
else if(search.type=='date'){tmp=(obj.parseField(rec,search.field+'_')instanceof Date?obj.parseField(rec,search.field+'_'):obj.parseField(rec,search.field))
val1=w2utils.isDate(tmp,w2utils.settings.dateFormat,true)
val2=w2utils.isDate(val2,w2utils.settings.dateFormat,true)
if(val1<val2||(orEqual&&val1===val2))fl++}
else if(search.type=='time'){tmp=(obj.parseField(rec,search.field+'_')instanceof Date?obj.parseField(rec,search.field+'_'):obj.parseField(rec,search.field))
val1=w2utils.formatTime(tmp,'hh24:mi')
val2=w2utils.formatTime(val2,'hh24:mi')
if(val1<val2||(orEqual&&val1===val2))fl++}
else if(search.type=='datetime'){tmp=(obj.parseField(rec,search.field+'_')instanceof Date?obj.parseField(rec,search.field+'_'):obj.parseField(rec,search.field))
val1=w2utils.formatDateTime(tmp,'yyyy-mm-dd|hh24:mm:ss')
val2=w2utils.formatDateTime(w2utils.isDateTime(val2,w2utils.settings.datetimeFormat,true),'yyyy-mm-dd|hh24:mm:ss')
if(val1.length==val2.length&&(val1<val2||(orEqual&&val1===val2)))fl++}
break
case'>=':orEqual=true
case'>':case'more':if(['int','float','money','currency','percent'].indexOf(search.type)!=-1){val1=parseFloat(obj.parseField(rec,search.field))
val2=parseFloat(sdata.value)
if(val1>val2||(orEqual&&val1===val2))fl++}
else if(search.type=='date'){tmp=(obj.parseField(rec,search.field+'_')instanceof Date?obj.parseField(rec,search.field+'_'):obj.parseField(rec,search.field))
val1=w2utils.isDate(tmp,w2utils.settings.dateFormat,true)
val2=w2utils.isDate(val2,w2utils.settings.dateFormat,true)
if(val1>val2||(orEqual&&val1===val2))fl++}
else if(search.type=='time'){tmp=(obj.parseField(rec,search.field+'_')instanceof Date?obj.parseField(rec,search.field+'_'):obj.parseField(rec,search.field))
val1=w2utils.formatTime(tmp,'hh24:mi')
val2=w2utils.formatTime(val2,'hh24:mi')
if(val1>val2||(orEqual&&val1===val2))fl++}
else if(search.type=='datetime'){tmp=(obj.parseField(rec,search.field+'_')instanceof Date?obj.parseField(rec,search.field+'_'):obj.parseField(rec,search.field))
val1=w2utils.formatDateTime(tmp,'yyyy-mm-dd|hh24:mm:ss')
val2=w2utils.formatDateTime(w2utils.isDateTime(val2,w2utils.settings.datetimeFormat,true),'yyyy-mm-dd|hh24:mm:ss')
if(val1.length==val2.length&&(val1>val2||(orEqual&&val1===val2)))fl++}
break
case'in':tmp=sdata.value
if(sdata.svalue)tmp=sdata.svalue
if((tmp.indexOf(w2utils.isFloat(val1b)?parseFloat(val1b):val1b)!==-1)||(tmp.indexOf(val1)!==-1&&val1!==''))fl++
break
case'not in':tmp=sdata.value
if(sdata.svalue)tmp=sdata.svalue
if(!((tmp.indexOf(w2utils.isFloat(val1b)?parseFloat(val1b):val1b)!==-1)||(tmp.indexOf(val1)!==-1&&val1!=='')))fl++
break
case'begins':case'begins with':if(val1.indexOf(val2)===0)fl++
break
case'contains':if(val1.indexOf(val2)>=0)fl++
break
case'null':if(obj.parseField(rec,search.field)==null)fl++
break
case'not null':if(obj.parseField(rec,search.field)!=null)fl++
break
case'ends':case'ends with':let lastIndex=val1.lastIndexOf(val2)
if(lastIndex!==-1&&lastIndex==val1.length-val2.length)fl++
break}}
if((obj.last.logic=='OR'&&fl!==0)||(obj.last.logic=='AND'&&fl==obj.searchData.length)){return true}
if(rec.w2ui?.children&&rec.w2ui?.expanded!==true){for(let r=0;r<rec.w2ui.children.length;r++){let subRec=rec.w2ui.children[r]
if(searchRecord(subRec)){return true}}}
return false}
function addParent(recid){let i=obj.get(recid,true)
if(i==null||recid==null||duplicateMap[recid]||obj.last.searchIds.includes(i)){return}
duplicateMap[recid]=true
let rec=obj.records[i]
if(rec?.w2ui){addParent(rec.w2ui.parent_recid)}
obj.last.searchIds.push(i)}}
getRangeData(range,extra){let rec1=this.get(range[0].recid,true)
let rec2=this.get(range[1].recid,true)
let col1=range[0].column
let col2=range[1].column
let res=[]
if(col1==col2){for(let r=rec1;r<=rec2;r++){let record=this.records[r]
let dt=record[this.columns[col1].field]||null
if(extra!==true){res.push(dt)}else{res.push({data:dt,column:col1,index:r,record:record})}}}else if(rec1==rec2){let record=this.records[rec1]
for(let i=col1;i<=col2;i++){let dt=record[this.columns[i].field]||null
if(extra!==true){res.push(dt)}else{res.push({data:dt,column:i,index:rec1,record:record})}}}else{for(let r=rec1;r<=rec2;r++){let record=this.records[r]
res.push([])
for(let i=col1;i<=col2;i++){let dt=record[this.columns[i].field]
if(extra!==true){res[res.length-1].push(dt)}else{res[res.length-1].push({data:dt,column:i,index:r,record:record})}}}}
return res}
addRange(ranges){let added=0,first,last
if(this.selectType=='row')return added
if(!Array.isArray(ranges))ranges=[ranges]
for(let i=0;i<ranges.length;i++){if(typeof ranges[i]!='object')ranges[i]={name:'selection'}
if(ranges[i].name=='selection'){if(this.show.selectionBorder===false)continue
let sel=this.getSelection()
if(sel.length===0){this.removeRange('selection')
continue}else{first=sel[0]
last=sel[sel.length-1]}}else{first=ranges[i].range[0]
last=ranges[i].range[1]}
if(first){let rg={name:ranges[i].name,range:[{recid:first.recid,column:first.column},{recid:last.recid,column:last.column}],style:ranges[i].style||'',class:ranges[i].class}
let ind=false
for(let j=0;j<this.ranges.length;j++)if(this.ranges[j].name==ranges[i].name){ind=j;break}
if(ind!==false){this.ranges[ind]=rg}else{this.ranges.push(rg)}
added++}}
this.refreshRanges()
return added}
removeRange(){let removed=0
for(let a=0;a<arguments.length;a++){let name=arguments[a]
query(this.box).find('#grid_'+this.name+'_'+name).remove()
query(this.box).find('#grid_'+this.name+'_f'+name).remove()
for(let r=this.ranges.length-1;r>=0;r--){if(this.ranges[r].name==name){this.ranges.splice(r,1)
removed++}}}
return removed}
refreshRanges(){if(this.ranges.length===0)return
let self=this
let range
let time=Date.now()
let rec1=query(this.box).find(`#grid_${this.name}_frecords`)
let rec2=query(this.box).find(`#grid_${this.name}_records`)
for(let i=0;i<this.ranges.length;i++){let rg=this.ranges[i]
let first=rg.range[0]
let last=rg.range[1]
if(first.index==null)first.index=this.get(first.recid,true)
if(last.index==null)last.index=this.get(last.recid,true)
let td1=query(this.box).find('#grid_'+this.name+'_rec_'+w2utils.escapeId(first.recid)+' td[col="'+first.column+'"]')
let td2=query(this.box).find('#grid_'+this.name+'_rec_'+w2utils.escapeId(last.recid)+' td[col="'+last.column+'"]')
let td1f=query(this.box).find('#grid_'+this.name+'_frec_'+w2utils.escapeId(first.recid)+' td[col="'+first.column+'"]')
let td2f=query(this.box).find('#grid_'+this.name+'_frec_'+w2utils.escapeId(last.recid)+' td[col="'+last.column+'"]')
let _lastColumn=last.column
if(first.column<this.last.vscroll.colIndStart&&last.column>this.last.vscroll.colIndStart){td1=query(this.box).find('#grid_'+this.name+'_rec_'+w2utils.escapeId(first.recid)+' td[col="start"]')}
if(first.column<this.last.vscroll.colIndEnd&&last.column>this.last.vscroll.colIndEnd){td2=query(this.box).find('#grid_'+this.name+'_rec_'+w2utils.escapeId(last.recid)+' td[col="end"]')
_lastColumn='"end"'}
let index_top=parseInt(query(this.box).find('#grid_'+this.name+'_rec_top').next().attr('index'))
let index_bottom=parseInt(query(this.box).find('#grid_'+this.name+'_rec_bottom').prev().attr('index'))
let index_ftop=parseInt(query(this.box).find('#grid_'+this.name+'_frec_top').next().attr('index'))
let index_fbottom=parseInt(query(this.box).find('#grid_'+this.name+'_frec_bottom').prev().attr('index'))
if(td1.length===0&&first.index<index_top&&last.index>index_top){td1=query(this.box).find('#grid_'+this.name+'_rec_top').next().find('td[col="'+first.column+'"]')}
if(td2.length===0&&last.index>index_bottom&&first.index<index_bottom){td2=query(this.box).find('#grid_'+this.name+'_rec_bottom').prev().find('td[col="'+_lastColumn+'"]')}
if(td1f.length===0&&first.index<index_ftop&&last.index>index_ftop){td1f=query(this.box).find('#grid_'+this.name+'_frec_top').next().find('td[col="'+first.column+'"]')}
if(td2f.length===0&&last.index>index_fbottom&&first.index<index_fbottom){td2f=query(this.box).find('#grid_'+this.name+'_frec_bottom').prev().find('td[col="'+last.column+'"]')}
let edit=query(this.box).find('#grid_'+this.name+'_editable')
let tmp=edit.find('.w2ui-input')
let tmp_ind=tmp.attr('index')
let tmp1=this.records[tmp_ind]?.recid
let tmp2=tmp.attr('column')
if(rg.name=='selection'&&rg.range[0].recid==tmp1&&rg.range[0].column==tmp2)continue
range=query(this.box).find('#grid_'+this.name+'_f'+rg.name)
if(td1f.length>0||td2f.length>0){if(range.length===0){rec1.append('<div id="grid_'+this.name+'_f'+rg.name+'" class="w2ui-selection" style="'+rg.style+'">'+
(rg.name=='selection'&&this.show.selectionResizer?'<div id="grid_'+this.name+'_resizer" class="w2ui-selection-resizer"></div>':'')+'</div>')
range=query(this.box).find('#grid_'+this.name+'_f'+rg.name)}else{range.attr('style',rg.style)
range.find('.w2ui-selection-resizer').show()}
if(td2f.length===0){td2f=query(this.box).find('#grid_'+this.name+'_frec_'+w2utils.escapeId(last.recid)+' td:last-child')
if(td2f.length===0)td2f=query(this.box).find('#grid_'+this.name+'_frec_bottom td:first-child')
range.css('border-right','0px')
range.find('.w2ui-selection-resizer').hide()}
if(first.recid!=null&&last.recid!=null&&td1f.length>0&&td2f.length>0){let style=getComputedStyle(td2f[0])
let top1=(td1f.prop('offsetTop')-td1f.prop('scrollTop'))
let left1=(td1f.prop('offsetLeft')+td1f.prop('scrollLeft'))
let top2=(td2f.prop('offsetTop')-td2f.prop('scrollTop'))
let left2=(td2f.prop('offsetLeft')+td2f.prop('scrollLeft'))
range.show().css({top:(top1>0?top1:0)+'px',left:(left1>0?left1:0)+'px',width:(left2-left1+parseFloat(style.width)-1)+'px',height:(top2-top1+parseFloat(style.height)-1)+'px'})}else{range.hide()}}else{range.hide()}
range=query(this.box).find('#grid_'+this.name+'_'+rg.name)
if(td1.length>0||td2.length>0){if(range.length===0){rec2.append(`
                        <div id="grid_${this.name}_${rg.name}" class="w2ui-selection ${rg.class ?? ''}" style="${rg.style}">
                            ${rg.name == 'selection' && this.show.selectionResizer
                                ? `<div id="grid_${this.name}_resizer"class="w2ui-selection-resizer"></div>`
                                : ''
                            }
                        </div>
                    `)
range=query(this.box).find('#grid_'+this.name+'_'+rg.name)}else{range.attr('style',rg.style)}
if(td1.length===0){td1=query(this.box).find('#grid_'+this.name+'_rec_'+w2utils.escapeId(first.recid)+' td:first-child')
if(td1.length===0)td1=query(this.box).find('#grid_'+this.name+'_rec_top td:first-child')}
if(td2f.length!==0){range.css('border-left','0px')}
if(first.recid!=null&&last.recid!=null&&td1.length>0&&td2.length>0){let style=getComputedStyle(td2[0])
let top1=(td1.prop('offsetTop')-td1.prop('scrollTop'))
let left1=(td1.prop('offsetLeft')+td1.prop('scrollLeft'))
let top2=(td2.prop('offsetTop')-td2.prop('scrollTop'))
let left2=(td2.prop('offsetLeft')+td2.prop('scrollLeft'))
range.show().css({top:(top1>0?top1:0)+'px',left:(left1>0?left1:0)+'px',width:(left2-left1+parseFloat(style.width)-1)+'px',height:(top2-top1+parseFloat(style.height)-1)+'px'})}else{range.hide()}}else{range.hide()}}
query(this.box).find('.w2ui-selection-resizer').off('.resizer').on('mousedown.resizer',mouseStart).on('dblclick.resizer',(event)=>{let edata=this.trigger('resizerDblClick',{target:this.name,originalEvent:event})
if(edata.isCancelled===true)return
edata.finish()})
let edata
let detail={target:this.name,originalRange:null,newRange:null}
let letters='abcdefghijklmnopqrstuvwxyz'
return Date.now()-time
function mouseStart(event){let sel=self.getSelection()
let first=sel[0]
let last=sel[sel.length-1]
self.last.move={type:'expand',x:event.screenX,y:event.screenY,divX:0,divY:0,index:first.index,recid:first.recid,column:first.column,name:letters[first.column]+(first.index+1)+':'+letters[last.column]+(last.index+1),originalRange:[w2utils.clone(first),w2utils.clone(last)],newRange:[w2utils.clone(first),w2utils.clone(last)]}
detail.originalName=self.last.move.name
detail.originalRange=self.last.move.originalRange
query('body').off('.w2ui-'+self.name).on('mousemove.w2ui-'+self.name,mouseMove).on('mouseup.w2ui-'+self.name,mouseStop)
event.preventDefault()}
function mouseMove(event){let mv=self.last.move
if(!mv||mv.type!='expand')return
mv.divX=(event.screenX-mv.x)
mv.divY=(event.screenY-mv.y)
let recid,index,column
let tmp=event.target
if(tmp.tagName.toUpperCase()!='TD')tmp=query(tmp).closest('td')[0]
if(query(tmp).attr('col')!=null)column=parseInt(query(tmp).attr('col'))
if(column==null){return}
tmp=query(tmp).closest('tr')[0]
index=parseInt(query(tmp).attr('index'))
recid=self.records[index]?.recid
if(mv.newRange[1].recid==recid&&mv.newRange[1].column==column){return}
let prevNewRange=w2utils.clone(mv.newRange)
mv.newRange=[{recid:mv.recid,index:mv.index,column:mv.column},{recid,index,column}]
detail.newName=letters[mv.column]+(mv.index+1)+':'+letters[column]+(index+1)
detail.newRange=w2utils.clone(mv.newRange)
edata=self.trigger('selectionExtend',detail)
if(edata.isCancelled===true){mv.newRange=prevNewRange
detail.newRange=prevNewRange
return}else{self.addRange({name:'selection-expand',range:mv.newRange,class:'w2ui-selection-expand'})}}
function mouseStop(event){self.removeRange('selection-expand')
query('body').off('.w2ui-'+self.name)
if(self.last.move?.type=='expand'&&edata.finish){edata.finish()}
delete self.last.move}}
select(){if(arguments.length===0)return 0
let selected=0
let sel=this.last.selection
if(!this.multiSelect)this.selectNone(true)
let args=Array.from(arguments)
if(Array.isArray(args[0]))args=args[0]
let tmp={target:this.name}
if(args.length==1){tmp.multiple=false
if(w2utils.isPlainObject(args[0])){tmp.clicked={recid:args[0].recid,column:args[0].column}}else{tmp.recid=args[0]}}else{tmp.multiple=true
tmp.clicked={recids:args}}
if(this.compareSelection(args).select.length==0){return}
let edata=this.trigger('select',tmp)
if(edata.isCancelled===true)return 0
if(this.selectType=='row'){for(let a=0;a<args.length;a++){let recid=typeof args[a]=='object'?args[a].recid:args[a]
let index=this.get(recid,true)
if(index==null)continue
let recEl1=null
let recEl2=null
if(this.searchData.length!==0||(index+1>=this.last.vscroll.recIndStart&&index+1<=this.last.vscroll.recIndEnd)){recEl1=query(this.box).find('#grid_'+this.name+'_frec_'+w2utils.escapeId(recid))
recEl2=query(this.box).find('#grid_'+this.name+'_rec_'+w2utils.escapeId(recid))}
if(this.selectType=='row'){if(sel.indexes.indexOf(index)!=-1)continue
sel.indexes.push(index)
if(recEl1&&recEl2){recEl1.addClass('w2ui-selected').find('.w2ui-col-number').addClass('w2ui-row-selected')
recEl2.addClass('w2ui-selected').find('.w2ui-col-number').addClass('w2ui-row-selected')
recEl1.find('.w2ui-grid-select-check').prop('checked',true)}
selected++}}}else{let new_sel={}
for(let a=0;a<args.length;a++){let recid=typeof args[a]=='object'?args[a].recid:args[a]
let column=typeof args[a]=='object'?args[a].column:null
new_sel[recid]=new_sel[recid]||[]
if(Array.isArray(column)){new_sel[recid]=column}else if(w2utils.isInt(column)){new_sel[recid].push(column)}else{for(let i=0;i<this.columns.length;i++){if(this.columns[i].hidden)continue;new_sel[recid].push(parseInt(i))}}}
let col_sel=[]
for(let recid in new_sel){let index=this.get(recid,true)
if(index==null)continue
let recEl1=null
let recEl2=null
if(index+1>=this.last.vscroll.recIndStart&&index+1<=this.last.vscroll.recIndEnd){recEl1=query(this.box).find('#grid_'+this.name+'_rec_'+w2utils.escapeId(recid))
recEl2=query(this.box).find('#grid_'+this.name+'_frec_'+w2utils.escapeId(recid))}
let s=sel.columns[index]||[]
if(sel.indexes.indexOf(index)==-1){sel.indexes.push(index)}
for(let t=0;t<new_sel[recid].length;t++){if(s.indexOf(new_sel[recid][t])==-1)s.push(new_sel[recid][t])}
s.sort((a,b)=>{return a-b})
for(let t=0;t<new_sel[recid].length;t++){let col=new_sel[recid][t]
if(col_sel.indexOf(col)==-1)col_sel.push(col)
if(recEl1){recEl1.find('#grid_'+this.name+'_data_'+index+'_'+col).addClass('w2ui-selected')
recEl1.find('.w2ui-col-number').addClass('w2ui-row-selected')
recEl1.find('.w2ui-grid-select-check').prop('checked',true)}
if(recEl2){recEl2.find('#grid_'+this.name+'_data_'+index+'_'+col).addClass('w2ui-selected')
recEl2.find('.w2ui-col-number').addClass('w2ui-row-selected')
recEl2.find('.w2ui-grid-select-check').prop('checked',true)}
selected++}
sel.columns[index]=s}
for(let c=0;c<col_sel.length;c++){query(this.box).find('#grid_'+this.name+'_column_'+col_sel[c]+' .w2ui-col-header').addClass('w2ui-col-selected')}}
sel.indexes.sort((a,b)=>{return a-b})
let areAllSelected=(this.records.length>0&&sel.indexes.length==this.records.length),areAllSearchedSelected=(sel.indexes.length>0&&this.searchData.length!==0&&sel.indexes.length==this.last.searchIds.length)
if(areAllSelected||areAllSearchedSelected){query(this.box).find('#grid_'+this.name+'_check_all').prop('checked',true)}else{query(this.box).find('#grid_'+this.name+'_check_all').prop('checked',false)}
this.status()
this.addRange('selection')
this.updateToolbar(sel,areAllSelected)
edata.finish()
return selected}
unselect(){let unselected=0
let sel=this.last.selection
let args=Array.from(arguments)
if(Array.isArray(args[0]))args=args[0]
let tmp={target:this.name}
if(args.length==1){tmp.multiple=false
if(w2utils.isPlainObject(args[0])){tmp.clicked={recid:args[0].recid,column:args[0].column}}else{tmp.clicked={recid:args[0]}}}else{tmp.multiple=true
tmp.recids=args}
if(this.compareSelection(args).unselect.length==0){return}
let edata=this.trigger('select',tmp)
if(edata.isCancelled===true)return 0
for(let a=0;a<args.length;a++){let recid=typeof args[a]=='object'?args[a].recid:args[a]
let record=this.get(recid)
if(record==null)continue
let index=this.get(record.recid,true)
let recEl1=query(this.box).find('#grid_'+this.name+'_frec_'+w2utils.escapeId(recid))
let recEl2=query(this.box).find('#grid_'+this.name+'_rec_'+w2utils.escapeId(recid))
if(this.selectType=='row'){if(sel.indexes.indexOf(index)==-1)continue
sel.indexes.splice(sel.indexes.indexOf(index),1)
recEl1.removeClass('w2ui-selected w2ui-inactive').find('.w2ui-col-number').removeClass('w2ui-row-selected')
recEl2.removeClass('w2ui-selected w2ui-inactive').find('.w2ui-col-number').removeClass('w2ui-row-selected')
if(recEl1.length!=0){recEl1[0].style.cssText='height: '+this.recordHeight+'px; '+recEl1.attr('custom_style')
recEl2[0].style.cssText='height: '+this.recordHeight+'px; '+recEl2.attr('custom_style')}
recEl1.find('.w2ui-grid-select-check').prop('checked',false)
unselected++}else{let col=args[a].column
if(!w2utils.isInt(col)){let cols=[]
for(let i=0;i<this.columns.length;i++){if(this.columns[i].hidden)continue;cols.push({recid:recid,column:i})}
return this.unselect(cols)}
let s=sel.columns[index]
if(!Array.isArray(s)||s.indexOf(col)==-1)continue
s.splice(s.indexOf(col),1)
query(this.box).find(`#grid_${this.name}_rec_${w2utils.escapeId(recid)} > td[col="${col}"]`).removeClass('w2ui-selected w2ui-inactive')
query(this.box).find(`#grid_${this.name}_frec_${w2utils.escapeId(recid)} > td[col="${col}"]`).removeClass('w2ui-selected w2ui-inactive')
let isColSelected=false
let isRowSelected=false
let tmp=this.getSelection()
for(let i=0;i<tmp.length;i++){if(tmp[i].column==col)isColSelected=true
if(tmp[i].recid==recid)isRowSelected=true}
if(!isColSelected){query(this.box).find(`.w2ui-grid-columns td[col="${col}"] .w2ui-col-header, .w2ui-grid-fcolumns td[col="${col}"] .w2ui-col-header`).removeClass('w2ui-col-selected')}
if(!isRowSelected){query(this.box).find('#grid_'+this.name+'_frec_'+w2utils.escapeId(recid)).find('.w2ui-col-number').removeClass('w2ui-row-selected')}
unselected++
if(s.length===0){delete sel.columns[index]
sel.indexes.splice(sel.indexes.indexOf(index),1)
recEl1.find('.w2ui-grid-select-check').prop('checked',false)}}}
let areAllSelected=(this.records.length>0&&sel.indexes.length==this.records.length),areAllSearchedSelected=(sel.indexes.length>0&&this.searchData.length!==0&&sel.indexes.length==this.last.searchIds.length)
if(areAllSelected||areAllSearchedSelected){query(this.box).find('#grid_'+this.name+'_check_all').prop('checked',true)}else{query(this.box).find('#grid_'+this.name+'_check_all').prop('checked',false)}
this.status()
this.addRange('selection')
this.updateToolbar(sel,areAllSelected)
edata.finish()
return unselected}
compareSelection(newSel){let sel=this.getSelection()
let select=[]
let unselect=[]
if(this.selectType=='row'){newSel.forEach((sel,ind)=>{if(typeof sel=='object')newSel[ind]=sel.recid})
for(let i=0;i<newSel.length;i++){if(!sel.includes(newSel[i])){select.push(newSel[i])}}
for(let i=0;i<newSel.length;i++){if(sel.includes(newSel[i])){unselect.push(newSel[i])}}}else{for(let ns=0;ns<newSel.length;ns++){let flag=false
for(let s=0;s<sel.length;s++)if(newSel[ns].recid==sel[s].recid&&newSel[ns].column==sel[s].column)flag=true
if(!flag)select.push({recid:newSel[ns].recid,column:newSel[ns].column})}
for(let s=0;s<sel.length;s++){let flag=false
for(let ns=0;ns<newSel.length;ns++)if(newSel[ns].recid==sel[s].recid&&newSel[ns].column==sel[s].column)flag=true
if(!flag)unselect.push({recid:sel[s].recid,column:sel[s].column})}}
return{select,unselect}}
selectAll(){let time=Date.now()
if(this.multiSelect===false)return
let url=this.url?.get??this.url
let sel=w2utils.clone(this.last.selection)
let cols=[]
for(let i=0;i<this.columns.length;i++)cols.push(i)
sel.indexes=[]
if(!url&&this.searchData.length!==0){for(let i=0;i<this.last.searchIds.length;i++){sel.indexes.push(this.last.searchIds[i])
if(this.selectType!='row')sel.columns[this.last.searchIds[i]]=cols.slice()}}else{let buffered=this.records.length
if(this.searchData.length!=0&&!url)buffered=this.last.searchIds.length
for(let i=0;i<buffered;i++){sel.indexes.push(i)
if(this.selectType!='row')sel.columns[i]=cols.slice()}}
let edata=this.trigger('select',{target:this.name,multiple:true,all:true,clicked:sel})
if(edata.isCancelled===true)return
this.last.selection=sel
if(this.selectType=='row'){query(this.box).find('.w2ui-grid-records tr:not(.w2ui-empty-record)').addClass('w2ui-selected').find('.w2ui-col-number').addClass('w2ui-row-selected')
query(this.box).find('.w2ui-grid-frecords tr:not(.w2ui-empty-record)').addClass('w2ui-selected').find('.w2ui-col-number').addClass('w2ui-row-selected')
query(this.box).find('input.w2ui-grid-select-check').prop('checked',true)}else{query(this.box).find('.w2ui-grid-columns td .w2ui-col-header, .w2ui-grid-fcolumns td .w2ui-col-header').addClass('w2ui-col-selected')
query(this.box).find('.w2ui-grid-records tr .w2ui-col-number').addClass('w2ui-row-selected')
query(this.box).find('.w2ui-grid-records tr:not(.w2ui-empty-record)').find('.w2ui-grid-data:not(.w2ui-col-select)').addClass('w2ui-selected')
query(this.box).find('.w2ui-grid-frecords tr .w2ui-col-number').addClass('w2ui-row-selected')
query(this.box).find('.w2ui-grid-frecords tr:not(.w2ui-empty-record)').find('.w2ui-grid-data:not(.w2ui-col-select)').addClass('w2ui-selected')
query(this.box).find('input.w2ui-grid-select-check').prop('checked',true)}
sel=this.getSelection(true)
this.addRange('selection')
query(this.box).find('#grid_'+this.name+'_check_all').prop('checked',true)
this.status()
this.updateToolbar({indexes:sel},true)
edata.finish()
return Date.now()-time}
selectNone(skipEvent){let time=Date.now()
let edata
if(!skipEvent){edata=this.trigger('select',{target:this.name,clicked:[]})
if(edata.isCancelled===true)return}
let sel=this.last.selection
if(this.selectType=='row'){query(this.box).find('.w2ui-grid-records tr.w2ui-selected').removeClass('w2ui-selected w2ui-inactive').find('.w2ui-col-number').removeClass('w2ui-row-selected')
query(this.box).find('.w2ui-grid-frecords tr.w2ui-selected').removeClass('w2ui-selected w2ui-inactive').find('.w2ui-col-number').removeClass('w2ui-row-selected')
query(this.box).find('input.w2ui-grid-select-check').prop('checked',false)}else{query(this.box).find('.w2ui-grid-columns td .w2ui-col-header, .w2ui-grid-fcolumns td .w2ui-col-header').removeClass('w2ui-col-selected')
query(this.box).find('.w2ui-grid-records tr .w2ui-col-number').removeClass('w2ui-row-selected')
query(this.box).find('.w2ui-grid-frecords tr .w2ui-col-number').removeClass('w2ui-row-selected')
query(this.box).find('.w2ui-grid-data.w2ui-selected').removeClass('w2ui-selected w2ui-inactive')
query(this.box).find('input.w2ui-grid-select-check').prop('checked',false)}
sel.indexes=[]
sel.columns={}
this.removeRange('selection')
query(this.box).find('#grid_'+this.name+'_check_all').prop('checked',false)
this.status()
this.updateToolbar(sel,false)
if(!skipEvent){edata.finish()}
return Date.now()-time}
updateToolbar(sel){let obj=this
let cnt=sel&&sel.indexes?sel.indexes.length:0
if(!this.toolbar.render){return}
this.toolbar.items.forEach((item)=>{_checkItem(item,'')
if(Array.isArray(item.items)){item.items.forEach((it)=>{_checkItem(it,item.id+':')})}})
if(this.show.toolbarSave){if(this.getChanges().length>0){this.toolbar.enable('w2ui-save')}else{this.toolbar.disable('w2ui-save')}}
function _checkItem(item,prefix){if(item.batch!=null){let enabled=false
if(item.batch===true){if(cnt>0)enabled=true}else if(typeof item.batch=='number'){if(cnt===item.batch)enabled=true}else if(typeof item.batch=='function'){enabled=item.batch({cnt,sel})}
if(enabled){obj.toolbar.enable(prefix+item.id)}else{obj.toolbar.disable(prefix+item.id)}}}}
getSelection(returnIndex){let ret=[]
let sel=this.last.selection
if(this.selectType=='row'){for(let i=0;i<sel.indexes.length;i++){if(!this.records[sel.indexes[i]])continue
if(returnIndex===true)ret.push(sel.indexes[i]);else ret.push(this.records[sel.indexes[i]].recid)}
return ret}else{for(let i=0;i<sel.indexes.length;i++){let cols=sel.columns[sel.indexes[i]]
if(!this.records[sel.indexes[i]])continue
for(let j=0;j<cols.length;j++){ret.push({recid:this.records[sel.indexes[i]].recid,index:parseInt(sel.indexes[i]),column:cols[j]})}}
return ret}}
search(field,value){let url=this.url?.get??this.url
let searchData=[]
let last_multi=this.last.multi
let last_logic=this.last.logic
let last_field=this.last.field
let last_search=this.last.search
let hasHiddenSearches=false
let overlay=query(`#w2overlay-${this.name}-search-overlay`)
if(value==='')value=null
for(let i=0;i<this.searches.length;i++){if(!this.searches[i].hidden||this.searches[i].value==null)continue
searchData.push({field:this.searches[i].field,operator:this.searches[i].operator||'is',type:this.searches[i].type,value:this.searches[i].value||''})
hasHiddenSearches=true}
if(arguments.length===0&&overlay.length===0){if(this.multiSearch){field=this.searchData
value=this.last.logic}else{field=this.last.field
value=this.last.search}}
if(arguments.length===0&&overlay.length!==0){this.focus()
last_logic=overlay.find(`#grid_${this.name}_logic`).val()
last_search=''
for(let i=0;i<this.searches.length;i++){let search=this.searches[i]
let operator=overlay.find('#grid_'+this.name+'_operator_'+i).val()
let field1=overlay.find('#grid_'+this.name+'_field_'+i)
let field2=overlay.find('#grid_'+this.name+'_field2_'+i)
let value1=field1.val()
let value2=field2.val()
let svalue=null
let text=null
if(['int','float','money','currency','percent'].indexOf(search.type)!=-1){let fld1=field1[0]._w2field
let fld2=field2[0]._w2field
if(fld1)value1=fld1.clean(value1)
if(fld2)value2=fld2.clean(value2)}
if(['list','enum'].indexOf(search.type)!=-1||['in','not in'].indexOf(operator)!=-1){value1=field1[0]._w2field.selected||{}
if(Array.isArray(value1)){svalue=[]
for(let j=0;j<value1.length;j++){svalue.push(w2utils.isFloat(value1[j].id)?parseFloat(value1[j].id):String(value1[j].id).toLowerCase())
delete value1[j].hidden}
if(Object.keys(value1).length===0)value1=''}else{text=value1.text||''
value1=value1.id||''}}
if((value1!==''&&value1!=null)||(value2!=null&&value2!=='')){let tmp={field:search.field,type:search.type,operator:operator}
if(operator=='between'){w2utils.extend(tmp,{value:[value1,value2]})}else if(operator=='in'&&typeof value1=='string'){w2utils.extend(tmp,{value:value1.split(',')})}else if(operator=='not in'&&typeof value1=='string'){w2utils.extend(tmp,{value:value1.split(',')})}else{w2utils.extend(tmp,{value:value1})}
if(svalue)w2utils.extend(tmp,{svalue:svalue})
if(text)w2utils.extend(tmp,{text:text})
try{if(search.type=='date'&&operator=='between'){tmp.value[0]=value1
tmp.value[1]=value2}
if(search.type=='date'&&operator=='is'){tmp.value=value1}}catch(e){}
searchData.push(tmp)
last_multi=true}}}
if(typeof field=='string'){if(arguments.length==1){value=field
field='all'}
last_field=field
last_search=value
last_multi=false
last_logic=(hasHiddenSearches?'AND':'OR')
if(value!=null){if(field.toLowerCase()=='all'){if(this.searches.length>0){for(let i=0;i<this.searches.length;i++){let search=this.searches[i]
if(search.type=='text'||(search.type=='alphanumeric'&&w2utils.isAlphaNumeric(value))||(search.type=='int'&&w2utils.isInt(value))||(search.type=='float'&&w2utils.isFloat(value))||(search.type=='percent'&&w2utils.isFloat(value))||((search.type=='hex'||search.type=='color')&&w2utils.isHex(value))||(search.type=='currency'&&w2utils.isMoney(value))||(search.type=='money'&&w2utils.isMoney(value))||(search.type=='date'&&w2utils.isDate(value))||(search.type=='time'&&w2utils.isTime(value))||(search.type=='datetime'&&w2utils.isDateTime(value))||(search.type=='datetime'&&w2utils.isDate(value))||(search.type=='enum'&&w2utils.isAlphaNumeric(value))||(search.type=='list'&&w2utils.isAlphaNumeric(value))){let def=this.defaultOperator[this.operatorsMap[search.type]]
let tmp={field:search.field,type:search.type,operator:(search.operator!=null?search.operator:def),value:value}
if(String(value).trim()!='')searchData.push(tmp)}
if(['int','float','money','currency','percent'].indexOf(search.type)!=-1&&String(value).trim().split('-').length==2){let t=String(value).trim().split('-')
let tmp={field:search.field,type:search.type,operator:(search.operator!=null?search.operator:'between'),value:[t[0],t[1]]}
searchData.push(tmp)}
if(['list','enum'].indexOf(search.type)!=-1){let new_values=[]
if(search.options==null)search.options={}
if(!Array.isArray(search.options.items))search.options.items=[]
for(let j=0;j<search.options.items;j++){let tmp=search.options.items[j]
try{let re=new RegExp(value,'i')
if(re.test(tmp))new_values.push(j)
if(tmp.text&&re.test(tmp.text))new_values.push(tmp.id)}catch(e){}}
if(new_values.length>0){let tmp={field:search.field,type:search.type,operator:(search.operator!=null?search.operator:'in'),value:new_values}
searchData.push(tmp)}}}}else{for(let i=0;i<this.columns.length;i++){let tmp={field:this.columns[i].field,type:'text',operator:this.defaultOperator.text,value:value}
searchData.push(tmp)}}
if(searchData.length==0){let tmp={field:'All',type:'text',operator:this.defaultOperator.text,value:value}
searchData.push(tmp)}}else{let el=overlay.find('#grid_'+this.name+'_search_all')
let search=this.getSearch(field)
if(search==null)search={field:field,type:'text'}
if(search.field==field)this.last.label=search.label
if(value!==''){let op=this.defaultOperator[this.operatorsMap[search.type]]
let val=value
if(['date','time','datetime'].indexOf(search.type)!=-1)op='is'
if(['list','enum'].indexOf(search.type)!=-1){op='is'
let tmp=el._w2field.get()
if(tmp&&Object.keys(tmp).length>0)val=tmp.id;else val=''}
if(search.type=='int'&&value!==''){op='is'
if(String(value).indexOf('-')!=-1){let tmp=value.split('-')
if(tmp.length==2){op='between'
val=[parseInt(tmp[0]),parseInt(tmp[1])]}}
if(String(value).indexOf(',')!=-1){let tmp=value.split(',')
op='in'
val=[]
for(let i=0;i<tmp.length;i++)val.push(tmp[i])}}
if(search.operator!=null)op=search.operator
let tmp={field:search.field,type:search.type,operator:op,value:val}
searchData.push(tmp)}}}}
if(Array.isArray(field)){let logic='AND'
if(typeof value=='string'){logic=value.toUpperCase()
if(logic!='OR'&&logic!='AND')logic='AND'}
last_search=''
last_multi=true
last_logic=logic
for(let i=0;i<field.length;i++){let data=field[i]
if(typeof data.value=='number'&&data.operator==null)data.operator=this.defaultOperator.number
if(typeof data.value=='string'&&data.operator==null)data.operator=this.defaultOperator.text
if(Array.isArray(data.value)&&data.operator==null)data.operator=this.defaultOperator.enum
if(w2utils.isDate(data.value)&&data.operator==null)data.operator=this.defaultOperator.date
searchData.push(data)}}
let edata=this.trigger('search',{target:this.name,multi:(arguments.length===0?true:false),searchField:(field?field:'multi'),searchValue:(field?value:'multi'),searchData:searchData,searchLogic:last_logic})
if(edata.isCancelled===true)return
this.searchData=edata.detail.searchData
this.last.field=last_field
this.last.search=last_search
this.last.multi=last_multi
this.last.logic=edata.detail.searchLogic
this.last.vscroll.scrollTop=0
this.last.vscroll.scrollLeft=0
this.last.selection.indexes=[]
this.last.selection.columns={}
this.searchClose()
if(url){this.last.fetch.offset=0
this.reload()}else{this.localSearch()
this.refresh()}
edata.finish()}
searchOpen(){if(!this.box)return
if(this.searches.length===0)return
let edata=this.trigger('searchOpen',{target:this.name})
if(edata.isCancelled===true){return}
let $btn=query(this.toolbar.box).find('.w2ui-grid-search-input .w2ui-search-drop')
$btn.addClass('checked')
w2tooltip.show({name:this.name+'-search-overlay',anchor:query(this.box).find('#grid_'+this.name+'_search_all').get(0),position:'bottom|top',html:this.getSearchesHTML(),align:'left',arrowSize:12,class:'w2ui-grid-search-advanced',hideOn:['doc-click']}).then(event=>{this.initSearches()
this.last.search_opened=true
let overlay=query(`#w2overlay-${this.name}-search-overlay`)
overlay.data('gridName',this.name).off('.grid-search').on('click.grid-search',()=>{overlay.find('input, select').each(el=>{let names=query(el).data('tooltipName')
if(names)names.forEach(name=>{w2tooltip.hide(name)})})})
w2utils.bindEvents(overlay.find('select, input, button'),this)
let sfields=query(`#w2overlay-${this.name}-search-overlay *[rel=search]`)
if(sfields.length>0)sfields[0].focus()
edata.finish()}).hide(event=>{$btn.removeClass('checked')
this.last.search_opened=false})}
searchClose(){w2tooltip.hide(this.name+'-search-overlay')}
searchFieldTooltip(ind,sd_ind,el){let sf=this.searches[ind]
let sd=this.searchData[sd_ind]
let oper=sd.operator
if(oper=='more'&&sd.type=='date')oper='since'
if(oper=='less'&&sd.type=='date')oper='before'
let options=''
let val=sd.value
if(Array.isArray(sd.value)){sd.value.forEach(opt=>{options+=`<span class="value">${opt.text || opt}</span>`})
if(sd.type=='date'){options=''
sd.value.forEach(opt=>{options+=`<span class="value">${w2utils.formatDate(opt)}</span>`})}}else{if(sd.type=='date'){val=w2utils.formatDateTime(val)}}
w2tooltip.hide(this.name+'-search-props')
w2tooltip.show({name:this.name+'-search-props',anchor:el,class:'w2ui-white',hideOn:'doc-click',html:`
                <div class="w2ui-grid-search-single">
                    <span class="field">${sf.label}</span>
                    <span class="operator">${w2utils.lang(oper)}</span>
                    ${Array.isArray(sd.value)
                        ? `${options}`
                        : `<span class="value">${val}</span>`
                    }
                    <div class="buttons">
                        <button id="remove" class="w2ui-btn">${w2utils.lang('Remove This Field')}</button>
                    </div>
                </div>`}).then(event=>{query(event.detail.overlay.box).find('#remove').on('click',()=>{this.searchData.splice(`${sd_ind}`,1)
this.reload()
this.localSearch()
w2tooltip.hide(this.name+'-search-props')})})}
searchSuggest(imediate,forceHide,input){clearTimeout(this.last.kbd_timer)
clearTimeout(this.last.overlay_timer)
this.searchShowFields(true)
this.searchClose()
if(forceHide===true){w2tooltip.hide(this.name+'-search-suggest')
return}
if(query(`#w2overlay-${this.name}-search-suggest`).length>0){return}
if(!imediate){this.last.overlay_timer=setTimeout(()=>{this.searchSuggest(true)},100)
return}
let el=query(this.box).find(`#grid_${this.name}_search_all`).get(0)
let searches=[...this.defaultSearches??[],...this.defaultSearches?.length>0&&this.savedSearches?.length>0?['--']:[],...this.savedSearches??[]]
if(Array.isArray(searches)&&searches.length>0){w2menu.show({name:this.name+'-search-suggest',anchor:el,align:'both',items:searches,hideOn:['doc-click','sleect','remove'],render(item){let ret=item.text
if(item.isDefault)ret=`<b>${ret}</b>`
return ret}}).select(event=>{let edata=this.trigger('searchSelect',{target:this.name,index:event.detail.index,item:event.detail.item})
if(edata.isCancelled===true){event.preventDefault()
return}
event.detail.overlay.hide()
this.last.logic=event.detail.item.logic||'AND'
this.last.search=''
this.last.label='[Multiple Fields]'
this.searchData=w2utils.clone(event.detail.item.data)
this.searchSelected=w2utils.clone(event.detail.item,{exclude:['icon','remove']})
this.reload()
edata.finish()}).remove(event=>{let item=event.detail.item
let edata=this.trigger('searchRemove',{target:this.name,index:event.detail.index,item})
if(edata.isCancelled===true){event.preventDefault()
return}
event.detail.overlay.hide()
this.confirm(w2utils.lang('Do you want to delete search "${item}"?',{item:item.text})).yes(evt=>{let search=this.savedSearches.findIndex((s)=>s.id==item.id?true:false)
if(search!==-1){this.savedSearches.splice(search,1)}
this.cacheSave('searches',this.savedSearches.map(s=>w2utils.clone(s,{exclude:['remove','icon']})))
evt.detail.self.close()
edata.finish()}).no(evt=>{evt.detail.self.close()})})}}
searchSave(){let value=''
if(this.searchSelected){value=this.searchSelected.text}
let ind=this.savedSearches.findIndex(s=>{return s.id==this.searchSelected?.id?true:false})
let edata=this.trigger('searchSave',{target:this.name,saveLocalStorage:true})
if(edata.isCancelled===true)return
this.message({width:350,height:150,body:`<div class="w2ui-grid-save-search">
                        <span>${w2utils.lang(ind != -1 ? 'Update Search' : 'Save New Search')}</span>
                        <input class="search-name w2ui-input" placeholder="${w2utils.lang('Search name')}">
                   </div>`,buttons:`
                <button id="grid-search-cancel" class="w2ui-btn">${w2utils.lang('Cancel')}</button>
                <button id="grid-search-save" class="w2ui-btn w2ui-btn-blue" ${String(value).trim() == '' ? 'disabled': ''}>${w2utils.lang('Save')}</button>
            `}).open(async(event)=>{query(event.detail.box).find('input, button').eq(0).val(value)
await event.complete
query(event.detail.box).find('#grid-search-cancel').on('click',()=>{this.message()})
query(event.detail.box).find('#grid-search-save').on('click',()=>{let name=query(event.detail.box).find('.w2ui-message .search-name').val()
if(this.searchSelected&&ind!=-1){Object.assign(this.savedSearches[ind],{id:name,text:name,logic:this.last.logic,data:w2utils.clone(this.searchData)})}else{this.savedSearches.push({id:name,text:name,icon:'w2ui-icon-search',remove:true,logic:this.last.logic,data:this.searchData})}
this.cacheSave('searches',this.savedSearches.map(s=>w2utils.clone(s,{exclude:['remove','icon']})))
this.message()
if(this.searchSelected){this.searchSelected.text=name
query(this.box).find(`#grid_${this.name}_search_name .name-text`).html(name)}else{this.searchSelected={text:name,logic:this.last.logic,data:w2utils.clone(this.searchData)}
query(event.detail.box).find(`#grid_${this.name}_search_all`).val(' ').prop('readOnly',true)
query(event.detail.box).find(`#grid_${this.name}_search_name`).show().find('.name-text').html(name)}
edata.finish({name})})
query(event.detail.box).find('input, button').off('.message').on('keydown.message',evt=>{let val=String(query(event.detail.box).find('.w2ui-message-body input').val()).trim()
if(evt.keyCode==13&&val!=''){query(event.detail.box).find('#grid-search-save').trigger('click')}
if(evt.keyCode==27){this.message()}}).eq(0).on('input.message',evt=>{let $save=query(event.detail.box).closest('.w2ui-message').find('#grid-search-save')
if(String(query(event.detail.box).val()).trim()===''){$save.prop('disabled',true)}else{$save.prop('disabled',false)}}).get(0).focus()})}
cache(type){if(w2utils.hasLocalStorage&&this.useLocalStorage){try{let data=JSON.parse(localStorage.w2ui||'{}')
data[(this.stateId||this.name)]??={}
return data[(this.stateId||this.name)][type]}catch(e){}}
return null}
cacheSave(type,value){if(w2utils.hasLocalStorage&&this.useLocalStorage){try{let data=JSON.parse(localStorage.w2ui||'{}')
data[(this.stateId||this.name)]??={}
data[(this.stateId||this.name)][type]=value
localStorage.w2ui=JSON.stringify(data)
return true}catch(e){delete localStorage.w2ui}}
return false}
searchReset(noReload){let searchData=[]
let hasHiddenSearches=false
for(let i=0;i<this.searches.length;i++){if(!this.searches[i].hidden||this.searches[i].value==null)continue
searchData.push({field:this.searches[i].field,operator:this.searches[i].operator||'is',type:this.searches[i].type,value:this.searches[i].value||''})
hasHiddenSearches=true}
let edata=this.trigger('search',{reset:true,target:this.name,searchData:searchData})
if(edata.isCancelled===true)return
let input=query(this.box).find('#grid_'+this.name+'_search_all')
this.searchData=edata.detail.searchData
this.searchSelected=null
this.last.search=''
this.last.logic=(hasHiddenSearches?'AND':'OR')
input.next().hide()
if(this.searches.length>0){if(!this.multiSearch||!this.show.searchAll){let tmp=0
while(tmp<this.searches.length&&(this.searches[tmp].hidden||this.searches[tmp].simple===false))tmp++
if(tmp>=this.searches.length){this.last.field=''
this.last.label=''}else{this.last.field=this.searches[tmp].field
this.last.label=this.searches[tmp].label}}else{this.last.field='all'
this.last.label='All Fields'
input.next().show()}}
this.last.multi=false
this.last.fetch.offset=0
this.last.vscroll.scrollTop=0
this.last.vscroll.scrollLeft=0
this.last.selection.indexes=[]
this.last.selection.columns={}
this.searchClose()
let all=input.val('').get(0)
if(all?._w2field){all._w2field.reset()}
if(!noReload)this.reload()
edata.finish()}
searchShowFields(forceHide){if(forceHide===true){w2tooltip.hide(this.name+'-search-fields')
return}
let items=[]
for(let s=-1;s<this.searches.length;s++){let search=this.searches[s]
let sField=(search?search.field:null)
let column=this.getColumn(sField)
let disabled=false
let tooltip=null
if(this.show.searchHiddenMsg==true&&s!=-1&&(column==null||(column.hidden===true&&column.hideable!==false))){disabled=true
tooltip=w2utils.lang(`This column ${column == null ? 'does not exist' : 'is hidden'}`)}
if(s==-1){if(!this.multiSearch||!this.show.searchAll)continue
search={field:'all',label:'All Fields'}}else{if(column!=null&&column.hideable===false)continue
if(search.hidden===true){tooltip=w2utils.lang('This column is hidden')
if(search.simple===false)continue}}
if(search.label==null&&search.caption!=null){console.log('NOTICE: grid search.caption property is deprecated, please use search.label. Search ->',search)
search.label=search.caption}
items.push({id:search.field,text:w2utils.lang(search.label),search,tooltip,disabled,checked:(search.field==this.last.field)})}
w2menu.show({type:'radio',name:this.name+'-search-fields',anchor:query(this.box).find('#grid_'+this.name+'_search_name').parent().find('.w2ui-search-down').get(0),items,align:'none',hideOn:['doc-click','select']}).select(event=>{this.searchInitInput(event.detail.item.search.field)})}
searchInitInput(field,value){let search
let el=query(this.box).find('#grid_'+this.name+'_search_all')
if(field=='all'){search={field:'all',label:w2utils.lang('All Fields')}}else{search=this.getSearch(field)
if(search==null)return}
if(this.last.search!=''){this.last.label=search.label
this.search(search.field,this.last.search)}else{this.last.field=search.field
this.last.label=search.label}
el.attr('placeholder',w2utils.lang('Search')+' '+w2utils.lang(search.label||search.caption||search.field,true))
if(this.searchSelected){query(this.box).find(`#grid_${this.name}_search_all`).val(' ').prop('readOnly',true)
query(this.box).find(`#grid_${this.name}_search_name`).show().find('.name-text').html(this.searchSelected.text)}else{query(this.box).find(`#grid_${this.name}_search_all`).prop('readOnly',false)
query(this.box).find(`#grid_${this.name}_search_name`).hide().find('.name-text').html('')}}
clear(noRefresh){this.total=0
this.records=[]
this.summary=[]
this.last.fetch.offset=0
this.last.idCache={}
this.last.selection={indexes:[],columns:{}}
this.reset(true)
if(!noRefresh)this.refresh()}
reset(noRefresh){this.last.vscroll.scrollTop=0
this.last.vscroll.scrollLeft=0
this.last.vscroll.recIndStart=null
this.last.vscroll.recIndEnd=null
query(this.box).find(`#grid_${this.name}_records`).prop('scrollTop',0)
if(!noRefresh)this.refresh()}
skip(offset,callBack){let url=this.url?.get??this.url
if(url){this.offset=parseInt(offset)
if(this.offset>this.total)this.offset=this.total-this.limit
if(this.offset<0||!w2utils.isInt(this.offset))this.offset=0
this.clear(true)
this.reload(callBack)}else{console.log('ERROR: grid.skip() can only be called when you have remote data source.')}}
load(url,callBack){if(url==null){console.log('ERROR: You need to provide url argument when calling .load() method of "'+this.name+'" object.')
return new Promise((resolve,reject)=>{reject()})}
this.clear(true)
return this.request('load',{},url,callBack)}
reload(callBack){let grid=this
let url=this.url?.get??this.url
grid.selectionSave()
if(url){return this.load(url,()=>{grid.selectionRestore()
if(typeof callBack=='function')callBack()})}else{this.reset(true)
this.localSearch()
this.selectionRestore()
if(typeof callBack=='function')callBack({status:'success'})
return new Promise(resolve=>{resolve()})}}
request(action,postData,url,callBack){let self=this
let resolve,reject
let requestProm=new Promise((res,rej)=>{resolve=res;reject=rej})
if(postData==null)postData={}
if(!url)url=this.url
if(!url)return new Promise((resolve,reject)=>{reject()})
if(!w2utils.isInt(this.offset))this.offset=0
if(!w2utils.isInt(this.last.fetch.offset))this.last.fetch.offset=0
let edata
let params={limit:this.limit,offset:parseInt(this.offset)+parseInt(this.last.fetch.offset),searchLogic:this.last.logic,search:this.searchData.map((search)=>{let _search=w2utils.clone(search)
if(this.searchMap&&this.searchMap[_search.field])_search.field=this.searchMap[_search.field]
return _search}),sort:this.sortData.map((sort)=>{let _sort=w2utils.clone(sort)
if(this.sortMap&&this.sortMap[_sort.field])_sort.field=this.sortMap[_sort.field]
return _sort})}
if(this.searchData.length===0){delete params.search
delete params.searchLogic}
if(this.sortData.length===0){delete params.sort}
w2utils.extend(params,this.postData)
w2utils.extend(params,postData)
if(action=='delete'||action=='save'){delete params.limit
delete params.offset
params.action=action
if(action=='delete'){params[this.recid||'recid']=this.getSelection()}}
if(action=='load'){edata=this.trigger('request',{target:this.name,url,postData:params,httpMethod:'GET',httpHeaders:this.httpHeaders})
if(edata.isCancelled===true)return new Promise((resolve,reject)=>{reject()})}else{edata={detail:{url,postData:params,httpMethod:action=='save'?'PUT':'DELETE',httpHeaders:this.httpHeaders}}}
if(this.last.fetch.offset===0){this.lock(w2utils.lang(this.msgRefresh),true)}
if(this.last.fetch.controller)try{this.last.fetch.controller.abort()}catch(e){}
url=edata.detail.url
switch(action){case'save':if(url?.save)url=url.save
break
case'delete':if(url?.remove)url=url.remove
break
default:url=url?.get??url}
if(Object.keys(this.routeData).length>0){let info=w2utils.parseRoute(url)
if(info.keys.length>0){for(let k=0;k<info.keys.length;k++){if(this.routeData[info.keys[k].name]==null)continue
url=url.replace((new RegExp(':'+info.keys[k].name,'g')),this.routeData[info.keys[k].name])}}}
url=new URL(url,location)
let fetchOptions=w2utils.prepareParams(url,{method:edata.detail.httpMethod,headers:edata.detail.httpHeaders,body:edata.detail.postData},this.dataType)
Object.assign(this.last.fetch,{action:action,options:fetchOptions,controller:new AbortController(),start:Date.now(),loaded:false})
fetchOptions.signal=this.last.fetch.controller.signal
fetch(url,fetchOptions).catch(processError).then(resp=>{if(resp==null)return
if(resp?.status!=200){processError(resp??{})
return}
self.unlock()
resp.json().catch(processError).then(data=>{this.requestComplete(data,action,callBack,resolve,reject)})})
if(action=='load'){edata.finish()}
return requestProm
function processError(response){if(response?.name==='AbortError'){return}
self.unlock()
let edata2=self.trigger('error',{response,lastFetch:self.last.fetch})
if(edata2.isCancelled===true)return
if(response.status&&response.status!=200){response.json().then((data)=>{self.error(response.status+': '+data.message??response.statusText)}).catch(()=>{self.error(response.status+': '+response.statusText)})}else{console.log('ERROR: Server communication failed.','\n   EXPECTED:',{total:5,records:[{recid:1,field:'value'}]},'\n         OR:',{error:true,message:'error message'})
self.requestComplete({error:true,message:w2utils.lang(this.msgHTTPError),response},action,callBack,resolve,reject)}
edata2.finish()}}
requestComplete(data,action,callBack,resolve,reject){let error=data.error??false
if(data.error==null&&data.status==='error')error=true
this.last.fetch.response=(Date.now()-this.last.fetch.start)/1000
setTimeout(()=>{if(this.show.statusResponse){this.status(w2utils.lang('Server Response ${count} seconds',{count:this.last.fetch.response}))}},10)
this.last.vscroll.pull_more=false
this.last.vscroll.pull_refresh=true
let event_name='load'
if(this.last.fetch.action=='save')event_name='save'
if(this.last.fetch.action=='delete')event_name='delete'
let edata=this.trigger(event_name,{target:this.name,error,data,lastFetch:this.last.fetch})
if(edata.isCancelled===true){reject()
return}
if(!error){if(typeof this.parser=='function'){data=this.parser(data)
if(typeof data!='object'){console.log('ERROR: Your parser did not return proper object')}}else{if(data==null){data={error:true,message:w2utils.lang(this.msgNotJSON),}}else if(Array.isArray(data)){data={error,records:data,total:data.length}}}
if(action=='load'){if(data.total==null)data.total=-1
if(data.records==null){data.records=[]}
if(data.records.length==this.limit){let loaded=this.records.length+data.records.length
this.last.fetch.hasMore=(loaded==this.total?false:true)}else{this.last.fetch.hasMore=false
this.total=this.offset+this.last.fetch.offset+data.records.length}
if(!this.last.fetch.hasMore){query(this.box).find('#grid_'+this.name+'_rec_more, #grid_'+this.name+'_frec_more').hide()}
if(this.last.fetch.offset===0){this.records=[]
this.summary=[]}else{if(data.total!=-1&&parseInt(data.total)!=parseInt(this.total)){let grid=this
this.message(w2utils.lang(this.msgNeedReload)).ok(()=>{delete grid.last.fetch.offset
grid.reload()})
return new Promise(resolve=>{resolve()})}}
if(w2utils.isInt(data.total))this.total=parseInt(data.total)
if(data.records){data.records.forEach(rec=>{if(this.recid){rec.recid=this.parseField(rec,this.recid)}
if(rec.recid==null){rec.recid='recid-'+this.records.length}
if(rec.w2ui?.summary===true){this.summary.push(rec)}else{this.records.push(rec)}})}
if(data.summary){this.summary=[]
data.summary.forEach(rec=>{if(this.recid){rec.recid=this.parseField(rec,this.recid)}
if(rec.recid==null){rec.recid='recid-'+this.summary.length}
this.summary.push(rec)})}}else if(action=='delete'){this.reset()
return this.reload()}}else{this.error(w2utils.lang(data.message??this.msgServerError))
reject(data)}
let url=this.url?.get??this.url
if(!url){this.localSort()
this.localSearch()}
this.total=parseInt(this.total)
if(this.last.fetch.offset===0){this.refresh()}else{this.scroll()
this.resize()}
if(typeof callBack=='function')callBack(data)
resolve(data)
edata.finish()
this.last.fetch.loaded=true}
error(msg){let edata=this.trigger('error',{target:this.name,message:msg})
if(edata.isCancelled===true){return}
this.message(msg)
edata.finish()}
getChanges(recordsBase){let changes=[]
if(typeof recordsBase=='undefined'){recordsBase=this.records}
for(let r=0;r<recordsBase.length;r++){let rec=recordsBase[r]
if(rec?.w2ui){if(rec.w2ui.changes!=null){let obj={}
obj[this.recid||'recid']=rec.recid
changes.push(w2utils.extend(obj,rec.w2ui.changes))}
if(rec.w2ui.expanded!==true&&rec.w2ui.children&&rec.w2ui.children.length){changes.push(...this.getChanges(rec.w2ui.children))}}}
return changes}
mergeChanges(){let changes=this.getChanges()
for(let c=0;c<changes.length;c++){let record=this.get(changes[c][this.recid||'recid'])
for(let s in changes[c]){if(s=='recid'||(this.recid&&s==this.recid))continue
if(typeof changes[c][s]==='object')changes[c][s]=changes[c][s].text
try{_setValue(record,s,changes[c][s])}catch(e){console.log('ERROR: Cannot merge. ',e.message||'',e)}
if(record.w2ui)delete record.w2ui.changes}}
this.refresh()
function _setValue(obj,field,value){let fld=field.split('.')
if(fld.length==1){obj[field]=value}else{obj=obj[fld[0]]
fld.shift()
_setValue(obj,fld.join('.'),value)}}}
save(callBack){let changes=this.getChanges()
let url=this.url?.save??this.url
let edata=this.trigger('save',{target:this.name,changes:changes})
if(edata.isCancelled===true)return
if(url){this.request('save',{'changes':edata.detail.changes},null,(data)=>{if(!data.error){this.mergeChanges()}
edata.finish()
if(typeof callBack=='function')callBack(data)})}else{this.mergeChanges()
edata.finish()}}
editField(recid,column,value,event){let self=this
if(this.last.inEditMode===true){if(event&&event.keyCode==13){let{index,column,value}=this.last._edit
this.editChange({type:'custom',value},index,column,event)
this.editDone(index,column,event)}else{let input=query(this.box).find('div.w2ui-edit-box .w2ui-input')
if(input.length>0){if(input.get(0).tagName=='DIV'){input.text(input.text()+value)
w2utils.setCursorPosition(input.get(0),input.text().length)}else{input.val(input.val()+value)
w2utils.setCursorPosition(input.get(0),input.val().length)}}}
return}
let index=this.get(recid,true)
let edit=this.getCellEditable(index,column)
if(!edit||['checkbox','check'].includes(edit.type))return
let rec=this.records[index]
let col=this.columns[column]
let prefix=(col.frozen===true?'_f':'_')
if(['enum','file'].indexOf(edit.type)!=-1){console.log('ERROR: input types "enum" and "file" are not supported in inline editing.')
return}
let edata=this.trigger('editField',{target:this.name,recid,column,value,index,originalEvent:event})
if(edata.isCancelled===true)return
value=edata.detail.value
this.last.inEditMode=true
this.last.editColumn=column
this.last._edit={value:value,index:index,column:column,recid:recid}
this.selectNone(true)
this.select({recid:recid,column:column})
let tr=query(this.box).find('#grid_'+this.name+prefix+'rec_'+w2utils.escapeId(recid))
let div=tr.find('[col="'+column+'"] > div')
this.last._edit.tr=tr
this.last._edit.div=div
query(this.box).find('div.w2ui-edit-box').remove()
if(this.selectType!='row'){query(this.box).find('#grid_'+this.name+prefix+'selection').attr('id','grid_'+this.name+'_editable').removeClass('w2ui-selection').addClass('w2ui-edit-box').prepend('<div style="position: absolute; top: 0px; bottom: 0px; left: 0px; right: 0px;"></div>').find('.w2ui-selection-resizer').remove()
div=query(this.box).find('#grid_'+this.name+'_editable > div:first-child')}
edit.attr=edit.attr??''
edit.text=edit.text??''
edit.style=edit.style??''
edit.items=edit.items??[]
let val=(rec.w2ui?.changes?.[col.field]!=null?w2utils.stripTags(rec.w2ui.changes[col.field]):w2utils.stripTags(self.parseField(rec,col.field)))
if(val==null)val=''
let prevValue=(typeof val!='object'?val:'')
if(edata.detail.prevValue!=null)prevValue=edata.detail.prevValue
if(value!=null)val=value
let addStyle=(col.style!=null?col.style+';':'')
if(typeof col.render=='string'&&['number','int','float','money','percent','size'].includes(col.render.split(':')[0])){addStyle+='text-align: right;'}
if(edit.items.length>0&&!w2utils.isPlainObject(edit.items[0])){edit.items=w2utils.normMenu(edit.items)}
let input
let dropTypes=['date','time','datetime','color','list','combo']
let styles=getComputedStyle(tr.find('[col="'+column+'"] > div').get(0))
let font=`font-family: ${styles['font-family']}; font-size: ${styles['font-size']};`
switch(edit.type){case'div':{div.addClass('w2ui-editable').html(w2utils.stripSpaces(`<div id="grid_${this.name}_edit_${recid}_${column}" class="w2ui-input w2ui-focus"
                        contenteditable autocorrect="off" autocomplete="off" spellcheck="false"
                        style="${font + addStyle + edit.style}"
                        field="${col.field}" recid="${recid}" column="${column}" ${edit.attr}>
                    </div>${edit.text}`))
input=div.find('div.w2ui-input').get(0)
input.innerText=(typeof val!='object'?val:'')
if(value!=null){w2utils.setCursorPosition(input,input.innerText.length)}else{w2utils.setCursorPosition(input,0,input.innerText.length)}
break}
default:{div.addClass('w2ui-editable').html(w2utils.stripSpaces(`<input id="grid_${this.name}_edit_${recid}_${column}" class="w2ui-input"
                        autocorrect="off" autocomplete="off" spellcheck="false" type="text"
                        style="${font + addStyle + edit.style}"
                        field="${col.field}" recid="${recid}" column="${column}" ${edit.attr}>${edit.text}`))
input=div.find('input').get(0)
if(edit.type=='number'){val=w2utils.formatNumber(val)}
if(edit.type=='date'){val=w2utils.formatDate(w2utils.isDate(val,edit.format,true)||new Date(),edit.format)}
input.value=(typeof val!='object'?val:'')
let doHide=(event)=>{let escKey=this.last._edit?.escKey
let selected=false
let name=query(input).data('tooltipName')
if(name&&w2tooltip.get(name[0])?.selected!=null){selected=true}
if(this.last.inEditMode&&!escKey&&dropTypes.includes(edit.type)&&(event.detail.overlay.anchor?.id==this.last._edit.input?.id||edit.type=='list')){this.editChange()
this.editDone(undefined,undefined,{keyCode:selected?13:0})}}
new w2field(w2utils.extend({},edit,{el:input,selected:val,onSelect:doHide,onHide:doHide}))
if(value==null&&input){input.select()}}}
Object.assign(this.last._edit,{input,edit})
query(input).off('.w2ui-editable').on('blur.w2ui-editable',(event)=>{if(this.last.inEditMode){let type=this.last._edit.edit.type
let name=query(input).data('tooltipName')
if((name&&dropTypes.includes(type))||event.target._keepOpen===true){delete event.target._keepOpen
return}
this.editChange(input,index,column,event)
this.editDone()}}).on('mousedown.w2ui-editable',(event)=>{event.stopPropagation()}).on('click.w2ui-editable',(event)=>{expand.call(input,event)}).on('paste.w2ui-editable',(event)=>{event.preventDefault()
let text=event.clipboardData.getData('text/plain')
document.execCommand('insertHTML',false,text)}).on('keyup.w2ui-editable',(event)=>{expand.call(input,event)}).on('keydown.w2ui-editable',(event)=>{switch(event.keyCode){case 8:if(edit.type=='list'&&!input._w2field){event.preventDefault()}
break
case 9:case 13:event.preventDefault()
break
case 27:let name=query(input).data('tooltipName')
if(name&&name.length>0){this.last._edit.escKey=true
w2tooltip.hide(name[0])
event.preventDefault()
return}
event.stopPropagation()
break}
setTimeout(()=>{switch(event.keyCode){case 9:{let next=event.shiftKey?self.prevCell(index,column,true):self.nextCell(index,column,true)
if(next!=null){let recid=self.records[next.index].recid
this.editChange(input,index,column,event)
this.editDone(index,column,event)
if(self.selectType!='row'){self.selectNone(true)
self.select({recid,column:next.colIndex})}else{self.editField(recid,next.colIndex,null,event)}
if(event.preventDefault)event.preventDefault()}
break}
case 13:{let selected=false
let name=query(input).data('tooltipName')
if(name&&w2tooltip.get(name[0]).selected!=null){selected=true}
if((!name||!selected)&&input._keepOpen!==true){this.editChange(input,index,column,event)
this.editDone(index,column,event)}else{delete input._keepOpen}
break}
case 27:{this.last._edit.escKey=false
let old=self.parseField(rec,col.field)
if(rec.w2ui?.changes?.[col.field]!=null)old=rec.w2ui.changes[col.field]
if(input._prevValue!=null)old=input._prevValue
if(input.tagName=='DIV'){input.innerText=old!=null?old:''}else{input.value=old!=null?old:''}
this.editDone(index,column,event)
setTimeout(()=>{self.select({recid:recid,column:column})},1)
break}}
expand(input)},1)})
if(input)input._prevValue=prevValue
if(edit.type!='list'){setTimeout(()=>{if(!this.last.inEditMode)return
if(input){input.focus()
clearTimeout(this.last.kbd_timer)
input.resize=expand
expand(input)}},50)}
edata.finish({input})
return
function expand(input){try{let styles=getComputedStyle(input)
let val=(input.tagName.toUpperCase()=='DIV'?input.innerText:input.value)
let editBox=query(self.box).find('#grid_'+self.name+'_editable').get(0)
let style=`font-family: ${styles['font-family']}; font-size: ${styles['font-size']}; white-space: no-wrap;`
let width=w2utils.getStrWidth(val,style)
if(width+20>editBox.clientWidth){query(editBox).css('width',width+20+'px')}}catch(e){}}}
editChange(input,index,column,event){input=input??this.last._edit.input
index=index??this.last._edit.index
column=column??this.last._edit.column
event=event??{}
let summary=index<0
index=index<0?-index-1:index
let records=summary?this.summary:this.records
let rec=records[index]
let col=this.columns[column]
let new_val=(input?.tagName=='DIV'?input.innerText:input.value)
let fld=input._w2field
if(fld){if(fld.type=='list'){new_val=fld.selected}
if(new_val==null||Object.keys(new_val).length===0)new_val=''
if(!w2utils.isPlainObject(new_val))new_val=fld.clean(new_val)}
if(input.type=='checkbox'){if(rec.w2ui?.editable===false)input.checked=!input.checked
new_val=input.checked}
let old_val=this.parseField(rec,col.field)
let prev_val=(rec.w2ui?.changes&&rec.w2ui.changes.hasOwnProperty(col.field)?rec.w2ui.changes[col.field]:old_val)
let edata={target:this.name,input,recid:rec.recid,index,column,originalEvent:event,value:{new:new_val,previous:prev_val,original:old_val,}}
if(event.target?._prevValue!=null)edata.value.previous=event.target._prevValue
let count=0
while(count<20){count++
new_val=edata.value.new
if((typeof new_val!='object'&&String(old_val)!=String(new_val))||(typeof new_val=='object'&&new_val&&new_val.id!=old_val&&(typeof old_val!='object'||old_val==null||new_val.id!=old_val.id))){edata=this.trigger('change',edata)
if(edata.isCancelled!==true){if(new_val!==edata.detail.value.new){continue}
if((edata.detail.value.new===''||edata.detail.value.new==null)&&(prev_val===''||prev_val==null)){}else{rec.w2ui=rec.w2ui??{}
rec.w2ui.changes=rec.w2ui.changes??{}
rec.w2ui.changes[col.field]=edata.detail.value.new}
edata.finish()}}else{edata=this.trigger('restore',edata)
if(edata.isCancelled!==true){if(new_val!==edata.detail.value.new){continue}
if(rec.w2ui?.changes){delete rec.w2ui.changes[col.field]
if(Object.keys(rec.w2ui.changes).length===0){delete rec.w2ui.changes}}
edata.finish()}}
break}}
editDone(index,column,event){index=index??this.last._edit.index
column=column??this.last._edit.column
event=event??{}
if(this.advanceOnEdit&&event.keyCode==13){let next=event.shiftKey?this.prevRow(index,column,1):this.nextRow(index,column,1)
if(next==null)next=index
setTimeout(()=>{if(this.selectType!='row'){this.selectNone(true)
this.select({recid:this.records[next].recid,column:column})}else{this.editField(this.records[next].recid,column,null,event)}},1)}
let summary=index<0
let cell=query(this.last._edit?.tr).find('[col="'+column+'"]')
let rec=this.records[index]
let col=this.columns[column]
this.last.inEditMode=false
this.last._edit=null
if(!summary){if(rec.w2ui?.changes?.[col.field]!=null){cell.addClass('w2ui-changed')}else{cell.removeClass('w2ui-changed')}
cell.replace(this.getCellHTML(index,column,summary))}
query(this.box).find('div.w2ui-edit-box').remove()
this.updateToolbar()
setTimeout(()=>{let input=query(this.box).find(`#grid_${this.name}_focus`).get(0)
if(document.activeElement!==input&&!this.last.inEditMode){input.focus()}},10)}'delete'(force){let edata=this.trigger('delete',{target:this.name,force:force})
if(force)this.message()
if(edata.isCancelled===true)return
force=edata.detail.force
let recs=this.getSelection()
if(recs.length===0)return
if(this.msgDelete!=''&&!force){this.confirm({text:w2utils.lang(this.msgDelete,{count:recs.length,records:w2utils.lang(recs.length==1?'record':'records')}),width:380,height:170,yes_text:w2utils.lang('Delete'),yes_class:'w2ui-btn-red',no_text:w2utils.lang('Cancel'),}).yes(event=>{event.detail.self.close()
this.delete(true)}).no(event=>{event.detail.self.close()})
return}
let url=(typeof this.url!='object'?this.url:this.url.remove)
if(url){this.request('delete')}else{if(typeof recs[0]!='object'){this.selectNone()
this.remove.apply(this,recs)}else{for(let r=0;r<recs.length;r++){let fld=this.columns[recs[r].column].field
let ind=this.get(recs[r].recid,true)
let rec=this.records[ind]
if(ind!=null&&fld!='recid'){this.records[ind][fld]=''
if(rec.w2ui?.changes)delete rec.w2ui.changes[fld]}}
this.update()}}
edata.finish()}
click(recid,event){let time=Date.now()
let column=null
if(this.last.cancelClick==true||(event&&event.altKey))return
if((typeof recid=='object')&&(recid!==null)){column=recid.column
recid=recid.recid}
if(event==null)event={}
if(time-parseInt(this.last.click_time)<350&&this.last.click_recid==recid&&event.type=='click'){this.dblClick(recid,event)
return}
if(this.last.bubbleEl){this.last.bubbleEl=null}
this.last.click_time=time
let last_recid=this.last.click_recid
this.last.click_recid=recid
if(column==null&&event.target){let trg=event.target
if(trg.tagName!='TD')trg=query(trg).closest('td')[0]
if(query(trg).attr('col')!=null)column=parseInt(query(trg).attr('col'))}
let edata=this.trigger('click',{target:this.name,recid,column,originalEvent:event})
if(edata.isCancelled===true)return
let sel=this.getSelection()
query(this.box).find('#grid_'+this.name+'_check_all').prop('checked',false)
let ind=this.get(recid,true)
let selectColumns=[]
this.last.sel_ind=ind
this.last.sel_col=column
this.last.sel_recid=recid
this.last.sel_type='click'
let start,end,t1,t2
if(event.shiftKey&&sel.length>0&&this.multiSelect){if(sel[0].recid){start=this.get(sel[0].recid,true)
end=this.get(recid,true)
if(column>sel[0].column){t1=sel[0].column
t2=column}else{t1=column
t2=sel[0].column}
for(let c=t1;c<=t2;c++)selectColumns.push(c)}else{start=this.get(last_recid,true)
end=this.get(recid,true)}
let sel_add=[]
if(start>end){let tmp=start;start=end;end=tmp}
let url=this.url?.get?this.url.get:this.url
for(let i=start;i<=end;i++){if(this.searchData.length>0&&!url&&!this.last.searchIds.includes(i))continue
if(this.selectType=='row'){sel_add.push(this.records[i].recid)}else{for(let sc=0;sc<selectColumns.length;sc++){sel_add.push({recid:this.records[i].recid,column:selectColumns[sc]})}}}
this.select(sel_add)}else{let last=this.last.selection
let flag=(last.indexes.indexOf(ind)!=-1?true:false)
let fselect=false
if(query(event.target).closest('td').hasClass('w2ui-col-select'))fselect=true
if(((!event.ctrlKey&&!event.shiftKey&&!event.metaKey&&!fselect)||!this.multiSelect)&&!this.showSelectColumn){if(this.selectType!='row'&&!last.columns[ind]?.includes(column)){flag=false}
if(flag===true&&sel.length==1){this.unselect({recid:recid,column:column})}else{this.selectNone(true)
this.select({recid:recid,column:column})}}else{if(this.selectType!='row')flag=false
if(flag===true){this.unselect({recid:recid,column:column})}else{this.select({recid:recid,column:column})}}}
this.status()
this.initResize()
edata.finish()}
columnClick(field,event){if(this.last.colResizing===true){return}
let edata=this.trigger('columnClick',{target:this.name,field:field,originalEvent:event})
if(edata.isCancelled===true)return
if(this.selectType=='row'){let column=this.getColumn(field)
if(column&&column.sortable)this.sort(field,null,(event&&(event.ctrlKey||event.metaKey||event.shiftKey)?true:false))
if(edata.detail.field=='line-number'){if(this.getSelection().length>=this.records.length){this.selectNone()}else{this.selectAll()}}}else{if(event.altKey){let column=this.getColumn(field)
if(column&&column.sortable)this.sort(field,null,(event&&(event.ctrlKey||event.metaKey||event.shiftKey)?true:false))}
if(edata.detail.field=='line-number'){if(this.getSelection().length>=this.records.length){this.selectNone()}else{this.selectAll()}}else{if(!event.shiftKey&&!event.metaKey&&!event.ctrlKey){this.selectNone(true)}
let tmp=this.getSelection()
let column=this.getColumn(edata.detail.field,true)
let sel=[]
let cols=[]
if(tmp.length!=0&&event.shiftKey){let start=column
let end=tmp[0].column
if(start>end){start=tmp[0].column
end=column}
for(let i=start;i<=end;i++)cols.push(i)}else{cols.push(column)}
edata=this.trigger('columnSelect',{target:this.name,columns:cols})
if(edata.isCancelled!==true){for(let i=0;i<this.records.length;i++){sel.push({recid:this.records[i].recid,column:cols})}
this.select(sel)}
edata.finish()}}
edata.finish()}
columnDblClick(field,event){let edata=this.trigger('columnDblClick',{target:this.name,field:field,originalEvent:event})
if(edata.isCancelled===true)return
edata.finish()}
columnContextMenu(field,event){let edata=this.trigger('columnContextMenu',{target:this.name,field:field,originalEvent:event})
if(edata.isCancelled===true)return
if(this.show.columnMenu){w2menu.show({type:'check',contextMenu:true,originalEvent:event,items:this.initColumnOnOff()}).then(()=>{query('#w2overlay-context-menu .w2ui-grid-skip').off('.w2ui-grid').on('click.w2ui-grid',evt=>{evt.stopPropagation()}).on('keypress',evt=>{if(evt.keyCode==13){this.skip(evt.target.value)
this.toolbar.click('w2ui-column-on-off')}})}).select((event)=>{let id=event.detail.item.id
if(['w2ui-stateSave','w2ui-stateReset'].includes(id)){this[id.substring(5)]()}else if(id=='w2ui-skip'){}else{this.columnOnOff(event,event.detail.item.id)}
clearTimeout(this.last.kbd_timer)})
clearTimeout(this.last.kbd_timer)}
event.preventDefault()
edata.finish()}
columnAutoSize(colIndex){if(arguments.length==0){this.columns.forEach((col,i)=>this.columnAutoSize(i))
return}
let col=this.columns[colIndex]
let el=query(`#grid_${this.name}_column_${colIndex} .w2ui-col-header`)[0]
if(col.autoResize===false||col.hidden===true||!el){return true}
let style=getComputedStyle(el)
let maxWidth=w2utils.getStrWidth(el.innerHTML,`font-family: ${style.fontFamily}; font-size: ${style.fontSize}`,true)
+parseFloat(style.paddingLeft)+parseFloat(style.paddingRight)+4
query(this.box).find(`.w2ui-grid-records td[col="${colIndex}"] > div`,this.box).each(el=>{let style=getComputedStyle(el)
let width=w2utils.getStrWidth(el.innerHTML,`font-family: ${style.fontFamily}; font-size: ${style.fontSize}`,true)
+parseFloat(style.paddingLeft)+parseFloat(style.paddingRight)+4
if(maxWidth<width){maxWidth=width}})
let edata=this.trigger('columnAutoResize',{maxWidth,originalEvent:event,target:this.name,column:col})
if(edata.isCancelled===true){return}
if(maxWidth>0){if(col.sizeOriginal==null)col.sizeOriginal=col.size
col.size=Math.min(Math.abs(maxWidth),col.max||Infinity)+'px'
this.resizeRecords()
this.resizeRecords()
this.scroll()}
edata.finish()}
columnAutoSizeAll(){this.columns.forEach((col,ind)=>this.columnAutoSize(ind))}
focus(event){let edata=this.trigger('focus',{target:this.name,originalEvent:event})
if(edata.isCancelled===true)return false
this.hasFocus=true
query(this.box).removeClass('w2ui-inactive').find('.w2ui-inactive').removeClass('w2ui-inactive')
setTimeout(()=>{let txt=query(this.box).find(`#grid_${this.name}_focus`).get(0)
if(txt&&document.activeElement!=txt){txt.focus()}},10)
edata.finish()}
blur(event){let edata=this.trigger('blur',{target:this.name,originalEvent:event})
if(edata.isCancelled===true)return false
this.hasFocus=false
query(this.box).addClass('w2ui-inactive').find('.w2ui-selected').addClass('w2ui-inactive')
query(this.box).find('.w2ui-selection').addClass('w2ui-inactive')
edata.finish()}
keydown(event){let obj=this
let url=(typeof this.url!='object'?this.url:this.url.get)
if(obj.keyboard!==true)return
let edata=obj.trigger('keydown',{target:obj.name,originalEvent:event})
if(edata.isCancelled===true)return
if(query(this.box).find('.w2ui-message').length>0){if(event.keyCode==27)this.message()
return}
let empty=false
let records=query(obj.box).find('#grid_'+obj.name+'_records')
let sel=obj.getSelection()
if(sel.length===0)empty=true
let recid=sel[0]||null
let columns=[]
let recid2=sel[sel.length-1]
if(typeof recid=='object'&&recid!=null){recid=sel[0].recid
columns=[]
let ii=0
while(true){if(!sel[ii]||sel[ii].recid!=recid)break
columns.push(sel[ii].column)
ii++}
recid2=sel[sel.length-1].recid}
let ind=obj.get(recid,true)
let ind2=obj.get(recid2,true)
let recEL=query(obj.box).find(`#grid_${obj.name}_rec_${(ind != null ? w2utils.escapeId(obj.records[ind].recid) : 'none')}`)
let pageSize=Math.floor(records[0].clientHeight/obj.recordHeight)
let cancel=false
let key=event.keyCode
let shiftKey=event.shiftKey
switch(key){case 8:case 46:{obj.delete()
cancel=true
event.stopPropagation()
break}
case 27:{if(obj.last.move?.type){delete obj.last.move
obj.removeRange('selection-preview')
obj.removeRange('selection-expand')
cancel=true}else{obj.selectNone()
cancel=true}
break}
case 65:{if(!event.metaKey&&!event.ctrlKey)break
obj.selectAll()
cancel=true
break}
case 13:{if(this.selectType=='row'&&obj.show.expandColumn===true){if(recEL.length<=0)break
obj.toggle(recid,event)
cancel=true}else{for(let c=0;c<this.columns.length;c++){let edit=this.getCellEditable(ind,c)
if(edit){columns.push(parseInt(c))
break}}
if(this.selectType=='row'&&this.last._edit&&this.last._edit.column){columns=[this.last._edit.column]}
if(columns.length>0){obj.editField(recid,columns[0]??this.last.editColumn,null,event)
cancel=true}}
break}
case 37:{moveLeft()
break}
case 39:{moveRight()
break}
case 33:{moveUp(pageSize)
break}
case 34:{moveDown(pageSize)
break}
case 35:{moveDown(-1)
break}
case 36:{moveUp(-1)
break}
case 38:{moveUp(event.metaKey||event.ctrlKey?-1:1)
break}
case 40:{moveDown(event.metaKey||event.ctrlKey?-1:1)
break}
case 17:case 91:{if(empty)break
if(w2utils.isSafari){obj.last.copy_event=obj.copy(false,event)
let focus=query(obj.box).find('#grid_'+obj.name+'_focus')
focus.val(obj.last.copy_event.detail.text)
focus[0].select()}
break}
case 67:{if(event.metaKey||event.ctrlKey){if(w2utils.isSafari){obj.copy(obj.last.copy_event,event)}else{obj.last.copy_event=obj.copy(false,event)
let focus=query(obj.box).find('#grid_'+obj.name+'_focus')
focus.val(obj.last.copy_event.detail.text)
focus[0].select()
obj.copy(obj.last.copy_event,event)}}
break}
case 88:{if(empty)break
if(event.ctrlKey||event.metaKey){if(w2utils.isSafari){obj.copy(obj.last.copy_event,event)}else{obj.last.copy_event=obj.copy(false,event)
let focus=query(obj.box).find('#grid_'+obj.name+'_focus')
focus.val(obj.last.copy_event.detail.text)
focus[0].select()
obj.copy(obj.last.copy_event,event)}}
break}}
let tmp=[32,187,189,192,219,220,221,186,222,188,190,191]
for(let i=48;i<=111;i++)tmp.push(i)
if(tmp.indexOf(key)!=-1&&!event.ctrlKey&&!event.metaKey&&!cancel){if(columns.length===0)columns.push(0)
cancel=false
setTimeout(()=>{let focus=query(obj.box).find('#grid_'+obj.name+'_focus')
let key=focus.val()
focus.val('')
obj.editField(recid,columns[0],key,event)},1)}
if(cancel){if(event.preventDefault)event.preventDefault()}
edata.finish()
function moveLeft(){if(empty){selectTopRecord()
return}
if(obj.selectType=='row'){if(recEL.length<=0)return
let tmp=obj.records[ind].w2ui||{}
if(tmp&&tmp.parent_recid!=null&&(!Array.isArray(tmp.children)||tmp.children.length===0||!tmp.expanded)){obj.unselect(recid)
obj.collapse(tmp.parent_recid,event)
obj.select(tmp.parent_recid)}else{obj.collapse(recid,event)}}else{let prev=obj.prevCell(ind,columns[0])
if(prev?.index!=ind){prev=null}else{prev=prev?.colIndex}
if(!shiftKey&&prev==null){obj.selectNone(true)
prev=0}
if(prev!=null){if(shiftKey&&obj.multiSelect){if(tmpUnselect())return
let tmp=[]
let newSel=[]
let unSel=[]
if(columns.indexOf(obj.last.sel_col)===0&&columns.length>1){for(let i=0;i<sel.length;i++){if(tmp.indexOf(sel[i].recid)==-1)tmp.push(sel[i].recid)
unSel.push({recid:sel[i].recid,column:columns[columns.length-1]})}
obj.unselect(unSel)
obj.scrollIntoView(ind,columns[columns.length-1],true)}else{for(let i=0;i<sel.length;i++){if(tmp.indexOf(sel[i].recid)==-1)tmp.push(sel[i].recid)
newSel.push({recid:sel[i].recid,column:prev})}
obj.select(newSel)
obj.scrollIntoView(ind,prev,true)}}else{obj.click({recid:recid,column:prev},event)
obj.scrollIntoView(ind,prev,true)}}else{if(!shiftKey){obj.selectNone(true)}}}
cancel=true}
function moveRight(){if(empty){selectTopRecord()
return}
if(obj.selectType=='row'){if(recEL.length<=0)return
obj.expand(recid,event)}else{let next=obj.nextCell(ind,columns[columns.length-1])
if(next.index!=ind){next=null}else{next=next.colIndex}
if(!shiftKey&&next==null){obj.selectNone(true)
next=obj.columns.length-1}
if(next!=null){if(shiftKey&&key==39&&obj.multiSelect){if(tmpUnselect())return
let tmp=[]
let newSel=[]
let unSel=[]
if(columns.indexOf(obj.last.sel_col)==columns.length-1&&columns.length>1){for(let i=0;i<sel.length;i++){if(tmp.indexOf(sel[i].recid)==-1)tmp.push(sel[i].recid)
unSel.push({recid:sel[i].recid,column:columns[0]})}
obj.unselect(unSel)
obj.scrollIntoView(ind,columns[0],true)}else{for(let i=0;i<sel.length;i++){if(tmp.indexOf(sel[i].recid)==-1)tmp.push(sel[i].recid)
newSel.push({recid:sel[i].recid,column:next})}
obj.select(newSel)
obj.scrollIntoView(ind,next,true)}}else{obj.click({recid:recid,column:next},event)
obj.scrollIntoView(ind,next,true)}}else{if(!shiftKey){obj.selectNone(true)}}}
cancel=true}
function moveUp(numRows){if(empty)selectTopRecord()
if(recEL.length<=0)return
let prev=obj.prevRow(ind,obj.selectType=='row'?0:sel[0].column,numRows)
if(!shiftKey&&prev==null){if(obj.searchData.length!=0&&!url){prev=obj.last.searchIds[0]}else{prev=0}}
if(prev!=null){if(shiftKey&&obj.multiSelect){if(tmpUnselect())return
if(obj.selectType=='row'){if(obj.last.sel_ind>prev&&obj.last.sel_ind!=ind2){obj.unselect(obj.records[ind2].recid)}else{obj.select(obj.records[prev].recid)}}else{if(obj.last.sel_ind>prev&&obj.last.sel_ind!=ind2){prev=ind2
let tmp=[]
for(let c=0;c<columns.length;c++)tmp.push({recid:obj.records[prev].recid,column:columns[c]})
obj.unselect(tmp)}else{let tmp=[]
for(let c=0;c<columns.length;c++)tmp.push({recid:obj.records[prev].recid,column:columns[c]})
obj.select(tmp)}}}else{obj.selectNone(true)
obj.click({recid:obj.records[prev].recid,column:columns[0]},event)}
obj.scrollIntoView(prev,null,true,numRows!=1)
if(event.preventDefault)event.preventDefault()}else{if(!shiftKey){obj.selectNone(true)}}}
function moveDown(numRows){if(empty)selectTopRecord()
if(recEL.length<=0)return
let next=obj.nextRow(ind2,obj.selectType=='row'?0:sel[0].column,numRows)
if(!shiftKey&&next==null){if(obj.searchData.length!=0&&!url){next=obj.last.searchIds[obj.last.searchIds.length-1]}else{next=obj.records.length-1}}
if(next!=null){if(shiftKey&&obj.multiSelect){if(tmpUnselect())return
if(obj.selectType=='row'){if(obj.last.sel_ind<next&&obj.last.sel_ind!=ind){obj.unselect(obj.records[ind].recid)}else{obj.select(obj.records[next].recid)}}else{if(obj.last.sel_ind<next&&obj.last.sel_ind!=ind){next=ind
let tmp=[]
for(let c=0;c<columns.length;c++)tmp.push({recid:obj.records[next].recid,column:columns[c]})
obj.unselect(tmp)}else{let tmp=[]
for(let c=0;c<columns.length;c++)tmp.push({recid:obj.records[next].recid,column:columns[c]})
obj.select(tmp)}}}else{obj.selectNone(true)
obj.click({recid:obj.records[next].recid,column:columns[0]},event)}
obj.scrollIntoView(next,null,true,numRows!=1)
cancel=true}else{if(!shiftKey){obj.selectNone(true)}}}
function selectTopRecord(){if(!obj.records||obj.records.length===0)return
let ind=Math.floor(records[0].scrollTop/obj.recordHeight)+1
if(!obj.records[ind]||ind<2)ind=0
if(typeof obj.records[ind]==='undefined')return
obj.select({recid:obj.records[ind].recid,column:0})}
function tmpUnselect(){if(obj.last.sel_type!='click')return false
if(obj.selectType!='row'){obj.last.sel_type='key'
if(sel.length>1){for(let s=0;s<sel.length;s++){if(sel[s].recid==obj.last.sel_recid&&sel[s].column==obj.last.sel_col){sel.splice(s,1)
break}}
obj.unselect(sel)
return true}
return false}else{obj.last.sel_type='key'
if(sel.length>1){sel.splice(sel.indexOf(obj.records[obj.last.sel_ind].recid),1)
obj.unselect(sel)
return true}
return false}}}
scrollIntoView(ind,column,instant,recTop){let buffered=this.records.length
if(this.searchData.length!=0&&!this.url)buffered=this.last.searchIds.length
if(buffered===0)return
if(ind==null){let sel=this.getSelection()
if(sel.length===0)return
if(w2utils.isPlainObject(sel[0])){ind=sel[0].index
column=sel[0].column}else{ind=this.get(sel[0],true)}}
let records=query(this.box).find(`#grid_${this.name}_records`)
let recWidth=records[0].clientWidth
let recHeight=records[0].clientHeight
let recSTop=records[0].scrollTop
let recSLeft=records[0].scrollLeft
let len=this.last.searchIds.length
if(len>0)ind=this.last.searchIds.indexOf(ind)
records.css({'scroll-behavior':instant?'auto':'smooth'})
if(recHeight<this.recordHeight*(len>0?len:buffered)&&records.length>0){let t1=Math.floor(recSTop/this.recordHeight)
let t2=t1+Math.floor(recHeight/this.recordHeight)
if(ind==t1){records.prop('scrollTop',recSTop-recHeight/1.3)}
if(ind==t2){records.prop('scrollTop',recSTop+recHeight/1.3)}
if(ind<t1||ind>t2){records.prop('scrollTop',(ind-1)*this.recordHeight)}
if(recTop===true){records.prop('scrollTop',ind*this.recordHeight)}}
if(column!=null){let x1=0
let x2=0
let sb=w2utils.scrollBarSize()
for(let i=0;i<=column;i++){let col=this.columns[i]
if(col.frozen||col.hidden)continue
x1=x2
x2+=parseInt(col.sizeCalculated)}
if(recWidth<x2-recSLeft){records.prop('scrollLeft',x1-sb)}else if(x1<recSLeft){records.prop('scrollLeft',x2-recWidth+sb*2)}}}
scrollToColumn(field){if(field==null)
return
let sWidth=0
let found=false
for(let i=0;i<this.columns.length;i++){let col=this.columns[i]
if(col.field==field){found=true
break}
if(col.frozen||col.hidden)
continue
let cSize=parseInt(col.sizeCalculated?col.sizeCalculated:col.size)
sWidth+=cSize}
if(!found)
return
this.last.vscroll.scrollLeft=sWidth+1
this.scroll()}
dblClick(recid,event){let column=null
if((typeof recid=='object')&&(recid!==null)){column=recid.column
recid=recid.recid}
if(event==null)event={}
if(column==null&&event.target){let tmp=event.target
if(tmp.tagName.toUpperCase()!='TD')tmp=query(tmp).closest('td')[0]
column=parseInt(query(tmp).attr('col'))}
let index=this.get(recid,true)
let rec=this.records[index]
let edata=this.trigger('dblClick',{target:this.name,recid:recid,column:column,originalEvent:event})
if(edata.isCancelled===true)return
this.selectNone(true)
let edit=this.getCellEditable(index,column)
if(edit){this.editField(recid,column,null,event)}else{this.select({recid:recid,column:column})
if(this.show.expandColumn||(rec&&rec.w2ui&&Array.isArray(rec.w2ui.children)))this.toggle(recid)}
edata.finish()}
showContextMenu(recid,column,event){if(this.last.userSelect=='text')return
if(event==null){event={offsetX:0,offsetY:0,target:query(this.box).find(`#grid_${this.name}_rec_${recid}`)[0]}}
if(event.offsetX==null){event.offsetX=event.layerX-event.target.offsetLeft
event.offsetY=event.layerY-event.target.offsetTop}
let sel=this.getSelection()
if(this.selectType=='row'){if(sel.indexOf(recid)==-1){this.click(recid)}}else{let selected=false
for(let i=0;i<sel.length;i++){if(sel[i].recid==recid||sel[i].column==column)selected=true}
if(!selected&&recid!=null)this.click({recid:recid,column:column})
if(!selected&&column!=null)this.columnClick(this.columns[column].field,event)}
let edata=this.trigger('contextMenu',{target:this.name,originalEvent:event,recid,column})
if(edata.isCancelled===true)return
if(this.contextMenu?.length>0){w2menu.show({contextMenu:true,originalEvent:event,items:this.contextMenu}).select((event)=>{clearTimeout(this.last.kbd_timer)
this.contextMenuClick(recid,column,event)})}
event.preventDefault()
clearTimeout(this.last.kbd_timer)
edata.finish()}
contextMenuClick(recid,column,event){let edata=this.trigger('contextMenuClick',{target:this.name,recid,column,originalEvent:event.detail.originalEvent,menuEvent:event,menuIndex:event.detail.index,menuItem:event.detail.item})
if(edata.isCancelled===true)return
edata.finish()}
toggle(recid){let rec=this.get(recid)
if(rec==null)return
rec.w2ui=rec.w2ui??{}
if(rec.w2ui.expanded===true)return this.collapse(recid);else return this.expand(recid)}
expand(recid,noRefresh){let ind=this.get(recid,true)
let rec=this.records[ind]
rec.w2ui=rec.w2ui??{}
let id=w2utils.escapeId(recid)
let children=rec.w2ui.children
let edata
if(Array.isArray(children)){if(rec.w2ui.expanded===true||children.length===0)return false
edata=this.trigger('expand',{target:this.name,recid:recid})
if(edata.isCancelled===true)return false
rec.w2ui.expanded=true
children.forEach((child)=>{child.w2ui=child.w2ui??{}
child.w2ui.parent_recid=rec.recid
if(child.w2ui.children==null)child.w2ui.children=[]})
this.records.splice.apply(this.records,[ind+1,0].concat(children))
if(this.total!==-1){this.total+=children.length}
let url=(typeof this.url!='object'?this.url:this.url.get)
if(!url){this.localSort(true,true)
if(this.searchData.length>0){this.localSearch(true)}}
if(noRefresh!==true)this.refresh()
edata.finish()}else{if(query(this.box).find('#grid_'+this.name+'_rec_'+id+'_expanded_row').length>0||this.show.expandColumn!==true)return false
if(rec.w2ui.expanded=='none')return false
query(this.box).find('#grid_'+this.name+'_rec_'+id).after(`<tr id="grid_${this.name}_rec_${recid}_expanded_row" class="w2ui-expanded-row">
                    <td colspan="100" class="w2ui-expanded2">
                        <div id="grid_${this.name}_rec_${recid}_expanded"></div>
                    </td>
                    <td class="w2ui-grid-data-last"></td>
                </tr>`)
query(this.box).find('#grid_'+this.name+'_frec_'+id).after(`<tr id="grid_${this.name}_frec_${recid}_expanded_row" class="w2ui-expanded-row">
                    ${this.show.lineNumbers ? '<td class="w2ui-col-number"></td>' : ''}
                    <td class="w2ui-grid-data w2ui-expanded1" colspan="100">
                       <div id="grid_${this.name}_frec_${recid}_expanded"></div>
                    </td>
                </tr>`)
edata=this.trigger('expand',{target:this.name,recid:recid,box_id:'grid_'+this.name+'_rec_'+recid+'_expanded',fbox_id:'grid_'+this.name+'_frec_'+recid+'_expanded'})
if(edata.isCancelled===true){query(this.box).find('#grid_'+this.name+'_rec_'+id+'_expanded_row').remove()
query(this.box).find('#grid_'+this.name+'_frec_'+id+'_expanded_row').remove()
return false}
let row1=query(this.box).find('#grid_'+this.name+'_rec_'+recid+'_expanded')
let row2=query(this.box).find('#grid_'+this.name+'_frec_'+recid+'_expanded')
let innerHeight=row1.find(':scope div:first-child')[0]?.clientHeight??50
if(row1[0].clientHeight<innerHeight){row1.css({height:innerHeight+'px'})}
if(row2[0].clientHeight<innerHeight){row2.css({height:innerHeight+'px'})}
query(this.box).find('#grid_'+this.name+'_rec_'+id).attr('expanded','yes').addClass('w2ui-expanded')
query(this.box).find('#grid_'+this.name+'_frec_'+id).attr('expanded','yes').addClass('w2ui-expanded')
query(this.box).find('#grid_'+this.name+'_cell_'+this.get(recid,true)+'_expand div').html('-')
rec.w2ui.expanded=true
edata.finish()
this.resizeRecords()}
return true}
collapse(recid,noRefresh){let ind=this.get(recid,true)
let rec=this.records[ind]
rec.w2ui=rec.w2ui||{}
let id=w2utils.escapeId(recid)
let children=rec.w2ui.children
let edata
if(Array.isArray(children)){if(rec.w2ui.expanded!==true)return false
edata=this.trigger('collapse',{target:this.name,recid:recid})
if(edata.isCancelled===true)return false
clearExpanded(rec)
let stops=[]
for(let r=rec;r!=null;r=this.get(r.w2ui.parent_recid))
stops.push(r.w2ui.parent_recid)
let start=ind+1
let end=start
while(true){if(this.records.length<=end+1||this.records[end+1].w2ui==null||stops.indexOf(this.records[end+1].w2ui.parent_recid)>=0){break}
end++}
this.records.splice(start,end-start+1)
if(this.total!==-1){this.total-=end-start+1}
let url=(typeof this.url!='object'?this.url:this.url.get)
if(!url){if(this.searchData.length>0){this.localSearch(true)}}
if(noRefresh!==true)this.refresh()
edata.finish()}else{if(query(this.box).find('#grid_'+this.name+'_rec_'+id+'_expanded_row').length===0||this.show.expandColumn!==true)return false
edata=this.trigger('collapse',{target:this.name,recid:recid,box_id:'grid_'+this.name+'_rec_'+recid+'_expanded',fbox_id:'grid_'+this.name+'_frec_'+recid+'_expanded'})
if(edata.isCancelled===true)return false
query(this.box).find('#grid_'+this.name+'_rec_'+id).removeAttr('expanded').removeClass('w2ui-expanded')
query(this.box).find('#grid_'+this.name+'_frec_'+id).removeAttr('expanded').removeClass('w2ui-expanded')
query(this.box).find('#grid_'+this.name+'_cell_'+this.get(recid,true)+'_expand div').html('+')
query(this.box).find('#grid_'+this.name+'_rec_'+id+'_expanded').css('height','0px')
query(this.box).find('#grid_'+this.name+'_frec_'+id+'_expanded').css('height','0px')
setTimeout(()=>{query(this.box).find('#grid_'+this.name+'_rec_'+id+'_expanded_row').remove()
query(this.box).find('#grid_'+this.name+'_frec_'+id+'_expanded_row').remove()
rec.w2ui.expanded=false
edata.finish()
this.resizeRecords()},300)}
return true
function clearExpanded(rec){rec.w2ui.expanded=false
for(let i=0;i<rec.w2ui.children.length;i++){let subRec=rec.w2ui.children[i]
if(subRec.w2ui.expanded){clearExpanded(subRec)}}}}
sort(field,direction,multiField){let edata=this.trigger('sort',{target:this.name,field,direction,multiField})
if(edata.isCancelled===true)return
if(field!=null){let sortIndex=this.sortData.length
for(let s=0;s<this.sortData.length;s++){if(this.sortData[s].field==field){sortIndex=s
break}}
if(direction==null){direction=this.sortData[sortIndex]?.direction
if(direction==null){if(this.last.originalSort==null){this.last.originalSort=this.records.map(rec=>rec.recid)}
direction='asc'}else{switch(direction.toLowerCase()){case'asc':{direction='desc'
break}
case'desc':{direction=''
break}
default:{direction='asc'
break}}}}
if(multiField!=true){this.sortData=[]
sortIndex=0}
if(direction===''){this.sortData.splice(sortIndex,1)}else{this.sortData[sortIndex]??={}
Object.assign(this.sortData[sortIndex],{field,direction})}}else{this.sortData=[]}
let url=(typeof this.url!='object'?this.url:this.url.get)
if(!url){this.localSort(false,true)
if(this.searchData.length>0)this.localSearch(true)
this.last.vscroll.scrollTop=0
query(this.box).find(`#grid_${this.name}_records`).prop('scrollTop',0)
edata.finish({direction})
this.refresh()}else{edata.finish({direction})
this.last.fetch.offset=0
this.reload()}}
copy(flag,oEvent){if(w2utils.isPlainObject(flag)){flag.finish()
return flag.text}
let sel=this.getSelection()
if(sel.length===0)return''
let text=''
if(typeof sel[0]=='object'){let minCol=sel[0].column
let maxCol=sel[0].column
let recs=[]
for(let s=0;s<sel.length;s++){if(sel[s].column<minCol)minCol=sel[s].column
if(sel[s].column>maxCol)maxCol=sel[s].column
if(recs.indexOf(sel[s].index)==-1)recs.push(sel[s].index)}
recs.sort((a,b)=>{return a-b})
for(let r=0;r<recs.length;r++){let ind=recs[r]
for(let c=minCol;c<=maxCol;c++){let col=this.columns[c]
if(col.hidden===true)continue
text+=this.getCellCopy(ind,c)+'\t'}
text=text.substr(0,text.length-1)
text+='\n'}}else{for(let c=0;c<this.columns.length;c++){let col=this.columns[c]
if(col.hidden===true)continue
let colName=(col.text?col.text:col.field)
if(col.text&&col.text.length<3&&col.tooltip)colName=col.tooltip
text+='"'+w2utils.stripTags(colName)+'"\t'}
text=text.substr(0,text.length-1)
text+='\n'
for(let s=0;s<sel.length;s++){let ind=this.get(sel[s],true)
for(let c=0;c<this.columns.length;c++){let col=this.columns[c]
if(col.hidden===true)continue
text+='"'+this.getCellCopy(ind,c)+'"\t'}
text=text.substr(0,text.length-1)
text+='\n'}}
text=text.substr(0,text.length-1)
let edata
if(flag==null){edata=this.trigger('copy',{target:this.name,text:text,cut:(oEvent.keyCode==88?true:false),originalEvent:oEvent})
if(edata.isCancelled===true)return''
text=edata.detail.text
edata.finish()
return text}else if(flag===false){edata=this.trigger('copy',{target:this.name,text:text,cut:(oEvent.keyCode==88?true:false),originalEvent:oEvent})
if(edata.isCancelled===true)return''
text=edata.detail.text
return edata}}
getCellCopy(ind,col_ind){return w2utils.stripTags(this.getCellHTML(ind,col_ind))}
paste(text,event){let sel=this.getSelection()
let ind=this.get(sel[0].recid,true)
let col=sel[0].column
let edata=this.trigger('paste',{target:this.name,text:text,index:ind,column:col,originalEvent:event})
if(edata.isCancelled===true)return
text=edata.detail.text
if(this.selectType=='row'||sel.length===0){console.log('ERROR: You can paste only if grid.selectType = \'cell\' and when at least one cell selected.')
edata.finish()
return}
if(typeof text!=='object'){let newSel=[]
text=text.split('\n')
for(let t=0;t<text.length;t++){let tmp=text[t].split('\t')
let cnt=0
let rec=this.records[ind]
let cols=[]
if(rec==null)continue
for(let dt=0;dt<tmp.length;dt++){if(!this.columns[col+cnt])continue
setCellPaste(rec,this.columns[col+cnt].field,tmp[dt])
cols.push(col+cnt)
cnt++}
for(let c=0;c<cols.length;c++)newSel.push({recid:rec.recid,column:cols[c]})
ind++}
this.selectNone(true)
this.select(newSel)}else{this.selectNone(true)
this.select([{recid:this.records[ind],column:col}])}
this.refresh()
edata.finish()
function setCellPaste(rec,field,paste){rec.w2ui=rec.w2ui??{}
rec.w2ui.changes=rec.w2ui.changes||{}
rec.w2ui.changes[field]=paste}}
resize(){let time=Date.now()
if(!this.box||query(this.box).attr('name')!=this.name)return
let edata=this.trigger('resize',{target:this.name})
if(edata.isCancelled===true)return
if(this.box!=null){this.resizeBoxes()
this.resizeRecords()}
edata.finish()
return Date.now()-time}
update({cells,fullCellRefresh,ignoreColumns}={}){let time=Date.now()
let self=this
if(this.box==null)return 0
if(Array.isArray(cells)){for(let i=0;i<cells.length;i++){let index=cells[i].index
let column=cells[i].column
if(index<0)continue
if(index==null||column==null){console.log('ERROR: Wrong argument for grid.update({ cells }), cells should be [{ index: X, column: Y }, ...]')
continue}
let rec=this.records[index]??{}
rec.w2ui=rec.w2ui??{}
rec.w2ui._update=rec.w2ui._update??{cells:[]}
let row1=rec.w2ui._update.row1
let row2=rec.w2ui._update.row2
if(row1==null||!row1.isConnected||row2==null||!row2.isColSelected){row1=this.box.querySelector(`#grid_${this.name}_rec_${w2utils.escapeId(rec.recid)}`)
row2=this.box.querySelector(`#grid_${this.name}_frec_${w2utils.escapeId(rec.recid)}`)
rec.w2ui._update.row1=row1
rec.w2ui._update.row2=row2}
_update(rec,row1,row2,index,column)}}else{for(let i=this.last.vscroll.recIndStart-1;i<=this.last.vscroll.recIndEnd;i++){let index=i
if(this.last.searchIds.length>0){index=this.last.searchIds[i]}else{index=i}
let rec=this.records[index]
if(index<0||rec==null)continue
rec.w2ui=rec.w2ui??{}
rec.w2ui._update=rec.w2ui._update??{cells:[]}
let row1=rec.w2ui._update.row1
let row2=rec.w2ui._update.row2
if(row1==null||!row1.isConnected||row2==null||!row2.isColSelected){row1=this.box.querySelector(`#grid_${this.name}_rec_${w2utils.escapeId(rec.recid)}`)
row2=this.box.querySelector(`#grid_${this.name}_frec_${w2utils.escapeId(rec.recid)}`)
rec.w2ui._update.row1=row1
rec.w2ui._update.row2=row2}
for(let column=0;column<this.columns.length;column++){_update(rec,row1,row2,index,column)}}}
return Date.now()-time
function _update(rec,row1,row2,index,column){let pcol=self.columns[column]
if(Array.isArray(ignoreColumns)&&(ignoreColumns.includes(column)||ignoreColumns.includes(pcol.field))){return}
let cell=rec.w2ui._update.cells[column]
if(cell==null||!cell.isConnected){cell=self.box.querySelector(`#grid_${self.name}_data_${index}_${column}`)
rec.w2ui._update.cells[column]=cell}
if(cell==null)return
if(fullCellRefresh){query(cell).replace(self.getCellHTML(index,column,false))
cell=self.box.querySelector(`#grid_${self.name}_data_${index}_${column}`)
rec.w2ui._update.cells[column]=cell}else{let div=cell.children[0]
let{value,style,className}=self.getCellValue(index,column,false,true)
if(div.innerHTML!=value){div.innerHTML=value}
if(style!=''&&cell.style.cssText!=style){cell.style.cssText=style}
if(className!=''){let ignore=['w2ui-grid-data']
let remove=[]
let add=className.split(' ').filter(cl=>!!cl)
cell.classList.forEach(cl=>{if(!ignore.includes(cl))remove.push(cl)})
cell.classList.remove(...remove)
cell.classList.add(...add)}}
if(self.columns[column].style&&self.columns[column].style!=cell.style.cssText){cell.style.cssText=self.columns[column].style??''}
if(rec.w2ui.class!=null){if(typeof rec.w2ui.class=='string'){let ignore=['w2ui-odd','w2ui-even','w2ui-record']
let remove=[]
let add=rec.w2ui.class.split(' ').filter(cl=>!!cl)
if(row1&&row2){row1.classList.forEach(cl=>{if(!ignore.includes(cl))remove.push(cl)})
row1.classList.remove(...remove)
row1.classList.add(...add)
row2.classList.remove(...remove)
row2.classList.add(...add)}}
if(w2utils.isPlainObject(rec.w2ui.class)&&typeof rec.w2ui.class[pcol.field]=='string'){let ignore=['w2ui-grid-data']
let remove=[]
let add=rec.w2ui.class[pcol.field].split(' ').filter(cl=>!!cl)
cell.classList.forEach(cl=>{if(!ignore.includes(cl))remove.push(cl)})
cell.classList.remove(...remove)
cell.classList.add(...add)}}
if(rec.w2ui.style!=null){if(row1&&row2&&typeof rec.w2ui.style=='string'&&row1.style.cssText!==rec.w2ui.style){row1.style.cssText='height: '+self.recordHeight+'px;'+rec.w2ui.style
row1.setAttribute('custom_style',rec.w2ui.style)
row2.style.cssText='height: '+self.recordHeight+'px;'+rec.w2ui.style
row2.setAttribute('custom_style',rec.w2ui.style)}
if(w2utils.isPlainObject(rec.w2ui.style)&&typeof rec.w2ui.style[pcol.field]=='string'&&cell.style.cssText!==rec.w2ui.style[pcol.field]){cell.style.cssText=rec.w2ui.style[pcol.field]}}}}
refreshCell(recid,field){let index=this.get(recid,true)
let col_ind=this.getColumn(field,true)
let isSummary=(this.records[index]&&this.records[index].recid==recid?false:true)
let cell=query(this.box).find(`${isSummary ? '.w2ui-grid-summary ' : ''}#grid_${this.name}_data_${index}_${col_ind}`)
if(cell.length==0)return false
cell.replace(this.getCellHTML(index,col_ind,isSummary))
return true}
refreshRow(recid,ind=null){let tr1=query(this.box).find('#grid_'+this.name+'_frec_'+w2utils.escapeId(recid))
let tr2=query(this.box).find('#grid_'+this.name+'_rec_'+w2utils.escapeId(recid))
if(tr1.length>0){if(ind==null)ind=this.get(recid,true)
let line=tr1.attr('line')
let isSummary=(this.records[ind]&&this.records[ind].recid==recid?false:true)
let url=(typeof this.url!='object'?this.url:this.url.get)
if(this.searchData.length>0&&!url)for(let s=0;s<this.last.searchIds.length;s++)if(this.last.searchIds[s]==ind)ind=s
let rec_html=this.getRecordHTML(ind,line,isSummary)
tr1.replace(rec_html[0])
tr2.replace(rec_html[1])
let st=(this.records[ind].w2ui?this.records[ind].w2ui.style:'')
if(typeof st=='string'){tr1=query(this.box).find('#grid_'+this.name+'_frec_'+w2utils.escapeId(recid))
tr2=query(this.box).find('#grid_'+this.name+'_rec_'+w2utils.escapeId(recid))
tr1.attr('custom_style',st)
tr2.attr('custom_style',st)
if(tr1.hasClass('w2ui-selected')){st=st.replace('background-color','none')}
tr1[0].style.cssText='height: '+this.recordHeight+'px;'+st
tr2[0].style.cssText='height: '+this.recordHeight+'px;'+st}
if(isSummary){this.resize()}
return true}
return false}
refresh(){let time=Date.now()
let url=(typeof this.url!='object'?this.url:this.url.get)
if(this.total<=0&&!url&&this.searchData.length===0){this.total=this.records.length}
if(!this.box)return
let edata=this.trigger('refresh',{target:this.name})
if(edata.isCancelled===true)return
if(this.show.header){query(this.box).find(`#grid_${this.name}_header`).html(w2utils.lang(this.header)+'&#160;').show()}else{query(this.box).find(`#grid_${this.name}_header`).hide()}
if(this.show.toolbar){query(this.box).find('#grid_'+this.name+'_toolbar').show()}else{query(this.box).find('#grid_'+this.name+'_toolbar').hide()}
this.searchClose()
let sInput=query(this.box).find('#grid_'+this.name+'_search_all')
if(!this.multiSearch&&this.last.field=='all'&&this.searches.length>0){this.last.field=this.searches[0].field
this.last.label=this.searches[0].label}
for(let s=0;s<this.searches.length;s++){if(this.searches[s].field==this.last.field)this.last.label=this.searches[s].label}
if(this.last.multi){sInput.attr('placeholder','['+w2utils.lang('Multiple Fields')+']')}else{sInput.attr('placeholder',w2utils.lang('Search')+' '+w2utils.lang(this.last.label,true))}
if(sInput.val()!=this.last.search){let val=this.last.search
let tmp=sInput._w2field
if(tmp)val=tmp.format(val)
sInput.val(val)}
this.refreshSearch()
this.refreshBody()
if(this.show.footer){query(this.box).find(`#grid_${this.name}_footer`).html(this.getFooterHTML()).show()}else{query(this.box).find(`#grid_${this.name}_footer`).hide()}
let sel=this.last.selection,areAllSelected=(this.records.length>0&&sel.indexes.length==this.records.length),areAllSearchedSelected=(sel.indexes.length>0&&this.searchData.length!==0&&sel.indexes.length==this.last.searchIds.length)
if(areAllSelected||areAllSearchedSelected){query(this.box).find('#grid_'+this.name+'_check_all').prop('checked',true)}else{query(this.box).find('#grid_'+this.name+'_check_all').prop('checked',false)}
this.status()
let rows=this.find({'w2ui.expanded':true},true,true)
for(let r=0;r<rows.length;r++){let tmp=this.records[rows[r]].w2ui
if(tmp&&!Array.isArray(tmp.children)){tmp.expanded=false}}
if(this.markSearch){setTimeout(()=>{let search=[]
for(let s=0;s<this.searchData.length;s++){let sdata=this.searchData[s]
let fld=this.getSearch(sdata.field)
if(!fld||fld.hidden)continue
let ind=this.getColumn(sdata.field,true)
search.push({field:sdata.field,search:sdata.value,col:ind})}
if(search.length>0){search.forEach((item)=>{let el=query(this.box).find('td[col="'+item.col+'"]:not(.w2ui-head)')
w2utils.marker(el,item.search)})}},50)}
this.updateToolbar(this.last.selection)
edata.finish()
this.resize()
this.addRange('selection')
setTimeout(()=>{this.resize()
this.scroll()},1)
if(this.reorderColumns&&!this.last.columnDrag){this.last.columnDrag=this.initColumnDrag()}else if(!this.reorderColumns&&this.last.columnDrag){this.last.columnDrag.remove()}
return Date.now()-time}
refreshSearch(){if(this.multiSearch&&this.searchData.length>0){if(query(this.box).find('.w2ui-grid-searches').length==0){query(this.box).find('.w2ui-grid-toolbar').css('height',(this.last.toolbar_height+35)+'px').append(`<div id="grid_${this.name}_searches" class="w2ui-grid-searches"></div>`)}
let searches=`
                <span id="grid_${this.name}_search_logic" class="w2ui-grid-search-logic"></span>
                <div class="grid-search-line"></div>`
this.searchData.forEach((sd,sd_ind)=>{let ind=this.getSearch(sd.field,true)
let sf=this.searches[ind]
let display
if(sf?.type=='enum'&&Array.isArray(sd.value)){display=`<span class="grid-search-count">${sd.value.length}</span>`}else if(sf?.type=='list'){display=!!sd.text&&sd.text!==sd.value?`: ${sd.text}`:`: ${sd.value}`}else{display=`: ${sd.value}`}
if(sf&&sf.type=='date'){if(sd.operator=='between'){let dsp1=sd.value[0]
let dsp2=sd.value[1]
if(Number(dsp1)===dsp1){dsp1=w2utils.formatDate(dsp1)}
if(Number(dsp2)===dsp2){dsp2=w2utils.formatDate(dsp2)}
display=`: ${dsp1} - ${dsp2}`}else{let dsp=sd.value
if(Number(dsp)==dsp){dsp=w2utils.formatDate(dsp)}
let oper=sd.operator
if(oper=='more')oper='since'
if(oper=='less')oper='before'
if(oper.substr(0,5)=='more:'){oper='since'}
display=`: ${oper} ${dsp}`}}
searches+=`<span class="w2ui-action" data-click="searchFieldTooltip|${ind}|${sd_ind}|this">
                    ${sf ? (sf.label ?? sf.field) : sd.field}
                    ${display}
                    <span class="icon-chevron-down"></span>
                </span>`})
searches+=`
                ${this.show.searchSave
                    ? `<div class="grid-search-line"></div><button class="w2ui-btn grid-search-btn"data-click="searchSave">${w2utils.lang('Save')}</button>`
                    : ''
                }
                <button class="w2ui-btn grid-search-btn btn-remove"
                    data-click="searchReset">X</button>
            `
query(this.box).find(`#grid_${this.name}_searches`).html(searches)
query(this.box).find(`#grid_${this.name}_search_logic`).html(w2utils.lang(this.last.logic=='AND'?'All':'Any'))}else{query(this.box).find('.w2ui-grid-toolbar').css('height',this.last.toolbar_height+'px').find('.w2ui-grid-searches').remove()}
if(this.searchSelected){query(this.box).find(`#grid_${this.name}_search_all`).val(' ').prop('readOnly',true)
query(this.box).find(`#grid_${this.name}_search_name`).show().find('.name-text').html(this.searchSelected.text)}else{query(this.box).find(`#grid_${this.name}_search_all`).prop('readOnly',false)
query(this.box).find(`#grid_${this.name}_search_name`).hide().find('.name-text').html('')}
w2utils.bindEvents(query(this.box).find(`#grid_${this.name}_searches .w2ui-action, #grid_${this.name}_searches button`),this)}
refreshBody(){this.scroll()
let recHTML=this.getRecordsHTML()
let colHTML=this.getColumnsHTML()
let bodyHTML='<div id="grid_'+this.name+'_frecords" class="w2ui-grid-frecords" style="margin-bottom: '+(w2utils.scrollBarSize()-1)+'px;">'+
recHTML[0]+'</div>'+'<div id="grid_'+this.name+'_records" class="w2ui-grid-records">'+
recHTML[1]+'</div>'+'<div id="grid_'+this.name+'_scroll1" class="w2ui-grid-scroll1" style="height: '+w2utils.scrollBarSize()+'px"></div>'+'<div id="grid_'+this.name+'_fcolumns" class="w2ui-grid-fcolumns">'+'    <table><tbody>'+colHTML[0]+'</tbody></table>'+'</div>'+'<div id="grid_'+this.name+'_columns" class="w2ui-grid-columns">'+'    <table><tbody>'+colHTML[1]+'</tbody></table>'+'</div>'+`<div class="w2ui-intersection-marker" style="display: none; height: ${this.recordHeight - 5}px">
               <div class="top-marker"></div>
               <div class="bottom-marker"></div>
            </div>`
let gridBody=query(this.box).find(`#grid_${this.name}_body`,this.box).html(bodyHTML)
let records=query(this.box).find(`#grid_${this.name}_records`,this.box)
let frecords=query(this.box).find(`#grid_${this.name}_frecords`,this.box)
if(this.selectType=='row'){records.on('mouseover mouseout',{delegate:'tr'},(event)=>{let ind=query(event.delegate).attr('index')
let recid=this.records[ind]?.recid
query(this.box).find(`#grid_${this.name}_frec_${w2utils.escapeId(recid)}`).toggleClass('w2ui-record-hover',event.type=='mouseover')})
frecords.on('mouseover mouseout',{delegate:'tr'},(event)=>{let ind=query(event.delegate).attr('index')
let recid=this.records[ind]?.recid
query(this.box).find(`#grid_${this.name}_rec_${w2utils.escapeId(recid)}`).toggleClass('w2ui-record-hover',event.type=='mouseover')})}
if(w2utils.isMobile){records.append(frecords).on('click',{delegate:'tr'},(event)=>{let index=query(event.delegate).attr('index')
let recid=this.records[index]?.recid
this.dblClick(recid,event)})}else{records.add(frecords).on('click',{delegate:'tr'},(event)=>{let index=query(event.delegate).attr('index')
let recid=this.records[index]?.recid
if(recid!='-none-'){this.click(recid,event)}}).on('contextmenu',{delegate:'tr'},(event)=>{let index=query(event.delegate).attr('index')
let recid=this.records[index]?.recid
let td=query(event.target).closest('td')
let column=td.attr('col')?parseInt(td.attr('col')):null
this.showContextMenu(recid,column,event)}).on('mouseover',{delegate:'tr'},(event)=>{this.last.rec_out=false
let index=query(event.delegate).attr('index')
let recid=this.records[index]?.recid
if(index!==this.last.rec_over){this.last.rec_over=index
setTimeout(()=>{delete this.last.rec_out
let edata=this.trigger('mouseEnter',{target:this.name,originalEvent:event,index,recid})
edata.finish()})}}).on('mouseout',{delegate:'tr'},(event)=>{let index=query(event.delegate).attr('index')
let recid=this.records[index]?.recid
this.last.rec_out=true
setTimeout(()=>{let recLeave=()=>{let edata=this.trigger('mouseLeave',{target:this.name,originalEvent:event,index,recid})
edata.finish()}
if(index!==this.last.rec_over){recLeave()}
setTimeout(()=>{if(this.last.rec_out){delete this.last.rec_out
delete this.last.rec_over
recLeave()}})})})}
gridBody.data('scroll',{lastDelta:0,lastTime:0}).find('.w2ui-grid-frecords').on('mousewheel DOMMouseScroll ',(event)=>{event.preventDefault()
let scroll=gridBody.data('scroll')
let container=gridBody.find('.w2ui-grid-records')
let amount=typeof event.wheelDelta!=null?-event.wheelDelta:(event.detail||event.deltaY)
let newScrollTop=container.prop('scrollTop')
scroll.lastDelta+=amount
amount=Math.round(scroll.lastDelta)
gridBody.data('scroll',scroll)
container.get(0).scroll({top:newScrollTop+amount,behavior:'smooth'})})
records.off('.body-global').on('scroll.body-global',{delegate:'.w2ui-grid-records'},event=>{this.scroll(event)})
query(this.box).find('.w2ui-grid-body').off('.body-global').on('click.body-global dblclick.body-global contextmenu.body-global',{delegate:'td.w2ui-head'},event=>{let col_ind=query(event.delegate).attr('col')
let col=this.columns[col_ind]??{field:col_ind}
switch(event.type){case'click':this.columnClick(col.field,event)
break
case'dblclick':this.columnDblClick(col.field,event)
break
case'contextmenu':this.columnContextMenu(col.field,event)
break}}).on('mouseover.body-global',{delegate:'.w2ui-col-header'},event=>{let col=query(event.delegate).parent().attr('col')
this.columnTooltipShow(col,event)
query(event.delegate).off('.tooltip').on('mouseleave.tooltip',()=>{this.columnTooltipHide(col,event)})}).on('click.body-global',{delegate:'input.w2ui-select-all'},event=>{if(event.delegate.checked){this.selectAll()}else{this.selectNone()}
event.stopPropagation()
clearTimeout(this.last.kbd_timer)}).on('click.body-global',{delegate:'.w2ui-show-children, .w2ui-col-expand'},event=>{event.stopPropagation()
let ind=query(event.target).parents('tr').attr('index')
this.toggle(this.records[ind].recid)}).on('click.body-global mouseover.body-global',{delegate:'.w2ui-info'},event=>{let td=query(event.delegate).closest('td')
let tr=td.parent()
let col=this.columns[td.attr('col')]
let isSummary=tr.parents('.w2ui-grid-body').hasClass('w2ui-grid-summary')
if(['mouseenter','mouseover'].includes(col.info?.showOn?.toLowerCase())&&event.type=='mouseover'){this.showBubble(tr.attr('index'),td.attr('col'),isSummary).then(()=>{query(event.delegate).off('.tooltip').on('mouseleave.tooltip',()=>{w2tooltip.hide(this.name+'-bubble')})})}else if(event.type=='click'){w2tooltip.hide(this.name+'-bubble')
this.showBubble(tr.attr('index'),td.attr('col'),isSummary)}}).on('mouseover.body-global',{delegate:'.w2ui-clipboard-copy'},event=>{if(event.delegate._tooltipShow)return
let td=query(event.delegate).parent()
let tr=td.parent()
let col=this.columns[td.attr('col')]
let isSummary=tr.parents('.w2ui-grid-body').hasClass('w2ui-grid-summary')
w2tooltip.show({name:this.name+'-bubble',anchor:event.delegate,html:w2utils.lang(typeof col.clipboardCopy=='string'?col.clipboardCopy:'Copy to clipboard'),position:'top|bottom',offsetY:-2}).hide(evt=>{event.delegate._tooltipShow=false
query(event.delegate).off('.tooltip')})
query(event.delegate).off('.tooltip').on('mouseleave.tooltip',evt=>{w2tooltip.hide(this.name+'-bubble')}).on('click.tooltip',evt=>{evt.stopPropagation()
w2tooltip.update(this.name+'-bubble',w2utils.lang('Copied'))
this.clipboardCopy(tr.attr('index'),td.attr('col'),isSummary)})
event.delegate._tooltipShow=true}).on('click.body-global',{delegate:'.w2ui-editable-checkbox'},event=>{let dt=query(event.delegate).data()
this.editChange.call(this,event.delegate,dt.changeind,dt.colind,event)
this.updateToolbar()})
if(this.records.length===0&&this.msgEmpty){query(this.box).find(`#grid_${this.name}_body`).append(`<div id="grid_${this.name}_empty_msg" class="w2ui-grid-empty-msg"><div>${w2utils.lang(this.msgEmpty)}</div></div>`)}else if(query(this.box).find(`#grid_${this.name}_empty_msg`).length>0){query(this.box).find(`#grid_${this.name}_empty_msg`).remove()}
if(this.summary.length>0){let sumHTML=this.getSummaryHTML()
query(this.box).find(`#grid_${this.name}_fsummary`).html(sumHTML[0]).show()
query(this.box).find(`#grid_${this.name}_summary`).html(sumHTML[1]).show()}else{query(this.box).find(`#grid_${this.name}_fsummary`).hide()
query(this.box).find(`#grid_${this.name}_summary`).hide()}}
render(box){let time=Date.now()
let obj=this
if(typeof box=='string')box=query(box).get(0)
let edata=this.trigger('render',{target:this.name,box:box??this.box})
if(edata.isCancelled===true)return
if(box!=null){this.unmount()
this.box=box}
if(!this.box)return
let url=(typeof this.url!='object'?this.url:this.url.get)
this.reset(true)
if(!this.last.field){if(!this.multiSearch||!this.show.searchAll){let tmp=0
while(tmp<this.searches.length&&(this.searches[tmp].hidden||this.searches[tmp].simple===false))tmp++
if(tmp>=this.searches.length){this.last.field=''
this.last.label=''}else{this.last.field=this.searches[tmp].field
this.last.label=this.searches[tmp].label}}else{this.last.field='all'
this.last.label='All Fields'}}
query(this.box).attr('name',this.name).addClass('w2ui-reset w2ui-grid w2ui-inactive').html('<div class="w2ui-grid-box">'+'    <div id="grid_'+this.name+'_header" class="w2ui-grid-header"></div>'+'    <div id="grid_'+this.name+'_toolbar" class="w2ui-grid-toolbar"></div>'+'    <div id="grid_'+this.name+'_body" class="w2ui-grid-body"></div>'+'    <div id="grid_'+this.name+'_fsummary" class="w2ui-grid-body w2ui-grid-summary"></div>'+'    <div id="grid_'+this.name+'_summary" class="w2ui-grid-body w2ui-grid-summary"></div>'+'    <div id="grid_'+this.name+'_footer" class="w2ui-grid-footer"></div>'+'    <textarea id="grid_'+this.name+'_focus" class="w2ui-grid-focus-input" '+
(this.tabIndex?'tabindex="'+this.tabIndex+'"':'')+
(w2utils.isMobile?'readonly':'')+'></textarea>'+'</div>')
if(this.selectType!='row')query(this.box).addClass('w2ui-ss')
if(query(this.box).length>0)query(this.box)[0].style.cssText+=this.style
if(this.toolbar!=null)this.toolbar.render(query(this.box).find('#grid_'+this.name+'_toolbar')[0])
this.last.toolbar_height=query(this.box).find(`#grid_${this.name}_toolbar`).prop('offsetHeight')
if(this.last.field&&this.last.field!='all'){let sd=this.searchData
setTimeout(()=>{this.searchInitInput(this.last.field,(sd.length==1?sd[0].value:null))},1)}
query(this.box).find(`#grid_${this.name}_footer`).html(this.getFooterHTML())
if(!this.last.state)this.last.state=this.stateSave(true)
this.stateRestore()
if(url){this.clear();this.refresh()}
let hasHiddenSearches=false
for(let i=0;i<this.searches.length;i++){if(this.searches[i].hidden){hasHiddenSearches=true;break}}
if(hasHiddenSearches){this.searchReset(false)
if(!url)setTimeout(()=>{this.searchReset()},1)}else{this.reload()}
query(this.box).find(`#grid_${this.name}_focus`).on('focus',(event)=>{clearTimeout(this.last.kbd_timer)
if(!this.hasFocus)this.focus()}).on('blur',(event)=>{clearTimeout(this.last.kbd_timer)
this.last.kbd_timer=setTimeout(()=>{if(this.hasFocus){this.blur()}},100)}).on('paste',(event)=>{let cd=(event.clipboardData?event.clipboardData:null)
if(cd){let items=cd.items
if(items.length==2){if(items.length==2&&items[1].kind=='file'){items=[items[1]]}
if(items.length==2&&items[0].type=='text/plain'&&items[1].type=='text/html'){items=[items[1]]}}
let items2send=[]
for(let index in items){let item=items[index]
if(item.kind==='file'){let file=item.getAsFile()
items2send.push({kind:'file',data:file})}else if(item.kind==='string'&&(item.type==='text/plain'||item.type==='text/html')){event.preventDefault()
let text=cd.getData('text/plain')
if(text.indexOf('\r')!=-1&&text.indexOf('\n')==-1){text=text.replace(/\r/g,'\n')}
items2send.push({kind:(item.type=='text/html'?'html':'text'),data:text})}}
if(items2send.length===1&&items2send[0].kind!='file'){items2send=items2send[0].data}
w2ui[this.name].paste(items2send,event)
event.preventDefault()}}).on('keydown',function(event){w2ui[obj.name].keydown.call(w2ui[obj.name],event)})
let edataCol
query(this.box).off('mousedown.mouseStart').on('mousedown.mouseStart',mouseStart)
this.updateToolbar()
edata.finish()
this.last.observeResize=new ResizeObserver(()=>{this.resize()
this.scroll()})
this.last.observeResize.observe(this.box)
return Date.now()-time
function mouseStart(event){if(event.which!=1)return
if(obj.last.userSelect=='text'){obj.last.userSelect=''
query(obj.box).find('.w2ui-grid-body').css('user-select','none')}
if(obj.selectType=='row'&&(query(event.target).parents().hasClass('w2ui-head')||query(event.target).hasClass('w2ui-head')))return
if(obj.last.move&&obj.last.move.type=='expand')return
if(event.altKey){query(obj.box).find('.w2ui-grid-body').css('user-select','text')
obj.selectNone()
obj.last.move={type:'text-select'}
obj.last.userSelect='text'}else{let tmp=event.target
let pos={x:event.offsetX-10,y:event.offsetY-10}
let tmps=false
while(tmp){if(tmp.classList&&tmp.classList.contains('w2ui-grid'))break
if(tmp.tagName&&tmp.tagName.toUpperCase()=='TD')tmps=true
if(tmp.tagName&&tmp.tagName.toUpperCase()!='TR'&&tmps==true){pos.x+=tmp.offsetLeft
pos.y+=tmp.offsetTop}
tmp=tmp.parentNode}
let index=query(event.target).parents('tr').attr('index')
let recid=obj.records[index]?.recid
if(obj.selectType=='cell'&&!event.shiftKey){let column1=parseInt(query(event.target).closest('td').attr('col'))
let column2=column1
if(isNaN(column1)){column1=0
column2=obj.columns.length-1}
obj.addRange({name:'selection-preview',range:[{recid,column:column1},{recid,column:column2}],class:'w2ui-selection-preview'})}
obj.last.move={x:event.screenX,y:event.screenY,divX:0,divY:0,focusX:pos.x,focusY:pos.y,recid:recid,column:parseInt(event.target.tagName.toUpperCase()=='TD'?query(event.target).attr('col'):query(event.target).parents('td').attr('col')),type:'select',ghost:false,start:true}
if(obj.last.move.recid==null&&obj.records.length>0){obj.last.move.type='select-column'
let column=parseInt(query(event.target).closest('td').attr('col'))
let start=obj.records[0].recid
let end=obj.records[obj.records.length-1].recid
obj.addRange({name:'selection-preview',range:[{recid:start,column},{recid:end,column}],class:'w2ui-selection-preview'})}
let target=event.target
let $input=query(obj.box).find('#grid_'+obj.name+'_focus')
if(obj.last.move){let sLeft=obj.last.move.focusX
let sTop=obj.last.move.focusY
let $owner=query(target).parents('table').parent()
if($owner.hasClass('w2ui-grid-records')||$owner.hasClass('w2ui-grid-frecords')||$owner.hasClass('w2ui-grid-columns')||$owner.hasClass('w2ui-grid-fcolumns')||$owner.hasClass('w2ui-grid-summary')){sLeft=obj.last.move.focusX-query(obj.box).find('#grid_'+obj.name+'_records').prop('scrollLeft')
sTop=obj.last.move.focusY-query(obj.box).find('#grid_'+obj.name+'_records').prop('scrollTop')}
if(query(target).hasClass('w2ui-grid-footer')||query(target).parents('div.w2ui-grid-footer').length>0){sTop=query(obj.box).find('#grid_'+obj.name+'_footer').get(0).offsetTop}
if($owner.hasClass('w2ui-scroll-wrapper')&&$owner.parent().hasClass('w2ui-toolbar')){sLeft=obj.last.move.focusX-$owner.prop('scrollLeft')}
$input.css({left:sLeft-10,top:sTop})}
setTimeout(()=>{if(!obj.last.inEditMode){if(['INPUT','TEXTAREA','SELECT'].includes(target.tagName)){target.focus()}else{if($input.get(0)!==document.active)$input.get(0)?.focus({preventScroll:true})}}},50)
if(!obj.multiSelect&&!obj.reorderRows&&obj.last.move.type=='drag'){delete obj.last.move}}
if(obj.reorderRows==true){let el=event.target
if(el.tagName.toUpperCase()!='TD')el=query(el).parents('td')[0]
if(query(el).hasClass('w2ui-col-number')||query(el).hasClass('w2ui-col-order')){obj.selectNone()
obj.last.move.reorder=true
let eColor=query(obj.box).find('.w2ui-even.w2ui-empty-record').css('background-color')
let oColor=query(obj.box).find('.w2ui-odd.w2ui-empty-record').css('background-color')
query(obj.box).find('.w2ui-even td').filter(':not(.w2ui-col-number)').css('background-color',eColor)
query(obj.box).find('.w2ui-odd td').filter(':not(.w2ui-col-number)').css('background-color',oColor)
let mv=obj.last.move
let recs=query(obj.box).find('.w2ui-grid-records')
if(!mv.ghost){let row=query(obj.box).find(`#grid_${obj.name}_rec_${mv.recid}`)
let tmp=row.parents('table').find('tr:first-child').get(0).cloneNode(true)
mv.offsetY=event.offsetY
mv.from=mv.recid
mv.pos={top:row.get(0).offsetTop-1,left:row.get(0).offsetLeft}
mv.ghost=query(row.get(0).cloneNode(true))
mv.ghost.removeAttr('id')
mv.ghost.find('td').css({'border-top':'1px solid silver','border-bottom':'1px solid silver'})
row.find('td').remove()
row.append(`<td colspan="1000"><div class="w2ui-reorder-empty" style="height: ${(obj.recordHeight - 2)}px"></div></td>`)
recs.append('<div id="grid_'+obj.name+'_ghost_line" style="position: absolute; z-index: 999999; pointer-events: none; width: 100%;"></div>')
recs.append('<table id="grid_'+obj.name+'_ghost" style="position: absolute; z-index: 999998; opacity: 0.9; pointer-events: none;"></table>')
query(obj.box).find('#grid_'+obj.name+'_ghost').append(tmp).append(mv.ghost)}
let ghost=query(obj.box).find('#grid_'+obj.name+'_ghost')
ghost.css({top:mv.pos.top+'px',left:mv.pos.left+'px'})}else{obj.last.move.reorder=false}}
query(document).on('mousemove.w2ui-'+obj.name,mouseMove).on('mouseup.w2ui-'+obj.name,mouseStop)
event.stopPropagation()}
function mouseMove(event){if(!event.target.tagName){return}
let mv=obj.last.move
if(!mv||!['select','select-column'].includes(mv.type))return
mv.divX=(event.screenX-mv.x)
mv.divY=(event.screenY-mv.y)
if(Math.abs(mv.divX)<=1&&Math.abs(mv.divY)<=1)return
obj.last.cancelClick=true
if(obj.reorderRows==true&&obj.last.move.reorder){let tmp=query(event.target).parents('tr')
let ind=tmp.attr('index')
let recid=obj.records[ind]?.recid
if(recid=='-none-'||recid==null)recid='bottom'
if(recid!=mv.from){let row2=query(obj.box).find('#grid_'+obj.name+'_rec_'+recid)
query(obj.box).find('.insert-before')
row2.addClass('insert-before')
mv.lastY=event.screenY
mv.to=recid
let pos={top:row2.get(0)?.offsetTop,left:row2.get(0)?.offsetLeft}
let ghost_line=query(obj.box).find('#grid_'+obj.name+'_ghost_line')
if(pos){ghost_line.css({top:pos.top+'px',left:mv.pos.left+'px','border-top':'2px solid #769EFC'})}else{ghost_line.css({'border-top':'2px solid transparent'})}}
let ghost=query(obj.box).find('#grid_'+obj.name+'_ghost')
ghost.css({top:(mv.pos.top+mv.divY)+'px',left:mv.pos.left+'px'})
return}
if(obj.selectType=='row'&&mv.start&&mv.recid){obj.selectNone()
mv.start=false}
let newSel=[]
let ind=(event.target.tagName.toUpperCase()=='TR'?query(event.target).attr('index'):query(event.target).parents('tr').attr('index'))
let recid=obj.records[ind]?.recid
if(recid==null){if(obj.selectType=='row')return
if(obj.last.move&&obj.last.move.type=='select')return
let col=parseInt(query(event.target).parents('td').attr('col'))
if(isNaN(col)){obj.removeRange('column-selection')
query(obj.box).find('.w2ui-grid-columns .w2ui-col-header, .w2ui-grid-fcolumns .w2ui-col-header').removeClass('w2ui-col-selected')
query(obj.box).find('.w2ui-col-number').removeClass('w2ui-row-selected')
delete mv.colRange}else{let newRange=col+'-'+col
if(mv.column<col)newRange=mv.column+'-'+col
if(mv.column>col)newRange=col+'-'+mv.column
let cols=[]
let tmp=newRange.split('-')
for(let ii=parseInt(tmp[0]);ii<=parseInt(tmp[1]);ii++){cols.push(ii)}
if(mv.colRange!=newRange&&mv.type=='select-column'){edataCol=obj.trigger('columnSelect',{target:obj.name,columns:cols})
if(edataCol.isCancelled!==true){mv.colRange=newRange
let start=obj.records[0].recid
let end=obj.records[obj.records.length-1].recid
obj.addRange({name:'selection-preview',range:[{recid:start,column:tmp[0]},{recid:end,column:tmp[1]}],class:'w2ui-selection-preview'})}}}}else{let ind1=obj.get(mv.recid,true)
if(ind1==null||(obj.records[ind1]&&obj.records[ind1].recid!=mv.recid))return
let ind2=obj.get(recid,true)
if(ind2==null)return
let col1=parseInt(mv.column)
let col2=parseInt(event.target.tagName.toUpperCase()=='TD'?query(event.target).attr('col'):query(event.target).parents('td').attr('col'))
if(isNaN(col1)&&isNaN(col2)){col1=0
col2=obj.columns.length-1}
if(ind1>ind2){let tmp=ind1;ind1=ind2;ind2=tmp}
let tmp='ind1:'+ind1+',ind2;'+ind2+',col1:'+col1+',col2:'+col2
if(mv.range==tmp)return
mv.range=tmp
for(let i=ind1;i<=ind2;i++){if(obj.last.searchIds.length>0&&obj.last.searchIds.indexOf(i)==-1)continue
if(obj.selectType!='row'){if(col1>col2){let tmp=col1;col1=col2;col2=tmp}
for(let c=col1;c<=col2;c++){if(obj.columns[c].hidden)continue
newSel.push({recid:obj.records[i].recid,column:parseInt(c)})}}else{newSel.push(obj.records[i].recid)}}
if(obj.selectType!='row'){let start=newSel[0]
let end=newSel[newSel.length-1]
obj.addRange({name:'selection-preview',range:[{recid:start.recid,column:start.column},{recid:end.recid,column:end.column}],class:'w2ui-selection-preview'})
mv.newRange=newSel}else{if(obj.multiSelect){let sel=obj.getSelection()
for(let ns=0;ns<newSel.length;ns++){if(sel.indexOf(newSel[ns])==-1)obj.select(newSel[ns])}
for(let s=0;s<sel.length;s++){if(newSel.indexOf(sel[s])==-1)obj.unselect(sel[s])}}}}}
function mouseStop(event){let mv=obj.last.move
setTimeout(()=>{delete obj.last.cancelClick},1)
if(query(event.target).parents().hasClass('.w2ui-head')||query(event.target).hasClass('.w2ui-head'))return
obj.removeRange('selection-preview')
if(mv&&['select','select-column'].includes(mv.type)){if(mv.colRange!=null&&edataCol.isCancelled!==true){let tmp=mv.colRange.split('-')
let sel=[]
for(let i=0;i<obj.records.length;i++){let cols=[]
for(let j=parseInt(tmp[0]);j<=parseInt(tmp[1]);j++)cols.push(j)
sel.push({recid:obj.records[i].recid,column:cols})}
edataCol.finish()
obj.selectNone(true)
obj.select(sel)}else if(mv.newRange!=null){obj.selectNone(true)
obj.select(...mv.newRange)}
if(obj.reorderRows==true&&obj.last.move.reorder){if(mv.to!=null){let edata=obj.trigger('reorderRow',{target:obj.name,recid:mv.from,moveBefore:mv.to})
if(edata.isCancelled===true){resetRowReorder()
delete obj.last.move
return}
let ind1=obj.get(mv.from,true)
let ind2=obj.get(mv.to,true)
if(mv.to=='bottom')ind2=obj.records.length
let tmp=obj.records[ind1]
if(ind1!=null&&ind2!=null){obj.records.splice(ind1,1)
if(ind1>ind2){obj.records.splice(ind2,0,tmp)}else{obj.records.splice(ind2-1,0,tmp)}}
obj.sortData=[]
query(obj.box).find(`#grid_${obj.name}_columns .w2ui-col-header`).removeClass('w2ui-col-sorted')
resetRowReorder()
edata.finish()}else{resetRowReorder()}}}
delete obj.last.move
query(document).off('.w2ui-'+obj.name)}
function resetRowReorder(){query(obj.box).find(`#grid_${obj.name}_ghost`).remove()
query(obj.box).find(`#grid_${obj.name}_ghost_line`).remove()
obj.refresh()
delete obj.last.move}}
unmount(){super.unmount()
this.toolbar?.unmount()
this.last.observeResize?.disconnect()}
destroy(){let edata=this.trigger('destroy',{target:this.name})
if(edata.isCancelled===true)return
this.toolbar?.destroy?.()
if(query(this.box).find(`#grid_${this.name}_body`).length>0){this.unmount()}
delete w2ui[this.name]
edata.finish()}
initColumnOnOff(){let items=[{id:'line-numbers',text:'Line #',checked:this.show.lineNumbers}]
for(let c=0;c<this.columns.length;c++){let col=this.columns[c]
let text=this.columns[c].text
if(col.hideable===false)continue
if(!text&&this.columns[c].tooltip)text=this.columns[c].tooltip
if(!text)text='- column '+(parseInt(c)+1)+' -'
items.push({id:col.field,text:w2utils.stripTags(text),checked:!col.hidden})}
let url=(typeof this.url!='object'?this.url:this.url.get)
if((url&&this.show.skipRecords)||this.show.saveRestoreState){items.push({text:'--'})}
if(this.show.skipRecords){let skip=w2utils.lang('Skip')+`<input id="${this.name}_skip" type="text" class="w2ui-input w2ui-grid-skip" value="${this.offset}">`+
w2utils.lang('records')
items.push({id:'w2ui-skip',text:skip,group:false,icon:'w2ui-icon-empty'})}
if(this.show.saveRestoreState){items.push({id:'w2ui-stateSave',text:w2utils.lang('Save Grid State'),icon:'w2ui-icon-empty',group:false},{id:'w2ui-stateReset',text:w2utils.lang('Restore Default State'),icon:'w2ui-icon-empty',group:false})}
let selected=[]
items.forEach(item=>{item.text=w2utils.lang(item.text)
if(item.checked)selected.push(item.id)})
this.toolbar.set('w2ui-column-on-off',{selected,items})
return items}
initColumnDrag(box){if(this.columnGroups&&this.columnGroups.length){throw'Draggable columns are not currently supported with column groups.'}
let self=this
let dragData={pressed:false,targetPos:null,columnHead:null}
let hasInvalidClass=(target,lastColumn)=>{let iClass=['w2ui-col-number','w2ui-col-expand','w2ui-col-select']
if(lastColumn!==true)iClass.push('w2ui-head-last')
for(let i=0;i<iClass.length;i++){if(query(target).closest('.w2ui-head').hasClass(iClass[i])){return true}}
return false}
query(self.box).off('.colDrag').on('mousedown.colDrag',dragColStart)
function dragColStart(event){if(dragData.pressed||dragData.numberPreColumnsPresent===0||event.button!==0)return
let edata,columns,origColumn,origColumnNumber
let preColHeadersSelector='.w2ui-head.w2ui-col-number, .w2ui-head.w2ui-col-expand, .w2ui-head.w2ui-col-select'
if(!query(event.target).parents().hasClass('w2ui-head')||hasInvalidClass(event.target))return
dragData.pressed=true
dragData.initialX=event.pageX
dragData.initialY=event.pageY
dragData.numberPreColumnsPresent=query(self.box).find(preColHeadersSelector).length
dragData.columnHead=origColumn=query(event.target).closest('.w2ui-head')
dragData.originalPos=origColumnNumber=parseInt(origColumn.attr('col'),10)
edata=self.trigger('columnDragStart',{originalEvent:event,origColumnNumber,target:origColumn[0]})
if(edata.isCancelled===true)return false
columns=dragData.columns=query(self.box).find('.w2ui-head:not(.w2ui-head-last)')
query(document).on('mouseup.colDrag',dragColEnd)
query(document).on('mousemove.colDrag',dragColOver)
let col=self.columns[dragData.originalPos]
let colText=w2utils.lang(typeof col.text=='function'?col.text(col):col.text)
dragData.ghost=query.html(`<span col="${dragData.originalPos}">${colText}</span>`)[0]
query(document.body).append(dragData.ghost)
query(dragData.ghost).css({display:'none',left:event.pageX,top:event.pageY,opacity:1,margin:'3px 0 0 20px',padding:'3px','background-color':'white',position:'fixed','z-index':999999,}).addClass('.w2ui-grid-ghost')
dragData.offsets=[]
for(let i=0,l=columns.length;i<l;i++){let rect=columns[i].getBoundingClientRect()
dragData.offsets.push(rect.left)}
edata.finish()}
function dragColOver(event){if(!dragData.pressed||!dragData.columnHead)return
let cursorX=event.pageX
let cursorY=event.pageY
if(!hasInvalidClass(event.target,true)){markIntersection(event)}
trackGhost(cursorX,cursorY)}
function dragColEnd(event){if(!dragData.pressed||!dragData.columnHead)return
dragData.pressed=false
let edata,target,selected,columnConfig
let finish=()=>{let ghosts=query(self.box).find('.w2ui-grid-ghost')
query(self.box).find('.w2ui-intersection-marker').hide()
query(dragData.ghost).remove()
ghosts.remove()
query(document).off('.colDrag')
dragData={}}
if(event.pageX==dragData.initialX&&event.pageY==dragData.initialY){self.columnClick(self.columns[dragData.originalPos].field,event)
finish()
return}
edata=self.trigger('columnDragEnd',{originalEvent:event,target:dragData.columnHead[0],dragData})
if(edata.isCancelled===true)return false
selected=self.columns[dragData.originalPos]
columnConfig=self.columns
if(dragData.originalPos!=dragData.targetPos&&dragData.targetPos!=null){columnConfig.splice(dragData.targetPos,0,w2utils.clone(selected))
columnConfig.splice(columnConfig.indexOf(selected),1)}
finish()
self.refresh()
edata.finish({targetColumn:target-1})}
function markIntersection(event){if(query(event.target).closest('td').length==0){return}
let td=query(event.target).closest('td')
let newPos=td.hasClass('w2ui-head-last')?self.columns.length:parseInt(td.attr('col'))
if(dragData.targetPos!=newPos){let rect1=query(self.box).find('.w2ui-grid-body').get(0).getBoundingClientRect()
let rect2=query(event.target).closest('td').get(0).getBoundingClientRect()
query(self.box).find('.w2ui-intersection-marker').show().css({left:(rect2.left-rect1.left)+'px',height:rect2.height+'px'})
dragData.targetPos=newPos}
return}
function trackGhost(cursorX,cursorY){query(dragData.ghost).css({left:(cursorX-10)+'px',top:(cursorY-10)+'px'}).show()}
return{remove(){query(self.box).off('.colDrag')
self.last.columnDrag=false}}}
columnOnOff(event,field){let edata=this.trigger('columnOnOff',{target:this.name,field:field,originalEvent:event})
if(edata.isCancelled===true)return
let rows=this.find({'w2ui.expanded':true},true)
for(let r=0;r<rows.length;r++){let tmp=this.records[r].w2ui
if(tmp&&!Array.isArray(tmp.children)){this.records[r].w2ui.expanded=false}}
if(field=='line-numbers'){this.show.lineNumbers=!this.show.lineNumbers
this.refresh()}else{let col=this.getColumn(field)
if(col.hidden){this.showColumn(col.field)}else{this.hideColumn(col.field)}}
edata.finish()}
initToolbar(){if(this.toolbar.render!=null){return}
let tb_items=this.toolbar.items||[]
this.toolbar.items=[]
this.toolbar=new w2toolbar(w2utils.extend({},this.toolbar,{name:this.name+'_toolbar',owner:this}))
if(this.show.toolbarReload){this.toolbar.items.push(w2utils.extend({},this.buttons.reload))}
if(this.show.toolbarColumns){this.toolbar.items.push(w2utils.extend({},this.buttons.columns))}
if(this.show.toolbarSearch){let html=`
                <div class="w2ui-grid-search-input">
                    ${this.buttons.search.html}
                    <div id="grid_${this.name}_search_name" class="w2ui-grid-search-name">
                        <span class="name-icon w2ui-icon-search"></span>
                        <span class="name-text"></span>
                        <span class="name-cross w2ui-action" data-click="searchReset">x</span>
                    </div>
                    <input type="text" id="grid_${this.name}_search_all" class="w2ui-search-all" tabindex="-1"
                        autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false"
                        placeholder="${w2utils.lang(this.last.label, true)}" value="${this.last.search}"
                        data-focus="searchSuggest" data-click="stop"
                    >
                    <div class="w2ui-search-drop w2ui-action" data-click="searchOpen"
                            style="${this.multiSearch ? '' : 'display: none'}">
                        <span class="w2ui-icon-drop"></span>
                    </div>
                </div>`
this.toolbar.items.push({id:'w2ui-search',type:'html',html,onRefresh:async(event)=>{await event.complete
let input=query(this.box).find(`#grid_${this.name}_search_all`)
w2utils.bindEvents(query(this.box).find(`#grid_${this.name}_search_all, .w2ui-action`),this)
let slowSearch=w2utils.debounce((event)=>{let val=event.target.value
if(this.liveSearch&&this.last.liveText!=val){this.last.liveText=val
this.search(this.last.field,val)}},250)
input.on('blur',()=>{this.last.liveText=''}).on('keyup',(event)=>{switch(event.keyCode){case 40:{this.searchSuggest(true)
break}
case 38:{this.searchSuggest(true,true)
break}
case 13:{this.search(this.last.field,event.target.value)
break}
default:{slowSearch(event)
break}}})}})}
if(Array.isArray(tb_items)){let ids=tb_items.map(item=>item.id)
if(this.show.toolbarAdd&&!ids.includes(this.buttons.add.id)){this.toolbar.items.push(w2utils.extend({},this.buttons.add))}
if(this.show.toolbarEdit&&!ids.includes(this.buttons.edit.id)){this.toolbar.items.push(w2utils.extend({},this.buttons.edit))}
if(this.show.toolbarDelete&&!ids.includes(this.buttons.delete.id)){this.toolbar.items.push(w2utils.extend({},this.buttons.delete))}
if(this.show.toolbarSave&&!ids.includes(this.buttons.save.id)){if(this.show.toolbarAdd||this.show.toolbarDelete||this.show.toolbarEdit){this.toolbar.items.push({type:'break',id:'w2ui-break2'})}
this.toolbar.items.push(w2utils.extend({},this.buttons.save))}
tb_items=tb_items.map(item=>this.buttons[item.name]?w2utils.extend({},this.buttons[item.name],item):item)}
this.toolbar.items.push(...tb_items)
this.toolbar.on('click',(event)=>{let edata=this.trigger('toolbar',{target:event.target,originalEvent:event})
if(edata.isCancelled===true)return
let edata2
switch(event.detail.item.id){case'w2ui-reload':edata2=this.trigger('reload',{target:this.name})
if(edata2.isCancelled===true)return false
this.reload()
edata2.finish()
break
case'w2ui-column-on-off':if(event.detail.subItem){let id=event.detail.subItem.id
if(['w2ui-stateSave','w2ui-stateReset'].includes(id)){this[id.substring(5)]()}else if(id=='w2ui-skip'){}else{this.columnOnOff(event,event.detail.subItem.id)}}else{this.initColumnOnOff()
setTimeout(()=>{query(`#w2overlay-${this.name}_toolbar-drop .w2ui-grid-skip`).off('.w2ui-grid').on('click.w2ui-grid',evt=>{evt.stopPropagation()}).on('keypress',evt=>{if(evt.keyCode==13){this.skip(evt.target.value)
this.toolbar.click('w2ui-column-on-off')}})},100)}
break
case'w2ui-add':edata2=this.trigger('add',{target:this.name,recid:null})
if(edata2.isCancelled===true)return false
edata2.finish()
break
case'w2ui-edit':{let sel=this.getSelection()
let recid=null
if(sel.length==1)recid=sel[0]
edata2=this.trigger('edit',{target:this.name,recid:recid})
if(edata2.isCancelled===true)return false
edata2.finish()
break}
case'w2ui-delete':this.delete()
break
case'w2ui-save':this.save()
break}
edata.finish()})
this.toolbar.on('refresh',(event)=>{if(event.target=='w2ui-search'){let sd=this.searchData
setTimeout(()=>{this.searchInitInput(this.last.field,(sd.length==1?sd[0].value:null))},1)}})}
initResize(){let obj=this
query(this.box).find('.w2ui-resizer').off('.grid-col-resize').on('click.grid-col-resize',function(event){event.stopPropagation()
event.preventDefault()}).on('mousedown.grid-col-resize',function(event){if(!event)event=window.event
obj.last.colResizing=true
obj.last.tmp={x:event.screenX,y:event.screenY,gx:event.screenX,gy:event.screenY,col:parseInt(query(this).attr('name'))}
obj.last.tmp.tds=query(obj.box).find('#grid_'+obj.name+'_body table tr:first-child td[col="'+obj.last.tmp.col+'"]')
event.stopPropagation()
event.preventDefault()
for(let c=0;c<obj.columns.length;c++){if(obj.columns[c].hidden)continue
if(obj.columns[c].sizeOriginal==null)obj.columns[c].sizeOriginal=obj.columns[c].size
obj.columns[c].size=obj.columns[c].sizeCalculated}
let edata=obj.trigger('columnResize',{target:obj.name,resizeBy:0,originalEvent:event,column:obj.last.tmp.col,field:obj.columns[obj.last.tmp.col].field})
let timer
let mouseMove=function(event){if(obj.last.colResizing!=true)return
if(!event)event=window.event
let edata2=obj.trigger('columnResizeMove',w2utils.extend(edata.detail,{resizeBy:(event.screenX-obj.last.tmp.gx),originalEvent:event}))
if(edata2.isCancelled===true){return}
obj.last.tmp.x=(event.screenX-obj.last.tmp.x)
obj.last.tmp.y=(event.screenY-obj.last.tmp.y)
let newWidth=(parseInt(obj.columns[obj.last.tmp.col].size)+obj.last.tmp.x)+'px'
obj.columns[obj.last.tmp.col].size=newWidth
if(timer)clearTimeout(timer)
timer=setTimeout(()=>{obj.resizeRecords()
obj.scroll()},100)
obj.last.tmp.tds.css({width:newWidth})
obj.last.tmp.x=event.screenX
obj.last.tmp.y=event.screenY
edata2.finish()}
let mouseUp=function(event){query(document).off('.grid-col-resize')
obj.resizeRecords()
obj.scroll()
edata.finish({originalEvent:event})
setTimeout(()=>{obj.last.colResizing=false},1)}
query(document).off('.grid-col-resize').on('mousemove.grid-col-resize',mouseMove).on('mouseup.grid-col-resize',mouseUp)}).on('dblclick.grid-col-resize',function(event){let ind=parseInt(query(this).attr('name'))
obj.columnAutoSize(ind)
event.stopPropagation()
event.preventDefault()}).each(el=>{let td=query(el).get(0).parentNode
query(el).css({'height':td.clientHeight+'px','margin-left':(td.clientWidth-3)+'px'})})}
resizeBoxes(){let header=query(this.box).find(`#grid_${this.name}_header`)
let toolbar=query(this.box).find(`#grid_${this.name}_toolbar`)
let fsummary=query(this.box).find(`#grid_${this.name}_fsummary`)
let summary=query(this.box).find(`#grid_${this.name}_summary`)
let footer=query(this.box).find(`#grid_${this.name}_footer`)
let body=query(this.box).find(`#grid_${this.name}_body`)
if(this.show.header){header.css({top:'0px',left:'0px',right:'0px'})}
if(this.show.toolbar){toolbar.css({top:(0+(this.show.header?w2utils.getSize(header,'height'):0))+'px',left:'0px',right:'0px'})}
if(this.summary.length>0){fsummary.css({bottom:(0+(this.show.footer?w2utils.getSize(footer,'height'):0))+'px'})
summary.css({bottom:(0+(this.show.footer?w2utils.getSize(footer,'height'):0))+'px',right:'0px'})}
if(this.show.footer){footer.css({bottom:'0px',left:'0px',right:'0px'})}
body.css({top:(0+(this.show.header?w2utils.getSize(header,'height'):0)+(this.show.toolbar?w2utils.getSize(toolbar,'height'):0))+'px',bottom:(0+(this.show.footer?w2utils.getSize(footer,'height'):0)+(this.summary.length>0?w2utils.getSize(summary,'height'):0))+'px',left:'0px',right:'0px'})}
resizeRecords(){let obj=this
query(this.box).find('.w2ui-empty-record').remove()
let box=query(this.box)
let grid=query(this.box).find(':scope > div.w2ui-grid-box')
let header=query(this.box).find(`#grid_${this.name}_header`)
let toolbar=query(this.box).find(`#grid_${this.name}_toolbar`)
let summary=query(this.box).find(`#grid_${this.name}_summary`)
let fsummary=query(this.box).find(`#grid_${this.name}_fsummary`)
let footer=query(this.box).find(`#grid_${this.name}_footer`)
let body=query(this.box).find(`#grid_${this.name}_body`)
let columns=query(this.box).find(`#grid_${this.name}_columns`)
let fcolumns=query(this.box).find(`#grid_${this.name}_fcolumns`)
let records=query(this.box).find(`#grid_${this.name}_records`)
let frecords=query(this.box).find(`#grid_${this.name}_frecords`)
let scroll1=query(this.box).find(`#grid_${this.name}_scroll1`)
let lineNumberWidth=String(this.total).length*8+10
if(lineNumberWidth<34)lineNumberWidth=34
if(this.lineNumberWidth!=null)lineNumberWidth=this.lineNumberWidth
let bodyOverflowX=false
let bodyOverflowY=false
let sWidth=0
for(let i=0;i<this.columns.length;i++){if(this.columns[i].frozen||this.columns[i].hidden)continue
let cSize=parseInt(this.columns[i].sizeCalculated?this.columns[i].sizeCalculated:this.columns[i].size)
sWidth+=cSize}
if(records[0]?.clientWidth<sWidth)bodyOverflowX=true
if(body[0]?.clientHeight-(columns[0]?.clientHeight??0)<(query(records).find(':scope > table')[0]?.clientHeight??0)+(bodyOverflowX?w2utils.scrollBarSize():0)){bodyOverflowY=true}
if(!this.fixedBody){let bodyHeight=w2utils.getSize(columns,'height')
+w2utils.getSize(query(this.box).find('#grid_'+this.name+'_records table'),'height')
+(bodyOverflowX?w2utils.scrollBarSize():0)
let calculatedHeight=bodyHeight
+(this.show.header?w2utils.getSize(header,'height'):0)
+(this.show.toolbar?w2utils.getSize(toolbar,'height'):0)
+(summary.css('display')!='none'?w2utils.getSize(summary,'height'):0)
+(this.show.footer?w2utils.getSize(footer,'height'):0)
grid.css('height',calculatedHeight+'px')
body.css('height',bodyHeight+'px')
box.css('height',w2utils.getSize(grid,'height')+'px')}else{let calculatedHeight=grid[0]?.clientHeight
-(this.show.header?w2utils.getSize(header,'height'):0)
-(this.show.toolbar?w2utils.getSize(toolbar,'height'):0)
-(summary.css('display')!='none'?w2utils.getSize(summary,'height'):0)
-(this.show.footer?w2utils.getSize(footer,'height'):0)
body.css('height',calculatedHeight+'px')}
let buffered=this.records.length
let url=(typeof this.url!='object'?this.url:this.url.get)
if(this.searchData.length!=0&&!url)buffered=this.last.searchIds.length
if(!this.fixedBody){bodyOverflowY=false}
if(bodyOverflowX||bodyOverflowY){columns.find(':scope > table > tbody > tr:nth-child(1) td.w2ui-head-last').css('width',w2utils.scrollBarSize()+'px').show()
records.css({top:((this.columnGroups.length>0&&this.show.columns?1:0)+w2utils.getSize(columns,'height'))+'px','-webkit-overflow-scrolling':'touch','overflow-x':(bodyOverflowX?'auto':'hidden'),'overflow-y':(bodyOverflowY?'auto':'hidden')})}else{columns.find(':scope > table > tbody > tr:nth-child(1) td.w2ui-head-last').hide()
records.css({top:((this.columnGroups.length>0&&this.show.columns?1:0)+w2utils.getSize(columns,'height'))+'px',overflow:'hidden'})
if(records.length>0){this.last.vscroll.scrollTop=0;this.last.vscroll.scrollLeft=0}}
if(bodyOverflowX){frecords.css('margin-bottom',w2utils.scrollBarSize()+'px')
scroll1.show()}else{frecords.css('margin-bottom',0)
scroll1.hide()}
frecords.css({overflow:'hidden',top:records.css('top')})
if(this.show.emptyRecords&&!bodyOverflowY){let max=Math.floor((records[0]?.clientHeight??0)/this.recordHeight)-1
let leftover=0
if(records[0])leftover=records[0].scrollHeight-max*this.recordHeight
if(leftover>=this.recordHeight){leftover-=this.recordHeight
max++}
if(this.fixedBody){for(let di=buffered;di<max;di++){addEmptyRow(di,this.recordHeight,this)}
addEmptyRow(max,leftover,this)}}
function addEmptyRow(row,height,grid){let html1=''
let html2=''
let htmlp=''
html1+='<tr class="'+(row%2?'w2ui-even':'w2ui-odd')+' w2ui-empty-record" recid="-none-" style="height: '+height+'px">'
html2+='<tr class="'+(row%2?'w2ui-even':'w2ui-odd')+' w2ui-empty-record" recid="-none-" style="height: '+height+'px">'
if(grid.show.lineNumbers)html1+='<td class="w2ui-col-number"></td>'
if(grid.show.selectColumn)html1+='<td class="w2ui-grid-data w2ui-col-select"></td>'
if(grid.show.expandColumn)html1+='<td class="w2ui-grid-data w2ui-col-expand"></td>'
html2+='<td class="w2ui-grid-data-spacer" col="start" style="border-right: 0"></td>'
if(grid.reorderRows)html2+='<td class="w2ui-grid-data w2ui-col-order" col="order"></td>'
for(let j=0;j<grid.columns.length;j++){let col=grid.columns[j]
if((col.hidden||j<grid.last.vscroll.colIndStart||j>grid.last.vscroll.colIndEnd)&&!col.frozen)continue
htmlp='<td class="w2ui-grid-data" '+(col.attr!=null?col.attr:'')+' col="'+j+'"></td>'
if(col.frozen)html1+=htmlp;else html2+=htmlp}
html1+='<td class="w2ui-grid-data-last"></td> </tr>'
html2+='<td class="w2ui-grid-data-last" col="end"></td> </tr>'
query(grid.box).find('#grid_'+grid.name+'_frecords > table').append(html1)
query(grid.box).find('#grid_'+grid.name+'_records > table').append(html2)}
let width_box,percent
if(body.length>0){let width_max=parseInt(body[0].clientWidth)
-(bodyOverflowY?w2utils.scrollBarSize():0)
-(this.show.lineNumbers?lineNumberWidth:0)
-(this.reorderRows?26:0)
-(this.show.selectColumn?26:0)
-(this.show.expandColumn?26:0)
-1
width_box=width_max
percent=0
let restart=false
for(let i=0;i<this.columns.length;i++){let col=this.columns[i]
if(col.gridMinWidth>0){if(col.gridMinWidth>width_box&&col.hidden!==true){col.hidden=true
restart=true}
if(col.gridMinWidth<width_box&&col.hidden===true){col.hidden=false
restart=true}}}
if(restart===true){this.refresh()
return}
for(let i=0;i<this.columns.length;i++){let col=this.columns[i]
if(col.hidden)continue
if(String(col.size).substr(String(col.size).length-2).toLowerCase()=='px'){width_max-=parseFloat(col.size)
this.columns[i].sizeCalculated=col.size
this.columns[i].sizeType='px'}else{percent+=parseFloat(col.size)
this.columns[i].sizeType='%'
delete col.sizeCorrected}}
if(percent!=100&&percent>0){for(let i=0;i<this.columns.length;i++){let col=this.columns[i]
if(col.hidden)continue
if(col.sizeType=='%'){col.sizeCorrected=Math.round(parseFloat(col.size)*100*100/percent)/100+'%'}}}
for(let i=0;i<this.columns.length;i++){let col=this.columns[i]
if(col.hidden)continue
if(col.sizeType=='%'){if(this.columns[i].sizeCorrected!=null){this.columns[i].sizeCalculated=Math.floor(width_max*parseFloat(col.sizeCorrected)/100)-1+'px'}else{this.columns[i].sizeCalculated=Math.floor(width_max*parseFloat(col.size)/100)-1+'px'}}}}
let width_cols=0
for(let i=0;i<this.columns.length;i++){let col=this.columns[i]
if(col.hidden)continue
if(col.min==null)col.min=20
if(parseInt(col.sizeCalculated)<parseInt(col.min))col.sizeCalculated=col.min+'px'
if(parseInt(col.sizeCalculated)>parseInt(col.max))col.sizeCalculated=col.max+'px'
width_cols+=parseInt(col.sizeCalculated)}
let width_diff=parseInt(width_box)-parseInt(width_cols)
if(width_diff>0&&percent>0){let i=0
while(true){let col=this.columns[i]
if(col==null){i=0;continue}
if(col.hidden||col.sizeType=='px'){i++;continue}
col.sizeCalculated=(parseInt(col.sizeCalculated)+1)+'px'
width_diff--
if(width_diff===0)break
i++}}else if(width_diff>0){columns.find(':scope > table > tbody > tr:nth-child(1) td.w2ui-head-last').css('width',w2utils.scrollBarSize()+'px').show()}
let fwidth=1
if(this.show.lineNumbers)fwidth+=lineNumberWidth
if(this.show.selectColumn)fwidth+=26
if(this.show.expandColumn)fwidth+=26
for(let i=0;i<this.columns.length;i++){if(this.columns[i].hidden)continue
if(this.columns[i].frozen)fwidth+=parseInt(this.columns[i].sizeCalculated)}
fcolumns.css('width',fwidth+'px')
frecords.css('width',fwidth+'px')
fsummary.css('width',fwidth+'px')
scroll1.css('width',fwidth+'px')
columns.css('left',(fwidth+0.5)+'px')
records.css('left',fwidth+'px')
summary.css('left',fwidth+'px')
columns.find(':scope > table > tbody > tr:nth-child(1) td').add(fcolumns.find(':scope > table > tbody > tr:nth-child(1) td')).each(el=>{if(query(el).hasClass('w2ui-col-number')){query(el).css('width',lineNumberWidth+'px')}
let ind=query(el).attr('col')
if(ind!=null){if(ind=='start'){let width=0
for(let i=0;i<obj.last.vscroll.colIndStart;i++){if(!obj.columns[i]||obj.columns[i].frozen||obj.columns[i].hidden)continue
width+=parseInt(obj.columns[i].sizeCalculated)}
query(el).css('width',width+'px')}
if(obj.columns[ind])query(el).css('width',obj.columns[ind].sizeCalculated)}
if(query(el).hasClass('w2ui-head-last')){if(obj.last.vscroll.colIndEnd+1<obj.columns.length){let width=0
for(let i=obj.last.vscroll.colIndEnd+1;i<obj.columns.length;i++){if(!obj.columns[i]||obj.columns[i].frozen||obj.columns[i].hidden)continue
width+=parseInt(obj.columns[i].sizeCalculated)}
query(el).css('width',width+'px')}else{query(el).css('width',w2utils.scrollBarSize()+(width_diff>0&&percent===0?width_diff:0)+'px')}}})
if(columns.find(':scope > table > tbody > tr').length==3){columns.find(':scope > table > tbody > tr:nth-child(1) td').add(fcolumns.find(':scope > table > tbody > tr:nth-child(1) td')).html('').css({'height':'0','border':'0','padding':'0','margin':'0'})}
records.find(':scope > table > tbody > tr:nth-child(1) td').add(frecords.find(':scope > table > tbody > tr:nth-child(1) td')).each(el=>{if(query(el).hasClass('w2ui-col-number')){query(el).css('width',lineNumberWidth+'px')}
let ind=query(el).attr('col')
if(ind!=null){if(ind=='start'){let width=0
for(let i=0;i<obj.last.vscroll.colIndStart;i++){if(!obj.columns[i]||obj.columns[i].frozen||obj.columns[i].hidden)continue
width+=parseInt(obj.columns[i].sizeCalculated)}
query(el).css('width',width+'px')}
if(obj.columns[ind])query(el).css('width',obj.columns[ind].sizeCalculated)}
if(query(el).hasClass('w2ui-grid-data-last')&&query(el).parents('.w2ui-grid-frecords').length===0){if(obj.last.vscroll.colIndEnd+1<obj.columns.length){let width=0
for(let i=obj.last.vscroll.colIndEnd+1;i<obj.columns.length;i++){if(!obj.columns[i]||obj.columns[i].frozen||obj.columns[i].hidden)continue
width+=parseInt(obj.columns[i].sizeCalculated)}
query(el).css('width',width+'px')}else{query(el).css('width',(width_diff>0&&percent===0?width_diff:0)+'px')}}})
summary.find(':scope > table > tbody > tr:nth-child(1) td').add(fsummary.find(':scope > table > tbody > tr:nth-child(1) td')).each(el=>{if(query(el).hasClass('w2ui-col-number')){query(el).css('width',lineNumberWidth+'px')}
let ind=query(el).attr('col')
if(ind!=null){if(ind=='start'){let width=0
for(let i=0;i<obj.last.vscroll.colIndStart;i++){if(!obj.columns[i]||obj.columns[i].frozen||obj.columns[i].hidden)continue
width+=parseInt(obj.columns[i].sizeCalculated)}
query(el).css('width',width+'px')}
if(obj.columns[ind])query(el).css('width',obj.columns[ind].sizeCalculated)}
if(query(el).hasClass('w2ui-grid-data-last')&&query(el).parents('.w2ui-grid-frecords').length===0){query(el).css('width',w2utils.scrollBarSize()+(width_diff>0&&percent===0?width_diff:0)+'px')}})
this.initResize()
this.refreshRanges()
if((this.last.vscroll.scrollTop||this.last.vscroll.scrollLeft)&&records.length>0){columns.prop('scrollLeft',this.last.vscroll.scrollLeft)
records.prop('scrollTop',this.last.vscroll.scrollTop)
records.prop('scrollLeft',this.last.vscroll.scrollLeft)}
columns.css('will-change','scroll-position')}
getSearchesHTML(){let html=`
            <div class="search-title">
                ${w2utils.lang('Advanced Search')}
                <span class="search-logic" style="${this.show.searchLogic ? '' : 'display: none'}">
                    <select id="grid_${this.name}_logic" class="w2ui-input">
                        <option value="AND" ${this.last.logic == 'AND' ? 'selected' : ''}>${w2utils.lang('All')}</option>
                        <option value="OR" ${this.last.logic == 'OR' ? 'selected' : ''}>${w2utils.lang('Any')}</option>
                    </select>
                </span>
            </div>
            <table cellspacing="0"><tbody>
        `
for(let i=0;i<this.searches.length;i++){let s=this.searches[i]
s.type=String(s.type).toLowerCase()
if(s.hidden)continue
if(s.attr==null)s.attr=''
if(s.text==null)s.text=''
if(s.style==null)s.style=''
if(s.type==null)s.type='text'
if(s.label==null&&s.caption!=null){console.log('NOTICE: grid search.caption property is deprecated, please use search.label. Search ->',s)
s.label=s.caption}
let operator=`<select id="grid_${this.name}_operator_${i}" class="w2ui-input" data-change="initOperator|${i}">
                    ${this.getOperators(s.type, s.operators)}
                </select>`
html+=`<tr>
                        <td class="caption">${(w2utils.lang(s.label ?? s.field) || '')}</td>
                        <td class="operator">${operator}</td>
                        <td class="value">`
let tmpStyle
switch(s.type){case'text':case'alphanumeric':case'hex':case'color':case'list':case'combo':case'enum':tmpStyle='width: 250px;'
if(['hex','color'].indexOf(s.type)!=-1)tmpStyle='width: 90px;'
html+=`<input rel="search" type="text" id="grid_${this.name}_field_${i}" name="${s.field}"
                               class="w2ui-input" style="${tmpStyle + s.style}" ${s.attr}>`
break
case'int':case'float':case'money':case'currency':case'percent':case'date':case'time':case'datetime':tmpStyle='width: 90px;'
if(s.type=='datetime')tmpStyle='width: 140px;'
html+=`<input id="grid_${this.name}_field_${i}" name="${s.field}" ${s.attr} rel="search" type="text"
                                class="w2ui-input" style="${tmpStyle + s.style}">
                            <span id="grid_${this.name}_range_${i}" style="display: none">&#160;-&#160;&#160;
                                <input rel="search" type="text" class="w2ui-input" style="${tmpStyle + s.style}" id="grid_${this.name}_field2_${i}" name="${s.field}" ${s.attr}>
                            </span>`
break
case'select':html+=`<select rel="search" class="w2ui-input" style="${s.style}" id="grid_${this.name}_field_${i}"
                                name="${s.field}" ${s.attr}></select>`
break}
html+=s.text+'    </td>'+'</tr>'}
html+=`<tr>
            <td colspan="2" class="actions">
                <button type="button" class="w2ui-btn close-btn" data-click="searchClose">${w2utils.lang('Close')}</button>
            </td>
            <td class="actions">
                <button type="button" class="w2ui-btn" data-click="searchReset">${w2utils.lang('Reset')}</button>
                <button type="button" class="w2ui-btn w2ui-btn-blue" data-click="search">${w2utils.lang('Search')}</button>
            </td>
        </tr></tbody></table>`
return html}
getOperators(type,opers){let operators=this.operators[this.operatorsMap[type]]||[]
if(opers!=null&&Array.isArray(opers)){operators=opers}
let html=''
operators.forEach(oper=>{let displayText=oper
let operValue=oper
if(Array.isArray(oper)){displayText=oper[1]
operValue=oper[0]}else if(w2utils.isPlainObject(oper)){displayText=oper.text
operValue=oper.oper}
if(displayText==null)displayText=oper
html+=`<option name="11" value="${operValue}">${w2utils.lang(displayText)}</option>\n`})
return html}
initOperator(ind){let options
let search=this.searches[ind]
let sdata=this.getSearchData(search.field)
let overlay=query(`#w2overlay-${this.name}-search-overlay`)
let $rng=overlay.find(`#grid_${this.name}_range_${ind}`)
let $fld1=overlay.find(`#grid_${this.name}_field_${ind}`)
let $fld2=overlay.find(`#grid_${this.name}_field2_${ind}`)
let $oper=overlay.find(`#grid_${this.name}_operator_${ind}`)
let oper=$oper.val()
$fld1.show()
$rng.hide()
switch(oper){case'between':$rng.css('display','inline')
break
case'null':case'not null':$fld1.hide()
$fld1.val(oper)
$fld1.trigger('change')
break}
switch(search.type){case'text':case'alphanumeric':let fld=$fld1[0]._w2field
if(fld){fld.reset()}
break
case'int':case'float':case'hex':case'color':case'money':case'currency':case'percent':case'date':case'time':case'datetime':if(!$fld1[0]._w2field){new w2field(search.type,{el:$fld1[0],...search.options})
new w2field(search.type,{el:$fld2[0],...search.options})
setTimeout(()=>{$fld1.trigger('keydown')
$fld2.trigger('keydown')},1)}
break
case'list':case'combo':case'enum':options=search.options
if(search.type=='list')options.selected={}
if(search.type=='enum')options.selected=[]
if(sdata)options.selected=sdata.value
if(!$fld1[0]._w2field){let fld=new w2field(search.type,{el:$fld1[0],...options})
if(sdata&&sdata.text!=null){fld.set({id:sdata.value,text:sdata.text})}}
break
case'select':options='<option value="">--</option>'
for(let i=0;i<search.options.items.length;i++){let si=search.options.items[i]
if(w2utils.isPlainObject(search.options.items[i])){let val=si.id
let txt=si.text
if(val==null&&si.value!=null)val=si.value
if(txt==null&&si.text!=null)txt=si.text
if(val==null)val=''
options+='<option value="'+val+'">'+txt+'</option>'}else{options+='<option value="'+si+'">'+si+'</option>'}}
$fld1.html(options)
break}}
initSearches(){let overlay=query(`#w2overlay-${this.name}-search-overlay`)
for(let ind=0;ind<this.searches.length;ind++){let search=this.searches[ind]
let sdata=this.getSearchData(search.field)
search.type=String(search.type).toLowerCase()
if(typeof search.options!='object')search.options={}
let operator=search.operator
let operators=[...this.operators[this.operatorsMap[search.type]]]||[]
if(search.operators)operators=search.operators
if(w2utils.isPlainObject(operator))operator=operator.oper
operators.forEach((oper,ind)=>{if(w2utils.isPlainObject(oper))operators[ind]=oper.oper})
if(sdata&&sdata.operator){operator=sdata.operator}
let def=this.defaultOperator[this.operatorsMap[search.type]]
if(operators.indexOf(operator)==-1){operator=def}
overlay.find(`#grid_${this.name}_operator_${ind}`).val(operator)
this.initOperator(ind)
let $fld1=overlay.find(`#grid_${this.name}_field_${ind}`)
let $fld2=overlay.find(`#grid_${this.name}_field2_${ind}`)
if(sdata!=null){if(!Array.isArray(sdata.value)){if(sdata.value!=null)$fld1.val(sdata.value).trigger('change')}else{if(['in','not in'].includes(sdata.operator)){$fld1[0]._w2field.set(sdata.value)}else{$fld1.val(sdata.value[0]).trigger('change')
$fld2.val(sdata.value[1]).trigger('change')}}}}
overlay.find('.w2ui-grid-search-advanced *[rel=search]').on('keypress',evnt=>{if(evnt.keyCode==13){this.search()
w2tooltip.hide(this.name+'-search-overlay')}})}
getColumnsHTML(){let self=this
let html1=''
let html2=''
if(this.show.columnHeaders){if(this.columnGroups.length>0){let tmp1=getColumns(true)
let tmp2=getGroups()
let tmp3=getColumns(false)
html1=tmp1[0]+tmp2[0]+tmp3[0]
html2=tmp1[1]+tmp2[1]+tmp3[1]}else{let tmp=getColumns(true)
html1=tmp[0]
html2=tmp[1]}}
return[html1,html2]
function getGroups(){let html1='<tr>'
let html2='<tr>'
let tmpf=''
let tmp=self.columnGroups.length-1
if(self.columnGroups[tmp].text==null&&self.columnGroups[tmp].caption!=null){console.log('NOTICE: grid columnGroup.caption property is deprecated, please use columnGroup.text. Group -> ',self.columnGroups[tmp])
self.columnGroups[tmp].text=self.columnGroups[tmp].caption}
if(self.columnGroups[self.columnGroups.length-1].text!='')self.columnGroups.push({text:''})
if(self.show.lineNumbers){html1+='<td class="w2ui-head w2ui-col-number" col="line-number">'+'    <div>&#160;</div>'+'</td>'}
if(self.show.selectColumn){html1+='<td class="w2ui-head w2ui-col-select" col="select">'+'    <div style="height: 25px">&#160;</div>'+'</td>'}
if(self.show.expandColumn){html1+='<td class="w2ui-head w2ui-col-expand" col="expand">'+'    <div style="height: 25px">&#160;</div>'+'</td>'}
let ii=0
html2+=`<td id="grid_${self.name}_column_start" class="w2ui-head" col="start" style="border-right: 0"></td>`
if(self.reorderRows){html2+='<td class="w2ui-head w2ui-col-order" col="order">'+'    <div style="height: 25px">&#160;</div>'+'</td>'}
for(let i=0;i<self.columnGroups.length;i++){let colg=self.columnGroups[i]
let col=self.columns[ii]||{}
if(colg.colspan!=null)colg.span=colg.colspan
if(colg.span==null||colg.span!=parseInt(colg.span))colg.span=1
if(col.text==null&&col.caption!=null){console.log('NOTICE: grid column.caption property is deprecated, please use column.text. Column ->',col)
col.text=col.caption}
let colspan=0
for(let jj=ii;jj<ii+colg.span;jj++){if(self.columns[jj]&&!self.columns[jj].hidden){colspan++}}
if(i==self.columnGroups.length-1){colspan=100}
if(colspan<=0){}else if(colg.main===true){let sortStyle=''
for(let si=0;si<self.sortData.length;si++){if(self.sortData[si].field==col.field){if((self.sortData[si].direction||'').toLowerCase()==='asc')sortStyle='w2ui-sort-up'
if((self.sortData[si].direction||'').toLowerCase()==='desc')sortStyle='w2ui-sort-down'}}
let resizer=''
if(col.resizable!==false){resizer=`<div class="w2ui-resizer" name="${ii}"></div>`}
let text=w2utils.lang(typeof col.text=='function'?col.text(col):col.text)
tmpf=`<td id="grid_${self.name}_column_${ii}" class="w2ui-head ${sortStyle}" col="${ii}" `+`    rowspan="2" colspan="${colspan}">`+resizer+`    <div class="w2ui-col-group w2ui-col-header ${sortStyle ? 'w2ui-col-sorted' : ''}">`+`        <div class="${sortStyle}"></div>`+(!text?'&#160;':text)+'    </div>'+'</td>'
if(col&&col.frozen)html1+=tmpf;else html2+=tmpf}else{let gText=w2utils.lang(typeof colg.text=='function'?colg.text(colg):colg.text)
tmpf=`<td id="grid_${self.name}_column_${ii}" class="w2ui-head" col="${ii}" colspan="${colspan}">`+`    <div class="w2ui-col-group" style="${colg.style ?? ''}">${!gText ? '&#160;' : gText}</div>`+'</td>'
if(col&&col.frozen)html1+=tmpf;else html2+=tmpf}
ii+=colg.span}
html1+='<td></td></tr>'
html2+=`<td id="grid_${self.name}_column_end" class="w2ui-head" col="end"></td></tr>`
return[html1,html2]}
function getColumns(main){let html1='<tr>'
let html2='<tr>'
if(self.show.lineNumbers){html1+='<td class="w2ui-head w2ui-col-number" col="line-number">'+'    <div>#</div>'+'</td>'}
if(self.show.selectColumn){html1+='<td class="w2ui-head w2ui-col-select" col="select">'+'    <div>'+`        <input type="checkbox" id="grid_${self.name}_check_all" class="w2ui-select-all" tabindex="-1"`+`            style="${self.multiSelect == false ? 'display: none;' : ''}"`+'        >'+'    </div>'+'</td>'}
if(self.show.expandColumn){html1+='<td class="w2ui-head w2ui-col-expand" col="expand">'+'    <div>&#160;</div>'+'</td>'}
let ii=0
let id=0
let colg
html2+=`<td id="grid_${self.name}_column_start" class="w2ui-head" col="start" style="border-right: 0"></td>`
if(self.reorderRows){html2+='<td class="w2ui-head w2ui-col-order" col="order">'+'    <div>&#160;</div>'+'</td>'}
for(let i=0;i<self.columns.length;i++){let col=self.columns[i]
if(col.text==null&&col.caption!=null){console.log('NOTICE: grid column.caption property is deprecated, please use column.text. Column -> ',col)
col.text=col.caption}
if(col.size==null)col.size='100%'
if(i==id){colg=self.columnGroups[ii++]||{}
id=id+colg.span}
if((i<self.last.vscroll.colIndStart||i>self.last.vscroll.colIndEnd)&&!col.frozen)
continue
if(col.hidden)
continue
if(colg.main!==true||main){let colCellHTML=self.getColumnCellHTML(i)
if(col&&col.frozen)html1+=colCellHTML;else html2+=colCellHTML}}
html1+='<td class="w2ui-head w2ui-head-last"><div>&#160;</div></td>'
html2+='<td class="w2ui-head w2ui-head-last" col="end"><div>&#160;</div></td>'
html1+='</tr>'
html2+='</tr>'
return[html1,html2]}}
getColumnCellHTML(i){let col=this.columns[i]
if(col==null)return''
let reorderCols=(this.reorderColumns&&(!this.columnGroups||!this.columnGroups.length))?' w2ui-col-reorderable ':''
let sortStyle=''
for(let si=0;si<this.sortData.length;si++){if(this.sortData[si].field==col.field){if((this.sortData[si].direction||'').toLowerCase()==='asc')sortStyle='w2ui-sort-up'
if((this.sortData[si].direction||'').toLowerCase()==='desc')sortStyle='w2ui-sort-down'}}
let tmp=this.last.selection.columns
let selected=false
for(let t in tmp){for(let si=0;si<tmp[t].length;si++){if(tmp[t][si]==i)selected=true}}
let text=w2utils.lang(typeof col.text=='function'?col.text(col):col.text)
let html='<td id="grid_'+this.name+'_column_'+i+'" col="'+i+'" class="w2ui-head '+sortStyle+reorderCols+'">'+
(col.resizable!==false?'<div class="w2ui-resizer" name="'+i+'"></div>':'')+'    <div class="w2ui-col-header '+(sortStyle?'w2ui-col-sorted':'')+' '+(selected?'w2ui-col-selected':'')+'">'+'        <div class="'+sortStyle+'"></div>'+
(!text?'&#160;':text)+'    </div>'+'</td>'
return html}
columnTooltipShow(ind,event){let $el=query(this.box).find('#grid_'+this.name+'_column_'+ind)
let item=this.columns[ind]
let pos=this.columnTooltip
w2tooltip.show({name:this.name+'-column-tooltip',anchor:$el.get(0),html:item?.tooltip,position:pos,})}
columnTooltipHide(ind,event){w2tooltip.hide(this.name+'-column-tooltip')}
getRecordsHTML(){let buffered=this.records.length
let url=(typeof this.url!='object'?this.url:this.url.get)
if(this.searchData.length!=0&&!url)buffered=this.last.searchIds.length
if(buffered>this.vs_start)this.last.vscroll.show_extra=this.vs_extra;else this.last.vscroll.show_extra=this.vs_start
let records=query(this.box).find(`#grid_${this.name}_records`)
let limit=Math.floor((records.get(0)?.clientHeight||0)/this.recordHeight)+this.last.vscroll.show_extra+1
if(limit<this.vs_start){limit=this.vs_start}
if(!this.fixedBody||limit>buffered)limit=buffered
let rec_html=this.getRecordHTML(-1,0)
let html1='<table><tbody>'+rec_html[0]
let html2='<table><tbody>'+rec_html[1]
html1+='<tr id="grid_'+this.name+'_frec_top" line="top" style="height: '+0+'px">'+'    <td colspan="2000"></td>'+'</tr>'
html2+='<tr id="grid_'+this.name+'_rec_top" line="top" style="height: '+0+'px">'+'    <td colspan="2000"></td>'+'</tr>'
for(let i=0;i<limit;i++){rec_html=this.getRecordHTML(i,i+1)
html1+=rec_html[0]
html2+=rec_html[1]}
let h2=(buffered-limit)*this.recordHeight
html1+='<tr id="grid_'+this.name+'_frec_bottom" rec="bottom" line="bottom" style="height: '+h2+'px; vertical-align: top">'+'    <td colspan="2000" style="border: 0"></td>'+'</tr>'+'<tr id="grid_'+this.name+'_frec_more" style="display: none; ">'+'    <td colspan="2000" class="w2ui-load-more"></td>'+'</tr>'+'</tbody></table>'
html2+='<tr id="grid_'+this.name+'_rec_bottom" rec="bottom" line="bottom" style="height: '+h2+'px; vertical-align: top">'+'    <td colspan="2000" style="border: 0"></td>'+'</tr>'+'<tr id="grid_'+this.name+'_rec_more" style="display: none">'+'    <td colspan="2000" class="w2ui-load-more"></td>'+'</tr>'+'</tbody></table>'
this.last.vscroll.recIndStart=0
this.last.vscroll.recIndEnd=limit
return[html1,html2]}
getSummaryHTML(){if(this.summary.length===0)return
let rec_html=this.getRecordHTML(-1,0)
let html1='<table><tbody>'+rec_html[0]
let html2='<table><tbody>'+rec_html[1]
for(let i=0;i<this.summary.length;i++){rec_html=this.getRecordHTML(i,i+1,true)
html1+=rec_html[0]
html2+=rec_html[1]}
html1+='</tbody></table>'
html2+='</tbody></table>'
return[html1,html2]}
scroll(event){let obj=this
let url=(typeof this.url!='object'?this.url:this.url.get)
let records=query(this.box).find(`#grid_${this.name}_records`)
let frecords=query(this.box).find(`#grid_${this.name}_frecords`)
if(event){let sTop=event.target.scrollTop
let sLeft=event.target.scrollLeft
this.last.vscroll.scrollTop=sTop
this.last.vscroll.scrollLeft=sLeft
let cols=query(this.box).find(`#grid_${this.name}_columns`)[0]
let summary=query(this.box).find(`#grid_${this.name}_summary`)[0]
if(cols)cols.scrollLeft=sLeft
if(summary)summary.scrollLeft=sLeft
if(frecords[0])frecords[0].scrollTop=sTop}
if(this.last.bubbleEl){w2tooltip.hide(this.name+'-bubble')
this.last.bubbleEl=null}
let colStart=null
let colEnd=null
if(this.disableCVS||this.columnGroups.length>0){colStart=0
colEnd=this.columns.length-1}else{let sWidth=records.prop('clientWidth')
let cLeft=0
for(let i=0;i<this.columns.length;i++){if(this.columns[i].frozen||this.columns[i].hidden)continue
let cSize=parseInt(this.columns[i].sizeCalculated?this.columns[i].sizeCalculated:this.columns[i].size)
if(cLeft+cSize+30>this.last.vscroll.scrollLeft&&colStart==null)colStart=i
if(cLeft+cSize-30>this.last.vscroll.scrollLeft+sWidth&&colEnd==null)colEnd=i
cLeft+=cSize}
if(colEnd==null)colEnd=this.columns.length-1}
if(colStart!=null){if(colStart<0)colStart=0
if(colEnd<0)colEnd=0
if(colStart==colEnd){if(colStart>0)colStart--;else colEnd++}
if(colStart!=this.last.vscroll.colIndStart||colEnd!=this.last.vscroll.colIndEnd){let $box=query(this.box)
let deltaStart=Math.abs(colStart-this.last.vscroll.colIndStart)
let deltaEnd=Math.abs(colEnd-this.last.vscroll.colIndEnd)
if(deltaStart<5&&deltaEnd<5){let $cfirst=$box.find(`.w2ui-grid-columns #grid_${this.name}_column_start`)
let $clast=$box.find('.w2ui-grid-columns .w2ui-head-last')
let $rfirst=$box.find(`#grid_${this.name}_records .w2ui-grid-data-spacer`)
let $rlast=$box.find(`#grid_${this.name}_records .w2ui-grid-data-last`)
let $sfirst=$box.find(`#grid_${this.name}_summary .w2ui-grid-data-spacer`)
let $slast=$box.find(`#grid_${this.name}_summary .w2ui-grid-data-last`)
if(colStart>this.last.vscroll.colIndStart){for(let i=this.last.vscroll.colIndStart;i<colStart;i++){$box.find('#grid_'+this.name+'_columns #grid_'+this.name+'_column_'+i).remove()
$box.find('#grid_'+this.name+'_records td[col="'+i+'"]').remove()
$box.find('#grid_'+this.name+'_summary td[col="'+i+'"]').remove()}}
if(colEnd<this.last.vscroll.colIndEnd){for(let i=this.last.vscroll.colIndEnd;i>colEnd;i--){$box.find('#grid_'+this.name+'_columns #grid_'+this.name+'_column_'+i).remove()
$box.find('#grid_'+this.name+'_records td[col="'+i+'"]').remove()
$box.find('#grid_'+this.name+'_summary td[col="'+i+'"]').remove()}}
if(colStart<this.last.vscroll.colIndStart){for(let i=this.last.vscroll.colIndStart-1;i>=colStart;i--){if(this.columns[i]&&(this.columns[i].frozen||this.columns[i].hidden))continue
$cfirst.after(this.getColumnCellHTML(i))
$rfirst.each(el=>{let index=query(el).parent().attr('index')
let td='<td class="w2ui-grid-data" col="'+i+'" style="height: 0px"></td>'
if(index!=null)td=this.getCellHTML(parseInt(index),i,false)
query(el).after(td)})
$sfirst.each(el=>{let index=query(el).parent().attr('index')
let td='<td class="w2ui-grid-data" col="'+i+'" style="height: 0px"></td>'
if(index!=null)td=this.getCellHTML(parseInt(index),i,true)
query(el).after(td)})}}
if(colEnd>this.last.vscroll.colIndEnd){for(let i=this.last.vscroll.colIndEnd+1;i<=colEnd;i++){if(this.columns[i]&&(this.columns[i].frozen||this.columns[i].hidden))continue
$clast.before(this.getColumnCellHTML(i))
$rlast.each(el=>{let index=query(el).parent().attr('index')
let td='<td class="w2ui-grid-data" col="'+i+'" style="height: 0px"></td>'
if(index!=null)td=this.getCellHTML(parseInt(index),i,false)
query(el).before(td)})
$slast.each(el=>{let index=query(el).parent().attr('index')||-1
let td=this.getCellHTML(parseInt(index),i,true)
query(el).before(td)})}}
this.last.vscroll.colIndStart=colStart
this.last.vscroll.colIndEnd=colEnd
this.resizeRecords()}else{this.last.vscroll.colIndStart=colStart
this.last.vscroll.colIndEnd=colEnd
let colHTML=this.getColumnsHTML()
let recHTML=this.getRecordsHTML()
let sumHTML=this.getSummaryHTML()
let $columns=$box.find(`#grid_${this.name}_columns`)
let $records=$box.find(`#grid_${this.name}_records`)
let $frecords=$box.find(`#grid_${this.name}_frecords`)
let $summary=$box.find(`#grid_${this.name}_summary`)
$columns.find('tbody').html(colHTML[1])
$frecords.html(recHTML[0])
$records.prepend(recHTML[1])
if(sumHTML!=null)$summary.html(sumHTML[1])
setTimeout(()=>{$records.find(':scope > table').filter(':not(table:first-child)').remove()
if($summary[0])$summary[0].scrollLeft=this.last.vscroll.scrollLeft},1)
this.resizeRecords()}}}
let buffered=this.records.length
if(buffered>this.total&&this.total!==-1)buffered=this.total
if(this.searchData.length!=0&&!url)buffered=this.last.searchIds.length
if(buffered===0||records.length===0||records.prop('clientHeight')===0)return
if(buffered>this.vs_start)this.last.vscroll.show_extra=this.vs_extra;else this.last.vscroll.show_extra=this.vs_start
let t1=Math.round(records.prop('scrollTop')/this.recordHeight+1)
let t2=t1+(Math.round(records.prop('clientHeight')/this.recordHeight)-1)
if(t1>buffered)t1=buffered
if(t2>=buffered-1)t2=buffered
query(this.box).find('#grid_'+this.name+'_footer .w2ui-footer-right').html((this.show.statusRange?w2utils.formatNumber(this.offset+t1)+'-'+w2utils.formatNumber(this.offset+t2)+
(this.total!=-1?' '+w2utils.lang('of')+' <span class="w2ui-total">'+w2utils.formatNumber(this.total)+'</span>':''):'')+
(url&&this.show.statusBuffered?' ('+w2utils.lang('buffered')+' <span class="w2ui-buffered">'+w2utils.formatNumber(buffered)+'</span>'+
(this.offset>0?', skip <span class="w2ui-skip">'+w2utils.formatNumber(this.offset):'')+'</span>)':''))
if(!url&&(!this.fixedBody||(this.total!=-1&&this.total<=this.vs_start)))return
let start=Math.floor(records.prop('scrollTop')/this.recordHeight)-this.last.vscroll.show_extra
let end=start+Math.floor(records.prop('clientHeight')/this.recordHeight)+this.last.vscroll.show_extra*2+1
if(start<1)start=1
if(end>this.total&&this.total!=-1)end=this.total
let tr1=records.find('#grid_'+this.name+'_rec_top')
let tr2=records.find('#grid_'+this.name+'_rec_bottom')
let tr1f=frecords.find('#grid_'+this.name+'_frec_top')
let tr2f=frecords.find('#grid_'+this.name+'_frec_bottom')
if(String(tr1.next().prop('id')).indexOf('_expanded_row')!=-1){tr1.next().remove()
tr1f.next().remove()}
if(this.total>end&&String(tr2.prev().prop('id')).indexOf('_expanded_row')!=-1){tr2.prev().remove()
tr2f.prev().remove()}
let first=parseInt(tr1.next().attr('line'))
let last=parseInt(tr2.prev().attr('line'))
let tmp,tmp1,tmp2,rec_start,rec_html
if(first<=start||first==1||this.last.vscroll.pull_refresh){if(end<=last+this.last.vscroll.show_extra-2&&end!=this.total)return
this.last.vscroll.pull_refresh=false
while(true){tmp1=frecords.find('#grid_'+this.name+'_frec_top').next()
tmp2=records.find('#grid_'+this.name+'_rec_top').next()
if(tmp2.attr('line')=='bottom')break
if(parseInt(tmp2.attr('line'))<start){tmp1.remove()
tmp2.remove()}else{break}}
tmp=records.find('#grid_'+this.name+'_rec_bottom').prev()
rec_start=tmp.attr('line')
if(rec_start=='top')rec_start=start
for(let i=parseInt(rec_start)+1;i<=end;i++){if(!this.records[i-1])continue
tmp2=this.records[i-1].w2ui
if(tmp2&&!Array.isArray(tmp2.children)){tmp2.expanded=false}
rec_html=this.getRecordHTML(i-1,i)
tr2.before(rec_html[1])
tr2f.before(rec_html[0])}
markSearch()
setTimeout(()=>{this.refreshRanges()},0)}else{if(start>=first-this.last.vscroll.show_extra+2&&start>1)return
while(true){tmp1=frecords.find('#grid_'+this.name+'_frec_bottom').prev()
tmp2=records.find('#grid_'+this.name+'_rec_bottom').prev()
if(tmp2.attr('line')=='top')break
if(parseInt(tmp2.attr('line'))>end){tmp1.remove()
tmp2.remove()}else{break}}
tmp=records.find('#grid_'+this.name+'_rec_top').next()
rec_start=tmp.attr('line')
if(rec_start=='bottom')rec_start=end
for(let i=parseInt(rec_start)-1;i>=start;i--){if(!this.records[i-1])continue
tmp2=this.records[i-1].w2ui
if(tmp2&&!Array.isArray(tmp2.children)){tmp2.expanded=false}
rec_html=this.getRecordHTML(i-1,i)
tr1.after(rec_html[1])
tr1f.after(rec_html[0])}
markSearch()
setTimeout(()=>{this.refreshRanges()},0)}
let h1=(start-1)*this.recordHeight
let h2=(buffered-end)*this.recordHeight
if(h2<0)h2=0
tr1.css('height',h1+'px')
tr1f.css('height',h1+'px')
tr2.css('height',h2+'px')
tr2f.css('height',h2+'px')
this.last.vscroll.recIndStart=start
this.last.vscroll.recIndEnd=end
let s=Math.floor(records.prop('scrollTop')/this.recordHeight)
let e=s+Math.floor(records.prop('clientHeight')/this.recordHeight)
if(e+10>buffered&&this.last.vscroll.pull_more!==true&&(buffered<this.total-this.offset||(this.total==-1&&this.last.fetch.hasMore))){if(this.autoLoad===true){this.last.vscroll.pull_more=true
this.last.fetch.offset+=this.limit
this.request('load')}
let more=query(this.box).find('#grid_'+this.name+'_rec_more, #grid_'+this.name+'_frec_more')
more.show().eq(1).off('.load-more').on('click.load-more',function(){query(this).find('td').html('<div><div style="width: 20px; height: 20px;" class="w2ui-spinner"></div></div>')
obj.last.vscroll.pull_more=true
obj.last.fetch.offset+=obj.limit
obj.request('load')}).find('td').html(obj.autoLoad?'<div><div style="width: 20px; height: 20px;" class="w2ui-spinner"></div></div>':'<div style="padding-top: 15px">'+w2utils.lang('Load ${count} more...',{count:obj.limit})+'</div>')}
function markSearch(){if(!obj.markSearch)return
clearTimeout(obj.last.marker_timer)
obj.last.marker_timer=setTimeout(()=>{let search=[]
for(let s=0;s<obj.searchData.length;s++){let sdata=obj.searchData[s]
let fld=obj.getSearch(sdata.field)
if(!fld||fld.hidden)continue
let ind=obj.getColumn(sdata.field,true)
search.push({field:sdata.field,search:sdata.value,col:ind})}
if(search.length>0){search.forEach((item)=>{let el=query(obj.box).find('td[col="'+item.col+'"]:not(.w2ui-head)')
w2utils.marker(el,item.search)})}},50)}}
getRecordHTML(ind,lineNum,summary){let tmph=''
let rec_html1=''
let rec_html2=''
let sel=this.last.selection
let record
if(ind==-1){rec_html1+='<tr line="0">'
rec_html2+='<tr line="0">'
if(this.show.lineNumbers)rec_html1+='<td class="w2ui-col-number" style="height: 0px"></td>'
if(this.show.selectColumn)rec_html1+='<td class="w2ui-col-select" style="height: 0px"></td>'
if(this.show.expandColumn)rec_html1+='<td class="w2ui-col-expand" style="height: 0px"></td>'
rec_html2+='<td class="w2ui-grid-data w2ui-grid-data-spacer" col="start" style="height: 0px; width: 0px"></td>'
if(this.reorderRows)rec_html2+='<td class="w2ui-col-order" style="height: 0px"></td>'
for(let i=0;i<this.columns.length;i++){let col=this.columns[i]
tmph='<td class="w2ui-grid-data" col="'+i+'" style="height: 0px;"></td>'
if(col.frozen&&!col.hidden){rec_html1+=tmph}else{if(col.hidden||i<this.last.vscroll.colIndStart||i>this.last.vscroll.colIndEnd)continue
rec_html2+=tmph}}
rec_html1+='<td class="w2ui-grid-data-last" style="height: 0px"></td>'
rec_html2+='<td class="w2ui-grid-data-last" col="end" style="height: 0px"></td>'
rec_html1+='</tr>'
rec_html2+='</tr>'
return[rec_html1,rec_html2]}
let url=(typeof this.url!='object'?this.url:this.url.get)
if(summary!==true){if(this.searchData.length>0&&!url){if(ind>=this.last.searchIds.length)return''
ind=this.last.searchIds[ind]
record=this.records[ind]}else{if(ind>=this.records.length)return''
record=this.records[ind]}}else{if(ind>=this.summary.length)return''
record=this.summary[ind]}
if(!record)return''
if(record.recid==null&&this.recid!=null){let rid=this.parseField(record,this.recid)
if(rid!=null)record.recid=rid}
let isRowSelected=false
if(sel.indexes.indexOf(ind)!=-1)isRowSelected=true
let rec_style=(record.w2ui?record.w2ui.style:'')
if(rec_style==null||typeof rec_style!='string')rec_style=''
let rec_class=(record.w2ui?record.w2ui.class:'')
if(rec_class==null||typeof rec_class!='string')rec_class=''
rec_html1+='<tr id="grid_'+this.name+'_frec_'+record.recid+'" recid="'+record.recid+'" line="'+lineNum+'" index="'+ind+'" '+' class="'+(lineNum%2===0?'w2ui-even':'w2ui-odd')+' w2ui-record '+rec_class+
(isRowSelected&&this.selectType=='row'?' w2ui-selected':'')+
(record.w2ui&&record.w2ui.editable===false?' w2ui-no-edit':'')+
(record.w2ui&&record.w2ui.expanded===true?' w2ui-expanded':'')+'" '+' style="height: '+this.recordHeight+'px; '+(!isRowSelected&&rec_style!=''?rec_style:rec_style.replace('background-color','none'))+'" '+
(rec_style!=''?'custom_style="'+rec_style+'"':'')+'>'
rec_html2+='<tr id="grid_'+this.name+'_rec_'+record.recid+'" recid="'+record.recid+'" line="'+lineNum+'" index="'+ind+'" '+' class="'+(lineNum%2===0?'w2ui-even':'w2ui-odd')+' w2ui-record '+rec_class+
(isRowSelected&&this.selectType=='row'?' w2ui-selected':'')+
(record.w2ui&&record.w2ui.editable===false?' w2ui-no-edit':'')+
(record.w2ui&&record.w2ui.expanded===true?' w2ui-expanded':'')+'" '+' style="height: '+this.recordHeight+'px; '+(!isRowSelected&&rec_style!=''?rec_style:rec_style.replace('background-color','none'))+'" '+
(rec_style!=''?'custom_style="'+rec_style+'"':'')+'>'
if(this.show.lineNumbers){rec_html1+='<td id="grid_'+this.name+'_cell_'+ind+'_number'+(summary?'_s':'')+'" '+'   class="w2ui-col-number '+(isRowSelected?' w2ui-row-selected':'')+'"'+
(this.reorderRows?' style="cursor: move"':'')+'>'+
(summary!==true?this.getLineHTML(lineNum,record):'')+'</td>'}
if(this.show.selectColumn){rec_html1+='<td id="grid_'+this.name+'_cell_'+ind+'_select'+(summary?'_s':'')+'" class="w2ui-grid-data w2ui-col-select">'+
(summary!==true&&!(record.w2ui&&record.w2ui.hideCheckBox===true)?'    <div>'+'        <input class="w2ui-grid-select-check" type="checkbox" tabindex="-1" '+
(isRowSelected?'checked="checked"':'')+' style="pointer-events: none"/>'+'    </div>':'')+'</td>'}
if(this.show.expandColumn){let tmp_img=''
if(record.w2ui?.expanded===true)tmp_img='-';else tmp_img='+'
if((record.w2ui?.expanded=='none'||!Array.isArray(record.w2ui?.children)||!record.w2ui?.children.length))tmp_img='+'
if(record.w2ui?.expanded=='spinner')tmp_img='<div class="w2ui-spinner" style="width: 16px; margin: -2px 2px;"></div>'
rec_html1+='<td id="grid_'+this.name+'_cell_'+ind+'_expand'+(summary?'_s':'')+'" class="w2ui-grid-data w2ui-col-expand">'+
(summary!==true?`<div>${tmp_img}</div>`:'')+'</td>'}
rec_html2+='<td class="w2ui-grid-data-spacer" col="start" style="border-right: 0"></td>'
if(this.reorderRows){rec_html2+='<td id="grid_'+this.name+'_cell_'+ind+'_order'+(summary?'_s':'')+'" class="w2ui-grid-data w2ui-col-order" col="order">'+
(summary!==true?'<div title="Drag to reorder">&nbsp;</div>':'')+'</td>'}
let col_ind=0
let col_skip=0
while(true){let col_span=1
let col=this.columns[col_ind]
if(col==null)break
if(col.hidden){col_ind++
if(col_skip>0)col_skip--
continue}
if(col_skip>0){col_ind++
if(this.columns[col_ind]==null)break
record.w2ui.colspan[this.columns[col_ind-1].field]=0
col_skip--
continue}else if(record.w2ui){let tmp1=record.w2ui.colspan
let tmp2=this.columns[col_ind].field
if(tmp1&&tmp1[tmp2]===0){delete tmp1[tmp2]}}
if((col_ind<this.last.vscroll.colIndStart||col_ind>this.last.vscroll.colIndEnd)&&!col.frozen){col_ind++
continue}
if(record.w2ui){if(typeof record.w2ui.colspan=='object'){let span=parseInt(record.w2ui.colspan[col.field])||null
if(span>1){let hcnt=0
for(let i=col_ind;i<col_ind+span;i++){if(i>=this.columns.length)break
if(this.columns[i].hidden)hcnt++}
col_span=span-hcnt
col_skip=span-1}}}
let rec_cell=this.getCellHTML(ind,col_ind,summary,col_span)
if(col.frozen)rec_html1+=rec_cell;else rec_html2+=rec_cell
col_ind++}
rec_html1+='<td class="w2ui-grid-data-last"></td>'
rec_html2+='<td class="w2ui-grid-data-last" col="end"></td>'
rec_html1+='</tr>'
rec_html2+='</tr>'
return[rec_html1,rec_html2]}
getLineHTML(lineNum){return'<div>'+lineNum+'</div>'}
getCellHTML(ind,col_ind,summary,col_span){let obj=this
let col=this.columns[col_ind]
if(col==null)return''
let record=(summary!==true?this.records[ind]:this.summary[ind])
let{value,style,className,attr,divAttr}=this.getCellValue(ind,col_ind,summary,true)
let edit=(ind!==-1?this.getCellEditable(ind,col_ind):'')
let divStyle='max-height: '+parseInt(this.recordHeight)+'px;'+(col.clipboardCopy?'margin-right: 20px':'')
let isChanged=!summary&&record?.w2ui?.changes&&record.w2ui.changes[col.field]!=null
let sel=this.last.selection
let isRowSelected=false
let infoBubble=''
if(sel.indexes.indexOf(ind)!=-1)isRowSelected=true
if(col_span==null){if(record?.w2ui?.colspan&&record.w2ui.colspan[col.field]){col_span=record.w2ui.colspan[col.field]}else{col_span=1}}
if(col_ind===0&&Array.isArray(record?.w2ui?.children)){let level=0
let subrec=this.get(record.w2ui.parent_recid,true)
while(true){if(subrec!=null){level++
let tmp=this.records[subrec].w2ui
if(tmp!=null&&tmp.parent_recid!=null){subrec=this.get(tmp.parent_recid,true)}else{break}}else{break}}
if(record.w2ui.parent_recid){for(let i=0;i<level;i++){infoBubble+='<span class="w2ui-show-children w2ui-icon-empty"></span>'}}
let className=record.w2ui.children.length>0?(record.w2ui.expanded?'w2ui-icon-collapse':'w2ui-icon-expand'):'w2ui-icon-empty'
infoBubble+=`<span class="w2ui-show-children ${className}"></span>`}
if(col.info===true)col.info={}
if(col.info!=null){let infoIcon='w2ui-icon-info'
if(typeof col.info.icon=='function'){infoIcon=col.info.icon(record,{self:this,index:ind,colIndex:col_ind,summary:!!summary})}else if(typeof col.info.icon=='object'){infoIcon=col.info.icon[this.parseField(record,col.field)]||''}else if(typeof col.info.icon=='string'){infoIcon=col.info.icon}
let infoStyle=col.info.style||''
if(typeof col.info.style=='function'){infoStyle=col.info.style(record,{self:this,index:ind,colIndex:col_ind,summary:!!summary})}else if(typeof col.info.style=='object'){infoStyle=col.info.style[this.parseField(record,col.field)]||''}else if(typeof col.info.style=='string'){infoStyle=col.info.style}
infoBubble+=`<span class="w2ui-info ${infoIcon}" style="${infoStyle}"></span>`}
let data=value
if(edit&&['checkbox','check'].indexOf(edit.type)!=-1){let changeInd=summary?-(ind+1):ind
divStyle+='text-align: center;'
data=`<input tabindex="-1" type="checkbox" class="w2ui-editable-checkbox"
                            data-changeInd="${changeInd}" data-colInd="${col_ind}" ${data ? 'checked="checked"' : ''}>`
infoBubble=''}
data=`<div style="${divStyle}" ${getTitle(data)} ${divAttr}>${infoBubble}${String(data)}</div>`
if(data==null)data=''
if(typeof col.render=='string'){let tmp=col.render.toLowerCase().split(':')
if(['number','int','float','money','currency','percent','size'].indexOf(tmp[0])!=-1){style+='text-align: right;'}}
if(record?.w2ui){if(typeof record.w2ui.style=='object'){if(typeof record.w2ui.style[col_ind]=='string')style+=record.w2ui.style[col_ind]+';'
if(typeof record.w2ui.style[col.field]=='string')style+=record.w2ui.style[col.field]+';'}
if(typeof record.w2ui.class=='object'){if(typeof record.w2ui.class[col_ind]=='string')className+=record.w2ui.class[col_ind]+' '
if(typeof record.w2ui.class[col.field]=='string')className+=record.w2ui.class[col.field]+' '}}
let isCellSelected=false
if(isRowSelected&&sel.columns[ind]?.includes(col_ind))isCellSelected=true
let clipboardIcon
if(col.clipboardCopy){clipboardIcon='<span class="w2ui-clipboard-copy w2ui-icon-paste"></span>'}
data='<td class="w2ui-grid-data'+(isCellSelected?' w2ui-selected':'')+' '+className+
(isChanged?' w2ui-changed':'')+'" '+'   id="grid_'+this.name+'_data_'+ind+'_'+col_ind+'" col="'+col_ind+'" '+'   style="'+style+(col.style!=null?col.style:'')+'" '+
(col.attr!=null?col.attr:'')+attr+
(col_span>1?'colspan="'+col_span+'"':'')+'>'+data+(clipboardIcon&&w2utils.stripTags(data)?clipboardIcon:'')+'</td>'
if(ind===-1&&summary===true){data='<td class="w2ui-grid-data" col="'+col_ind+'" style="height: 0px; '+style+'" '+
(col_span>1?'colspan="'+col_span+'"':'')+'></td>'}
return data
function getTitle(cellData){let title
if(obj.show.recordTitles){if(col.title!=null){if(typeof col.title=='function'){title=col.title.call(obj,record,{self:this,index:ind,colIndex:col_ind,summary:!!summary})}
if(typeof col.title=='string')title=col.title}else{title=w2utils.stripTags(String(cellData).replace(/"/g,'\'\''))}}
return(title!=null)?'title="'+String(title)+'"':''}}
clipboardCopy(ind,col_ind,summary){let rec=summary?this.summary[ind]:this.records[ind]
let col=this.columns[col_ind]
let txt=(col?this.parseField(rec,col.field):'')
if(typeof col.clipboardCopy=='function'){txt=col.clipboardCopy(rec,{self:this,index:ind,colIndex:col_ind,summary:!!summary})}
query(this.box).find('#grid_'+this.name+'_focus').text(txt).get(0).select()
document.execCommand('copy')}
showBubble(ind,col_ind,summary){let info=this.columns[col_ind].info
if(!info)return
let html=''
let rec=this.records[ind]
let el=query(this.box).find(`${summary ? '.w2ui-grid-summary' : ''} #grid_${this.name}_data_${ind}_${col_ind} .w2ui-info`)
if(this.last.bubbleEl){w2tooltip.hide(this.name+'-bubble')}
this.last.bubbleEl=el
if(info.fields==null){info.fields=[]
for(let i=0;i<this.columns.length;i++){let col=this.columns[i]
info.fields.push(col.field+(typeof col.render=='string'?':'+col.render:''))}}
let fields=info.fields
if(typeof fields=='function'){fields=fields(rec,{self:this,index:ind,colIndex:col_ind,summary:!!summary})}
if(typeof info.render=='function'){html=info.render(rec,{self:this,index:ind,colIndex:col_ind,summary:!!summary})}else if(Array.isArray(fields)){html='<table cellpadding="0" cellspacing="0">'
for(let i=0;i<fields.length;i++){let tmp=String(fields[i]).split(':')
if(tmp[0]==''||tmp[0]=='-'||tmp[0]=='--'||tmp[0]=='---'){html+='<tr><td colspan=2><div style="border-top: '+(tmp[0]==''?'0':'1')+'px solid #C1BEBE; margin: 6px 0px;"></div></td></tr>'
continue}
let col=this.getColumn(tmp[0])
if(col==null)col={field:tmp[0],caption:tmp[0]}
let val=(col?this.parseField(rec,col.field):'')
if(tmp.length>1){if(w2utils.formatters[tmp[1]]){val=w2utils.formatters[tmp[1]](val,tmp[2]||null,rec)}else{console.log('ERROR: w2utils.formatters["'+tmp[1]+'"] does not exists.')}}
if(info.showEmpty!==true&&(val==null||val==''))continue
if(info.maxLength!=null&&typeof val=='string'&&val.length>info.maxLength)val=val.substr(0,info.maxLength)+'...'
html+='<tr><td>'+col.text+'</td><td>'+((val===0?'0':val)||'')+'</td></tr>'}
html+='</table>'}else if(w2utils.isPlainObject(fields)){html='<table cellpadding="0" cellspacing="0">'
for(let caption in fields){let fld=fields[caption]
if(fld==''||fld=='-'||fld=='--'||fld=='---'){html+='<tr><td colspan=2><div style="border-top: '+(fld==''?'0':'1')+'px solid #C1BEBE; margin: 6px 0px;"></div></td></tr>'
continue}
let tmp=String(fld).split(':')
let col=this.getColumn(tmp[0])
if(col==null)col={field:tmp[0],caption:tmp[0]}
let val=(col?this.parseField(rec,col.field):'')
if(tmp.length>1){if(w2utils.formatters[tmp[1]]){val=w2utils.formatters[tmp[1]](val,tmp[2]||null,rec)}else{console.log('ERROR: w2utils.formatters["'+tmp[1]+'"] does not exists.')}}
if(typeof fld=='function'){val=fld(rec,{self:this,index:ind,colIndex:col_ind,summary:!!summary})}
if(info.showEmpty!==true&&(val==null||val==''))continue
if(info.maxLength!=null&&typeof val=='string'&&val.length>info.maxLength)val=val.substr(0,info.maxLength)+'...'
html+='<tr><td>'+caption+'</td><td>'+((val===0?'0':val)||'')+'</td></tr>'}
html+='</table>'}
return w2tooltip.show(w2utils.extend({name:this.name+'-bubble',html,anchor:el.get(0),position:'top|bottom',class:'w2ui-info-bubble',style:'',hideOn:['doc-click']},info.options??{})).hide(()=>[this.last.bubbleEl=null])}
getCellEditable(ind,col_ind){let col=this.columns[col_ind]
let rec=this.records[ind]
if(!rec||!col)return null
let edit=(rec.w2ui?rec.w2ui.editable:null)
if(edit===false)return null
if(edit==null||edit===true){edit=(Object.keys(col.editable??{}).length>0?col.editable:null)
if(typeof edit==='function'){let value=this.getCellValue(ind,col_ind,false)
edit=edit.call(this,rec,{self:this,value,index:ind,colIndex:col_ind})}}
return edit}
getCellValue(ind,col_ind,summary,extra){let col=this.columns[col_ind]
let record=(summary!==true?this.records[ind]:this.summary[ind])
let value=this.parseField(record,col.field)
let className='',style='',attr='',divAttr=''
if(record?.w2ui?.changes?.[col.field]!=null){value=record.w2ui.changes[col.field]}
if(col.render!=null&&ind!==-1){if(typeof col.render=='function'&&record!=null){let html
try{html=col.render.call(this,record,{self:this,value,index:ind,colIndex:col_ind,summary:!!summary})}catch(e){throw new Error(`Render function for column "${col.field}" in grid "${this.name}": -- `+e.message)}
if(html!=null&&typeof html=='object'&&typeof html!='function'){if(html.id!=null&&html.text!=null){value=html.text}else if(typeof html.html=='string'){value=(html.html||'').trim()}else{value=''
console.log('ERROR: render function should return a primitive or an object of the following structure.',{html:'',attr:'',style:'',class:'',divAttr:''})}
attr=html.attr??''
style=html.style??''
className=html.class??''
divAttr=html.divAttr??''}else{value=String(html||'').trim()}}
if(typeof col.render=='object'){let tmp=col.render[value]
if(tmp!=null&&tmp!==''){value=tmp}}
if(typeof col.render=='string'){let strInd=col.render.toLowerCase().indexOf(':')
let tmp=[]
if(strInd==-1){tmp[0]=col.render.toLowerCase()
tmp[1]=''}else{tmp[0]=col.render.toLowerCase().substr(0,strInd)
tmp[1]=col.render.toLowerCase().substr(strInd+1)}
let func=w2utils.formatters[tmp[0]]
if(col.options&&col.options.autoFormat===false){func=null}
value=(typeof func=='function'?func(value,tmp[1],record):'')}}
if(value==null)value=''
return!extra?value:{value,attr,style,className,divAttr}}
getFooterHTML(){return'<div>'+'    <div class="w2ui-footer-left"></div>'+'    <div class="w2ui-footer-right"></div>'+'    <div class="w2ui-footer-center"></div>'+'</div>'}
status(msg){if(msg!=null){query(this.box).find(`#grid_${this.name}_footer`).find('.w2ui-footer-left').html(msg)}else{let msgLeft=''
let sel=this.getSelection()
if(sel.length>0){if(this.show.statusSelection&&sel.length>1){msgLeft=String(sel.length).replace(/(\d)(?=(\d\d\d)+(?!\d))/g,'$1'+w2utils.settings.groupSymbol)+' '+w2utils.lang('selected')}
if(this.show.statusRecordID&&sel.length==1){let tmp=sel[0]
if(typeof tmp=='object')tmp=tmp.recid+', '+w2utils.lang('Column')+': '+tmp.column
msgLeft=w2utils.lang('Record ID')+': '+tmp+' '}}
query(this.box).find('#grid_'+this.name+'_footer .w2ui-footer-left').html(msgLeft)}}
lock(msg,showSpinner){let args=Array.from(arguments)
args.unshift(this.box)
setTimeout(()=>{query(this.box).find('#grid_'+this.name+'_empty_msg').remove()
w2utils.lock(...args)},10)}
unlock(speed){setTimeout(()=>{if(query(this.box).find('.w2ui-message').hasClass('w2ui-closing'))return
w2utils.unlock(this.box,speed)},25)}
stateSave(returnOnly){let state={columns:[],show:w2utils.clone(this.show),last:{search:this.last.search,multi:this.last.multi,logic:this.last.logic,label:this.last.label,field:this.last.field,scrollTop:this.last.vscroll.scrollTop,scrollLeft:this.last.vscroll.scrollLeft},sortData:[],searchData:[]}
let prop_val
for(let i=0;i<this.columns.length;i++){let col=this.columns[i]
let col_save_obj={}
Object.keys(this.stateColProps).forEach((prop,idx)=>{if(this.stateColProps[prop]){if(col[prop]!==undefined){prop_val=col[prop]}else{prop_val=this.colTemplate[prop]||null}
col_save_obj[prop]=prop_val}})
state.columns.push(col_save_obj)}
for(let i=0;i<this.sortData.length;i++)state.sortData.push(w2utils.clone(this.sortData[i]))
for(let i=0;i<this.searchData.length;i++)state.searchData.push(w2utils.clone(this.searchData[i]))
let edata=this.trigger('stateSave',{target:this.name,state:state})
if(edata.isCancelled===true){return}
if(returnOnly!==true){this.cacheSave('state',state)}
edata.finish()
return state}
stateRestore(newState){let url=(typeof this.url!='object'?this.url:this.url.get)
if(!newState){newState=this.cache('state')}
let edata=this.trigger('stateRestore',{target:this.name,state:newState})
if(edata.isCancelled===true){return}
if(w2utils.isPlainObject(newState)){w2utils.extend(this.show,newState.show??{})
w2utils.extend(this.last,newState.last??{})
let sTop=this.last.vscroll.scrollTop
let sLeft=this.last.vscroll.scrollLeft
for(let c=0;c<newState.columns?.length;c++){let tmp=newState.columns[c]
let col_index=this.getColumn(tmp.field,true)
if(col_index!==null){w2utils.extend(this.columns[col_index],tmp)
if(c!==col_index)this.columns.splice(c,0,this.columns.splice(col_index,1)[0])}}
this.sortData.splice(0,this.sortData.length)
for(let c=0;c<newState.sortData?.length;c++){this.sortData.push(newState.sortData[c])}
this.searchData.splice(0,this.searchData.length)
for(let c=0;c<newState.searchData?.length;c++){this.searchData.push(newState.searchData[c])}
setTimeout(()=>{if(!url){if(this.sortData.length>0)this.localSort()
if(this.searchData.length>0)this.localSearch()}
this.last.vscroll.scrollTop=sTop
this.last.vscroll.scrollLeft=sLeft
this.refresh()},1)
console.log(`INFO (w2ui): state restored for "${this.name}"`)}
edata.finish()
return true}
stateReset(){this.stateRestore(this.last.state)
this.cacheSave('state',null)}
parseField(obj,field){if(this.nestedFields){let val=''
try{val=obj
let tmp=String(field).split('.')
for(let i=0;i<tmp.length;i++){val=val[tmp[i]]}}catch(event){val=''}
return val}else{return obj?obj[field]:''}}
prepareData(){let obj=this
for(let r=0;r<this.records.length;r++){let rec=this.records[r]
prepareRecord(rec)}
function prepareRecord(rec){for(let c=0;c<obj.columns.length;c++){let column=obj.columns[c]
if(rec[column.field]==null||typeof column.render!='string')continue
if(['number','int','float','money','currency','percent'].indexOf(column.render.split(':')[0])!=-1){if(typeof rec[column.field]!='number')rec[column.field]=parseFloat(rec[column.field])}
if(['date','age'].indexOf(column.render.split(':')[0])!=-1){if(!rec[column.field+'_']){let dt=rec[column.field]
if(w2utils.isInt(dt))dt=parseInt(dt)
rec[column.field+'_']=new Date(dt)}}
if(['time'].indexOf(column.render)!=-1){if(w2utils.isTime(rec[column.field])){let tmp=w2utils.isTime(rec[column.field],true)
let dt=new Date()
dt.setHours(tmp.hours,tmp.minutes,(tmp.seconds?tmp.seconds:0),0)
if(!rec[column.field+'_'])rec[column.field+'_']=dt}else{let tmp=rec[column.field]
if(w2utils.isInt(tmp))tmp=parseInt(tmp)
tmp=(tmp!=null?new Date(tmp):new Date())
let dt=new Date()
dt.setHours(tmp.getHours(),tmp.getMinutes(),tmp.getSeconds(),0)
if(!rec[column.field+'_'])rec[column.field+'_']=dt}}}
if(rec.w2ui?.children&&rec.w2ui?.expanded!==true){for(let r=0;r<rec.w2ui.children.length;r++){let subRec=rec.w2ui.children[r]
prepareRecord(subRec)}}}}
nextCell(index,col_ind,editable){let check=col_ind+1
if(check>=this.columns.length){index=this.nextRow(index)
return index==null?index:this.nextCell(index,-1,editable)}
let tmp=this.records[index].w2ui
let col=this.columns[check]
let span=(tmp&&tmp.colspan&&!isNaN(tmp.colspan[col.field])?parseInt(tmp.colspan[col.field]):1)
if(col==null)return null
if(col&&col.hidden||span===0)return this.nextCell(index,check,editable)
if(editable){let edit=this.getCellEditable(index,check)
if(edit==null||['checkbox','check'].indexOf(edit.type)!=-1){return this.nextCell(index,check,editable)}}
return{index,colIndex:check}}
prevCell(index,col_ind,editable){let check=col_ind-1
if(check<0){index=this.prevRow(index)
return index==null?index:this.prevCell(index,this.columns.length,editable)}
if(check<0)return null
let tmp=this.records[index].w2ui
let col=this.columns[check]
let span=(tmp&&tmp.colspan&&!isNaN(tmp.colspan[col.field])?parseInt(tmp.colspan[col.field]):1)
if(col==null)return null
if(col&&col.hidden||span===0)return this.prevCell(index,check,editable)
if(editable){let edit=this.getCellEditable(index,check)
if(edit==null||['checkbox','check'].indexOf(edit.type)!=-1){return this.prevCell(index,check,editable)}}
return{index,colIndex:check}}
nextRow(ind,col_ind,numRows){let sids=this.last.searchIds
let ret=null
if(numRows==null)numRows=1
if(numRows==-1){return this.records.length-1}
if((ind+numRows<this.records.length&&sids.length===0)||(sids.length>0&&ind<sids[sids.length-numRows])){ind+=numRows
if(sids.length>0)while(true){if(sids.includes(ind)||ind>this.records.length)break
ind+=numRows}
let tmp=this.records[ind].w2ui
let col=this.columns[col_ind]
let span=(tmp&&tmp.colspan&&col!=null&&!isNaN(tmp.colspan[col.field])?parseInt(tmp.colspan[col.field]):1)
if(span===0){ret=this.nextRow(ind,col_ind,numRows)}else{ret=ind}}
return ret}
prevRow(ind,col_ind,numRows){let sids=this.last.searchIds
let ret=null
if(numRows==null)numRows=1
if(numRows==-1){return 0}
if((ind-numRows>=0&&sids.length===0)||(sids.length>0&&ind>sids[0])){ind-=numRows
if(sids.length>0)while(true){if(sids.includes(ind)||ind<0)break
ind-=numRows}
let tmp=this.records[ind].w2ui
let col=this.columns[col_ind]
let span=(tmp&&tmp.colspan&&col!=null&&!isNaN(tmp.colspan[col.field])?parseInt(tmp.colspan[col.field]):1)
if(span===0){ret=this.prevRow(ind,col_ind,numRows)}else{ret=ind}}
return ret}
selectionSave(){this.last.saved_sel=this.getSelection()
return this.last.saved_sel}
selectionRestore(noRefresh){let time=Date.now()
this.last.selection={indexes:[],columns:{}}
let sel=this.last.selection
let lst=this.last.saved_sel
if(lst)for(let i=0;i<lst.length;i++){if(w2utils.isPlainObject(lst[i])){let tmp=this.get(lst[i].recid,true)
if(tmp!=null){if(sel.indexes.indexOf(tmp)==-1)sel.indexes.push(tmp)
if(!sel.columns[tmp])sel.columns[tmp]=[]
sel.columns[tmp].push(lst[i].column)}}else{let tmp=this.get(lst[i],true)
if(tmp!=null)sel.indexes.push(tmp)}}
delete this.last.saved_sel
if(noRefresh!==true)this.refresh()
return Date.now()-time}
message(options){return w2utils.message({owner:this,box:this.box,after:'.w2ui-grid-header'},options)}
confirm(options){return w2utils.confirm({owner:this,box:this.box,after:'.w2ui-grid-header'},options)}}
class w2form extends w2base{constructor(options){super(options.name)
this.name=null
this.header=''
this.box=null
this.url=''
this.method=null
this.routeData={}
this.formURL=''
this.formHTML=''
this.page=0
this.pageStyle=''
this.recid=null
this.fields=[]
this.actions={}
this.record={}
this.original=null
this.dataType=null
this.postData={}
this.httpHeaders={}
this.toolbar={}
this.tabs={}
this.style=''
this.focus=0
this.autosize=true
this.nestedFields=true
this.tabindexBase=0
this.isGenerated=false
this.last={fetchCtrl:null,fetchOptions:null,errors:[]}
this.onRequest=null
this.onLoad=null
this.onValidate=null
this.onSubmit=null
this.onProgress=null
this.onSave=null
this.onChange=null
this.onInput=null
this.onRender=null
this.onRefresh=null
this.onResize=null
this.onDestroy=null
this.onAction=null
this.onToolbar=null
this.onError=null
this.msgRefresh='Loading...'
this.msgSaving='Saving...'
this.msgServerError='Server error'
this.ALL_TYPES=['text','textarea','email','pass','password','int','float','money','currency','percent','hex','alphanumeric','color','date','time','datetime','toggle','checkbox','radio','check','checks','list','combo','enum','file','select','switch','map','array','div','custom','html','empty']
this.LIST_TYPES=['select','radio','check','checks','list','combo','enum','switch']
this.W2FIELD_TYPES=['int','float','money','currency','percent','hex','alphanumeric','color','date','time','datetime','list','combo','enum','file']
w2utils.extend(this,options)
let record=options.record
let original=options.original
let fields=options.fields
let toolbar=options.toolbar
let tabs=options.tabs
Object.assign(this,{record:{},original:null,fields:[],tabs:{},toolbar:{},handlers:[]})
if(fields){let sub=_processFields(fields)
this.fields=sub.fields
if(!tabs&&sub.tabs.length>0){tabs=sub.tabs}}
if(Array.isArray(tabs)){w2utils.extend(this.tabs,{tabs:[]})
for(let t=0;t<tabs.length;t++){let tmp=tabs[t]
if(typeof tmp==='object'){this.tabs.tabs.push(tmp)
if(tmp.active===true){this.tabs.active=tmp.id}}else{this.tabs.tabs.push({id:tmp,text:tmp})}}}else{w2utils.extend(this.tabs,tabs)}
w2utils.extend(this.toolbar,toolbar)
for(let p in record){if(w2utils.isPlainObject(record[p])){this.record[p]=w2utils.clone(record[p])}else{this.record[p]=record[p]}}
for(let p in original){if(w2utils.isPlainObject(original[p])){this.original[p]=w2utils.clone(original[p])}else{this.original[p]=original[p]}}
if(this.formURL!==''){fetch(this.formURL).then(resp=>resp.text()).then(text=>{this.formHTML=text
this.isGenerated=true
if(this.box)this.render(this.box)})}else if(!this.formURL&&!this.formHTML){this.formHTML=this.generateHTML()
this.isGenerated=true}else if(this.formHTML){this.isGenerated=true}
if(typeof this.box=='string')this.box=query(this.box).get(0)
if(this.box)this.render(this.box)
function _processFields(fields){let newFields=[]
let tabs=[]
if(w2utils.isPlainObject(fields)){let tmp=fields
fields=[]
Object.keys(tmp).forEach((key)=>{let fld=tmp[key]
if(fld.type=='group'){fld.text=key
if(w2utils.isPlainObject(fld.fields)){let tmp2=fld.fields
fld.fields=[]
Object.keys(tmp2).forEach((key2)=>{let fld2=tmp2[key2]
fld2.field=key2
fld.fields.push(_process(fld2))})}
fields.push(fld)}else if(fld.type=='tab'){let tab={id:key,text:key}
if(fld.style){tab.style=fld.style}
tabs.push(tab)
let sub=_processFields(fld.fields).fields
sub.forEach(fld2=>{fld2.html=fld2.html||{}
fld2.html.page=tabs.length-1
_process2(fld,fld2)})
fields.push(...sub)}else{fld.field=key
fields.push(_process(fld))}})
function _process(fld){let ignore=['html']
if(fld.html==null)fld.html={}
Object.keys(fld).forEach((key=>{if(ignore.indexOf(key)!=-1)return
if(['label','attr','style','text','span','page','column','anchor','group','groupStyle','groupTitleStyle','groupCollapsible'].indexOf(key)!=-1){fld.html[key]=fld[key]
delete fld[key]}}))
return fld}
function _process2(fld,fld2){let ignore=['style','html']
Object.keys(fld).forEach((key=>{if(ignore.indexOf(key)!=-1)return
if(['span','column','attr','text','label'].indexOf(key)!=-1){if(fld[key]&&!fld2.html[key]){fld2.html[key]=fld[key]}}}))}}
fields.forEach(field=>{if(field.type=='group'){let group={group:field.text||'',groupStyle:field.style||'',groupTitleStyle:field.titleStyle||'',groupCollapsible:field.collapsible===true?true:false,}
if(Array.isArray(field.fields)){field.fields.forEach(gfield=>{let fld=w2utils.clone(gfield)
if(fld.html==null)fld.html={}
w2utils.extend(fld.html,group)
Array('span','column','attr','label','page').forEach(key=>{if(fld.html[key]==null&&field[key]!=null){fld.html[key]=field[key]}})
if(fld.field==null&&fld.name!=null){console.log('NOTICE: form field.name property is deprecated, please use field.field. Field ->',field)
fld.field=fld.name}
newFields.push(fld)})}}else{let fld=w2utils.clone(field)
if(fld.field==null&&fld.name!=null){console.log('NOTICE: form field.name property is deprecated, please use field.field. Field ->',field)
fld.field=fld.name}
newFields.push(fld)}})
return{fields:newFields,tabs}}}
get(field,returnIndex){if(arguments.length===0){let all=[]
for(let f1=0;f1<this.fields.length;f1++){if(this.fields[f1].field!=null)all.push(this.fields[f1].field)}
return all}else{for(let f2=0;f2<this.fields.length;f2++){if(this.fields[f2].field==field){if(returnIndex===true)return f2;else return this.fields[f2]}}
return null}}
set(field,obj){for(let f=0;f<this.fields.length;f++){if(this.fields[f].field==field){w2utils.extend(this.fields[f],obj)
delete this.fields[f].w2field
this.refresh(field)
return true}}
return false}
getValue(field,original){if(this.nestedFields){let val=undefined
try{let rec=original===true?this.original:this.record
val=String(field).split('.').reduce((rec,i)=>{return rec[i]},rec)}catch(event){}
return val}else{return this.record[field]}}
setValue(field,value,noRefresh){if(value===''||value==null||(Array.isArray(value)&&value.length===0)||(w2utils.isPlainObject(value)&&Object.keys(value).length==0)){value=null}
if(this.nestedFields){try{let rec=this.record
String(field).split('.').map((fld,i,arr)=>{if(arr.length-1!==i){if(rec[fld])rec=rec[fld];else{rec[fld]={};rec=rec[fld]}}else{rec[fld]=value}})
if(!noRefresh)this.setFieldValue(field,value)
return true}catch(event){return false}}else{this.record[field]=value
if(!noRefresh)this.setFieldValue(field,value)
return true}}
getFieldValue(name){let field=this.get(name)
if(field==null)return
let el=field.el
let previous=this.getValue(name)
let original=this.getValue(name,true)
let current=el.value
if(['int','float','percent','money','currency'].includes(field.type)){if(field.type=='int'||current[current.length-1]!='.'){current=field.w2field.clean(current)}}
if(['radio'].includes(field.type)){let selected=query(el).closest('div').find('input:checked').get(0)
if(selected){let item=field.options.items[query(selected).data('index')]
current=item.id}else{current=null}}
if(['toggle','checkbox'].includes(field.type)){current=el.checked}
if(['check','checks'].indexOf(field.type)!==-1){current=[]
let selected=query(el).closest('div').find('input:checked')
if(selected.length>0){selected.each(el=>{let item=field.options.items[query(el).data('index')]
current.push(item.id)})}
if(!Array.isArray(previous))previous=[]}
let selected=el._w2field?.selected
if(['list','enum','file'].includes(field.type)&&selected){let nv=selected
let cv=previous
if(Array.isArray(nv)){current=[]
for(let i=0;i<nv.length;i++)current[i]=w2utils.clone(nv[i])}
if(Array.isArray(cv)){previous=[]
for(let i=0;i<cv.length;i++)previous[i]=w2utils.clone(cv[i])}
if(w2utils.isPlainObject(nv)){current=w2utils.clone(nv)}
if(w2utils.isPlainObject(cv)){previous=w2utils.clone(cv)}}
if(['map','array'].includes(field.type)){current=(field.type=='map'?{}:[])
field.$el.parent().find('.w2ui-map-field').each(div=>{let key=query(div).find('.w2ui-map.key').val()
let value=query(div).find('.w2ui-map.value').val()
if(field.type=='map'){current[key]=value}else{current.push(value)}})}
return{current,previous,original}}
setFieldValue(name,value){let field=this.get(name)
if(field==null)return
let el=field.el
switch(field.type){case'toggle':case'checkbox':{el.checked=value?true:false
break}
case'radio':{value=value?.id??value
let inputs=query(el).closest('div').find('input')
let items=field.options.items
items.forEach((it,ind)=>{if(it.id===value){inputs.filter(`[data-index="${ind}"]`).prop('checked',true)}})
break}
case'check':case'checks':{if(!Array.isArray(value)){if(value!=null){value=[value]}else{value=[]}}
value=value.map(val=>val?.id??val)
let inputs=query(el).closest('div').find('input')
let items=field.options.items
items.forEach((it,ind)=>{inputs.filter(`[data-index="${ind}"]`).prop('checked',value.includes(it.id)?true:false)})
break}
case'list':case'combo':let item=value
if(item?.id==null&&Array.isArray(field.options?.items)){field.options.items.forEach(it=>{if(it.id===value)item=it})}
if(item!=value){this.setValue(field.name,item,true)}
if(field.type=='list'){field.w2field.selected=item
field.w2field.refresh()}else{field.el.value=item?.text??value}
break
case'switch':{el.value=value
field.toolbar.uncheck(...field.toolbar.get())
field.toolbar.check(value)
break}
case'enum':case'file':{if(!Array.isArray(value)){value=value!=null?[value]:[]}
let items=[...value]
let updated=false
items.forEach((item,ind)=>{if(item?.id==null&&Array.isArray(field.options.items)){field.options.items.forEach(it=>{if(it.id==item){items[ind]=it
updated=true}})}})
if(updated){this.setValue(field.name,items,true)}
field.w2field.selected=items
field.w2field.refresh()
break}
case'map':case'array':{if(field.type=='map'&&(value==null||!w2utils.isPlainObject(value))){this.setValue(field.field,{},true)
value=this.getValue(field.field)}
if(field.type=='array'&&(value==null||!Array.isArray(value))){this.setValue(field.field,[],true)
value=this.getValue(field.field)}
let container=query(field.el).parent().find('.w2ui-map-container')
field.el.mapRefresh(value,container)
break}
case'div':case'custom':{query(el).html(value)
break}
case'color':{el.value=value??''
field.w2field.refresh()
break}
case'html':case'empty':break
default:el.value=value??''
break}}
show(){let effected=[]
for(let a=0;a<arguments.length;a++){let fld=this.get(arguments[a])
if(fld&&fld.hidden){fld.hidden=false
effected.push(fld.field)}}
if(effected.length>0)this.refresh.apply(this,effected)
this.updateEmptyGroups()
return effected}
hide(){let effected=[]
for(let a=0;a<arguments.length;a++){let fld=this.get(arguments[a])
if(fld&&!fld.hidden){fld.hidden=true
effected.push(fld.field)}}
if(effected.length>0)this.refresh.apply(this,effected)
this.updateEmptyGroups()
return effected}
enable(){let effected=[]
for(let a=0;a<arguments.length;a++){let fld=this.get(arguments[a])
if(fld&&fld.disabled){fld.disabled=false
effected.push(fld.field)}}
if(effected.length>0)this.refresh.apply(this,effected)
return effected}
disable(){let effected=[]
for(let a=0;a<arguments.length;a++){let fld=this.get(arguments[a])
if(fld&&!fld.disabled){fld.disabled=true
effected.push(fld.field)}}
if(effected.length>0)this.refresh.apply(this,effected)
return effected}
updateEmptyGroups(){query(this.box).find('.w2ui-group').each((group)=>{if(isHidden(query(group).find('.w2ui-field'))){query(group).hide()}else{query(group).show()}})
function isHidden($els){let flag=true
$els.each((el)=>{if(el.style.display!='none')flag=false})
return flag}}
change(){Array.from(arguments).forEach((field)=>{let tmp=this.get(field)
if(tmp.$el)tmp.$el.change()})}
reload(callBack){let url=(typeof this.url!=='object'?this.url:this.url.get)
if(url&&this.recid!=null){return this.request(callBack)}else{if(typeof callBack==='function')callBack()
return new Promise(resolve=>{resolve()})}}
clear(){if(arguments.length!=0){Array.from(arguments).forEach((field)=>{let rec=this.record
String(field).split('.').map((fld,i,arr)=>{if(arr.length-1!==i)rec=rec[fld];else delete rec[fld]})
this.refresh(field)})}else{this.recid=null
this.record={}
this.original=null
this.refresh()
this.hideErrors()}}
error(msg){let edata=this.trigger('error',{target:this.name,message:msg,fetchCtrl:this.last.fetchCtrl,fetchOptions:this.last.fetchOptions})
if(edata.isCancelled===true)return
setTimeout(()=>{this.message(msg)},1)
edata.finish()}
message(options){return w2utils.message({owner:this,box:this.box,after:'.w2ui-form-header'},options)}
confirm(options){return w2utils.confirm({owner:this,box:this.box,after:'.w2ui-form-header'},options)}
validate(showErrors){if(showErrors==null)showErrors=true
let errors=[]
for(let f=0;f<this.fields.length;f++){let field=this.fields[f]
if(this.getValue(field.field)==null)this.setValue(field.field,'')
if(['int','float','currency','money'].indexOf(field.type)!=-1){let val=this.getValue(field.field)
let min=field.options.min
let max=field.options.max
if(min!=null&&val!=null&&val<min){errors.push({field:field,error:w2utils.lang('Should be more than ${min}',{min})})}
if(max!=null&&val!=null&&val>max){errors.push({field:field,error:w2utils.lang('Should be less than ${max}',{max})})}}
switch(field.type){case'alphanumeric':if(this.getValue(field.field)&&!w2utils.isAlphaNumeric(this.getValue(field.field))){errors.push({field:field,error:w2utils.lang('Not alpha-numeric')})}
break
case'int':if(this.getValue(field.field)&&!w2utils.isInt(this.getValue(field.field))){errors.push({field:field,error:w2utils.lang('Not an integer')})}
break
case'percent':case'float':if(this.getValue(field.field)&&!w2utils.isFloat(this.getValue(field.field))){errors.push({field:field,error:w2utils.lang('Not a float')})}
break
case'currency':case'money':if(this.getValue(field.field)&&!w2utils.isMoney(this.getValue(field.field))){errors.push({field:field,error:w2utils.lang('Not in money format')})}
break
case'color':case'hex':if(this.getValue(field.field)&&!w2utils.isHex(this.getValue(field.field))){errors.push({field:field,error:w2utils.lang('Not a hex number')})}
break
case'email':if(this.getValue(field.field)&&!w2utils.isEmail(this.getValue(field.field))){errors.push({field:field,error:w2utils.lang('Not a valid email')})}
break
case'checkbox':if(this.getValue(field.field)==true){this.setValue(field.field,true)}else{this.setValue(field.field,false)}
break
case'date':if(!field.options.format)field.options.format=w2utils.settings.dateFormat
if(this.getValue(field.field)&&!w2utils.isDate(this.getValue(field.field),field.options.format)){errors.push({field:field,error:w2utils.lang('Not a valid date')+': '+field.options.format})}
break
case'list':case'combo':case'switch':break
case'enum':break}
let val=this.getValue(field.field)
if(field.hidden!==true&&field.required&&!['div','custom','html','empty'].includes(field.type)&&(val==null||val===''||(Array.isArray(val)&&val.length===0)||(w2utils.isPlainObject(val)&&Object.keys(val).length==0))){errors.push({field:field,error:w2utils.lang('Required field')})}
if(field.hidden!==true&&field.options?.minLength>0&&!['enum','list','combo'].includes(field.type)&&(val==null||val.length<field.options.minLength)){errors.push({field:field,error:w2utils.lang('Field should be at least ${count} characters.',{count:field.options.minLength})})}}
let edata=this.trigger('validate',{target:this.name,errors:errors})
if(edata.isCancelled===true)return
this.last.errors=errors
if(showErrors)this.showErrors()
edata.finish()
return errors}
showErrors(){let errors=this.last.errors
if(errors.length<=0)return
this.goto(errors[0].field.page)
query(errors[0].field.$el).parents('.w2ui-field')[0].scrollIntoView({block:'nearest',inline:'nearest'})
errors.forEach(error=>{let opt=w2utils.extend({anchorClass:'w2ui-error',class:'w2ui-light',position:'right|left',hideOn:['input']},error.options)
if(error.field==null)return
let anchor=error.field.el
if(error.field.type==='radio'){anchor=query(error.field.el).closest('div').get(0)}else if(['enum','file'].includes(error.field.type)){}
w2tooltip.show(w2utils.extend({anchor,name:`${this.name}-${error.field.field}-error`,html:error.error},opt))})
query(errors[0].field.$el).parents('.w2ui-page').off('.hideErrors').on('scroll.hideErrors',(evt)=>{this.hideErrors()})}
hideErrors(){this.fields.forEach(field=>{w2tooltip.hide(`${this.name}-${field.field}-error`)})}
getChanges(){let diff={}
if(this.original!=null&&typeof this.original=='object'&&Object.keys(this.record).length!==0){diff=doDiff(this.record,this.original,{})}
return diff
function doDiff(record,original,result){if(Array.isArray(record)&&Array.isArray(original)){while(record.length<original.length){record.push(null)}}
for(let i in record){if(record[i]!=null&&typeof record[i]==='object'){result[i]=doDiff(record[i],original[i]||{},{})
if(!result[i]||(Object.keys(result[i]).length==0&&Object.keys(original[i].length==0)))delete result[i]}else if(record[i]!=original[i]||(record[i]==null&&original[i]!=null)){result[i]=record[i]}}
return Object.keys(result).length!=0?result:null}}
getCleanRecord(strict){let data=w2utils.clone(this.record)
this.fields.forEach((fld)=>{if(['list','combo','enum'].indexOf(fld.type)!=-1){let tmp={nestedFields:true,record:data}
let val=this.getValue.call(tmp,fld.field)
if(w2utils.isPlainObject(val)&&val.id!=null){this.setValue.call(tmp,fld.field,val.id)}
if(Array.isArray(val)){val.forEach((item,ind)=>{if(w2utils.isPlainObject(item)&&item.id){val[ind]=item.id}})}}
if(fld.type=='map'){let tmp={nestedFields:true,record:data}
let val=this.getValue.call(tmp,fld.field)
if(val._order)delete val._order}
if(fld.type=='file'){let tmp={nestedFields:true,record:data}
let val=this.getValue.call(tmp,fld.field)??[]
val.forEach(v=>{delete v.file
delete v.modified})
this.setValue.call(tmp,fld.field,val)}})
if(strict===true){Object.keys(data).forEach((key)=>{if(!this.get(key))delete data[key]})}
return data}
request(postData,callBack){let self=this
let resolve,reject
let responseProm=new Promise((res,rej)=>{resolve=res;reject=rej})
if(typeof postData==='function'){callBack=postData
postData=null}
if(postData==null)postData={}
if(!this.url||(typeof this.url==='object'&&!this.url.get))return
let params={}
params.action='get'
params.recid=this.recid
params.name=this.name
w2utils.extend(params,this.postData)
w2utils.extend(params,postData)
let edata=this.trigger('request',{target:this.name,url:this.url,httpMethod:'GET',postData:params,httpHeaders:this.httpHeaders})
if(edata.isCancelled===true)return
this.record={}
this.original=null
this.lock(w2utils.lang(this.msgRefresh))
let url=edata.detail.url
if(typeof url==='object'&&url.get)url=url.get
if(this.last.fetchCtrl)try{this.last.fetchCtrl.abort()}catch(e){}
if(Object.keys(this.routeData).length!=0){let info=w2utils.parseRoute(url)
if(info.keys.length>0){for(let k=0;k<info.keys.length;k++){if(this.routeData[info.keys[k].name]==null)continue
url=url.replace((new RegExp(':'+info.keys[k].name,'g')),this.routeData[info.keys[k].name])}}}
url=new URL(url,location)
let fetchOptions=w2utils.prepareParams(url,{method:edata.detail.httpMethod,headers:edata.detail.httpHeaders,body:edata.detail.postData},this.dataType)
this.last.fetchCtrl=new AbortController()
fetchOptions.signal=this.last.fetchCtrl.signal
this.last.fetchOptions=fetchOptions
fetch(url,fetchOptions).catch(processError).then((resp)=>{if(resp?.status!=200){if(resp)processError(resp)
return}
resp.json().catch(processError).then(data=>{let edata=self.trigger('load',{target:self.name,fetchCtrl:this.last.fetchCtrl,fetchOptions:this.last.fetchOptions,data})
if(edata.isCancelled===true)return
if(data.error==null&&data.status==='error'){data.error=true}
if(!data.record){Object.assign(data,{record:w2utils.clone(data)})}
if(data.error===true){self.error(w2utils.lang(data.message??this.msgServerError))}else{self.record=w2utils.clone(data.record)}
self.unlock()
edata.finish()
self.refresh()
self.setFocus()
if(typeof callBack==='function')callBack(data)
resolve(data)})})
edata.finish()
return responseProm
function processError(response){if(response.name==='AbortError'){return}
self.unlock()
let edata2=self.trigger('error',{response,fetchCtrl:self.last.fetchCtrl,fetchOptions:self.last.fetchOptions})
if(edata2.isCancelled===true)return
if(response.status&&response.status!=200){self.error(response.status+': '+response.statusText)}else{console.log('ERROR: Server request failed.',response,'. ','Expected Response:',{error:false,record:{field1:1,field2:'item'}},'OR:',{error:true,message:'Error description'})
self.error(String(response))}
edata2.finish()
reject(response)}}
submit(postData,callBack){return this.save(postData,callBack)}
save(postData,callBack){let self=this
let resolve,reject
let saveProm=new Promise((res,rej)=>{resolve=res;reject=rej})
if(typeof postData==='function'){callBack=postData
postData=null}
let errors=self.validate(true)
if(errors.length!==0)return
if(postData==null)postData={}
if(!self.url||(typeof self.url==='object'&&!self.url.save)){console.log('ERROR: Form cannot be saved because no url is defined.')
return}
self.lock(w2utils.lang(self.msgSaving)+' <span id="'+self.name+'_progress"></span>')
let params={}
params.action='save'
params.recid=self.recid
params.name=self.name
w2utils.extend(params,self.postData)
w2utils.extend(params,postData)
params.record=w2utils.clone(self.record)
let edata=self.trigger('submit',{target:self.name,url:self.url,httpMethod:this.method??'POST',postData:params,httpHeaders:self.httpHeaders})
if(edata.isCancelled===true)return
let url=edata.detail.url
if(typeof url==='object'&&url.save)url=url.save
if(self.last.fetchCtrl)self.last.fetchCtrl.abort()
if(Object.keys(self.routeData).length>0){let info=w2utils.parseRoute(url)
if(info.keys.length>0){for(let k=0;k<info.keys.length;k++){if(self.routeData[info.keys[k].name]==null)continue
url=url.replace((new RegExp(':'+info.keys[k].name,'g')),self.routeData[info.keys[k].name])}}}
url=new URL(url,location)
let fetchOptions=w2utils.prepareParams(url,{method:edata.detail.httpMethod,headers:edata.detail.httpHeaders,body:edata.detail.postData},this.dataType)
this.last.fetchCtrl=new AbortController()
fetchOptions.signal=this.last.fetchCtrl.signal
this.last.fetchOptions=fetchOptions
fetch(url,fetchOptions).catch(processError).then(resp=>{self.unlock()
if(resp?.status!=200){processError(resp??{})
return}
resp.json().catch(processError).then(data=>{let edata=self.trigger('save',{target:self.name,fetchCtrl:this.last.fetchCtrl,fetchOptions:this.last.fetchOptions,data})
if(edata.isCancelled===true)return
if(data.error===true){self.error(w2utils.lang(data.message??this.msgServerError))}else{self.original=null}
edata.finish()
self.refresh()
if(typeof callBack==='function')callBack(data)
resolve(data)})})
edata.finish()
return saveProm
function processError(response){if(response?.name==='AbortError'){return}
self.unlock()
let edata2=self.trigger('error',{response,fetchCtrl:self.last.fetchCtrl,fetchOptions:self.last.fetchOptions})
if(edata2.isCancelled===true)return
if(response.status&&response.status!=200){self.error(response.status+': '+response.statusText)}else{console.log('ERROR: Server request failed.',response,'. ','Expected Response:',{error:false,record:{field1:1,field2:'item'}},'OR:',{error:true,message:'Error description'})
self.error(String(response))}
edata2.finish()
reject()}}
lock(msg,showSpinner){let args=Array.from(arguments)
args.unshift(this.box)
w2utils.lock(...args)}
unlock(speed){let box=this.box
w2utils.unlock(box,speed)}
lockPage(page,msg,spinner){let $page=query(this.box).find('.page-'+page)
if($page.length){w2utils.lock($page,msg,spinner)
return true}
return false}
unlockPage(page,speed){let $page=query(this.box).find('.page-'+page)
if($page.length){w2utils.unlock($page,speed)
return true}
return false}
goto(page){if(this.page===page)return
if(page!=null)this.page=page
if(query(this.box).data('autoSize')===true){query(this.box).get(0).clientHeight=0}
this.refresh()}
generateHTML(){let pages=[]
let group=''
let page
let column
let html
let tabindex
let tabindex_str
for(let f=0;f<this.fields.length;f++){html=''
tabindex=this.tabindexBase+f+1
tabindex_str=' tabindex="'+tabindex+'"'
let field=this.fields[f]
if(field.html==null)field.html={}
if(field.options==null)field.options={}
if(field.html.caption!=null&&field.html.label==null){console.log('NOTICE: form field.html.caption property is deprecated, please use field.html.label. Field ->',field)
field.html.label=field.html.caption}
if(field.html.label==null)field.html.label=field.field
field.html=w2utils.extend({label:'',span:6,attr:'',text:'',style:'',page:0,column:0},field.html)
if(page==null)page=field.html.page
if(column==null)column=field.html.column
let input=`<input id="${field.field}" name="${field.field}" class="w2ui-input ${field.html.class ?? ''}" type="text" ${field.html.attr + tabindex_str}>`
switch(field.type){case'pass':case'password':input=input.replace('type="text"','type="password"')
break
case'checkbox':{input=`
                        <label class="w2ui-box-label">
                            <input id="${field.field}" name="${field.field}" class="w2ui-input ${field.html.class ?? ''}" type="checkbox" ${field.html.attr + tabindex_str}>
                            <span>${field.html.label}</span>
                        </label>`
break}
case'check':case'checks':{if(field.options.items==null&&field.html.items!=null)field.options.items=field.html.items
let items=field.options.items
input=''
if(!Array.isArray(items))items=[]
if(items.length>0){items=w2utils.normMenu.call(this,items,field)}
for(let i=0;i<items.length;i++){input+=`
                            <label class="w2ui-box-label">
                                <input id="${field.field + i}" name="${field.field}" class="w2ui-input ${field.html.class ?? ''}" type="checkbox"
                                    ${field.html.attr + tabindex_str} data-value="${items[i].id}" data-index="${i}">
                                <span>&#160;${items[i].text}</span>
                            </label>
                            <br>`}
break}
case'radio':{input=''
if(field.options.items==null&&field.html.items!=null)field.options.items=field.html.items
let items=field.options.items
if(!Array.isArray(items))items=[]
if(items.length>0){items=w2utils.normMenu.call(this,items,field)}
for(let i=0;i<items.length;i++){input+=`
                            <label class="w2ui-box-label">
                                <input id="${field.field + i}" name="${field.field}" class="w2ui-input ${field.html.class ?? ''}" type="radio"
                                    ${field.html.attr + (i === 0 ? tabindex_str : '')}
                                    data-value="${items[i].id}" data-index="${i}">
                                <span>&#160;${items[i].text}</span>
                            </label>
                            <br>`}
break}
case'select':{input=`<select id="${field.field}" name="${field.field}" class="w2ui-input ${field.html.class ?? ''}" ${field.html.attr + tabindex_str}>`
if(field.options.items==null&&field.html.items!=null)field.options.items=field.html.items
let items=field.options.items
if(!Array.isArray(items))items=[]
if(items.length>0){items=w2utils.normMenu.call(this,items,field)}
for(let i=0;i<items.length;i++){input+=`<option value="${items[i].id}">${items[i].text}</option>`}
input+='</select>'
break}
case'switch':{input=`<div id="${field.field}-tb" class="w2ui-form-switch ${field.html.class ?? ''}" ${field.html.attr}
                        style="outline1: 1px solid red !important; height: 34px; margin-top: -5px; padding: 0px; background-color: transparent; position: relative;"></div>
                        <input id="${field.field}" name="${field.field}" ${tabindex_str} class="w2ui-input"
                            style="position: absolute; right: 0; margin-top: -30px; width: 1px; padding: 0; opacity: 0">`
break}
case'textarea':input=`<textarea id="${field.field}" name="${field.field}" class="w2ui-input ${field.html.class ?? ''}" ${field.html.attr + tabindex_str}></textarea>`
break
case'toggle':input=`<input id="${field.field}" name="${field.field}" class="w2ui-input w2ui-toggle  ${field.html.class ?? ''}"
                                type="checkbox" ${field.html.attr + tabindex_str}>
                            <div><div></div></div>`
break
case'map':case'array':field.html.key=field.html.key||{}
field.html.value=field.html.value||{}
field.html.tabindex_str=tabindex_str
input='<span style="float: right">'+(field.html.text||'')+'</span>'+'<input id="'+field.field+'" name="'+field.field+'" type="hidden" '+field.html.attr+tabindex_str+'>'+'<div class="w2ui-map-container"></div>'
break
case'div':case'custom':input=`<div id="${field.field}" name="${field.field}" ${field.html.attr + tabindex_str} class="w2ui-input ${field.html.class ?? ''}">`+
(field&&field.html&&field.html.html?field.html.html:'')+'</div>'
break
case'html':case'empty':input=`<div id="${field.field}" name="${field.field}" ${field.html.attr + tabindex_str} class="w2ui-input ${field.html.class ?? ''}">`+
(field&&field.html?(field.html.html||'')+(field.html.text||''):'')+'</div>'
break}
if(group!==''){if(page!=field.html.page||column!=field.html.column||(field.html.group&&(group!=field.html.group))){pages[page][column]+='\n   </div>\n  </div>'
group=''}}
if(field.html.group&&(group!=field.html.group)){let collapsible=''
if(field.html.groupCollapsible){collapsible='<span class="w2ui-icon-collapse" style="width: 15px; display: inline-block; position: relative; top: -2px;"></span>'}
html+='\n <div class="w2ui-group">'
+'\n   <div class="w2ui-group-title w2ui-eaction" style="'+(field.html.groupTitleStyle||'')+'; '
+(collapsible!=''?'cursor: pointer; user-select: none':'')+'"'
+(collapsible!=''?'data-group="'+w2utils.base64encode(field.html.group)+'"':'')
+(collapsible!=''?'data-click="toggleGroup|'+field.html.group+'"':'')
+'>'
+collapsible+w2utils.lang(field.html.group)+'</div>\n'
+'   <div class="w2ui-group-fields" style="'+(field.html.groupStyle||'')+'">'
group=field.html.group}
if(field.html.anchor==null){let span=(field.html.span!=null?'w2ui-span'+field.html.span:'')
if(field.html.span==-1)span='w2ui-span-none'
let label='<label'+(span=='none'?' style="display: none"':'')+'>'+w2utils.lang(field.type!='checkbox'?field.html.label:field.html.text)+'</label>'
if(!field.html.label)label=''
html+='\n      <div class="w2ui-field '+span+'" style="'+(field.hidden?'display: none;':'')+field.html.style+'">'+'\n         '+label+
((field.type==='empty')?input:'\n         <div>'+input+(field.type!='array'&&field.type!='map'?w2utils.lang(field.type!='checkbox'?field.html.text:''):'')+'</div>')+'\n      </div>'}else{pages[field.html.page].anchors=pages[field.html.page].anchors||{}
pages[field.html.page].anchors[field.html.anchor]='<div class="w2ui-field w2ui-field-inline" style="'+(field.hidden?'display: none;':'')+field.html.style+'">'+
((field.type==='empty')?input:'<div>'+w2utils.lang(field.type!='checkbox'?field.html.label:field.html.text,true)+input+w2utils.lang(field.type!='checkbox'?field.html.text:'')+'</div>')+'</div>'}
if(pages[field.html.page]==null)pages[field.html.page]={}
if(pages[field.html.page][field.html.column]==null)pages[field.html.page][field.html.column]=''
pages[field.html.page][field.html.column]+=html
page=field.html.page
column=field.html.column}
if(group!=='')pages[page][column]+='\n   </div>\n  </div>'
if(this.tabs.tabs){for(let i=0;i<this.tabs.tabs.length;i++)if(pages[i]==null)pages[i]=[]}
let buttons=''
if(Object.keys(this.actions).length>0){buttons+='\n<div class="w2ui-buttons">'
tabindex=this.tabindexBase+this.fields.length+1
for(let a in this.actions){let act=this.actions[a]
let info={text:'',style:'','class':''}
if(w2utils.isPlainObject(act)){if(act.text==null&&act.caption!=null){console.log('NOTICE: form action.caption property is deprecated, please use action.text. Action ->',act)
act.text=act.caption}
if(act.text)info.text=act.text
if(act.style)info.style=act.style
if(act.class)info.class=act.class}else{info.text=a
if(['save','update','create'].indexOf(a.toLowerCase())!==-1)info.class='w2ui-btn-blue';else info.class=''}
buttons+='\n    <button name="'+a+'" class="w2ui-btn '+info.class+'" style="'+info.style+'" tabindex="'+tabindex+'">'+
w2utils.lang(info.text)+'</button>'
tabindex++}
buttons+='\n</div>'}
html=''
for(let p=0;p<pages.length;p++){html+='<div class="w2ui-page page-'+p+'" style="'+(p!==0?'display: none;':'')+this.pageStyle+'">'
if(!pages[p]){console.log(`ERROR: Page ${p} does not exist`)
return false}
if(pages[p].before){html+=pages[p].before}
html+='<div class="w2ui-column-container">'
Object.keys(pages[p]).sort().forEach((c,ind)=>{if(c==parseInt(c)){html+='<div class="w2ui-column col-'+c+'">'+(pages[p][c]||'')+'\n</div>'}})
html+='\n</div>'
if(pages[p].after){html+=pages[p].after}
html+='\n</div>'
if(pages[p].anchors){Object.keys(pages[p].anchors).forEach((key,ind)=>{html=html.replace(key,pages[p].anchors[key])})}}
html+=buttons
return html}
toggleGroup(groupName,show){let el=query(this.box).find('.w2ui-group-title[data-group="'+w2utils.base64encode(groupName)+'"]')
if(el.length===0)return
let el_next=query(el.prop('nextElementSibling'))
if(typeof show==='undefined'){show=(el_next.css('display')=='none')}
if(show){el_next.show()
el.find('span').addClass('w2ui-icon-collapse').removeClass('w2ui-icon-expand')}else{el_next.hide()
el.find('span').addClass('w2ui-icon-expand').removeClass('w2ui-icon-collapse')}}
action(action,event){let act=this.actions[action]
let click=act
if(w2utils.isPlainObject(act)&&act.onClick)click=act.onClick
let edata=this.trigger('action',{target:action,action:act,originalEvent:event})
if(edata.isCancelled===true)return
if(typeof click==='function')click.call(this,event)
edata.finish()}
resize(){let self=this
let edata=this.trigger('resize',{target:this.name})
if(edata.isCancelled===true)return
if(this.box!=null){let header=query(this.box).find(':scope > div .w2ui-form-header')
let toolbar=query(this.box).find(':scope > div .w2ui-form-toolbar')
let tabs=query(this.box).find(':scope > div .w2ui-form-tabs')
let page=query(this.box).find(':scope > div .w2ui-page')
let dpage=query(this.box).find(':scope > div .w2ui-page.page-'+this.page+' > div')
let buttons=query(this.box).find(':scope > div .w2ui-buttons')
let{headerHeight,tbHeight,tabsHeight}=resizeElements()
if(this.autosize){let cHeight=query(this.box).get(0).clientHeight
if(cHeight===0||query(this.box).data('autosize')=='yes'){query(this.box).css({height:headerHeight+tbHeight+tabsHeight+15
+(page.length>0?w2utils.getSize(dpage,'height'):0)
+(buttons.length>0?w2utils.getSize(buttons,'height'):0)
+'px'})
query(this.box).data('autosize','yes')}
resizeElements()}
function resizeElements(){let headerHeight=(self.header!==''?w2utils.getSize(header,'height'):0)
let tbHeight=(Array.isArray(self.toolbar?.items)&&self.toolbar?.items?.length>0)?w2utils.getSize(toolbar,'height'):0
let tabsHeight=(Array.isArray(self.tabs?.tabs)&&self.tabs?.tabs?.length>0)?w2utils.getSize(tabs,'height'):0
toolbar.css({top:headerHeight+'px'})
tabs.css({top:headerHeight+tbHeight+'px'})
page.css({top:headerHeight+tbHeight+tabsHeight+'px',bottom:(buttons.length>0?w2utils.getSize(buttons,'height'):0)+'px'})
return{headerHeight,tbHeight,tabsHeight}}}
edata.finish()}
refresh(){let time=Date.now()
let self=this
if(!this.box)return
if(!this.isGenerated||!query(this.box).html())return
let edata=this.trigger('refresh',{target:this.name,page:this.page,field:arguments[0],fields:arguments})
if(edata.isCancelled===true)return
let fields=Array.from(this.fields.keys())
if(arguments.length>0){fields=Array.from(arguments).map((fld,ind)=>{if(typeof fld!='string')console.log('ERROR: Arguments in refresh functions should be field names')
return this.get(fld,true)}).filter((fld,ind)=>{if(fld!=null)return true;else return false})}else{query(this.box).find('input, textarea, select').each(el=>{let name=(query(el).attr('name')!=null?query(el).attr('name'):query(el).attr('id'))
let field=this.get(name)
if(field){let div=query(el).closest('.w2ui-page')
if(div.length>0){for(let i=0;i<100;i++){if(div.hasClass('page-'+i)){field.page=i;break}}}}})
query(this.box).find('.w2ui-page').hide()
query(this.box).find('.w2ui-page.page-'+this.page).show()
query(this.box).find('.w2ui-form-header').html(w2utils.lang(this.header))
if(typeof this.tabs==='object'&&Array.isArray(this.tabs.tabs)&&this.tabs.tabs.length>0){query(this.box).find('#form_'+this.name+'_tabs').show()
this.tabs.active=this.tabs.tabs[this.page].id
this.tabs.refresh()}else{query(this.box).find('#form_'+this.name+'_tabs').hide()}
if(typeof this.toolbar==='object'&&Array.isArray(this.toolbar.items)&&this.toolbar.items.length>0){query(this.box).find('#form_'+this.name+'_toolbar').show()
this.toolbar.refresh()}else{query(this.box).find('#form_'+this.name+'_toolbar').hide()}}
for(let f=0;f<fields.length;f++){let field=this.fields[fields[f]]
if(field.name==null&&field.field!=null)field.name=field.field
if(field.field==null&&field.name!=null)field.field=field.name
field.$el=query(this.box).find(`[name='${String(field.name).replace(/\\/g, '\\\\')}']`)
field.el=field.$el.get(0)
if(field.el)field.el.id=field.name
if(field.w2field){field.w2field.reset()}
field.$el.off('.w2form').on('change.w2form',function(event){let value=self.getFieldValue(field.field)
if(['enum','file'].includes(field.type)){let helper=field.el._w2field?.helpers?.multi
query(helper).removeClass('w2ui-error')}
if(this._previous!=null){value.previous=this._previous
delete this._previous}
let edata2=self.trigger('change',{target:this.name,field:this.name,value,originalEvent:event})
if(edata2.isCancelled===true)return
self.setValue(this.name,value.current)
edata2.finish()}).on('input.w2form',function(event){if(self.original==null){if(Object.keys(self.record).length>0){self.original=w2utils.clone(self.record)}else{self.original={}}}
let value=self.getFieldValue(field.field)
if(this._previous==null){this._previous=value.previous}
let edata2=self.trigger('input',{target:self.name,field,value,originalEvent:event})
if(edata2.isCancelled===true)return
self.setValue(this.name,value.current)
edata2.finish()})
if(field.required){field.$el.closest('.w2ui-field').addClass('w2ui-required')}else{field.$el.closest('.w2ui-field').removeClass('w2ui-required')}
if(field.disabled!=null){if(field.disabled){if(field.$el.data('tabIndex')==null){field.$el.data('tabIndex',field.$el.prop('tabIndex'))}
field.$el.prop('readOnly',true).prop('disabled',true).prop('tabIndex',-1).closest('.w2ui-field').addClass('w2ui-disabled')}else{field.$el.prop('readOnly',false).prop('disabled',false).prop('tabIndex',field.$el.data('tabIndex')??field.$el.prop('tabIndex')??0).closest('.w2ui-field').removeClass('w2ui-disabled')}}
let tmp=field.el
if(!tmp)tmp=query(this.box).find('#'+field.field)
if(field.hidden){query(tmp).closest('.w2ui-field').hide()}else{query(tmp).closest('.w2ui-field').show()}}
query(this.box).find('button, input[type=button]').each(el=>{query(el).off('click').on('click',function(event){let action=this.value
if(this.id)action=this.id
if(this.name)action=this.name
self.action(action,event)})})
for(let f=0;f<fields.length;f++){let field=this.fields[fields[f]]
if(!field.el)continue
if(!field.$el.hasClass('w2ui-input'))field.$el.addClass('w2ui-input')
field.type=String(field.type).toLowerCase()
if(!field.options)field.options={}
if(this.LIST_TYPES.includes(field.type)){let items=field.options.items
if(items==null)field.options.items=[]
if(field.type=='switch'){items.forEach((item,ind)=>{return items[ind]=typeof item!='object'?{id:item,text:item}:item})}else{field.options.items=w2utils.normMenu.call(this,items??[],field)}}
if(field.type=='switch'){if(field.toolbar){w2ui[this.name+'_'+field.name+'_tb'].destroy()}
let items=field.options.items
items.forEach(item=>item.type='radio')
field.toolbar=new w2toolbar({box:field.$el.prev().get(0),name:this.name+'_'+field.name+'_tb',items,onClick(event){let value=event.detail.item.id
let edata=self.trigger('change',{target:field.name,field:field.name,value,originalEvent:event})
if(edata.isCancelled===true){return}
self.record[field.name]=event.detail.item.id
self.setFieldValue(field.name,event.detail.item.id)
edata.finish()}})
field.$el.off('.form-input').on('focus.form-input',event=>{let ind=field.toolbar.get(field.$el.val(),true)
query(event.target).prop('_index',ind)}).on('blur.form-input',event=>{query(event.target).removeProp('_index')
query(`#${field.name}-tb .w2ui-tb-button`).removeClass('over')}).on('keydown.form-input',event=>{let ind=query(event.target).prop('_index')
switch(event.key){case'ArrowLeft':{if(ind>0)ind--
query(`#${field.name}-tb .w2ui-tb-button`).removeClass('over').eq(ind).addClass('over')
query(event.target).prop('_index',ind)
break}
case'ArrowRight':{if(ind<field.toolbar.items.length-1)ind++
query(`#${field.name}-tb .w2ui-tb-button`).removeClass('over').eq(ind).addClass('over')
query(event.target).prop('_index',ind)
break}}
if(event.keyCode==32||event.keyCode==13){let item=field.toolbar.items[ind]
self.setFieldValue(field.name,item.id)
query(`#${field.name}-tb .w2ui-tb-button`).removeClass('over')}
if(!event.metaKey&&!event.ctrlKey&&event.keyCode!=9){event.preventDefault()}})}
if(field.type=='select'){let items=field.options.items
let options=''
items.forEach(item=>{options+=`<option value="${item.id}">${item.text}</option>`})
field.$el.html(options)}
if(this.W2FIELD_TYPES.includes(field.type)){field.w2field=field.w2field??new w2field(w2utils.extend({},field.options,{type:field.type}))
field.w2field.render(field.el)}
if(['map','array'].includes(field.type)){(function(obj,field){let keepFocus
field.el.mapAdd=function(field,div,cnt){let attr=(field.disabled?' readOnly ':'')+(field.html.tabindex_str||'')
let html=`
                            <div class="w2ui-map-field" style="margin-bottom: 5px" data-index="${cnt}">
                            ${field.type == 'map'
                                ? `<input type="text"${(field.html.key.attr??'')+attr}class="w2ui-input ${field.html.class ?? ''} w2ui-map key">${field.html.key.text||''}`
                                : ''
                            }
                            <input type="text" ${(field.html.value.attr ?? '') + attr} class="w2ui-input ${field.html.class ?? ''} w2ui-map value">
                                ${field.html.value.text || ''}
                            </div>`
div.append(html)}
field.el.mapRefresh=function(map,div){let keys,$k,$v
if(field.type=='map'){if(!w2utils.isPlainObject(map))map={}
if(map._order==null)map._order=Object.keys(map)
keys=map._order}
if(field.type=='array'){if(!Array.isArray(map))map=[]
keys=map.map((item,ind)=>{return ind})}
let all=div.find('.w2ui-map-field')
for(let i=all.length-1;i>=keys.length;i--){div.find(`div[data-index='${i}']`).remove()}
for(let ind=0;ind<keys.length;ind++){let key=keys[ind]
let fld=div.find(`div[data-index='${ind}']`)
if(fld.length==0){field.el.mapAdd(field,div,ind)
fld=div.find(`div[data-index='${ind}']`)}
fld.attr('data-key',key)
$k=fld.find('.w2ui-map.key')
$v=fld.find('.w2ui-map.value')
let val=map[key]
if(field.type=='array'){let tmp=map.filter((it)=>{return it.key==key?true:false})
if(tmp.length>0)val=tmp[0].value}
$k.val(key)
$v.val(val)
if(field.disabled===true||field.disabled===false){$k.prop('readOnly',field.disabled?true:false)
$v.prop('readOnly',field.disabled?true:false)}}
let cnt=keys.length
let curr=div.find(`div[data-index='${cnt}']`)
if(curr.length===0&&(!$k||$k.val()!=''||$v.val()!='')&&!($k&&($k.prop('readOnly')===true||$k.prop('disabled')===true))){field.el.mapAdd(field,div,cnt)}
if(field.disabled===true||field.disabled===false){curr.find('.key').prop('readOnly',field.disabled?true:false)
curr.find('.value').prop('readOnly',field.disabled?true:false)}
let container=query(field.el).get(0)?.nextSibling
query(container).find('input.w2ui-map').off('.mapChange').on('keyup.mapChange',function(event){let $div=query(event.target).closest('.w2ui-map-field')
let next=$div.get(0).nextElementSibling
let prev=$div.get(0).previousElementSibling
if(event.keyCode==13){let el=keepFocus??next
if(el instanceof HTMLElement){let inp=query(el).find('input')
if(inp.length>0){inp.get(0).focus()}}
keepFocus=undefined}
let className=query(event.target).hasClass('key')?'key':'value'
if(event.keyCode==38&&prev){query(prev).find(`input.${className}`).get(0).select()
event.preventDefault()}
if(event.keyCode==40&&next){query(next).find(`input.${className}`).get(0).select()
event.preventDefault()}}).on('keydown.mapChange',function(event){if(event.keyCode==38||event.keyCode==40){event.preventDefault()}}).on('input.mapChange',function(event){let fld=query(event.target).closest('div')
let cnt=fld.data('index')
let next=fld.get(0).nextElementSibling
if(fld.find('input').val()!=''&&!next){field.el.mapAdd(field,div,parseInt(cnt)+1)}else if(fld.find('input').val()==''&&next){let isEmpty=true
query(next).find('input').each(el=>{if(el.value!='')isEmpty=false})
if(isEmpty){query(next).remove()}}}).on('change.mapChange',function(event){if(self.original==null){if(Object.keys(self.record).length>0){self.original=w2utils.clone(self.record)}else{self.original={}}}
let{current,previous,original}=self.getFieldValue(field.field)
let $cnt=query(event.target).closest('.w2ui-map-container')
if(field.type=='map')current._order=[]
$cnt.find('.w2ui-map.key').each(el=>{current._order.push(el.value)})
let edata=self.trigger('change',{target:field.field,field:field.field,originalEvent:event,value:{current,previous,original}})
if(edata.isCancelled===true){return}
if(field.type=='map'){current._order=current._order.filter(k=>k!=='')
delete current['']}
if(field.type=='array'){current=current.filter(k=>k!=='')}
if(query(event.target).parent().find('input').val()==''){keepFocus=event.target}
self.setValue(field.field,current)
field.el.mapRefresh(current,div)
edata.finish()})}})(this,field)}
this.setFieldValue(field.field,this.getValue(field.name))}
edata.finish()
this.resize()
return Date.now()-time}
render(box){let time=Date.now()
let self=this
if(typeof box=='string')box=query(box).get(0)
let edata=this.trigger('render',{target:this.name,box:box??this.box})
if(edata.isCancelled===true)return
if(box!=null){this.unmount()
this.box=box}
if(!this.isGenerated&&!this.formHTML)return
if(!this.box)return
let html='<div class="w2ui-form-box">'+
(this.header!==''?'<div class="w2ui-form-header">'+w2utils.lang(this.header)+'</div>':'')+'    <div id="form_'+this.name+'_toolbar" class="w2ui-form-toolbar" style="display: none"></div>'+'    <div id="form_'+this.name+'_tabs" class="w2ui-form-tabs" style="display: none"></div>'+
this.formHTML+'</div>'
query(this.box).attr('name',this.name).addClass('w2ui-reset w2ui-form').html(html)
if(query(this.box).length>0)query(this.box)[0].style.cssText+=this.style
w2utils.bindEvents(query(this.box).find('.w2ui-eaction'),this)
if(typeof this.toolbar.render!=='function'){this.toolbar=new w2toolbar(w2utils.extend({},this.toolbar,{name:this.name+'_toolbar',owner:this}))
this.toolbar.on('click',function(event){let edata=self.trigger('toolbar',{target:event.target,originalEvent:event})
if(edata.isCancelled===true)return
edata.finish()})}
if(typeof this.toolbar==='object'&&typeof this.toolbar.render==='function'){this.toolbar.render(query(this.box).find('#form_'+this.name+'_toolbar')[0])}
if(typeof this.tabs.render!=='function'){this.tabs=new w2tabs(w2utils.extend({},this.tabs,{name:this.name+'_tabs',owner:this,active:this.tabs.active}))
this.tabs.on('click',function(event){self.goto(this.get(event.target,true))})}
if(typeof this.tabs==='object'&&typeof this.tabs.render==='function'){this.tabs.render(query(this.box).find('#form_'+this.name+'_tabs')[0])
if(this.tabs.active)this.tabs.click(this.tabs.active)}
edata.finish()
this.resize()
let url=(typeof this.url!=='object'?this.url:this.url.get)
if(url&&this.recid!=null){this.request().catch(error=>this.refresh())}else{this.refresh()}
this.last.observeResize=new ResizeObserver(()=>{this.resize()})
this.last.observeResize.observe(this.box)
if(this.focus!=-1){let setCount=0
let setFocus=()=>{if(query(self.box).find('input, select, textarea').length>0){self.setFocus()}else{setCount++
if(setCount<20)setTimeout(setFocus,50)}}
setFocus()}
return Date.now()-time}
unmount(){super.unmount()
this.tabs?.unmount?.()
this.toolbar?.unmount?.()
this.last.observeResize?.disconnect()}
destroy(){let edata=this.trigger('destroy',{target:this.name})
if(edata.isCancelled===true)return
this.tabs?.destroy?.()
this.toolbar?.destroy?.()
if(query(this.box).find('#form_'+this.name+'_tabs').length>0){this.unmount()}
this.last.observeResize?.disconnect()
delete w2ui[this.name]
edata.finish()}
setFocus(focus){if(typeof focus==='undefined'){focus=this.focus}
let $input
if(w2utils.isInt(focus)){if(focus<0){return}
let inputs=query(this.box).find('div:not(.w2ui-field-helper) > input, select, textarea, div > label:nth-child(1) > [type=radio]').filter(':not(.file-input)')
while(inputs[focus].offsetParent==null&&inputs.length>=focus){focus++}
if(inputs[focus]){$input=query(inputs[focus])}}else if(typeof focus==='string'){$input=query(this.box).find(`[name='${focus}']`)}
if($input.length>0){$input.get(0).focus()}
return $input}}
class w2field extends w2base{constructor(type,options){super()
if(typeof type=='string'&&options==null){options={type:type}}
if(typeof type=='object'&&options==null){options=w2utils.clone(type)}
if(typeof type=='string'&&typeof options=='object'){options.type=type}
options.type=String(options.type).toLowerCase()
this.el=options.el??null
this.selected=null
this.helpers={}
this.type=options.type??'text'
this.options=w2utils.clone(options)
this.onClick=options.onClick??null
this.onAdd=options.onAdd??null
this.onNew=options.onNew??null
this.onRemove=options.onRemove??null
this.onMouseEnter=options.onMouseEnter??null
this.onMouseLeave=options.onMouseLeave??null
this.onScroll=options.onScroll??null
this.tmp={}
delete this.options.type
delete this.options.onClick
delete this.options.onMouseEnter
delete this.options.onMouseLeave
delete this.options.onScroll
if(this.el){this.render(this.el)}}
render(el){if(!(el instanceof HTMLElement)){console.log('ERROR: Cannot init w2field on empty subject')
return}
if(el._w2field){el._w2field.reset()}else{el._w2field=this}
this.el=el
this.init()}
init(){let options=this.options
let defaults
if(!['INPUT','TEXTAREA'].includes(this.el.tagName.toUpperCase())){console.log('ERROR: w2field could only be applied to INPUT or TEXTAREA.',this.el)
return}
switch(this.type){case'text':case'int':case'float':case'money':case'currency':case'percent':case'alphanumeric':case'bin':case'hex':{defaults={min:null,max:null,step:1,autoFormat:true,autoCorrect:true,currencyPrefix:w2utils.settings.currencyPrefix,currencySuffix:w2utils.settings.currencySuffix,currencyPrecision:w2utils.settings.currencyPrecision,decimalSymbol:w2utils.settings.decimalSymbol,groupSymbol:w2utils.settings.groupSymbol,arrow:false,keyboard:true,precision:null,prefix:'',suffix:''}
this.options=w2utils.extend({},defaults,options)
options=this.options
options.numberRE=new RegExp('['+options.groupSymbol+']','g')
options.moneyRE=new RegExp('['+options.currencyPrefix+options.currencySuffix+options.groupSymbol+']','g')
options.percentRE=new RegExp('['+options.groupSymbol+'%]','g')
if(['text','alphanumeric','hex','bin'].includes(this.type)){options.arrow=false
options.keyboard=false}
break}
case'color':{let size=parseInt(getComputedStyle(this.el)['font-size'])||12
defaults={prefix:'#',suffix:`<div style="width: ${size}px; height: ${size}px; margin-top: -2px;
                                    position: relative; top: 50%; transform: translateY(-50%);">&#160;</div>`,arrow:false,advanced:null,transparent:true}
this.options=w2utils.extend({},defaults,options)
options=this.options
break}
case'date':{defaults={format:w2utils.settings.dateFormat,keyboard:true,autoCorrect:true,start:null,end:null,blockDates:[],blockWeekdays:[],colored:{},btnNow:true}
this.options=w2utils.extend({type:'date'},defaults,options)
options=this.options
if(query(this.el).attr('placeholder')==null){query(this.el).attr('placeholder',options.format)}
break}
case'time':{defaults={format:w2utils.settings.timeFormat,keyboard:true,autoCorrect:true,start:null,end:null,btnNow:true,noMinutes:false}
this.options=w2utils.extend({type:'time'},defaults,options)
options=this.options
if(query(this.el).attr('placeholder')==null){query(this.el).attr('placeholder',options.format)}
break}
case'datetime':{defaults={format:w2utils.settings.dateFormat+'|'+w2utils.settings.timeFormat,keyboard:true,autoCorrect:true,start:null,end:null,startTime:null,endTime:null,blockDates:[],blockWeekdays:[],colored:{},btnNow:true,noMinutes:false}
this.options=w2utils.extend({type:'datetime'},defaults,options)
options=this.options
if(query(this.el).attr('placeholder')==null){query(this.el).attr('placeholder',options.placeholder||options.format)}
break}
case'list':case'combo':{defaults={items:[],selected:{},prefix:'',suffix:'',openOnFocus:false,icon:null,iconStyle:'',url:null,recId:null,recText:null,method:null,debounce:250,postData:{},minLength:1,cacheMax:250,maxDropHeight:350,maxDropWidth:null,minDropWidth:null,match:'begins',align:'both',altRows:true,renderDrop:null,compare:null,filter:true,hideSelected:false,markSearch:false,msgNoItems:'No matches',msgSearch:'Type to search...',onSearch:null,onRequest:null,onLoad:null,onError:null,}
if(typeof options.items=='function'){options._items_fun=options.items}
options.items=w2utils.normMenu.call(this,options.items)
if(this.type==='list'){query(this.el).addClass('w2ui-select')
if(!w2utils.isPlainObject(options.selected)&&Array.isArray(options.items)){options.items.forEach(item=>{if(item&&item.id===options.selected){options.selected=w2utils.clone(item)}})}}
options=w2utils.extend({},defaults,options)
let valid=['is','begins','contains','ends']
if(!valid.includes(options.match)){console.log(`ERROR: invalid value "${options.match}" for option.match. It should be one of following: ${valid.join(', ')}.`)}
this.options=options
if(!w2utils.isPlainObject(options.selected))options.selected={}
this.selected=options.selected
query(this.el).attr('autocapitalize','off').attr('autocomplete','off').attr('autocorrect','off').attr('spellcheck','false')
if(options.selected.text!=null){query(this.el).val(options.selected.text)}
break}
case'enum':{defaults={items:[],selected:[],max:0,maxItemWidth:250,style:'',openOnFocus:false,renderItem:null,onMouseEnter:null,onMouseLeave:null,onScroll:null,onClick:null,onAdd:null,onNew:null,onRemove:null,url:null,recId:null,recText:null,debounce:250,method:null,postData:{},minLength:1,cacheMax:250,match:'begins',align:'',altRows:true,renderDrop:null,maxDropHeight:350,maxDropWidth:null,markSearch:false,compare:null,filter:true,hideSelected:true,msgNoItems:'No matches',msgSearch:'Type to search...',onSearch:null,onRequest:null,onLoad:null,onError:null,}
options=w2utils.extend({},defaults,options,{suffix:''})
if(typeof options.items=='function'){options._items_fun=options.items}
let valid=['is','begins','contains','ends']
if(!valid.includes(options.match)){console.log(`ERROR: invalid value "${options.match}" for option.match. It should be one of following: ${valid.join(', ')}.`)}
options.items=w2utils.normMenu.call(this,options.items)
options.selected=w2utils.normMenu.call(this,options.selected)
this.options=options
if(!Array.isArray(options.selected))options.selected=[]
this.selected=options.selected
break}
case'file':{defaults={selected:[],max:0,maxSize:0,maxFileSize:0,maxItemWidth:250,maxDropHeight:350,maxDropWidth:null,readContent:true,silent:true,align:'both',altRows:true,renderItem:null,style:'',onClick:null,onAdd:null,onRemove:null,onMouseEnter:null,onMouseLeave:null}
options=w2utils.extend({},defaults,options)
this.options=options
if(!Array.isArray(options.selected))options.selected=[]
this.selected=options.selected
if(query(this.el).attr('placeholder')==null){query(this.el).attr('placeholder',w2utils.lang('Attach files by dragging and dropping or Click to Select'))}
break}
default:{console.log(`ERROR: field type "${this.type}" is not supported.`)
break}}
query(this.el).css('box-sizing','border-box').addClass('w2field w2ui-input').off('.w2field').on('change.w2field',(event)=>{this.change(event)}).on('click.w2field',(event)=>{this.click(event)}).on('focus.w2field',(event)=>{this.focus(event)}).on('blur.w2field',(event)=>{if(this.type!=='list')this.blur(event)}).on('keydown.w2field',(event)=>{this.keyDown(event)}).on('keyup.w2field',(event)=>{this.keyUp(event)})
this.addPrefix()
this.addSuffix()
this.addSearch()
this.addMultiSearch()
this.change(new Event('change'))}
get(){let ret
if(['list','enum','file'].indexOf(this.type)!==-1){ret=this.selected}else{ret=query(this.el).val()}
return ret}
set(val,append){if(['list','enum','file'].indexOf(this.type)!==-1){if(this.type!=='list'&&append){if(!Array.isArray(this.selected))this.selected=[]
this.selected.push(val)
let overlay=w2menu.get(this.el.id+'_menu')
if(overlay)overlay.options.selected=this.selected
query(this.el).trigger('input').trigger('change')}else{if(val==null)val=[]
let it=(this.type==='enum'&&!Array.isArray(val)?[val]:val)
this.selected=it
query(this.el).trigger('input').trigger('change')}
this.refresh()}else{query(this.el).val(val)}}
setIndex(ind,append){if(['list','enum'].indexOf(this.type)!==-1){let items=this.options.items
if(items&&items[ind]){if(this.type=='list'){this.selected=items[ind]}
if(this.type=='enum'){if(!append)this.selected=[]
this.selected.push(items[ind])}
let overlay=w2menu.get(this.el.id+'_menu')
if(overlay)overlay.options.selected=this.selected
query(this.el).trigger('input').trigger('change')
this.refresh()
return true}}
return false}
refresh(){let options=this.options
let time=Date.now()
let styles=getComputedStyle(this.el)
if(this.type=='color'){let color=this.el.value
if(color.substr(0,1)!='#'&&color.substr(0,3)!='rgb'){color='#'+color}
query(this.helpers.suffix).find(':scope > div').css('background-color',color)}
if(this.type=='list'){if(this.helpers.prefix)this.helpers.prefix.hide()
if(!this.helpers.search)return
if(this.selected==null&&options.icon){options.prefix=`
                    <span class="w2ui-icon ${options.icon} "style="cursor: pointer; font-size: 14px;
                        display: inline-block; margin-top: -1px; color: #7F98AD; ${options.iconStyle}">
                    </span>`
this.addPrefix()}else{options.prefix=''
this.addPrefix()}
let focus=query(this.helpers.search_focus)
let icon=query(focus[0].previousElementSibling)
focus.css({outline:'none'})
if(focus.val()===''){focus.css('opacity',0)
icon.css('opacity',0)
if(this.selected?.id){let text=this.selected.text
let ind=this.findItemIndex(options.items,this.selected.id)
if(text!=null){query(this.el).val(w2utils.lang(text)).data({selected:text,selectedIndex:ind[0]})}}else{this.el.value=''
query(this.el).removeData('selected selectedIndex')}}else{focus.css('opacity',1)
icon.css('opacity',1)
query(this.el).val('')
setTimeout(()=>{if(this.helpers.prefix)this.helpers.prefix.hide()
if(options.icon){focus.css('margin-left','17px')
query(this.helpers.search).find('.w2ui-icon-search').addClass('show-search')}else{focus.css('margin-left','0px')
query(this.helpers.search).find('.w2ui-icon-search').removeClass('show-search')}},1)}
if(query(this.el).prop('readOnly')||query(this.el).prop('disabled')){setTimeout(()=>{if(this.helpers.prefix)query(this.helpers.prefix).css('opacity','0.6')
if(this.helpers.suffix)query(this.helpers.suffix).css('opacity','0.6')},1)}else{setTimeout(()=>{if(this.helpers.prefix)query(this.helpers.prefix).css('opacity','1')
if(this.helpers.suffix)query(this.helpers.suffix).css('opacity','1')},1)}}
let div=this.helpers.multi
if(['enum','file'].includes(this.type)&&div){let html=''
if(Array.isArray(this.selected)){this.selected.forEach((it,ind)=>{if(it==null)return
html+=`
                        <div class="li-item" index="${ind}" style="max-width: ${parseInt(options.maxItemWidth)}px; ${it.style ? it.style : ''}">
                        ${
                            typeof options.renderItem === 'function'
                            ? options.renderItem(it, ind, `<div class="w2ui-list-remove"index="${ind}">&#160;&#160;</div>`)
                            : `
${it.icon?`<span class="w2ui-icon ${it.icon}"></span>`:''}<div class="w2ui-list-remove"index="${ind}">&#160;&#160;</div>${(this.type==='enum'?it.text:it.name)??it.id??it}
${it.size?`<span class="file-size"> - ${w2utils.formatSize(it.size)}</span>`:''}`
                        }
                        </div>`})}
let ul=div.find('.w2ui-multi-items')
if(options.style){div.attr('style',div.attr('style')+';'+options.style)}
query(this.el).css('z-index','-1')
if(query(this.el).prop('readOnly')||query(this.el).prop('disabled')){setTimeout(()=>{div[0].scrollTop=0
div.addClass('w2ui-readonly').find('.li-item').css('opacity','0.9').parent().find('.li-search').hide().find('input').prop('readOnly',true).closest('.w2ui-multi-items').find('.w2ui-list-remove').hide()},1)}else{setTimeout(()=>{div.removeClass('w2ui-readonly').find('.li-item').css('opacity','1').parent().find('.li-search').show().find('input').prop('readOnly',false).closest('.w2ui-multi-items').find('.w2ui-list-remove').show()},1)}
if(this.selected?.length>0){query(this.el).attr('placeholder','')}
div.find('.w2ui-enum-placeholder').remove()
ul.find('.li-item').remove()
if(html!==''){ul.prepend(html)}else if(query(this.el).attr('placeholder')!=null&&div.find('input').val()===''){let style=w2utils.stripSpaces(`
                    padding-top: ${styles['padding-top']};
                    padding-left: ${styles['padding-left']};
                    box-sizing: ${styles['box-sizing']};
                    line-height: ${styles['line-height']};
                    font-size: ${styles['font-size']};
                    font-family: ${styles['font-family']};
                `)
div.prepend(`<div class="w2ui-enum-placeholder" style="${style}">${query(this.el).attr('placeholder')}</div>`)}
div.off('.w2item').on('scroll.w2item',(event)=>{let edata=this.trigger('scroll',{target:this.el,originalEvent:event})
if(edata.isCancelled===true)return
w2tooltip.hide(this.el.id+'_preview')
edata.finish()}).find('.li-item').on('click.w2item',(event)=>{let target=query(event.target).closest('.li-item')
let index=target.attr('index')
let item=this.selected[index]
if(query(target).hasClass('li-search'))return
event.stopPropagation()
let edata
if(query(event.target).hasClass('w2ui-list-remove')){if(query(this.el).prop('readOnly')||query(this.el).prop('disabled'))return
edata=this.trigger('remove',{target:this.el,originalEvent:event,item})
if(edata.isCancelled===true)return
this.selected.splice(index,1)
query(this.el).trigger('input').trigger('change')
query(event.target).remove()}else{edata=this.trigger('click',{target:this.el,originalEvent:event.originalEvent,item})
if(edata.isCancelled===true)return
let preview=item.tooltip
if(this.type==='file'){if((/image/i).test(item.type)){preview=`
                                    <div class="w2ui-file-preview">
                                        <img src="${(item.content ? 'data:'+ item.type +';base64,'+ item.content : '')}"
                                            style="max-width: 300px">
                                    </div>`}
preview+=`
                                <div class="w2ui-file-info">
                                    <div class="file-caption">${w2utils.lang('Name')}:</div>
                                    <div class="file-value">${item.name}</div>
                                    <div class="file-caption">${w2utils.lang('Size')}:</div>
                                    <div class="file-value">${w2utils.formatSize(item.size)}</div>
                                    <div class="file-caption">${w2utils.lang('Type')}:</div>
                                    <div class="file-value file-type">${item.type}</div>
                                    <div class="file-caption">${w2utils.lang('Modified')}:</div>
                                    <div class="file-value">${w2utils.date(item.modified)}</div>
                                </div>`}
if(preview){let name=this.el.id+'_preview'
w2tooltip.show({name,anchor:target.get(0),html:preview,hideOn:['doc-click'],class:''}).show((event)=>{let $img=query(`#w2overlay-${name} img`)
$img.on('load',function(event){let w=this.clientWidth
let h=this.clientHeight
if(w<300&h<300)return
if(w>=h&&w>300)query(this).css('width','300px')
if(w<h&&h>300)query(this).css('height','300px')}).on('error',function(event){this.style.display='none'})})}
edata.finish()}}).on('mouseenter.w2item',(event)=>{let target=query(event.target).closest('.li-item')
if(query(target).hasClass('li-search'))return
let item=this.selected[query(event.target).attr('index')]
let edata=this.trigger('mouseEnter',{target:this.el,originalEvent:event,item})
if(edata.isCancelled===true)return
edata.finish()}).on('mouseleave.w2item',(event)=>{let target=query(event.target).closest('.li-item')
if(query(target).hasClass('li-search'))return
let item=this.selected[query(event.target).attr('index')]
let edata=this.trigger('mouseLeave',{target:this.el,originalEvent:event,item})
if(edata.isCancelled===true)return
edata.finish()})
if(this.type==='enum'){let search=this.helpers.multi.find('input')
search.css({width:'15px'})}else{this.helpers.multi.find('.li-search').hide()}
this.resize()}
return Date.now()-time}
resize(){let width=this.el.clientWidth
let styles=getComputedStyle(this.el)
let focus=this.helpers.search
let multi=this.helpers.multi
let suffix=this.helpers.suffix
let prefix=this.helpers.prefix
if(focus){query(focus).css('width',width)}
if(multi){query(multi).css('width',width-parseInt(styles['margin-left'],10)-parseInt(styles['margin-right'],10))}
if(suffix){this.addSuffix()}
if(prefix){this.addPrefix()}
let div=this.helpers.multi
if(['enum','file'].includes(this.type)&&div){query(this.el).css('height','')
let cntHeight=query(div).find(':scope div.w2ui-multi-items').get(0).clientHeight+5
if(cntHeight<20)cntHeight=20
if(cntHeight>this.tmp['max-height']){cntHeight=this.tmp['max-height']}
if(cntHeight<this.tmp['min-height']){cntHeight=this.tmp['min-height']}
let inpHeight=w2utils.getSize(this.el,'height')-2
if(inpHeight>cntHeight)cntHeight=inpHeight
query(div).css({'height':cntHeight+'px',overflow:(cntHeight==this.tmp['max-height']?'auto':'hidden')})
query(div).css('height',cntHeight+'px')
query(this.el).css({'height':cntHeight+'px'})}
this.tmp.current_width=width}
reset(){if(this.tmp!=null){query(this.el).css('height','')
Array('padding-left','padding-right','background-color','border-color').forEach(prop=>{if(this.tmp&&this.tmp['old-'+prop]!=null){query(this.el).css(prop,this.tmp['old-'+prop])
delete this.tmp['old-'+prop]}})
clearInterval(this.tmp.sizeTimer)}
query(this.el).val(this.clean(query(this.el).val())).removeClass('w2field w2ui-input').removeData('selected selectedIndex').off('.w2field')
Object.keys(this.helpers).forEach(key=>{query(this.helpers[key]).remove()})
this.helpers={}}
clean(val){if(typeof val==='number'){return val}
let options=this.options
val=String(val).trim()
if(['int','float','money','currency','percent'].includes(this.type)){if(typeof val==='string'){if(options.autoFormat){if(['money','currency'].includes(this.type)){val=String(val).replace(options.moneyRE,'')}
if(this.type==='percent'){val=String(val).replace(options.percentRE,'')}
if(['int','float'].includes(this.type)){val=String(val).replace(options.numberRE,'')}}
val=val.replace(/\s+/g,'').replace(new RegExp(options.groupSymbol,'g'),'').replace(options.decimalSymbol,'.')}
if(val!==''&&w2utils.isFloat(val))val=Number(val);else val=''}
return val}
format(val){let options=this.options
if(options.autoFormat&&val!==''){switch(this.type){case'money':case'currency':val=w2utils.formatNumber(val,options.currencyPrecision,true)
if(val!=='')val=options.currencyPrefix+val+options.currencySuffix
break
case'percent':val=w2utils.formatNumber(val,options.precision,true)
if(val!=='')val+='%'
break
case'float':val=w2utils.formatNumber(val,options.precision,true)
break
case'int':val=w2utils.formatNumber(val,0,true)
break}
let group=parseInt(1000).toLocaleString(w2utils.settings.locale,{useGrouping:true}).slice(1,2)
if(group!==this.options.groupSymbol){val=val.replaceAll(group,this.options.groupSymbol)}}
return val}
change(event){if(['int','float','money','currency','percent'].indexOf(this.type)!==-1){let val=query(this.el).val()
let new_val=this.format(this.clean(query(this.el).val()))
if(val!==''&&val!=new_val){query(this.el).val(new_val)
event.stopPropagation()
event.preventDefault()
return false}}
if(this.type==='color'){let color=query(this.el).val()
if(color.substr(0,3).toLowerCase()!=='rgb'){color='#'+color
let len=query(this.el).val().length
if(len!==8&&len!==6&&len!==3)color=''}
let next=query(this.el).get(0).nextElementSibling
query(next).find('div').css('background-color',color)
if(query(this.el).hasClass('has-focus')){this.updateOverlay()}}
if(['list','enum','file'].indexOf(this.type)!==-1){this.refresh()}
if(['date','time','datetime'].indexOf(this.type)!==-1){let tmp=parseInt(this.el.value)
if(w2utils.isInt(this.el.value)&&tmp>3000){if(this.type==='time')tmp=w2utils.formatTime(new Date(tmp),this.options.format)
if(this.type==='date')tmp=w2utils.formatDate(new Date(tmp),this.options.format)
if(this.type==='datetime')tmp=w2utils.formatDateTime(new Date(tmp),this.options.format)
query(this.el).val(tmp).trigger('input').trigger('change')}}}
click(event){if(['list','combo','enum'].includes(this.type)){if(!query(this.el).hasClass('has-focus')){this.focus(event)}
if(this.type=='list'||this.type=='combo'){if(!this.tmp.openedOnFocus){let name=this.el.id+'_menu'
let overlay=w2menu.get(name)
if(overlay?.displayed){w2menu.hide(name)}else{this.updateOverlay()}}
delete this.tmp.openedOnFocus
if(this.type=='list'){event.stopPropagation()}}}
if(['date','time','datetime','color'].includes(this.type)){this.updateOverlay()}}
focus(event){if(this.type=='list'&&document.activeElement==this.el){this.helpers.search_focus.focus()
return}
if(['color','date','time','datetime'].indexOf(this.type)!==-1){if(query(this.el).prop('readOnly')||query(this.el).prop('disabled'))return
this.updateOverlay()}
if(['list','combo','enum'].indexOf(this.type)!==-1){if(query(this.el).prop('readOnly')||query(this.el).prop('disabled')){query(this.el).addClass('has-focus')
return}
if(typeof this.options._items_fun=='function'){this.options.items=w2utils.normMenu.call(this,this.options._items_fun)}
if(this.helpers.search){let search=this.helpers.search_focus
search.value=''
search.select()}
if(this.type=='enum'){let search=query(this.el.previousElementSibling).find('.li-search input').get(0)
if(document.activeElement!==search){search.focus()}}
this.resize()
if(event.showMenu!==false&&(this.options.openOnFocus!==false||query(this.el).hasClass('has-focus'))&&!this.tmp.overlay?.overlay?.displayed){setTimeout(()=>{this.tmp.openedOnFocus=true
this.updateOverlay()},0)}}
if(this.type=='file'){let prev=query(this.el).get(0).previousElementSibling
query(prev).addClass('has-focus')}
query(this.el).addClass('has-focus')}
blur(event){let val=query(this.el).val().trim()
query(this.el).removeClass('has-focus')
if(['int','float','money','currency','percent'].includes(this.type)){if(val!==''){let newVal=val
let error=''
if(!this.isStrValid(val)){newVal=''}else{let rVal=this.clean(val)
if(this.options.min!=null&&rVal<this.options.min){newVal=this.options.min
error=`Should be >= ${this.options.min}`}
if(this.options.max!=null&&rVal>this.options.max){newVal=this.options.max
error=`Should be <= ${this.options.max}`}}
if(this.options.autoCorrect){query(this.el).val(newVal).trigger('input').trigger('change')
if(error){w2tooltip.show({name:this.el.id+'_error',anchor:this.el,html:error})
setTimeout(()=>{w2tooltip.hide(this.el.id+'_error')},3000)}}}}
if(['date','time','datetime'].includes(this.type)&&this.options.autoCorrect){if(val!==''){let check=this.type=='date'?w2utils.isDate:(this.type=='time'?w2utils.isTime:w2utils.isDateTime)
if(!w2date.inRange(this.el.value,this.options)||!check.bind(w2utils)(this.el.value,this.options.format)){query(this.el).val('').trigger('input').trigger('change')}}}
if(this.type==='enum'){query(this.helpers.multi).find('input').val('').css('width','15px')}
if(this.type=='file'){let prev=this.el.previousElementSibling
query(prev).removeClass('has-focus')}
if(this.type==='list'){this.el.value=this.selected?.text??''}}
keyDown(event,extra){let options=this.options
let key=event.keyCode||(extra&&extra.keyCode)
let cancel=false
let val,inc,daymil,dt,newValue,newDT
if(['int','float','money','currency','percent','hex','bin','color','alphanumeric'].includes(this.type)){if(!event.metaKey&&!event.ctrlKey&&!event.altKey){if(!this.isStrValid(event.key??'1',true)&&![9,8,13,27,37,38,39,40,46].includes(event.keyCode)){event.preventDefault()
if(event.stopPropagation)event.stopPropagation();else event.cancelBubble=true
return false}}}
if(['int','float','money','currency','percent'].includes(this.type)){if(!options.keyboard||query(this.el).prop('readOnly')||query(this.el).prop('disabled'))return
val=parseFloat(query(this.el).val().replace(options.moneyRE,''))||0
inc=options.step
if(event.ctrlKey||event.metaKey)inc=options.step*10
switch(key){case 38:if(event.shiftKey)break
newValue=(val+inc<=options.max||options.max==null?Number((val+inc).toFixed(12)):options.max)
query(this.el).val(newValue).trigger('input').trigger('change')
cancel=true
break
case 40:if(event.shiftKey)break
newValue=(val-inc>=options.min||options.min==null?Number((val-inc).toFixed(12)):options.min)
query(this.el).val(newValue).trigger('input').trigger('change')
cancel=true
break}
if(cancel){event.preventDefault()
this.moveCaret2end()}}
if(['date','datetime'].includes(this.type)){if(!options.keyboard||query(this.el).prop('readOnly')||query(this.el).prop('disabled'))return
let is=(this.type=='date'?w2utils.isDate:w2utils.isDateTime).bind(w2utils)
let format=(this.type=='date'?w2utils.formatDate:w2utils.formatDateTime).bind(w2utils)
daymil=24*60*60*1000
inc=1
if(event.ctrlKey||event.metaKey)inc=10
dt=is(query(this.el).val(),options.format,true)
if(!dt){dt=new Date();daymil=0}
switch(key){case 38:if(event.shiftKey)break
if(inc==10){dt.setMonth(dt.getMonth()+1)}else{dt.setTime(dt.getTime()+daymil)}
newDT=format(dt.getTime(),options.format)
query(this.el).val(newDT).trigger('input').trigger('change')
cancel=true
break
case 40:if(event.shiftKey)break
if(inc==10){dt.setMonth(dt.getMonth()-1)}else{dt.setTime(dt.getTime()-daymil)}
newDT=format(dt.getTime(),options.format)
query(this.el).val(newDT).trigger('input').trigger('change')
cancel=true
break}
if(cancel){event.preventDefault()
this.moveCaret2end()
this.updateOverlay()}}
if(this.type==='time'){if(!options.keyboard||query(this.el).prop('readOnly')||query(this.el).prop('disabled'))return
inc=(event.ctrlKey||event.metaKey?60:1)
val=query(this.el).val()
let time=w2date.str2min(val)||w2date.str2min((new Date()).getHours()+':'+((new Date()).getMinutes()-1))
switch(key){case 38:if(event.shiftKey)break
time+=inc
cancel=true
break
case 40:if(event.shiftKey)break
time-=inc
cancel=true
break}
if(cancel){event.preventDefault()
query(this.el).val(w2date.min2str(time)).trigger('input').trigger('change')
this.moveCaret2end()}}
if(['list','enum'].includes(this.type)){switch(key){case 8:case 46:if(this.type=='list'){let search=query(this.helpers.search_focus)
if(search.val()==''){this.selected=null
w2menu.hide(this.el.id+'_menu')
query(this.el).val('').trigger('input').trigger('change')}}else{let search=query(this.helpers.multi).find('input')
if(search.val()==''){w2menu.hide(this.el.id+'_menu')
this.selected.pop()
let overlay=w2menu.get(this.el.id+'_menu')
if(overlay)overlay.options.selected=this.selected
this.refresh()}}
break
case 9:case 16:break
case 27:w2menu.hide(this.el.id+'_menu')
this.refresh()
break
default:{}}}}
keyUp(event){if(this.type=='list'){let search=query(this.helpers.search_focus)
if(search.val()!==''){query(this.el).attr('placeholder','')}else{query(this.el).attr('placeholder',this.tmp.pholder)}
if(event.keyCode==13){setTimeout(()=>{search.val('')
w2menu.hide(this.el.id+'_menu')
this.refresh()},1)}
if([38,40].includes(event.keyCode)&&!this.tmp.overlay?.overlay?.displayed){this.updateOverlay()}
this.refresh()}
if(this.type=='combo'){if(![9,16,27].includes(event.keyCode)&&this.options.openOnFocus!==true){this.updateOverlay()}
if([38,40].includes(event.keyCode)&&!this.tmp.overlay?.overlay?.displayed){this.updateOverlay()}}
if(this.type=='enum'){let search=this.helpers.multi.find('input')
let styles=getComputedStyle(search.get(0))
let width=w2utils.getStrWidth(search.val(),`font-family: ${styles['font-family']}; font-size: ${styles['font-size']};`)
search.css({width:(width+15)+'px'})
this.resize()
if([38,40].includes(event.keyCode)&&!this.tmp.overlay?.overlay?.displayed){this.updateOverlay()}}}
findItemIndex(items,id,parents){let inds=[]
if(!parents)parents=[]
if(['list','combo','enum'].includes(this.type)&&this.options.url){let overlay=w2menu.get(this.el.id+'_menu')
if(overlay){items=overlay.options.items
this.options.items=items}}
items.forEach((item,ind)=>{if(item.id===id){inds=parents.concat([ind])
this.options.index=[ind]}
if(inds.length==0&&item.items&&item.items.length>0){parents.push(ind)
inds=this.findItemIndex(item.items,id,parents)
parents.pop()}})
return inds}
updateOverlay(indexOnly){let options=this.options
let params
if(this.type==='color'){if(query(this.el).prop('readOnly')||query(this.el).prop('disabled'))return
w2color.show(w2utils.extend({name:this.el.id+'_color',anchor:this.el,transparent:options.transparent,advanced:options.advanced,color:this.el.value,liveUpdate:true},this.options)).select(event=>{let color=event.detail.color
query(this.el).val(color).trigger('input').trigger('change')}).liveUpdate(event=>{let color=event.detail.color
query(this.helpers.suffix).find(':scope > div').css('background-color','#'+color)})}
if(['list','combo','enum'].includes(this.type)){let el=this.el
let input=this.el
if(this.type==='enum'){el=this.helpers.multi.get(0)
input=query(el).find('input').get(0)}
if(this.type==='list'){let sel=this.selected
if(w2utils.isPlainObject(sel)&&Object.keys(sel).length>0){let ind=this.findItemIndex(options.items,sel.id)
if(ind.length>0){options.index=ind}}
input=this.helpers.search_focus}
if(query(this.el).hasClass('has-focus')&&!this.el.readOnly&&!this.el.disabled){params=w2utils.extend({},options,{name:this.el.id+'_menu',anchor:input,selected:this.selected,search:false,render:options.renderDrop,anchorClass:'',offsetY:5,maxHeight:options.maxDropHeight,maxWidth:options.maxDropWidth,minWidth:options.minDropWidth})
this.tmp.overlay=w2menu.show(params).select(event=>{if(['list','combo'].includes(this.type)){this.selected=event.detail.item
query(input).val('')
query(this.el).val(this.selected.text).trigger('input').trigger('change')
this.focus({showMenu:false})}else{let selected=this.selected
let newItem=event.detail?.item
if(newItem){let edata=this.trigger('add',{target:this.el,item:newItem,originalEvent:event})
if(edata.isCancelled===true)return
if(selected.length>=options.max&&options.max>0)selected.pop()
delete newItem.hidden
selected.push(newItem)
query(this.el).trigger('input').trigger('change')
query(this.helpers.multi).find('input').val('')
let overlay=w2menu.get(this.el.id+'_menu')
if(overlay)overlay.options.selected=this.selected
edata.finish()}}})}}
if(['date','time','datetime'].includes(this.type)){if(query(this.el).prop('readOnly')||query(this.el).prop('disabled'))return
w2date.show(w2utils.extend({name:this.el.id+'_date',anchor:this.el,value:this.el.value,},this.options)).select(event=>{let date=event.detail.date
if(date!=null){query(this.el).val(date).trigger('input').trigger('change')}})}}
isStrValid(ch,loose){let isValid=true
switch(this.type){case'int':if(loose&&['-',this.options.groupSymbol].includes(ch)){isValid=true}else{isValid=w2utils.isInt(ch.replace(this.options.numberRE,''))}
break
case'percent':ch=ch.replace(/%/g,'')
case'float':if(loose&&['-','',this.options.decimalSymbol,this.options.groupSymbol].includes(ch)){isValid=true}else{isValid=w2utils.isFloat(ch.replace(this.options.numberRE,''))}
break
case'money':case'currency':if(loose&&['-',this.options.decimalSymbol,this.options.groupSymbol,this.options.currencyPrefix,this.options.currencySuffix].includes(ch)){isValid=true}else{isValid=w2utils.isFloat(ch.replace(this.options.moneyRE,''))}
break
case'bin':isValid=w2utils.isBin(ch)
break
case'color':case'hex':isValid=w2utils.isHex(ch)
break
case'alphanumeric':isValid=w2utils.isAlphaNumeric(ch)
break}
return isValid}
addPrefix(){if(!this.options.prefix){return}
let helper
let styles=getComputedStyle(this.el)
if(this.tmp['old-padding-left']==null){this.tmp['old-padding-left']=styles['padding-left']}
if(this.helpers.prefix)query(this.helpers.prefix).remove()
query(this.el).before(`<div class="w2ui-field-helper">${this.options.prefix}</div>`)
helper=query(this.el).get(0).previousElementSibling
query(helper).css({'color':styles.color,'font-family':styles['font-family'],'font-size':styles['font-size'],'height':this.el.clientHeight+'px','padding-top':parseInt(styles['padding-top'],10)+1+'px','padding-bottom':parseInt(styles['padding-bottom'],10)-1+'px','padding-left':this.tmp['old-padding-left'],'padding-right':0,'margin-top':(parseInt(styles['margin-top'],10))+'px','margin-bottom':(parseInt(styles['margin-bottom'],10))+'px','margin-left':styles['margin-left'],'margin-right':0,'z-index':1,'display':'flex','align-items':'center'})
query(this.el).css('padding-left',helper.clientWidth+'px !important')
this.helpers.prefix=helper}
addSuffix(){if(!this.options.suffix&&!this.options.arrow){return}
let helper
let self=this
let styles=getComputedStyle(this.el)
if(this.tmp['old-padding-right']==null){this.tmp['old-padding-right']=styles['padding-right']}
let pr=parseInt(styles['padding-right']||0)
if(this.options.arrow){if(this.helpers.arrow)query(this.helpers.arrow).remove()
query(this.el).after('<div class="w2ui-field-helper" style="border: 1px solid transparent">&#160;'+'    <div class="w2ui-field-up" type="up">'+'        <div class="arrow-up" type="up"></div>'+'    </div>'+'    <div class="w2ui-field-down" type="down">'+'        <div class="arrow-down" type="down"></div>'+'    </div>'+'</div>')
helper=query(this.el).get(0).nextElementSibling
query(helper).css({'color':styles.color,'font-family':styles['font-family'],'font-size':styles['font-size'],'height':this.el.clientHeight+'px','padding':0,'margin-top':(parseInt(styles['margin-top'],10)+1)+'px','margin-bottom':0,'border-left':'1px solid silver','width':'16px','transform':'translateX(-100%)'}).on('mousedown',function(event){if(query(event.target).hasClass('arrow-up')){self.keyDown(event,{keyCode:38})}
if(query(event.target).hasClass('arrow-down')){self.keyDown(event,{keyCode:40})}})
pr+=helper.clientWidth
query(this.el).css('padding-right',pr+'px !important')
this.helpers.arrow=helper}
if(this.options.suffix!==''){if(this.helpers.suffix)query(this.helpers.suffix).remove()
query(this.el).after(`<div class="w2ui-field-helper">${this.options.suffix}</div>`)
helper=query(this.el).get(0).nextElementSibling
query(helper).css({'color':styles.color,'font-family':styles['font-family'],'font-size':styles['font-size'],'height':this.el.clientHeight+'px','padding-top':styles['padding-top'],'padding-bottom':styles['padding-bottom'],'padding-left':0,'padding-right':styles['padding-right'],'margin-top':(parseInt(styles['margin-top'],10)+2)+'px','margin-bottom':(parseInt(styles['margin-bottom'],10)+1)+'px','transform':'translateX(-100%)'})
query(this.el).css('padding-right',helper.clientWidth+'px !important')
this.helpers.suffix=helper}}
addSearch(){if(this.type!=='list')return
if(this.helpers.search)query(this.helpers.search).remove()
let tabIndex=parseInt(query(this.el).attr('tabIndex'))
if(!isNaN(tabIndex)&&tabIndex!==-1)this.tmp['old-tabIndex']=tabIndex
if(this.tmp['old-tabIndex'])tabIndex=this.tmp['old-tabIndex']
if(tabIndex==null||isNaN(tabIndex))tabIndex=0
let searchId=''
if(query(this.el).attr('id')!=null){searchId='id="'+query(this.el).attr('id')+'_search"'}
let html=`
            <div class="w2ui-field-helper">
                <span class="w2ui-icon w2ui-icon-search"></span>
                <input ${searchId} type="text" tabIndex="${tabIndex}" autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false"/>
            </div>`
query(this.el).attr('tabindex',-1).before(html)
let helper=query(this.el).get(0).previousElementSibling
this.helpers.search=helper
this.helpers.search_focus=query(helper).find('input').get(0)
let styles=getComputedStyle(this.el)
query(helper).css({width:this.el.clientWidth+'px','margin-top':styles['margin-top'],'margin-left':styles['margin-left'],'margin-bottom':styles['margin-bottom'],'margin-right':styles['margin-right']}).find('input').css({cursor:'default',width:'100%',opacity:1,padding:styles.padding,margin:styles.margin,border:'1px solid transparent','background-color':'transparent'})
query(helper).find('input').off('.helper').on('focus.helper',event=>{query(event.target).val('')
this.tmp.pholder=query(this.el).attr('placeholder')??''
this.focus(event)
event.stopPropagation()}).on('blur.helper',event=>{query(event.target).val('')
if(this.tmp.pholder!=null)query(this.el).attr('placeholder',this.tmp.pholder)
this.blur(event)
event.stopPropagation()}).on('keydown.helper',event=>{this.keyDown(event)}).on('keyup.helper',event=>{this.keyUp(event)})
query(helper).on('click',event=>{query(event.target).find('input').focus()})}
addMultiSearch(){if(!['enum','file'].includes(this.type)){return}
query(this.helpers.multi).remove()
let html=''
let styles=getComputedStyle(this.el)
let margin=w2utils.stripSpaces(`
            margin-top: 0px;
            margin-bottom: 0px;
            margin-left: ${styles['margin-left']};
            margin-right: ${styles['margin-right']};
            width: ${(w2utils.getSize(this.el, 'width') - parseInt(styles['margin-left'], 10)
                                - parseInt(styles['margin-right'], 10))}px;
        `)
if(this.tmp['min-height']==null){let min=this.tmp['min-height']=parseInt((styles['min-height']!='none'?styles['min-height']:0)||0)
let current=parseInt(styles.height)
this.tmp['min-height']=Math.max(min,current)}
if(this.tmp['max-height']==null&&styles['max-height']!='none'){this.tmp['max-height']=parseInt(styles['max-height'])}
let searchId=''
if(query(this.el).attr('id')!=null){searchId=`id="${query(this.el).attr('id')}_search"`}
let tabIndex=parseInt(query(this.el).attr('tabIndex'))
if(!isNaN(tabIndex)&&tabIndex!==-1)this.tmp['old-tabIndex']=tabIndex
if(this.tmp['old-tabIndex'])tabIndex=this.tmp['old-tabIndex']
if(tabIndex==null||isNaN(tabIndex))tabIndex=0
if(this.type==='enum'){html=`
            <div class="w2ui-field-helper w2ui-list" style="${margin}">
                <div class="w2ui-multi-items">
                    <div class="li-search">
                        <input ${searchId} type="text" autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false"
                            tabindex="${tabIndex}"
                            ${query(this.el).prop('readOnly') ? 'readonly': '' }
                            ${query(this.el).prop('disabled') ? 'disabled': '' }>
                    </div>
                </div>
            </div>`}
if(this.type==='file'){html=`
            <div class="w2ui-field-helper w2ui-list" style="${margin}">
                <div class="w2ui-multi-file">
                    <input name="attachment" class="file-input" type="file" tabindex="-1"'
                        style="width: 100%; height: 100%; opacity: 0" title=""
                        ${this.options.max !== 1 ? 'multiple' : ''}
                        ${query(this.el).prop('readOnly') || query(this.el).prop('disabled') ? 'disabled': ''}
                        ${query(this.el).attr('accept') ? ' accept="'+ query(this.el).attr('accept') +'"': ''}>
                </div>
                <div class="w2ui-multi-items">
                    <div class="li-search" style="display: none">
                        <input ${searchId} type="text" autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false"
                            tabindex="${tabIndex}"
                            ${query(this.el).prop('readOnly') ? 'readonly': '' }
                            ${query(this.el).prop('disabled') ? 'disabled': '' }>
                    </div>
                </div>
            </div>`}
this.tmp['old-background-color']=styles['background-color']
this.tmp['old-border-color']=styles['border-color']
query(this.el).before(html).css({'border-color':'transparent','background-color':'transparent'})
let div=query(this.el.previousElementSibling)
this.helpers.multi=div
query(this.el).attr('tabindex',-1)
div.on('click',event=>{this.focus(event)})
div.find('input:not(.file-input)').on('click',event=>{this.click(event)}).on('focus',event=>{this.focus(event)}).on('blur',event=>{this.blur(event)}).on('keydown',event=>{this.keyDown(event)}).on('keyup',event=>{this.keyUp(event)})
if(this.type==='file'){div.find('input.file-input').off('.drag').on('click.drag',(event)=>{event.stopPropagation()
if(query(this.el).prop('readOnly')||query(this.el).prop('disabled'))return
this.focus(event)}).on('dragenter.drag',(event)=>{if(query(this.el).prop('readOnly')||query(this.el).prop('disabled'))return
div.addClass('w2ui-file-dragover')}).on('dragleave.drag',(event)=>{if(query(this.el).prop('readOnly')||query(this.el).prop('disabled'))return
div.removeClass('w2ui-file-dragover')}).on('drop.drag',(event)=>{if(query(this.el).prop('readOnly')||query(this.el).prop('disabled'))return
div.removeClass('w2ui-file-dragover')
let files=Array.from(event.dataTransfer.files)
files.forEach(file=>{this.addFile(file)})
this.focus(event)
event.preventDefault()
event.stopPropagation()}).on('dragover.drag',(event)=>{event.preventDefault()
event.stopPropagation()}).on('change.drag',(event)=>{if(typeof event.target.files!=='undefined'){Array.from(event.target.files).forEach(file=>{this.addFile(file)})}
this.focus(event)})}
this.refresh()}
addFile(file){let options=this.options
let selected=this.selected
let newItem={name:file.name,type:file.type,modified:file.lastModifiedDate,size:file.size,content:null,file:file}
let size=0
let cnt=0
let errors=[]
if(Array.isArray(selected)){selected.forEach(item=>{if(item.name==file.name&&item.size==file.size){errors.push(w2utils.lang('The file "${name}" (${size}) is already added.',{name:file.name,size:w2utils.formatSize(file.size)}))}
size+=item.size
cnt++})}
if(options.maxFileSize!==0&&newItem.size>options.maxFileSize){errors.push(w2utils.lang('Maximum file size is ${size}',{size:w2utils.formatSize(options.maxFileSize)}))}
if(options.maxSize!==0&&size+newItem.size>options.maxSize){errors.push(w2utils.lang('Maximum total size is ${size}',{size:w2utils.formatSize(options.maxSize)}))}
if(options.max!==0&&cnt>=options.max){errors.push(w2utils.lang('Maximum number of files is ${count}',{count:options.max}))}
let edata=this.trigger('add',{target:this.el,file:newItem,total:cnt,totalSize:size,errors})
if(edata.isCancelled===true)return
if(options.silent!==true&&errors.length>0){w2tooltip.show({anchor:this.el,html:'Errors: '+errors.join('<br>')})
console.log('ERRORS (while adding files): ',errors)
return}
selected.push(newItem)
if(typeof FileReader!=='undefined'&&options.readContent===true){let reader=new FileReader()
let self=this
reader.onload=(function onload(){return function closure(event){let fl=event.target.result
let ind=fl.indexOf(',')
newItem.content=fl.substr(ind+1)
self.refresh()
query(self.el).trigger('input').trigger('change')
edata.finish()}})()
reader.readAsDataURL(file)}else{this.refresh()
query(this.el).trigger('input').trigger('change')
edata.finish()}}
moveCaret2end(){setTimeout(()=>{this.el.setSelectionRange(this.el.value.length,this.el.value.length)},0)}}
class w2window extends w2base{constructor(options){if(!options.name)options.name='w2w-'+Math.random().toString(36).slice(2,7)
super(options.name)
this.defaults={title:'',text:'',body:'',buttons:'',x:300,y:20,width:600,height:500,focus:null,actions:null,style:'',modal:false,maximized:false,keyboard:true,showClose:true,showMax:false,openMaximized:false,center:false,resizable:true}
this.status='opening'
this.onOpen=null
this.onClose=null
this.onMax=null
this.onMin=null
this.onToggle=null
this.onKeydown=null
this.onAction=null
this.onMove=null
this.name=options.name
if(!this.box){this.box='#'+this.name}
if(query(this.box)&&query(this.box).hasClass('w2ui-window')){console.log(`w2window already exists: ${this.box}`)
return}
if(options.text!=null)options.body=`<div class="w2ui-centered w2ui-msg-text">${options.text}</div>`
options=Object.assign({},this.defaults,{title:'',body:''},options,{maximized:false})
this.options=options
this.handleResize=(event)=>{let rect={x:options.x,y:options.y,width:options.width,height:options.height}
rect=this.do_fix_dimension_to_screen(rect.x,rect.y,rect.width,rect.height)
if(this.options.center)
rect=this.do_center(rect.x,rect.y,rect.width,rect.height)
this.resize(rect.x,rect.y,rect.width,rect.height)}
this.render(options)}
render(options){let self=this
if(typeof this.box=='string'){this.box=query(this.box).get(0)}
let rect=this.do_fix_dimension_to_screen(options.x,options.y,options.width,options.height)
if(this.options.center)
rect=this.do_center(rect.x,rect.y,rect.width,rect.height)
this.resize(rect.x,rect.y,rect.width,rect.height)
let styles=`
            left: ${rect.x}px;
            top: ${rect.y}px;
            width: ${rect.width}px;
            height: ${rect.height}px;
        `
let msg,id
if(!this.box){id=this.name
msg=`<div id="${id}" class="w2ui-window" style="${w2utils.stripSpaces(styles)}"></div>`
query('body').append(msg)
this.box=query('#'+id).get(0)}else{this.box.style.cssText=w2utils.stripSpaces(styles)
this.box.addClass('w2ui-window')}
if(!this.box){console.log('w2window: no container')
return}
Object.keys(options).forEach(key=>{if(key.startsWith('on')&&key!='on'&&options[key]){this[key]=options[key]}})
if(options.actions!=null&&!options.buttons){options.buttons=''
Object.keys(options.actions).forEach((action)=>{let handler=options.actions[action]
let btnAction=action
if(typeof handler=='function'){options.buttons+=`<button class="w2ui-btn w2ui-eaction" data-click='["action","${action}","event"]'>${action}</button>`}
if(typeof handler=='object'){options.buttons+=`<button class="w2ui-btn w2ui-eaction ${handler.class || ''}" name="${action}" data-click='["action","${action}","event"]'
                        style="${handler.style}" ${handler.attrs}>${handler.text || action}</button>`
btnAction=Array.isArray(options.actions)?handler.text:action}
if(typeof handler=='string'){options.buttons+=`<button class="w2ui-btn w2ui-eaction" data-click='["action","${handler}","event"]'>${handler}</button>`
btnAction=handler}
if(typeof btnAction=='string'){btnAction=btnAction[0].toLowerCase()+btnAction.substr(1).replace(/\s+/g,'')}})}
let edata=this.trigger('open',{target:'window',present:false})
if(edata.isCancelled===true)return
this.status='opening'
if(options.modal){w2utils.lock(document.body,{onClick:null})}
let btn=''
if(options.showClose){btn+=`<div class="w2ui-window-button w2ui-window-close">
                        <span class="w2ui-xicon w2ui-icon-cross w2ui-eaction" data-pointerdown="stop" data-click="close"></span>
                    </div>`}
if(options.showMax){btn+=`<div class="w2ui-window-button w2ui-window-max">
                        <span class="w2ui-xicon w2ui-icon-box w2ui-eaction" data-pointerdown="stop" data-click="toggle"></span>
                    </div>`}
styles=`${!options.title ? 'top: 0px !important;' : ''} ${!options.buttons ? 'bottom: 0px !important;' : ''}`
msg=`
            <span name="hidden-first" tabindex="0" style="position: absolute; top: -100px"></span>
            <div class="w2ui-window-title" style="${!options.title ? 'display: none' : ''}">${btn}</div>
            <div class="w2ui-box" style="${styles}">
                <div class="w2ui-window-body ${!options.title || ' w2ui-window-no-title'}
                    ${!options.buttons || ' w2ui-window-no-buttons'}" style="${options.style}">
                </div>
            </div>
            <div class="w2ui-window-buttons" style="${!options.buttons ? 'display: none' : ''}"></div>
            <div class="w2ui-window-button w2ui-window-resize" style="${!options.resizable ? 'display: none' : ''}">
                <span class="w2ui-xicon w2ui-icon-resize"></span>
            </div>
            <span name="hidden-last" tabindex="0" style="position: absolute; top: -100px"></span>
        `
query(this.box).html(msg)
if(options.title)query(this.box).find('.w2ui-window-title').append(w2utils.lang(options.title))
if(options.buttons)query(this.box).find('.w2ui-window-buttons').append(options.buttons)
if(options.body)query(this.box).find('.w2ui-window-body').append(options.body)
w2utils.bindEvents(query(this.box).find('.w2ui-eaction'),this)
query(this.box).find('.w2ui-window-body').show()
this.status='open'
self.setFocus(options.focus)
edata.finish()
if(options.openMaximized){this.max()}
options._last_focus=document.activeElement
if(options.keyboard){query(document.body).on('keydown',(event)=>{this.keydown(event)})}
query(window).on('resize',this.handleResize)
let tmp_move={moving:false,mvMove:mvMove,mvStop:mvStop}
query(this.box).find('.w2ui-window-title').on('pointerdown',function(event){if(!self.options.maximized)mvStart(event)})
let tmp_resize={resizing:false,rsMove:rsMove,rsStop:rsStop}
query(this.box).find('.w2ui-window-resize').on('pointerdown',function(event){if(!self.options.maximized)rsStart(event)})
return
function mvStart(evt){if(!evt)evt=window.event
self.status='moving'
let window_rect=query(self.box).get(0).getBoundingClientRect()
Object.assign(tmp_move,{moving:true,x:evt.screenX,y:evt.screenY,pos_x:window_rect.x,pos_y:window_rect.y,})
query(document.body).on('pointermove.w2ui-window',tmp_move.mvMove).on('pointerup.w2ui-window',tmp_move.mvStop)
if(evt.stopPropagation)evt.stopPropagation();else evt.cancelBubble=true
if(evt.preventDefault)evt.preventDefault();else return false}
function mvMove(evt){if(tmp_move.moving!=true)return
if(!evt)evt=window.event
tmp_move.div_x=evt.screenX-tmp_move.x
tmp_move.div_y=evt.screenY-tmp_move.y
let window_rect=query(self.box).get(0).getBoundingClientRect()
let edata=self.trigger('moving',{target:'window',window_rect:window_rect,originalEvent:evt})
if(edata.isCancelled===true)return
query(self.box).css({'transition':'none','transform':'translate3d('+tmp_move.div_x+'px, '+tmp_move.div_y+'px, 0px)'})
self.options.center=false
edata.finish()}
function mvStop(evt){if(tmp_move.moving!=true)return
if(!evt)evt=window.event
self.status='open'
tmp_move.div_x=(evt.screenX-tmp_move.x)
tmp_move.div_y=(evt.screenY-tmp_move.y)
let x=tmp_move.pos_x+tmp_move.div_x
let y=tmp_move.pos_y+tmp_move.div_y
query(self.box).css({'left':x+'px','top':y+'px'}).css({'transition':'none','transform':'translate3d(0px, 0px, 0px)'})
tmp_move.moving=false
query(document.body).off('.w2ui-window')
let window_rect=query(self.box).get(0).getBoundingClientRect()
self.options.x=window_rect.x
self.options.y=window_rect.y
self.options.width=window_rect.width
self.options.height=window_rect.height
let edata=self.trigger('moved',{target:'window',window_rect:window_rect,originalEvent:evt})
edata.finish()}
function rsStart(evt){if(!evt)evt=window.event
self.status='resizing'
let window_rect=query(self.box).get(0).getBoundingClientRect()
Object.assign(tmp_resize,{resizing:true,width:window_rect.width,height:window_rect.height,pageX:evt.pageX,pageY:evt.pageY,rel_w:0,rel_h:0,})
query(document.body).on('pointermove.w2ui-window',tmp_resize.rsMove).on('pointerup.w2ui-window',tmp_resize.rsStop)
if(evt.stopPropagation)evt.stopPropagation();else evt.cancelBubble=true
if(evt.preventDefault)evt.preventDefault();else return false}
function rsMove(evt){if(tmp_resize.resizing!=true)return
if(!evt)evt=window.event
tmp_resize.rel_w=evt.pageX-tmp_resize.pageX
tmp_resize.rel_h=evt.pageY-tmp_resize.pageY
let window_rect=query(self.box).get(0).getBoundingClientRect()
let edata=self.trigger('resizing',{target:'window',window_rect:window_rect,originalEvent:evt})
if(edata.isCancelled===true)return
query(self.box).css({'width':(tmp_resize.width+tmp_resize.rel_w)+'px','height':(tmp_resize.height+tmp_resize.rel_h)+'px',})
self.options.center=false
edata.finish()}
function rsStop(evt){if(tmp_resize.resizing!=true)return
if(!evt)evt=window.event
self.status='open'
tmp_resize.rel_w=evt.pageX-tmp_resize.pageX
tmp_resize.rel_h=evt.pageY-tmp_resize.pageY
query(self.box).css({'width':(tmp_resize.width+tmp_resize.rel_w)+'px','height':(tmp_resize.height+tmp_resize.rel_h)+'px',})
query(document.body).off('.w2ui-window')
let window_rect=query(self.box).get(0).getBoundingClientRect()
self.options.x=window_rect.x
self.options.y=window_rect.y
self.options.width=window_rect.width
self.options.height=window_rect.height
let body_rect=query(self.box).find('.w2ui-window-body').get(0).getBoundingClientRect()
let edata=self.trigger('resized',{target:'window',window_rect:window_rect,body_rect:body_rect,originalEvent:evt})
edata.finish()}}
destroy(){this.close()}
close(){let edata=this.trigger('close',{target:'window'})
if(edata.isCancelled===true)return
query(this.box).remove()
if(this.options._last_focus&&this.options._last_focus.length>0)this.options._last_focus.focus()
this.status='destroyed'
edata.finish()
if(this.options.keyboard){query(document.body).off('keydown',this.keydown)}
query(window).off('resize',this.handleResize)
w2utils.unlock(document.body,0)
delete w2ui[this.name]}
get_container(){return query(this.box).find('.w2ui-window-body')}
load(options){return new Promise((resolve,reject)=>{if(typeof options=='string'){options={url:options}}
if(options.url==null){console.log('ERROR: The url is not defined.')
reject('The url is not defined')
return}
this.status='loading'
let[url,selector]=String(options.url).split('#')
if(url){fetch(url).then(res=>res.text()).then(html=>{resolve(this.template(html,selector,options))})}})}
template(data,id,options={}){let html
try{html=query(data)}catch(e){html=query.html(data)}
if(id)html=html.filter('#'+id)
Object.assign(options,{width:parseInt(query(html).css('width')),height:parseInt(query(html).css('height')),title:query(html).find('[rel=title]').html(),body:query(html).find('[rel=body]').html(),buttons:query(html).find('[rel=buttons]').html(),style:query(html).find('[rel=body]').get(0).style.cssText,})
return this.open(options)}
action(action,event){let click=this.options.actions[action]
if(click instanceof Object&&click.onClick)click=click.onClick
let edata=this.trigger('action',{action,target:'window',self:this,originalEvent:event,value:this.input?this.input.value:null})
if(edata.isCancelled===true)return
if(typeof click==='function')click.call(this,event)
edata.finish()}
keydown(event){if(this.options&&!this.options.keyboard)return
let edata=this.trigger('keydown',{target:'window',originalEvent:event})
if(edata.isCancelled===true)return
switch(event.keyCode){case 27:event.preventDefault()
this.destroy()
break}
edata.finish()}
toggle(){let edata=this.trigger('toggle',{target:'window'})
if(edata.isCancelled===true)return
if(this.options.maximized===true)this.min();else this.max()
edata.finish()}
max(){if(this.options.maximized===true)return
let edata=this.trigger('max',{target:'window'})
if(edata.isCancelled===true)return
this.status='resizing'
this.prevSize=query(this.box).get(0).getBoundingClientRect()
let rect=this.do_fix_dimension_to_screen(0,0,10000,10000)
if(this.options.center)
rect=this.do_center(rect.x,rect.y,rect.width,rect.height)
this.resize(rect.x,rect.y,rect.width,rect.height,()=>{this.status='open'
this.options.maximized=true
edata.finish()})}
min(){if(this.options.maximized!==true)return
let rect=this.prevSize
let edata=this.trigger('min',{target:'window'})
if(edata.isCancelled===true)return
this.status='resizing'
rect=this.do_fix_dimension_to_screen(rect.x,rect.y,rect.width,rect.height)
if(this.options.center)
rect=this.do_center(rect.x,rect.y,rect.width,rect.height)
this.options.maximized=false
this.resize(parseInt(rect.x),parseInt(rect.y),parseInt(rect.width),parseInt(rect.height),()=>{this.status='open'
this.prevSize=null
edata.finish()})}
resize(x,y,width,height,callBack){let self=this
query(this.box).css({'top':y+'px','left':x+'px','width':width+'px','height':height+'px'})
self.resizeMessages()
if(typeof callBack=='function')callBack()}
resizeMessages(){query(this.box).find('.w2ui-message').each(msg=>{let mopt=msg._msg_options
let window=query(this.box)
if(parseInt(mopt.width)<10)mopt.width=10
if(parseInt(mopt.height)<10)mopt.height=10
let rect=window[0].getBoundingClientRect()
let titleHeight=parseInt(window.find('.w2ui-window-title')[0].clientHeight)
let pWidth=parseInt(rect.width)
let pHeight=parseInt(rect.height)
mopt.width=mopt.originalWidth
if(mopt.width>pWidth-10){mopt.width=pWidth-10}
mopt.height=mopt.originalHeight
if(mopt.height>pHeight-titleHeight-5){mopt.height=pHeight-titleHeight-5}
if(mopt.originalHeight<0)mopt.height=pHeight+mopt.originalHeight-titleHeight
if(mopt.originalWidth<0)mopt.width=pWidth+mopt.originalWidth*2
query(msg).css({left:((pWidth-mopt.width)/2)+'px',width:mopt.width+'px',height:mopt.height+'px'})})}
do_fix_dimension_to_screen(x,y,width,height){let maxW,maxH
if(window.innerHeight==undefined){maxW=document.documentElement.offsetWidth
maxH=document.documentElement.offsetHeight}else{maxW=window.innerWidth
maxH=window.innerHeight}
if(maxW>width){if(x+width>maxW){x=maxW-width}}else if(maxW<=width){x=0
width=maxW}
if(maxH>height){if(y+height>maxH){y=maxH-height}}else if(maxH<=height){y=0
height=maxH}
return{x,y,width,height}}
do_center(x,y,width,height){let maxW,maxH
if(window.innerHeight==undefined){maxW=document.documentElement.offsetWidth
maxH=document.documentElement.offsetHeight}else{maxW=window.innerWidth
maxH=window.innerHeight}
if(maxW>width){x=(maxW-width)/2}else if(maxW<=width){x=0}
if(maxH>height){y=(maxH-height)/2}else if(maxH<=height){y=0}
return{x,y,width,height}}
clear(){query(this.box).find('.w2ui-window-title').html('')
query(this.box).find('.w2ui-window-body').html('')
query(this.box).find('.w2ui-window-buttons').html('')}
setFocus(focus){let box=query(this.box)
let sel='input, button, select, textarea, [contentEditable], .w2ui-input'
if(focus!=null){let el=isNaN(focus)?box.find(sel).filter(focus).get(0):box.find(sel).get(focus)
el?.focus()}else{let el=box.find('[name=hidden-first]').get(0)
if(el)el.focus()}
query(box).find(sel+',[name=hidden-first],[name=hidden-last]').off('.keep-focus').on('blur.keep-focus',function(event){setTimeout(()=>{let focus=document.activeElement
let inside=query(box).find(sel).filter(focus).length>0
let name=query(focus).attr('name')
if(!inside&&focus&&focus!==document.body){query(box).find(sel).get(0)?.focus()}
if(name=='hidden-last'){query(box).find(sel).get(0)?.focus()}
if(name=='hidden-first'){query(box).find(sel).get(-1)?.focus()}},1)})}}
(function($){let w2globals=function(){(function(win,obj){Object.keys(obj).forEach(key=>{win[key]=obj[key]})})(window,{w2ui,w2utils,query,w2locale,w2event,w2base,w2popup,w2alert,w2confirm,w2prompt,Dialog,w2window,w2tooltip,w2menu,w2color,w2date,Tooltip,w2toolbar,w2sidebar,w2tabs,w2layout,w2grid,w2form,w2field})}
let param=String(undefined).split('?')[1]||''
if(param=='globals'||param.substr(0,8)=='globals='){w2globals()}
if(!$)return
$.w2globals=w2globals
$.fn.w2render=function(name){if($(this).length>0){if(typeof name==='string'&&w2ui[name])w2ui[name].render($(this)[0])
if(typeof name==='object')name.render($(this)[0])}}
$.fn.w2destroy=function(name){if(!name&&this.length>0)name=this.attr('name')
if(typeof name==='string'&&w2ui[name])w2ui[name].destroy()
if(typeof name==='object')name.destroy()}
$.fn.w2field=function(type,options){if(arguments.length===0){let obj=$(this).data('w2field')
return obj}
return this.each((index,el)=>{let obj=$(el).data('w2field')
if(obj==null){obj=new w2field(type,options)
obj.render(el)
return obj}else{obj=new w2field(type,options)
obj.render(el)
return obj}
return null})}
$.fn.w2form=function(options){return proc.call(this,options,'w2form')}
$.fn.w2grid=function(options){return proc.call(this,options,'w2grid')}
$.fn.w2layout=function(options){return proc.call(this,options,'w2layout')}
$.fn.w2sidebar=function(options){return proc.call(this,options,'w2sidebar')}
$.fn.w2tabs=function(options){return proc.call(this,options,'w2tabs')}
$.fn.w2toolbar=function(options){return proc.call(this,options,'w2toolbar')}
function proc(options,type){if($.isPlainObject(options)){let obj
if(type=='w2form'){obj=new w2form(options)
if(this.find('.w2ui-field').length>0){obj.formHTML=this.html()}}
if(type=='w2grid')obj=new w2grid(options)
if(type=='w2layout')obj=new w2layout(options)
if(type=='w2sidebar')obj=new w2sidebar(options)
if(type=='w2tabs')obj=new w2tabs(options)
if(type=='w2toolbar')obj=new w2toolbar(options)
if($(this).length!==0){obj.render(this[0])}
return obj}else{let obj=w2ui[$(this).attr('name')]
if(!obj)return null
if(arguments.length>0){if(obj[options])obj[options].apply(obj,Array.prototype.slice.call(arguments,1))
return this}else{return obj}}}
$.fn.w2popup=function(options){if(this.length>0){w2popup.template(this[0],null,options)}else if(options.url){w2popup.load(options)}}
$.fn.w2marker=function(){let str=Array.from(arguments)
if(Array.isArray(str[0]))str=str[0]
return $(this).each((index,el)=>{w2utils.marker(el,str)})}
$.fn.w2tag=function(text,options){return this.each((index,el)=>{if(text==null&&options==null){w2tooltip.hide()
return}
if(typeof text=='object'){options=text}else{options=options??{}
options.html=text}
w2tooltip.show(el,options)})}
$.fn.w2overlay=function(html,options){return this.each((index,el)=>{if(html==null&&options==null){w2tooltip.hide()
return}
if(typeof html=='object'){options=html}else{options.html=html}
Object.assign(options,{class:'w2ui-white',hideOn:['doc-click']})
w2tooltip.show(el,options)})}
$.fn.w2menu=function(menu,options){return this.each((index,el)=>{if(typeof menu=='object'){options=menu}
if(typeof menu=='object'){options=menu}else{options.items=menu}
w2menu.show(el,options)})}
$.fn.w2color=function(options,callBack){return this.each((index,el)=>{let tooltip=w2color.show(el,options)
if(typeof callBack=='function'){tooltip.select(callBack)}})}})(window.jQuery)
!(function(global,w2ui){if(typeof define=='function'&&define.amd){return define(()=>w2ui)}
if(typeof exports!='undefined'){if(typeof module!='undefined'&&module.exports){return exports=module.exports=w2ui}
global=exports}
if(global){Object.keys(w2ui).forEach(key=>{global[key]=w2ui[key]})}})(self,{w2ui,w2utils,query,w2locale,w2event,w2base,w2popup,w2alert,w2confirm,w2prompt,Dialog,w2window,w2tooltip,w2menu,w2color,w2date,Tooltip,w2toolbar,w2sidebar,w2tabs,w2layout,w2grid,w2form,w2field});(function(exports){"use strict";var yuneta_icon_font={"align-justify":59905,"bolt-lightning-solid":59906,"bulldog":59907,"chevron-left":59908,"chevron-right":59909,"plug-solid":59910,"user":59911,"yuneta":59912,"zblank":59913};exports.yuneta_icon_font=yuneta_icon_font;})(this);!function(){"use strict";let re={not_string:/[^s]/,not_bool:/[^t]/,not_type:/[^T]/,not_primitive:/[^v]/,number:/[diefg]/,numeric_arg:/[bcdiefguxX]/,json:/[j]/,not_json:/[^j]/,text:/^[^\x25]+/,modulo:/^\x25{2}/,placeholder:/^\x25(?:([1-9]\d*)\$|\(([^)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-gijostTuvxX])/,key:/^([a-z_][a-z_\d]*)/i,key_access:/^\.([a-z_][a-z_\d]*)/i,index_access:/^\[(\d+)\]/,sign:/^[+-]/};function sprintf(key){return sprintf_format(sprintf_parse(key),arguments);}
function vsprintf(fmt,argv){return sprintf.apply(null,[fmt].concat(argv||[]));}
function sprintf_format(parse_tree,argv){var cursor=1,tree_length=parse_tree.length,arg,output='',i,k,ph,pad,pad_character,pad_length,is_positive,sign;for(i=0;i<tree_length;i++){if(typeof parse_tree[i]==='string'){output+=parse_tree[i];}
else if(typeof parse_tree[i]==='object'){ph=parse_tree[i];if(ph.keys){arg=argv[cursor];for(k=0;k<ph.keys.length;k++){if(arg==undefined){throw new Error(sprintf('[sprintf] Cannot access property "%s" of undefined value "%s"',ph.keys[k],ph.keys[k-1]));}
arg=arg[ph.keys[k]];}}
else if(ph.param_no){arg=argv[ph.param_no];}
else{arg=argv[cursor++];}
if(re.not_type.test(ph.type)&&re.not_primitive.test(ph.type)&&arg instanceof Function){arg=arg();}
if(re.numeric_arg.test(ph.type)&&(typeof arg!=='number'&&isNaN(arg))){throw new TypeError(sprintf('[sprintf] expecting number but found %T',arg));}
if(re.number.test(ph.type)){is_positive=arg>=0;}
switch(ph.type){case'b':arg=parseInt(arg,10).toString(2);break;case'c':arg=String.fromCharCode(parseInt(arg,10));break;case'd':case'i':arg=parseInt(arg,10);break;case'j':arg=JSON.stringify(arg,null,ph.width?parseInt(ph.width):0);break;case'e':arg=ph.precision?parseFloat(arg).toExponential(ph.precision):parseFloat(arg).toExponential();break;case'f':arg=ph.precision?parseFloat(arg).toFixed(ph.precision):parseFloat(arg);break;case'g':arg=ph.precision?String(Number(arg.toPrecision(ph.precision))):parseFloat(arg);break;case'o':arg=(parseInt(arg,10)>>>0).toString(8);break;case's':arg=String(arg);arg=(ph.precision?arg.substring(0,ph.precision):arg);break;case't':arg=String(!!arg);arg=(ph.precision?arg.substring(0,ph.precision):arg);break;case'T':arg=Object.prototype.toString.call(arg).slice(8,-1).toLowerCase();arg=(ph.precision?arg.substring(0,ph.precision):arg);break;case'u':arg=parseInt(arg,10)>>>0;break;case'v':arg=arg.valueOf();arg=(ph.precision?arg.substring(0,ph.precision):arg);break;case'x':arg=(parseInt(arg,10)>>>0).toString(16);break;case'X':arg=(parseInt(arg,10)>>>0).toString(16).toUpperCase();break;}
if(re.json.test(ph.type)){output+=arg;}
else{if(re.number.test(ph.type)&&(!is_positive||ph.sign)){sign=is_positive?'+':'-';arg=arg.toString().replace(re.sign,'');}
else{sign='';}
pad_character=ph.pad_char?ph.pad_char==='0'?'0':ph.pad_char.charAt(1):' ';pad_length=ph.width-(sign+arg).length;pad=ph.width?(pad_length>0?pad_character.repeat(pad_length):''):'';output+=ph.align?sign+arg+pad:(pad_character==='0'?sign+pad+arg:pad+sign+arg);}}}
return output;}
let sprintf_cache=Object.create(null);function sprintf_parse(fmt){if(sprintf_cache[fmt]){return sprintf_cache[fmt];}
let _fmt=fmt,match,parse_tree=[],arg_names=0;while(_fmt){if((match=re.text.exec(_fmt))!==null){parse_tree.push(match[0]);}
else if((match=re.modulo.exec(_fmt))!==null){parse_tree.push('%');}
else if((match=re.placeholder.exec(_fmt))!==null){if(match[2]){arg_names|=1;var field_list=[],replacement_field=match[2],field_match=[];if((field_match=re.key.exec(replacement_field))!==null){field_list.push(field_match[1]);while((replacement_field=replacement_field.substring(field_match[0].length))!==''){if((field_match=re.key_access.exec(replacement_field))!==null){field_list.push(field_match[1]);}
else if((field_match=re.index_access.exec(replacement_field))!==null){field_list.push(field_match[1]);}
else{throw new SyntaxError('[sprintf] failed to parse named argument key');}}}
else{throw new SyntaxError('[sprintf] failed to parse named argument key');}
match[2]=field_list;}
else{arg_names|=2;}
if(arg_names===3){throw new Error('[sprintf] mixing positional and named placeholders is not (yet) supported');}
parse_tree.push({placeholder:match[0],param_no:match[1],keys:match[2],sign:match[3],pad_char:match[4],align:match[5],width:match[6],precision:match[7],type:match[8]});}
else{throw new SyntaxError('[sprintf] unexpected placeholder');}
_fmt=_fmt.substring(match[0].length);}
return sprintf_cache[fmt]=parse_tree;}
if(typeof exports!=='undefined'){exports['sprintf']=sprintf;exports['vsprintf']=vsprintf;}
if(typeof window!=='undefined'){window['sprintf']=sprintf;window['vsprintf']=vsprintf;if(typeof define==='function'&&define['amd']){define(function(){return{'sprintf':sprintf,'vsprintf':vsprintf};});}}}();(function(exports){"use strict";Function.prototype.__makeSubclass__=function(){function Class(){if(!(this instanceof Class)){throw("Constructor called without new");}
if("__init__"in this){this.__init__.apply(this,arguments);}}
Function.prototype.__makeSubclass__.nonconstructor.prototype=this.prototype;Class.prototype=new Function.prototype.__makeSubclass__.nonconstructor();return Class;};Function.prototype.__makeSubclass__.nonconstructor=function(){};function __duplicate__(obj)
{let clonedObjectsArray=[];let originalObjectsArray=[];let next_objid=0;function objectId(obj){if(obj==null)return null;if(obj.__obj_id==undefined){obj.__obj_id=next_objid++;originalObjectsArray[obj.__obj_id]=obj;}
return obj.__obj_id;}
function cloneRecursive(obj){if(null==obj||typeof obj=="string"||typeof obj=="number"||typeof obj=="boolean")return obj;if(obj instanceof Date){let copy=new Date();copy.setTime(obj.getTime());return copy;}
if(obj instanceof Array){let copy=[];for(let i=0;i<obj.length;++i){copy[i]=cloneRecursive(obj[i]);}
return copy;}
if(obj instanceof Object){if(clonedObjectsArray[objectId(obj)]!=undefined)
return clonedObjectsArray[objectId(obj)];let copy;if(obj instanceof Function)
copy=function(){return obj.apply(this,arguments);};else
copy={};clonedObjectsArray[objectId(obj)]=copy;for(let attr in obj)
if(attr!="__obj_id"&&obj.hasOwnProperty(attr))
copy[attr]=cloneRecursive(obj[attr]);return copy;}
throw new Error("Unable to copy obj! Its type isn't supported.");}
let cloneObj=cloneRecursive(obj);for(let i=0;i<originalObjectsArray.length;i++){delete originalObjectsArray[i].__obj_id;}
return cloneObj;}
function json_object_update_existing_recursive(destination,source){if(!source){return destination;}
for(let property in source){if(source.hasOwnProperty(property)&&destination.hasOwnProperty(property)){if(is_object(destination[property])&&is_object(source[property])){json_object_update_existing_recursive(destination[property],source[property]);}else{destination[property]=source[property];}}}
return destination;}
function __update_dict__(destination,source){if(!source){return destination;}
for(var property in source){if(source.hasOwnProperty(property)&&destination.hasOwnProperty(property)){destination[property]=source[property];}}
return destination;}
function __extend_dict__(destination,source){if(!source){return destination;}
for(var property in source){if(source.hasOwnProperty(property)){destination[property]=source[property];}}
return destination;}
function __extend_list__(destination,source){if(!source){return destination;}
Array.prototype.push.apply(destination,source);return destination;}
function json_object_update_missing(destination,source){if(!source){return destination;}
for(var property in source){if(source.hasOwnProperty(property)&&!destination.hasOwnProperty(property)){destination[property]=source[property];}}
return destination;}
function array_real_length(list)
{var ln=0;for(var i in list){if(list.hasOwnProperty(i)){ln++;}}
return ln;}
function index_of_list(elm,list){let nativeIndexOf=list.indexOf?true:false;if(nativeIndexOf){return list.indexOf(elm);}
let i=list.length;while(i--){if(list[i]===elm){return i;}}
return-1;}
function elm_in_list(elm,list){if(!list){throw"ERROR: elm_in_list() list empty";}
if(!elm){throw"ERROR: elm_in_list() elm empty";}
for(var i=0;i<list.length;i++){if(elm===list[i]){return true;}}
return false;}
function elms_in_list(elms,list){if(!list){throw"ERROR: elms_in_list() list empty";}
if(!elms){throw"ERROR: elms_in_list() elm empty";}
for(var i=0;i<elms.length;i++){var elm=elms[i];if(elm_in_list(elm,list)){return true;}}
return false;}
function index_in_list(list,elm){if(!list){throw"ERROR: index_in_list() list empty";}
for(let i=0;i<list.length;i++){if(elm===list[i]){return i;}}
return-1;}
function id_index_in_obj_list(list,id){if(!list){return-1;}
for(let i=0;i<list.length;i++){if(list[i]&&list[i].id===id){return i;}}
return-1;}
function get_object_from_list(list,id){if(!list){return null;}
for(let i=0;i<list.length;i++){if(list[i]&&list[i].id==id){return list[i];}}
return null;}
function none_in_list(list){for(let i=0;i<list.length;i++){if(!list[i]){return true;}}
return false;}
function delete_from_list(list,elm){for(let i=0;i<list.length;i++){if(elm===list[i]){list.splice(i,1);return true;}}
return false;}
function same_list(arrA,arrB){if(arrA.length!==arrB.length){return false;}
let cA=arrA.slice().sort();let cB=arrB.slice().sort();for(let i=0;i<cA.length;i++){if(cA[i]!==cB[i]){return false;}}
return true;}
function __strip__(s){return(s||"").replace(/^\s+|\s+$/g,"");}
function __set__(arr){let seen={},result=[];let len=arr.length;for(let i=0;i<len;i++){let el=arr[i];if(!seen[el]){seen[el]=true;result.push(el);}}
return result;}
function get_function_name(func){var fName=null;if(typeof func==="function"||typeof func==="object"){fName=(""+func).match(/function\s*([\w\$]*)\s*\(/);}
if(fName!==null){return fName[1]+"()";}
return"";}
Array.prototype.remove=function(from,to){var rest=this.slice((to||from)+1||this.length);this.length=from<0?this.length+from:from;return this.push.apply(this,rest);};String.prototype.repeat=function(count){if(count<1)return"";var result="",pattern=this.valueOf();while(count>1){if(count&1){result+=pattern;}
count>>=1;pattern+=pattern;}
result+=pattern;return result;};function strncmp(str1,str2,lgth)
{var s1=(str1+"").substring(0,lgth);var s2=(str2+"").substring(0,lgth);return((s1==s2)?0:((s1>s2)?1:-1));}
function is_object(a)
{return(!!a)&&(a.constructor===Object);}
function json_object_size(a)
{if(is_object(a)){return Object.keys(a).length;}
return 0;}
function json_size(a)
{if(is_object(a)){return Object.keys(a).length;}else if(is_array(a)){return a.length;}else if(is_string(a)){return 0;}else{return 0;}
return 0;}
function is_array(a)
{return(!!a)&&(a.constructor===Array);}
function is_string(value)
{return typeof value==="string"||value instanceof String;}
function is_number(value)
{return typeof value==="number"&&isFinite(value);}
function is_boolean(value)
{return value===false||value===true;}
function is_null(value)
{return value===null||value===undefined;}
function is_date(value)
{return value instanceof Date;}
function is_function(value)
{return typeof value==="function";}
function is_gobj(value)
{return value instanceof GObj;}
function empty_string(s)
{if(!s||typeof(s)!=="string"){return true;}
if(s.length==0){return true;}
return false;}
function match_dict_list_by_kw(set,__filter__)
{if(!__filter__){return[];}
return set.filter(function(entry){return Object.keys(__filter__).every(function(key){if(!entry.hasOwnProperty(key)){return false;}
return entry[key]===__filter__[key];});});}
function kw_is_identical(kw1,kw2)
{var kw1_=JSON.stringify(kw1);var kw2_=JSON.stringify(kw2);return(kw1_==kw2_)?true:false;}
function strcmp(str1,str2)
{return((str1==str2)?0:((str1>str2)?1:-1));}
function cmp_two_simple_json(jn_var1,jn_var2)
{if(is_object(jn_var1)||is_object(jn_var2)||is_array(jn_var1)||is_array(jn_var2)){return 0;}
if(is_number(jn_var1)||is_number(jn_var2)){let val1=Number(jn_var1);let val2=Number(jn_var2);if(val1>val2){return 1;}else if(val1<val2){return-1;}else{return 0;}}
if(is_boolean(jn_var1)||is_boolean(jn_var2)){let val1=Number(jn_var1);let val2=Number(jn_var2);if(val1>val2){return 1;}else if(val1<val2){return-1;}else{return 0;}}
let val1=String(jn_var1);let val2=String(jn_var2);let ret=strcmp(val1,val2);return ret;}
function _kw_match_simple(kw,jn_filter,level)
{let matched=false;level++;if(is_array(jn_filter)){matched=false;for(let idx=0;idx<jn_filter.length;idx++){let jn_filter_value=jn_filter[idx];matched=_kw_match_simple(kw,jn_filter_value,level);if(matched){break;}}}else if(is_object(jn_filter)){if(json_object_size(jn_filter)==0){matched=false;}else{matched=true;}
for(let filter_path in jn_filter){let jn_filter_value=jn_filter[filter_path];if(is_array(jn_filter_value)||is_object(jn_filter_value)){matched=_kw_match_simple(kw,jn_filter_value,level);break;}
let path=filter_path;let op="__equal__";let jn_record_value;jn_record_value=kw_get_dict_value(kw,path,0,0);if(!jn_record_value){jn_record_value=kw[path];}
if(!jn_record_value){matched=false;break;}
if(op=="__equal__"){let cmp=cmp_two_simple_json(jn_record_value,jn_filter_value);if(cmp!=0){matched=false;break;}}else{}}}
return matched;}
function kw_match_simple(kw,jn_filter)
{if(!jn_filter){return true;}
if(is_object(jn_filter)&&Object.keys(jn_filter).length==0){return true;}
return _kw_match_simple(kw,jn_filter,0);}
function kw_collect(kw,jn_filter,match_fn)
{if(!kw){return null;}
if(!match_fn){match_fn=kw_match_simple;}
var kw_new=[];if(is_array(kw)){for(var i=0;i<kw.length;i++){var jn_value=kw[i];if(match_fn(jn_value,jn_filter)){kw_new.push(jn_value);}}}else if(is_object(kw)){if(match_fn(kw,jn_filter)){kw_new.push(kw);}}else{log_error("kw_collect() BAD kw parameter");return null;}
return kw_new;}
function kwid_get_ids(ids)
{if(!ids){return[];}
let new_ids=[];if(is_string(ids)){new_ids.push(ids);}else if(is_object(ids)){for(let id in ids){if(ids.hasOwnProperty(id)){new_ids.push(id);}}}else if(is_array(ids)){ids.forEach(function(item){if(is_string(item)){if(!empty_string(item)){new_ids.push(item);}}else if(is_object(item)){let id=kw_get_str(item,"id",0,0);if(id){new_ids.push(id);}}});}
return new_ids;}
function kwid_match_id(ids,id)
{if(is_null(ids)||is_null(id)){return true;}
if(is_array(ids)){if(ids.length==0){return true;}
for(let i=0;i<ids.length;i++){let value=ids[i];if(value==id){return true;}}}else if(is_object(ids)){if(Object.keys(ids).length==0){return true;}
for(let key in ids){if(key==id){return true;}}}else if(is_string(ids)){if(ids==id){return true;}}
return false;}
function kwid_collect(kw,ids,jn_filter,match_fn)
{if(!kw){return null;}
if(!match_fn){match_fn=kw_match_simple;}
let kw_new=[];if(is_array(kw)){for(let i=0;i<kw.length;i++){let jn_value=kw[i];let id;if(is_object(jn_value)){id=kw_get_str(jn_value,"id","",false);}else if(is_string(jn_value)){id=jn_value;}else{continue;}
if(!kwid_match_id(ids,id)){continue;}
if(match_fn(jn_value,jn_filter)){kw_new.push(jn_value);}}}else if(is_object(kw)){for(let id in kw){let jn_value=kw[id];if(!kwid_match_id(ids,id)){continue;}
if(match_fn(jn_value,jn_filter)){kw_new.push(jn_value);}}}else{log_error("kw_collect() BAD kw parameter");return null;}
return kw_new;}
function kwid_new_dict(kw,path)
{let new_dict={};if(!empty_string(path)){kw=_kw_search_path(kw,path);}
if(is_object(kw)){new_dict=kw;}else if(is_array(kw)){for(let i=0;i<kw.length;i++){let kv=kw[i];let id=kw_get_str(kv,"id",null,false);if(!empty_string(id)){new_dict[id]=kv;}}}else{log_error("kwid_new_dict: data type unknown");}
return new_dict;}
function kwid_get_first_id(kw)
{let list=kwid_get_ids(kw);if(list.length>0){return list[0];}
return null;}
function kwid_find_one_record(kw,ids,jn_filter,match_fn)
{let list=kwid_collect(kw,ids,jn_filter,match_fn);if(list.length>0){return list[0];}else{return null;}}
function kwid_delete_record(kw,ids_)
{let deletes=0;let ids=kwid_get_ids(ids_);for(let i=0;i<ids.length;i++){let id=ids[i];if(is_object(kw)){delete kw[id];deletes++;}else if(is_array(kw)){for(let j=0;j<kw.length;j++){if(id==kw[j].id){delete_from_list(kw,kw[j]);deletes++;j=-1;continue;}}}else{log_error("kwid_delete_record: data type unknown");}}
return deletes>0?0:-1;}
function filter_dict(dict,keylist)
{let new_dict={};if(is_array(keylist)){for(let j=0;j<keylist.length;j++){let key=keylist[j];if(dict.hasOwnProperty(key)){new_dict[key]=dict[key];}}}else if(is_object(keylist)){for(let key in keylist){if(dict.hasOwnProperty(key)){new_dict[key]=dict[key];}}}
return new_dict;}
function filter_dictlist(dict_list,keylist)
{let new_dictlist=[];for(let i=0;i<dict_list.length;i++){let new_dict=filter_dict(dict_list[i],keylist);new_dictlist.push(new_dict);}
return new_dictlist;}
function filter_list(dict_list,key)
{let new_list=[];for(let i=0;i<dict_list.length;i++){let dict=dict_list[i];if(dict.hasOwnProperty(key)){new_list.push(dict[key]);}}
return new_list;}
function ids2str(dictlist)
{let s="";for(let i=0;i<dictlist.length;i++){let dict=dictlist[i];if(i==0){s+=dict.id;}else{s+=","+dict.id;}}
return s;}
function msg_iev_read_key(kw,key,create,default_value)
{try{var __md_iev__=kw["__md_iev__"];if(__md_iev__){return __md_iev__[key];}}catch(e){return undefined;}
return undefined;}
function msg_iev_write_key(kw,key,value)
{var __md_iev__=kw["__md_iev__"];if(!__md_iev__){__md_iev__={};kw["__md_iev__"]=__md_iev__;}
__md_iev__[key]=value;}
function msg_iev_delete_key(kw,key)
{var __md_iev__=kw["__md_iev__"];if(!__md_iev__){return;}
if(!kw_has_key(__md_iev__,key)){return;}
delete __md_iev__[key];}
function msg_delete_MIA(kw,key)
{var __md_iev__=kw["__md_iev__"];if(!__md_iev__){return;}
delete kw["__md_iev__"];}
var message_area_filters=[];function msg_iev_add_answer_filter(gobj,field_name,answer_filter_cb)
{var len=message_area_filters.length;for(var i=0;i<len;i++){var name=message_area_filters[i].field_name;if(name==field_name){return 0;}}
var filter={field_name:field_name,answer_filter_fn:answer_filter_cb,gobj:gobj};message_area_filters.push(filter);}
function msg_apply_answer_filters(kw_answer,__md_iev__,src)
{var len=message_area_filters.length;for(var i=0;i<len;i++){var name=message_area_filters[i].field_name;var cb=message_area_filters[i].answer_filter_fn;var gobj=message_area_filters[i].gobj;if(kw_has_key(__md_iev__,name)){var value=kw_get_dict_value(__md_iev__,name,0);(cb)(gobj,kw_answer,name,value,src);}}}
function msg_iev_answer(gobj,kw,kw_answer)
{try{let __md_iev__=kw["__md_iev__"];if(__md_iev__){let new_msg_area=Object(__md_iev__);kw_answer["__md_iev__"]=new_msg_area;msg_apply_answer_filters(kw_answer,new_msg_area,gobj);}}catch(e){}
return kw_answer;}
function msg_iev_push_stack(kw,stack,user_info)
{if(!kw){return;}
let jn_stack=msg_iev_read_key(kw,stack);if(!jn_stack){jn_stack=[];msg_iev_write_key(kw,stack,jn_stack);}
try{if(is_array(jn_stack)){jn_stack.unshift(user_info);}}catch(e){console.log(e);}}
function msg_iev_get_stack(kw,stack)
{if(!kw){return null;}
var jn_stack=msg_iev_read_key(kw,stack);if(!jn_stack){return 0;}
if(jn_stack.length==0){return null;}
return jn_stack[0];}
function msg_iev_pop_stack(kw,stack)
{if(!kw){return null;}
let jn_stack=msg_iev_read_key(kw,stack);if(!jn_stack){return 0;}
if(jn_stack.length==0){return null;}
let user_info=jn_stack.shift();if(jn_stack.length==0){msg_iev_delete_key(kw,stack);}
return user_info;}
var msg_type_list=["__command__","__publishing__","__subscribing__","__unsubscribing__","__query__","__response__","__order__","__first_shot__"];function msg_set_msg_type(kw,msg_type)
{if(!empty_string(msg_type)){if(is_metadata_key(msg_type)&&!elm_in_list(msg_type,msg_type_list)){return;}
msg_iev_write_key(kw,"__msg_type__",msg_type);}}
function msg_get_msg_type(kw)
{return msg_iev_read_key(kw,"__msg_type__");}
function kw_has_key(kw,key)
{if(key in kw){if(kw.hasOwnProperty(key)){return true;}}
return false;}
function search_delimiter(s,delimiter_)
{if(!delimiter_){return 0;}
return strchr(s,delimiter_);}
function _kw_search_path(kw,path)
{if(!is_object(kw)){return 0;}
if(!is_string(path)){log_error("path must be a string: "+String(path));return 0;}
let ss=path.split("`");if(ss.length<=1){return kw[path];}
let len=ss.length;for(let i=0;i<len;i++){let key=ss[i];kw=kw[key];if(kw===undefined){return undefined;}}
return kw;}
function kw_get_bool(kw,key,default_value,create,verbose)
{if(kw!==Object(kw)){return default_value?true:false;}
let b=_kw_search_path(kw,key);if(b===undefined){if(create){kw[key]=default_value?true:false;}else if(verbose){log_error("kw_get_bool() path not found: '"+key+"'");trace_msg(kw);}
return default_value?true:false;}
return b?true:false;}
function kw_get_int(kw,key,default_value,create,verbose)
{if(kw!==Object(kw)){return default_value;}
let v=_kw_search_path(kw,key);if(v===undefined){if(create){kw[key]=default_value;}else if(verbose){log_error("kw_get_int() path not found: '"+key+"'");trace_msg(kw);}
return default_value;}
if(!is_number(v)){if(verbose){log_error("path value MUST BE a number: "+key);trace_msg(kw);}
return default_value;}
return parseInt(v);}
function kw_get_real(kw,key,default_value,create,verbose)
{if(kw!==Object(kw)){return default_value;}
let v=_kw_search_path(kw,key);if(v===undefined){if(create){kw[key]=default_value;}else if(verbose){log_error("kw_get_real() path not found: '"+key+"'");trace_msg(kw);}
return default_value;}
if(!is_number(v)){if(verbose){log_error("path value MUST BE a number: "+key);trace_msg(kw);}
return default_value;}
return parseFloat(v);}
function kw_get_str(kw,key,default_value,create,verbose)
{if(kw!==Object(kw)){return default_value;}
let v=_kw_search_path(kw,key);if(v===undefined){if(create){kw[key]=default_value;}else if(verbose){log_error("kw_get_str() path not found: '"+key+"'");trace_msg(kw);}
return default_value;}
if(!is_string(v)){if(verbose){log_error("path value MUST BE a string: "+key);trace_msg(kw);}
return default_value;}
return String(v);}
function kw_get_dict(kw,key,default_value,create,verbose)
{if(kw!==Object(kw)){return default_value;}
let v=_kw_search_path(kw,key);if(v===undefined){if(create){kw[key]=default_value;}else if(verbose){log_error("kw_get_dict() path not found: '"+key+"'");trace_msg(kw);}
return default_value;}
if(!is_object(v)){if(verbose){log_error("path value MUST BE a json dict: "+key);trace_msg(kw);}
return default_value;}
return v;}
function kw_get_list(kw,key,default_value,create,verbose)
{if(kw!==Object(kw)){return default_value;}
let v=_kw_search_path(kw,key);if(v===undefined){if(create){kw[key]=default_value;}else if(verbose){log_error("kw_get_list() path not found: '"+key+"'");trace_msg(kw);}
return default_value;}
if(!is_array(v)){if(verbose){log_error("path value MUST BE a json list: "+key);trace_msg(kw);}
return default_value;}
return v;}
function kw_get_dict_value(kw,key,default_value,create,verbose)
{if(kw!==Object(kw)){return default_value;}
var v=_kw_search_path(kw,key);if(v===undefined){if(create){kw[key]=default_value;}else if(verbose){log_error("kw_get_dict_value() path not found: '"+key+"'");trace_msg(kw);}
return default_value;}
return v;}
function kw_set_dict_value(kw,path,value)
{if(!is_object(kw)){log_error("kw is not an object");return-1;}
kw[path]=value;return 0;}
function kw_set_subdict_value(kw,path,key,value)
{if(!is_object(kw)){log_error("kw is not an object");return-1;}
let path_=kw[path];if(is_null(path_)||!is_object(path_)){path_={};kw[path]=path_;}
path_[key]=value;return 0;}
function kw_extract_private(kw)
{var copy={};for(var attr in kw){if(kw.hasOwnProperty(attr)){if(is_private_key(attr)){copy[attr]=kw[attr];delete kw[attr];}}}
return copy;}
function get_unique_id(prefix)
{if(!prefix){prefix="random";}
return prefix+"-"+uuidv4();}
function uuidv4()
{return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=='x'?r:(r&0x3|0x8);return v.toString(16);});}
function fileLoaded(xhr){return xhr.status==0&&xhr.responseText&&xhr.responseURL.startsWith("file:");}
function load_json_file(url,on_success,on_error)
{let req=new XMLHttpRequest();req.open("GET",url,true);req.setRequestHeader("Accept","application/json");req.onreadystatechange=function(){if(req.readyState==4){if(req.status==200||fileLoaded(req)){let json=JSON.parse(req.responseText);on_success(json);}else{if(on_error){on_error(req.status);}}}};req.send();}
function send_http_json_post(url,data,on_response){let xhr=new XMLHttpRequest();xhr.open("POST",url);xhr.setRequestHeader("Accept","application/json");xhr.setRequestHeader("Content-Type","application/json");xhr.onreadystatechange=function(){if(xhr.readyState==4){on_response(xhr.status,xhr.responseText);}};xhr.send(data);}
function strstr(haystack,needle,bool)
{var pos=0;haystack+="";pos=haystack.indexOf(needle);if(pos==-1){return false;}else{if(bool){return haystack.substring(0,pos);}else{return haystack.slice(pos);}}}
function list2options(list,field_id,field_value)
{field_id=field_id?field_id:"id";field_value=field_value?field_value:"value";var options=[];if(is_array(list)){for(var i=0;i<list.length;i++){var v=list[i];if(is_string(v)){options.push({id:list[i],value:list[i]});}else if(is_object(v)){var vv={};if(!kw_has_key(v,field_id)){log_error("list2options(): object without field id: "+field_id);}
if(!kw_has_key(v,field_value)){log_error("list2options(): object without field value: "+field_value);}
vv["id"]=v[field_id];vv["value"]=v[field_value];options.push(vv);}else{log_error("list2options(): case1 not implemented");}}}else if(is_object(list)){for(var k in list){options.push({id:k,value:k});}}else{log_error("list2options(): case2 not implemented");}
return options;}
function traverse_dict(obj,callback,full_path)
{if(full_path==undefined||!is_string(full_path)){full_path="";}
for(var key in obj){if(!obj.hasOwnProperty(key)){continue;}
var sufix=(full_path.length?"`":"")+key;full_path+=sufix;callback.apply(this,[obj,key,obj[key],full_path]);if(is_object(obj[key])){traverse_dict(obj[key],callback,full_path);}
full_path=full_path.slice(0,-sufix.length);}}
function jdb_init(jdb,prefix,duplicate)
{if(duplicate){jdb=__duplicate__(jdb);}
var type=kw_get_dict_value(jdb,"type",[],1);var hook=kw_get_str(jdb,"hook","data",1);var schema=kw_get_dict_value(jdb,"schema",{},1);var topics=kw_get_dict_value(jdb,"topics",{},1);var walk=function(obj,key,value,full_path){if(key.substring(0,2)!="__"){kw_get_dict_value(topics,full_path,__duplicate__(type),1);}};traverse_dict(schema,walk,prefix);return jdb;}
function jdb_update(jdb,topic_name,path,kw)
{var topics=kw_get_dict_value(jdb,"topics",null,0);var topic=kw_get_dict_value(topics,topic_name,null,0);if(!topic){log_error("jdb_update: topic not found: "+topic_name);return null;}
if(empty_string(kw["id"])){log_error("jdb_update: record without id: "+kw);trace_msg(kw);return null;}
var ids=path.split("`");var id;var v=topic;while((id=ids.shift())){if(empty_string(id)||!v){break;}
if(is_object(v)){v=kw_get_dict_value(v,jdb.hook,[],1);}
v=_jdb_get(v,null,id,false);}
if(ids.length==0&&v){if(is_array(v)){v.push(kw);}else{if(v["id"]==kw["id"]){Object.assign(v,kw);}else{var v_=kw_get_dict_value(v,jdb.hook,[],1);var v__=_jdb_get(v_,jdb.hook,kw["id"],false);if(v__){Object.assign(v__,kw);}else{v_.push(kw);}}}}
return topic;}
function jdb_delete(jdb,topic_name,path,kw)
{var topics=kw_get_dict_value(jdb,"topics",null,0);var topic=kw_get_dict_value(topics,topic_name,null,0);if(!topic){log_error("jdb_delete: topic not found: "+topic_name);return null;}
if(empty_string(kw["id"])){log_error("jdb_delete: record without id: "+kw);trace_msg(kw);return null;}
var ids=path.split("`");var id;var v=topic;while((id=ids.shift())){if(empty_string(id)||!v){break;}
if(is_object(v)){v=kw_get_dict_value(v,jdb.hook,null,0);}
v=_jdb_get(v,null,id,false);}
if(ids.length==0&&v){if(is_array(v)){let idx=id_index_in_obj_list(v,kw["id"]);if(idx>=0){v.splice(idx,1);}}else{let v_=kw_get_dict_value(v,jdb.hook,null,0);let idx=id_index_in_obj_list(v_,kw["id"]);if(idx>=0){v_.splice(idx,1);}}}
return topic;}
function jdb_get_topic(jdb,topic_name)
{var topics=kw_get_dict_value(jdb,"topics",null,0,false);if(!topics){log_error("jdb topics section not found");trace_msg(jdb);return null;}
var topic=kw_get_dict_value(topics,topic_name,null,0,false);if(!topic){log_error("jdb topic not found: "+topic_name);trace_msg(topics);return null;}
return topic;}
function jdb_get(jdb,topic_name,id,recursive)
{var topics=kw_get_dict_value(jdb,"topics",null,0);var topic=kw_get_dict_value(topics,topic_name,null,0);if(!topic){log_error("jdb_get: topic not found: "+topic_name);return null;}
if(recursive===undefined){recursive=true;}
return _jdb_get(topic,jdb.hook,id,recursive);}
function jdb_get_by_idx(jdb,topic_name,idx)
{var topics=kw_get_dict_value(jdb,"topics",null,0);var topic=kw_get_dict_value(topics,topic_name,null,0);if(!topic){log_error("jdb_get_by_idx: topic not found: "+topic_name);return null;}
if(idx<topic.length){return topic[idx];}else{return{};}}
function _jdb_get(v,hook,id,recursive)
{if(!v){return null;}
var j;var ln=v.length;for(j=0;j<ln;j++){var v_=v[j];if(v_){var id_=v_["id"];if(id_&&(id_==id)){return v_;}
if(recursive){if(kw_has_key(v_,hook)){var v__=_jdb_get(v_[hook],hook,id,recursive);if(v__){return v__;}}}}}
return null;}
function create_json_record(json_desc,value)
{let record=__duplicate__(json_desc);json_object_update_existing(record,value);return record;}
function _logger(msg)
{console.log(msg);}
var f_error=null;var f_warning=null;var f_info=null;var f_debug=null;function set_log_functions(f_error_,f_warning_,f_info_,f_debug_)
{if(f_error_){f_error=f_error_;}
if(f_warning_){f_warning=f_warning_;}
if(f_info_){f_info=f_info_;}
if(f_debug_){f_debug=f_debug_;}}
function log_error(msg)
{if(is_object(msg)){msg=JSON.stringify(msg);}
let hora=get_current_datetime();console.log("%c"+hora+" ERROR: "+String(msg),"color:yellow");if(f_error){f_error(""+hora+" ERROR: "+String(msg));}
try{throw new Error();}catch(e){console.log(e.stack);}}
function log_warning(msg)
{if(is_object(msg)){msg=JSON.stringify(msg);}
let hora=get_current_datetime();console.log("%c"+hora+" WARNING: "+String(msg),"color:cyan");if(f_warning){f_warning(""+hora+" WARNING: "+String(msg));}}
function log_info(msg)
{if(is_object(msg)){msg=JSON.stringify(msg);}
if(!empty_string(msg)){console.log(String(msg));}
if(f_info){f_info(String(msg));}}
function log_debug(msg)
{if(is_object(msg)){msg=JSON.stringify(msg);}
if(!empty_string(msg)){console.log(String(msg));}
if(f_debug){f_debug(String(msg));}}
function trace_msg(msg)
{console.log(msg);if(f_debug){f_debug(String(msg));}}
function trace_msg2(msg,msg2)
{console.log(msg);console.log(msg2);if(f_debug){f_debug(String(msg));f_debug(String(msg2));}}
function kw_get_local_storage_value(key,default_value,create)
{if(!(key&&window.JSON&&window.localStorage)){return undefined;}
var value=window.localStorage.getItem(key);if(value===null||value===undefined){if(create){kw_set_local_storage_value(key,default_value);}
return default_value;}
try{value=JSON.parse(value);}catch(e){}
return value;}
function kw_set_local_storage_value(key,value)
{if(key&&window.JSON&&window.localStorage){if(value!==undefined){window.localStorage.setItem(key,JSON.stringify(value));}}}
function kw_remove_local_storage_value(key)
{if(key&&window.localStorage){window.localStorage.removeItem(key);}}
function parseBoolean(s)
{if(is_number(s)){return Boolean(s);}
let regex=/^\s*(true|1|on)\s*$/i
return regex.test(s);}
function escapeRegExp(stringToGoIntoTheRegex){return stringToGoIntoTheRegex.replace(/[-\/\\^$*+?.()|[\]{}]/g,'\\$&');}
function replace_variable_engine(variable)
{var variable2=escapeRegExp(variable);return new RegExp("#"+variable2+"#","g");}
function CssClassBuilder(){var styleSheet;var pub={};var constructor=function(){if(!styleSheetsExist()||!headElementExists())
return;getStyleSheet();if(typeof styleSheet==='undefined'){makeStyleSheet();}};var MediaType=function(styleSheet,media){var styleSheet=styleSheet;var media=media;this.mediaType=function(){return media;};this.styleSheet=function(){return styleSheet;};};var StringMediaType=function(styleSheet){var pub={};MediaType.call(pub,styleSheet,"string");pub.addRule=function(selector,style){for(var i=0,l=styleSheet.rules.length;i<l;i++){if(styleSheet.rules[i].selectorText&&styleSheet.rules[i].selectorText.toLowerCase()==selector.toLowerCase()){styleSheet.rules[i].style.cssText=style;return;}}
styleSheet.addRule(selector,style);};pub.removeRule=function(selector){for(var i=0;i<styleSheet.rules.length;i++){if(styleSheet.rules[i].selectorText.toLowerCase()===selector.toLowerCase()){styleSheet.removeRule(i);}}};return pub;};StringMediaType.isString=function(styleSheet){var media=styleSheet.media;var mediaType=typeof media;if(mediaType==='string'){if(media===''||(media.indexOf('screen')!==-1)){return true;}}
return false;};var ObjectMediaType=function(styleSheet){var pub={};MediaType.call(pub,styleSheet,"object");var pub={};pub.addRule=function(selector,style){var styleSheetLength=(styleSheet.cssRules)?styleSheet.cssRules.length:0;for(var i=0;i<styleSheetLength;i++){if(styleSheet.cssRules[i].selectorText&&styleSheet.cssRules[i].selectorText.toLowerCase()==selector.toLowerCase()){styleSheet.cssRules[i].style.cssText=style;return;}}
styleSheet.insertRule(selector+'{'+style+'}',styleSheetLength);};pub.removeRule=function(selector){for(var i=0;i<styleSheet.cssRules.length;i++){if(styleSheet.cssRules[i].selectorText.toLowerCase()===selector.toLowerCase()){styleSheet.deleteRule(i);}}};return pub;};ObjectMediaType.isObject=function(styleSheet){var media=styleSheet.media;var mediaType=typeof media;if(mediaType=='object'){if(media.mediaText===''||(media.mediaText.indexOf('screen')!==-1)){return true;}}
return false;};var makeMediaType=function(styleSheet){if(StringMediaType.isString(styleSheet)){return StringMediaType(styleSheet);}else if(ObjectMediaType.isObject(styleSheet)){return ObjectMediaType(styleSheet);}else{return undefined;}};var styleSheetsExist=function(){return document.styleSheets;};var headElementExists=function(){return document.getElementsByTagName('head').length!==0;};var makeStyleSheet=function(){var styleSheetElement=document.createElement('style');styleSheetElement.type='text/css';document.getElementsByTagName('head')[0].appendChild(styleSheetElement);for(i=0;i<document.styleSheets.length;i++){if(document.styleSheets[i].disabled){continue;}
styleSheet=makeMediaType(document.styleSheets[i]);}};var getStyleSheet=function(){if(document.styleSheets.length>0){for(var i=0,l=document.styleSheets.length;i<l;i++){if(document.styleSheets[i].disabled)
continue;styleSheet=makeMediaType(document.styleSheets[i]);if(typeof styleSheet!=='undefined')
break;}};};var styleSheetDefined=function(){return styleSheet!==undefined;};pub.addRule=function(selector,style){if(styleSheetDefined())
styleSheet.addRule(selector,style);};pub.removeRule=function(selector){if(styleSheetDefined())
styleSheet.removeRule(selector);};constructor();return pub;}
function zot(v){return v==null;}
let Proportion=function(baseMin,baseMax,targetMin,targetMax,factor,targetRound,clamp){if(zot(targetMin))targetMin=0;if(zot(targetMax))targetMax=1;if(zot(factor))factor=1;if(zot(targetRound))targetRound=false;var proportion;var targetAmount;this.convert=function(baseAmount){if(zot(baseAmount)){baseAmount=baseMin;}
if(isNaN(baseAmount)||(baseMax-baseMin==0)){return;}
if(clamp){baseAmount=Math.max(baseAmount,baseMin);baseAmount=Math.min(baseAmount,baseMax);}
proportion=(baseAmount-baseMin)/(baseMax-baseMin);if(factor>0){targetAmount=targetMin+(targetMax-targetMin)*proportion;}else{targetAmount=targetMax-(targetMax-targetMin)*proportion;}
if(targetRound){targetAmount=Math.round(targetAmount);}
return targetAmount;};};function adjust_font_size(wanted_size,fontFamily)
{let h;for(h=1;h<80;h++){let dim=get_text_size("MWj|}",fontFamily,h,0);if(dim.height>=wanted_size){break;}}
return h;}
function adjust_icon_size(wanted_size,fontFamily)
{let h;for(h=1;h<80;h++){let dim=get_text_size("\u{EA01}\u{EA02}",fontFamily,h,0);if(dim.height>=wanted_size){break;}}
return h;}
function get_text_size(text,font_family,font_size,padding)
{let pa=document.body;let who=document.createElement('div');if(is_null(padding)){padding=0;}
if(is_number(padding)){padding=padding+"px";}
if(is_number(font_size)){font_size=font_size+"px";}
if(empty_string(font_size)){font_size="1em";}
if(empty_string(font_family)){font_family="sans-serif";}
if(empty_string(text)){text="Mj";}
who.style.cssText="display:inline-block;padding:"+padding+";line-height:1;position:absolute;visibility:hidden font-family:"+font_family+";font-size:"+font_size+";";who.appendChild(document.createTextNode(text));pa.appendChild(who);let height=who.offsetHeight;let width=who.offsetWidth;pa.removeChild(who);return{width:width,height:height};}
function htmlToElement(html)
{let template=document.createElement('template');html=html.trim();template.innerHTML=html;return template.content.firstChild;}
function get_current_datetime()
{let currentTime=new Date();let month=currentTime.getMonth()+1;if(month<10){month="0"+month;}
let day=currentTime.getDate();if(day<10){day="0"+day;}
let year=currentTime.getFullYear();let fecha=year+"/"+month+"/"+day;let hours=currentTime.getHours();if(hours<10){hours="0"+hours;}
let minutes=currentTime.getMinutes();if(minutes<10){minutes="0"+minutes;}
let seconds=currentTime.getSeconds();if(seconds<10){seconds="0"+seconds;}
let hora=hours+":"+minutes+":"+seconds;return fecha+" "+hora;}
function get_now()
{let start=new Date();start.setMilliseconds(0);return start/1000;}
function jwtDecode(jwt)
{function b64DecodeUnicode(str){return decodeURIComponent(atob(str).replace(/(.)/g,function(m,p){let code=p.charCodeAt(0).toString(16).toUpperCase();if(code.length<2){code='0'+code;}
return'%'+code;}));}
function decode(str){let output=str.replace(/-/g,"+").replace(/_/g,"/");switch(output.length%4){case 0:break;case 2:output+="==";break;case 3:output+="=";break;default:throw"Illegal base64url string!";}
try{return b64DecodeUnicode(output);}catch(err){return atob(output);}}
let jwtArray=jwt.split('.');return{header:decode(jwtArray[0]),payload:decode(jwtArray[1]),signature:decode(jwtArray[2])};}
function jwt2json(jwt,what)
{try{let jwt_decoded=jwtDecode(jwt)
switch(what){case"header":return JSON.parse(jwt_decoded.header);case"signature":return JSON.parse(jwt_decoded.signature);case"payload":default:return JSON.parse(jwt_decoded.payload);}}catch(e){return null;}}
function is_metadata_key(key)
{if(!is_string(key)){return false;}
let i;for(i=0;i<key.length;i++){if(key[i]!=='_'){break;}
if(i>2){break;}}
return(i===2);}
function is_private_key(key)
{if(!is_string(key)){return false;}
let i;for(i=0;i<key.length;i++){if(key[i]!=='_'){break;}
if(i>2){break;}}
return(i===1);}
function icono(name)
{let icon_unicode=yuneta_icon_font[name];if(!icon_unicode){log_error("Yuneta icon not found: '"+name+"'");return null;}
return String.fromCharCode(parseInt(icon_unicode,10))}
function find_gobj_in_list(list,name)
{for(let gobj of list){if(!is_gobj(gobj)){continue;}
if(gobj.gobj_name()===name){return gobj;}}
return null;}
function get_str_list_difference(array1,array2)
{let difference1=[];for(let i=0;i<array1.length;i++){if(!array2.includes(array1[i])){difference1.push(array1[i]);}}
let difference2=[];for(let i=0;i<array2.length;i++){if(!array1.includes(array2[i])){difference2.push(array2[i]);}}
return{array1:difference1,array2:difference2};}
exports.__duplicate__=__duplicate__;exports.__update_dict__=__update_dict__;exports.json_object_update_existing_recursive=json_object_update_existing_recursive;exports.json_object_update_existing=__update_dict__;exports.__extend_dict__=__extend_dict__;exports.json_object_update=__extend_dict__;exports.__extend_list__=__extend_list__;exports.json_object_update_missing=json_object_update_missing;exports.array_real_length=array_real_length;exports.index_of_list=index_of_list;exports.elm_in_list=elm_in_list;exports.elms_in_list=elms_in_list;exports.index_in_list=index_in_list;exports.delete_from_list=delete_from_list;exports.__strip__=__strip__;exports.__set__=__set__;exports.get_function_name=get_function_name;exports.same_list=same_list;exports.none_in_list=none_in_list;exports.id_index_in_obj_list=id_index_in_obj_list;exports.get_object_from_list=get_object_from_list;exports.strncmp=strncmp;exports.is_object=is_object;exports.json_object_size=json_object_size;exports.json_size=json_size;exports.is_array=is_array;exports.is_string=is_string;exports.is_number=is_number;exports.is_boolean=is_boolean;exports.is_null=is_null;exports.is_date=is_date;exports.is_function=is_function;exports.is_gobj=is_gobj;exports.empty_string=empty_string;exports.kw_is_identical=kw_is_identical;exports.strcmp=strcmp;exports.cmp_two_simple_json=cmp_two_simple_json;exports.kw_match_simple=kw_match_simple;exports.kw_collect=kw_collect;exports.kwid_get_ids=kwid_get_ids;exports.kwid_match_id=kwid_match_id;exports.kwid_collect=kwid_collect;exports.kwid_new_dict=kwid_new_dict;exports.kwid_get_first_id=kwid_get_first_id;exports.kwid_find_one_record=kwid_find_one_record;exports.kwid_delete_record=kwid_delete_record;exports.match_dict_list_by_kw=match_dict_list_by_kw;exports.filter_dictlist=filter_dictlist;exports.filter_dict=filter_dict;exports.filter_list=filter_list;exports.ids2str=ids2str;exports.msg_iev_read_key=msg_iev_read_key;exports.msg_iev_write_key=msg_iev_write_key;exports.msg_iev_add_answer_filter=msg_iev_add_answer_filter;exports.msg_iev_answer=msg_iev_answer;exports.msg_iev_push_stack=msg_iev_push_stack;exports.msg_iev_get_stack=msg_iev_get_stack;exports.msg_iev_pop_stack=msg_iev_pop_stack;exports.msg_set_msg_type=msg_set_msg_type;exports.msg_get_msg_type=msg_get_msg_type;exports.kw_has_key=kw_has_key;exports.kw_get_bool=kw_get_bool;exports.kw_get_int=kw_get_int;exports.kw_get_real=kw_get_real;exports.kw_get_str=kw_get_str;exports.kw_get_dict=kw_get_dict;exports.kw_get_list=kw_get_list;exports.kw_get_dict_value=kw_get_dict_value;exports.kw_set_dict_value=kw_set_dict_value;exports.kw_set_subdict_value=kw_set_subdict_value;exports.kw_extract_private=kw_extract_private;exports.get_unique_id=get_unique_id;exports.uuidv4=uuidv4;exports.load_json_file=load_json_file;exports.send_http_json_post=send_http_json_post;exports.strstr=strstr;exports.list2options=list2options;exports.traverse_dict=traverse_dict;exports.jdb_init=jdb_init;exports.jdb_update=jdb_update;exports.jdb_delete=jdb_delete;exports.jdb_get_topic=jdb_get_topic;exports.jdb_get=jdb_get;exports.jdb_get_by_idx=jdb_get_by_idx;exports.create_json_record=create_json_record;exports._logger=_logger;exports.set_log_functions=set_log_functions;exports.log_error=log_error;exports.log_warning=log_warning;exports.log_info=log_info;exports.log_debug=log_debug;exports.trace_msg=trace_msg;exports.trace_msg2=trace_msg2;exports.kw_get_local_storage_value=kw_get_local_storage_value;exports.kw_set_local_storage_value=kw_set_local_storage_value;exports.kw_remove_local_storage_value=kw_remove_local_storage_value;exports.parseBoolean=parseBoolean;exports.escapeRegExp=escapeRegExp;exports.replace_variable_engine=replace_variable_engine;exports.CssClassBuilder=CssClassBuilder;exports.Proportion=Proportion;exports.get_text_size=get_text_size;exports.adjust_font_size=adjust_font_size;exports.adjust_icon_size=adjust_icon_size;exports.htmlToElement=htmlToElement;exports.get_current_datetime=get_current_datetime;exports.get_now=get_now;exports.jwtDecode=jwtDecode;exports.jwt2json=jwt2json;exports.is_metadata_key=is_metadata_key;exports.is_private_key=is_private_key;exports.icono=icono;exports.find_gobj_in_list=find_gobj_in_list;exports.get_str_list_difference=get_str_list_difference;})(this);let __inside_event_loop__=0;(function(exports){"use strict";function json_object_update_config(destination,source){if(!source){return destination;}
for(let property in source){if(source.hasOwnProperty(property)&&destination.hasOwnProperty(property)){if(is_object(destination[property])&&is_object(source[property])){json_object_update(destination[property],source[property]);}else{destination[property]=source[property];}}}
return destination;}
let GObj=Object.__makeSubclass__();let proto=GObj.prototype;proto.__init__=function(fsm_desc,config,name,gclass_name,kw,gcflag){this.name=name||'';this.gclass_name=gclass_name||'';this.config=__duplicate__(config);json_object_update_config(this.config,kw||{});this.private=kw_extract_private(this.config);this.gcflag=gcflag;this.user_data={};this.yuno=undefined;this.parent=undefined;this.dl_subscriptions=[];this.dl_childs=[];this.tracing=0;this.trace_timer=0;this.running=false;this._destroyed=false;this.timer_id=-1;this.timer_event_name="EV_TIMEOUT";this.fsm_create(fsm_desc);return this;};proto.gobj_start=function()
{if(this.running){log_error("gobj_start() ALREADY RUNNING");return-1;}
this.running=true;if(this.mt_start){if(this.is_tracing()){log_debug(sprintf("⏺ ⏺ start: %s",this.gobj_full_name()));}
return this.mt_start();}
return 0;};proto.gobj_stop=function()
{if(!this.running){log_error("gobj_stop() NOT RUNNING");return-1;}
this.running=false;if(this.mt_stop){if(this.is_tracing()){log_debug(sprintf("⏺ ⏺ stop: %s",this.gobj_full_name()));}
this.mt_stop();}
if(this.__volatil__){return this.yuno.gobj_destroy(this);}
return 0;};proto.gobj_is_running=function()
{return this.running;};proto.gobj_start_tree=function()
{if(this.is_tracing()){log_debug(sprintf("⏺ ⏺ ⏺ ⏺ start_tree: %s",this.gobj_full_name()));}
if(!this.running){this.gobj_start();}
let set=this.dl_childs;for(let i=0;i<set.length;i++){let child=set[i];if(child){child.gobj_start_tree();}}
return 0;};proto.gobj_stop_tree=function()
{if(this.is_tracing()){log_debug(sprintf("⏺ ⏺ ⏺ ⏺ stop_tree: %s",this.gobj_full_name()));}
if(this.running){this.gobj_stop();}
let set=this.dl_childs;for(let i=0;i<set.length;i++){let child=set[i];if(child){child.gobj_stop_tree();}}
return 0;};proto._add_child=function(gobj){if(gobj.parent){log_error("GObj._add_child(): ALREADY HAS PARENT");}
this.dl_childs.push(gobj);gobj.parent=this;};proto._remove_child=function(gobj){let index=index_in_list(this.dl_childs,gobj);if(index>=0){this.dl_childs.remove(index);}};proto.gobj_child_by_index=function(index){return this.dl_childs[index];};proto.gobj_child_size=function()
{return this.dl_childs.length;};proto.gobj_is_service=function()
{return this.config.__service__;};proto.gobj_is_unique=function()
{return this.__unique__||this.__service__;};proto.gobj_is_volatil=function()
{return this.__volatil__;};proto.gobj_load_persistent_attrs=function()
{if(this.gobj_is_service()||this.gobj_is_unique()){if(this.yuno.__global_load_persistent_attrs_fn__){return this.yuno.__global_load_persistent_attrs_fn__(this);}}
return-1;};proto.gobj_save_persistent_attrs=function()
{if(this.gobj_is_service()||this.gobj_is_unique()){if(this.yuno.__global_save_persistent_attrs_fn__){return this.yuno.__global_save_persistent_attrs_fn__(this);}}
return-1;};proto.gobj_remove_persistent_attrs=function(recursive)
{if(!this.yuno.__global_remove_persistent_attrs_fn__){return-1;}
this.yuno.__global_remove_persistent_attrs_fn__(this,recursive);if(recursive){let set=this.dl_childs;for(let i=0;i<set.length;i++){let child=set[i];if(child){child.gobj_remove_persistent_attrs(recursive);}}}
return 0;};proto.gobj_get_writable_attrs=function()
{if(this.config&&this.config.__writable_attrs__){return this.config.__writable_attrs__;}else{return[];}};proto.gobj_update_writable_attrs=function(attrs)
{if(this.config&&this.config.__writable_attrs__){for(let attr in attrs){if(elm_in_list(attr,this.config.__writable_attrs__)){let new_value=attrs[attr];this.config[attr]=new_value;}}}};function _gobj_search_path(gobj,path)
{if(!is_gobj(gobj)){return 0;}
return gobj;}
proto.gobj_write_attr=function(path,value)
{if(!is_string(path)){log_error(sprintf("gobj_write_attr(%s): path must be a string",this.gobj_short_name()));return-1;}
let ss=path.split("`");if(ss.length<=1){let key=path;if(key in this.config){if(this.config.hasOwnProperty(key)){this.config[key]=value;if(this.mt_writing){this.mt_writing(key);}
return 0;}}
log_error(sprintf("gobj_write_attr(%s): attr not found '%s'",this.gobj_short_name(),key));return-1;}
let gobj=this;let len=ss.length;for(let i=0;i<len;i++){let key=ss[i];let child=gobj.gobj_find_child({"__gobj_name__":key});if(child&&i<len-1){gobj=child;continue;}
if(key in gobj.config){if(gobj.config.hasOwnProperty(key)){gobj.config[key]=value;if(gobj.mt_writing){gobj.mt_writing(key);}
return 0;}}
break;}
log_error(sprintf("gobj_write_attr(%s): attr not found '%s'",this.gobj_short_name(),key));return-1;};proto.gobj_read_attr=function(key)
{if(key in this.config){if(this.config.hasOwnProperty(key)){let value=this.config[key];if(this.mt_reading){return this.mt_reading(key,value);}
return value;}}
return null;};proto.gobj_write_user_data=function(key,value)
{this.user_data[key]=value;};proto.gobj_kw_set_user_data=function(path,value)
{return kw_set_dict_value(this.user_data,path,value);};proto.gobj_read_user_data=function(key)
{return this.user_data[key];};proto.gobj_kw_get_user_data=function(path,default_value,create)
{return kw_get_dict_value(this.user_data,path,default_value,create);};proto.gobj_has_attr=function(key)
{if(key in this.config){if(this.config.hasOwnProperty(key)){return true;}}
return false;};proto._match_child=function(properties)
{let __gclass_name__=properties.__gclass_name__;let __gobj_name__=properties.__gobj_name__;let __prefix_gobj_name__=properties.__prefix_gobj_name__;let __state__=properties.__state__;if(__gclass_name__){if(__gclass_name__!==this.gclass_name){return false;}}
if(__gobj_name__){if(__gobj_name__!==this.name){return false;}}
if(__prefix_gobj_name__){let l=__prefix_gobj_name__.length;let name=this.name.substring(0,l);if(__prefix_gobj_name__!==name){return false;}}
if(__state__){let state=this.gobj_current_state();if(__state__!==state){return false;}}
for(let key in properties){if(key==="__gclass_name__"||key==="__gobj_name__"||key==="__prefix_gobj_name__"||key==="__state__"){continue;}
if(this.gobj_has_attr(key)){if(this.config[key]!==properties[key]){return false;}}}
return true;};proto.gobj_find_child=function(kw)
{kw=kw||{};let set=this.dl_childs;for(let i=0;i<set.length;i++){let child=set[i];if(child._match_child(kw)){return child;}}
return null;};proto.gobj_child_by_name=function(name)
{return this.gobj_find_child({"__gobj_name__":name});};proto.gobj_match_childs=function(kw)
{kw=kw||{};let childs=[];let set=this.dl_childs;for(let i=0;i<set.length;i++){let child=set[i];if(child._match_child(kw)){childs.push(child);}}
return childs;};proto.gobj_build_webix_answer=function(gobj,result,comment,schema,data,kw){let webix={"result":result,"comment":comment,"schema":schema,"data":data};let webix_answer=msg_iev_answer(gobj,kw,webix);return webix_answer;};proto.gobj_command=function(command,kw,src){if(this.mt_command){let tracing=this.is_tracing();if(tracing){let hora=get_current_datetime();let msg=sprintf("%s%s!> cmd: %s, cmd: %s, src: %s",hora,this._tab(),this.gobj_short_name(),command,src?src.gobj_short_name():"undefined");log_debug(msg);if(tracing>1){trace_msg(kw);}}
return this.mt_command(command,kw,src);}
return this.gobj_build_webix_answer(this,-1,this.gobj_short_name()+" has no mt_command method.",null,null,kw);};proto.gobj_stats=function(stat,kw,src){if(this.mt_stats){return this.mt_stats(stat,kw,src);}
return this.gobj_build_webix_answer(this,-1,this.gobj_short_name()+" has no mt_stats method.",null,null,kw);};proto.set_machine_trace=function(value)
{this.tracing=value;};proto.is_tracing=function(event)
{if(event&&event==this.timer_event_name&&(this.yuno&&!this.yuno.config.trace_timer)){return false;}
return this.tracing||(this.yuno&&this.yuno.config.tracing);};proto.set_timeout=function(msec)
{let gobj=this;if(this.timer_id!==-1){clearTimeout(this.timer_id);this.timer_id=-1;}
if(msec!==-1){this.timer_id=setTimeout(function(){gobj.timer_id=-1;gobj.inject_event(gobj.timer_event_name);},msec);}};proto.clear_timeout=function()
{if(this.timer_id!==-1){clearTimeout(this.timer_id);this.timer_id=-1;}};proto.gobj_send_event=function(event,kw,src)
{if(!src){}
if(!kw){kw={};}
if(this.mt_inject_event){if(!this.gobj_event_in_input_event_list(event)){let tracing=this.is_tracing();if(tracing){let hora=get_current_datetime();let msg=sprintf("%s%s+> mach: %s, st: %s, ev: %s, src: %s",hora,this._tab(),this.gobj_short_name(),this.fsm.state_list[this.fsm.current_state-1],event,src?src.gobj_short_name():"undefined");log_debug(msg);if(tracing>1){trace_msg(kw);}}
return this.mt_inject_event(event,kw,src);}}
return this.inject_event(event,kw,src);};proto.gobj_event_in_input_event_list=function(event)
{let input_events=this.get_input_event_list();return elm_in_list(event,input_events);};proto.gobj_send_event_to_childs=function(event,kw,src)
{let set=this.dl_childs;for(let i=0;i<set.length;i++){let child=set[i];if(child){if(child.gobj_event_in_input_event_list(event)){child.gobj_send_event(event,kw,src);}}}};function _Subscription(publisher,event,kw,subscriber){this.publisher=publisher;this.subscriber=subscriber;this.event=event;this.renamed_event=null;this.hard_subscription=false;this.own_event=false;this.share_kw=false;this.__config__=null;this.__global__=null;this.__filter__=null;this.__service__=null;if(kw){let __global__=kw["__global__"];let __config__=kw["__config__"];let __filter__=kw["__filter__"];let __service__=kw["__service__"];if(__global__){this.__global__=__duplicate__(__global__);}
if(__config__){this.__config__=__duplicate__(__config__);if(kw_has_key(this.__config__,"__rename_event_name__")){let renamed_event=kw_get_str(this.__config__,"__rename_event_name__",0);this.renamed_event=renamed_event;delete this.__config__["__rename_event_name__"];let kw_global=this.__global__;if(!kw_global){kw_global={};this.__global__=kw_global;}
kw_global["__original_event_name__"]=event;}
if(kw_has_key(this.__config__,"__hard_subscription__")){this.hard_subscription=kw_get_bool(this.__config__,"__hard_subscription__",0);delete this.__config__["__hard_subscription__"];}
if(kw_has_key(this.__config__,"__own_event__")){this.own_event=kw_get_bool(this.__config__,"__own_event__",0);delete this.__config__["__own_event__"];}
if(kw_has_key(this.__config__,"__share_kw__")){this.share_kw=kw_get_bool(this.__config__,"__share_kw__",0);delete this.__config__["__share_kw__"];}}
if(__filter__){this.__filter__=__duplicate__(__filter__);}
if(__service__){this.__service__=__service__;}}}
function _find_subscription(dl_subs,publisher,event,kw,subscriber)
{let sub_list=[];let __global__=null;let __config__=null;let __filter__=null;if(kw){__global__=kw["__global__"];__config__=kw["__config__"];__filter__=kw["__filter__"];}
for(let i=0;i<dl_subs.length;i++){let subs=dl_subs[i];let match=true;if(subscriber){if(subscriber!=subs.subscriber){match=false;}}
if(event){if(event!=subs.event){match=false;}}
if(__config__){let kw_config=subs["__config__"];if(kw_config){if(!kw_is_identical(kw_config,__config__)){match=false;}}else{match=false;}}
if(__global__){let kw_global=subs["__global__"];if(kw_global){if(!kw_is_identical(kw_global,__global__)){match=false;}}else{match=false;}}
if(__filter__){let kw_filter=subs["__filter__"];if(kw_filter){if(!kw_is_identical(kw_filter,__filter__)){match=false;}}else{match=false;}}
if(match){sub_list.push(subs);}}
return sub_list;}
proto.gobj_find_subscriptions=function(event,kw,subscriber)
{return _find_subscription(this.dl_subscriptions,this,event,kw,subscriber);};proto._delete_subscription=function(subs,force)
{if(subs.hard_subscription){if(!force){return;}}
if(this.mt_subscription_deleted){this.mt_subscription_deleted(subs);}
delete_from_list(this.dl_subscriptions,subs);};proto.gobj_subscribe_event=function(event,kw,subscriber)
{if(!subscriber){log_error("GObj.gobj_subscribe_event(): subscriber NULL");return;}
if(!(typeof subscriber==='string'||subscriber instanceof GObj)){log_error("GObj.gobj_subscribe_event(): BAD TYPE subscriber");}
if(typeof subscriber==='string'){let new_subscriber=this.yuno.gobj_find_unique_gobj(subscriber);if(!new_subscriber){log_error("GObj.gobj_subscribe_event(): '"+subscriber+"' gobj NOT FOUND");return;}
subscriber=new_subscriber;}else if(subscriber instanceof GObj){}else{log_error("GObj.gobj_subscribe_event(): BAD TYPE subscriber");return;}
let output_events=this.get_output_event_list();if(event){if(typeof event!=='string'){let msg="GObj.gobj_subscribe_event('"+
this.gobj_short_name()+"') from "+subscriber.gobj_short_name()+": '"+
event+"' is not a string";log_error(msg);return 0;}
if(!(this.gcflag&gcflag_no_check_output_events)){if(!elm_in_list(event,output_events)){let msg="GObj.gobj_subscribe_event('"+
this.gobj_short_name()+"') from "+subscriber.gobj_short_name()+": '"+
event+"' not in output-event list";log_error(msg);return 0;}}}
let dl_subs=this.gobj_find_subscriptions(event,kw,subscriber);if(dl_subs.length>0){log_error(sprintf("subscription(s) REPEATED, event %s, publisher %s, subscriber %s: NEW IGNORED",event,this.gobj_short_name(),subscriber.gobj_short_name()));return 0;}
let subscription=new _Subscription(this,event,kw,subscriber);this.dl_subscriptions.push(subscription);if(this.mt_subscription_added){this.mt_subscription_added(subscription);}
return subscription;};proto.gobj_unsubscribe_event=function(event,kw,subscriber)
{let sub_list=this.gobj_find_subscriptions(event,kw,subscriber);if(sub_list.length){for(let i=0;i<sub_list.length;i++){this._delete_subscription(sub_list[i],false);}}else{log_error(sprintf("%s: gobj_unsubscribe_event(): event '%s', subscriber %s, NOT FOUND",this.gobj_short_name(),event,subscriber.gobj_short_name()));return-1;}
return 0;};proto.gobj_print_subscriptions=function()
{let lista=[];let subscriptions=this.dl_subscriptions;let len=subscriptions.length;for(let i=0;i<len;i++){let subs=subscriptions[i];if(!subs){continue;}
let item={publisher:subs.publisher.gobj_short_name(),subscriber:subs.subscriber.gobj_short_name(),event:subs.event,renamed_event:subs.renamed_event,hard_subscription:subs.hard_subscription,own_event:subs.own_event,__config__:__duplicate__(subs.__config__),__global__:__duplicate__(subs.__global__),__filter__:__duplicate__(subs.__filter__),__service__:__duplicate__(subs.__service__)};lista.push(item);}
return lista;};proto.gobj_unsubscribe_event2=function(hsub)
{return this._delete_subscription(hsub,false);};proto.gobj_unsubscribe_list=function(dl_subs,force)
{if(dl_subs.length){for(let i=0;i<dl_subs.length;i++){this._delete_subscription(dl_subs[i],force);}}};proto.gobj_publish_event=function(event,kw)
{let sent_count=0;if(!kw){kw={};}
if(empty_string(event)){let msg=sprintf("GObj.gobj_publish_event('%s'): event NULL",this.gobj_short_name());log_error(msg);return 0;}
let output_events=this.get_output_event_list();if(!(this.gcflag&gcflag_no_check_output_events)){if(!elm_in_list(event,output_events)){let msg=sprintf("GObj.gobj_publish_event('%s'): event '%s' not in output-event list",this.gobj_short_name(),event);log_error(msg);return 0;}}
let tracing=this.is_tracing(event);if(tracing){let hora=get_current_datetime();let msg=sprintf("%s%s**> mach: %s, st: %s, ev: %s",hora,this._tab(),this.gobj_short_name(),this.fsm.state_list[this.fsm.current_state-1],event);log_debug(msg);if(tracing>1){trace_msg(kw);}}
if(this.mt_publish_event){let topublish=this.mt_publish_event(event,kw);if(topublish<=0){return 0;}}
let global_kw_shared=kw_get_bool(kw,"__share_kw__",false);let subscriptions=this.dl_subscriptions;let len=subscriptions.length;for(let i=0;i<len;i++){let subs=subscriptions[i];if(!subs){continue;}
if(this.mt_publication_pre_filter){let topublish=this.mt_publication_pre_filter(subs,event,kw);if(topublish<0){break;}else if(topublish==0){continue;}}
let subscriber=subs.subscriber;if(subs.event===null||subs.event===undefined||event===subs.event){let kw2publish=null;let __global__=subs.__global__;let __filter__=subs.__filter__;let event_name=subs.renamed_event;if(empty_string(event_name)){event_name=event;}
if(__global__){kw2publish=__duplicate__(__global__);__extend_dict__(kw2publish,kw);}else{if(global_kw_shared||subs.share_kw){kw2publish=kw;}else{kw2publish=__duplicate__(kw);}}
let topublish=1;if(this.mt_publication_filter){topublish=this.mt_publication_filter(this,event,kw2publish,subscriber);}else if(__filter__){topublish=kw_match_simple(kw2publish,__filter__);}
if(topublish<0){break;}else if(topublish==0){continue;}
let ret=subscriber.gobj_send_event(event_name,kw2publish,this);if(ret<0&&subs.own_event){sent_count=-1;break;}
sent_count++;if(this._destroyed){break;}}}
if(!sent_count){let event_id=this.fsm.event_index[event]||0;let attrs=this.fsm.event_attrs[event_id-1]||{};if(!elm_in_list("no_warn_subs",attrs)){if(!this._destroyed){log_warning("Publish event WITHOUT subscribers: "+
this.gobj_short_name()+", "+event);}}}
return sent_count;};proto.gobj_parent=function()
{return this.parent;};proto.gobj_full_name=function()
{let self=this;let full_name=self.gobj_short_name();let parent=self.parent;while(parent){let prefix=parent.gobj_short_name();full_name=prefix+'`'+full_name;parent=parent.parent;}
return full_name;};proto.gobj_short_name=function()
{return this.gclass_name+'^'+this.name;};proto.gobj_escaped_short_name=function()
{return this.gclass_name+'-'+this.name;};proto.gobj_gclass_name=function()
{return this.gclass_name;};proto.gobj_name=function()
{return this.name;};proto.gobj_is_destroying=function()
{if(this._destroyed){return true;}
return false;};proto.fsm_create=function(fsm_desc)
{let self=this.fsm={};self.event_list=fsm_desc.event_list||[];self.event_attrs=[];self.state_list=fsm_desc.state_list||[];self.states=[];self.last_state=0;self.current_state=1;let state_names=__duplicate__(self.state_list);for(let st_name in fsm_desc.machine){if(elm_in_list(st_name,state_names)){delete_from_list(state_names,st_name);}else{log_error(this.gclass_name+": machine state: "+st_name+" is NOT in state-list");}}
if(state_names.length>0){log_error(this.gclass_name+": state-list OVERFILLED: "+state_names);}
let event_list=[];let event_attrs=[];for(let i=0;i<self.event_list.length;i++){let ev=self.event_list[i];let name=ev.split(":");let ev_name=name[0];ev_name=__strip__(ev_name);event_list.push(ev_name);let ev_attrs=name[1];ev_attrs=__strip__(ev_attrs);let attrs_list=ev_attrs.split(" ");event_attrs.push(attrs_list);}
self.event_list=event_list;self.event_attrs=event_attrs;let output_events=[];for(let idx=0;idx<self.event_list.length;idx++){let ev_name=self.event_list[idx];let attrs=self.event_attrs[idx];if(elm_in_list("output",attrs)){output_events.push(ev_name);}}
self.output_events=__set__(output_events);let event_names=__duplicate__(self.event_list);let set_event_names=__duplicate__(self.output_events);for(let st in fsm_desc.machine){if(fsm_desc.machine.hasOwnProperty(st)){let st_desc=fsm_desc.machine[st];let len=st_desc.length;for(let idx=0;idx<len;idx++){let ev_ac_nt=st_desc[idx];if(!ev_ac_nt){continue;}
let ev_name=ev_ac_nt[0];let ac=ev_ac_nt[1];let nt=ev_ac_nt[2];if(elm_in_list(ev_name,event_names)){set_event_names.push(ev_name);}else{log_error(this.gclass_name+": event NOT in event-list: "+ev_name);}}}}
set_event_names=__set__(set_event_names);if(event_names.length!==set_event_names.length){let diff=get_str_list_difference(event_names,set_event_names);log_error(sprintf("%s: event-list OVERFILLED: %j",this.gclass_name,diff));}
state_names=__duplicate__(self.state_list);for(let st in fsm_desc.machine){if(fsm_desc.machine.hasOwnProperty(st)){let st_desc=fsm_desc.machine[st];let len=st_desc.length;for(let idx=0;idx<len;idx++){let ev_ac_nt=st_desc[idx];if(!ev_ac_nt){continue;}
let ev_name=ev_ac_nt[0];let ac=ev_ac_nt[1];let nt=ev_ac_nt[2];if(nt&&!elm_in_list(nt,state_names)){log_error(this.gclass_name+": next statename: "+nt+" is NOT in state-list");}
if(ac&&typeof ac!=='function'){log_error(this.gclass_name+": action: "+ac+" is NOT a FUNCTION");}}}}
self.state_index={'':0};for(let i=0;i<self.state_list.length;i++){let elm=self.state_list[i];self.state_index[elm]=i+1;}
self.event_index={'':0};for(let i=0;i<self.event_list.length;i++){let elm=self.event_list[i];self.event_index[elm]=i+1;}
self.states=new Array(self.state_list.length+1);for(let i=0;i<self.state_list.length;i++){let st=self.state_list[i];let st_idx=self.state_index[st];let st_desc=fsm_desc.machine[st];self.states[st_idx]=new Array(self.event_list.length+1);for(let j=0;j<st_desc.length;j++){let ev_ac_nt=st_desc[j];if(!ev_ac_nt){continue;}
let iev=self.event_index[ev_ac_nt[0]];let ac=ev_ac_nt[1];let next_state_id;if(ev_ac_nt[2]){next_state_id=self.state_index[ev_ac_nt[2]];}else{next_state_id=undefined;}
self.states[st_idx][iev]=[ac,next_state_id];}}};proto.gobj_in_this_state=function(state)
{if(this.gobj_current_state()==state){return true;}
return false;};proto.gobj_change_state=function(new_state)
{let state_id=this.fsm.state_index[new_state]||0;if(state_id<=0){log_error(this.gclass_name+": change_state() state UNKNOWN: "+new_state);return;}
this._change_state(state_id);};proto._change_state=function(state_id)
{let fsm=this.fsm;if(state_id<=0||state_id>fsm.state_list.length){log_error(this.gclass_name+": _change_state() state_id INVALID "+state_id);}
let tracing=this.is_tracing();fsm.last_state=fsm.current_state;fsm.current_state=state_id;if(tracing){if(fsm.last_state!==state_id){let hora=get_current_datetime();let msg=sprintf("%s%s - mach: %s, new_st: %s",hora,this._tab(),this.gobj_short_name(),this.fsm.state_list[this.fsm.current_state-1]);log_debug(msg);}}};proto.gobj_current_state=function()
{let fsm=this.fsm;if(fsm.current_state<=0||fsm.state_list.length==0){return null;}
return fsm.state_list[fsm.current_state-1];};proto.inject_event=function(event,kw,src)
{let fsm=this.fsm;let result=-1;let action=null;if(typeof event!=='string'){log_error("inject_event() invalid event TYPE");return-1;}
let tracing=this.is_tracing(event);let hora=null;if(tracing){hora=get_current_datetime();}
let event_id=fsm.event_index[event]||0;if(event_id<=0){let msg=sprintf("EVENT UNKNOWN -> mach: %s, st: %s, ev: %s",this.gobj_short_name(),this.fsm.state_list[this.fsm.current_state-1],event);log_error(msg);if(tracing>1){trace_msg(kw);}
return-1;}
this._increase_inside();if(fsm.states){action=fsm.states[fsm.current_state][event_id];}
if(!action){let msg=sprintf("%s<> mach: %s, st: %s, ev: %s, src: %s (REFUSED, no match action)",hora,this.gobj_short_name(),this.fsm.state_list[this.fsm.current_state-1],event,src?src.gobj_short_name():"undefined");log_warning(msg);if(tracing>1){trace_msg(kw);}
this._decrease_inside();return-1;}
if(tracing){let action_name="";if(action[0]){action_name=get_function_name(action[0]);}
let msg=sprintf("%s%s-> mach: %s, st: %s, ev: %s, ac: %s, src: %s",hora,this._tab(),this.gobj_short_name(),this.fsm.state_list[this.fsm.current_state-1],event,action_name,src?src.gobj_short_name():"undefined");log_debug(msg);if(tracing>1){trace_msg(kw);}}
if(action[1]){this._change_state(action[1]);}
if(tracing){if(action[0]){result=action[0](this,event,kw,src);}}else{try{if(action[0]){result=action[0](this,event,kw,src);}}catch(e){log_error(e);}}
if(tracing){let msg=sprintf("%s%s<- mach: %s, st: %s, ev: %s, ret: %d",hora,this._tab(),this.gobj_short_name(),this.fsm.state_list[this.fsm.current_state-1],event,Number(result));log_debug(msg);}
this._decrease_inside();return result;};proto.get_input_event_list=function()
{return this.fsm.event_list||[];};proto.get_output_event_list=function()
{return this.fsm.output_events||[];};proto.current_state=function()
{if(this.fsm.current_state<=0||this.fsm.state_list.length===0){return undefined;}
return this.fsm.state_list[this.fsm.current_state-1];};proto._tab=function()
{let spaces,pad;if(__inside_event_loop__<=0){spaces=1;}else{spaces=__inside_event_loop__*2;}
pad='';while(spaces--){pad+=' ';}
return pad;};proto._increase_inside=function()
{__inside_event_loop__+=1;};proto._decrease_inside=function()
{__inside_event_loop__-=1;};let gcflag_manual_start=0x0001;let gcflag_no_check_output_events=0x0002;exports.GObj=GObj;exports.get_current_datetime=get_current_datetime;exports.gcflag_manual_start=gcflag_manual_start;exports.gcflag_no_check_output_events=gcflag_no_check_output_events;})(this);(function(exports){"use strict";var __jn_global_settings__=null;var __global_load_persistent_attrs_fn__=null;var __global_save_persistent_attrs_fn__=null;var __global_remove_persistent_attrs_fn__=null;var __global_list_persistent_attrs_fn__=null;var __global_command_parser_fn__=null;var __global_stats_parser_fn__=null;var CONFIG={changesLost:false,tracing:0,no_poll:0,trace_timer:0,trace_inter_event:false,trace_creation:false,trace_ievent_callback:null};var FSM={'event_list':['EV_TIMEOUT: top output'],'state_list':['ST_IDLE'],'machine':{'ST_IDLE':[['EV_TIMEOUT',null,'ST_IDLE']]}};var _gclass_register={};var Yuno=GObj.__makeSubclass__();var proto=Yuno.prototype;proto.__init__=function(yuno_name,yuno_role,yuno_version,kw){GObj.prototype.__init__.call(this,FSM,CONFIG,yuno_name,"Yuno",kw,0);this.yuno_role=yuno_role;this.yuno_name=yuno_name;this.yuno_version=yuno_version;this.config.yuno_role=yuno_role;this.config.yuno_name=yuno_name;this.config.yuno_version=yuno_version;this.__service__=false;this.__unique__=false;this.__volatil__=false;this.parent=null;this.yuno=this;this._inside=0;this._unique_gobjs={};this._service_gobjs={};this.__jn_global_settings__=__jn_global_settings__;this.__global_load_persistent_attrs_fn__=__global_load_persistent_attrs_fn__;this.__global_save_persistent_attrs_fn__=__global_save_persistent_attrs_fn__;this.__global_remove_persistent_attrs_fn__=__global_remove_persistent_attrs_fn__;this.__global_list_persistent_attrs_fn__=__global_list_persistent_attrs_fn__;this.__global_command_parser_fn__=null;this.__global_stats_parser_fn__=null;this.mt_create(kw);};proto.mt_create=function(kw)
{};function gobj_start_up(jn_global_settings,load_persistent_attrs_fn,save_persistent_attrs_fn,remove_persistent_attrs_fn,list_persistent_attrs_fn,global_command_parser_fn,global_stats_parser_fn)
{__jn_global_settings__=0;__global_load_persistent_attrs_fn__=load_persistent_attrs_fn;__global_save_persistent_attrs_fn__=save_persistent_attrs_fn;__global_remove_persistent_attrs_fn__=remove_persistent_attrs_fn;__global_list_persistent_attrs_fn__=list_persistent_attrs_fn;__global_command_parser_fn__=global_command_parser_fn;__global_stats_parser_fn__=global_stats_parser_fn;return 0;}
function gobj_register_gclass(gclass,gclass_name)
{if(!gclass||!gclass_name){let msg="Yuno.gobj_register_gclass(): gclass undefined";log_error(msg);return-1;}
let gclass_=_gclass_register[gclass_name];if(gclass_){let msg="Yuno.gobj_register_gclass(): '"+
gclass_name+"' ALREADY REGISTERED";log_error(msg);return-1;}
_gclass_register[gclass_name]=gclass;return 0;}
function gobj_find_gclass(gclass_name,verbose)
{let gclass;try{gclass=_gclass_register[gclass_name];}catch(e){if(verbose){log_error("Yuno.gobj_find_gclass(): '"+gclass_name+"' gclass not found");}
return null;}
return gclass;}
function gobj_get_gclass_config(gclass_name,verbose)
{let gclass=gobj_find_gclass(gclass_name,verbose);if(gclass&&gclass.prototype.mt_get_gclass_config){return gclass.prototype.mt_get_gclass_config.call();}else{if(verbose){log_error(sprintf("gobj_get_gclass_config: '%s' gclass without mt_get_gclass_config",gclass_name));}
return null;}}
function gobj_list_persistent_attrs()
{if(!__global_list_persistent_attrs_fn__){return null;}
return __global_list_persistent_attrs_fn__();}
proto._gobj_create=function(name,gclass,kw,parent,is_service,is_unique,is_volatil)
{if(is_string(gclass)){let gclass_=gclass;gclass=gobj_find_gclass(gclass_,false);if(!gclass){log_error("GClass not found: '"+gclass_+"'");return null;}}
if(!empty_string(name)){if(name.indexOf("`")>=0){log_error("GObj name cannot contain \"`\" char: '"+name+"'");return null;}
if(name.indexOf("^")>=0){log_error("GObj name cannot contain \"^\" char: '"+name+"'");return null;}}else{name="";}
if(!(typeof parent==='string'||parent instanceof GObj)){log_error("Yuno.gobj_create() BAD TYPE of parent: "+parent);return null;}
if(typeof parent==='string'){parent=this.gobj_find_unique_gobj(parent);if(!parent){let msg="Yuno.gobj_create('"+name+"'): "+"WITHOUT registered named PARENT: '"+parent+"'";log_warning(msg);return null;}}
let gobj=new gclass(name,kw);gobj.yuno=this;if(this.config.trace_creation){let gclass_name=gobj.gclass_name||'';log_debug(sprintf("💙💙⏩ creating: %s%s %s^%s",is_service?"service":"",is_unique?"unique":"",gclass_name,name));}
if(!gobj.gobj_load_persistent_attrs){let msg="Check GClass of '"+name+"': don't look a GClass";log_error(msg);return null;}
if(name){}
if(is_unique){if(!this._register_unique_gobj(gobj)){return null;}
gobj.__unique__=true;}else{gobj.__unique__=false;}
if(is_service){if(!this._register_service_gobj(gobj)){return null;}
gobj.__service__=true;}else{gobj.__service__=false;}
if(is_service||is_unique){gobj.gobj_load_persistent_attrs();}
if(is_volatil){gobj.__volatil__=true;}else{gobj.__volatil__=false;}
if(parent){parent._add_child(gobj);}
if(gobj.mt_create){gobj.mt_create(kw);}
if(parent&&parent.mt_child_added){if(this.config.trace_creation){log_debug(sprintf("👦👦🔵 child_added(%s): %s",parent.gobj_full_name(),gobj.gobj_short_name()));}
parent.mt_child_added(gobj);}
if(this.config.trace_creation){log_debug("💙💙⏪ created: "+gobj.gobj_full_name());}
return gobj;};proto.gobj_create=function(name,gclass,kw,parent)
{return this._gobj_create(name,gclass,kw,parent,false,false,false);};proto.gobj_create_unique=function(name,gclass,kw,parent)
{if(this._exist_unique_gobj(name)){var msg="GObj unique ALREADY exits: "+name;log_error(msg);return null;}
return this._gobj_create(name,gclass,kw,parent,false,true,false);};proto.gobj_create_service=function(name,gclass,kw,parent)
{if(this._exist_service_gobj(name)){var msg="GObj service ALREADY exists: "+name;log_error(msg);return null;}
return this._gobj_create(name,gclass,kw,parent,true,false,false);};proto.gobj_create_volatil=function(name,gclass,kw,parent)
{return this._gobj_create(name,gclass,kw,parent,false,false,true);};proto.gobj_destroy=function(gobj){var self=this;if(!gobj){log_error("gobj_destroy(): gobj NULL");return;}
if(this.config.trace_creation){log_debug("<========== DESTROYED "+gobj.gclass_name+"^"+gobj.name);}
if(gobj._destroyed){log_debug("<========== ALREADY DESTROYED! "+gobj.gclass_name+"^"+gobj.name);try{throw new Error();}catch(e){console.log(e.stack);}
return;}
if(gobj.gobj_is_running()){gobj.gobj_stop();}
gobj._destroyed=true;if(gobj.parent&&gobj.parent.mt_child_removed){gobj.parent.mt_child_removed(gobj);}
if(gobj.parent){gobj.parent._remove_child(gobj);}
if(gobj.gobj_is_unique()){this._deregister_unique_gobj(gobj);}
if(gobj.gobj_is_service()){this._deregister_service_gobj(gobj);}
var dl_childs=gobj.dl_childs.slice();for(var i=0;i<dl_childs.length;i++){var child=dl_childs[i];if(!child._destroyed){self.gobj_destroy(child);}}
gobj.clear_timeout();gobj.gobj_unsubscribe_list(gobj.gobj_find_subscriptions(),true);if(gobj.mt_destroy){gobj.mt_destroy();}};proto._exist_unique_gobj=function(name){var self=this;if(kw_has_key(self._unique_gobjs,name)){return true;}
return false;};proto._register_unique_gobj=function(gobj){var self=this;var named_gobj=self._unique_gobjs[gobj.name];if(named_gobj){var msg="GObj unique ALREADY REGISTERED: "+gobj.name;log_error(msg);return false;}
self._unique_gobjs[gobj.name]=gobj;return true;};proto._deregister_unique_gobj=function(gobj){var self=this;var named_gobj=self._unique_gobjs[gobj.name];if(named_gobj){delete self._unique_gobjs[gobj.name];return true;}
return false;};proto._exist_service_gobj=function(name){var self=this;if(kw_has_key(self._service_gobjs,name)){return true;}
return false;};proto._register_service_gobj=function(gobj){var self=this;var named_gobj=self._service_gobjs[gobj.name];if(named_gobj){var msg="GObj service ALREADY REGISTERED: "+gobj.name;log_error(msg);return false;}
self._service_gobjs[gobj.name]=gobj;return true;};proto._deregister_service_gobj=function(gobj){var self=this;var named_gobj=self._service_gobjs[gobj.name];if(named_gobj){delete self._service_gobjs[gobj.name];return true;}
return false;};proto.gobj_find_unique_gobj=function(gobj_name,verbose)
{let named_gobj=this._unique_gobjs[gobj_name];if(named_gobj){return named_gobj;}
named_gobj=this._service_gobjs[gobj_name];if(!named_gobj&&verbose){log_warning("gobj unique not found: '"+gobj_name+"'");}
return named_gobj;};proto.gobj_find_service=function(service_name,verbose)
{let service_gobj=this._service_gobjs[service_name];if(!service_gobj&&verbose){log_warning("gobj service not found: '"+service_name+"'");}
return service_gobj;};function its_me(gobj,shortname)
{let n=shortname.split("^");let gobj_name=null;let gclass_name=null;if(n.length===2){gclass_name=n[0];gobj_name=n[1];if(gclass_name!==gobj.gobj_gclass_name()){return false;}}else if(n.length===1){gobj_name=n[0];}else{return false;}
if(gobj_name===gobj.gobj_name()){return true;}
return false;}
function _gobj_search_path(gobj,path)
{if(!path){return null;}
var p=path.split("`");var shortname=p[0];if(!its_me(gobj,shortname)){return null;}
if(p.length==1){return gobj;}
var n=p[1];var nn=n.split("^");var filter={};if(nn.length==1){filter.__gobj_name__=nn;}else{filter.__gclass_name__=nn[0];filter.__gobj_name__=nn[1];}
var child=gobj.gobj_find_child(filter);if(!child){return null;}
p.splice(0,1);p=p.join("`");return _gobj_search_path(child,p);}
proto.gobj_find_gobj=function(path)
{return _gobj_search_path(this,path);};proto.gobj_find_public_event_service=function(event)
{for(let gobj_name in this._unique_gobjs){if(!this._unique_gobjs.hasOwnProperty(gobj_name)){continue;}
let gobj=this._unique_gobjs[gobj_name];if(gobj.gobj_event_in_input_event_list(event)){return gobj;}}
return null;};proto.gobj_list_gobj_tree=function(gobj)
{function _add_gobj_to_webix_tree(d,o)
{let content={"id":o.gobj_full_name(),"value":o.gobj_short_name()};d.push(content);let dl_childs=o.dl_childs;if(dl_childs.length>0){let d2=[];content['data']=d2;for(let i=0;i<dl_childs.length;i++){let child=dl_childs[i];_add_gobj_to_webix_tree(d2,child);}}}
let data=[];_add_gobj_to_webix_tree(data,gobj);return data;};proto.gobj_list_gobj_attr=function(gobj)
{let data=[];if(!gobj||!gobj.config){return data;}
for(let attr in gobj.config){if(gobj.config.hasOwnProperty(attr)){data.push({name:attr,type:typeof(gobj.config[attr]),description:'',stats:0,value:gobj.config[attr]});}}
data.push({name:'__state__',type:'string',description:'',stats:0,value:gobj.gobj_current_state()});data.push({name:'__running__',type:'boolean',description:'',stats:0,value:gobj.gobj_is_running()});return data;};exports.Yuno=Yuno;exports.gobj_register_gclass=gobj_register_gclass;exports.gobj_find_gclass=gobj_find_gclass;exports.gobj_get_gclass_config=gobj_get_gclass_config;exports.gobj_start_up=gobj_start_up;})(this);(function(exports){"use strict";var CONFIG={timeout_retry:5,timeout_idack:5,_wanted_yuno_name:null,_wanted_yuno_role:null,_wanted_yuno_service:null,remote_yuno_name:null,remote_yuno_role:null,remote_yuno_service:null,required_services:null,inside_on_open:false,jwt:null,urls:null,idx_url:0};var IEVENT_MESSAGE_AREA_ID="ievent_gate_stack";function setup_websocket(self)
{var url=self.config.urls[self.config.idx_url];log_debug("====> Starting WebSocket to '"+url+"' ("+self.gobj_short_name()+")");function on_open_event(gobj){return function(){gobj.gobj_send_event('EV_ON_OPEN',{url:url},gobj);};}
function on_close_event(gobj){return function(){gobj.gobj_send_event('EV_ON_CLOSE',{url:url},gobj);};}
function on_error_event(gobj){return function(){gobj.gobj_send_event('EV_ON_CLOSE',{url:url},gobj);};}
function on_message_event(gobj){return function(e){gobj.gobj_send_event('EV_ON_MESSAGE',{url:url,data:e.data},gobj);};}
let websocket;try{websocket=new WebSocket(url);if(!websocket){log_error(self.gobj_short_name()+": Cannot open WebSocket to '"+url+"'");return;}}catch(e){log_error(self.gobj_short_name()+": Cannot open WebSocket to '"+url+"'");return;}
websocket.onopen=on_open_event(self);websocket.onclose=on_close_event(self);websocket.onerror=on_error_event(self);websocket.onmessage=on_message_event(self);return websocket;}
function trace_inter_event(self,prefix,iev)
{let hora=get_current_datetime();try{log_debug("\n"+hora+" "+prefix+"\n");trace_msg(iev);}catch(e){log_debug("ERROR in trace_inter_event: "+e);}}
function InterEvent(event,kw){this.event=event;this.kw=kw||{};}
function iev_create(event,kw)
{if(empty_string(event)){log_error("iev_create() event NULL");return null;}
var iev=new InterEvent(event,kw);return iev;}
function send_iev(self,iev)
{var msg=JSON.stringify(iev);if(self.yuno.config.trace_inter_event){var url=self.config.urls[self.config.idx_url];var prefix=self.yuno.yuno_name+' ==> '+url;if(self.yuno.config.trace_ievent_callback){var size=msg.length;self.yuno.config.trace_ievent_callback(prefix,iev,1,size);}else{trace_inter_event(self,prefix,iev);}}
try{self.websocket.send(msg);}catch(e){log_error(self.gobj_short_name()+": send_iev(): "+e);log_error(msg);}
return 0;}
function send_static_iev(self,event,kw)
{var iev=iev_create(event,kw);return send_iev(self,iev);}
function build_ievent_request(self,src_service,dst_service)
{var jn_ievent_chain={dst_yuno:self.config._wanted_yuno_name,dst_role:self.config._wanted_yuno_role,dst_service:dst_service?dst_service:self.config._wanted_yuno_service,src_yuno:self.yuno.yuno_name,src_role:self.yuno.yuno_role,src_service:src_service};return jn_ievent_chain;}
function ievent_answer_filter(self,kw_answer,area_key,ivent_gate_stack,src)
{var ievent=json_array_get(ievent_gate_stack,0);var iev_src_service=kw_get_str(ievent,"src_service","");ievent["dst_yuno"]=self.config.remote_yuno_name;ievent["dst_role"]=self.config.remote_yuno_role;ievent["dst_service"]=iev_src_service;ievent["src_yuno"]=self.yuno.yuno_name;ievent["src_role"]=self.yuno.yuno_role;ievent["src_service"]=src.name;}
function send_identity_card(self)
{var kw={"yuno_role":self.yuno.yuno_role,"yuno_name":self.yuno.yuno_name,"yuno_version":self.yuno.yuno_version,"yuno_release":self.yuno.yuno_version,"yuneta_version":"4.19.0","playing":false,"pid":0,"jwt":self.config.jwt,"user_agent":navigator.userAgent,"launch_id":0,"yuno_startdate":"","required_services":self.config.required_services};var jn_ievent_id=build_ievent_request(self,self.parent.name,null);msg_iev_push_stack(kw,IEVENT_MESSAGE_AREA_ID,jn_ievent_id);self.set_timeout(self.config.timeout_idack*1000);return send_static_iev(self,"EV_IDENTITY_CARD",kw);}
function iev_create_from_json(self,data)
{let x;try{x=JSON.parse(data);}catch(e){log_error("parsing inter_event json: "+e);return null;}
if(!(x instanceof Object)){log_error("parsing inter_event: websocket data not a json object");return null;}
var event=x['event'];if(!event){log_error("parsing inter_event: no event");return null;}
if(typeof event!=='string'){log_error("parsing inter_event: event not a string");return null;}
var kw=x['kw'];if(!kw){log_error("parsing inter_kw: no kw");return null;}
if(!(kw instanceof Object)){log_error("parsing inter_event: kw not a json object");return null;}
var iev=new InterEvent(event,kw);return iev;}
function close_websocket(self)
{self.clear_timeout();if(self.websocket){try{if(self.websocket){if(self.websocket.close){self.websocket.close();}else if(self.websocket.websocket.close){self.websocket.websocket.close();}else{trace_msg("What fuck*! websocket.close?");}}}catch(e){log_error(self.gobj_short_name()+": close_websocket(): "+e);}}}
function ac_on_open(self,event,kw,src)
{var url=self.config.urls[self.config.idx_url];log_debug('Websocket opened: '+url);send_identity_card(self);return 0;}
function ac_on_close(self,event,kw,src)
{var url=self.config.urls[self.config.idx_url];log_debug('Websocket closed: '+url);if(self.websocket){try{if(self.websocket.close){self.websocket.close();}else if(self.websocket.websocket.close){self.websocket.websocket.close();}}catch(e){log_error(self.gobj_short_name()+": ac_on_close(): "+e);}
self.websocket=null;}
if(self.inform_on_close){self.inform_on_close=false;self.gobj_publish_event('EV_ON_CLOSE',{url:url,remote_yuno_name:self.config.remote_yuno_name,remote_yuno_role:self.config.remote_yuno_role,remote_yuno_service:self.config.remote_yuno_service});}
if(self.gobj_is_running()){var ln=self.config.urls.length;self.config.idx_url=(++self.config.idx_url)%ln;self.set_timeout(self.config.timeout_retry*1000);}
return 0;}
function ac_timeout_disconnected(self,event,kw,src)
{close_websocket(self);if(self.gobj_is_running()){self.websocket=setup_websocket(self);}
return 0;}
function ac_identity_card_ack(self,event,kw,src)
{self.clear_timeout();var request=msg_iev_get_stack(kw,IEVENT_MESSAGE_AREA_ID);var src_yuno=kw_get_str(request,"src_yuno","");var src_role=kw_get_str(request,"src_role","");var src_service=kw_get_str(request,"src_service","");var result=kw_get_int(kw,"result",-1);if(result<0){close_websocket(self);self.gobj_publish_event('EV_IDENTITY_CARD_REFUSED',{url:self.config.urls[self.config.idx_url],result:result,remote_yuno_name:src_yuno,remote_yuno_role:src_role,remote_yuno_service:src_service});}else{var services_roles=kw_get_dict_value(kw,"services_roles",{});var data=kw_get_dict_value(kw,"data",null);self.config.remote_yuno_role=src_role;self.config.remote_yuno_name=src_yuno;self.config.remote_yuno_service=src_service;self.gobj_change_state("ST_SESSION");self.config.inside_on_open=true;if(!self.inform_on_close){self.inform_on_close=true;self.gobj_publish_event('EV_ON_OPEN',{url:self.config.urls[self.config.idx_url],remote_yuno_name:src_yuno,remote_yuno_role:src_role,remote_yuno_service:src_service,services_roles:services_roles,data:data});}
self.config.inside_on_open=false;self.resend_subscriptions();}
return 0;}
function ac_timeout_wait_idAck(self,event,kw,src)
{send_identity_card(self);return 0;}
function ac_on_message(self,event,kw,src)
{let url=self.config.urls[self.config.idx_url];let size=kw.data.length;let iev_msg=iev_create_from_json(self,kw.data);if(self.yuno.config.trace_inter_event){let prefix=self.yuno.yuno_name+' <== '+url;if(self.yuno.config.trace_ievent_callback){self.yuno.config.trace_ievent_callback(prefix,iev_msg,2,size);}else{trace_inter_event(self,prefix,iev_msg);}}
let iev_event=iev_msg.event;let iev_kw=iev_msg.kw;if(!self.gobj_in_this_state("ST_SESSION")){if(self.gobj_event_in_input_event_list(iev_event)){self.gobj_send_event(iev_event,iev_kw,self);}else{log_error("ignoring event: "+iev_event+" for "+self.name);}
return 0;}
let msg_type=msg_get_msg_type(iev_kw);let event_id=msg_iev_get_stack(iev_kw,IEVENT_MESSAGE_AREA_ID);let dst_service=kw_get_str(event_id,"dst_service","");let dst_role=kw_get_str(event_id,"dst_role","");if(dst_role!=self.yuno.yuno_role){log_error("It's not my role, yuno_role: "+dst_role+", my_role: "+self.yuno.yuno_role);return 0;}
if(msg_type=='__subscribing__'){return 0;}
if(msg_type=='__unsubscribing__'){return 0;}
if(self.gobj_event_in_input_event_list(iev_event)){self.gobj_send_event(iev_event,iev_kw,self);return 0;}
let gobj_service=self.yuno.gobj_find_service(dst_service);if(gobj_service){if(gobj_service.gobj_event_in_input_event_list(iev_event)){gobj_service.gobj_send_event(iev_event,iev_kw,self);}else{log_error(gobj_service.gobj_short_name()+": event '"+iev_event+"' not in input event list");}}else{self.gobj_publish_event(iev_event,iev_kw);}
return 0;}
var FSM={"event_list":["EV_ON_MESSAGE","EV_IDENTITY_CARD_ACK","EV_ON_OPEN","EV_ON_CLOSE","EV_TIMEOUT"],"state_list":["ST_DISCONNECTED","ST_WAIT_IDENTITY_CARD_ACK","ST_SESSION"],"machine":{"ST_DISCONNECTED":[["EV_ON_OPEN",ac_on_open,"ST_WAIT_IDENTITY_CARD_ACK"],["EV_ON_CLOSE",ac_on_close,undefined],["EV_TIMEOUT",ac_timeout_disconnected,undefined]],"ST_WAIT_IDENTITY_CARD_ACK":[["EV_ON_MESSAGE",ac_on_message,undefined],["EV_IDENTITY_CARD_ACK",ac_identity_card_ack,undefined],["EV_ON_CLOSE",ac_on_close,"ST_DISCONNECTED"],["EV_TIMEOUT",ac_timeout_wait_idAck,undefined]],"ST_SESSION":[["EV_ON_MESSAGE",ac_on_message,undefined],["EV_ON_CLOSE",ac_on_close,"ST_DISCONNECTED"]]}};var IEvent=GObj.__makeSubclass__();var proto=IEvent.prototype;proto.__init__=function(name,kw){GObj.prototype.__init__.call(this,FSM,CONFIG,name,"IEvent",kw,gcflag_no_check_output_events);return this;};proto.mt_create=function(kw)
{var self=this;self.config._wanted_yuno_name=self.config.remote_yuno_name;self.config._wanted_yuno_role=self.config.remote_yuno_role;self.config._wanted_yuno_service=self.config.remote_yuno_service;};proto.mt_destroy=function()
{};proto.mt_start=function(kw)
{var self=this;self.config.idx_url=0;msg_iev_add_answer_filter(self,IEVENT_MESSAGE_AREA_ID,ievent_answer_filter);self.websocket=setup_websocket(self);};proto.mt_stop=function(kw)
{var self=this;close_websocket(self);};proto.mt_stats=function(stats,kw,src)
{let self=this;if(self.gobj_current_state()!="ST_SESSION"){return self.gobj_build_webix_answer(self,-1,self.config.remote_yuno_role+"^"+self.config.remote_yuno_name+" not in session.",null,null,kw);}
if(!kw){kw={};}
let jn_ievent_id=build_ievent_request(self,src.name,kw.service?kw.service:null);msg_iev_push_stack(kw,IEVENT_MESSAGE_AREA_ID,jn_ievent_id);kw["__stats__"]=stats;msg_iev_write_key(kw,"__stats__",stats);return send_static_iev(self,"EV_MT_STATS",kw);};proto.mt_command=function(command,kw,src)
{let self=this;if(self.gobj_current_state()!="ST_SESSION"){return self.gobj_build_webix_answer(self,-1,self.config.remote_yuno_role+"^"+self.config.remote_yuno_name+" not in session.",null,null,kw);}
if(!kw){kw={};}
let jn_ievent_id=build_ievent_request(self,src.name,kw.service?kw.service:null);msg_iev_push_stack(kw,IEVENT_MESSAGE_AREA_ID,jn_ievent_id);kw["__command__"]=command;msg_iev_write_key(kw,"__command__",command);return send_static_iev(self,"EV_MT_COMMAND",kw);};proto.mt_inject_event=function(event,kw,src)
{let self=this;if(self.gobj_current_state()!="ST_SESSION"){log_error("Not in session, ignore event: "+event);return-1;}
if(!kw){kw={};}
let jn_request=msg_iev_get_stack(kw,IEVENT_MESSAGE_AREA_ID);if(!jn_request){let __service__=null;if(kw_has_key(kw,"__service__")){__service__=kw.__service__;delete kw.__service__;}
let jn_ievent_id=build_ievent_request(self,src.name,__service__);msg_iev_push_stack(kw,IEVENT_MESSAGE_AREA_ID,jn_ievent_id);}
return send_static_iev(self,event,kw);};proto.send_remote_subscription=function(subs)
{if(empty_string(subs.event)){return;}
var kw={};var __global__=subs.__global__;var __config__=subs.__config__;var __filter__=subs.__filter__;if(__config__){kw["__config__"]=__duplicate__(__config__);}
if(__global__){kw["__global__"]=__duplicate__(__global__);}
if(__filter__){kw["__filter__"]=__duplicate__(__filter__);}
msg_set_msg_type(kw,"__subscribing__");var __service__=subs.__service__?subs.__service__:null;var jn_ievent_id=build_ievent_request(this,subs.subscriber.name,__service__);msg_iev_push_stack(kw,IEVENT_MESSAGE_AREA_ID,jn_ievent_id);send_static_iev(this,subs.event,kw);};proto.mt_subscription_added=function(subs)
{if(!this.gobj_in_this_state("ST_SESSION")){return;}
if(this.config.inside_on_open){return;}
this.send_remote_subscription(subs);};proto.mt_subscription_deleted=function(subs)
{if(!this.gobj_in_this_state("ST_SESSION")){return;}
if(empty_string(subs.event)){return;}
var kw={};var __global__=subs.__global__;var __config__=subs.__config__;var __filter__=subs.__filter__;if(__config__){kw["__config__"]=__duplicate__(__config__);}
if(__global__){kw["__global__"]=__duplicate__(__global__);}
if(__filter__){kw["__filter__"]=__duplicate__(__filter__);}
msg_set_msg_type(kw,"__unsubscribing__");var __service__=subs.__service__?subs.__service__:null;var jn_ievent_id=build_ievent_request(this,subs.subscriber.name,__service__);msg_iev_push_stack(kw,IEVENT_MESSAGE_AREA_ID,jn_ievent_id);send_static_iev(this,subs.event,kw);};proto.resend_subscriptions=function()
{var dl_subs=this.gobj_find_subscriptions();for(var i=0;i<dl_subs.length;i++){var subs=dl_subs[i];this.send_remote_subscription(subs);}};exports.IEvent=IEvent;})(this);(function(exports){"use strict";function _get_persistent_path(gobj)
{var path="persistent-attrs-"+gobj.gobj_short_name();return path;}
function db_load_persistent_attrs(gobj)
{var attrs=kw_get_local_storage_value(_get_persistent_path(gobj),null,false);if(attrs&&is_object(attrs)){__update_dict__(gobj.config,filter_dict(attrs,gobj.gobj_get_writable_attrs()));}}
function db_save_persistent_attrs(gobj)
{kw_set_local_storage_value(_get_persistent_path(gobj),filter_dict(gobj.config,gobj.gobj_get_writable_attrs()));}
function db_remove_persistent_attrs(gobj)
{kw_remove_local_storage_value(_get_persistent_path(gobj));}
function db_list_persistent_attrs()
{}
exports.db_load_persistent_attrs=db_load_persistent_attrs;exports.db_save_persistent_attrs=db_save_persistent_attrs;exports.db_remove_persistent_attrs=db_remove_persistent_attrs;exports.db_list_persistent_attrs=db_list_persistent_attrs;})(this);(function(exports){'use strict';let CONFIG={subscriber:null,container:"gui_canvas",background_color:"#cccccc",width:window.innerWidth,height:window.innerHeight,stage:null,main_layer:null,static_layer:null,modal_layer:null,debug_dimensions:false,_ka_container:null,_dl_activation:[],};let activation_service_json_desc={id:"",modal:false,super_modal:false,autoclose:false,};let first_resize=true;function get_e_src(target)
{while(target){if(target.gobj){return target.gobj;}
target=target.parent;}
return null;}
function get_current_active(self)
{if(self.private._dl_activation.length>0){return self.private._dl_activation[self.private._dl_activation.length-1];}
return null;}
function find_bind_gobj(k)
{if(k.gobj){return k.gobj;}
let k_parent=k.getParent?k.getParent():null;if(k_parent){return find_bind_gobj(k_parent);}}
function create_canvas(self)
{self.config.width=window.innerWidth;self.config.height=window.innerHeight;let stage=self.config.stage=new Konva.Stage({id:self.config.container,container:self.config.container,width:self.config.width,height:self.config.height});self.private._ka_container=stage;stage.gobj=self;let container=stage.container();stage.on("pointerup",function(e){let src=get_e_src(e.target);if(self.is_tracing()){log_warning(sprintf("%s.%s ==> (%s), cancelBubble: %s, gobj: %s, ka_id: %s, ka_name: %s","Ka_main","stage",e.type,(e.cancelBubble)?"Y":"N",src?src.gobj_short_name():"",kw_get_str(e.target.attrs,"id",""),kw_get_str(e.target.attrs,"name","")));}
let current_active_gobj=get_current_active(self);if(!current_active_gobj){return;}
if(src){let id=src.gobj_full_name();if(kwid_find_one_record(self.private._dl_activation,id)){if(current_active_gobj.gobj!=src){self.gobj_send_event("EV_ACTIVATE",{},src);}}}
if(current_active_gobj.modal&&!current_active_gobj.super_modal){if(current_active_gobj.gobj!=src){current_active_gobj.gobj.gobj_send_event("EV_HIDE",{},self);}}
if(current_active_gobj.autoclose){current_active_gobj.gobj.gobj_send_event("EV_HIDE",{},self);}});container.addEventListener("keydown",function(e){let kw={code:e.code,key:e.key,keyCode:e.keyCode,ctrlKey:e.ctrlKey,altKey:e.altKey,shiftKey:e.shiftKey,repeat:e.repeat};let current_active_gobj=get_current_active(self);let ret=0;if(current_active_gobj){switch(kw.keyCode){case 27:if((current_active_gobj.modal&&!current_active_gobj.super_modal)||current_active_gobj.autoclose){current_active_gobj.gobj.gobj_send_event("EV_HIDE",{},self);ret=-1;}
break;default:if(current_active_gobj.gobj.gobj_event_in_input_event_list("EV_KEYDOWN")){ret=current_active_gobj.gobj.gobj_send_event("EV_KEYDOWN",kw);}
break;}}else{self.gobj_publish_event("EV_KEYDOWN",kw);}
if(ret<0){e.preventDefault();e.stopPropagation();}});container.tabIndex=1;container.focus();container.addEventListener("focus",function(e){if(self.is_tracing()){log_warning(sprintf("%s.%s ==> (%s), cancelBubble: %s, gobj: %s, ka_id: %s, ka_name: %s","Ka_main","stage.container",e.type,(e.cancelBubble)?"Y":"N",self.gobj_short_name(),kw_get_str(e.target.attrs,"id",""),kw_get_str(e.target.attrs,"name","")));}
let current_active_gobj=get_current_active(self);if(current_active_gobj){current_active_gobj.gobj.gobj_send_event("EV_ACTIVATE",{},self);}});container.addEventListener("blur",function(e){if(self.is_tracing()){log_warning(sprintf("%s.%s ==> (%s), cancelBubble: %s, gobj: %s, ka_id: %s, ka_name: %s","Ka_main","stage.container",e.type,(e.cancelBubble)?"Y":"N",self.gobj_short_name(),kw_get_str(e.target.attrs,"id",""),kw_get_str(e.target.attrs,"name","")));}
let current_active_gobj=get_current_active(self);if(current_active_gobj){current_active_gobj.gobj.gobj_send_event("EV_DEACTIVATE",{},self);}});stage.container().style.backgroundColor=self.config.background_color;}
function create_layers(self)
{let stage=self.config.stage;let modal_layer=self.config.modal_layer=new Konva.Layer({id:"modal_layer"});modal_layer.gobj=self;let main_layer=self.config.main_layer=new Konva.Layer({id:"main_layer"});main_layer.gobj=self;let static_layer=self.config.static_layer=new Konva.Layer({id:"static_layer"});static_layer.gobj=self;stage.add(main_layer);stage.add(modal_layer);stage.add(static_layer);if(1){stage.on("contextmenu",function(e){let jn=null;let gobj=find_bind_gobj(e.target);if(gobj){let k=gobj.get_konva_container?gobj.get_konva_container():null;if(k){if(e.evt.ctrlKey){jn=log_konva_tree0(k,false);}else if(e.evt.altKey){jn=log_konva_tree0(self.get_konva_container(),false);}else{jn=__yuno__.gobj_list_gobj_tree(__yuno__);}
create_json_editor_window({props:{indentation:4,content:{text:undefined,json:jn}}});e.evt.preventDefault();e.evt.stopPropagation();}}else{jn=e.target;}});}
if(self.config.debug_dimensions){let node_info=null;if(!node_info){node_info=new Konva.Text({id:"__debug_dimensions__",text:"()",fontSize:14,draggable:true,x:100,y:100,});modal_layer.add(node_info);}
stage.on("pointerenter pointerover",function(e){if(node_info){let id=e.target.id&&e.target.id();if(id!=="__debug_dimensions__"){let gobj=find_bind_gobj(e.target);let gobj_name=gobj?gobj.gobj_short_name():"";let dim_abs=e.target.getClientRect({skipShadow:true,skipStroke:true});let parent_container;try{parent_container=gobj.gobj_parent().get_konva_container();}catch(xx){parent_container=e.target.getParent();}
let dim_rel=e.target.getClientRect({skipShadow:true,skipStroke:true,relativeTo:parent_container});let info=sprintf("(x %f, y %f, w %f, h %f),(x %f, y %f, w %f, h %f) stroke %d, blur %d, %s %s %s",dim_rel.x,dim_rel.y,dim_rel.width,dim_rel.height,dim_abs.x,dim_abs.y,dim_abs.width,dim_abs.height,e.target.strokeWidth?e.target.strokeWidth():0,e.target.shadowBlur?e.target.shadowBlur():0,e.target.id(),e.target.name(),gobj_name);node_info.moveToTop();dim_abs=e.target.getClientRect();node_info.position({x:dim_abs.x<0?0:dim_abs.x,y:dim_abs.y<0?0:dim_abs.y});node_info.text(info);}}});}}
function subscribe_to_system_resize(self)
{window.onresize=resize;function resize(){document.body.style.width=window.innerWidth+"px";document.body.style.height=window.innerHeight+"px";self.config.width=window.innerWidth;self.config.height=window.innerHeight;self.gobj_send_event("EV_RESIZE",{width:self.config.width,height:self.config.height},self);}}
function ac_activate(self,event,kw,src)
{let id=src&&src.gobj_full_name();if(empty_string(id)){log_error(sprintf("%s: ac_activate() src null",self.gobj_short_name()));return-1;}
let prev_active_record=get_current_active(self);if(prev_active_record&&id!==prev_active_record.id){prev_active_record.gobj.gobj_send_event("EV_DEACTIVATE",{},self);}
if(kwid_find_one_record(self.private._dl_activation,id)){kwid_delete_record(self.private._dl_activation,id);}
let new_record=create_json_record(activation_service_json_desc,kw);json_object_update_existing(new_record,src.config);new_record["id"]=id;new_record["gobj"]=src;self.private._dl_activation.push(new_record);if(new_record.modal||new_record.super_modal){src.get_konva_container().moveTo(self.config.modal_layer);self.config.modal_layer.moveToTop();self.config.main_layer.opacity(0.2);self.config.static_layer.opacity(0.2);self.config.main_layer.listening(false);self.config.static_layer.listening(false);}
new_record.gobj.gobj_send_event("EV_ACTIVATE",{},self);return 0;}
function ac_deactivate(self,event,kw,src)
{let id=src&&src.gobj_full_name();if(empty_string(id)){log_error(sprintf("%s: ac_deactivate(), src NULL",self.gobj_short_name()));return-1;}
let prev_active_record=get_current_active(self);let record_to_deactivate=kwid_find_one_record(self.private._dl_activation,id);if(record_to_deactivate){if((record_to_deactivate.modal||record_to_deactivate.super_modal)){src.get_konva_container().moveTo(self.config.main_layer);self.config.main_layer.moveToTop();self.config.static_layer.moveToTop();self.config.main_layer.opacity(1);self.config.static_layer.opacity(1);self.config.main_layer.listening(true);self.config.static_layer.listening(true);}
kwid_delete_record(self.private._dl_activation,id);}else{log_error(sprintf("%s: deactivate src not found: %s",self.gobj_short_name(),id));}
src.gobj_send_event("EV_DEACTIVATE",{},self);let new_active_record=get_current_active(self);if(new_active_record){if(new_active_record.id!=prev_active_record.id){new_active_record.gobj.gobj_send_event("EV_ACTIVATE",{},self);}}
return 0;}
function ac_resize(self,event,kw,src)
{let new_width=kw.width;let new_height=kw.height;if(first_resize||1){if(new_width>0&&new_height>0){self.config.stage.size({width:new_width,height:new_height});self.gobj_send_event_to_childs(event,kw,src);self.gobj_publish_event(event,kw,src);self.config.stage.draw();first_resize=false;}}else{if(new_width!==self.config.stage.width()||new_height!==self.config.stage.height()){let old_size=self.config.stage.size();self.config.stage.size({width:new_width,height:new_height});self.config.stage.scale({x:new_width/old_size.width,y:new_height/old_size.height});}}
return 0;}
let FSM={"event_list":["EV_ACTIVATE","EV_DEACTIVATE","EV_RESIZE: output no_warn_subs","EV_KEYDOWN: output no_warn_subs"],"state_list":["ST_IDLE"],"machine":{"ST_IDLE":[["EV_ACTIVATE",ac_activate,undefined],["EV_DEACTIVATE",ac_deactivate,undefined],["EV_RESIZE",ac_resize,undefined]]}};let Ka_main=GObj.__makeSubclass__();let proto=Ka_main.prototype;proto.__init__=function(name,kw){GObj.prototype.__init__.call(this,FSM,CONFIG,name,"Ka_main",kw,0);return this;};gobj_register_gclass(Ka_main,"Ka_main");proto.mt_create=function(kw)
{let self=this;let subscriber=self.gobj_read_attr("subscriber");if(!subscriber){subscriber=self.gobj_parent();}
self.gobj_subscribe_event(null,null,subscriber);document.body.style.backgroundColor=self.config.background_color;create_canvas(self);create_layers(self);};proto.mt_destroy=function()
{let self=this;};proto.mt_start=function(kw)
{let self=this;setTimeout(function(){self.config.stage.draw();subscribe_to_system_resize(self);},200);};proto.mt_stop=function(kw)
{let self=this;};proto.mt_child_added=function(kw)
{let self=this;let kw_size={width:self.config.width,height:self.config.height};self.gobj_send_event("EV_RESIZE",kw_size,self);};proto.get_konva_container=function()
{let self=this;return self.private._ka_container;};proto.get_stage=function()
{let self=this;return self.config.stage;};proto.get_main_layer=function()
{let self=this;return self.config.main_layer;};proto.get_static_layer=function()
{let self=this;return self.config.static_layer;};exports.Ka_main=Ka_main;exports.find_bind_gobj=find_bind_gobj;})(this);(function(exports){"use strict";function search_ka_nodes(ka_container,kw,callback)
{if(!container){log_error("search_ka_nodes(): ka_container not defined");return-1;}
if(kw_has_key(kw,"items")){let kw_items=kw_get_list(kw,"items",[],0);for(let i=0;i<kw_items.length;i++){let kw_item=kw_items[i];if(kw_item instanceof Konva.Node){if(kw_item.getParent()===ka_container){callback(null,kw_item);}else{log_error("search_ka_nodes(): ka_node not belong this container");}}else if(is_object(kw_item)){let __ka_node__=kw_get_dict_value(kw_item,"__ka_node__",null,false,false);if(__ka_node__){if(__ka_node__.getParent()===ka_container){callback(kw_item,__ka_node__);}else{log_error("search_ka_nodes(): ka_node not belong this container");}}else{let id=kw_get_str(kw_item,"id",null,false,false);if(!empty_string(id)){__ka_node__=container.find("#"+id);if(__ka_node__){callback(kw_item,__ka_node__);}}else{let name=kw_get_str(kw_item,"name",null,false,false);if(!empty_string(name)){let __ka_nodes__=container.find(name);if(__ka_nodes__){for(let i=0;i<__ka_nodes__.length;i++){callback(kw_item,__ka_nodes__[i]);}}}else{log_error("search_ka_nodes(): no params to find ka_node");}}}}else{log_error("search_ka_nodes(): what fuck is it?");}}}else{log_error("search_ka_nodes(): no items found");return-1;}
return 0;}
function display_text(layer,text,x,y)
{let size=get_text_size(text,"sans-serif",18,5);let ka_text=new Konva.Text({text:text,fontSize:18,fontFamily:"sans-serif",draggable:true,name:"text",x:is_number(x)?x:100,y:is_number(y)?y:100,width:size.width,height:size.height,shadowBlur:0});layer.add(ka_text);layer.draw();}
let __inside_loop__=0;function _tab()
{let spaces,pad;if(__inside_loop__<=0){spaces=1;}else{spaces=__inside_loop__*4;}
pad='';while(spaces--){pad+=' ';}
return pad;}
function increase_inside()
{__inside_loop__+=1;}
function decrease_inside()
{__inside_loop__-=1;}
function _log_konva_tree0(jn,k,verbose)
{increase_inside();if(verbose){let msg=sprintf("%s - k:'%s', gobj:'%s', id:'%s', name:'%s', str:%s, sha:%d, rel: %j, abs: %j",_tab(),k.getClassName(),k.gobj?k.gobj.gobj_short_name():"",k.getAttr("id"),k.getAttr("name"),k.getAttr("strokeWidth")?k.getAttr("strokeWidth"):0,k.getAttr("shadowBlur")?k.getAttr("shadowBlur"):0,k.getClientRect({relativeTo:k.getParent()}),k.getClientRect());log_debug(msg);}
json_object_update(jn,{konva:k.getClassName(),gobj:k.gobj?k.gobj.gobj_short_name():"",id:k.getAttr("id"),name:k.getAttr("name"),config:k.gobj?filter_dict(k.gobj.config,["x","y","width","height"]):"",position_size:Object.assign({},k.position(),k.size()),stroke:k.getAttr("strokeWidth")?k.getAttr("strokeWidth"):0,shadowBlue:k.getAttr("shadowBlur")?k.getAttr("shadowBlur"):0,clientrect_rel:k.getClientRect({relativeTo:k.getParent()}),clientrect_abs:k.getClientRect()});if(k.getChildren){let list=k.getChildren();let childs=jn["zchilds"]=[];for(let i=0;i<list.length;i++){let child=list[i];let _jn={};childs.push(_jn);_log_konva_tree0(_jn,child,verbose);}}
decrease_inside();}
function log_konva_tree0(container,verbose)
{__inside_loop__=0;let k=null;if(is_gobj(container)){k=container.get_konva_container();}else if(container instanceof Konva.Container){k=container;}
if(!k){return;}
let jn={};_log_konva_tree0(jn,k,verbose);return jn;}
function _log_konva_tree(jn,k,verbose)
{increase_inside();if(verbose){let msg=sprintf("%s - konva: '%s', gobj: '%s', id: '%s', name: '%s'",_tab(),k.getClassName(),k.gobj?k.gobj.gobj_short_name():"",k.getAttr("id"),k.getAttr("name"));log_debug(msg);}
json_object_update(jn,{konva:k.getClassName(),gobj:k.gobj?k.gobj.gobj_short_name():"",id:k.getAttr("id"),name:k.getAttr("name"),xattrs:k.getAttrs()});if(k.getChildren){let list=k.getChildren();let childs=jn["zchilds"]=[];for(let i=0;i<list.length;i++){let child=list[i];let _jn={};childs.push(_jn);_log_konva_tree(_jn,child,verbose);}}
decrease_inside();}
function log_konva_tree(container,verbose)
{__inside_loop__=0;let k=null;if(is_gobj(container)){k=container.get_konva_container();}else if(container instanceof Konva.Container){k=container;}
if(!k){return;}
let jn={};_log_konva_tree(jn,k,verbose);return jn;}
exports.search_ka_nodes=search_ka_nodes;exports.display_text=display_text;exports.log_konva_tree0=log_konva_tree0;exports.log_konva_tree=log_konva_tree;})(this);(function(exports){'use strict';let CONFIG={subscriber:null,layer:null,modal:false,super_modal:false,autoclose:false,x:undefined,y:undefined,width:300,height:300,padding:10,background_color:"white",visible:true,panning:true,draggable:false,autosize:false,fix_dimension_to_screen:false,center:false,show_overflow:false,top_on_activate:false,enable_vscroll:true,enable_hscroll:true,scroll_by_step:false,kw_border_shape:{strokeWidth:4,stroke:"black",opacity:1,shadowBlur:0,shadowColor:"black",shadowForStrokeEnabled:false},kw_border_shape_actived:{},hide_hscrollbar:false,hide_vscrollbar:false,scrollbar_min_large:12,scrollbar_width:10,scrollbar_padding:0,kw_scrollview_scrollbar_rect:{fill:"gray",opacity:0.8},items:[],quick_display:false,_ka_container:null,_ka_border_rect:null,_ka_viewport_rect:null,_ka_wrapper_content_group:null,_ka_content_group:null,_ka_content_rect:null,_ka_scrollbars_group:null,_ka_vscroll_rect:null,_ka_hscroll_rect:null,_vProportion_scroll2content:null,_hProportion_scroll2content:null,_vProportion_content2scroll:null,_hProportion_content2scroll:null,_strokeW:0,_shadowW:0,_padding:0,_x:0,_y:0,_original_x:null,_original_y:null,_original_width:null,_original_height:null,_util_width:null,_util_height:null};function create_scrollview(self,create)
{let ka_container;if(create){ka_container=self.private._ka_container=new Konva.Group({id:self.gobj_short_name(),name:"ka_container",x:kw_get_int(self.config,"x",get_auto_x(self),false,false),y:kw_get_int(self.config,"y",get_auto_y(self),false,false),width:self.config.width,height:self.config.height,visible:self.config.visible,draggable:self.config.draggable,listening:true});if(self.config.layer){self.config.layer.add(ka_container);}
ka_container.gobj=self;}else{ka_container=self.private._ka_container;ka_container.position({x:self.config.x,y:self.config.y});ka_container.size({width:self.config.width,height:self.config.height});}
let x=0;let y=0;let width=self.config.width;let height=self.config.height;let kw_border_shape=__duplicate__(kw_get_dict(self.config,"kw_border_shape",{},false,false));let strokeW=self.private._strokeW=kw_get_int(kw_border_shape,"strokeWidth",0,false,false);let shadowW=self.private._shadowW=kw_get_int(kw_border_shape,"shadowBlur",0,false,false);if(strokeW>0){x+=strokeW/2;y+=strokeW/2;width-=strokeW;height-=strokeW;}
if(shadowW>0){x+=shadowW;y+=shadowW;width-=shadowW*2;height-=shadowW*2;}
json_object_update(kw_border_shape,{id:self.gobj_short_name()+"-1",name:"ka_border_rect",x:x,y:y,width:width,height:height,fill:kw_get_str(self.config,"background_color",null,false,false)});if(create){let ka_border_rect=self.private._ka_border_rect=new Konva.Rect(kw_border_shape);ka_container.add(ka_border_rect);}else{self.private._ka_border_rect.position({x:x,y:y});self.private._ka_border_rect.size({width:width,height:height});}
if(self.config.quick_display){ka_container.draw();}
let padding=self.private._padding=kw_get_int(self.config,"padding",0,false,false);if(padding>0){x+=padding;y+=padding;width-=padding*2;height-=padding*2;}
if(strokeW>0){x+=strokeW/2;y+=strokeW/2;width-=strokeW;height-=strokeW;}
let kw_viewport_rect={id:self.gobj_short_name()+"-2",name:"ka_viewport_rect",x:x,y:y,width:width,height:height,strokeWidth:0,shadowBlur:0,strokeEnabled:false,shadowEnabled:false};if(create){let ka_viewport_rect=self.private._ka_viewport_rect=new Konva.Rect(kw_viewport_rect);ka_container.add(ka_viewport_rect);}else{self.private._ka_viewport_rect.position({x:x,y:y});self.private._ka_viewport_rect.size({width:width,height:height});}
if(self.config.quick_display){ka_container.draw();}
let ka_wrapper_content_group;if(create){ka_wrapper_content_group=self.private._ka_wrapper_content_group=new Konva.Group({id:self.gobj_short_name()+"-3",name:"ka_wrapper_content_group",x:x,y:y,width:width,height:height});ka_container.add(ka_wrapper_content_group);}else{ka_wrapper_content_group=self.private._ka_wrapper_content_group;ka_wrapper_content_group.position({x:x,y:y});ka_wrapper_content_group.size({width:width,height:height});}
self.private._util_width=width;self.private._util_height=height;if(!self.config.show_overflow){ka_wrapper_content_group.clip({x:0,y:0,width:width,height:height});}
let ka_content_group;if(create){ka_content_group=self.private._ka_content_group=new Konva.Group({id:self.gobj_short_name()+"-4",name:"ka_content_group",x:0,y:0,width:0,height:0,draggable:self.config.panning,dragBoundFunc:function(pos){let new_pos=get_new_pos(self,pos,true);return new_pos;}});ka_wrapper_content_group.add(ka_content_group);}else{ka_content_group=self.private._ka_content_group;}
let kw_scrollview_content_rect={name:"ka_content_rect",x:0,y:0,width:self.config.autosize?0:width,height:self.config.autosize?0:height,strokeWidth:0,shadowBlur:0,strokeEnabled:false,shadowEnabled:false,fill:kw_get_str(self.config,"background_color",null,false,false)};let ka_content_rect;if(create){ka_content_rect=self.private._ka_content_rect=new Konva.Rect(kw_scrollview_content_rect);ka_content_group.add(ka_content_rect);ka_content_rect.moveToBottom();}else{ka_content_rect=self.private._ka_content_rect;ka_content_rect.size({width:width,height:height});let content_dim=ka_content_group.getClientRect({relativeTo:ka_content_group.getParent()});ka_content_group.size({width:content_dim.width,height:content_dim.height});ka_content_rect.size(ka_content_group.size());}
if(self.config.quick_display){ka_container.draw();}
if(create){let ka_scrollbars_group=self.private._ka_scrollbars_group=new Konva.Group({id:self.gobj_short_name()+"-6",name:"ka_scrollbars_group",x:x,y:y,width:width,height:height,});ka_container.add(ka_scrollbars_group);}
if(!create){return;}
ka_container.off("wheel");ka_container.on("wheel",function(ev){ev.cancelBubble=true;let pos=self.private._ka_content_group.position();let dx=ev.evt.deltaX;let dy=ev.evt.deltaY;let scroll_by_step=self.config.scroll_by_step;if(is_number(scroll_by_step)){if(dx!==0){if(dx<0){dx=-scroll_by_step;}else{dx=scroll_by_step;}}
if(dy!==0){if(dy<0){dy=-scroll_by_step;}else{dy=scroll_by_step;}}}else if(scroll_by_step===true){if(dy!==0){let pos_=get_first_visible_vertical_pos(self);if(pos_){let step=pos_.height;if(dy<0){dy=-step;}else{dy=step;}}}
if(dx!==0){let pos_=get_first_visible_horizontal_pos(self);if(pos_){let step=pos_.width;if(dx<0){dx=-step;}else{dx=step;}}}}else{}
pos.x-=dx;pos.y-=dy;let new_pos=get_new_pos(self,pos,false);if(self.config.enable_vscroll){self.private._ka_content_group.y(new_pos.y);}
if(self.config.enable_hscroll){self.private._ka_content_group.x(new_pos.x);}
adjust_screen_position(self);});if(self.config.panning){ka_content_group.on('dragstart',function(ev){ev.cancelBubble=true;self.gobj_publish_event("EV_PANNING",ka_content_group.position());});ka_content_group.on('dragmove',function(ev){ev.cancelBubble=true;document.body.style.cursor='pointer';move_scrollbars(self);});ka_content_group.on('dragend',function(ev){ev.cancelBubble=true;document.body.style.cursor='default';adjust_screen_position(self);self.gobj_publish_event("EV_PANNED",ka_content_group.position());});}
if(create){if(self.private._ka_container.isVisible()){self.gobj_publish_event("EV_SHOWED",{});}}}
function update_scrollbars(self)
{let ka_viewport_rect=self.private._ka_viewport_rect;let ka_content_group=self.private._ka_content_group;let ka_scrollbars_group=self.private._ka_scrollbars_group;if(self.private._ka_vscroll_rect){self.private._ka_vscroll_rect.off("dragmove");self.private._ka_vscroll_rect.off("dragend");self.private._ka_vscroll_rect.destroy();self.private._ka_vscroll_rect=null;}
if(self.private._ka_hscroll_rect){self.private._ka_hscroll_rect.off("dragmove");self.private._ka_hscroll_rect.off("dragend");self.private._ka_hscroll_rect.destroy();self.private._ka_hscroll_rect=null;}
let viewportWidth=ka_viewport_rect.width();let viewportHeight=ka_viewport_rect.height();let content_dim=ka_content_group.getClientRect({relativeTo:ka_content_group.getParent()});let contentWidth=content_dim.width;let contentHeight=content_dim.height;let vscroll_lane_size=viewportHeight-self.config.scrollbar_padding;let hscroll_lane_size=viewportWidth-self.config.scrollbar_padding;let minSize=self.config.scrollbar_min_large;let must_display_vbar=self.config.enable_vscroll&&!self.config.hide_vscrollbar&&(contentHeight>viewportHeight);let must_display_hbar=self.config.enable_hscroll&&!self.config.hide_hscrollbar&&(contentWidth>viewportWidth);let ka_hscroll_rect=null;let ka_vscroll_rect=null;let vscroll_x=viewportWidth+self.config.padding-self.config.scrollbar_width;let vscroll_y=self.config.scrollbar_padding;let vscroll_max_y;let hscroll_x=self.config.scrollbar_padding;let hscroll_y=viewportHeight+self.config.padding-self.config.scrollbar_width;let hscroll_max_x;if(must_display_vbar){let scrollBarLength=Math.max(minSize,Math.min(viewportHeight*(viewportHeight/(contentHeight)),vscroll_lane_size));vscroll_max_y=vscroll_lane_size-scrollBarLength;ka_vscroll_rect=self.private._ka_vscroll_rect=new Konva.Rect({id:self.gobj_short_name()+"-7",name:"vScrollBar",width:self.config.scrollbar_width,height:scrollBarLength,fill:self.config.kw_scrollview_scrollbar_rect.fill,opacity:self.config.kw_scrollview_scrollbar_rect.opacity,x:vscroll_x,y:vscroll_y,draggable:true,dragBoundFunc:function(pos){let viewport_dim=ka_viewport_rect.getClientRect();let new_pos={};new_pos.x=vscroll_x+viewport_dim.x;pos.y-=viewport_dim.y-self.config.scrollbar_padding;new_pos.y=Math.max(vscroll_y,Math.min(pos.y,vscroll_max_y));new_pos.y+=viewport_dim.y;return new_pos;}});ka_scrollbars_group.add(ka_vscroll_rect);self.private._vProportion_scroll2content=new Proportion(vscroll_y,vscroll_max_y,0,contentHeight-viewportHeight,1);self.private._vProportion_content2scroll=new Proportion(-(contentHeight-viewportHeight),0,vscroll_max_y,vscroll_y,1);}
if(must_display_hbar){let scrollBarLength=Math.max(minSize,Math.min(viewportWidth*(viewportWidth/(contentWidth)),hscroll_lane_size));hscroll_max_x=hscroll_lane_size-scrollBarLength;ka_hscroll_rect=self.private._ka_hscroll_rect=new Konva.Rect({id:self.gobj_short_name()+"-8",name:"hScrollBar",width:scrollBarLength,height:self.config.scrollbar_width,fill:self.config.kw_scrollview_scrollbar_rect.fill,opacity:self.config.kw_scrollview_scrollbar_rect.opacity,x:hscroll_x,y:hscroll_y,draggable:true,dragBoundFunc:function(pos){let viewport_dim=ka_viewport_rect.getClientRect();let new_pos={};new_pos.y=hscroll_y+viewport_dim.y;pos.x-=viewport_dim.x-self.config.scrollbar_padding;new_pos.x=Math.max(hscroll_x,Math.min(pos.x,hscroll_max_x));new_pos.x+=viewport_dim.x;return new_pos;}});ka_scrollbars_group.add(ka_hscroll_rect);self.private._hProportion_scroll2content=new Proportion(hscroll_x,hscroll_max_x,0,contentWidth-viewportWidth,1);self.private._hProportion_content2scroll=new Proportion(-(contentWidth-viewportWidth),0,hscroll_max_x,hscroll_x,1);}
if(ka_vscroll_rect){ka_vscroll_rect.on('dragmove',function(ev){ev.cancelBubble=true;let y=self.private._vProportion_scroll2content.convert(ka_vscroll_rect.y());ka_content_group.y(-y);});ka_vscroll_rect.on('dragend',function(ev){ev.cancelBubble=true;let y=self.private._vProportion_scroll2content.convert(ka_vscroll_rect.y());ka_content_group.y(-y);adjust_screen_position(self);});}
if(ka_hscroll_rect){ka_hscroll_rect.on('dragmove',function(ev){ev.cancelBubble=true;let x=self.private._hProportion_scroll2content.convert(ka_hscroll_rect.x());ka_content_group.x(-x);});ka_hscroll_rect.on('dragend',function(ev){ev.cancelBubble=true;adjust_screen_position(self);});}
if(self.config.quick_display){self.private._ka_container.draw();}}
function move_scrollbars(self)
{let ka_content_group=self.private._ka_content_group;let ka_vscroll_rect=self.private._ka_vscroll_rect;if(ka_vscroll_rect){let y=self.private._vProportion_content2scroll.convert(ka_content_group.y());ka_vscroll_rect.y(y);}
let ka_hscroll_rect=self.private._ka_hscroll_rect;if(ka_hscroll_rect){let x=self.private._hProportion_content2scroll.convert(ka_content_group.x());ka_hscroll_rect.x(x);}
if(self.config.quick_display){self.private._ka_container.draw();}}
function get_new_pos(self,pos,absolute_pos)
{let ka_content_group=self.private._ka_content_group;let contentWidth=ka_content_group.width();let contentHeight=ka_content_group.height();const viewport_dim=self.private._ka_viewport_rect.getClientRect();if(absolute_pos){pos.x-=viewport_dim.x;pos.y-=viewport_dim.y;}
const minY=-(contentHeight-viewport_dim.height);const maxY=0;let y=Math.max(minY,Math.min(pos.y,maxY));const minX=-(contentWidth-viewport_dim.width);const maxX=0;let x=Math.max(minX,Math.min(pos.x,maxX));if(absolute_pos){x+=viewport_dim.x;y+=viewport_dim.y;}
return{x:self.config.enable_hscroll?x:viewport_dim.x,y:self.config.enable_vscroll?y:viewport_dim.y};}
function adjust_screen_position(self)
{let ka_content_group=self.private._ka_content_group;let pos=ka_content_group.getClientRect({relativeTo:ka_content_group.getParent()});if(self.config.scroll_by_step===true){if(self.config.enable_vscroll){let vpos=get_first_full_visible_vertical_pos(self,true);if(vpos){pos.y=-vpos.y;}}else if(self.config.enable_hscroll){let hpos=get_first_full_visible_horizontal_pos(self,true);if(hpos){pos.x=-hpos.x;}}}
let new_pos=get_new_pos(self,pos,false);if(self.config.enable_vscroll){self.private._ka_content_group.y(new_pos.y);}
if(self.config.enable_hscroll){self.private._ka_content_group.x(new_pos.x);}
if(self.config.quick_display){self.private._ka_container.draw();}
move_scrollbars(self);}
function do_fix_dimension_to_screen(self,kw)
{let x=kw_get_int(kw,"x",self.config.x,false,false);let y=kw_get_int(kw,"y",self.config.y,false,false);let width=kw_get_int(kw,"width",self.config.width,false,false);let height=kw_get_int(kw,"height",self.config.height,false,false);let WIDTH,HEIGHT;if(window.innerHeight==undefined){WIDTH=document.documentElement.offsetWidth;HEIGHT=document.documentElement.offsetHeight;}else{WIDTH=window.innerWidth;HEIGHT=window.innerHeight;}
if(x<0){x=0;}
if(y<0){y=0;}
if(WIDTH>width){if(x+width>WIDTH){x=WIDTH-width;if(self.private._original_x===null){self.private._original_x=self.config.x;}}}else if(WIDTH<=width){x=0;width=WIDTH;if(self.private._original_width===null){self.private._original_width=self.config.width;}
self.config.width=width;}
if(HEIGHT>height){if(y+height>HEIGHT){y=HEIGHT-height;if(self.private._original_y===null){self.private._original_y=self.config.y;}}}else if(HEIGHT<=height){y=0;height=HEIGHT;if(self.private._original_height===null){self.private._original_height=self.config.height;}
self.config.height=height;}
self.config.x=x;self.config.y=y;return 0;}
function do_center(self)
{let x=self.config.x;let y=self.config.y;let width=self.config.width;let height=self.config.height;let WIDTH,HEIGHT;if(window.innerHeight==undefined){WIDTH=document.documentElement.offsetWidth;HEIGHT=document.documentElement.offsetHeight;}else{WIDTH=window.innerWidth;HEIGHT=window.innerHeight;}
if(WIDTH>width){x=(WIDTH-width)/2;if(self.private._original_x===null){self.private._original_x=self.config.x;}}else if(WIDTH<=width){x=0;}
if(HEIGHT>height){y=(HEIGHT-height)/2;if(self.private._original_y===null){self.private._original_y=self.config.y;}}else if(HEIGHT<=height){y=0;}
self.config.x=x;self.config.y=y;return 0;}
function get_first_visible_vertical_child(self)
{let pos=self.private._ka_content_group.position();pos.y*=-1;let children=self.private._ka_content_group.getChildren();for(let i=0;i<children.length;i++){let child=children[i];if(child.name()=="ka_content_rect"){continue;}
let pos_=child.getClientRect({relativeTo:child.getParent()});if(pos.y>=pos_.y&&pos.y<pos_.y+pos_.height){return[child,pos_];}}
return[null,null];}
function get_first_visible_vertical_pos(self)
{let child_and_pos=get_first_visible_vertical_child(self);return child_and_pos[1];}
function get_first_visible_horizontal_child(self)
{let pos=self.private._ka_content_group.position();pos.x*=-1;let children=self.private._ka_content_group.getChildren();for(let i=0;i<children.length;i++){let child=children[i];if(child.name()=="ka_content_rect"){continue;}
let pos_=child.getClientRect({relativeTo:child.getParent()});if(pos.x>=pos_.x&&pos.x<pos_.x+pos_.width){return[child,pos_];}}
return[null,null];}
function get_first_visible_horizontal_pos(self)
{let child_and_pos=get_first_visible_horizontal_child(self);return child_and_pos[1];}
function get_first_full_visible_vertical_child(self)
{let pos=self.private._ka_content_group.position();pos.y*=-1;let next=null;let pos_=null;let children=self.private._ka_content_group.getChildren();for(let i=0;i<children.length-1;i++){let child=children[i];if(child.name()=="ka_content_rect"){continue;}
next=children[i+1];pos_=child.getClientRect({relativeTo:child.getParent()});if(pos.y>pos_.y&&pos.y<=pos_.y+pos_.height){return[next,next.getClientRect({relativeTo:child.getParent()})];}}
return[null,null];}
function get_first_full_visible_vertical_pos(self)
{let child_and_pos=get_first_full_visible_vertical_child(self);return child_and_pos[1];}
function get_first_full_visible_horizontal_child(self)
{let pos=self.private._ka_content_group.position();pos.x*=-1;let next=null;let pos_=null;let children=self.private._ka_content_group.getChildren();for(let i=0;i<children.length-1;i++){let child=children[i];if(child.name()=="ka_content_rect"){continue;}
next=children[i+1];pos_=child.getClientRect({relativeTo:child.getParent()});if(pos.x>pos_.x&&pos.x<=pos_.x+pos_.width){return[next,next.getClientRect({relativeTo:child.getParent()})];}}
return[null,null];}
function get_first_full_visible_horizontal_pos(self)
{let child_and_pos=get_first_full_visible_horizontal_child(self);return child_and_pos[1];}
function get_auto_x(self)
{let CONFIG=gobj_get_gclass_config("Ka_scrollview",false);CONFIG._x+=10;return CONFIG._x;}
function get_auto_y(self)
{let CONFIG=gobj_get_gclass_config("Ka_scrollview",false);CONFIG._y+=5;return CONFIG._y;}
function ac_add_item(self,event,kw,src)
{if(!self.private._ka_container){log_error("ka_scrollview.ac_add_item(): _ka_container not defined");return-1;}
let ka_items=kw_get_list(kw,"items",[],0,true);for(let i=0;i<ka_items.length;i++){let ka_item=ka_items[i];if(ka_item instanceof Konva.Node){if(ka_item.x()<0){ka_item.x(0);}
if(ka_item.y()<0){ka_item.y(0);}
self.private._ka_content_group.add(ka_item);}else if(is_object(ka_item)){let __ka_node__=kw_get_dict_value(ka_item,"__ka_node__",null,false,true);if(__ka_node__){if(__ka_node__.x()<0){__ka_node__.x(0);}
if(__ka_node__.y()<0){__ka_node__.y(0);}
self.private._ka_content_group.add(__ka_node__);}}else{log_error("ka_scrollview.ac_add_item(): what fuck is it?");}
if(self.config.quick_display){self.private._ka_container.draw();}}
self.private._ka_content_rect.moveToBottom();if(self.config.autosize){let content_dim=self.private._ka_content_group.getClientRect();self.config.width=content_dim.width;self.config.width+=self.private._strokeW*2+self.private._shadowW*2+self.private._padding*2;self.config.height=content_dim.height;self.config.height+=self.private._strokeW*2+self.private._shadowW*2+self.private._padding*2;if(self.config.fix_dimension_to_screen){if(self.config.fix_dimension_to_screen===true){do_fix_dimension_to_screen(self,kw);}}
if(self.config.center){do_center(self);}}
create_scrollview(self,false);update_scrollbars(self);adjust_screen_position(self);return 0;}
function ac_remove_item(self,event,kw,src)
{if(!self.private._ka_container){log_error("ka_scrollview.ac_remove_item(): _ka_container not defined");return-1;}
search_ka_nodes(self.private._ka_container,kw,function(kw_item,__ka_node__){__ka_node__.destroy();if(kw_item&&kw_has_key(kw_item,"__ka_node__")){kw_item.__ka_node__=null;}});self.private._ka_content_rect.moveToBottom();if(self.config.autosize){let content_dim=self.private._ka_content_group.getClientRect();self.config.width=content_dim.width;self.config.width+=self.private._strokeW*2+self.private._shadowW*2+self.private._padding*2;self.config.height=content_dim.height;self.config.height+=self.private._strokeW*2+self.private._shadowW*2+self.private._padding*2;if(self.config.fix_dimension_to_screen){if(self.config.fix_dimension_to_screen===true){do_fix_dimension_to_screen(self,kw);}}
if(self.config.center){do_center(self);}}
create_scrollview(self,false);update_scrollbars(self);adjust_screen_position(self);return 0;}
function ac_activate(self,event,kw,src)
{if(self.config.top_on_activate){self.private._ka_container.moveToTop();}
let kw_rect=self.config.kw_border_shape_actived;let stroke=kw_get_str(kw_rect,"stroke",null);if(!is_null(stroke)){self.private._ka_border_rect.stroke(stroke);}
let opacity=kw_get_real(kw_rect,"opacity",null);if(!is_null(opacity)){self.private._ka_border_rect.opacity(opacity);}
let shadowBlur=kw_get_int(kw_rect,"shadowBlur",null);if(!is_null(shadowBlur)){self.private._ka_border_rect.shadowBlur(shadowBlur);}
let shadowColor=kw_get_str(kw_rect,"shadowColor",null);if(!is_null(shadowColor)){self.private._ka_border_rect.shadowColor(shadowColor);}
return 0;}
function ac_deactivate(self,event,kw,src)
{let kw_rect=self.config.kw_border_shape;let stroke=kw_get_str(kw_rect,"stroke",null);if(!is_null(stroke)){self.private._ka_border_rect.stroke(stroke);}
let opacity=kw_get_real(kw_rect,"opacity",null);if(!is_null(opacity)){self.private._ka_border_rect.opacity(opacity);}
let shadowBlur=kw_get_int(kw_rect,"shadowBlur",null);if(!is_null(shadowBlur)){self.private._ka_border_rect.shadowBlur(shadowBlur);}
let shadowColor=kw_get_str(kw_rect,"shadowColor",null);if(!is_null(shadowColor)){self.private._ka_border_rect.shadowColor(shadowColor);}
return 0;}
function ac_position(self,event,kw,src)
{if(!self.private._ka_container){log_error("_ka_container not defined");return-1;}
self.config.x=kw_get_int(kw,"x",self.config.x,false,false);self.config.y=kw_get_int(kw,"y",self.config.y,false,false);if(self.config.fix_dimension_to_screen){if(self.config.fix_dimension_to_screen===true){do_fix_dimension_to_screen(self,kw);}}
if(self.config.center){do_center(self);}
self.private._ka_container.position({x:self.config.x,y:self.config.y});return 0;}
function ac_size(self,event,kw,src)
{if(!self.private._ka_container){log_error("_ka_container not defined");return-1;}
self.config.width=kw_get_int(kw,"width",self.config.width,false,false);self.config.height=kw_get_int(kw,"height",self.config.height,false,false);if(self.config.fix_dimension_to_screen){if(self.config.fix_dimension_to_screen===true){do_fix_dimension_to_screen(self,kw);}}
if(self.config.center){do_center(self);}
create_scrollview(self,false);update_scrollbars(self);adjust_screen_position(self);return 0;}
function ac_get_dimension(self,event,kw,src)
{if(!is_object(kw)){log_error(sprintf("%s: get_dimension(): kw not an object, from %s",self.gobj_short_name(),src.gobj_short_name()));return-1;}
kw["x"]=self.config.x;kw["y"]=self.config.y;kw["width"]=self.config.width;kw["height"]=self.config.height;kw["absolute_dimension"]=self.private._ka_container.getClientRect();kw["_original_x"]=self.private._original_x;kw["_original_y"]=self.private._original_y;kw["_original_width"]=self.private._original_width;kw["_original_height"]=self.private._original_height;kw["util_dimension"]={x:0,y:0,width:self.private._util_width,height:self.private._util_height};return 0;}
function ac_show_or_hide(self,event,kw,src)
{if(!self.private._ka_container){log_error("_ka_container not defined");return-1;}
switch(event){case"EV_TOGGLE":if(self.private._ka_container.isVisible()){self.private._ka_container.hide();}else{self.private._ka_container.show();}
break;case"EV_SHOW":self.private._ka_container.show();break;case"EV_HIDE":self.private._ka_container.hide();break;}
if(self.private._ka_container.isVisible()){self.gobj_publish_event("EV_SHOWED",{});}else{self.gobj_publish_event("EV_HIDDEN",{});}
return 0;}
function ac_resize(self,event,kw,src)
{if(!self.private._ka_container){log_error("_ka_container not defined");return-1;}
self.config.x=kw_get_int(kw,"x",self.config.x,true,false);self.config.y=kw_get_int(kw,"y",self.config.y,true,false);self.config.width=kw_get_int(kw,"width",self.config.width,true,false);self.config.height=kw_get_int(kw,"height",self.config.height,true,false);if(self.config.fix_dimension_to_screen){if(self.config.fix_dimension_to_screen===true){do_fix_dimension_to_screen(self,kw);}}
if(self.config.center){do_center(self);}
create_scrollview(self,false);update_scrollbars(self);adjust_screen_position(self);return 0;}
let FSM={"event_list":["EV_ADD_ITEM","EV_REMOVE_ITEM","EV_ACTIVATE","EV_DEACTIVATE","EV_POSITION","EV_SIZE","EV_GET_DIMENSION","EV_TOGGLE","EV_SHOW","EV_HIDE","EV_MOVING: output no_warn_subs","EV_MOVED: output no_warn_subs","EV_PANNING: output no_warn_subs","EV_PANNED: output no_warn_subs","EV_SHOWED: output no_warn_subs","EV_HIDDEN: output no_warn_subs","EV_RESIZE"],"state_list":["ST_IDLE"],"machine":{"ST_IDLE":[["EV_ADD_ITEM",ac_add_item,undefined],["EV_REMOVE_ITEM",ac_remove_item,undefined],["EV_ACTIVATE",ac_activate,undefined],["EV_DEACTIVATE",ac_deactivate,undefined],["EV_POSITION",ac_position,undefined],["EV_SIZE",ac_size,undefined],["EV_GET_DIMENSION",ac_get_dimension,undefined],["EV_TOGGLE",ac_show_or_hide,undefined],["EV_SHOW",ac_show_or_hide,undefined],["EV_HIDE",ac_show_or_hide,undefined],["EV_RESIZE",ac_resize,undefined]]}};let Ka_scrollview=GObj.__makeSubclass__();let proto=Ka_scrollview.prototype;proto.__init__=function(name,kw){GObj.prototype.__init__.call(this,FSM,CONFIG,name,"Ka_scrollview",kw,0);return this;};gobj_register_gclass(Ka_scrollview,"Ka_scrollview");proto.mt_create=function(kw)
{let self=this;if(!self.config.subscriber){self.config.subscriber=self.gobj_parent();}
if(self.config.subscriber){self.gobj_subscribe_event(null,{},self.config.subscriber);}
if(!self.config.layer){self.config.layer=self.gobj_parent().config.layer;}
create_scrollview(self,true);};proto.mt_destroy=function()
{let self=this;if(self.private._ka_container){self.private._ka_container.destroy();self.private._ka_container=null;}};proto.mt_start=function(kw)
{let self=this;};proto.mt_stop=function(kw)
{let self=this;};proto.mt_child_added=function(child)
{let self=this;self.gobj_send_event("EV_ADD_ITEM",{items:[child.get_konva_container()]},self);};proto.get_viewport_rect=function()
{let self=this;return self.private._ka_viewport_rect.size();};proto.isVisible=function()
{let self=this;return self.private._ka_container.isVisible();};proto.get_konva_container=function()
{let self=this;return self.private._ka_container;};proto.get_util_dimension=function(){let self=this;return{x:0,y:0,width:self.private._util_width,height:self.private._util_height};};proto.mt_get_gclass_config=function()
{return CONFIG;};exports.Ka_scrollview=Ka_scrollview;})(this);(function(exports){'use strict';let CONFIG={subscriber:null,layer:null,view:null,source_node:null,source_port:null,target_node:null,target_port:null,photons:0,photon_color:"yellow",shape:"bezier",connection_margin:0,color:"#000000BB",speed:100,width:4,visible:true,fontFamily:"sans-serif",icon_size:30,text_size:18,kw_border_shape:{shadowBlur:0,shadowColor:"black",shadowForStrokeEnabled:false},kw_photon_shape:{shape:"circle",width:12,height:12,radius:6},timeout_retry:5,timeout_idle:5,_icon_size:0,_text_size:0,_gobj_source_node:null,_gobj_source_port:null,_gobj_target_node:null,_gobj_target_port:null,_ka_container:null,_ka_path:null,_path_length:0,_ka_animation:null,_ka_photons:[]};function adjust_text_and_icon_size(self)
{self.private._text_size=adjust_font_size(self.config.text_size,self.config.fontFamily);self.private._icon_size=adjust_font_size(self.config.icon_size,self.config.fontFamily);}
function get_control_points(from,to)
{let x1=0;let y1=0;let x2=0;let y2=0;switch(from.port_position){case"left":switch(to.port_position){case"left":break;case"right":break;case"top":break;case"bottom":break;}
break;case"right":switch(to.port_position){case"left":x1=from.x+(to.x-from.x)/3*2;y1=from.y;x2=from.x+(to.x-from.x)/3;y2=to.y;break;case"right":break;case"top":break;case"bottom":break;}
break;case"top":switch(to.port_position){case"left":break;case"right":break;case"top":break;case"bottom":break;}
break;case"bottom":switch(to.port_position){case"left":break;case"right":break;case"top":break;case"bottom":break;}
break;}
return{x1:x1,y1:y1,x2:x2,y2:y2};}
function get_connector_path(self,from,to)
{let from_x,from_y,to_x,to_y;from_x=from.relative_dimension.x+from.relative_dimension.width/2;from_y=from.relative_dimension.y+from.relative_dimension.height/2;to_x=to.relative_dimension.x+to.relative_dimension.width/2+1;to_y=to.relative_dimension.y+to.relative_dimension.height/2+1;switch(self.config.shape){case"bezier":{const dx=to_x-from_x;const dy=to_y-from_y;let angle=Math.atan2(-dy,dx);let from_radius=from.relative_dimension.width/2+self.config.connection_margin;let from_={x:from_x+-from_radius*Math.cos(angle+Math.PI),y:from_y+from_radius*Math.sin(angle+Math.PI),port_position:from.port_position};let to_radius=to.relative_dimension.width/2+self.config.connection_margin;let to_={x:to_x+-to_radius*Math.cos(angle),y:to_y+to_radius*Math.sin(angle),port_position:to.port_position};let control_points=get_control_points(from_,to_);let points=[from_.x,from_.y,control_points.x1,control_points.y1,control_points.x2,control_points.y2,to_.x,to_.y];return sprintf("M %d %d C %d %d %d %d %d %d",points[0],points[1],points[2],points[3],points[4],points[5],points[6],points[7],);}
case"arrow":case"line":default:{const dx=to_x-from_x;const dy=to_y-from_y;let angle=Math.atan2(-dy,dx);let from_radius=from.relative_dimension.width/2+self.config.connection_margin;let to_radius=to.relative_dimension.width/2+self.config.connection_margin;let points=[from_x+-from_radius*Math.cos(angle+Math.PI),from_y+from_radius*Math.sin(angle+Math.PI),to_x+-to_radius*Math.cos(angle),to_y+to_radius*Math.sin(angle)];return sprintf("M %d %d L %d %d",points[0],points[1],points[2],points[3]);}}}
function update_link_path(self)
{let source_port=self.private._gobj_source_port;let target_port=self.private._gobj_target_port;let kw_source_dim={};let kw_target_dim={};source_port.gobj_send_event("EV_GET_DIMENSION",kw_source_dim,self);target_port.gobj_send_event("EV_GET_DIMENSION",kw_target_dim,self);kw_source_dim.port_position=source_port.config.port_position;kw_target_dim.port_position=target_port.config.port_position;const path=get_connector_path(self,kw_source_dim,kw_target_dim);for(let i=0;i<self.private._ka_photons.length;i++){let photon=self.private._ka_photons[i];photon.photon_idx=(self.private._path_length/self.private._ka_photons.length)*i;}
self.private._ka_path.data(path);self.private._path_length=self.private._ka_path.getLength();}
function link_ports(self)
{let name=self.config.source_node;self.private._gobj_source_node=get_unique_gobj(self,name);if(!self.private._gobj_source_node){log_error(sprintf("%s: unique source node not found: '%s'",self.gobj_short_name(),is_gobj(name)?name.gobj_short_name():name));return null;}
name=self.config.target_node;self.private._gobj_target_node=get_unique_gobj(self,name);if(!self.private._gobj_target_node){log_error(sprintf("%s: unique target node not found: '%s'",self.gobj_short_name(),is_gobj(name)?name.gobj_short_name():name));return null;}
name=self.config.source_port;self.private._gobj_source_port=get_child_gobj(self,self.private._gobj_source_node,name);if(!self.private._gobj_source_port){log_error(sprintf("%s: source port not found: '%s'",self.gobj_short_name(),is_gobj(name)?name.gobj_short_name():name));return null;}
name=self.config.target_port;self.private._gobj_target_port=get_child_gobj(self,self.private._gobj_target_node,name);if(!self.private._gobj_target_port){log_error(sprintf("%s: target port not found: '%s'",self.gobj_short_name(),is_gobj(name)?name.gobj_short_name():name));return null;}
self.private._gobj_source_node.gobj_subscribe_event("EV_MOVING",{},self);self.private._gobj_source_node.gobj_subscribe_event("EV_MOVED",{},self);self.private._gobj_target_node.gobj_subscribe_event("EV_MOVING",{},self);self.private._gobj_target_node.gobj_subscribe_event("EV_MOVED",{},self);update_link_path(self);}
function get_unique_gobj(self,name)
{let node;if(is_string(name)){node=self.yuno.gobj_find_unique_gobj(name);if(!node){return null;}}else if(is_gobj(name)){node=name;if(!node.gobj_is_unique(node)){node=null;}}else{node=null;}
return node;}
function get_child_gobj(self,gobj_parent,name)
{let child_gobj;if(is_string(name)){child_gobj=gobj_parent.gobj_child_by_name(name);if(!child_gobj){return null;}}else if(is_gobj(name)){child_gobj=name;if(!gobj_parent.gobj_child_by_name(child_gobj.gobj_name())){child_gobj=null;}}else{child_gobj=null;}
return child_gobj;}
function create_shape(self)
{let ka_container=self.private._ka_container=new Konva.Group({id:self.gobj_short_name(),name:"ka_container",visible:self.config.visible,listening:true});ka_container.gobj=self;let kw_border_shape=__duplicate__(kw_get_dict(self.config,"kw_border_shape",{},false,false));json_object_update_missing(kw_border_shape,{name:"ka_border_path",strokeWidth:kw_get_int(self.config,"width",4),stroke:kw_get_str(self.config,"color",null)});self.private._ka_path=new Konva.Path(kw_border_shape);ka_container.add(self.private._ka_path);}
function ac_moving(self,event,kw,src)
{update_link_path(self);return 0;}
function ac_moved(self,event,kw,src)
{update_link_path(self);return 0;}
function ac_start_animation(self,event,kw,src)
{if(self.private._ka_photons.length===0){let kw_photon_shape=__duplicate__(kw_get_dict(self.config,"kw_photon_shape",{},false,false));json_object_update_missing(kw_photon_shape,{name:"ka_border_photon",color:self.config.photon_color});for(let i=0;i<self.config.photons;i++){let photon=self.yuno.gobj_create("",Ka_photon,kw_photon_shape,self.config.view);self.private._ka_photons.push(photon);photon.photon_idx=(self.private._path_length/self.config.photons)*i;}}
if(self.private._ka_photons.length>0){if(!self.private._ka_animation){self.private._ka_animation=new Konva.Animation(function(frame){let increment=self.config.speed*(frame.timeDiff/1000);for(let i=0;i<self.private._ka_photons.length;i++){let photon=self.private._ka_photons[i];photon.photon_idx+=increment;if(photon.photon_idx<0){photon.photon_idx=0;}
let idx=photon.photon_idx%self.private._path_length;let pos=self.private._ka_path.getPointAtLength(idx);photon.get_konva_container().x(pos.x);photon.get_konva_container().y(pos.y);}},self.config.layer);}}
for(let i=0;i<self.private._ka_photons.length;i++){let photon=self.private._ka_photons[i];photon.get_konva_container().visible(true);}
if(self.private._ka_animation){self.private._ka_animation.start();}
return 0;}
function ac_stop_animation(self,event,kw,src)
{if(self.private._ka_animation){self.private._ka_animation.stop();}
for(let i=0;i<self.private._ka_photons.length;i++){let photon=self.private._ka_photons[i];photon.get_konva_container().visible(false);}
return 0;}
let FSM={"event_list":["EV_MOVING","EV_MOVED","EV_START_ANIMATION","EV_STOP_ANIMATION"],"state_list":["ST_IDLE"],"machine":{"ST_IDLE":[["EV_MOVING",ac_moving,undefined],["EV_MOVED",ac_moved,undefined],["EV_START_ANIMATION",ac_start_animation,undefined],["EV_STOP_ANIMATION",ac_stop_animation,undefined]]}};let Ka_link=GObj.__makeSubclass__();let proto=Ka_link.prototype;proto.__init__=function(name,kw){GObj.prototype.__init__.call(this,FSM,CONFIG,name,"Ka_link",kw,0);return this;};gobj_register_gclass(Ka_link,"Ka_link");proto.mt_create=function(kw)
{let self=this;let subscriber=self.gobj_read_attr("subscriber");if(!subscriber){subscriber=self.gobj_parent();}
self.gobj_subscribe_event(null,null,subscriber);if(!self.config.layer){self.config.layer=self.gobj_parent().config.layer;}
if(!self.config.view){self.config.view=self.gobj_parent();}
adjust_text_and_icon_size(self);create_shape(self);link_ports(self);};proto.mt_destroy=function()
{let self=this;if(self.private._ka_container){self.private._ka_container.destroy();self.private._ka_container=null;}};proto.mt_start=function(kw)
{let self=this;};proto.mt_stop=function(kw)
{let self=this;};proto.mt_writing=function(name)
{let self=this;switch(name){case"color":self.private._ka_path.stroke(self.config.color);break;case"width":self.private._ka_path.strokeWidth(self.config.width);break;}};proto.get_konva_container=function()
{let self=this;return self.private._ka_container;};proto.get_private_data=function()
{let self=this;return{gobj_source_node:self.private._gobj_source_node,gobj_source_port:self.private._gobj_source_port,gobj_target_node:self.private._gobj_target_node,gobj_target_port:self.private._gobj_target_port,ka_container:self.private._ka_container,ka_path:self.private._ka_path,ka_photon:self.private._ka_photon};};function _create_link(self,kw,common)
{let id=kw_get_str(kw,"id",kw_get_str(kw,"name",""));let gobj_link=self.yuno.gobj_find_unique_gobj(id);if(gobj_link){log_error(sprintf("%s: link already exists '%s'",self.gobj_short_name(),id));return null;}
kw["source_port"]=kw_get_dict_value(kw,"source_port",id);kw["target_port"]=kw_get_dict_value(kw,"target_port",id);json_object_update_missing(kw,common);return self.yuno.gobj_create_unique(id,Ka_link,kw,self);}
function create_link(self,kw)
{if(self.gobj_gclass_name()!=="Sw_graph"){log_error(sprintf("create_link(): Not a Sw_graph gclass"));return;}
let links=kw_get_list(kw,"links",null);if(!links){_create_link(self,kw,{});}else{for(let i=0;i<links.length;i++){let link=links[i];_create_link(self,link,kw);}}}
exports.Ka_link=Ka_link;exports.create_link=create_link;})(this);(function(exports){'use strict';let CONFIG={subscriber:null,layer:null,id:"",action:null,label:"",icon:"",background_color:"#FFF7E0",color:"black",text_color:null,icon_color:null,value:null,icon_position:"left",disabled:false,selected:false,unlocked:false,x:0,y:0,width:150,height:40,visible:true,draggable:false,icon_size:18,text_size:18,autosize:false,kw_text_font_properties:{fontFamily:"sans-serif",fontStyle:"normal",padding:10,align:"center",verticalAlign:"middle",wrap:"char"},kw_icon_font_properties:{fontFamily:"yuneta-icon-font",fontStyle:"normal",padding:10,align:"center",verticalAlign:"middle",wrap:"char"},kw_border_shape:{cornerRadius:10,strokeWidth:2,stroke:"#f5c211ff",opacity:1,shadowBlur:0,shadowColor:"black",shadowForStrokeEnabled:false},quick_display:false,_icon_size:0,_text_size:0,_ka_container:null};function create_shape(self)
{let config=__duplicate__(self.config);if(!config.background_color){config.background_color=self.parent.config.background_color;}
if(!config.color){config.color=self.parent.config.color;}
let ka_container=create_shape_label_with_icon(config);ka_container.gobj=self;if(self.config.draggable){ka_container.draggable(true);ka_container.on('dragstart',function(ev){ev.cancelBubble=true;let min_offset=self.config.kw_border_shape.strokeWidth;min_offset+=self.config.kw_border_shape.shadowBlur;let dim=ka_container.getClientRect({relativeTo:ka_container.getParent()});if(dim.x<0){ka_container.x(min_offset);}
if(dim.y<0){ka_container.y(min_offset);}
self.config.layer.getStage().container().style.cursor="move";self.gobj_publish_event("EV_MOVING",ka_container.position());});ka_container.on('dragmove',function(ev){ev.cancelBubble=true;let min_offset=self.config.kw_border_shape.strokeWidth;min_offset+=self.config.kw_border_shape.shadowBlur;let dim=ka_container.getClientRect({relativeTo:ka_container.getParent()});if(dim.x<0){ka_container.x(min_offset);}
if(dim.y<0){ka_container.y(min_offset);}
self.config.layer.getStage().container().style.cursor="move";self.gobj_publish_event("EV_MOVING",ka_container.position());});ka_container.on('dragend',function(ev){ka_container.opacity(1);ev.cancelBubble=true;let min_offset=self.config.kw_border_shape.strokeWidth;min_offset+=self.config.kw_border_shape.shadowBlur;let dim=ka_container.getClientRect({relativeTo:ka_container.getParent()});if(dim.x<0){ka_container.x(min_offset);}
if(dim.y<0){ka_container.y(min_offset);}
self.config.layer.getStage().container().style.cursor="default";self.gobj_publish_event("EV_MOVED",ka_container.position());});}
let id=kw_get_str(self.config,"id",null);let action=kw_get_dict_value(self.config,"action",null);if(empty_string(id)){if(!empty_string(action)){id=action;}}
if(is_null(action)){if(!empty_string(id)){action=id;}}
if(is_string(action)){let event=action;action=function(e){e["__share_kw__"]=true;self.gobj_publish_event(event,e);};}
if(is_function(action)){ka_container.on("mouseenter",function(e){self.config.layer.getStage().container().style.cursor="pointer";});ka_container.on("mouseleave",function(e){self.config.layer.getStage().container().style.cursor="default";});ka_container.on("pointerdown",function(e){ka_container.opacity(0.5);e.gobj=self;if(self.is_tracing()){log_warning(sprintf("%s.%s ==> (%s), cancelBubble: %s, gobj: %s, ka_id: %s, ka_name: %s","nd_machine","element",e.type,(e.cancelBubble)?"Y":"N",self.gobj_short_name(),kw_get_str(e.target.attrs,"id",""),kw_get_str(e.target.attrs,"name","")));}});ka_container.on("pointerup",function(e){ka_container.opacity(1);e.cancelBubble=true;e.gobj=self;if(self.is_tracing()){log_warning(sprintf("%s.%s ==> (%s), cancelBubble: %s, gobj: %s, ka_id: %s, ka_name: %s","nd_machine","element",e.type,(e.cancelBubble)?"Y":"N",self.gobj_short_name(),kw_get_str(e.target.attrs,"id",""),kw_get_str(e.target.attrs,"name","")));}
action(e);});}
return ka_container;}
function ac_position(self,event,kw,src)
{self.config.x=kw_get_int(kw,"x",self.config.x,false,false);self.config.y=kw_get_int(kw,"y",self.config.y,false,false);let ka_container=self.private._ka_container;ka_container.position({x:self.config.x,y:self.config.y});return 0;}
function ac_size(self,event,kw,src)
{self.config.width=kw_get_int(kw,"width",self.config.width,false,false);self.config.height=kw_get_int(kw,"height",self.config.height,false,false);let ka_container=self.private._ka_container;ka_container.shape_label_size({width:self.config.width,height:self.config.height});return 0;}
function ac_get_dimension(self,event,kw,src)
{if(!is_object(kw)){log_error(sprintf("%s: get_dimension(): kw not an object, from %s",self.gobj_short_name(),src.gobj_short_name()));return-1;}
kw["x"]=self.config.x;kw["y"]=self.config.y;kw["width"]=self.config.width;kw["height"]=self.config.height;kw["absolute_dimension"]=self.private._ka_container.getClientRect();return 0;}
function ac_select(self,event,kw,src)
{self.config.selected=true;return 0;}
function ac_unselect(self,event,kw,src)
{self.config.selected=false;return 0;}
function ac_enable(self,event,kw,src)
{self.config.disabled=false;self.private._ka_container.listening(true);self.private._ka_container.opacity(1);return 0;}
function ac_disable(self,event,kw,src)
{self.config.layer.getStage().container().style.cursor="default";self.config.disabled=true;self.private._ka_container.listening(false);self.private._ka_container.opacity(0.6);return 0;}
function ac_lock(self,event,kw,src)
{return 0;}
function ac_unlock(self,event,kw,src)
{return 0;}
function ac_timeout(self,event,kw,src)
{return 0;}
function ac_resize(self,event,kw,src)
{return 0;}
let FSM={"event_list":["EV_MOVING: output no_warn_subs","EV_MOVED: output no_warn_subs","EV_POSITION","EV_SIZE","EV_GET_DIMENSION","EV_SELECT","EV_UNSELECT","EV_ENABLE","EV_DISABLE","EV_LOCK","EV_UNLOCK","EV_TIMEOUT","EV_RESIZE"],"state_list":["ST_IDLE"],"machine":{"ST_IDLE":[["EV_POSITION",ac_position,undefined],["EV_SIZE",ac_size,undefined],["EV_GET_DIMENSION",ac_get_dimension,undefined],["EV_SELECT",ac_select,undefined],["EV_UNSELECT",ac_unselect,undefined],["EV_ENABLE",ac_enable,undefined],["EV_DISABLE",ac_disable,undefined],["EV_LOCK",ac_lock,undefined],["EV_UNLOCK",ac_unlock,undefined],["EV_TIMEOUT",ac_timeout,undefined],["EV_RESIZE",ac_resize,undefined]]}};let Ka_button=GObj.__makeSubclass__();let proto=Ka_button.prototype;proto.__init__=function(name,kw){GObj.prototype.__init__.call(this,FSM,CONFIG,name,"Ka_button",kw,gcflag_no_check_output_events);return this;};gobj_register_gclass(Ka_button,"Ka_button");proto.mt_create=function(kw)
{let self=this;let subscriber=self.gobj_read_attr("subscriber");if(!subscriber){subscriber=self.gobj_parent();}
self.gobj_subscribe_event(null,null,subscriber);if(!self.config.layer){self.config.layer=self.gobj_parent().config.layer;}
self.private._ka_container=create_shape(self);};proto.mt_destroy=function()
{let self=this;if(self.private._ka_container){self.private._ka_container.destroy();self.private._ka_container=null;}};proto.mt_start=function(kw)
{let self=this;if(self.config.disabled){self.gobj_send_event("EV_DISABLE",{},self);}};proto.mt_stop=function(kw)
{let self=this;};proto.mt_writing=function(name)
{let self=this;switch(name){case"disabled":if(self.config.disabled){self.gobj_send_event("EV_DISABLE",{},self);}else{self.gobj_send_event("EV_ENABLE",{},self);}
break;case"background_color":self.private._ka_container.shape_label_background_color(self.config.background_color);break;case"color":self.private._ka_container.shape_label_color(self.config.color);break;case"icon_color":self.private._ka_container.shape_label_icon_color(self.config.icon_color);break;case"text_color":self.private._ka_container.shape_label_text_color(self.config.text_color);break;case"label":self.private._ka_container.shape_label_text(self.config.label);break;}};proto.get_konva_container=function()
{let self=this;return self.private._ka_container;};exports.Ka_button=Ka_button;})(this);(function(exports){'use strict';let CONFIG={subscriber:null,layer:null,view:null,id:"",action:null,port_shape:"circle",port_color:"#FFEEAA",port_position:"",port_label:"",port_label_background_color:"#00000000",port_label_color:"black",disabled:false,selected:false,unlocked:false,x:0,y:0,width:20,height:20,visible:true,draggable:false,kw_border_shape:{strokeWidth:2,stroke:"#f5c211ff",opacity:1,shadowBlur:0,shadowColor:"black",shadowForStrokeEnabled:false},kw_label:{autosize:true,kw_border_shape:{strokeWidth:0,cornerRadius:0},kw_text_font_properties:{padding:0},kw_icon_font_properties:{padding:0}},quick_display:false,_icon_size:0,_text_size:0,_ka_container:null,_ka_border_shape:null,_ka_label:null};function create_shape(self)
{let width=kw_get_int(self.config,"width",20);let height=kw_get_int(self.config,"height",20);let port_color=kw_get_str(self.config,"port_color","red");let ka_container=new Konva.Group({id:kw_get_str(self.config,"id",""),name:kw_get_str(self.config,"name",""),x:kw_get_int(self.config,"x",0),y:kw_get_int(self.config,"y",0),width:width,height:height,visible:kw_get_bool(self.config,"visible",true),draggable:self.config.draggable});ka_container.gobj=self;let kw_border_shape=__duplicate__(kw_get_dict(CONFIG,"kw_border_shape",{}));json_object_update(kw_border_shape,kw_get_dict(self.config,"kw_border_shape",{}));json_object_update_missing(kw_border_shape,{name:"ka_border_shape",x:0,y:0,width:width,height:height,fill:port_color});switch(self.config.port_shape){case"rect":self.private._ka_border_shape=new Konva.Rect(kw_border_shape);break;case"circle":default:self.private._ka_border_shape=new Konva.Circle(kw_border_shape);}
ka_container.add(self.private._ka_border_shape);let label=self.config.port_label;if(!empty_string(label)){let kw_label=__duplicate__(kw_get_dict(self.config,"kw_label",{}));json_object_update_missing(kw_label,{name:"ka_label",label:label,background_color:self.config.port_label_background_color,color:self.config.port_label_color,y:self.config.port_shape==="circle"?-height/2:0});let x=0;let y=0;switch(self.config.port_position){case"left":self.private._ka_label=create_shape_label_with_icon(kw_label);x=width;if(self.config.port_shape==="circle"){x=width/2+5;}else{x+=5;}
self.private._ka_label.x(x);break;case"right":self.private._ka_label=create_shape_label_with_icon(kw_label);x=self.private._ka_label.width()+5;if(self.config.port_shape==="circle"){x+=width/2;}
self.private._ka_label.x(-x);break;case"top":self.private._ka_label=create_shape_label_with_icon(kw_label);self.private._ka_label.rotation(-45);if(self.config.port_shape==="circle"){y=height+5;x=0;}else{x=width/2;y=height;}
self.private._ka_label.position({x:x,y:-y});break;case"bottom":self.private._ka_label=create_shape_label_with_icon(kw_label);self.private._ka_label.rotation(45);if(self.config.port_shape==="circle"){y=height/2+5;x=5;}else{y=height+5;x=width;}
self.private._ka_label.position({x:x,y:y});break;}
if(self.private._ka_label){ka_container.add(self.private._ka_label);}}
if(self.config.draggable){ka_container.on('dragstart',function(ev){ev.cancelBubble=true;self.config.layer.getStage().container().style.cursor="move";self.gobj_publish_event("EV_MOVING",ka_container.position());});ka_container.on('dragmove',function(ev){ev.cancelBubble=true;self.config.layer.getStage().container().style.cursor="move";self.gobj_publish_event("EV_MOVING",ka_container.position());});ka_container.on('dragend',function(ev){ka_container.opacity(1);ev.cancelBubble=true;if(self.config.action){self.config.layer.getStage().container().style.cursor="pointer";}else{self.config.layer.getStage().container().style.cursor="default";}
self.gobj_publish_event("EV_MOVED",ka_container.position());});}
let id=kw_get_str(self.config,"id",null);let action=kw_get_dict_value(self.config,"action",null);if(is_null(id)){if(is_string(item.action)){self.config.id=action;}}
if(is_string(action)){let event=action;self.config.action=function(e){e["__share_kw__"]=true;self.gobj_publish_event(event,e);};}else if(action&&!is_function(action)){log_error("action must be a string or function");return ka_container;}
if(is_function(self.config.action)){ka_container.on("mouseenter",function(e){self.config.layer.getStage().container().style.cursor="pointer";});ka_container.on("mouseleave",function(e){self.config.layer.getStage().container().style.cursor="default";});ka_container.on("pointerdown",function(e){ka_container.opacity(0.5);e.gobj=self;if(self.is_tracing()){log_warning(sprintf("%s.%s ==> (%s), cancelBubble: %s, gobj: %s, ka_id: %s, ka_name: %s","nd_machine","element",e.type,(e.cancelBubble)?"Y":"N",self.gobj_short_name(),kw_get_str(e.target.attrs,"id",""),kw_get_str(e.target.attrs,"name","")));}});ka_container.on("pointerup",function(e){ka_container.opacity(1);e.cancelBubble=true;e.gobj=self;if(self.is_tracing()){log_warning(sprintf("%s.%s ==> (%s), cancelBubble: %s, gobj: %s, ka_id: %s, ka_name: %s","nd_machine","element",e.type,(e.cancelBubble)?"Y":"N",self.gobj_short_name(),kw_get_str(e.target.attrs,"id",""),kw_get_str(e.target.attrs,"name","")));}
self.config.action(e);});}
return ka_container;}
function ac_color(self,event,kw,src)
{let color=kw_get_str(kw,"color","");switch(kw.what){case"text":if(self.private._ka_label){if(color){self.private._ka_label.shape_label_text_color(color);}else{kw["color"]=self.private._ka_label.shape_label_text_color();}}
break;case"icon":if(self.private._ka_label){if(color){self.private._ka_label.shape_label_icon_color(color);}else{kw["color"]=self.private._ka_label.shape_label_icon_color();}}
break;case"port":default:if(color){self.private._ka_border_shape.fill(color);}else{kw["color"]=self.private._ka_border_shape.fill();}
break;}
return 0;}
function ac_position(self,event,kw,src)
{self.config.x=kw_get_int(kw,"x",self.config.x,false,false);self.config.y=kw_get_int(kw,"y",self.config.y,false,false);let ka_container=self.private._ka_container;ka_container.position({x:self.config.x,y:self.config.y});return 0;}
function ac_size(self,event,kw,src)
{self.config.width=kw_get_int(kw,"width",self.config.width,false,false);self.config.height=kw_get_int(kw,"height",self.config.height,false,false);return 0;}
function ac_get_dimension(self,event,kw,src)
{if(!is_object(kw)){log_error(sprintf("%s: get_dimension(): kw not an object, from %s",self.gobj_short_name(),src.gobj_short_name()));return-1;}
kw["x"]=self.config.x;kw["y"]=self.config.y;kw["width"]=self.config.width;kw["height"]=self.config.height;kw["absolute_dimension"]=self.private._ka_border_shape.getClientRect();if(!self.config.view){log_error(sprintf("%s: view of port NULL",self.gobj_short_name()));}
kw["relative_dimension"]=self.private._ka_border_shape.getClientRect({relativeTo:self.config.view.get_konva_container()});return 0;}
function ac_select(self,event,kw,src)
{self.config.selected=true;return 0;}
function ac_unselect(self,event,kw,src)
{self.config.selected=false;return 0;}
function ac_enable(self,event,kw,src)
{self.config.disabled=false;return 0;}
function ac_disable(self,event,kw,src)
{self.config.disabled=true;return 0;}
function ac_lock(self,event,kw,src)
{return 0;}
function ac_unlock(self,event,kw,src)
{return 0;}
function ac_timeout(self,event,kw,src)
{return 0;}
function ac_resize(self,event,kw,src)
{return 0;}
let FSM={"event_list":["EV_MOVING: output no_warn_subs","EV_MOVED: output no_warn_subs","EV_COLOR","EV_POSITION","EV_SIZE","EV_GET_DIMENSION","EV_SELECT","EV_UNSELECT","EV_ENABLE","EV_DISABLE","EV_LOCK","EV_UNLOCK","EV_TIMEOUT","EV_RESIZE"],"state_list":["ST_IDLE"],"machine":{"ST_IDLE":[["EV_COLOR",ac_color,undefined],["EV_POSITION",ac_position,undefined],["EV_SIZE",ac_size,undefined],["EV_GET_DIMENSION",ac_get_dimension,undefined],["EV_SELECT",ac_select,undefined],["EV_UNSELECT",ac_unselect,undefined],["EV_ENABLE",ac_enable,undefined],["EV_DISABLE",ac_disable,undefined],["EV_LOCK",ac_lock,undefined],["EV_UNLOCK",ac_unlock,undefined],["EV_TIMEOUT",ac_timeout,undefined],["EV_RESIZE",ac_resize,undefined]]}};let Ka_port=GObj.__makeSubclass__();let proto=Ka_port.prototype;proto.__init__=function(name,kw){GObj.prototype.__init__.call(this,FSM,CONFIG,name,"Ka_port",kw,gcflag_no_check_output_events);return this;};gobj_register_gclass(Ka_port,"Ka_port");proto.mt_create=function(kw)
{let self=this;let subscriber=self.gobj_read_attr("subscriber");if(!subscriber){subscriber=self.gobj_parent();}
self.gobj_subscribe_event(null,null,subscriber);if(!self.config.layer){self.config.layer=self.gobj_parent().config.layer;}
self.private._ka_container=create_shape(self);};proto.mt_destroy=function()
{let self=this;if(self.private._ka_container){self.private._ka_container.destroy();self.private._ka_container=null;}};proto.mt_start=function(kw)
{let self=this;};proto.mt_stop=function(kw)
{let self=this;};proto.mt_writing=function(name)
{let self=this;switch(name){case"port_color":self.private._ka_border_shape.fill(self.config.port_color);break;case"port_label_background_color":self.private._ka_label.shape_label_background_color(self.config.port_label_background_color);break;case"port_label_color":self.private._ka_label.fill(self.config.port_label_color);break;}};proto.get_konva_container=function()
{let self=this;return self.private._ka_container;};exports.Ka_port=Ka_port;})(this);(function(exports){'use strict';let CONFIG={subscriber:null,layer:null,shape:"circle",x:0,y:0,width:12,height:12,radius:6,color:"yellow",visible:true,kw_border_shape:{strokeWidth:0,stroke:"black",opacity:1,shadowBlur:0,shadowColor:"black",shadowForStrokeEnabled:false},_ka_container:null,_ka_border_shape:null};function create_shape(self)
{let width=self.config.width;let height=self.config.height;let radius=self.config.radius;let color=self.config.color;let ka_container=new Konva.Group({width:width,height:height,visible:kw_get_bool(self.config,"visible",true)});ka_container.gobj=self;let kw_border_shape=__duplicate__(kw_get_dict(CONFIG,"kw_border_shape",{}));json_object_update(kw_border_shape,kw_get_dict(self.config,"kw_border_shape",{}));json_object_update_missing(kw_border_shape,{name:"ka_border_shape",x:0,y:0,width:width,height:height,radius:radius,fill:color,});switch(self.config.port_shape){case"rect":self.private._ka_border_shape=new Konva.Rect(kw_border_shape);break;case"circle":default:self.private._ka_border_shape=new Konva.Circle(kw_border_shape);}
ka_container.add(self.private._ka_border_shape);return ka_container;}
function ac_position(self,event,kw,src)
{self.config.x=kw_get_int(kw,"x",self.config.x,false,false);self.config.y=kw_get_int(kw,"y",self.config.y,false,false);let ka_container=self.private._ka_container;ka_container.position({x:self.config.x,y:self.config.y});return 0;}
function ac_size(self,event,kw,src)
{self.config.width=kw_get_int(kw,"width",self.config.width,false,false);self.config.height=kw_get_int(kw,"height",self.config.height,false,false);return 0;}
let FSM={"event_list":["EV_POSITION","EV_SIZE"],"state_list":["ST_IDLE"],"machine":{"ST_IDLE":[["EV_POSITION",ac_position,undefined],["EV_SIZE",ac_size,undefined]]}};let Ka_photon=GObj.__makeSubclass__();let proto=Ka_photon.prototype;proto.__init__=function(name,kw){GObj.prototype.__init__.call(this,FSM,CONFIG,name,"Ka_photon",kw,gcflag_no_check_output_events);return this;};gobj_register_gclass(Ka_photon,"Ka_photon");proto.mt_create=function(kw)
{let self=this;let subscriber=self.gobj_read_attr("subscriber");if(!subscriber){subscriber=self.gobj_parent();}
self.gobj_subscribe_event(null,null,subscriber);if(!self.config.layer){self.config.layer=self.gobj_parent().config.layer;}
self.private._ka_container=create_shape(self);};proto.mt_destroy=function()
{let self=this;if(self.private._ka_container){self.private._ka_container.destroy();self.private._ka_container=null;}};proto.mt_start=function(kw)
{let self=this;};proto.mt_stop=function(kw)
{let self=this;};proto.mt_writing=function(name)
{let self=this;switch(name){case"color":self.private._ka_border_shape.fill(self.config.color);break;}};proto.get_konva_container=function()
{let self=this;return self.private._ka_container;};exports.Ka_photon=Ka_photon;})(this);(function(exports){'use strict';let CONFIG={subscriber:null,layer:null,modal:true,super_modal:true,autoclose:false,items:[],x:100,y:100,width:240,height:240,padding:10,background_color:"white",draggable:true,kw_border_shape:{strokeWidth:8,opacity:1,shadowBlur:5},kw_border_shape_actived:{},_gobj_ka_scrollview:null,_ka_list:[]};function calculate_max_width(self,items)
{let max_width=0;for(let i=0;i<items.length;i++){let item=items[i];let label=kw_get_str(item,"label","",false,true);let kw_text=kw_get_dict(item,"kw_text",{},false,false);if(empty_string(label)){continue;}
kw_text.fontSize=adjust_font_size(kw_text.fontSize,kw_text.fontFamily,kw_text.padding);let text_size=get_text_size(label,kw_text.fontFamily,kw_text.fontSize,kw_text.padding,true);if(text_size.width>max_width){max_width=text_size.width;}}
let _w=kw_get_int(self.config.kw_border_shape,"strokeWidth",0,false,false);_w+=Math.max(kw_get_int(self.config.kw_border_shape,"shadowBlur",0,false,false),kw_get_int(self.config.kw_border_shape_actived,"strokeWidth",0,false,false));let _max_width=window.innerWidth-self.config.padding*2-_w*2;if(_max_width>0&&max_width>_max_width){max_width=_max_width;}
return max_width;}
function remove_ka_list(self)
{for(let i=0;i<self.private._ka_list.length;i++){let ka_group=self.private._ka_list[i];if(ka_group){ka_group.record.ka_group=null;ka_group.record=null;ka_group.destroy();self.private._ka_list[i]=null;}}
self.private._ka_list=[];}
function create_konva_item(self,record,y,width)
{let id=kw_get_str(record,"id","",false,false);let name=kw_get_str(record,"name","",false,false);let label=kw_get_str(record,"label","",false,true);if(empty_string(label)){return null;}
let icon=kw_get_str(record,"icon","",false,false);let action=kw_get_dict_value(record,"action",null,false,false);if(is_string(action)){let event=action;record.action=function(_self,_id){_self.gobj_publish_event(event,{"id":_id});};}else if(action&&!is_function(action)){log_error("action must be a string or function");}
let ka_group=new Konva.Group({id:id,name:name,x:0,y:y});let kw_text=__duplicate__(kw_get_dict(record,"kw_text",{},false));json_object_update(kw_text,{x:0,y:0,text:label,width:width});let ka_text=new Konva.Text(kw_text);let kw_rect=__duplicate__(kw_get_dict(record,"kw_rect",{},false));json_object_update(kw_rect,{x:0,y:0,width:ka_text.getClientRect().width,height:ka_text.getClientRect().height});let ka_rect=new Konva.Rect(kw_rect);ka_group.add(ka_rect);ka_group.add(ka_text);record.ka_group=ka_group;ka_group.record=record;enable_konva_item(self,record,!record.disabled,true);return ka_group;}
function enable_konva_item(self,record,enable,force)
{let stage=self.config.layer.getStage();let ka_group=record.ka_group;let ka_text=ka_group.findOne("Text");if(enable){if(record.disabled||force){record.disabled=false;ka_text.opacity(1);if(record.action){ka_group.on("mouseenter",function(e){stage.container().style.cursor="pointer";});ka_group.on("mouseleave",function(e){ka_group.opacity(1);stage.container().style.cursor="default";});ka_group.on("pointerdown",function(e){e.cancelBubble=false;e.gobj=self;if(self.is_tracing()){log_warning(sprintf("%s.%s ==> (%s), cancelBubble: %s, gobj: %s, ka_id: %s, ka_name: %s","ka_display_message","ka_group",e.type,(e.cancelBubble)?"Y":"N",self.gobj_short_name(),kw_get_str(e.target.attrs,"id",""),kw_get_str(e.target.attrs,"name","")));}
ka_group.opacity(0.5);});ka_group.on("pointerup",function(e){e.cancelBubble=false;e.gobj=self;if(self.is_tracing()){log_warning(sprintf("%s.%s ==> (%s), cancelBubble: %s, gobj: %s, ka_id: %s, ka_name: %s","ka_display_message","ka_group",e.type,(e.cancelBubble)?"Y":"N",self.gobj_short_name(),kw_get_str(e.target.attrs,"id",""),kw_get_str(e.target.attrs,"name","")));}
ka_group.opacity(1);record.action(self,record.id?record.id:record.name);});}}}else{if(!record.disabled||force){record.disabled=true;ka_text.opacity(0.4);if(record.action){ka_group.off("mouseenter");ka_group.off("mouseleave");ka_group.off("pointerdown");ka_group.off("pointerup");ka_group.on("pointerup",function(e){e.cancelBubble=true;if(self.is_tracing()){log_warning(sprintf("%s.%s ==> (%s), cancelBubble: %s, gobj: %s, ka_id: %s, ka_name: %s","ka_display_message","ka_group",e.type,(e.cancelBubble)?"Y":"N",self.gobj_short_name(),kw_get_str(e.target.attrs,"id",""),kw_get_str(e.target.attrs,"name","")));}});}}}}
function ac_add_item(self,event,kw,src)
{let items_=kw_get_list(kw,"items",[],false,true);let items=__duplicate__(items_);remove_ka_list(self);let width=calculate_max_width(self,items);let y=0;for(let i=0;i<items.length;i++){let record=items[i];let ka_group=create_konva_item(self,record,y,width);if(ka_group){let rc=ka_group.getClientRect();let delta=rc.height;self.private._ka_list.push(ka_group);y+=delta;}}
self.private._gobj_ka_scrollview.gobj_send_event("EV_ADD_ITEM",{items:self.private._ka_list},self);return 0;}
function ac_keydown(self,event,kw,src)
{let ret=0;if(self.private._gobj_ka_scrollview.isVisible()){switch(kw.keyCode){case 27:if(self.config.modal){self.gobj_send_event("EV_HIDE",{},self);ret=-1;}
break;case 13:let record=kwid_find_one_record(self.config.items,"submit");if(record){record.action(self,record.id?record.id:record.name);ret=-1;}
break;default:break;}}
return ret;}
function ac_activate(self,event,kw,src)
{self.get_konva_container().moveToTop();self.private._gobj_ka_scrollview.gobj_send_event("EV_ACTIVATE",{},self);return 0;}
function ac_deactivate(self,event,kw,src)
{self.private._gobj_ka_scrollview.gobj_send_event("EV_DEACTIVATE",{},self);return 0;}
function ac_position(self,event,kw,src)
{self.config.x=kw_get_int(kw,"x",self.config.x,false,false);self.config.y=kw_get_int(kw,"y",self.config.y,false,false);let position={x:self.config.x,y:self.config.y};self.private._gobj_ka_scrollview.gobj_send_event(event,position,self);return 0;}
function ac_size(self,event,kw,src)
{self.config.width=kw_get_int(kw,"width",self.config.width,false,false);self.config.height=kw_get_int(kw,"height",self.config.height,false,false);let size={width:self.config.width,height:self.config.height};self.private._gobj_ka_scrollview.gobj_send_event(event,size,self);return 0;}
function ac_show_or_hide(self,event,kw,src)
{let position=kw;let node_dimension={};self.private._gobj_ka_scrollview.gobj_send_event("EV_GET_DIMENSION",node_dimension,self);self.config.x=kw_get_int(position,"x",node_dimension.x,true,false);self.config.y=kw_get_int(position,"y",node_dimension.y,true,false);self.private._gobj_ka_scrollview.gobj_send_event("EV_POSITION",position,self);self.private._gobj_ka_scrollview.gobj_send_event(event,kw,self);let __ka_main__=self.yuno.gobj_find_service("__ka_main__",true);if(self.private._gobj_ka_scrollview.isVisible()){__ka_main__.gobj_send_event("EV_ACTIVATE",{},self);}else{__ka_main__.gobj_send_event("EV_DEACTIVATE",{},self);}
return 0;}
function ac_showed(self,event,kw,src)
{return 0;}
function ac_hidden(self,event,kw,src)
{return 0;}
function ac_resize(self,event,kw,src)
{let node_dimension={};self.private._gobj_ka_scrollview.gobj_send_event("EV_GET_DIMENSION",node_dimension,self);let kw_restore={};let _original_x=kw_get_int(node_dimension,"_original_x",null,false,false);let _original_y=kw_get_int(node_dimension,"_original_y",null,false,false);let _original_width=kw_get_int(node_dimension,"_original_width",null,false,false);let _original_height=kw_get_int(node_dimension,"_original_height",null,false,false);if(_original_x!==null){kw_restore.x=_original_x;}
if(_original_y!==null){kw_restore.y=_original_y;}
if(_original_width!==null){kw_restore.width=_original_width;}
if(_original_height!==null){kw_restore.height=_original_height;}
self.private._gobj_ka_scrollview.gobj_send_event("EV_RESIZE",kw_restore,self);return 0;}
let FSM={"event_list":["EV_KEYDOWN","EV_ADD_ITEM","EV_ACTIVATE","EV_DEACTIVATE","EV_TOGGLE","EV_POSITION","EV_SIZE","EV_SHOW","EV_HIDE","EV_SHOWED","EV_HIDDEN","EV_RESIZE"],"state_list":["ST_IDLE"],"machine":{"ST_IDLE":[["EV_KEYDOWN",ac_keydown,undefined],["EV_ADD_ITEM",ac_add_item,undefined],["EV_ACTIVATE",ac_activate,undefined],["EV_DEACTIVATE",ac_deactivate,undefined],["EV_TOGGLE",ac_show_or_hide,undefined],["EV_SHOW",ac_show_or_hide,undefined],["EV_HIDE",ac_show_or_hide,undefined],["EV_POSITION",ac_position,undefined],["EV_SIZE",ac_size,undefined],["EV_SHOWED",ac_showed,undefined],["EV_HIDDEN",ac_hidden,undefined],["EV_RESIZE",ac_resize,undefined]]}};let Sw_display_message=GObj.__makeSubclass__();let proto=Sw_display_message.prototype;proto.__init__=function(name,kw){GObj.prototype.__init__.call(this,FSM,CONFIG,name,"Sw_display_message",kw,0);return this;};gobj_register_gclass(Sw_display_message,"Sw_display_message");proto.mt_create=function(kw)
{let self=this;if(!self.config.layer){log_error("What konva layer?");return;}
let subscriber=self.gobj_read_attr("subscriber");if(!subscriber){subscriber=self.gobj_parent();}
self.gobj_subscribe_event(null,null,subscriber);self.private._gobj_ka_scrollview=self.yuno.gobj_create(self.gobj_name(),Ka_scrollview,{layer:self.config.layer,x:self.config.x,y:self.config.y,width:self.config.width,height:self.config.height,padding:self.config.padding,background_color:self.config.background_color,visible:true,panning:true,draggable:self.config.draggable,autosize:true,fix_dimension_to_screen:true,center:true,show_overflow:false,enable_vscroll:true,enable_hscroll:true,scroll_by_step:true,kw_border_shape:__duplicate__(kw_get_dict(self.config,"kw_border_shape",{},false,false)),kw_border_shape_actived:__duplicate__(kw_get_dict(self.config,"kw_border_shape_actived",{},false,false))},self);self.private._gobj_ka_scrollview.get_konva_container().gobj=self;self.gobj_send_event("EV_ADD_ITEM",{items:self.config.items},self);self.gobj_send_event("EV_SHOW",{},self);};proto.mt_destroy=function()
{let self=this;};proto.mt_start=function(kw)
{let self=this;};proto.mt_stop=function(kw)
{let self=this;};proto.get_konva_container=function()
{let self=this;return self.private._gobj_ka_scrollview.get_konva_container();};function display_message(kw)
{let type=kw_get_str(kw,"type","",false,false);let text=kw_get_str(kw,"text","",false,false);let title=kw_get_str(kw,"title","",false,false);let ok=kw_get_str(kw,"ok","Ok",false,false);let callback=kw_get_dict_value(kw,"callback",null,false,false);if(empty_string(title)){if(type=="error"){title=t("error");}else if(type=="warning"){title=t("warning");}}
let color;switch(type){case"error":color="red";break;case"warning":color="yellow";break;default:color="gray";break;}
let kw_border_shape={"stroke":color,"shadowColor":color};let kw_border_shape_actived={"stroke":color,"shadowColor":color};let items=[{"label":title,kw_text:{fontFamily:"sans-serif",fontSize:30,fill:"black",align:"center",padding:5},"kw_rect":{strokeWidth:0}},{"label":text,"kw_text":{fontFamily:"sans-serif",fontSize:20,fill:"black",align:"center",padding:20},"kw_rect":{strokeWidth:0}},{"id":"submit","label":t(ok),"icon":"","kw_text":{fontFamily:"sans-serif",fontSize:20,fill:"black",align:"center",padding:10},"kw_rect":{fill:color,opacity:0.4,strokeWidth:0},"action":function(_self,_item){_self.gobj_send_event("EV_HIDE",{},__ka_main__);__yuno__.gobj_destroy(_self);if(callback){callback();}}}];let __ka_main__=__yuno__.gobj_find_service("__ka_main__",true);let gobj_display_message=__yuno__.gobj_create('display_message',Sw_display_message,{x:700,y:130,layer:__ka_main__.get_main_layer(),"kw_border_shape":kw_border_shape,"kw_border_shape_actived":kw_border_shape_actived,items:items},__ka_main__);if(gobj_display_message){__ka_main__.gobj_send_event("EV_ACTIVATE",{},gobj_display_message);}}
function display_error_message(msg,title,callback,ok)
{let kw={type:"error",title:title,text:msg,callback:callback,ok:ok};display_message(kw);}
function display_warning_message(msg,title,callback,ok)
{let kw={type:"warning",title:title,text:msg,callback:callback,ok:ok};display_message(kw);}
function display_ok_message(msg,title)
{let kw={type:"",title:title,text:msg,callback:callback,ok:ok};display_message(kw);}
exports.Sw_display_message=Sw_display_message;exports.display_message=display_message;exports.display_error_message=display_error_message;exports.display_warning_message=display_warning_message;exports.display_ok_message=display_ok_message;})(this);(function(exports){'use strict';let CONFIG={subscriber:null,layer:null,modal:false,super_modal:false,autoclose:true,items:[],kw_text:{fontFamily:"sans-serif",fontSize:20,fill:"black",padding:10},kw_menu_item_rect:{fill:"white",stroke:"gray",strokeWidth:2,opacity:1},x:200,y:200,width:250,height:250,padding:0,background_color:"white",visible:true,draggable:false,autosize:true,kw_border_shape:{strokeWidth:1,stroke:"gray",opacity:1,shadowBlur:0,shadowColor:"gray"},kw_border_shape_actived:{stroke:"blue",opacity:1,shadowBlur:0,shadowColor:"blue"},_jdb:{"type":[],"hook":"data","schema":{"menu":[]}},_topic_name:"menu",_gobj_ka_scrollview:null,_ka_list:[]};function remove_ka_list(self)
{for(let i=0;i<self.private._ka_list.length;i++){let ka_group=self.private._ka_list[i];if(ka_group){ka_group.record.ka_group=null;ka_group.record=null;ka_group.destroy();self.private._ka_list[i]=null;}}
self.private._ka_list=[];}
function create_konva_item(self,record,y,width)
{let id=kw_get_str(record,"id","",false,false);let label=kw_get_str(record,"label","",false,true);if(empty_string(label)){return null;}
let icon=kw_get_str(record,"icon","",false,false);let action=kw_get_dict_value(record,"action",null,false,false);if(is_string(action)){let event=action;record.action=function(_id){self.gobj_publish_event(event,{"id":_id});};}else if(action&&!is_function(action)){log_error("action must be a string or function");}
let x=0;x+=kw_get_int(self.config.kw_menu_item_rect,"strokeWidth",0,false,false)/2;x+=kw_get_int(self.config.kw_menu_item_rect,"shadowBlur",0,false,false);let ka_group=new Konva.Group({id:id,name:"sw_menu_container",x:x,y:y});let kw_text=__duplicate__(kw_get_dict(self.config,"kw_text",{},false));json_object_update(kw_text,{x:0,y:0,text:label,width:width});let ka_text=new Konva.Text(kw_text);ka_group.add(ka_text);let text_dimension=ka_text.getClientRect({relativeTo:ka_text.getParent()});let kw_menu_item_rect=__duplicate__(kw_get_dict(self.config,"kw_menu_item_rect",{},false));json_object_update(kw_menu_item_rect,text_dimension);let ka_rect=new Konva.Rect(kw_menu_item_rect);ka_group.add(ka_rect);ka_group.size(ka_group.getClientRect());ka_text.moveToTop();record.ka_group=ka_group;ka_group.record=record;enable_konva_item(self,record,!record.disabled,true);return ka_group;}
function enable_konva_item(self,record,enable,force)
{let stage=self.config.layer.getStage();let ka_group=record.ka_group;let ka_text=ka_group.findOne("Text");if(enable){if(record.disabled||force){record.disabled=false;ka_text.opacity(1);if(is_function(record.action)){ka_group.on("mouseenter",function(e){stage.container().style.cursor="pointer";});ka_group.on("mouseleave",function(e){ka_group.opacity(1);stage.container().style.cursor="default";});ka_group.on("pointerdown",function(e){e.cancelBubble=false;e.gobj=self;if(self.is_tracing()){log_warning(sprintf("%s.%s ==> (%s), cancelBubble: %s, gobj: %s, ka_id: %s, ka_name: %s","Sw_menu","ka_group",e.type,(e.cancelBubble)?"Y":"N",self.gobj_short_name(),kw_get_str(e.target.attrs,"id",""),kw_get_str(e.target.attrs,"name","")));}
ka_group.opacity(0.5);});ka_group.on("pointerup",function(e){e.cancelBubble=false;e.gobj=self;log_warning(sprintf("%s.%s ==> (%s), cancelBubble: %s, gobj: %s, ka_id: %s, ka_name: %s","Sw_menu","element",e.type,(e.cancelBubble)?"Y":"N",self.gobj_short_name(),kw_get_str(e.target.attrs,"id",""),kw_get_str(e.target.attrs,"name","")));ka_group.opacity(1);record.action(record.id);});}}}else{if(!record.disabled||force){record.disabled=true;ka_text.opacity(0.4);if(record.action){ka_group.off("mouseenter");ka_group.off("mouseleave");ka_group.off("pointerdown");ka_group.off("pointerup");ka_group.on("pointerup",function(e){e.cancelBubble=true;if(self.is_tracing()){log_warning(sprintf("%s.%s ==> (%s), cancelBubble: %s, gobj: %s, ka_id: %s, ka_name: %s","Sw_menu","ka_group",e.type,(e.cancelBubble)?"Y":"N",self.gobj_short_name(),kw_get_str(e.target.attrs,"id",""),kw_get_str(e.target.attrs,"name","")));}});}}}}
function ac_add_item(self,event,kw,src)
{let items=kw_get_list(kw,"items",[],false,true);for(let i=0;i<items.length;i++){let item=items[i];if(item.id===undefined||item.id===null){if(is_string(item.action)){item.id=item.action;}}
jdb_update(self.private._jdb,self.private._topic_name,"",item);}
remove_ka_list(self);let menu_topic=jdb_get_topic(self.private._jdb,self.private._topic_name);let y=0;y+=kw_get_int(self.config.kw_menu_item_rect,"strokeWidth",0,false,false)/2;y+=kw_get_int(self.config.kw_menu_item_rect,"shadowBlur",0,false,false);for(let i=0;i<menu_topic.length;i++){let record=menu_topic[i];let ka_group=create_konva_item(self,record,y,self.config.width);if(ka_group){let delta=ka_group.getClientRect({skipShadow:true,skipStroke:true}).height;self.private._ka_list.push(ka_group);y+=delta;}}
self.private._gobj_ka_scrollview.gobj_send_event("EV_ADD_ITEM",{items:self.private._ka_list},self);return 0;}
function ac_remove_item(self,event,kw,src)
{let items=kw_get_list(kw,"items",[],false,true);for(let i=0;i<items.length;i++){let item=items[i];jdb_delete(self.private._jdb,self.private._topic_name,"",item);}
remove_ka_list(self);let menu_topic=jdb_get_topic(self.private._jdb,self.private._topic_name);for(let i=0,y=0;i<menu_topic;i++){let record=menu_topic[i];let ka_group=create_konva_item(self,record,y,self.config.width);if(ka_group){let delta=ka_group.getClientRect({skipShadow:true,skipStroke:true}).height;self.private._ka_list.push(ka_group);y+=delta;}}
self.private._gobj_ka_scrollview.gobj_send_event("EV_ADD_ITEM",{items:self.private._ka_list},self);return 0;}
function ac_keydown(self,event,kw,src)
{let ret=0;if(self.private._gobj_ka_scrollview.isVisible()){switch(kw.keyCode){case 27:if(self.config.modal){self.gobj_send_event("EV_HIDE",{},self);ret=-1;}
break;default:break;}}
return ret;}
function ac_enable_items(self,event,kw,src)
{let ids=kwid_get_ids(kw);for(let i=0;i<ids.length;i++){let id=ids[i];let record=jdb_get(self.private._jdb,self.private._topic_name,id);if(!record){log_error(sprintf("%s: enable_items, record not found, id:%s",self.gobj_short_name(),id));continue;}
enable_konva_item(self,record,true);}
return 0;}
function ac_disable_items(self,event,kw,src)
{let ids=kwid_get_ids(kw);for(let i=0;i<ids.length;i++){let id=ids[i];let record=jdb_get(self.private._jdb,self.private._topic_name,id);if(!record){log_error(sprintf("%s: enable_items, record not found, id:%s",self.gobj_short_name(),id));continue;}
enable_konva_item(self,record,false);}
return 0;}
function ac_activate(self,event,kw,src)
{self.get_konva_container().moveToTop();self.private._gobj_ka_scrollview.gobj_send_event("EV_ACTIVATE",{},self);return 0;}
function ac_deactivate(self,event,kw,src)
{self.private._gobj_ka_scrollview.gobj_send_event("EV_DEACTIVATE",{},self);return 0;}
function ac_position(self,event,kw,src)
{self.config.x=kw_get_int(kw,"x",self.config.x,false,false);self.config.y=kw_get_int(kw,"y",self.config.y,false,false);let position={x:self.config.x,y:self.config.y};self.private._gobj_ka_scrollview.gobj_send_event(event,position,self);return 0;}
function ac_size(self,event,kw,src)
{self.config.width=kw_get_int(kw,"width",self.config.width,false,false);self.config.height=kw_get_int(kw,"height",self.config.height,false,false);let size={width:self.config.width,height:self.config.height};self.private._gobj_ka_scrollview.gobj_send_event(event,size,self);return 0;}
function ac_show_or_hide(self,event,kw,src)
{let position=kw;let node_dimension={};self.private._gobj_ka_scrollview.gobj_send_event("EV_GET_DIMENSION",node_dimension,self);self.config.x=kw_get_int(position,"x",node_dimension.x,true,false);self.config.y=kw_get_int(position,"y",node_dimension.y,true,false);self.private._gobj_ka_scrollview.gobj_send_event("EV_POSITION",position,self);self.private._gobj_ka_scrollview.gobj_send_event(event,kw,self);let __ka_main__=self.yuno.gobj_find_service("__ka_main__",true);if(self.private._gobj_ka_scrollview.isVisible()){__ka_main__.gobj_send_event("EV_ACTIVATE",{},self);}else{__ka_main__.gobj_send_event("EV_DEACTIVATE",{},self);}
return 0;}
function ac_showed(self,event,kw,src)
{return 0;}
function ac_hidden(self,event,kw,src)
{return 0;}
function ac_resize(self,event,kw,src)
{let node_dimension={};self.private._gobj_ka_scrollview.gobj_send_event("EV_GET_DIMENSION",node_dimension,self);let kw_restore={};let _original_x=kw_get_int(node_dimension,"_original_x",null,false,false);let _original_y=kw_get_int(node_dimension,"_original_y",null,false,false);let _original_width=kw_get_int(node_dimension,"_original_width",null,false,false);let _original_height=kw_get_int(node_dimension,"_original_height",null,false,false);if(_original_x!==null){kw_restore.x=_original_x;}
if(_original_y!==null){kw_restore.y=_original_y;}
if(_original_width!==null){kw_restore.width=_original_width;}
if(_original_height!==null){kw_restore.height=_original_height;}
self.private._gobj_ka_scrollview.gobj_send_event("EV_RESIZE",kw_restore,self);return 0;}
let FSM={"event_list":["EV_KEYDOWN","EV_ENABLE_ITEMS","EV_DISABLE_ITEMS","EV_ADD_ITEM","EV_REMOVE_ITEM","EV_ACTIVATE","EV_DEACTIVATE","EV_TOGGLE","EV_POSITION","EV_SIZE","EV_SHOW","EV_HIDE","EV_SHOWED","EV_HIDDEN","EV_RESIZE"],"state_list":["ST_IDLE"],"machine":{"ST_IDLE":[["EV_KEYDOWN",ac_keydown,undefined],["EV_ADD_ITEM",ac_add_item,undefined],["EV_REMOVE_ITEM",ac_remove_item,undefined],["EV_ENABLE_ITEMS",ac_enable_items,undefined],["EV_DISABLE_ITEMS",ac_disable_items,undefined],["EV_ACTIVATE",ac_activate,undefined],["EV_DEACTIVATE",ac_deactivate,undefined],["EV_TOGGLE",ac_show_or_hide,undefined],["EV_SHOW",ac_show_or_hide,undefined],["EV_HIDE",ac_show_or_hide,undefined],["EV_POSITION",ac_position,undefined],["EV_SIZE",ac_size,undefined],["EV_SHOWED",ac_showed,undefined],["EV_HIDDEN",ac_hidden,undefined],["EV_RESIZE",ac_resize,undefined]]}};let Sw_menu=GObj.__makeSubclass__();let proto=Sw_menu.prototype;proto.__init__=function(name,kw){GObj.prototype.__init__.call(this,FSM,CONFIG,name,"Sw_menu",kw,gcflag_no_check_output_events);return this;};gobj_register_gclass(Sw_menu,"Sw_menu");proto.mt_create=function(kw)
{let self=this;if(!self.config.subscriber){self.config.subscriber=self.gobj_parent();}
if(self.config.subscriber){self.gobj_subscribe_event(null,{},self.config.subscriber);}
if(!self.config.layer){self.config.layer=self.gobj_parent().config.layer;}
if(!self.config.layer){log_error("What layer?");}
jdb_init(self.private._jdb);self.private._gobj_ka_scrollview=self.yuno.gobj_create(self.gobj_name(),Ka_scrollview,{layer:self.config.layer,x:self.config.x,y:self.config.y,width:self.config.width,height:self.config.height,padding:self.config.padding,background_color:self.config.background_color,visible:self.config.visible,panning:true,draggable:self.config.draggable,autosize:self.config.autosize,fix_dimension_to_screen:true,center:false,show_overflow:false,enable_vscroll:true,enable_hscroll:false,scroll_by_step:true,kw_border_shape:__duplicate__(kw_get_dict(self.config,"kw_border_shape",{},false,false)),kw_border_shape_actived:__duplicate__(kw_get_dict(self.config,"kw_border_shape_actived",{},false,false))},self);self.private._gobj_ka_scrollview.get_konva_container().gobj=self;self.gobj_send_event("EV_ADD_ITEM",{items:self.config.items},self);if(self.config.visible){self.gobj_send_event("EV_SHOW",{},self);}};proto.mt_destroy=function()
{let self=this;if(self.private._gobj_ka_scrollview){self.yuno.gobj_destroy(self.private._gobj_ka_scrollview);self.private._gobj_ka_scrollview=null;}};proto.mt_start=function(kw)
{let self=this;};proto.mt_stop=function(kw)
{let self=this;};proto.get_konva_container=function()
{let self=this;return self.private._gobj_ka_scrollview.get_konva_container();};exports.Sw_menu=Sw_menu;})(this);(function(exports){'use strict';let CONFIG={subscriber:null,layer:null,orientation:"horizontal",wide:40,long:0,items:[],x:0,y:0,width:0,height:0,padding:2,background_color:"#EEEEEE",visible:true,panning:true,draggable:false,fix_dimension_to_screen:false,enable_vscroll:false,enable_hscroll:false,quick_display:false,kw_border_shape:{strokeWidth:0,stroke:null,opacity:1,shadowColor:null,shadowBlur:0},kw_border_shape_actived:{},_gobj_ka_scrollview:null};function calculate_dimension(self)
{switch(self.config.orientation){case"vertical":if(self.config.long===0){self.config.long=self.gobj_parent().gobj_read_attr("height");}
self.config.width=self.config.wide;self.config.height=self.config.long;self.config.enable_vscroll=true;self.config.enable_hscroll=false;break;default:case"horizontal":if(self.config.long===0){self.config.long=self.gobj_parent().gobj_read_attr("width");}
self.config.width=self.config.long;self.config.height=self.config.wide;self.config.enable_vscroll=false;self.config.enable_hscroll=true;break;}}
function ac_add_item(self,event,kw,src)
{let items=kw_get_dict_value(kw,"items",null,false,false);let x=0,y=0,k=null;for(let i=0;i<items.length;i++){let item=items[i];let gobj_node=null;if(is_gobj(item)){gobj_node=item;k=gobj_node.get_konva_container();}else if(is_object(item)){let kw_view=kw_get_dict(item,"kw",{});json_object_update(kw_view,{subscriber:self.config.subscriber,x:x,y:y});gobj_node=self.yuno.gobj_create(kw_get_str(item,"id",kw_get_str(item,"name","")),kw_get_dict_value(item,"gclass",null),kw_view,self);if(!gobj_node){continue;}
k=gobj_node.get_konva_container();let dim=k.getClientRect({skipShadow:true,skipStroke:true});switch(self.config.orientation){case"vertical":x=0;y+=dim.height;break;default:case"horizontal":x+=dim.width;y=0;break;}
continue;}else{log_error("What is it?"+item);continue;}
self.private._gobj_ka_scrollview.gobj_send_event("EV_ADD_ITEM",{items:[k]},self);}
return 0;}
function ac_remove_item(self,event,kw,src)
{let items=kw_get_dict_value(kw,"items",null,false,false);for(let i=0;i<items.length;i++){let item=items[i];let childs=null;if(is_string(item)){let name=item;childs=self.gobj_match_childs({__gobj_name__:name});}else if(is_object(item)){let name=kw_get_str(item,"id",kw_get_str(item,"name",""));childs=self.gobj_match_childs({__gobj_name__:name});}else if(is_gobj(item)){childs=[item];}else{log_error("What is?"+item);continue;}
for(let child in childs){let k=child.get_konva_container();self.private._gobj_ka_scrollview.gobj_send_event("EV_REMOVE_ITEM",{items:[k]},self);if(!child.gobj_is_destroying()){self.yuno.gobj_destroy(child);}}}
return 0;}
function ac_show_or_hide(self,event,kw,src)
{let __ka_main__=self.yuno.gobj_find_service("__ka_main__",true);let name=kw_get_str(kw,"id",kw_get_str(kw,"name",""));if(!empty_string(name)){if(event==="EV_SHOW"){let gobj=find_gobj_in_list(self.private._views,name);if(gobj){gobj.get_konva_container().moveToTop();__ka_main__.gobj_send_event("EV_ACTIVATE",{},gobj);}}
return 0;}
let position=kw;let node_dimension={};self.private._gobj_ka_scrollview.gobj_send_event("EV_GET_DIMENSION",node_dimension,self);self.config.x=kw_get_int(position,"x",node_dimension.x,true,false);self.config.y=kw_get_int(position,"y",node_dimension.y,true,false);self.private._gobj_ka_scrollview.gobj_send_event("EV_POSITION",position,self);self.private._gobj_ka_scrollview.gobj_send_event(event,kw,self);if(self.private._gobj_ka_scrollview.isVisible()){__ka_main__.gobj_send_event("EV_ACTIVATE",{},self);}else{__ka_main__.gobj_send_event("EV_DEACTIVATE",{},self);}
return 0;}
function ac_keydown(self,event,kw,src)
{let ret=0;return ret;}
function ac_activate(self,event,kw,src)
{self.get_konva_container().moveToTop();self.private._gobj_ka_scrollview.gobj_send_event("EV_ACTIVATE",{},self);return 0;}
function ac_deactivate(self,event,kw,src)
{self.private._gobj_ka_scrollview.gobj_send_event("EV_DEACTIVATE",{},self);return 0;}
function ac_position(self,event,kw,src)
{self.config.x=kw_get_int(kw,"x",self.config.x,false,false);self.config.y=kw_get_int(kw,"y",self.config.y,false,false);let position={x:self.config.x,y:self.config.y};self.private._gobj_ka_scrollview.gobj_send_event(event,position,self);return 0;}
function ac_size(self,event,kw,src)
{self.config.width=kw_get_int(kw,"width",self.config.width,false,false);self.config.height=kw_get_int(kw,"height",self.config.height,false,false);let size={width:self.config.width,height:self.config.height};self.private._gobj_ka_scrollview.gobj_send_event(event,size,self);return 0;}
function ac_resize(self,event,kw,src)
{self.config.x=kw_get_int(kw,"x",self.config.x);self.config.y=kw_get_int(kw,"y",self.config.y);self.config.wide=kw_get_int(kw,"wide",self.config.wide);self.config.long=kw_get_int(kw,"long",self.config.long);calculate_dimension(self);self.private._gobj_ka_scrollview.gobj_send_event("EV_RESIZE",{x:self.config.x,y:self.config.y,width:self.config.width,height:self.config.height},self);return 0;}
function ac_panning(self,event,kw,src)
{if(src===self.private._gobj_ka_scrollview){}
return 0;}
function ac_moving(self,event,kw,src)
{if(src===self.private._gobj_ka_scrollview){}else{if(strcmp(event,"EV_MOVED")===0){if(kw.x<0||kw.y<0){if(kw.x<0){kw.x=0;}
if(kw.y<0){kw.y=0;}
src.gobj_send_event("EV_POSITION",kw,self);}
self.private._gobj_ka_scrollview.gobj_send_event("EV_RESIZE",{},self);}}
return 0;}
function ac_showed(self,event,kw,src)
{return 0;}
function ac_hidden(self,event,kw,src)
{return 0;}
let FSM={"event_list":["EV_KEYDOWN","EV_ADD_ITEM","EV_REMOVE_ITEM","EV_ACTIVATE","EV_DEACTIVATE","EV_TOGGLE","EV_POSITION","EV_SIZE","EV_SHOW","EV_HIDE","EV_RESIZE","EV_PANNING","EV_PANNED","EV_MOVING","EV_MOVED","EV_SHOWED","EV_HIDDEN"],"state_list":["ST_IDLE"],"machine":{"ST_IDLE":[["EV_KEYDOWN",ac_keydown,undefined],["EV_ADD_ITEM",ac_add_item,undefined],["EV_REMOVE_ITEM",ac_remove_item,undefined],["EV_ACTIVATE",ac_activate,undefined],["EV_DEACTIVATE",ac_deactivate,undefined],["EV_TOGGLE",ac_show_or_hide,undefined],["EV_SHOW",ac_show_or_hide,undefined],["EV_HIDE",ac_show_or_hide,undefined],["EV_POSITION",ac_position,undefined],["EV_SIZE",ac_size,undefined],["EV_RESIZE",ac_resize,undefined],["EV_PANNING",ac_panning,undefined],["EV_PANNED",ac_panning,undefined],["EV_MOVING",ac_moving,undefined],["EV_MOVED",ac_moving,undefined],["EV_SHOWED",ac_showed,undefined],["EV_HIDDEN",ac_hidden,undefined],]}};let Sw_toolbar=GObj.__makeSubclass__();let proto=Sw_toolbar.prototype;proto.__init__=function(name,kw){GObj.prototype.__init__.call(this,FSM,CONFIG,name,"Sw_toolbar",kw,0);return this;};gobj_register_gclass(Sw_toolbar,"Sw_toolbar");proto.mt_create=function(kw)
{let self=this;let subscriber=self.gobj_read_attr("subscriber");if(!subscriber){subscriber=self.gobj_parent();}
self.gobj_subscribe_event(null,null,subscriber);if(!self.config.layer){self.config.layer=self.gobj_parent().config.layer;}
calculate_dimension(self);let visible=self.config.visible;self.private._gobj_ka_scrollview=self.yuno.gobj_create(self.gobj_name(),Ka_scrollview,{layer:self.config.layer,x:self.config.x,y:self.config.y,width:self.config.width,height:self.config.height,padding:self.config.padding,background_color:self.config.background_color,visible:visible,panning:self.config.panning,draggable:self.config.draggable,autosize:false,fix_dimension_to_screen:self.config.fix_dimension_to_screen,center:false,show_overflow:false,enable_vscroll:self.config.enable_vscroll,enable_hscroll:self.config.enable_hscroll,scroll_by_step:true,hide_hscrollbar:true,hide_vscrollbar:true,quick_display:self.config.quick_display,kw_border_shape:__duplicate__(kw_get_dict(self.config,"kw_border_shape",{})),kw_border_shape_actived:__duplicate__(kw_get_dict(self.config,"kw_border_shape_actived",{}))},self);self.private._gobj_ka_scrollview.get_konva_container().gobj=self;self.gobj_send_event("EV_ADD_ITEM",{items:self.config.items},self);if(visible){self.gobj_send_event("EV_SHOW",{},self);}};proto.mt_destroy=function()
{let self=this;};proto.mt_start=function(kw)
{let self=this;};proto.mt_stop=function(kw)
{let self=this;};proto.mt_child_added=function(child)
{let self=this;if(self.private._gobj_ka_scrollview){self.gobj_send_event("EV_ADD_ITEM",{items:[child]},self);}};proto.mt_child_removed=function(child)
{let self=this;self.gobj_send_event("EV_REMOVE_ITEM",{items:[child]},self);};proto.get_konva_container=function()
{let self=this;return self.private._gobj_ka_scrollview.get_konva_container();};exports.Sw_toolbar=Sw_toolbar;})(this);(function(exports){'use strict';let CONFIG={subscriber:null,layer:null,views:[],x:100,y:100,width:240,height:240,padding:0,background_color:"#cccccc",visible:true,draggable:false,fix_dimension_to_screen:false,center:false,kw_border_shape:{strokeWidth:0,opacity:1,shadowBlur:0},kw_border_shape_actived:{},_gobj_ka_scrollview:null};function ac_add_view(self,event,kw,src)
{let views=kw_get_dict_value(kw,"views",null,false,false);for(let i=0;i<views.length;i++){let view=views[i];let child=null;if(is_gobj(view)){child=view;}else if(is_object(view)){child=self.yuno.gobj_create(kw_get_str(view,"id",kw_get_str(view,"name","")),kw_get_dict_value(view,"gclass",null),kw_get_dict(view,"kw",{}),self);continue;}else{log_error("What is it?"+view);continue;}
child.gobj_send_event("EV_RESIZE",self.private._gobj_ka_scrollview.get_util_dimension(),self);let k=child.get_konva_container();self.private._gobj_ka_scrollview.gobj_send_event("EV_ADD_ITEM",{items:[k]},self);}
return 0;}
function ac_remove_view(self,event,kw,src)
{let views=kw_get_dict_value(kw,"views",null,false,false);for(let i=0;i<views.length;i++){let view=views[i];let childs=null;if(is_string(view)){let name=view;childs=self.gobj_match_childs({__gobj_name__:name});}else if(is_object(view)){let name=kw_get_str(view,"id",kw_get_str(view,"name",""));childs=self.gobj_match_childs({__gobj_name__:name});}else if(is_gobj(view)){childs=[view];}else{log_error("What is?"+view);continue;}
for(let child in childs){let k=child.get_konva_container();self.private._gobj_ka_scrollview.gobj_send_event("EV_REMOVE_ITEM",{items:[k]},self);if(!child.gobj_is_destroying()){self.yuno.gobj_destroy(child);}}}
return 0;}
function ac_show_or_hide(self,event,kw,src)
{let __ka_main__=self.yuno.gobj_find_service("__ka_main__",true);let name=kw_get_str(kw,"id",kw_get_str(kw,"name",""));if(!empty_string(name)){if(event==="EV_SHOW"){let gobj=find_gobj_in_list(self.private._views,name);if(gobj){gobj.get_konva_container().moveToTop();__ka_main__.gobj_send_event("EV_ACTIVATE",{},gobj);}}
return 0;}
let position=kw;let node_dimension={};self.private._gobj_ka_scrollview.gobj_send_event("EV_GET_DIMENSION",node_dimension,self);self.config.x=kw_get_int(position,"x",node_dimension.x,true,false);self.config.y=kw_get_int(position,"y",node_dimension.y,true,false);self.private._gobj_ka_scrollview.gobj_send_event("EV_POSITION",position,self);self.private._gobj_ka_scrollview.gobj_send_event(event,kw,self);if(self.private._gobj_ka_scrollview.isVisible()){__ka_main__.gobj_send_event("EV_ACTIVATE",{},self);}else{__ka_main__.gobj_send_event("EV_DEACTIVATE",{},self);}
return 0;}
function ac_showed(self,event,kw,src)
{return 0;}
function ac_hidden(self,event,kw,src)
{return 0;}
function ac_keydown(self,event,kw,src)
{let ret=0;return ret;}
function ac_activate(self,event,kw,src)
{self.get_konva_container().moveToTop();self.private._gobj_ka_scrollview.gobj_send_event("EV_ACTIVATE",{},self);return 0;}
function ac_deactivate(self,event,kw,src)
{self.private._gobj_ka_scrollview.gobj_send_event("EV_DEACTIVATE",{},self);return 0;}
function ac_moving(self,event,kw,src)
{return 0;}
function ac_moved(self,event,kw,src)
{return 0;}
function ac_position(self,event,kw,src)
{self.config.x=kw_get_int(kw,"x",self.config.x,false,false);self.config.y=kw_get_int(kw,"y",self.config.y,false,false);let position={x:self.config.x,y:self.config.y};self.private._gobj_ka_scrollview.gobj_send_event(event,position,self);return 0;}
function ac_size(self,event,kw,src)
{self.config.width=kw_get_int(kw,"width",self.config.width,false,false);self.config.height=kw_get_int(kw,"height",self.config.height,false,false);let size={width:self.config.width,height:self.config.height};self.private._gobj_ka_scrollview.gobj_send_event(event,size,self);return 0;}
function ac_resize(self,event,kw,src)
{self.config.x=kw_get_int(kw,"x",self.config.x);self.config.y=kw_get_int(kw,"y",self.config.y);self.config.width=kw_get_int(kw,"width",self.config.width);self.config.height=kw_get_int(kw,"height",self.config.height);self.private._gobj_ka_scrollview.gobj_send_event("EV_RESIZE",{x:self.config.x,y:self.config.y,width:self.config.width,height:self.config.height},self);let childs=self.gobj_match_childs();for(let i=0;i<childs.length;i++){let child=childs[i];if(child.gobj_name()===self.gobj_name()){continue;}
child.gobj_send_event("EV_RESIZE",self.private._gobj_ka_scrollview.get_util_dimension(),self);}
return 0;}
let FSM={"event_list":["EV_KEYDOWN","EV_ADD_VIEW","EV_REMOVE_VIEW","EV_ACTIVATE","EV_DEACTIVATE","EV_MOVING: output no_warn_subs","EV_MOVED: output no_warn_subs","EV_TOGGLE","EV_POSITION","EV_SIZE","EV_SHOW","EV_HIDE","EV_SHOWED","EV_HIDDEN","EV_RESIZE"],"state_list":["ST_IDLE"],"machine":{"ST_IDLE":[["EV_KEYDOWN",ac_keydown,undefined],["EV_ADD_VIEW",ac_add_view,undefined],["EV_REMOVE_VIEW",ac_remove_view,undefined],["EV_ACTIVATE",ac_activate,undefined],["EV_DEACTIVATE",ac_deactivate,undefined],["EV_MOVING",ac_moving,undefined],["EV_MOVED",ac_moved,undefined],["EV_TOGGLE",ac_show_or_hide,undefined],["EV_SHOW",ac_show_or_hide,undefined],["EV_HIDE",ac_show_or_hide,undefined],["EV_POSITION",ac_position,undefined],["EV_SIZE",ac_size,undefined],["EV_SHOWED",ac_showed,undefined],["EV_HIDDEN",ac_hidden,undefined],["EV_RESIZE",ac_resize,undefined]]}};let Sw_multiview=GObj.__makeSubclass__();let proto=Sw_multiview.prototype;proto.__init__=function(name,kw){GObj.prototype.__init__.call(this,FSM,CONFIG,name,"Sw_multiview",kw,0);return this;};gobj_register_gclass(Sw_multiview,"Sw_multiview");proto.mt_create=function(kw)
{let self=this;let subscriber=self.gobj_read_attr("subscriber");if(!subscriber){subscriber=self.gobj_parent();}
self.gobj_subscribe_event(null,null,subscriber);if(!self.config.layer){self.config.layer=self.gobj_parent().config.layer;}
let visible=self.config.visible;self.private._gobj_ka_scrollview=self.yuno.gobj_create(self.gobj_name(),Ka_scrollview,{layer:self.config.layer,x:self.config.x,y:self.config.y,width:self.config.width,height:self.config.height,padding:self.config.padding,background_color:self.config.background_color,visible:visible,panning:false,draggable:self.config.draggable,autosize:false,fix_dimension_to_screen:self.config.fix_dimension_to_screen,center:self.config.center,show_overflow:false,enable_vscroll:false,enable_hscroll:false,scroll_by_step:false,kw_border_shape:__duplicate__(kw_get_dict(self.config,"kw_border_shape",{})),kw_border_shape_actived:__duplicate__(kw_get_dict(self.config,"kw_border_shape_actived",{}))},self);self.private._gobj_ka_scrollview.get_konva_container().gobj=self;self.gobj_send_event("EV_ADD_VIEW",{views:self.config.views},self);if(visible){self.gobj_send_event("EV_SHOW",{},self);}};proto.mt_destroy=function()
{let self=this;};proto.mt_start=function(kw)
{let self=this;};proto.mt_stop=function(kw)
{let self=this;};proto.mt_child_added=function(child)
{let self=this;if(self.private._gobj_ka_scrollview){self.gobj_send_event("EV_ADD_VIEW",{views:[child]},self);}};proto.mt_child_removed=function(child)
{let self=this;self.gobj_send_event("EV_REMOVE_VIEW",{views:[child]},self);};proto.get_konva_container=function()
{let self=this;return self.private._gobj_ka_scrollview.get_konva_container();};exports.Sw_multiview=Sw_multiview;})(this);(function(exports){'use strict';let CONFIG={subscriber:null,layer:null,items:[],links:[],x:100,y:100,width:240,height:240,padding:0,background_color:"#cccccc",visible:true,panning:true,draggable:false,fix_dimension_to_screen:false,grid:10,enable_vscroll:true,enable_hscroll:true,scroll_by_step:false,quick_display:false,kw_border_shape:{strokeWidth:0,opacity:1,shadowBlur:0},kw_border_shape_actived:{},_gobj_ka_scrollview:null};function create_link(self,kw,common)
{let id=kw_get_str(kw,"id",kw_get_str(kw,"name",""));let gobj_link=self.yuno.gobj_find_unique_gobj(id);if(gobj_link){log_error(sprintf("%s: link already exists '%s'",self.gobj_short_name(),id));return null;}
kw["source_port"]=kw_get_dict_value(kw,"source_port",id);kw["target_port"]=kw_get_dict_value(kw,"target_port",id);json_object_update_missing(kw,common);return self.yuno.gobj_create_unique(id,Ka_link,kw,self);}
function ac_add_item(self,event,kw,src)
{let items=kw_get_dict_value(kw,"items",null,false,false);for(let i=0;i<items.length;i++){let item=items[i];let gobj_item=null;if(is_gobj(item)){gobj_item=item;}else if(is_object(item)){let kw_item=kw_get_dict(item,"kw",{});gobj_item=self.yuno.gobj_create(kw_get_str(item,"id",kw_get_str(item,"name","")),kw_get_dict_value(item,"gclass",null),kw_item,self);continue;}else{log_error("What is it?"+item);continue;}
let k=gobj_item.get_konva_container();self.private._gobj_ka_scrollview.gobj_send_event("EV_ADD_ITEM",{items:[k]},self);}
return 0;}
function ac_remove_item(self,event,kw,src)
{let items=kw_get_dict_value(kw,"items",null,false,false);for(let i=0;i<items.length;i++){let item=items[i];let childs=null;if(is_string(item)){let name=item;childs=self.gobj_match_childs({__gobj_name__:name});}else if(is_object(item)){let name=kw_get_str(item,"id",kw_get_str(item,"name",""));childs=self.gobj_match_childs({__gobj_name__:name});}else if(is_gobj(item)){childs=[item];}else{log_error("What is?"+item);continue;}
for(let child in childs){let k=child.get_konva_container();self.private._gobj_ka_scrollview.gobj_send_event("EV_REMOVE_ITEM",{items:[k]},self);if(!child.gobj_is_destroying()){self.yuno.gobj_destroy(child);}}}
return 0;}
function ac_link(self,event,kw,src)
{let links=kw_get_dict_value(kw,"links",null,false,false);for(let i=0;i<links.length;i++){let link=links[i];let gobj_link=null;if(is_gobj(link)){gobj_link=link;}else if(is_object(link)){create_link(self,link,kw);continue;}else{log_error("What is it?"+link);continue;}
let k=gobj_link.get_konva_container();self.private._gobj_ka_scrollview.gobj_send_event("EV_ADD_ITEM",{items:[k]},self);}
return 0;}
function ac_unlink(self,event,kw,src)
{let source_node=kw_get_dict_value(kw,"source_node",src);return 0;}
function ac_show_or_hide(self,event,kw,src)
{let __ka_main__=self.yuno.gobj_find_service("__ka_main__",true);let name=kw_get_str(kw,"id",kw_get_str(kw,"name",""));if(!empty_string(name)){if(event==="EV_SHOW"){let gobj=self.gobj_child_by_name(name);if(gobj){gobj.get_konva_container().moveToTop();__ka_main__.gobj_send_event("EV_ACTIVATE",{},gobj);}}
return 0;}
let position=kw;let item_dimension={};self.private._gobj_ka_scrollview.gobj_send_event("EV_GET_DIMENSION",item_dimension,self);self.config.x=kw_get_int(position,"x",item_dimension.x,true,false);self.config.y=kw_get_int(position,"y",item_dimension.y,true,false);self.private._gobj_ka_scrollview.gobj_send_event("EV_POSITION",position,self);self.private._gobj_ka_scrollview.gobj_send_event(event,kw,self);if(self.private._gobj_ka_scrollview.isVisible()){__ka_main__.gobj_send_event("EV_ACTIVATE",{},self);}else{__ka_main__.gobj_send_event("EV_DEACTIVATE",{},self);}
return 0;}
function ac_keydown(self,event,kw,src)
{let ret=0;return ret;}
function ac_activate(self,event,kw,src)
{self.get_konva_container().moveToTop();self.private._gobj_ka_scrollview.gobj_send_event("EV_ACTIVATE",{},self);return 0;}
function ac_deactivate(self,event,kw,src)
{self.private._gobj_ka_scrollview.gobj_send_event("EV_DEACTIVATE",{},self);return 0;}
function ac_position(self,event,kw,src)
{self.config.x=kw_get_int(kw,"x",self.config.x,false,false);self.config.y=kw_get_int(kw,"y",self.config.y,false,false);let position={x:self.config.x,y:self.config.y};self.private._gobj_ka_scrollview.gobj_send_event(event,position,self);return 0;}
function ac_size(self,event,kw,src)
{self.config.width=kw_get_int(kw,"width",self.config.width,false,false);self.config.height=kw_get_int(kw,"height",self.config.height,false,false);let size={width:self.config.width,height:self.config.height};self.private._gobj_ka_scrollview.gobj_send_event(event,size,self);return 0;}
function ac_resize(self,event,kw,src)
{self.config.x=kw_get_int(kw,"x",self.config.x);self.config.y=kw_get_int(kw,"y",self.config.y);self.config.width=kw_get_int(kw,"width",self.config.width);self.config.height=kw_get_int(kw,"height",self.config.height);self.private._gobj_ka_scrollview.gobj_send_event("EV_RESIZE",{x:self.config.x,y:self.config.y,width:self.config.width,height:self.config.height},self);return 0;}
function ac_panning(self,event,kw,src)
{if(src===self.private._gobj_ka_scrollview){}
return 0;}
function ac_moving(self,event,kw,src)
{if(src===self.private._gobj_ka_scrollview){}else{if(strcmp(event,"EV_MOVED")===0){let grid=self.config.grid;let change_position=false;if(kw.x<grid||kw.y<grid){if(kw.x<grid){kw.x=grid;}
if(kw.y<grid){kw.y=grid;}
change_position=true;}
if(grid>0){kw.x=Math.round(kw.x/grid)*grid;kw.y=Math.round(kw.y/grid)*grid;if(kw.x<grid){kw.x=grid;}
if(kw.y<grid){kw.y=grid;}
change_position=true;}
if(change_position){src.gobj_send_event("EV_POSITION",kw,self);}
self.private._gobj_ka_scrollview.gobj_send_event("EV_RESIZE",{},self);}}
return 0;}
function ac_showed(self,event,kw,src)
{return 0;}
function ac_hidden(self,event,kw,src)
{return 0;}
let FSM={"event_list":["EV_KEYDOWN","EV_ADD_ITEM","EV_REMOVE_ITEM","EV_LINK","EV_UNLINK","EV_ACTIVATE","EV_DEACTIVATE","EV_TOGGLE","EV_POSITION","EV_SIZE","EV_SHOW","EV_HIDE","EV_RESIZE","EV_PANNING","EV_PANNED","EV_MOVING","EV_MOVED","EV_SHOWED","EV_HIDDEN"],"state_list":["ST_IDLE"],"machine":{"ST_IDLE":[["EV_KEYDOWN",ac_keydown,undefined],["EV_ADD_ITEM",ac_add_item,undefined],["EV_REMOVE_ITEM",ac_remove_item,undefined],["EV_LINK",ac_link,undefined],["EV_UNLINK",ac_unlink,undefined],["EV_ACTIVATE",ac_activate,undefined],["EV_DEACTIVATE",ac_deactivate,undefined],["EV_PANNING",ac_panning,undefined],["EV_PANNED",ac_panning,undefined],["EV_MOVING",ac_moving,undefined],["EV_MOVED",ac_moving,undefined],["EV_SHOWED",ac_showed,undefined],["EV_HIDDEN",ac_hidden,undefined],["EV_TOGGLE",ac_show_or_hide,undefined],["EV_SHOW",ac_show_or_hide,undefined],["EV_HIDE",ac_show_or_hide,undefined],["EV_POSITION",ac_position,undefined],["EV_SIZE",ac_size,undefined],["EV_RESIZE",ac_resize,undefined]]}};let Sw_graph=GObj.__makeSubclass__();let proto=Sw_graph.prototype;proto.__init__=function(name,kw){GObj.prototype.__init__.call(this,FSM,CONFIG,name,"Sw_graph",kw,0);return this;};gobj_register_gclass(Sw_graph,"Sw_graph");proto.mt_create=function(kw)
{let self=this;let subscriber=self.gobj_read_attr("subscriber");if(!subscriber){subscriber=self.gobj_parent();}
self.gobj_subscribe_event(null,null,subscriber);if(!self.config.layer){self.config.layer=self.gobj_parent().config.layer;}
self.private._gobj_ka_scrollview=self.yuno.gobj_create(self.gobj_name(),Ka_scrollview,{layer:self.config.layer,x:self.config.x,y:self.config.y,width:self.config.width,height:self.config.height,padding:self.config.padding,background_color:self.config.background_color,visible:self.config.visible,panning:self.config.panning,draggable:self.config.draggable,autosize:false,fix_dimension_to_screen:self.config.fix_dimension_to_screen,center:false,show_overflow:false,enable_vscroll:self.config.enable_vscroll,enable_hscroll:self.config.enable_hscroll,scroll_by_step:self.config.scroll_by_step,quick_display:self.config.quick_display,kw_border_shape:__duplicate__(kw_get_dict(self.config,"kw_border_shape",{})),kw_border_shape_actived:__duplicate__(kw_get_dict(self.config,"kw_border_shape_actived",{}))},self);self.private._gobj_ka_scrollview.get_konva_container().gobj=self;};proto.mt_destroy=function()
{let self=this;};proto.mt_start=function(kw)
{let self=this;self.gobj_send_event("EV_ADD_ITEM",{items:self.config.items},self);self.gobj_send_event("EV_LINK",{links:self.config.links},self);if(self.config.visible){self.gobj_send_event("EV_SHOW",{},self);}};proto.mt_stop=function(kw)
{let self=this;};proto.mt_child_added=function(child)
{let self=this;if(self.private._gobj_ka_scrollview){if(child.gobj_gclass_name()==="Ka_link"){self.gobj_send_event("EV_LINK",{links:[child]},self);}else{self.gobj_send_event("EV_ADD_ITEM",{items:[child]},self);}}};proto.mt_child_removed=function(child)
{let self=this;if(child.gobj_gclass_name()==="Ne_base"){self.gobj_send_event("EV_REMOVE_ITEM",{items:[child]},self);}
if(child.gobj_gclass_name()==="Ka_link"){self.gobj_send_event("EV_UNLINK",{links:[child]},self);}};proto.get_konva_container=function()
{let self=this;return self.private._gobj_ka_scrollview.get_konva_container();};exports.Sw_graph=Sw_graph;})(this);(function(exports){'use strict';let CONFIG={subscriber:null,layer:null,view:null,x:0,y:0,width:400,height:250,padding:20,background_color:"#FFF7E0",color:"black",visible:true,draggable:false,top_on_activate:false,disabled:false,selected:false,unlocked:false,kw_border_shape:{cornerRadius:10,strokeWidth:2,stroke:"#f5c211ff",opacity:1,shadowBlur:0,shadowColor:"black",shadowForStrokeEnabled:false},kw_border_shape_actived:{},port_width:20,port_height:20,port_shape:"circle",port_color:"#FFEEAA",port_offset:0,port_label:"",port_label_background_color:"#00000000",port_label_color:"black",title:{height:30},input:{},output:{},top:{},bottom:{},kw_top_left:{},kw_top_right:{},kw_bottom_left:{},kw_bottom_right:{},enable_center:false,center_y_offset:true,kw_center:{padding:0,kw_border_shape:{strokeWidth:0,}},gobj_sw_center:null,_ka_container:null,_ka_border_shape:null,_ka_title:null};function create_shape(self)
{let width=self.config.width;let height=self.config.height;let ka_container=self.private._ka_container=new Konva.Group({id:self.gobj_short_name(),name:"ka_container",x:self.config.x,y:self.config.y,width:width,height:height,visible:self.config.visible,draggable:self.config.draggable});ka_container.gobj=self;let kw_border_shape=__duplicate__(kw_get_dict(self.config,"kw_border_shape",{},false,false));json_object_update(kw_border_shape,{name:"ka_border_shape",x:0,y:0,width:width,height:height,fill:kw_get_str(self.config,"background_color",null)});self.private._ka_border_shape=new Konva.Rect(kw_border_shape);ka_container.add(self.private._ka_border_shape);let padding=kw_get_int(self.config,"padding",0);let kw_title=kw_get_dict(self.config,"title",{},false,false);let title_width=width-2*padding;let title_height=kw_get_int(kw_title,"height",30);json_object_update(kw_title,{name:"ka_title",x:padding,y:padding,width:title_width,height:title_height});let kw_text_font_properties=kw_get_dict(kw_title,"kw_text_font_properties",{},true);kw_text_font_properties.width=title_width;kw_text_font_properties.height=title_height;self.private._ka_title=create_shape_label_with_icon(kw_title);ka_container.add(self.private._ka_title);if(self.config.enable_center){let kw_center=__duplicate__(kw_get_dict(self.config,"kw_center",{},false,false));let _y=padding+title_height;let _height=height-2*padding-title_height;if(self.config.center_y_offset){_y+=self.config.center_y_offset;_height-=self.config.center_y_offset;}
json_object_update(kw_center,{name:"ka_center",x:padding,y:_y,width:width-2*padding,height:_height,background_color:kw_get_str(kw_center,"background_color",self.config.background_color)});self.config.gobj_sw_center=self.yuno.gobj_create("center",Ka_scrollview,kw_center,self);}
if(self.config.draggable){ka_container.on('dragstart',function(ev){ev.cancelBubble=true;let min_offset=self.config.kw_border_shape.strokeWidth;min_offset+=self.config.kw_border_shape.shadowBlur;let dim=ka_container.getClientRect({relativeTo:ka_container.getParent()});if(dim.x<0){ka_container.x(min_offset);}
if(dim.y<0){ka_container.y(min_offset);}
self.config.layer.getStage().container().style.cursor="move";self.gobj_publish_event("EV_MOVING",ka_container.position());});ka_container.on('dragmove',function(ev){ev.cancelBubble=true;let min_offset=self.config.kw_border_shape.strokeWidth;min_offset+=self.config.kw_border_shape.shadowBlur;let dim=ka_container.getClientRect({relativeTo:ka_container.getParent()});if(dim.x<0){ka_container.x(min_offset);}
if(dim.y<0){ka_container.y(min_offset);}
self.config.layer.getStage().container().style.cursor="move";self.gobj_publish_event("EV_MOVING",ka_container.position());});ka_container.on('dragend',function(ev){ka_container.opacity(1);ev.cancelBubble=true;let min_offset=self.config.kw_border_shape.strokeWidth;min_offset+=self.config.kw_border_shape.shadowBlur;let dim=ka_container.getClientRect({relativeTo:ka_container.getParent()});if(dim.x<0){ka_container.x(min_offset);}
if(dim.y<0){ka_container.y(min_offset);}
self.config.layer.getStage().container().style.cursor="default";self.gobj_publish_event("EV_MOVED",ka_container.position());});}
return ka_container;}
function create_ports(self,port_position,kw_common)
{let node_width=self.config.width;let node_height=self.config.height;let title_height=self.private._ka_title.height();let padding=kw_get_int(self.config,"padding",0);let ports=kw_get_list(kw_common,"ports",[]);let port_x,port_y,port_size;switch(port_position){case"left":port_size=(node_height-(3*padding+title_height))/(ports.length);break;case"right":port_size=(node_height-(3*padding+title_height))/(ports.length);break;case"top":port_size=(node_width-(3*padding))/(ports.length);break;case"bottom":port_size=(node_width-(3*padding))/(ports.length);break;}
let port_width=kw_get_int(kw_common,"width",self.config.port_width);let port_height=kw_get_int(kw_common,"height",self.config.port_height);let port_shape=kw_get_str(kw_common,"port_shape",self.config.port_shape);let port_color=kw_get_str(kw_common,"port_color",self.config.port_color);let port_offset=kw_get_int(kw_common,"port_offset",self.config.port_offset);let port_label=kw_get_str(kw_common,"port_label",self.config.port_label);let port_label_background_color=kw_get_str(kw_common,"port_label_background_color",self.config.port_label_background_color);let port_label_color=kw_get_str(kw_common,"port_label_color",self.config.port_label_color);json_object_update(kw_common,{layer:self.config.layer,subscriber:self.config.subscriber,width:port_width,height:port_height,port_shape:port_shape,port_position:port_position,port_color:port_color,port_label:port_label,port_label_background_color:port_label_background_color,port_label_color:port_label_color});for(let i=0;i<ports.length;i++){let kw_port=ports[i];let port_shape2=kw_get_str(kw_port,"port_shape",port_shape);switch(port_position){case"left":if(port_shape2==="circle"){port_x=0;}else{port_x=-port_width/2;}
port_x-=kw_get_int(kw_port,"port_offset",port_offset);port_y=padding*2+title_height;port_y+=port_size*i;break;case"right":if(port_shape2==="circle"){port_x=node_width;}else{port_x=node_width-port_width/2;}
port_x+=kw_get_int(kw_port,"port_offset",port_offset);port_y=padding*2+title_height;port_y+=port_size*i;break;case"top":if(port_shape2==="circle"){port_y=0;}else{port_y=-port_height/2;}
port_y-=kw_get_int(kw_port,"port_offset",port_offset);port_x=padding*2;port_x+=port_size*i;break;case"bottom":if(port_shape2==="circle"){port_y=node_height;}else{port_y=node_height-port_width/2;}
port_y+=kw_get_int(kw_port,"port_offset",port_offset);port_x=padding*2;port_x+=port_size*i;break;}
kw_common.x=port_x;kw_common.y=port_y;json_object_update_missing(kw_port,kw_common);kw_port.view=self.config.view;self.yuno.gobj_create(kw_get_str(kw_port,"id",kw_get_str(kw_port,"name","")),Ka_port,kw_port,self);}}
function ac_keydown(self,event,kw,src)
{let ret=0;return ret;}
function ac_add_port(self,event,kw,src)
{let input_ports=kw_get_list(kw,"input`ports",[]);if(input_ports.length>0){create_ports(self,"left",kw.input);}
let output_ports=kw_get_list(kw,"output`ports",[]);if(output_ports.length>0){create_ports(self,"right",kw.output);}
let top_ports=kw_get_list(kw,"top`ports",[]);if(top_ports.length>0){create_ports(self,"top",kw.top);}
let bottom_ports=kw_get_list(kw,"bottom`ports",[]);if(bottom_ports.length>0){create_ports(self,"bottom",kw.bottom);}
return 0;}
function ac_remove_port(self,event,kw,src)
{return 0;}
function ac_activate(self,event,kw,src)
{if(self.config.top_on_activate){self.private._ka_container.moveToTop();}
let kw_rect=self.config.kw_border_shape_actived;let stroke=kw_get_str(kw_rect,"stroke",null);if(!is_null(stroke)){self.private._ka_border_rect.stroke(stroke);}
let opacity=kw_get_real(kw_rect,"opacity",null);if(!is_null(opacity)){self.private._ka_border_rect.opacity(opacity);}
let shadowBlur=kw_get_int(kw_rect,"shadowBlur",null);if(!is_null(shadowBlur)){self.private._ka_border_rect.shadowBlur(shadowBlur);}
let shadowColor=kw_get_str(kw_rect,"shadowColor",null);if(!is_null(shadowColor)){self.private._ka_border_rect.shadowColor(shadowColor);}
return 0;}
function ac_deactivate(self,event,kw,src)
{let kw_rect=self.config.kw_border_shape;let stroke=kw_get_str(kw_rect,"stroke",null);if(!is_null(stroke)){self.private._ka_border_rect.stroke(stroke);}
let opacity=kw_get_real(kw_rect,"opacity",null);if(!is_null(opacity)){self.private._ka_border_rect.opacity(opacity);}
let shadowBlur=kw_get_int(kw_rect,"shadowBlur",null);if(!is_null(shadowBlur)){self.private._ka_border_rect.shadowBlur(shadowBlur);}
let shadowColor=kw_get_str(kw_rect,"shadowColor",null);if(!is_null(shadowColor)){self.private._ka_border_rect.shadowColor(shadowColor);}
return 0;}
function ac_show_or_hide(self,event,kw,src)
{let __ka_main__=self.yuno.gobj_find_service("__ka_main__",true);let name=kw_get_str(kw,"id",kw_get_str(kw,"name",""));if(!empty_string(name)){if(event==="EV_SHOW"){let gobj=self.gobj_child_by_name(name);if(gobj){gobj.get_konva_container().moveToTop();__ka_main__.gobj_send_event("EV_ACTIVATE",{},gobj);}}
return 0;}
switch(event){case"EV_TOGGLE":if(self.private._ka_container.isVisible()){self.private._ka_container.hide();}else{self.private._ka_container.show();}
break;case"EV_SHOW":self.private._ka_container.show();break;case"EV_HIDE":self.private._ka_container.hide();break;}
if(self.private._ka_container.isVisible()){self.gobj_publish_event("EV_SHOWED",{});__ka_main__.gobj_send_event("EV_ACTIVATE",{},self);}else{self.gobj_publish_event("EV_HIDDEN",{});__ka_main__.gobj_send_event("EV_DEACTIVATE",{},self);}
return 0;}
function ac_position(self,event,kw,src)
{self.config.x=kw_get_int(kw,"x",self.config.x,false,false);self.config.y=kw_get_int(kw,"y",self.config.y,false,false);let ka_container=self.private._ka_container;ka_container.position({x:self.config.x,y:self.config.y});return 0;}
function ac_size(self,event,kw,src)
{self.config.width=kw_get_int(kw,"width",self.config.width,false,false);self.config.height=kw_get_int(kw,"height",self.config.height,false,false);return 0;}
function ac_resize(self,event,kw,src)
{return 0;}
function ac_panning(self,event,kw,src)
{if(src===self.private._gobj_ka_scrollview){}
return 0;}
function ac_moving(self,event,kw,src)
{if(src===self.private._gobj_ka_scrollview){}else{}
return 0;}
function ac_showed(self,event,kw,src)
{return 0;}
function ac_hidden(self,event,kw,src)
{return 0;}
let FSM={"event_list":["EV_MOVING: output no_warn_subs","EV_MOVED: output no_warn_subs","EV_KEYDOWN","EV_ADD_PORT","EV_REMOVE_PORT","EV_ACTIVATE","EV_DEACTIVATE","EV_TOGGLE","EV_SHOW","EV_HIDE","EV_POSITION","EV_SIZE","EV_RESIZE","EV_PANNING","EV_PANNED","EV_SHOWED","EV_HIDDEN"],"state_list":["ST_IDLE"],"machine":{"ST_IDLE":[["EV_KEYDOWN",ac_keydown,undefined],["EV_ADD_PORT",ac_add_port,undefined],["EV_REMOVE_PORT",ac_remove_port,undefined],["EV_ACTIVATE",ac_activate,undefined],["EV_DEACTIVATE",ac_deactivate,undefined],["EV_TOGGLE",ac_show_or_hide,undefined],["EV_SHOW",ac_show_or_hide,undefined],["EV_HIDE",ac_show_or_hide,undefined],["EV_POSITION",ac_position,undefined],["EV_SIZE",ac_size,undefined],["EV_RESIZE",ac_resize,undefined],["EV_PANNING",ac_panning,undefined],["EV_PANNED",ac_panning,undefined],["EV_MOVING",ac_moving,undefined],["EV_MOVED",ac_moving,undefined],["EV_SHOWED",ac_showed,undefined],["EV_HIDDEN",ac_hidden,undefined],]}};let Ne_base=GObj.__makeSubclass__();let proto=Ne_base.prototype;proto.__init__=function(name,kw){GObj.prototype.__init__.call(this,FSM,CONFIG,name,"Ne_base",kw,0);return this;};gobj_register_gclass(Ne_base,"Ne_base");proto.mt_create=function(kw)
{let self=this;let subscriber=self.gobj_read_attr("subscriber");if(!subscriber){subscriber=self.gobj_parent();}
self.gobj_subscribe_event(null,null,subscriber);if(!self.config.layer){self.config.layer=self.gobj_parent().config.layer;}
if(!self.config.view){self.config.view=self.gobj_parent();}
create_shape(self);};proto.mt_destroy=function()
{let self=this;if(self.private._ka_container){self.private._ka_container.destroy();self.private._ka_container=null;}};proto.mt_start=function(kw)
{let self=this;self.gobj_send_event("EV_ADD_PORT",self.config,self);};proto.mt_stop=function(kw)
{let self=this;};proto.mt_writing=function(name)
{let self=this;};proto.mt_child_added=function(child)
{let self=this;self.private._ka_container.add(child.get_konva_container());};proto.mt_child_removed=function(child)
{let self=this;};proto.get_konva_container=function()
{let self=this;return self.private._ka_container;};proto.get_ka_title_label=function()
{let self=this;return self.private._ka_title;};exports.Ne_base=Ne_base;})(this);(function(exports){'use strict';let CONFIG={id:"",name:"shape_label_with_icon",label:"",icon:"",icon_position:"left",background_color:"#FFF7E0",color:"black",text_color:"black",icon_color:"black",x:0,y:0,width:150,height:40,visible:true,icon_size:18,text_size:18,autosize:false,kw_text_font_properties:{fontFamily:"sans-serif",fontStyle:"normal",padding:10,align:"center",verticalAlign:"middle",wrap:"char"},kw_icon_font_properties:{fontFamily:"yuneta-icon-font",fontStyle:"normal",padding:10,align:"center",verticalAlign:"middle",wrap:"char"},kw_border_shape:{cornerRadius:10,strokeWidth:2,stroke:"#f5c211ff",opacity:1,shadowBlur:0,shadowColor:"black",shadowForStrokeEnabled:false}};function create_shape_label_with_icon(config)
{let width=kw_get_int(config,"width",CONFIG.width);let height=kw_get_int(config,"height",CONFIG.height);let background_color=kw_get_str(config,"background_color",CONFIG.background_color);let ka_container=new Konva.Group({id:kw_get_str(config,"id",CONFIG.id),name:kw_get_str(config,"name",CONFIG.name),x:kw_get_int(config,"x",CONFIG.x),y:kw_get_int(config,"y",CONFIG.y),width:width,height:height,visible:kw_get_bool(config,"visible",CONFIG.visible)});let kw_border_shape=__duplicate__(kw_get_dict(CONFIG,"kw_border_shape",{}));json_object_update(kw_border_shape,kw_get_dict(config,"kw_border_shape",{}));json_object_update(kw_border_shape,{name:"ka_border_shape",x:0,y:0,width:width,height:height,fill:background_color,});let _ka_border_shape=new Konva.Rect(kw_border_shape);ka_container.add(_ka_border_shape);let label=create_label(config);ka_container.add(label);if(config.autosize){let font_dimension=label.getClientRect();_ka_border_shape.size(font_dimension);ka_container.size(font_dimension);let ka_container_dimension=ka_container.getClientRect();config.width=ka_container_dimension.width;config.height=ka_container_dimension.height;}
ka_container.shape_label_background_color=function(color)
{let ka=ka_container.find(".ka_border_shape");if(ka.length===0){log_error("ka not found");return null;}
if(color){ka[0].fill(color);}else{color=ka[0].fill();}
return color;};ka_container.shape_label_icon_color=function(color)
{let ka=ka_container.find(".ka_icon");if(ka.length===0){log_error("ka not found");return null;}
if(color){ka[0].fill(color);}else{color=ka[0].fill();}
return color;};ka_container.shape_label_text_color=function(color)
{let ka=ka_container.find(".ka_text");if(ka.length===0){log_error("ka not found");return null;}
if(color){ka[0].fill(color);}else{color=ka[0].fill();}
return color;};ka_container.shape_label_color=function(color)
{let ka=ka_container.find(".ka_text");if(ka.length>0){ka[0].fill(color);}
ka=ka_container.find(".ka_icon");if(ka.length>0){ka[0].fill(color);}
return ka_container;};ka_container.shape_label_size=function(size)
{ka_container.size(size);let ka=ka_container.find(".ka_border_shape");if(ka.length===0){log_error("ka not found");return ka_container;}
ka[0].size(size);return ka_container;};ka_container.shape_label_text=function(text)
{let ka=ka_container.find(".ka_text");if(ka.length===0){log_error("ka not found");return ka_container;}
ka[0].text(text);return ka_container;};return ka_container;}
function create_label(config)
{let width=kw_get_int(config,"width",CONFIG.width);let height=kw_get_int(config,"height",CONFIG.height);let color=kw_get_str(config,"color",CONFIG.color);let text_color=kw_get_str(config,"text_color",color);let icon_color=kw_get_str(config,"icon_color",color);let kw_text_font_properties=__duplicate__(kw_get_dict(CONFIG,"kw_text_font_properties",{}));json_object_update(kw_text_font_properties,kw_get_dict(config,"kw_text_font_properties",{}));if(text_color){if(!kw_has_key(kw_text_font_properties,"fill")){kw_text_font_properties.fill=text_color;}}
let kw_icon_font_properties=__duplicate__(kw_get_dict(CONFIG,"kw_icon_font_properties",{}));json_object_update(kw_icon_font_properties,kw_get_dict(config,"kw_icon_font_properties",{}));if(icon_color){if(!kw_has_key(kw_icon_font_properties,"fill")){kw_icon_font_properties.fill=icon_color;}}
let _text_size=adjust_font_size(kw_get_int(config,"text_size",CONFIG.text_size),kw_text_font_properties.fontFamily);let _icon_size=adjust_icon_size(kw_get_int(config,"icon_size",CONFIG.icon_size),kw_icon_font_properties.fontFamily);let text=kw_get_str(config,"label",CONFIG.label);let icon=kw_get_str(config,"icon",CONFIG.icon);let container=new Konva.Group({name:"ka_label_container"});let icon_element=null,text_element=null;if(!empty_string(text)&&!empty_string(icon)){let icon_position=kw_get_str(config,"icon_position",CONFIG.icon_position);switch(icon_position){case"top":{let kw_icon={name:"ka_icon",text:icon,x:0,y:0,fontSize:_icon_size};json_object_update(kw_icon,kw_icon_font_properties);icon_element=new Konva.Text(kw_icon);container.add(icon_element);let kw_text={name:"ka_text",text:text,x:0,y:icon_element.height()-
kw_get_int(kw_text_font_properties,"padding",0),lineHeight:icon_element.lineHeight(),fontSize:_text_size};json_object_update(kw_text,kw_text_font_properties);text_element=new Konva.Text(kw_text);container.add(text_element);let max_width=Math.max(icon_element.width(),text_element.width());icon_element.width(max_width);text_element.width(max_width);}
break;case"bottom":{let kw_text={name:"ka_text",text:text,x:0,y:0,fontSize:_text_size};json_object_update(kw_text,kw_text_font_properties);text_element=new Konva.Text(kw_text);container.add(text_element);let kw_icon={name:"ka_icon",text:icon,x:0,y:text_element.height()-
kw_get_int(kw_text_font_properties,"padding",0),lineHeight:text_element.lineHeight(),fontSize:_icon_size};json_object_update(kw_icon,kw_icon_font_properties);icon_element=new Konva.Text(kw_icon);container.add(icon_element);let max_width=Math.max(icon_element.width(),text_element.width());icon_element.width(max_width);text_element.width(max_width);}
break;case"left":{let kw_icon={name:"ka_icon",text:icon,x:0,y:0,fontSize:_icon_size};json_object_update(kw_icon,kw_icon_font_properties);icon_element=new Konva.Text(kw_icon);container.add(icon_element);let kw_text={name:"ka_text",text:text,x:icon_element.width(),y:0,fontSize:_text_size};json_object_update(kw_text,kw_text_font_properties);text_element=new Konva.Text(kw_text);container.add(text_element);let max_height=Math.max(icon_element.height(),text_element.height());icon_element.height(max_height);text_element.height(max_height);}
break;case"right":{let kw_text={name:"ka_text",text:text,x:0,y:0,fontSize:_text_size};json_object_update(kw_text,kw_text_font_properties);text_element=new Konva.Text(kw_text);container.add(text_element);let kw_icon={name:"ka_icon",text:icon,x:text_element.width(),y:0,fontSize:_icon_size};json_object_update(kw_icon,kw_icon_font_properties);icon_element=new Konva.Text(kw_icon);container.add(icon_element);let max_height=Math.max(icon_element.height(),text_element.height());icon_element.height(max_height);text_element.height(max_height);}
break;}}else if(!empty_string(icon)){let kw_icon={name:"ka_icon",text:icon,x:0,y:0,fontSize:_icon_size};json_object_update(kw_icon,kw_icon_font_properties);icon_element=new Konva.Text(kw_icon);container.add(icon_element);}else{let kw_text={name:"ka_text",text:text?text:"",x:0,y:0,fontSize:_text_size};if(!config.autosize){kw_text.width=width;kw_text.height=height;}
json_object_update(kw_text,kw_text_font_properties);text_element=new Konva.Text(kw_text);container.add(text_element);}
return container;}
exports.create_shape_label_with_icon=create_shape_label_with_icon;})(this);function create_json_editor_window(kw)
{let name=kw_get_str(kw,"name",kw_get_str(kw,"id",undefined));let title=kw_get_str(kw,"title","JSON Editor");let props=kw_get_dict(kw,"props",null,false,true);if(!props){return;}
let editor=null;let target=null;let w2=new w2window({name:name,title:title,showMax:true,center:true,modal:false,width:600,height:500,onClose(ev){if(editor&&editor.destroy){editor.destroy();}},onMoving(ev){},onMoved(ev){},onResizing(ev){},onResized(ev){},actions:{Ok(ev){this.close();},Cancel(ev){this.close();},custom:{text:"Other Button",class:"w2ui-btn-blue",style:"color: yellow",onClick(ev){console.log("button clicked");}}}});target=w2.get_container();if(target.length>0){target.addClass("jse-theme-dark");let font_family="DejaVu Sans Mono, monospace";let sz=adjust_font_size(16,font_family);const root=target[0];root.style.setProperty('--jse-font-size-mono',sz+'px');root.style.setProperty('--jse-font-family-mono',font_family);editor=new JSONEditor({target:target[0],props:props});}
return w2;}
function destroy_json_editor(editor)
{const w2=editor.w2;editor.destroy();if(w2){w2.destroy();}}